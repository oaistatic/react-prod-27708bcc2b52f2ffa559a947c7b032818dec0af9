var be=Object.defineProperty,Se=Object.defineProperties;var Le=Object.getOwnPropertyDescriptors;var qt=Object.getOwnPropertySymbols;var Oe=Object.prototype.hasOwnProperty,Ae=Object.prototype.propertyIsEnumerable;var Zt=(e,t,o)=>t in e?be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Kt=(e,t)=>{for(var o in t||(t={}))Oe.call(t,o)&&Zt(e,o,t[o]);if(qt)for(var o of qt(t))Ae.call(t,o)&&Zt(e,o,t[o]);return e},Jt=(e,t)=>Se(e,Le(t));import{c as Ne,e as le,r as O,j as d}from"./fg33krlcm0qyi6yw.js";import{cG as Te,hl as we,nN as De,ru as Me,qw as _,qx as ut,v4 as Qt,qP as Pe}from"./k65njl5wlgspihfr.js";import{k as W,C as H,h as ke,f as X,j as ie,q as _e,S as ce,r as Be,s as ae,E as je,t as Ye}from"./kkpvfco69f4rm4dl.js";import{C as te}from"./b2l059fz4znz94nm.js";import{Z as pt,T as He}from"./ce3hgmw4iyyhicud.js";import{u as mt,i as _t,a as Ie}from"./gfro8vshyz92jyup.js";import{aU as Pt,b as Re,d as ue,l as F,bg as V,bv as ht,oa as Ge,ku as fe,fZ as Ve,xi as Xe,da as de,gd as zt,k5 as Ke,fe as Fe}from"./mtk1qztvnb31pw5r.js";import{p as pe,q as me,a as Ue}from"./ck40inivrzkot78b.js";import{P as ze,H as We}from"./n1g1ac9g2671vjzk.js";import{E as Ft,c as $e,G as Y,a as ee}from"./exqqo21frem4no6f.js";import{u as Bt}from"./l09h2qppleubii6l.js";import{a as he}from"./acd1cl9alifs5fnh.js";import{C as qe}from"./dxf0nhie0kb80o3m.js";var U=(e=>(e[e.up=-1]="up",e[e.down=1]="down",e))(U||{}),kt=(e=>(e.COMMENT="comment",e.COMPOSER="composer",e))(kt||{}),w=(e=>(e.COLLAPSED="collapsed",e.EXPANDED="expanded",e))(w||{});const Ee=([e,t],[o,s])=>{const n=e+t,l=o+s;return e<l&&o<n},Wt=([e,t])=>e+t,ft=e=>{var l;if(e.type===w.COLLAPSED)return[(l=e.offsetY)!=null?l:0,0];const{offsetY:t,shiftY:o=0,height:s=0}=e,n=t+o;return o<0?[n,s+Math.abs(o)]:[n,s]},Ze=(e,t,o)=>{if(!Ee(e,t))return null;const[s,n]=e,l=s+n,[r,c]=t,i=r+c,u=r-l,p=i-s;return o===U.up?u:p};var Ce=(e=>(e.ABOVE="above",e.BELOW="below",e))(Ce||{});function dt(e,t){return Pt(e.coordsAtPos(t))}const oe=360,Je=250,ge=44,Qe=.5,to=[.5,.9,1],eo=[1,.75,.2],ye=e=>{"use forget";const t=Ne.c(89),{onClose:o,onSubmit:s,opensOverDocument:n,opensFromGutter:l,gutterHasComments:r,ref:c}=e,i=n===void 0?!1:n,u=l===void 0?!1:l,p=r===void 0?!1:r,E=Re(),a=le(),h=O.useRef(null),f=O.useRef(!1),[g,y]=O.useState(""),[m,b]=O.useState(!0);let N;t[0]!==o?(N=()=>{document.hasFocus()&&(y(""),o==null||o(f.current))},t[0]=o,t[1]=N):N=t[1];const v=N;let S;t[2]!==g||t[3]!==s?(S=(k,K)=>{const z=K===void 0?g:K;f.current=!0,s==null||s(k,z),y("")},t[2]=g,t[3]=s,t[4]=S):S=t[4];const x=S;let L;t[5]!==E||t[6]!==i?(L=()=>i?we(E).width<oe+100?Je:oe:Ft,t[5]=E,t[6]=i,t[7]=L):L=t[7];const D=ue(L);let C;t[8]!==u||t[9]!==i?(C={},u&&(C.top=-12),i&&u?C.right=0:C.left=0,t[8]=u,t[9]=i,t[10]=C):C=t[10];let M="";u&&!i?M="8px 50%":u&&i?M="calc(100% + 8px) 50%":i&&(M="center left");let P=0;u&&!i&&p&&(P=$e);let R;t[11]!==x||t[12]!==g||t[13]!==o?(R=k=>{const{metaKey:K,shiftKey:z,key:$t}=k;$t==="Enter"&&!k.nativeEvent.isComposing&&g&&!(z||K)?(x(k),k.preventDefault()):$t==="Escape"&&(y(""),o==null||o(!1))},t[11]=x,t[12]=g,t[13]=o,t[14]=R):R=t[14];const G=R;let A;t[15]!==a?(A=a.formatMessage({id:"VvfbvY",defaultMessage:"Edit or explain..."}),t[15]=a,t[16]=A):A=t[16];const T=A;let B;t[17]!==c?(B=Te(h,c),t[17]=c,t[18]=B):B=t[18];let j;t[19]===Symbol.for("react.memo_cache_sentinel")?(j=F("absolute flex items-center",pt.commentComposer),t[19]=j):j=t[19];let I;t[20]!==C?(I=Jt(Kt({},C),{minHeight:ge}),t[20]=C,t[21]=I):I=t[21];let Et,Ct;t[22]===Symbol.for("react.memo_cache_sentinel")?(Et={type:"spring",bounce:.18,duration:.48},Ct={translateX:0},t[22]=Et,t[23]=Ct):(Et=t[22],Ct=t[23]);let $;t[24]!==P?($={translateX:P},t[24]=P,t[25]=$):$=t[25];let gt;t[26]===Symbol.for("react.memo_cache_sentinel")?(gt={translateX:0},t[26]=gt):gt=t[26];const jt=!m;let q;t[27]!==m||t[28]!==jt?(q=F("no-scrollbar border-token-border-default relative z-10 flex items-center overflow-x-hidden border",He,{"rounded-full":m,"rounded-2xl":jt}),t[27]=m,t[28]=jt,t[29]=q):q=t[29];const Yt=i?Ft:24,Ht=i?void 0:Qe;let Z;t[30]!==Yt||t[31]!==Ht?(Z={width:Yt,scale:Ht},t[30]=Yt,t[31]=Ht,t[32]=Z):Z=t[32];const It=i?void 0:to;let J;t[33]!==It||t[34]!==D?(J={width:D,scale:It},t[33]=It,t[34]=D,t[35]=J):J=t[35];const Rt=i?void 0:eo,Gt=i?Ft:24;let Q;t[36]!==i?(Q=i?0:[1,1,0],t[36]=i,t[37]=Q):Q=t[37];let tt;t[38]!==Rt||t[39]!==Gt||t[40]!==Q?(tt={filter:"blur(16px)",scale:Rt,width:Gt,opacity:Q},t[38]=Rt,t[39]=Gt,t[40]=Q,t[41]=tt):tt=t[41];const Vt=i?.14:0;let yt;t[42]===Symbol.for("react.memo_cache_sentinel")?(yt={type:"tween",duration:.2},t[42]=yt):yt=t[42];let xt;t[43]===Symbol.for("react.memo_cache_sentinel")?(xt=[0,.95,1],t[43]=xt):xt=t[43];let vt;t[44]===Symbol.for("react.memo_cache_sentinel")?(vt={type:"tween",times:xt},t[44]=vt):vt=t[44];let et;t[45]!==Vt?(et={type:"spring",bounce:Vt,duration:.28,scale:yt,opacity:vt},t[45]=Vt,t[46]=et):et=t[46];let ot;t[47]!==M?(ot={transformOrigin:M},t[47]=M,t[48]=ot):ot=t[48];let bt;t[49]===Symbol.for("react.memo_cache_sentinel")?(bt=d.jsx(V.div,{className:"absolute inset-0 z-[-1] bg-gray-50/75 backdrop-blur-3xl backdrop-saturate-25 dark:bg-gray-700/75",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.2}}),t[49]=bt):bt=t[49];let St,Lt;t[50]===Symbol.for("react.memo_cache_sentinel")?(St=(k,K)=>{const{rowHeight:z}=K;b(Math.floor(k/z)<=1)},Lt=k=>{const{target:K}=k,{value:z}=K;return y(z)},t[50]=St,t[51]=Lt):(St=t[50],Lt=t[51]);let nt;t[52]!==v||t[53]!==G||t[54]!==g||t[55]!==T?(nt=d.jsx(De,{"aria-placeholder":T,value:g,className:"text-token-text-primary placeholder:text-token-text-secondary w-full resize-none border-0 bg-transparent px-1 py-0 pe-2 outline-0 focus:ring-0 focus-visible:ring-0",autoFocus:!0,maxRows:4,onBlur:v,onHeightChange:St,onChange:Lt,onKeyDown:G}),t[52]=v,t[53]=G,t[54]=g,t[55]=T,t[56]=nt):nt=t[56];let st;t[57]!==g||t[58]!==T?(st=!g&&d.jsx("span",{"aria-hidden":!0,className:"text-token-text-secondary absolute inline-block ps-1 text-nowrap",children:T}),t[57]=g,t[58]=T,t[59]=st):st=t[59];const Xt=!m;let rt;t[60]!==Xt?(rt=F("-me-1.5 h-6 w-6 rounded-full bg-black text-center dark:bg-white",{"self-end":Xt}),t[60]=Xt,t[61]=rt):rt=t[61];let Ot,At,Nt,Tt;t[62]===Symbol.for("react.memo_cache_sentinel")?(Ot={opacity:0},At={opacity:1},Nt={opacity:0},Tt={type:"tween",duration:.1},t[62]=Ot,t[63]=At,t[64]=Nt,t[65]=Tt):(Ot=t[62],At=t[63],Nt=t[64],Tt=t[65]);let lt;t[66]!==x?(lt=k=>x(k),t[66]=x,t[67]=lt):lt=t[67];let wt;t[68]===Symbol.for("react.memo_cache_sentinel")?(wt=d.jsx(Me,{className:"h-6 w-6 text-white dark:text-black"}),t[68]=wt):wt=t[68];let it;t[69]!==rt||t[70]!==lt?(it=d.jsx(V.button,{className:rt,initial:Ot,animate:At,exit:Nt,transition:Tt,onMouseDown:lt,children:wt}),t[69]=rt,t[70]=lt,t[71]=it):it=t[71];let ct;t[72]!==nt||t[73]!==st||t[74]!==it?(ct=d.jsxs(V.div,{className:"bg-token-main-surface-primary relative z-0 flex w-full items-center px-4 py-2.5",children:[bt,nt,st,it]}),t[72]=nt,t[73]=st,t[74]=it,t[75]=ct):ct=t[75];let at;t[76]!==q||t[77]!==Z||t[78]!==J||t[79]!==tt||t[80]!==et||t[81]!==ot||t[82]!==ct?(at=d.jsx(V.div,{className:q,initial:Z,animate:J,exit:tt,transition:et,style:ot,children:ct}),t[76]=q,t[77]=Z,t[78]=J,t[79]=tt,t[80]=et,t[81]=ot,t[82]=ct,t[83]=at):at=t[83];let Dt;return t[84]!==I||t[85]!==$||t[86]!==at||t[87]!==B?(Dt=d.jsx(V.div,{ref:B,className:j,style:I,transition:Et,initial:Ct,animate:$,exit:gt,children:at}),t[84]=I,t[85]=$,t[86]=at,t[87]=B,t[88]=Dt):Dt=t[88],Dt},oo=(e,t)=>{if((t==null?void 0:t.type)!==W.SELECTION)return null;try{const{from:o,to:s}=t,{top:n}=e.dom.getBoundingClientRect(),{bottom:l,top:r}=dt(e,o),{bottom:c}=dt(e,s),i=_t(e)?-30:-24;let u=l-n+i;const p=r-n;return u=c-n+8,{composerTop:u,loadingTop:p}}catch(o){return _.logError("Invalid position in SelectionCommentComposer",o),null}},no=({toolbarPosition:e,composerRect:t,view:o})=>{const{width:s}=t;let{height:n}=t;if(n||(n=ge),o==null||e==null)return null;const{right:l,left:r}=o.dom.getBoundingClientRect(),{left:c,top:i,aboveOrBelow:u,toolbarSize:p}=e,E=i-(u===Ce.ABOVE&&n!==0?n-p.height:0),a=Ie(o)?12:0;return{left:Math.min(c,l-r-s-a),composerTop:E,aboveOrBelow:u}},so=({toolbarPosition:e,commentingOn:t,isWaitingForCommentResponse:o=!1,onAddComment:s})=>{const n=mt()(),[l,r]=Bt(),c=no({view:n,toolbarPosition:e,composerRect:l});if(n==null||c==null)return null;const{left:i,composerTop:u}=c,p=(E,a)=>{if((t==null?void 0:t.type)!==W.SELECTION)return;const{action:h,sourceRange:f}=t;s==null||s(E,a,h,f,t.type)};return d.jsx(ht,{children:(t==null?void 0:t.type)===W.SELECTION&&!o&&d.jsx("div",{className:F("absolute",pt.commentComposer),style:{left:i,top:u},children:d.jsx(ye,{opensOverDocument:!0,onClose:E=>{var a;E||(H.cancelCommentingOn(),n&&_t(n)&&!n.state.selection.empty&&n.dispatch(n.state.tr.setSelection(new Ge(n.state.selection.$from))),(a=document.getSelection())==null||a.removeAllRanges())},onSubmit:p,ref:r})},"composer")})};function ro(e,t,o){const s=e+t;for(const n of o.values()){const l=n.start,r=n.end;if(e<r&&l<s)return!0}return!1}const lo=50,io=200,co=[ze.proseMirrorNodeName(),We.proseMirrorNodeName()],ao=e=>e?e.isBlock:!1,uo=e=>{if(!e)return!1;const{isBlock:t,type:{name:o}}=e;return t&&co.includes(o)},fo=(e,t,o,s)=>{const n=e.posAtCoords({left:t,top:o});if(n==null)return;const{pos:l,inside:r}=n;if(r===-1)return;const{state:c}=e;let i=l,u=c.doc.nodeAt(i);for(;!ao(u)&&i>=0;)i--,u=c.doc.nodeAt(i);if(!u||!uo(u))return;const p=s!=null&&ro(i,u.nodeSize,s);return{node:u,nodeHasComment:p,pos:i}};function po(e,t,o){const s=fo(e,t.x,t.y,o);if(s==null)return null;const{node:n,pos:l,nodeHasComment:r}=s,{top:c}=e.coordsAtPos(0);function i(){const h=l+1;if(Ue(e.state.doc,h)){const f=e.state.doc.nodeAt(h);if(f!=null&&f.isText)return e.coordsAtPos(h).top}return e.coordsAtPos(l).top}const u=i(),p=u-c;return{height:e.coordsAtPos(l+n.nodeSize-1).bottom-u,nodeHasComment:r,mouseEnteredAt:Date.now(),yOffset:p,pos:l}}function mo(e){var E;const t=O.useRef(!1),o=O.useRef(!1),[s,n]=O.useState(null),l=ke(),r=(E=l())==null?void 0:E.dom,c=O.useRef(!1),i=X(({visibleBlockCommentLauncher_DEBUG_ONLY:a})=>a),u=O.useCallback(fe(a=>{var L;t.current=!0;const{commentingOn:h}=X.getState();if(o.current||h!=null)return;const f=l();if(f==null||!t.current)return n(null);const{dom:g,state:y}=f,m=(L=pe(me,y))==null?void 0:L.positions;if(m==null)return n(null);const b=po(f,a,m);if(b==null||b.nodeHasComment&&e===Y.COLLAPSED){n(null);return}if(c.current&&b.yOffset!==(s==null?void 0:s.yOffset)){n(null);return}const N=f.coordsAtPos(0),v=g.getBoundingClientRect().width,x=(a.x-N.left)/v>=lo/100;n(x?b:null)},io),[l,c,s]);O.useEffect(()=>{if(r!=null)return Ve(r,{mouseenter:()=>{t.current=!0,o.current=!1},mouseleave:({relatedTarget:a})=>{if(u.cancel(),a instanceof HTMLElement&&a.closest("[data-block-comment-launcher]")){o.current=!0;return}o.current=!1,t.current=!1,X.getState().commentingOn==null&&n(null)},mousemove:u})},[l,r,e,u]);const p=O.useCallback(({relatedTarget:a})=>{const{commentingOn:h}=X.getState();h==null&&a!==r&&(o.current=!1,n(null))},[r]);return{visibleBlockComment:i!=null?i:s,handleMouseLeave:p,onComposerVisibleChange:a=>{c.current=a}}}const ho=({isWaitingForCommentResponse:e=!1,opensOverDocument:t=!1,hasComments:o=!1,activeBlockComment:s,composerRef:n,onLaunchComposer:l,onMouseLeave:r,onSubmit:c})=>{const[i,u]=O.useState(!1),{yOffset:p,height:E,pos:a}=s,h=()=>{u(!0),l==null||l(),_.logButtonClick(ut.BLOCK_COMMENT_LAUNCHER),H.startCommentingOn({type:W.BLOCK,pos:a})},f=m=>{m||(u(!1),H.cancelCommentingOn())},g=(m,b)=>{u(!1),c==null||c(m,b)};O.useEffect(()=>()=>{H.mouseLeaveBlock()},[]);const y=o&&i?t?-88:88:0;return d.jsx(V.div,{className:F("pointer-events-auto absolute flex h-6 w-5 origin-[14px_50%] items-start after:absolute after:-inset-4 after:content-['']",pt.commentComposer),initial:!1,animate:{opacity:1},exit:{opacity:0},transition:{type:"spring",duration:.2,bounce:.1},style:{top:0,height:E,translateY:p},onMouseLeave:r,"data-block-comment-launcher":!0,children:d.jsxs(ht,{children:[i?d.jsx(ye,{ref:n,opensFromGutter:!0,onClose:f,onSubmit:g,gutterHasComments:o,opensOverDocument:t},"composer"):null,d.jsx(V.button,{initial:{opacity:0},animate:{opacity:i?0:1,translateX:y},transition:{duration:.15,translateX:{type:"spring",bounce:.18,duration:.48}},className:"group absolute z-10 flex h-6 gap-1 bg-transparent after:absolute after:-inset-y-4 after:-start-1 after:-end-4 after:content-['']",onClick:h,onMouseEnter:()=>H.mouseEnterBlock(a),onMouseLeave:()=>H.mouseLeaveBlock(),disabled:i||e,children:d.jsx(_e,{isLoading:e})},"launcer")]})})},Eo=({isWaitingForCommentResponse:e=!1,isRequestActive:t=!1,hasComments:o=!1,composerRef:s,gutterMode:n,onAddComment:l})=>{const r=ie(),{visibleBlockComment:c,handleMouseLeave:i,onComposerVisibleChange:u}=mo(n),p=(E,a)=>{if(!c||!r)return;const{doc:h}=r,{pos:f}=c,g=h.nodeAt(f);if(!g)return;const{attrs:{start:y,end:m}}=g;l==null||l(E,a,ce.ASK,{start:y,end:m},W.BLOCK)};return d.jsx(ht,{onExitComplete:()=>u(!1),children:c&&r&&(e||!t)&&d.jsx(ho,{composerRef:s,isWaitingForCommentResponse:e,opensOverDocument:n===Y.COLLAPSED,activeBlockComment:c,hasComments:o,onSubmit:p,onMouseLeave:i,onLaunchComposer:()=>u(!0)},"launcher")})},Co=({onAcceptComment:e,onDismissComment:t,disableActions:o=!1,entry:s,isGutterCollapsed:n=!1,isHovered:l=!1,isFocused:r=!1,isSomeCommentFocused:c=!1})=>{const{offsetY:i,type:u}=s,[p,E]=Xe();let a=null;if(u===w.COLLAPSED)a=!r&&d.jsx(Be,{offsetY:i,count:s.count,onClick:()=>{_.logButtonClick(ut.COLLAPSED_COMMENT),H.focusComment(s.children[0])}},"collapsed");else{const{comment:h}=s;if(h==null||h.content===""||h.status===Qt.DISMISSED)a=null;else if(h.status===Qt.ACCEPT_INITIATED)a=d.jsx("div",{className:"absolute",style:{top:i},children:d.jsx(ae,{})},"loading");else{const{id:f}=h;a=d.jsx(je,{isSomeCommentFocused:c,isHovered:l,isFocused:r,offsetY:i,disableActions:o,onClick:()=>{_.logButtonClick(ut.EXPANDED_COMMENT),H.focusComment(f)},onMouseEnter:()=>H.mouseEnterComment(f),onMouseLeave:()=>H.mouseLeaveComment(),comment:h,onAccept:g=>{_.logButtonClick(ut.COMMENT_ACCEPT,{commentId:f}),e==null||e(g,f)},onDismiss:()=>{_.logButtonClick(ut.COMMENT_DISMISS,{commentId:f}),t==null||t(f)},opensOverDocument:n},"expanded")}}return d.jsx(ht,{onExitComplete:()=>E==null?void 0:E(),children:p&&a})},ne=({onMeasureHeight:e,comment:t,isFocused:o=!1})=>{const[{height:s},n]=Bt();return de(()=>{e==null||e(s)},[s]),d.jsx(Ye,{ref:n,comment:t,isFocused:o,disableAnimations:!0})},go=({comments:e,onMeasure:t,getStableCommentId:o})=>{const s=O.useRef(new Map),n=O.useRef(new Map),l=O.useRef(null),r=(c,i,u=!1)=>{i&&(u?n.current.set(o(c),i):s.current.set(o(c),i),l.current&&cancelAnimationFrame(l.current),l.current=requestAnimationFrame(()=>{t==null||t({focusedHeights:new Map(n.current),heights:new Map(s.current)}),l.current=null}))};return e!=null&&e.length?d.jsxs("div",{className:"pointer-events-none invisible fixed start-0 top-0 overflow-clip","aria-hidden":"true",children:[e.map(c=>d.jsx(ne,{comment:c,onMeasureHeight:i=>r(c.id,i)},o(c.id))),e.map(c=>d.jsx(ne,{isFocused:!0,comment:c,onMeasureHeight:i=>r(c.id,i,!0)},"".concat(o(c.id),"-focused")))]}):null},se=(e,t,o)=>{let s=o+t;for(;t===U.down?s<e.length:s>-1;){const n=e[s],l=e[s-t],r=Ze(ft(n),ft(l),t);if(r!=null&&n.type!==w.COLLAPSED)n.shiftY+=r;else break;s+=t}},re=(e,t)=>{for(const o of t){const{index:s,amount:n}=o,l=e[s];l.type===w.EXPANDED&&(l.shiftY+=n),se(e,U.down,s),se(e,U.up,s);for(const r of e)r.type!==w.COLLAPSED&&(r.offsetY+=r.shiftY,r.shiftY=0)}},yo=(e,t)=>{const o=[],[s,n]=t,l=s+n;for(let r=0;r<e.length;r++){const c=e[r],[i]=ft(c),u=[i,c.type===w.EXPANDED?c.height:0],[p,E]=u;if(Ee(u,t)){const a=p+E,h=s-a,f=l-p,y=(Math.abs(h)<Math.abs(f)?U.up:U.down)===U.up?h:f;o.push({index:r,amount:y})}}return o},xo=({gutterMode:e,focusedCommentId:t,gutterPositions:o,getCommentKey:s,getComment:n})=>{var p,E,a,h,f,g;if(!(o!=null&&o.size))return[];const l=new Map,r=[];let c=null,i=-1;for(const y of o.values()){if(y.type===kt.COMPOSER){c=[y.offsetY,y.height];continue}const{commentId:m,height:b,collapsedOffsetY:N,offsetY:v}=y;if(e===Y.EXPANDED){const L=zt(r),D=L?Wt(ft(L)):0;let C=v;L&&C<=D&&(C=D),l.set(m,{originalOffsetY:v,offsetY:C}),t===m&&(i=r.length),r.push({key:s(m),comment:n(m),type:w.EXPANDED,height:b,offsetY:C,shiftY:0});continue}let S=r.findIndex(({offsetY:L,type:D})=>D===w.COLLAPSED&&L===N),x=(p=r[S])!=null?p:null;if(!x)x={key:r.length,type:w.COLLAPSED,offsetY:v,count:1,children:[m]},S=r.length,r.push(x);else{if(x.type!==w.COLLAPSED)throw new Error("Collapsed parent type expected to be collapsed");x.count+=1,x.children.push(m),x.offsetY=N}t===m&&(i=S)}const u=r[i];if(e===Y.COLLAPSED&&(u==null?void 0:u.type)===w.COLLAPSED){const y=[];for(let m=0;m<u.children.length;m++){const b=u.children[m];b===t&&(i+=m+1);const N=zt(y),v=N?Wt(ft(N)):0,S=(a=(E=o.get(b))==null?void 0:E.offsetY)!=null?a:0,x=Math.max(v,S);l.set(b,{originalOffsetY:S,offsetY:x}),y.push({type:w.EXPANDED,key:s(b),comment:n(b),offsetY:x,height:(f=(h=o.get(b))==null?void 0:h.height)!=null?f:0,shiftY:0})}r.splice(i,0,...y)}if(t){const y=l.get(t);if(!y)return r;const{offsetY:m,originalOffsetY:b}=y,N=b-m,v=[{amount:N,index:i}];let S=i+1;for(;S<r.length;){const x=r[S],{type:L}=x;let D=N;if(L===w.EXPANDED&&((g=x.comment)!=null&&g.id)){const{offsetY:C,originalOffsetY:M}=Pt(l.get(x.comment.id));if(C===M)break;D=Math.max(M-C,N)}else break;v.push({amount:D,index:S}),S++}v.length&&re(r,v)}else if(e!==Y.COLLAPSED&&c){const y=yo(r,c);re(r,y)}return r},vo=e=>{try{return xo(e)}catch(t){return _.logError("Generating comment gutter entries",t),[]}},bo=e=>"length"in e?e.length===0:e.nodeSize===0,Ut=12,So=({composerHeight:e,getCommentHeight:t,getCollapsedStartPos:o,commentingOn:s,commentPositions:n,view:l})=>{var u,p;if(!n||!l||bo(l.state.doc))return null;const{top:r}=l.dom.getBoundingClientRect(),c=Array.from(n.entries()).sort(([E,a],[h,f])=>a.start-f.start),i=new Map;for(const[E,{start:a}]of c)try{const h=(u=o==null?void 0:o(a))!=null?u:a,{top:f}=dt(l,h),{top:g}=dt(l,a),y=g-r,m=f-r,b=((p=t(E))!=null?p:0)+Ut;i.set(E,{commentId:E,height:b,collapsedOffsetY:m,offsetY:y,type:kt.COMMENT})}catch(h){continue}if((s==null?void 0:s.type)===W.BLOCK){const{pos:E}=s;try{const{top:a}=dt(l,E),f=a-r-Ut;i.set("block-composer",{type:kt.COMPOSER,height:(e!=null?e:0)+Ut,offsetY:f})}catch(a){}}return i},xe=(e,t)=>{const o=t.nodeAt(e);return o!=null&&o.isBlock?e+1:xe(e-1,t)};function Lo(e){const t=ie(),o=mt(),s=o==null?void 0:o();if(!s)return null;if(_t(s)){if(!t)return null;const n=pe(me,t);return n?n.positions:null}return new Map(e.map(n=>[n.id,n.at]))}const Oo=({gutterMode:e,focusedCommentId:t,commentingOn:o,comments:s,getStableId:n})=>{const[{height:l},r]=Bt(),c=mt(),[i,u]=O.useState(()=>new Map),[p,E]=O.useState(()=>new Map),a=O.useCallback(({focusedHeights:v,heights:S})=>{u(v),E(S)},[]),h=v=>{var x,L;const S=n(v);return v===t?(x=i.get(S))!=null?x:0:(L=p.get(S))!=null?L:0},f=c(),g=f!=null&&_t(f)?(v=>xe(v,f.state.doc)):void 0,y=new Map(s==null?void 0:s.map(v=>[n(v.id),v])),m=Lo(s),b=So({composerHeight:l,commentingOn:o,getCommentHeight:h,getCollapsedStartPos:g,commentPositions:m,view:f}),N=vo({gutterMode:e,gutterPositions:b,focusedCommentId:t,getComment:v=>{var S;return(S=y.get(n(v)))!=null?S:null},getCommentKey:n});return{blockComposerRef:r,onMeasureComments:a,gutterEntries:N}};function Ao(){const t=mt()(),o=X(({commentingOn:l})=>l),n=t==null?null:oo(t,o);return n==null?null:d.jsx(V.div,{className:"absolute",style:{top:n.loadingTop},initial:!1,animate:{opacity:1,scale:1},exit:{opacity:0,scale:0},transition:{delay:.2},children:d.jsx(ae,{})},"selection-loading")}const No=e=>d.jsx("div",{className:"absolute",style:{top:Wt(ft(e))},children:d.jsx("div",{className:"h-[max(3rem,18vh)] w-1"})}),Fo=({availableWidth:e,comments:t,commentsMode:o,disableBlockComments:s=!1,isRequestActive:n=!1,isWaitingForCommentResponse:l=!1,onAddComment:r,onAcceptComment:c,onDismissComment:i,getStableCommentId:u})=>{const p=X(({focusedCommentId:C})=>C),E=X(({hoveredCommentId:C})=>C),a=X(({commentingOn:C})=>C),h=ue(Ke),f=e<ee?Y.COLLAPSED:Y.EXPANDED,{onMeasureComments:g,blockComposerRef:y,gutterEntries:m}=Oo({comments:t,getStableId:u,gutterMode:f,focusedCommentId:p,commentingOn:a}),b=m.length>0,N=a!=null&&!l&&a.type!=="selection"||b,S=(()=>{if(!N)return 0;switch(f){case Y.COLLAPSED:return 0;case Y.EXPANDED:return ee}})(),x=(a==null?void 0:a.type)==="selection",L=zt(m),D=o===te.ENABLED&&h&&!x&&!s;return d.jsxs(V.div,{className:F("pointer-events-none relative flex h-full shrink-0",pt.commentGutter,f===Y.COLLAPSED&&S?"basis-[32px]":"basis-0"),initial:{width:0,opacity:0},animate:{width:S,opacity:1},exit:{width:0,opacity:0},children:[d.jsx(go,{getStableCommentId:u,comments:t,onMeasure:g}),d.jsxs("div",{className:F("pointer-events-auto absolute start-0 top-0 bottom-0 w-0 overflow-visible",{"ps-2":N||!s}),children:[d.jsx(ht,{children:m.map(C=>{var A,T;const{key:M,type:P}=C,R=!!p&&P===w.EXPANDED&&((A=C.comment)==null?void 0:A.id)===p,G=!!p&&C.type===w.COLLAPSED&&C.children.includes(p);return d.jsx(Co,{isGutterCollapsed:f===Y.COLLAPSED,isSomeCommentFocused:!!a||!!p,isHovered:P===w.EXPANDED&&((T=C.comment)==null?void 0:T.id)===E,isFocused:R||G,entry:C,disableActions:n||l||o===te.COMMENTS_READONLY,onAcceptComment:(B,j)=>{try{c==null||c(B,Pt(t==null?void 0:t.find(I=>I.id===j)))}catch(I){_.logError("Comment ".concat(j," not found"),I)}},onDismissComment:B=>{try{i==null||i(Pt(t==null?void 0:t.find(j=>j.id===B)))}catch(j){_.logError("Comment ".concat(B," not found"),j)}}},M)})}),b&&L&&d.jsx(No,Kt({},L)),D&&d.jsx(Eo,{composerRef:y,gutterMode:f,onAddComment:r,isWaitingForCommentResponse:l,isRequestActive:n,hasComments:b}),l&&x&&d.jsx(Ao,{})]})]})};function ve(e){const t=e();if(t==null)return;const{from:o,to:s,sourceFrom:n,sourceTo:l}=t;if(o==null||s==null||n==null||l==null){_.logError("Missing selection range on targeted edit",t);return}const r=ce.ASK;_.logButtonClick(ut.TOOLBAR_ASK_CHATGPT,{action:r,sourceFrom:n,sourceTo:l}),H.startCommentingOn({type:W.SELECTION,from:o,to:s,sourceRange:{start:n,end:l},action:r})}function To(e,t,o){O.useEffect(()=>{if(o)return;const s=n=>{(n.metaKey||n.ctrlKey)&&n.key.toLowerCase()==="k"&&(n.preventDefault(),ve(t))};return e==null||e.addEventListener("keydown",s),()=>e==null?void 0:e.removeEventListener("keydown",s)},[e,t,o])}const wo=({isSendDisabled:e=!1,getSelectionRange:t})=>{const o=le(),s=()=>{ve(t)};return d.jsx(he.Action,{isDisabled:e,label:o.formatMessage({id:"wOaJUU",defaultMessage:"Ask ChatGPT"}),onClick:s,icon:qe})},Uo=({getEditorDom:e,getToolbarPosition:t,getSelectionRange:o,toolbarType:s,children:n,onAddComment:l,isWaitingForCommentResponse:r=!1,isSendDisabled:c=!1,showAskChatGPT:i=!0,fixToolbarPositionOnInteraction:u=!1,savedSelection:p=!1,toolbarContentRef:E,setIsToolbarOpen:a,forceClose:h=!1})=>{const[{height:f,width:g},y]=Bt(),[m,b]=O.useState(!0),[N,v]=O.useState(!1),[S,x]=O.useState(!0),L=e(),D=X(({commentingOn:A})=>A),[C,M]=O.useState(null);To(L,o,c);const P=O.useCallback(()=>{const A=e(),T=document.getSelection();return!T||T.type!=="Range"||T.isCollapsed||!(A!=null&&A.contains(T.anchorNode))},[e]);O.useEffect(()=>{const A=Fe(()=>{v(!0)},200,{leading:!0}),T=()=>{A.cancel(),v(!1)};return L==null||L.addEventListener("pointerdown",A,{passive:!0}),document.addEventListener("pointerup",T,{passive:!0}),()=>{L==null||L.removeEventListener("pointerdown",A),document.removeEventListener("pointerup",T)}},[L]),O.useEffect(()=>{if(N){x(!1);return}const A=setTimeout(()=>x(!0),100);return()=>{clearTimeout(A)}},[N]),O.useEffect(()=>{const A=()=>{b(P())};return document.addEventListener("selectionchange",A,{passive:!0}),()=>{document.removeEventListener("selectionchange",A)}},[P]),de(()=>{if(m||P())return b(!0);try{const A=t({width:g,height:f});A!=null&&!u&&M(A)}catch(A){_.logError("Invalid position in getToolbarPosition",A)}},[f,g,m,P,t,u]);const R=d.jsxs(he,{toolbarType:s,children:[i&&d.jsx(wo,{isSendDisabled:c,getSelectionRange:o}),n]}),G=!h&&(!m||p)&&!D&&C!=null&&S;return O.useEffect(()=>{a==null||a(G)},[G,a]),d.jsxs(d.Fragment,{children:[d.jsx("div",{"aria-hidden":"true",className:"pointer-events-none invisible fixed start-0 top-0 h-0 overflow-clip",children:d.jsx("div",{ref:y,children:R})}),G&&d.jsx("div",{style:{top:C.top,left:C.left},className:F("absolute",pt.toolbar,N?"pointer-events-none":"pointer-events-auto"),ref:E,children:R}),d.jsx(so,{toolbarPosition:C,commentingOn:D,isWaitingForCommentResponse:r,onAddComment:l})]})};function Do(e){let t=e;for(;t;){const s=window.getComputedStyle(t).overflowY;if(s==="auto"||s==="scroll")return t;t=t.parentElement}return null}function zo(e,t){const o=mt(),s=Pe(),n=o();O.useEffect(()=>{const l=n==null?void 0:n.dom;if(!l||e.length===0)return;const r=Do(l),c=t?fe(t,100):null;return r&&c&&r.addEventListener("scroll",c,{passive:!0}),()=>{c&&(r&&r.removeEventListener("scroll",c),c.cancel())}},[n,s,e,t])}let Mt=null;function Wo(){if(Mt!=null)return Mt;if(typeof window>"u")return 0;const e=document.createElement("div");e.style.width="100px",e.style.height="100px",e.style.overflow="scroll",e.style.position="absolute",e.style.top="-9999px",document.body.appendChild(e);try{Mt=e.offsetWidth-e.clientWidth}finally{document.body.removeChild(e)}return Mt}function $o(e){return e==null?null:e.scrollHeight>e.clientHeight}export{Ce as A,Fo as C,Uo as T,bo as a,Wo as g,$o as i,zo as u};
//# sourceMappingURL=cgotviy5lzzhvf4u.js.map
