import{c as Te,e as Fe,r as S,f as We,j as Re}from"./fg33krlcm0qyi6yw.js";import{R as he,A as Ce,gq as Ae,ry as Be,m as ze,d as Le,k2 as $e,o as pe,b as Oe,c2 as Ue,fN as qe,dF as be,_ as x,eD as He}from"./mtk1qztvnb31pw5r.js";import{u as Ne,W as je,p as Se,c as Ge}from"./zqh8zckrbn05i9g8.js";import{g as ve}from"./c5f83hvrbqsij840.js";import{u as Xe}from"./gi9hyxr9tw3nqr5l.js";import{f as Je}from"./f96c6fguu1kcw0go.js";import{W as Ke}from"./nb22pb07i8ebbv0i.js";import"./btdpwmi6j9nv6qc2.js";import"./k65njl5wlgspihfr.js";import"./hgk4djqrlco056z6.js";import"./l6gg4oal15ycpbhj.js";import"./27egyxvdbhiyko0z.js";import"./he7oe7s4xa3cph5y.js";import"./gy1lpvuoewmzh42c.js";import"./jed1ux7qibe55pmj.js";import"./h1em0bjkpkjv8ykw.js";import"./nfccle6oyncifphl.js";import"./hu1bt0oauegdhua6.js";import"./ojve869uwykk95at.js";import"./ly75bs3d14n5v622.js";import"./b7abh8aw9icifmym.js";import"./odbvdbv7o06jw7ls.js";import"./l8g4nijn9ow7argx.js";import"./njh1hro7jxhbut4d.js";import"./l09h2qppleubii6l.js";import"./cu0ig3jox4ha1bc5.js";import"./i1g2kxfbotvbgq93.js";import"./qcr0k45a8ay8c0b9.js";import"./li70yj6yb4gouarj.js";import"./krwszi9u3lj63i9v.js";import"./h5lbwoaovb563r4k.js";import"./iiok29s29bpdre61.js";import"./d3oudxt8f92bezmy.js";import"./coc2775l3yj92qmf.js";import"./i1mqwoffqueglpnh.js";import"./kzbknm4lxuyoq9wi.js";import"./f5ep9o7usovyn4vf.js";import"./h733mrhdc6qfebgd.js";import"./zqbip2ya77i1mx4s.js";import"./dm7q440f2oraxz29.js";import"./eqi3xjytwhmszqqa.js";import"./n0ab5m1z76n8mazm.js";import"./sy1xvqwioh9ks4z8.js";import"./cmaobpdpreyiep8p.js";import"./j3x02iqqi345yx57.js";import"./lbq5605sor1ah5hb.js";import"./mmn9462oogkapcg8.js";import"./blmsijdyv0yxybpw.js";import"./bbzlu7xqes2h12wz.js";import"./npp0xpas090zc0qr.js";import"./0hruh9i7xt25bbur.js";import"./bgx9m29b5moow7ak.js";import"./j4u691tk1tplayl2.js";import"./kg0cp341m64rddpv.js";import"./u9jpwxvw30u3h6nc.js";import"./gns80bg8nlx0ty1m.js";import"./kx34yg3blv92o8xp.js";import"./i3rty9twuhjkv8ax.js";import"./kgjs6438c34s9yzr.js";import"./lep2wptoy14cfe2w.js";import"./hy5xt98rivxg8tb4.js";import"./du4xh8plp0f7ydun.js";import"./idu73b1fegzzc3f8.js";import"./hcn3kohxpjzaoxwc.js";import"./n6upldbhvll48b0q.js";import"./ol9d5wxhynx9q2is.js";import"./l9but48wvxtwnlrx.js";import"./esz2kgkc587ofop0.js";import"./oxont9zeuaiwb679.js";import"./jdzosouyvpzu0tpb.js";import"./fqo7byo7t7jfvb49.js";import"./5mkn81r14jsz61px.js";import"./j509ay9g77d9nkrt.js";import"./n1g1ac9g2671vjzk.js";import"./f76gy0b8ieo4s693.js";import"./g3lybt7hj0s143gw.js";import"./bkm8et9bp0kf1c7y.js";import"./e4usrdpxs4x6g5aq.js";import"./c7uslvzbaqks7omp.js";import"./acd1cl9alifs5fnh.js";import"./ce3hgmw4iyyhicud.js";import"./j1qri9ykgswuwttk.js";import"./ir7nzwbolrsm3ds2.js";import"./kl7c6054usfnqmd4.js";import"./k97n0y6ba9c9h39c.js";import"./kee8jqsrbjdoukr1.js";import"./n7q15cptibmmhebw.js";async function ye(W,e,a,o){const t=o?await he.safeGet("/share/{shared_conversation_id}/file_from_message/{message_id}",{parameters:{path:{shared_conversation_id:e,message_id:W},query:{file_path:a}},authOption:Ce.SendIfAvailable}):await he.safeGet("/conversation/{conversation_id}/interpreter/download",{parameters:{path:{conversation_id:e},query:{message_id:W,sandbox_path:a}}});if(t.status===Ae.Success)return t;throw new Be("Could not download file from advanced data analysis","error_code"in t?t.error_code:"unknown_error")}function To(W){"use forget";var we,xe,_e;const e=Te.c(59),{conversation:a,messageId:o,filepath:t,isResponsiveSheet:ce,responsiveSheetHeight:J}=W,Ie=ce===void 0?!1:ce,s=Oe(),v=Fe(),y=ze(),{updatePresentationMap:I}=Xe();let R;e[0]!==a?(R=()=>a.serverId$(),e[0]=a,e[1]=R):R=e[1];const ke=Le(R),_=S.useContext($e),l=(we=_==null?void 0:_.serverSharedThreadId)!=null?we:ke,c=!!(_!=null&&_.serverSharedThreadId),[Ee,K]=S.useState(!1),[Q,V]=S.useState(!1),[Y,fe]=S.useState(null);let C;e[2]!==t?(C=(xe=t.split("/").pop())!=null?xe:"spreadsheet.xlsx",e[2]=t,e[3]=C):C=e[3];const i=C,p="".concat(a.id,"-").concat(o,"-").concat(t);let A;e[4]!==i||e[5]!==t||e[6]!==p?(A={type:"file",cite_key:t,file_id:p,filepath:t,file_name:i,matched_text:i,start_idx:0,end_idx:0,alt:null},e[4]=i,e[5]=t,e[6]=p,e[7]=A):A=e[7];const f=A;let B;e[8]!==s?(B=pe(s,"638971034"),e[8]=s,e[9]=B):B=e[9];const g=B,k=Ne(!g);let z;e[10]!==s?(z=pe(s,"2400755524"),e[10]=s,e[11]=z):z=e[11];const L=z;let $;e[12]!==s?($=Ue(s,"2888003541"),e[12]=s,e[13]=$):$=e[13];const Z=$.value,E=Number((_e=Z==null?void 0:Z.max_bytes)!=null?_e:3e7);let O;e[14]!==s?(O=pe(s,"1086459186"),e[14]=s,e[15]=O):O=e[15];const ue=O;let U;e[16]!==o?(U=r=>{const n=be.getConversationTurnIndex(r,o),M=be.getConversationTurns(r);return n!==-1&&n===M.length-1},e[16]=o,e[17]=U):U=e[17];const De=qe(a.id,U),[D,Pe]=S.useState(De||!ue),P=!ue||D;let q;e[18]!==t||e[19]!==v||e[20]!==c||e[21]!==o||e[22]!==l||e[23]!==y?(q=async()=>{if(!l)return y.danger(v.formatMessage(me.downloadFailed),{toastId:"file_download_failed"}),!1;try{const r=await ye(o,l,t,c);let n;if(r!=null&&typeof r.download_url=="string"&&(n=r.download_url),!n)return x.addError(new Error("Missing sandbox download url"),{message_id:o,filepath:t}),y.danger(v.formatMessage(me.downloadFailed),{toastId:"file_download_failed"}),!1;const M=document.createElement("a");return M.href=n,M.click(),!0}catch(r){const n=r;return y.danger(v.formatMessage(me.downloadFailed),{toastId:"file_download_failed"}),x.addError(n,{message_id:o,filepath:t}),!1}},e[18]=t,e[19]=v,e[20]=c,e[21]=o,e[22]=l,e[23]=y,e[24]=q):q=e[24];const ee=q;let H;e[25]!==ee?(H=async r=>{r.preventDefault(),await ee()},e[25]=ee,e[26]=H):H=e[26];const te=H;let N,j;e[27]!==f.file_id||e[28]!==i||e[29]!==t||e[30]!==c||e[31]!==E||e[32]!==o||e[33]!==k||e[34]!==l||e[35]!==P||e[36]!==g||e[37]!==L||e[38]!==I||e[39]!==p?(N=()=>{if(!l||!P)return;let r=!1;const n=new AbortController;return K(!0),V(!1),fe(null),(async()=>{var ge;const u=await ye(o,l,t,c);let se;if(u!=null&&typeof u.download_url=="string"&&(se=u.download_url),!se)throw new Error("Missing sandbox download url");const ae=await fetch(se,{headers:He(),signal:n.signal});if(!ae.ok)throw new Error("HTTP ".concat(ae.status));const T=await ae.blob();if(E!==0&&T.size>E){r||(V(!0),fe("fileTooLarge"));return}const ne=T.size,X=new Uint8Array(await T.arrayBuffer()),le=(ge=ve(i))!=null?ge:"pptx";if(le==="pptx"){let d;if(g){const m=performance.now();d=await Se(X,le);const F=performance.now()-m;x.addAction("walnut_pptx_import_time_ms",{extension:"pptx",duration_ms:Math.round(F),file_size_bytes:ne})}else{const m=await k;if(!m)return;d=m.PptxReader.ExtractSlidesProto(X,!1)}if(!d)return;const de=Je.decode(d);r||I(p,{fileBlob:T,fileName:i,presentation:de,workbook:null,document:null,selectedSlideIdx:0,selectedSheetIdx:0});return}let w;if(g){const d=performance.now();w=await Se(X,le);const de=performance.now()-d;if(x.addAction("walnut_xlsx_import_time_ms",{extension:"xlsx",duration_ms:Math.round(de),file_size_bytes:ne}),w)try{const m=performance.now();w=await Ge(w,L);const F=performance.now()-m;x.addAction("walnut_xlsx_recalculate_time_ms",{extension:"xlsx",duration_ms:Math.round(F),file_size_bytes:ne})}catch(m){const F=m;x.addError(F,{file_id:f.file_id})}}else{const d=await k;if(!d)return;w=d.XlsxReader.ExtractXlsxProto(X,!1)}if(!w)return;const Me=Ke.decode(w);r||I(p,{fileBlob:T,fileName:i,presentation:null,workbook:Me,document:null,selectedSlideIdx:0,selectedSheetIdx:0})})().then(()=>{r||K(!1)}).catch(u=>{u instanceof DOMException&&u.name==="AbortError"||(x.addError(u,{message_id:o,filepath:t}),r||(V(!0),K(!1)))}),()=>{r=!0,n.abort()}},j=[t,i,E,o,k,l,g,L,I,p,f.file_id,c,P],e[27]=f.file_id,e[28]=i,e[29]=t,e[30]=c,e[31]=E,e[32]=o,e[33]=k,e[34]=l,e[35]=P,e[36]=g,e[37]=L,e[38]=I,e[39]=p,e[40]=N,e[41]=j):(N=e[40],j=e[41]),S.useEffect(N,j);const oe=P&&(Ee||!l),re=!D;let h;e[42]!==Y||e[43]!==te||e[44]!==Q||e[45]!==oe||e[46]!==re?(h={isPreviewCollapsed:re,isLoading:oe,isError:Q,errorMessage:Y,handleDownloadClick:te},e[42]=Y,e[43]=te,e[44]=Q,e[45]=oe,e[46]=re,e[47]=h):h=e[47];const ie=ve(i)==="pptx"?!1:Ie;let b;e[48]!==D?(b=D?void 0:()=>Pe(!0),e[48]=D,e[49]=b):b=e[49];let G;return e[50]!==f||e[51]!==a||e[52]!==i||e[53]!==o||e[54]!==J||e[55]!==h||e[56]!==ie||e[57]!==b?(G=Re.jsx(je,{citation:f,conversation:a,messageId:o,showWorksheetTabs:!0,showFileName:!0,isSandboxDownload:!0,sandboxOverrides:h,isResponsiveSheet:ie,responsiveSheetHeight:J,onPreviewTriggered:b,children:i}),e[50]=f,e[51]=a,e[52]=i,e[53]=o,e[54]=J,e[55]=h,e[56]=ie,e[57]=b,e[58]=G):G=e[58],G}const me=We({downloadFile:{id:"SandboxDownload.downloadFile",defaultMessage:"Download file"},downloadFailed:{id:"SandboxDownload.downloadFailed",defaultMessage:"Failed to download file"}});export{To as WalnutSandboxFileCitation};
//# sourceMappingURL=gf5v5n8wz716uyon.js.map
