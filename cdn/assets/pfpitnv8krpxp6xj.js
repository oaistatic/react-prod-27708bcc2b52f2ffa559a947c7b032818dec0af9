var tt=Object.defineProperty,st=Object.defineProperties;var at=Object.getOwnPropertyDescriptors;var Te=Object.getOwnPropertySymbols;var nt=Object.prototype.hasOwnProperty,rt=Object.prototype.propertyIsEnumerable;var Fe=(t,a)=>(a=Symbol[t])?a:Symbol.for("Symbol."+t);var Re=(t,a,s)=>a in t?tt(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,V=(t,a)=>{for(var s in a||(a={}))nt.call(a,s)&&Re(t,s,a[s]);if(Te)for(var s of Te(a))rt.call(a,s)&&Re(t,s,a[s]);return t},P=(t,a)=>st(t,at(a));var xe=(t,a,s)=>(a=t[Fe("asyncIterator")])?a.call(t):(t=t[Fe("iterator")](),a={},s=(n,r)=>(r=t[n])&&(a[n]=o=>new Promise((i,l,h)=>(o=r.call(t,o),h=o.done,Promise.resolve(o.value).then(g=>i({value:g,done:h}),l)))),s("next"),s("return"),a);import{e as T,j as e,M as u,r as d,b as ot,f as je,m as it,d as lt}from"./fg33krlcm0qyi6yw.js";import{a9 as B,H as ct,c as $,C as We,l as Be,i6 as mt,T as te,bX as dt,me as qe,p as ut,_ as ft,eD as ze,bg as ht,az as gt,aq as pt,ar as xt,m as vt,fZ as bt,ag as wt,gP as jt,b as yt}from"./mtk1qztvnb31pw5r.js";import{z as U,ao as fe,an as A,az as Mt,eN as St,gl as kt,gm as Nt,gg as He,cG as Ct,jS as Et,gd as Le,dx as At,fK as _t,gt as Vt}from"./k65njl5wlgspihfr.js";import{b as Tt,u as Ft,A as Rt,R as Lt,N as It,I as Dt,a as Ot}from"./m1mge0ilkwpbadjy.js";import{u as Pt}from"./ek8ypz08ir47cco2.js";import{F as W}from"./c39l581penbg6uen.js";import{s as K}from"./cmaobpdpreyiep8p.js";import{W as Ue}from"./sy1xvqwioh9ks4z8.js";import{S as ye}from"./ht7pa4q84q7i97x2.js";import{A as we}from"./kg0cp341m64rddpv.js";import{i as $e}from"./bes67zhi4fr5gq8i.js";import{u as Wt}from"./l09h2qppleubii6l.js";import{u as Bt}from"./mbk6r4n07eoyd764.js";import{i as qt}from"./kodpf00oq0c6g8b3.js";import{b as zt}from"./lptwpbjabrvjmhsj.js";import{u as Ht}from"./gp2ycmyaevvj2458.js";import{f as Ut}from"./n0ab5m1z76n8mazm.js";import{u as $t,a as Ie,b as I}from"./mh627gt08lvdeswk.js";function Kt({onChange:t,value:a}){const s=T();return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.descriptionSection.label",defaultMessage:"Description"})}),e.jsx("textarea",{name:"description","aria-label":s.formatMessage({id:"wham.environment.descriptionSection.description",defaultMessage:"Environment Description"}),placeholder:s.formatMessage({id:"wham.environment.descriptionSection.descriptionPlaceholder",defaultMessage:"1-2 sentence description"}),className:"border-token-border-heavy focus-within:border-token-border-heavy focus-within:ring-token-text-secondary bg-token-bg-primary h-16 max-h-48 w-full resize-none rounded-md border px-3 py-2 text-sm shadow-none focus-within:ring-1",value:a,onChange:n=>t(n.target.value)})]})}function Xt({repositoryId:t,existingEnvironment:a,setRepositoryName:s}){var r;const n=(r=a.repo_map)==null?void 0:r[t];return d.useEffect(()=>{n&&s(n.name)},[n,s]),n?e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.repositorySection.label",defaultMessage:"Repository"})}),e.jsx("div",{className:"border-token-border-heavy bg-token-bg-primary pointer-events-none rounded-lg border p-3",children:e.jsx(Tt,{repository:n,className:"pointer-events-none p-1",isSelected:!0})})]}):e.jsx("div",{className:"text-token-text-secondary flex h-full items-center text-sm",children:e.jsx(u,{id:"wham.createEnvironments.repositorySection.unavailable",defaultMessage:"Repository unavailable"})})}function Ke(t,a,s,n,r){const o=t.clipboardData.getData("text/plain"),i=Yt(o);if(i.length!==0){t.preventDefault(),s(a,r(i[0]));for(const l of i.slice(1))n(r(l))}}function Gt(t,a,s,n){Ke(t,a,s,n,r=>r)}function Xe(t,a,s,n){Ke(t,a,s,n,r=>P(V({},r),{isEditing:!1,domain:void 0,previousDomain:void 0,previousKey:void 0}))}function Yt(t){const a=[];for(let s of t.split(/\r?\n/)){if(s=s.trim(),!s||s.startsWith("#")||s.startsWith(";"))continue;s.startsWith("export ")&&(s=s.slice(7).trim());let n=!1,r=!1,o=!1,i=-1;for(let f=0;f<s.length;f++){const c=s[f];if(o){o=!1;continue}if(c==="\\"){o=!0;continue}if(c==="'"&&!r){n=!n;continue}if(c==='"'&&!n){r=!r;continue}if(c==="#"&&!n&&!r){i=f;break}}if(i!==-1&&(s=s.slice(0,i).trim()),!s)continue;n=r=o=!1;let l=-1;for(let f=0;f<s.length;f++){const c=s[f];if(o){o=!1;continue}if(c==="\\"){o=!0;continue}if(c==="'"&&!r){n=!n;continue}if(c==='"'&&!n){r=!r;continue}if(c==="="&&!n&&!r){l=f;break}}if(l===-1)continue;const h=s.slice(0,l).trim();if(!h)continue;let g=s.slice(l+1).trim();(g.startsWith('"')&&g.endsWith('"')||g.startsWith("'")&&g.endsWith("'"))&&(g=g.slice(1,-1)),a.push({key:h,value:g})}return a}function Jt({pushValue:t,removeValue:a,changeValue:s,values:n}){const r=T();return e.jsxs("div",{className:"mb-2 flex flex-col",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.envVarsSection.label",defaultMessage:"Environment variables"})}),n.map((o,i)=>o.key.startsWith("CODEX_ENV_")?null:e.jsx("div",{className:"flex gap-2 pt-4",children:e.jsx("div",{className:"flex w-full flex-1 flex-col gap-2",children:e.jsxs("div",{className:"flex w-full items-center gap-2",children:[e.jsx(U,{name:"envVars[".concat(i,"].key"),color:"search",containerInputClassName:"w-full",className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",value:o.key,onPaste:l=>Gt(l,i,s,t),onChange:l=>{s(i,P(V({},o),{key:l.target.value}))},placeholder:r.formatMessage({id:"wham.envVarsSection.keyPlaceholder",defaultMessage:"Key"}),ariaLabel:r.formatMessage({id:"wham.envVarsSection.keyAria",defaultMessage:"Environment variable key"})}),e.jsx(U,{name:"envVars[".concat(i,"].value"),className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",containerInputClassName:"w-full",color:"search",value:o.value,onChange:l=>{s(i,P(V({},o),{value:l.target.value}))},placeholder:r.formatMessage({id:"wham.envVarsSection.value",defaultMessage:"Value"}),ariaLabel:r.formatMessage({id:"wham.envVarsSection.environmentVariableValue",defaultMessage:"Environment variable value"})}),e.jsx(B,{type:"button",size:"small",color:"secondary",onClick:()=>a(i),"aria-label":r.formatMessage({id:"wham.createEnvironments.envVarsSection.deleteAriaLabel",defaultMessage:"Button to remove environment variable"}),children:e.jsx(u,{id:"wham.createEnvironments.envVarsSection.delete",defaultMessage:"Delete"})})]})})},i)),e.jsx("div",{className:"pt-2",children:e.jsx(B,{color:"secondary",size:"small",onClick:()=>{t({key:"",value:""})},type:"button",className:"w-fit","aria-label":r.formatMessage({id:"wham.createEnvironments.envVarsSection.addAriaLabel",defaultMessage:"Button to add another environment variable"}),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{id:"wham.createEnvironments.envVarsSection.add",defaultMessage:"Add"}),e.jsx(fe,{className:"icon-sm"})]})})})]})}const Qt=d.memo(Jt);function Zt({value:t=[],onChange:a,onBlur:s,disabled:n}){const r=T(),o=d.useMemo(()=>t==null?void 0:t.join("\n"),[t]);return e.jsxs("div",{className:"mt-4 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironment.shareTargets.label",defaultMessage:"Add additional editors"})}),e.jsx("p",{className:"text-token-text-tertiary text-xs",children:e.jsx(u,{id:"wham.createEnvironment.shareTargets.helper",defaultMessage:"Add one email per line. Users will be able to edit or delete this environment, or add and remove editors. The environment creator, and ChatGPT Workspace Admins, always have edit access."})})]}),e.jsx("textarea",{name:"shareTargets","aria-label":r.formatMessage({id:"wham.createEnvironment.shareTargets.ariaLabel",defaultMessage:"Environment share target emails"}),placeholder:r.formatMessage({id:"wham.createEnvironment.shareTargets.placeholder",defaultMessage:"user@example.com"}),className:"border-token-border-heavy focus-within:border-token-border-heavy focus-within:ring-token-text-secondary bg-token-bg-primary h-20 resize-y rounded-md border px-3 py-2 text-sm shadow-none focus-within:ring-1",value:o,onChange:i=>{a(i.target.value.split(/\r?\n/))},onBlur:s,disabled:n})]})}function es({value:t,onChange:a}){const s=T(),n=ct(),r=n==null?void 0:n.name,o=r!=null?r:s.formatMessage({id:"wham.createEnvironment.workspaceName",defaultMessage:"Workspace"});return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironment.environmentVisibility",defaultMessage:"Sharing"})}),e.jsxs(A.Root,{value:t,onValueChange:a,children:[e.jsx(A.Trigger,{className:"border-token-border-heavy bg-token-bg-primary flex w-fit rounded-md border","aria-label":s.formatMessage({id:"wham.createEnvironment.openVisibilityMenu",defaultMessage:"Open sharing menu"}),children:e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx("div",{className:"flex items-center",children:e.jsx(A.Value,{placeholder:s.formatMessage({id:"wham.createEnvironment.selectVisibility",defaultMessage:"Select visibility"})})}),e.jsx(A.Icon,{})]})}),e.jsx(A.Portal,{children:e.jsxs(A.Content,{align:"start",children:[e.jsx(A.Item,{value:"private",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(Mt,{"aria-hidden":!0,className:"icon-sm me-1.5"}),e.jsx(u,{id:"wham.createEnvironment.private",defaultMessage:"Only you"})]})}),e.jsx(A.Item,{value:"workspace",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(St,{"aria-hidden":!0,className:"icon-sm me-1.5"}),e.jsx(u,{id:"wham.createEnvironment.sharedWithWorkspace",defaultMessage:"Shared with {workspaceName}",values:{workspaceName:o}})]})})]})})]}),t==="workspace"&&e.jsx("p",{className:"text-token-text-tertiary text-xs",children:e.jsx(u,{id:"wham.createEnvironments.workspace.onlyYouCanEdit",defaultMessage:"Workspace members can launch tasks with this environment. Only you, ChatGPT Workspace Admins, and any additional editors can make changes."})})]})}const ts=d.memo(es);function ss({onChange:t,value:a}){const s=T();return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.label",defaultMessage:"Name"})}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(U,{name:"label",ariaLabel:s.formatMessage({id:"wham.labelSection.envAria",defaultMessage:"Environment name"}),placeholder:s.formatMessage({id:"wham.labelSection.namePlaceholder",defaultMessage:"Name"}),containerInputClassName:"w-full",className:"flex h-8 w-full items-center rounded-md!",inputClassName:"w-full text-sm",color:"search",value:a,onChange:n=>t(n.target.value)})})]})}const as=d.memo(ss),ns=$(K,"dd777f",24,24),rs=$(K,"c164d5",24,24),os=$(K,"c0d20b",24,24),is=$(K,"62f67d",24,24),ls=$(K,"67243e",222,120),cs=$(K,"03e9d0",24,24),ms=$(K,"c4352c",24,24),ds=$(K,"a8298c",24,24),us=$(K,"4d853d",24,24),Ge=[{key:"python",icon:cs,label:"Python",envVar:"CODEX_ENV_PYTHON_VERSION",versions:["3.14","3.13","3.12","3.11","3.10"],defaultVersion:"3.12"},{key:"nodejs",icon:is,label:"Node.js",envVar:"CODEX_ENV_NODE_VERSION",versions:["22","20","18"],defaultVersion:"20"},{key:"ruby",icon:ms,label:"Ruby",envVar:"CODEX_ENV_RUBY_VERSION",versions:["3.2.3","3.3.8","3.4.4"],defaultVersion:"3.4.4"},{key:"rust",icon:ds,label:"Rust",envVar:"CODEX_ENV_RUST_VERSION",versions:["1.89.0","1.88.0","1.87.0","1.86.0","1.85.1","1.84.1","1.83.0"],defaultVersion:"1.89.0"},{key:"go",icon:rs,label:"Go",envVar:"CODEX_ENV_GO_VERSION",versions:["1.25.1","1.24.3","1.23.8","1.22.12"],defaultVersion:"1.24.3"},{key:"bun",icon:ns,label:"Bun",envVar:"CODEX_ENV_BUN_VERSION",versions:["1.2.14"],defaultVersion:"1.2.14"},{key:"php",icon:ls,label:"PHP",envVar:"CODEX_ENV_PHP_VERSION",versions:["8.4","8.3","8.2"],defaultVersion:"8.4"},{key:"java",icon:os,label:"Java",envVar:"CODEX_ENV_JAVA_VERSION",versions:["21"],defaultVersion:"21"},{key:"swift",icon:us,label:"Swift",envVar:"CODEX_ENV_SWIFT_VERSION",versions:["6.2","6.1","5.10"],defaultVersion:"6.1"}],ma=Ge.map(t=>({key:t.envVar,value:t.defaultVersion}));function fs({selectedVersion:t,setSelectedVersion:a,versions:s,defaultVersion:n}){const r=T();return e.jsxs(A.Root,{value:t!=null?t:"",onValueChange:a,children:[e.jsx(A.Trigger,{className:"border-token-border-default bg-token-bg-primary! w-48 rounded-md! border","aria-label":r.formatMessage({id:"wham.createEnvironments.languageSelector.openVersionMenu",defaultMessage:"Open version menu"}),children:e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx(A.Value,{placeholder:r.formatMessage({id:"wham.createEnvironments.languageSelector.selectVersion",defaultMessage:"Select version"})}),e.jsx(A.Icon,{})]})}),e.jsx(A.Portal,{children:e.jsxs(A.Content,{align:"start",children:[s.map(o=>e.jsx(A.Item,{value:o,children:e.jsx("p",{className:Be("text-token-text-primary text-sm",o===n?"font-semibold":"font-normal"),children:o})},o)),s.length===1&&e.jsx("div",{className:"flex w-full items-center justify-center p-4",children:e.jsx("p",{className:"text-token-text-primary text-sm",children:r.formatMessage({id:"wham.createEnvironments.languageSelector.noVersions",defaultMessage:"No other versions available"})})})]})})]})}function hs({icon:t,language:a,versions:s,defaultVersion:n,selectedVersion:r,setSelectedVersion:o}){return e.jsxs("div",{className:"flex items-center justify-between gap-2 pe-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(t,{className:"icon"}),e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:a})]}),e.jsx(fs,{defaultVersion:n,selectedVersion:r,setSelectedVersion:o,versions:s})]})}function gs(t,a){var r,o;const s=t.split(".").map(Number),n=a.split(".").map(Number);for(let i=0;i<Math.max(s.length,n.length);i++){const l=(r=s[i])!=null?r:0,h=(o=n[i])!=null?o:0;if(l!==h)return h-l}return 0}function ps({onClose:t,envVars:a,pushValue:s,replaceValue:n}){const r=o=>i=>{const l=a.findIndex(h=>h.key===o);l!==-1?n(l,P(V({},a[l]),{value:i})):s({key:o,value:i})};return e.jsx(We,{isOpen:!0,onClose:t,type:"success",testId:"modal-language-selector-modal",showCloseButton:!0,className:"max-w-screen-xs",title:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(u,{id:"wham.languageModal.languageSelector.title",defaultMessage:"Preinstalled packages"}),e.jsx("p",{className:"text-token-text-secondary text-sm font-normal",children:e.jsx(u,{id:"wham.languageModal.languageSelector.description",defaultMessage:"Configure your own packages in the setup script."})})]}),children:e.jsx("div",{className:"flex flex-col gap-4",children:Ge.map(o=>{var h;const i=[...o.versions],l=(h=a.find(g=>g.key===o.envVar))==null?void 0:h.value;return l&&!i.includes(l)&&i.push(l),i.sort(gs),e.jsx(hs,{icon:o.icon,language:o.label,versions:i,selectedVersion:l!=null?l:o.defaultVersion,defaultVersion:o.defaultVersion,setSelectedVersion:g=>r(o.envVar)(g)},o.envVar)})})})}const re=64,ve=512,De="<REDACTED>",Oe=[{id:"wham-public/wham-universal",label:"universal"}];function xs({selectedMachineId:t,setSelectedMachineId:a}){const s=T(),{data:n}=ot({queryKey:["wham","machines"],queryFn:()=>Ue.getMachines()}),r=d.useMemo(()=>{const i=Array.isArray(n)?n:[],l=new Set(Oe.map(g=>g.id));return[...i.filter(g=>!l.has(g.id)),...Oe]},[n]);d.useEffect(()=>{!t&&r.length&&a(r[0].id)},[t,a,r]);const o=i=>{a(i)};return e.jsxs(A.Root,{value:t!=null?t:"",onValueChange:o,children:[e.jsx(A.Trigger,{className:"border-token-border-default! bg-token-bg-primary! w-48 rounded-md! border","aria-label":s.formatMessage({id:"wham.machineSelectorPopover.openMachineMenu",defaultMessage:"Open machine menu"}),children:e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx(A.Value,{placeholder:s.formatMessage({id:"wham.machineSelectorPopover.selectMachine",defaultMessage:"Select machine"})}),e.jsx(A.Icon,{})]})}),e.jsx(A.Portal,{children:e.jsx(A.Content,{align:"start",className:"bg-token-bg-primary",children:e.jsx(vs,{machines:r})})})]})}function vs({machines:t}){return e.jsxs("div",{className:"bg-token-bg-primary flex max-h-[400px] w-full flex-col gap-2 overflow-y-auto rounded-lg p-2",children:[t.length>0?t.map(a=>e.jsx(A.Item,{value:a.id,children:a.label},a.id)):e.jsx("div",{className:"p-2 text-center",children:e.jsx("p",{className:"text-token-text-secondary text-sm",children:e.jsx(u,{id:"wham.createEnvironments.machineSelector.noMatchesFound",defaultMessage:"No matches found"})})}),t.length===1&&e.jsx("div",{className:"p-2 text-start",children:e.jsx("p",{className:"text-token-text-tertiary ps-2 text-xs",children:e.jsx(u,{id:"wham.createEnvironments.machineSelector.noMachinesFound",defaultMessage:"Custom images coming soon"})})})]})}function bs({selectedMachineId:t,setSelectedMachineId:a,envVars:s,pushValue:n,replaceValue:r}){const o=T(),[i,l]=d.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.machineSelector",defaultMessage:"Container image"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(xs,{selectedMachineId:t,setSelectedMachineId:a}),e.jsx(B,{color:"secondary",size:"medium",type:"button",icon:mt,onClick:()=>{l(!0)},"aria-label":o.formatMessage({id:"wham.createEnvironments.languageSelector.titleAriaLabel",defaultMessage:"Button to open preinstalled packages modal"}),className:"w-fit",children:e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.languageSelector.title",defaultMessage:"Preinstalled packages"})})})]})]}),i&&e.jsx(ps,{onClose:()=>l(!1),envVars:s,pushValue:n,replaceValue:r})]})}const ws=d.memo(bs),me=je({toggleOffLabel:{id:"wham.postSetupCaching.off",defaultMessage:"Off"},toggleOnLabel:{id:"wham.postSetupCaching.on",defaultMessage:"On"},toggleOffAriaLabel:{id:"wham.postSetupCaching.offAriaLabel",defaultMessage:"Toggle to turn off post setup caching"},toggleOnAriaLabel:{id:"wham.postSetupCaching.onAriaLabel",defaultMessage:"Toggle to turn on post setup caching"}});function js({cacheSettings:t,onChange:a}){const s=T();return e.jsxs("div",{className:"mb-2 flex flex-col gap-2",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.postSetupCaching.title",defaultMessage:"Container Caching"})}),e.jsx("p",{className:"text-token-text-tertiary mb-1 text-xs",children:e.jsx(u,{id:"wham.postSetupCaching.description",defaultMessage:"Speed up container start by caching state after running the setup script. Maintenance scripts are run before every task."})}),e.jsx(ye,{className:"max-w-32",ariaLabel:s.formatMessage({id:"wham.postSetupCachingToggle.label",defaultMessage:"Container Caching"}),value:t!=null&&t.post_setup_cache_enabled?"on":"off",onChange:n=>a({post_setup_cache_enabled:n==="on"}),leftItem:{ariaLabel:s.formatMessage(me.toggleOffAriaLabel),label:s.formatMessage(me.toggleOffLabel),value:"off"},rightItem:{ariaLabel:s.formatMessage(me.toggleOnAriaLabel),label:s.formatMessage(me.toggleOnLabel),value:"on"}})]})}const ys=d.memo(js),de=je({offLabel:{id:"wham.secretsSection.toggle.off",defaultMessage:"Off"},onLabel:{id:"wham.secretsSection.toggle.on",defaultMessage:"On"},offAria:{id:"wham.secretsSection.toggle.offAria",defaultMessage:"Disable domain scoped secrets"},onAria:{id:"wham.secretsSection.toggle.onAria",defaultMessage:"Enable domain scoped secrets"}});function Ms({value:t,index:a,pushValue:s,changeValue:n,removeValue:r}){var i;const o=T();return e.jsxs("div",{className:"border-token-border-light bg-token-bg-primary mt-4 rounded-xl border p-4 shadow-sm",children:[e.jsxs("div",{className:"flex w-full items-center gap-3",children:[e.jsx(U,{name:"secrets[".concat(a,"].key"),color:"search",containerInputClassName:"w-full",className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",value:t.key,onPaste:l=>Xe(l,a,n,s),onChange:l=>{n(a,P(V({},t),{key:l.target.value}))},placeholder:o.formatMessage({id:"wham.secretsSection.keyPlaceholder",defaultMessage:"Key"}),ariaLabel:o.formatMessage({id:"wham.secretsSection.keyAria",defaultMessage:"Secret Key"})}),e.jsx(U,{name:"secrets[".concat(a,"].value"),className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",containerInputClassName:"w-full",color:"search",type:"password",value:t.value,onChange:l=>{n(a,P(V({},t),{value:l.target.value}))},placeholder:o.formatMessage({id:"wham.secretsSection.value",defaultMessage:"Value"}),ariaLabel:o.formatMessage({id:"wham.secretsSection.secretValue",defaultMessage:"Secret Value"})}),e.jsx(B,{type:"button",size:"small",color:"secondary",onClick:()=>r(a),"aria-label":o.formatMessage({id:"wham.createEnvironments.secretsSection.deleteAriaLabel",defaultMessage:"Button to remove secret"}),children:e.jsx(u,{id:"wham.createEnvironments.secretsSection.delete",defaultMessage:"Delete"})})]}),e.jsxs("div",{className:"border-token-border-light mt-3 border-t pt-3",children:[e.jsx("p",{className:"mb-1 text-xs text-gray-500",children:o.formatMessage({id:"wham.secretsSection.domainLabel",defaultMessage:"Domain (optional)"})}),e.jsx(U,{name:"secrets[".concat(a,"].domain"),value:(i=t.domain)!=null?i:"",onChange:l=>{n(a,P(V({},t),{domain:l.target.value}))},placeholder:o.formatMessage({id:"wham.secretsSection.domainPlaceholder",defaultMessage:"e.g. aws.amazon.com"}),ariaLabel:o.formatMessage({id:"wham.secretsSection.domainAria",defaultMessage:"Secret Domain"})})]})]})}function Ss({pushValue:t,removeValue:a,changeValue:s,values:n,enableAuthtranslator:r=!1,onEnableAuthtranslatorChange:o,isAuthtranslatorGateEnabled:i=!1}){const l=T(),[h,g]=d.useState(r&&i);d.useEffect(()=>{!i&&h&&g(!1)},[h,i]),d.useEffect(()=>{i&&g(r!=null?r:!1)},[r,i]);const f=i&&h;return e.jsxs("div",{className:"mb-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.secretsSection",defaultMessage:"Secrets"})}),i&&e.jsxs("div",{className:"text-token-text-secondary flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{id:"wham.createEnvironments.secretsSection.enableAuthtranslator",defaultMessage:"Enable domain scoped secrets"}),e.jsx(te,{label:l.formatMessage({id:"wham.createEnvironments.secretsSection.enableAuthtranslator.tooltip",defaultMessage:"Advanced prompt-injection protection: secrets never reach the model and are only sent to their domain."}),children:e.jsx(dt,{className:"icon text-token-text-tertiary"})})]}),e.jsx(ye,{className:"max-w-32",ariaLabel:l.formatMessage({id:"wham.createEnvironments.secretsSection.enableAuthtranslator.aria",defaultMessage:"Domain scoped secrets"}),value:h?"on":"off",onChange:c=>{const x=c==="on";g(x),o==null||o(x)},leftItem:{ariaLabel:l.formatMessage(de.offAria),label:l.formatMessage(de.offLabel),value:"off"},rightItem:{ariaLabel:l.formatMessage(de.onAria),label:l.formatMessage(de.onLabel),value:"on"}})]})]}),f&&e.jsxs("div",{className:"bg-token-bg-critical-muted border-token-border-light flex flex-col gap-1 rounded-lg border px-3 py-2",children:[e.jsx("p",{className:"text-token-text-critical text-xs font-medium",children:e.jsx(u,{id:"wham.createEnvironments.secretsSection.domainlessWarning.title",defaultMessage:"Domain required for injection"})}),e.jsx("p",{className:"text-token-text-secondary text-xs",children:e.jsx(u,{id:"wham.createEnvironments.secretsSection.domainlessWarning",defaultMessage:"Secrets without a domain won't be injected into the agent environment while this is on (setup scripts still receive their real values). Add a domain to make them available during tasks."})})]}),f?n.map((c,x)=>e.jsx(Ms,{value:c,index:x,pushValue:t,changeValue:s,removeValue:a},x)):n.map((c,x)=>e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(U,{name:"secrets[".concat(x,"].key"),color:"search",containerInputClassName:"w-full",className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",value:c.key,onPaste:N=>Xe(N,x,s,t),onChange:N=>{s(x,P(V({},c),{key:N.target.value}))},placeholder:l.formatMessage({id:"wham.secretsSection.keyPlaceholder",defaultMessage:"Key"}),ariaLabel:l.formatMessage({id:"wham.secretsSection.keyAria",defaultMessage:"Secret Key"})}),e.jsx(U,{name:"secrets[".concat(x,"].value"),className:"text-token-text-primary flex h-8 w-full items-center rounded-md!",containerInputClassName:"w-full",color:"search",type:"password",value:c.value,onChange:N=>{s(x,P(V({},c),{value:N.target.value}))},placeholder:l.formatMessage({id:"wham.secretsSection.value",defaultMessage:"Value"}),ariaLabel:l.formatMessage({id:"wham.secretsSection.secretValue",defaultMessage:"Secret Value"})}),e.jsx(B,{type:"button",size:"small",color:"secondary",onClick:()=>a(x),children:e.jsx(u,{id:"wham.createEnvironments.secretsSection.delete",defaultMessage:"Delete"})})]},x)),e.jsx("div",{className:"pt-2",children:e.jsx(B,{color:"secondary",size:"small",onClick:()=>{t({key:"",value:"",isEditing:!1,domain:f?null:void 0,previousDomain:void 0,previousKey:void 0})},type:"button",className:"w-fit","aria-label":l.formatMessage({id:"wham.createEnvironments.secretsSection.addAriaLabel",defaultMessage:"Button to add another secret"}),children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{id:"wham.createEnvironments.secretsSection.add",defaultMessage:"Add"}),e.jsx(fe,{className:"icon-sm"})]})})})]})}const ks=d.memo(Ss),Ns="# e.g.\npip install -r requirements.txt\nnpm install\n./run/maintenance_setup.sh\n";function Cs({script:t,onChange:a}){const s=T(),n=Math.min(10,Math.max(4,t.split("\n").length));return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.maintenanceSetupCommandsSection",defaultMessage:"Maintenance script"})})}),e.jsx("div",{className:"flex items-center gap-2 pt-2",children:e.jsx("textarea",{name:"setupCommands",className:"border-token-border-default focus-within:border-token-border-heavy focus-within:ring-token-text-secondary bg-token-bg-primary min-h-32 w-full resize-y rounded-md border px-3 py-2 font-mono text-xs shadow-none focus-within:ring-1",value:t,rows:n,onChange:r=>{a(r.target.value)},placeholder:Ns,"aria-label":s.formatMessage({id:"wham.maintenanceSetupCommandsSection.maintenanceSetupCommand",defaultMessage:"Maintenance Setup Command"})})}),e.jsx("p",{className:"text-token-text-tertiary pt-2 text-xs",children:e.jsx(u,{id:"wham.createEnvironments.maintenanceSetupCommandsSection.description",defaultMessage:"The maintenance script is run in containers that were resumed from the cache, after checking out the branch.{br}<strong>Network access is always enabled for this step.</strong>",values:{br:e.jsx("br",{}),strong:r=>e.jsx("span",{className:"font-semibold",children:r})}})})]})}const Es=d.memo(Cs),As="# e.g.\npip install -r requirements.txt\nnpm install\n./run/setup.sh\n",ue=je({toggleAutomaticLabel:{id:"wham.autoSetup.automatic",defaultMessage:"Automatic"},toggleManualLabel:{id:"wham.autoSetup.manual",defaultMessage:"Manual"},toggleAutomaticAriaLabel:{id:"wham.autoSetup.automaticAriaLabel",defaultMessage:"Toggle to turn on automatic setup"},toggleManualAriaLabel:{id:"wham.autoSetup.manualAriaLabel",defaultMessage:"Toggle to turn on auto setup"}});function _s({value:t,onChangeAutoSetupSettings:a}){const s=T();return e.jsx(ye,{className:"max-w-64",ariaLabel:s.formatMessage({id:"wham.autoSetup.label",defaultMessage:"Auto setup"}),value:t?"on":"off",onChange:n=>{a(n==="off"?{use_auto_setup:!0}:{use_auto_setup:!1})},leftItem:{ariaLabel:s.formatMessage(ue.toggleAutomaticAriaLabel),label:s.formatMessage(ue.toggleAutomaticLabel),value:"off"},rightItem:{ariaLabel:s.formatMessage(ue.toggleManualAriaLabel),label:s.formatMessage(ue.toggleManualLabel),value:"on"}})}function Vs({setupScript:t,maintenanceScript:a,onSetupScriptChange:s,onMaintenanceScriptChange:n,setupScriptChildren:r,maintenanceScriptChildren:o,onClickAppendReplHistory:i,inputRef:l,replCommandHistory:h,suggestedCommand:g,onClickAcceptSuggestedCommand:f,autoSetupSettings:c,onChangeAutoSetupSettings:x,postSetupCacheEnabled:N}){var y;const b=T(),w=t===""&&c==null,j=(y=c==null?void 0:c.use_auto_setup)!=null?y:w;return e.jsxs("div",{className:"mb-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-token-text-primary text-sm font-medium",children:e.jsx(u,{id:"wham.createEnvironments.setupCommandsSection",defaultMessage:"Setup script"})}),!j&&e.jsx(e.Fragment,{children:g?e.jsx(te,{className:"-my-2.5 block",label:b.formatMessage({id:"wham.createEnv.terminal.addCommandSuggestion",defaultMessage:"Add suggestion to setup script"}),children:e.jsx(B,{type:"button",color:"secondary",size:"small",onClick:f,icon:fe,children:e.jsx("span",{className:"max-w-[200px] truncate font-mono text-xs",children:g.trimEnd().replace("\n","; ")})})}):h.length>0?e.jsx(te,{className:"-my-2.5 block",label:b.formatMessage({id:"wham.createEnv.terminal.addCommands",defaultMessage:"Add commands you've run to the setup script"}),children:e.jsx(B,{type:"button",color:"secondary",size:"small",onClick:i,icon:fe,children:e.jsx(u,{id:"wham.createEnvironments.terminalSection.addToSetupScript",defaultMessage:"New commands ({count})",values:{count:h.length}})})}):null})]}),e.jsx(_s,{value:!j,onChangeAutoSetupSettings:x}),j&&e.jsx("p",{className:"text-token-text-tertiary mb-1 text-xs",children:e.jsx(u,{id:"wham.autoSetup.description",defaultMessage:"Runs the install commands like npm install for common package managers. <docs>Learn more.</docs>",values:{docs:M=>e.jsx("a",{href:"https://platform.openai.com/docs/codex/overview#setup-scripts",target:"_blank",rel:"noopener noreferrer",className:"underline",children:M})}})}),!j&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 pt-2",children:e.jsx("textarea",{ref:l,name:"setupCommands",className:"border-token-border-default focus-within:border-token-border-heavy focus-within:ring-token-text-secondary bg-token-bg-primary min-h-32 w-full resize-y rounded-md border px-3 py-2 font-mono text-xs shadow-none focus-within:ring-1",value:t,rows:Math.min(10,Math.max(4,t.split("\n").length)),onChange:M=>{s(M.target.value)},placeholder:As,"aria-label":b.formatMessage({id:"wham.setupCommandsSection.setupCommand",defaultMessage:"Setup Command"})})}),e.jsx("p",{className:"text-token-text-tertiary pt-2 text-xs",children:N?e.jsx(u,{id:"wham.createEnvironments.setupCommandsSection.withCachingDescription",defaultMessage:"The setup script is run after creating new containers, after the repo is cloned.{br}<strong>Network access is always enabled for this step.</strong>",values:{br:e.jsx("br",{}),strong:M=>e.jsx("span",{className:"font-semibold",children:M})}}):e.jsx(u,{id:"wham.createEnvironments.setupCommandsSection.description",defaultMessage:"The setup script is run at the start of every task, after the repo is cloned.{br}<strong>Network access is always enabled for this step.</strong>",values:{br:e.jsx("br",{}),strong:M=>e.jsx("span",{className:"font-semibold",children:M})}})}),r]}),N&&!j&&e.jsxs(e.Fragment,{children:[e.jsx(Es,{script:a,onChange:n}),o]})]})}const Ts=d.memo(Vs);function Fs(t,a,s){var o,i,l,h,g;if(t.some(f=>f.domain!==void 0)||!!(s!=null&&s.length)){const f=[],c=(w,j)=>"".concat(w,"::").concat(j!=null?j:"__global__"),x=(o=s==null?void 0:s.filter(w=>!!w.name))!=null?o:[],N=new Map;if(x.length>0)for(const w of x){const j=(i=w.name)!=null?i:"";N.set(c(j,(l=w.domain)!=null?l:null),{name:j,domain:(h=w.domain)!=null?h:null})}else for(const w of Object.keys(a))N.set(c(w,null),{name:w,domain:null});const b=new Set;for(const{key:w,value:j,domain:y,previousDomain:M,previousKey:C}of t){const S=y!=null?y:null;if(M===void 0){j!==""&&f.push({name:w,domain:S,value:j});continue}const D=M!=null?M:null,E=C!=null?C:w,p=c(E,D);b.add(p);const F=a[E],H=j!==De&&j!==F,L=D!==S,R=C!==void 0&&C!==w;(L||H||R)&&f.push(V({name:w,domain:S,value:H?j:null,previous_domain:D},R?{previous_name:E}:{}))}for(const[w,j]of N.entries())b.has(w)||f.push({name:j.name,domain:null,value:null,previous_domain:(g=j.domain)!=null?g:null});return f}const r={};for(const{key:f,value:c}of t){const x=a[f];x===void 0?c!==""&&(r[f]=c):c!==De&&c!==x&&(r[f]=c)}for(const f of Object.keys(a))t.some(c=>c.key===f)||(r[f]=null);return r}const Rs=t=>Array.isArray(t),Ls=t=>t.map(a=>{var s,n;return P(V({},a),{previous_domain:(s=a.previous_domain)!=null?s:null,previous_name:(n=a.previous_name)!=null?n:null})});function Is({onSuggestCommand:t}){const a=T(),[s,n]=d.useState([]),[r,o]=d.useState(null),[i,l]=d.useState(!1),[h,g]=d.useState(null),f=d.useRef(null),c=d.useCallback(async b=>{try{try{for(var w=xe(b),j,y,M;j=!(y=await w.next()).done;j=!1){const C=y.value;const S=Ye(C);if(!S)continue;const D=S.type;switch(D){case"client_error":case"server_error":o(S.message);break;case"log":{if(S.key==="heartbeat")break;if(S.key==="suggest_command")t(S.line);else if(S.key.startsWith("userscript_")){const[,E]=S.key.split("_"),p=Number(E);if(!Number.isFinite(p))return;S.line.startsWith("+ ")?n(F=>[...F,{messageType:"user",line:S.line.slice(2),scriptIndex:p}]):n(F=>[...F,{messageType:"output",line:S.line,scriptIndex:p}])}else S.line.startsWith("+ ")?n(E=>[...E,{messageType:"server",line:S.line.slice(2)}]):n(E=>[...E,{messageType:"output",line:S.line}]);break}case"test_session_started":g(S.test_session_id);break;default:qe(D)}}}catch(y){M=[y]}finally{try{j&&(y=w.return)&&await y.call(w)}finally{if(M)throw M[0]}}}catch(C){if($e(C))return;if(C instanceof ut&&C.status===429){o(a.formatMessage({id:"wham.useStreamTestEnv.errorRateLimited",defaultMessage:"Too many requests: Your environment didn't start because we're at capacity. Try again soon."}));return}o(a.formatMessage({id:"wham.useStreamTestEnv.errorConnecting",defaultMessage:"Error connecting to the test environment"}))}finally{l(!1)}},[a,t]),x=async(b,w,j={})=>{f.current=new AbortController,n([]),l(!0),o(null),g(null);const M="".concat(window.location.origin+"/backend-api","/wham/environments/test"),C=Fs(b.secrets,j),S=Rs(C)?{secrets_with_domains:Ls(C)}:{secrets:C},D=b.envVars.reduce((L,R)=>(L[R.key]=R.value,L),{}),E=await kt("codex_environment_test").catch(L=>{ft.addError(L)}),p=V(P(V({},ze({isAuthOptional:!1})),{"Content-Type":"application/json"}),Nt(null,null,null,E)),F=V(V(V(V({machine_id:b.machine,repos:[b.repositoryId],setup:[b.setupCommands],maintenance_setup:[b.maintenanceSetupCommands],workspace_dir:b.workspaceDirectory,env_vars:D},S),w===void 0?{}:{environment_id:w}),b.agentNetworkAccess===void 0?{}:{agent_network_access:b.agentNetworkAccess}),b.autoSetupSettings===void 0?{}:{auto_setup_settings:b.autoSetupSettings}),H=He(M,{method:"POST",body:F,signal:f.current.signal,headers:p,observer:{onClose:(L,R)=>{l(!1),L==="error"&&R instanceof Error&&o(R.message)}}});(async()=>await c(H))()},N=d.useCallback(()=>{var b;(b=f.current)==null||b.abort(),n(w=>[...w,{messageType:"output",line:"Test cancelled"}])},[]);return d.useEffect(()=>()=>{var b;(b=f.current)==null||b.abort()},[]),{messages:s,error:r,setError:o,isStreaming:i,startTestEnvironment:x,abortTestEnvironment:N,testSessionId:h,setTestSessionId:g}}function Ye(t){return!("data"in t)||!t.data?null:t.data}function Ds({testSessionId:t,replOutput:a,inputRef:s,setReplOutput:n,setError:r,onSetConnected:o,onSubmitCommand:i}){const l=T(),[h,g]=d.useState(""),f=d.useCallback(({command:y})=>{t&&Ue.runEnvironmentTestCommand({command:y,testSessionId:t})},[t]),c=d.useCallback(async y=>{try{try{for(var M=xe(y),C,S,D;C=!(S=await M.next()).done;C=!1){const E=S.value;const p=Ye(E);if(!p)continue;const F=p.type;switch(F){case"client_error":case"server_error":r(p.message);break;case"log":{const L=Bs(p.line).replace(/\x1b\].*?\x07/g,"").replace(/\x1b\[\?2004[hl]/g,"");n(R=>[...R,L]);break}case"test_session_started":break;default:qe(F)}}}catch(S){D=[S]}finally{try{C&&(S=M.return)&&await S.call(M)}finally{if(D)throw D[0]}}}catch(E){if($e(E))return;r(l.formatMessage({id:"wham.envTestRepl.error",defaultMessage:"Error connecting to the test environment"}))}},[l,r,n]),{connected:x}=Ps({testSessionId:t,processStream:c,setError:r});d.useEffect(()=>{o(x)},[x,o,n]),d.useEffect(()=>{t||n([])},[t,n]);const N=d.useRef(null),b=a.map((y,M)=>e.jsx(we,{children:y.replace(/\x1b\].*?\x07/g,"")},M)),[w,j]=d.useState(!1);return t?e.jsxs("div",{className:"flex w-full flex-col whitespace-pre",children:[b,e.jsxs("div",{className:"relative w-full p-0 text-[12px] leading-4 focus:ring-0",children:[e.jsxs("span",{"aria-hidden":!0,className:"flex min-h-4 min-w-2",children:[h,e.jsx("span",{className:"inline-block h-auto w-2",children:w?e.jsx("div",{className:"bg-token-text-primary h-full w-full"}):e.jsx(ht.div,{className:"bg-token-text-primary h-full w-full",animate:{opacity:[0,1,0]},transition:{type:"tween",ease:"easeInOut",duration:2,repeat:1/0}})})]}),e.jsx("input",{type:"text",className:"absolute h-[1px] w-[1px] opacity-0",disabled:!x,onChange:y=>g(y.target.value),onFocus:()=>j(!0),onBlur:()=>j(!1),onKeyDown:y=>{const M=Os(y);if(M){y.preventDefault(),g(""),f({command:M});return}if(y.key==="Enter"){y.preventDefault(),g("");const C=h+"\n";i(C),f({command:C})}},value:h,ref:Ct(s,N)})]})]}):null}function Os(t){return t.ctrlKey?t.key==="c"?"":t.key==="d"?"":null:null}function Ps({testSessionId:t,processStream:a,setError:s}){const[n,r]=d.useState(!1),o=d.useCallback(i=>{const h="".concat(window.location.origin+"/backend-api","/wham/environments/test/").concat(t,"/stream"),g=He(h,{method:"POST",signal:i.signal,headers:P(V({},ze({isAuthOptional:!1})),{"Content-Type":"application/json"}),observer:{onOpen:()=>{r(!0)},onClose:(f,c)=>{r(!1),f==="error"&&c instanceof Error&&s(c.message)}}});(async()=>await a(g))()},[t,a,s]);return d.useEffect(()=>{if(!t)return;const i=new AbortController;return o(i),()=>{i.abort()}},[t,o]),{connected:n}}const Ws=new TextDecoder("utf-8");function Bs(t){const a=atob(t),s=a.length,n=new Uint8Array(s);for(let r=0;r<s;r+=1)n[r]=a.charCodeAt(r);return Ws.decode(n)}function qs({formValues:t,initialSecrets:a,environmentId:s,onConnectedChange:n,onSubmitCommand:r,onSuggestCommand:o}){const i=T(),{messages:l,error:h,setError:g,abortTestEnvironment:f,isStreaming:c,startTestEnvironment:x,testSessionId:N,setTestSessionId:b}=Is({onSuggestCommand:o}),[w,j]=d.useState([]),y=d.useRef(null),M=d.useRef(null),[C,S]=d.useState(!1);d.useEffect(()=>{S(!0)},[t]);const[D,E]=d.useState(!0);d.useEffect(()=>{if(y.current&&M.current&&D){const k=y.current,_=M.current;_.scrollTop=k.offsetTop-_.offsetTop-_.clientHeight/2+k.clientHeight/2}},[l,w,D]);const p=()=>{const k=M.current;if(!k)return;const _=Math.abs(k.scrollTop+k.clientHeight-k.scrollHeight)<2;E(_)},[F,H]=d.useState(!1),[L,R]=d.useState(!1),se=()=>{H(!0),S(!1),b(null),x(t,s,a)},oe=k=>{R(k),n(k)};d.useEffect(()=>()=>n(!1),[]);const ie=d.useRef(null),le=!L&&!c,q=!le&&C,Q=le&&!F||q,Y=!t.repositoryId,[X,G]=d.useState(!1),J=e.jsx("div",{className:"absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/20 dark:bg-white/5",onMouseUp:k=>k.stopPropagation(),onClick:async()=>{q&&(S(!1),G(!0),await new Promise(k=>setTimeout(k,3e3)),G(!1))},children:e.jsx(te,{open:Y||q?void 0:!1,label:Y?i.formatMessage({id:"wham.createEnv.terminal.selectRepo",defaultMessage:"Please select a repository"}):q?i.formatMessage({id:"wham.createEnv.terminal.restartTooltip",defaultMessage:"Changes will only be reflected after a restart."}):void 0,children:e.jsx(B,{onClick:se,disabled:!t.repositoryId,type:"button",color:"primary-inverse",icon:Et,children:q?e.jsx(u,{id:"wham.createEnvironments.terminalSection.reRunSetupScript",defaultMessage:"Re-run setup script"}):e.jsx(u,{id:"wham.createEnvironments.terminalSection.runSetupScript",defaultMessage:"Connect interactive terminal"})})})}),[{height:he},Z]=Wt();return e.jsxs("div",{onMouseUp:k=>{var _,ee;(_=document.getSelection())!=null&&_.toString()||((ee=ie.current)==null||ee.focus(),k.preventDefault())},className:"dark focus-within:ring-primary relative flex h-full w-full flex-col overflow-hidden rounded-xl ring-offset-2 focus-within:ring-2",children:[e.jsxs("div",{ref:Z,className:"bg-token-bg-tertiary flex shrink-0 flex-row justify-between p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-white",children:e.jsx(u,{id:"wham.createEnvironments.terminalSection",defaultMessage:"Terminal"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[(L||!!h||F&&!c)&&e.jsx(te,{className:"flex",open:X?!0:void 0,label:i.formatMessage({id:"wham.createEnvironments.terminalSection.restartSessionTooltip",defaultMessage:"Restart terminal session"}),children:e.jsx(Le,{icon:e.jsx(At,{className:"icon-sm"}),className:"-m-1 h-6! w-6!",onClick:se,onMouseEnter:()=>G(!1),label:i.formatMessage({id:"wham.createEnvironments.terminalSection.restartSession",defaultMessage:"Restart session"})})}),c&&e.jsx(te,{className:"flex",open:X?!0:void 0,label:i.formatMessage({id:"wham.createEnvironments.terminalSection.cancelSessionTooltip",defaultMessage:"Cancel terminal session"}),children:e.jsx(Le,{icon:e.jsx(_t,{className:"icon-sm"}),className:"-m-1 h-6! w-6!",onClick:f,label:i.formatMessage({id:"wham.createEnvironments.terminalSection.cancelSession",defaultMessage:"Cancel session"})})}),L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-white",children:e.jsx(u,{id:"wham.createEnvironments.terminalSection.connected",defaultMessage:"Connected"})}),e.jsx(be,{color:"#52EA00"})]}):c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-white",children:e.jsx(u,{id:"wham.createEnvironments.terminalSection.initializing",defaultMessage:"Initializing"})}),e.jsx(be,{color:"#FF9800"})]}):F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xs text-white",children:e.jsx(u,{id:"wham.createEnvironments.terminalSection.disconnected",defaultMessage:"Disconnected"})}),e.jsx(be,{color:"#FF0000"})]}):null]})]}),h&&e.jsxs("div",{style:{top:he},className:"bg-token-bg-status-error text-token-text-status-error absolute start-0 end-0 top-0 z-20 flex flex-col gap-2 px-4 py-3 text-sm",children:[e.jsx("p",{className:"font-medium",children:e.jsx(u,{id:"wham.createEnvironments.terminalSection.error",defaultMessage:"Terminal errored"})}),e.jsx("p",{className:"font-mono text-xs",children:h})]}),Q&&J,e.jsxs("div",{className:"bg-token-bg-secondary relative flex flex-1 flex-col overflow-y-auto p-4 font-mono text-xs text-white",onScroll:p,ref:M,children:[l.length===0&&!c&&e.jsx("p",{className:"text-token-text-tertiary",children:"".concat(t.workspaceDirectory," $")}),l.map((k,_)=>k.messageType==="user"?e.jsx(we,{className:"text-token-text-tertiary",children:"â†’ "+k.line},_):k.messageType==="server"?e.jsx("p",{className:"text-token-text-tertiary",children:k.line}):e.jsx(we,{children:k.line},_)),e.jsx(Ds,{inputRef:ie,testSessionId:N,replOutput:w,setReplOutput:j,setError:g,onSetConnected:oe,onSubmitCommand:r}),e.jsx("div",{ref:y})]})]})}function be({color:t}){return e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"6",height:"6",viewBox:"0 0 6 6",fill:"none",className:"animate-pulse",children:e.jsx("circle",{cx:"3",cy:"3",r:"3",fill:t})})}function zs({workspaceDirectory:t,repositoryName:a,onChange:s,onClose:n,errors:r}){const o=T(),[i,l]=d.useState(t),[h]=d.useState(t!=null?t:"/workspace"),g=o.formatMessage({id:"wham.createEnvironments.workspaceEditorModal.defaultRepositoryName",defaultMessage:"repository"}),f=o.formatMessage({id:"wham.editWorkspace.modal.title",defaultMessage:"Edit workspace"}),c=({forceClear:x}={})=>{(r.length>0||x)&&s(h),n()};return e.jsxs(We,{isOpen:!0,onClose:()=>c(),type:"success",testId:"modal-workspace-editor-modal",children:[e.jsxs(gt,{children:[e.jsx(pt,{children:f}),e.jsx(xt,{children:f})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"text-token-text-primary text-xl font-medium",children:e.jsx(u,{id:"wham.createEnvironments.workspaceEditorModal.title",defaultMessage:"Edit workspace directory"})}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(U,{name:"workspaceDirectory",value:i,onChange:x=>{l(x.target.value),s(x.target.value)},inputClassName:"w-full",containerInputClassName:"w-full",color:"quaternary",ariaLabel:o.formatMessage({id:"wham.createEnvironments.workspaceEditorModal.inputAriaLabel",defaultMessage:"Workspace directory"})})}),r.length>0&&e.jsx("div",{className:"flex flex-col gap-2",children:r.map(x=>e.jsx("div",{className:"text-token-text-status-error text-xs",children:x},x))}),e.jsx("div",{className:"text-token-text-tertiary text-xs",children:e.jsx(u,{id:"wham.createEnvironments.workspaceEditorModal.description",defaultMessage:"The repository will be cloned to {workspaceDirectory}/{repositoryName}. You only need to adjust this if your code requires an absolute install path.",values:{repositoryName:a!=null?a:g,workspaceDirectory:t!=null?t:h}})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(B,{color:"secondary",onClick:()=>c({forceClear:!0}),children:e.jsx(u,{id:"wham.createEnvironments.workspaceEditorModal.cancelButton",defaultMessage:"Cancel"})}),e.jsx(B,{onClick:()=>n(),disabled:r.length>0,children:e.jsx(u,{id:"wham.createEnvironments.workspaceEditorModal.saveButton",defaultMessage:"Save"})})]})]})]})}const Hs=d.memo(zs);function Pe({current:t,max:a,className:s}){return e.jsx("span",{className:"text-xs ".concat(t>a?"text-token-text-status-error":"text-token-text-tertiary"," ").concat(s!=null?s:"").trim(),children:e.jsx(u,{id:"wham.characterCount.display",defaultMessage:"{current}/{max}",values:{current:t,max:a}})})}function da({initialEnvironmentId:t,initialValues:a,primaryButtonText:s,onSubmit:n,isPending:r,existingEnvironment:o}){var ke,Ne,Ce,Ee,Ae,_e,Ve;const[i,l]=d.useState(null),[h,g]=d.useState(null),{data:f}=Ut(),c=T(),x=vt(),N=d.useRef(null),[b,w]=d.useState(!1),j=Pt(),y=Bt(),[M,C]=d.useState(null),S=it(),D=yt(),E=qt(D),p=$t({defaultValues:a,validators:{onSubmit:({value:m})=>{var z,ne;m.machine||(m.machine=a.machine);const v={};if(m.label.trim()||(v.label=c.formatMessage({id:"wham.environmentsForm.labelIsRequired",defaultMessage:"Label is required"})),m.label.length>re&&(v.label=c.formatMessage({id:"wham.environmentsForm.labelMaxChars",defaultMessage:"Label must be at most {max} characters"},{max:re})),f!=null&&f.find(O=>O.label===m.label&&O.id!==t)&&(v.label=c.formatMessage({id:"wham.environmentsForm.labelAlreadyExistsInYourAccountPleaseChooseAnotherName",defaultMessage:"An environment with this name already exists. Try choosing another name."})),m.repositoryId.trim()||(v.repositoryId=c.formatMessage({id:"wham.environmentsForm.repositoryRequired",defaultMessage:"Repository is required"})),m.machine.trim()||(v.machine=c.formatMessage({id:"wham.environmentsForm.machineRequired",defaultMessage:"Machine is required"})),m.description&&m.description.length>ve&&(v.description=c.formatMessage({id:"wham.environmentsForm.descriptionMaxChars",defaultMessage:"Description must be at most {max} characters"},{max:ve})),m.secrets.some(O=>O.value===""||O.key==="")&&(v.secrets=c.formatMessage({id:"wham.environmentsForm.secretRequired",defaultMessage:"Secret value is required"})),y){const O=((z=m.share_targets)!=null?z:[]).map(et=>et.trim()).filter(Boolean);m.share_targets=O,O.length>0&&m.share_settings==="private"&&(v.share_targets=c.formatMessage({id:"wham.environmentsForm.shareTargetsRequiresVisibility",defaultMessage:"Share targets require workspace or public visibility."}))}else delete m.share_targets;return m.envVars.some(O=>O.key===""||O.value==="")&&(v.envVars=c.formatMessage({id:"wham.environmentsForm.valueRequired",defaultMessage:"Environment variable value is required"})),m.secrets.some(O=>O.isEditing)&&(v.secrets=c.formatMessage({id:"wham.environmentsForm.editingSecrets",defaultMessage:"Secrets are being edited"})),((ne=m.agentNetworkAccess)==null?void 0:ne.mode)==="on"&&m.agentNetworkAccess.preset_allowlist===zt&&(!m.agentNetworkAccess.allowlist_domains||m.agentNetworkAccess.allowlist_domains.length===0)&&(v.agentNetworkAccess=c.formatMessage({id:"wham.environmentsForm.agentNetworkAccessAllowlistRequired",defaultMessage:"At least one domain is required"})),Object.keys(v).length>0&&x.danger(lt({id:"wham.environmentsForm.validationError",defaultMessage:"Please address the validation issues in the form."}),{toastId:"wham_environments_form_validation_error"}),{fields:v}}},onSubmit:({value:m})=>{n(m)}}),F=Ie(p.store,m=>m.isDirty),[H,L]=d.useState(!1),[R,se]=d.useState([]),oe=d.useRef(null),ie=Ht(oe);d.useEffect(()=>!F&&!H&&!R.length?void 0:bt(window,{beforeunload:v=>{v.preventDefault(),v.returnValue=c.formatMessage({id:"wham.environmentsForm.unsavedChanges",defaultMessage:"You have unsaved changes to your environment. Are you sure you want to leave?"})}}),[c,F,H,R]),d.useEffect(()=>{S.hash==="#setup-script"&&setTimeout(()=>{N.current&&(N.current.scrollIntoView({behavior:"smooth",block:"center"}),N.current.focus())},0)},[S.hash]);const le=m=>{m.preventDefault(),m.stopPropagation(),p.handleSubmit()},q=I({name:"label",form:p,validators:{onChange:({value:m})=>{if(m.length>re)return c.formatMessage({id:"wham.environmentsForm.labelMaxChars",defaultMessage:"Label must be at most {max} characters"},{max:re});if(f!=null&&f.find(v=>v.label===m&&v.id!==t))return c.formatMessage({id:"wham.environmentsForm.labelAlreadyExistsInYourAccountPleaseChooseAnotherName",defaultMessage:"An environment with this name already exists. Try choosing another name."})}}}),Q=I({name:"repositoryId",form:p}),Y=I({name:"description",form:p}),X=I({name:"secrets",form:p,mode:"array"}),G=I({name:"share_settings",form:p}),J=I({name:"share_targets",form:p,mode:"array"}),he=m=>{G.handleChange(m),y&&m==="private"&&J.handleChange([])},Z=I({name:"agentNetworkAccess",form:p}),k=I({name:"cacheSettings",form:p}),_=I({name:"envVars",form:p,mode:"array"}),ee=I({name:"machine",form:p}),Me=I({name:"autoSetupSettings",form:p}),ae=I({name:"setupCommands",form:p,mode:"array"}),ge=I({name:"maintenanceSetupCommands",form:p,mode:"array"}),ce=I({name:"workspaceDirectory",form:p,validators:{onChange:({value:m})=>{if(m)if(m.includes("/")){if(m==="/")return c.formatMessage({id:"wham.environmentsForm.workspaceDirectoryCannotBeRoot",defaultMessage:"Workspace directory cannot be root"})}else return c.formatMessage({id:"wham.environmentsForm.workspaceDirectoryMustContainASlash",defaultMessage:"Workspace directory must contain a slash"});else return c.formatMessage({id:"wham.environmentsForm.workspaceDirectoryRequired",defaultMessage:"Workspace directory is required"})}}}),Je=Ie(p.store,m=>{var v;return(v=m.values.enableAuthtranslator)!=null?v:!1}),Qe=E?Je:!1;d.useEffect(()=>{var m;E||((m=p.state.values.enableAuthtranslator)!=null?m:void 0)!==void 0&&p.setFieldValue("enableAuthtranslator",void 0)},[p,E]);const Se=wt(),Ze=!!Se&&jt(Se),pe=Ft();return e.jsx("form",{ref:oe,onSubmit:le,className:Be("mx-auto flex min-h-0 w-full grow flex-col items-center overflow-y-auto px-8",ie&&"border-t"),children:e.jsxs("div",{className:"flex w-full max-w-screen-2xl flex-col",children:[e.jsxs("div",{className:"flex flex-col overflow-clip rounded-xl border bg-[#F7F7F7] dark:bg-[#1E1E1E]",children:[e.jsx("div",{className:"bg-token-bg-primary w-full border-b p-4 text-xl font-medium",children:e.jsx(u,{id:"wham.environmentsForm.basic",defaultMessage:"Basic"})}),e.jsxs("div",{className:"flex w-full flex-col p-4 md:max-w-[50%]",children:[!o&&e.jsx(Rt,{className:"mb-4",selectedInstallationId:(ke=i==null?void 0:i.id)!=null?ke:null,setSelectedInstallation:l}),o?e.jsx(Xt,{repositoryId:Q.state.value,existingEnvironment:o,setRepositoryName:g}):e.jsx(Lt,{selectedRepository:Q.state.value,onSelect:(m,v,z)=>{Q.handleChange(m),q.handleChange(v),g(z)},installationId:(Ne=i==null?void 0:i.id)!=null?Ne:null,installationAccountLogin:(Ce=i==null?void 0:i.account_login)!=null?Ce:null,installationAccountType:(Ee=i==null?void 0:i.account_type)!=null?Ee:null}),e.jsx(W,{className:"mb-4",field:Q}),e.jsx(as,{onChange:q.handleChange,value:q.state.value}),e.jsxs("div",{className:"flex flex-row justify-between pt-1",children:[e.jsx(W,{field:q}),e.jsx(Pe,{current:q.state.value.length,max:re})]}),e.jsx(Kt,{onChange:Y.handleChange,value:Y.state.value}),e.jsxs("div",{className:"flex flex-row justify-between pt-1",children:[j&&e.jsx("p",{className:"text-token-text-tertiary text-xs",children:e.jsx(u,{id:"wham.createEnvironments.descriptionSection.description",defaultMessage:"Explain to members of your organization what this environment is for."})}),e.jsx(Pe,{current:Y.state.value.length,max:ve})]}),e.jsx(W,{className:"mb-4",field:Y}),y&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx(ts,{value:G.state.value,onChange:he}),e.jsx(W,{field:G}),G.state.value!=="private"&&e.jsxs(e.Fragment,{children:[e.jsx(Zt,{value:J.state.value,onChange:J.handleChange,onBlur:J.handleBlur}),e.jsx(W,{className:"mb-4",field:J})]})]})]}),e.jsxs("div",{className:"bg-token-bg-primary flex w-full items-baseline justify-between gap-1.5 border-y p-4",children:[e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsx("span",{className:"shrink-0 text-xl font-medium",children:e.jsx(u,{id:"wham.environmentsForm.advanced",defaultMessage:"Code execution"})}),e.jsx("span",{className:"text-token-text-tertiary text-xs",children:e.jsx(u,{id:"wham.environmentsForm.advancedSubtitle",defaultMessage:"Set up dependencies, lint, and tests."})})]}),e.jsx("a",{href:"https://platform.openai.com/docs/codex/overview#environment-configuration",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-1 py-2 ps-2 hover:underline","aria-label":c.formatMessage({id:"wham.environmentsForm.learnMoreAriaLabel",defaultMessage:"Link to learn more about code execution"}),children:e.jsxs("div",{className:"text-token-text-tertiary flex items-center gap-1 text-xs",children:[e.jsx(Vt,{className:"icon-sm"}),e.jsx(u,{id:"wham.environmentsForm.learnMore",defaultMessage:"Learn more"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col p-4",children:[e.jsx(ws,{selectedMachineId:ee.state.value,setSelectedMachineId:m=>ee.handleChange(m),envVars:_.state.value,pushValue:_.pushValue,replaceValue:_.replaceValue}),e.jsx(W,{className:"mb-1",field:ee}),e.jsxs("p",{className:"text-token-text-tertiary mb-4 text-xs",children:[e.jsx(u,{id:"wham.createEnvironments.machineSelector.description",defaultMessage:"Universal is an image based on Ubuntu 24.04 - see <dockerfile>openai/codex-universal</dockerfile> to learn more. {br} The repository will be cloned to {workspaceDirectory}/{repo_name}. <EditWorkspace>Edit workspace directory.</EditWorkspace>",values:{br:e.jsx("br",{}),repo_name:h!=null?h:"",workspaceDirectory:(Ae=ce.state.value)!=null?Ae:"/workspace",dockerfile:m=>e.jsx("a",{href:"https://github.com/openai/codex-universal",target:"_blank",rel:"noopener noreferrer",className:"underline",children:m}),EditWorkspace:m=>e.jsx("button",{className:"underline",type:"button",onClick:()=>{w(!0)},children:m})}}),b&&e.jsx(Hs,{onChange:m=>ce.handleChange(m),repositoryName:h,workspaceDirectory:ce.state.value,errors:ce.state.meta.errors.filter(m=>!!m),onClose:()=>w(!1)})]}),e.jsx(Qt,{pushValue:_.pushValue,removeValue:_.removeValue,changeValue:_.replaceValue,values:_.state.value}),e.jsx(W,{className:"mb-4",field:_}),e.jsx(ks,{pushValue:X.pushValue,removeValue:X.removeValue,changeValue:X.replaceValue,values:X.state.value,enableAuthtranslator:Qe,isAuthtranslatorGateEnabled:E,onEnableAuthtranslatorChange:m=>p.setFieldValue("enableAuthtranslator",m)}),e.jsx(W,{className:"mb-4",field:X}),e.jsx(ys,{cacheSettings:k.state.value,onChange:k.handleChange}),e.jsx(W,{className:"mb-4",field:k}),e.jsx(Ts,{onClickAppendReplHistory:()=>{const m=c.formatMessage({id:"wham.createEnv.terminal.recentCommands",defaultMessage:"Recent commands"}),v=ae.state.value,z="".concat(v?"\n\n":"","# ").concat(m,":\n")+R.join("");p.setFieldValue("setupCommands",v+z),se([]),setTimeout(()=>{if(N.current){const ne=N.current;ne.scrollTop=ne.scrollHeight}},1)},replCommandHistory:R,suggestedCommand:M,onClickAcceptSuggestedCommand:()=>{M&&p.setFieldValue("setupCommands",ae.state.value+M),C(null)},setupScript:ae.state.value,onSetupScriptChange:ae.handleChange,maintenanceScript:ge.state.value,onMaintenanceScriptChange:ge.handleChange,setupScriptChildren:e.jsx(W,{className:"mb-4",field:ae}),maintenanceScriptChildren:e.jsx(W,{className:"mb-4",field:ge}),inputRef:N,autoSetupSettings:Me.state.value,onChangeAutoSetupSettings:Me.handleChange,postSetupCacheEnabled:!!((_e=k.state.value)!=null&&_e.post_setup_cache_enabled)}),pe!=null&&e.jsxs(e.Fragment,{children:[e.jsx(It,{disabledByWorkspaceSettings:pe,agentNetworkAccess:Z.state.value,onChange:Z.handleChange}),e.jsx(W,{className:"mb-4",field:Z}),Ze&&e.jsx(Dt,{className:"mb-4"}),!pe&&((Ve=Z.state.value)==null?void 0:Ve.mode)==="on"&&e.jsx(Ot,{className:"mb-4"})]})]}),e.jsx("div",{className:"flex h-[650px] p-3",children:e.jsx(p.Subscribe,{selector:m=>m.values,children:m=>e.jsx(qs,{formValues:m,environmentId:t,onConnectedChange:L,initialSecrets:a.secrets.reduce((v,z)=>(v[z.key]=z.value,v),{}),onSuggestCommand:v=>{C(v)},onSubmitCommand:v=>{v.trim()&&se(z=>[...z,v])}})})})]})]}),e.jsx("div",{className:"mb-12 flex w-full items-end pt-4",children:e.jsx(p.Subscribe,{selector:m=>m.values,children:m=>e.jsx(B,{color:"primary",size:"medium",type:"button",className:"ms-auto",loading:r,disabled:!m.repositoryId,onClick:v=>{v.preventDefault(),v.stopPropagation(),p.handleSubmit()},children:s})})})]})})}export{ma as D,da as E,Oe as P,De as R,Fs as g};
//# sourceMappingURL=pfpitnv8krpxp6xj.js.map
