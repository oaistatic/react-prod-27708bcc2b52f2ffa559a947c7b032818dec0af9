var W=Object.defineProperty,q=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var T=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e);var C=(e,t,r)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,P=(e,t)=>{for(var r in t||(t={}))F.call(t,r)&&C(e,r,t[r]);if(k)for(var r of k(t))X.call(t,r)&&C(e,r,t[r]);return e},$=(e,t)=>q(e,z(t));var w=function(e,t){this[0]=e,this[1]=t},R=(e,t,r)=>{var o=(u,n,i,l)=>{try{var b=r[u](n),f=(n=b.value)instanceof w,m=b.done;Promise.resolve(f?n[0]:n).then(s=>f?o(u==="return"?u:"next",n[1]?{done:s.done,value:s.value}:s,i,l):i({value:s,done:m})).catch(s=>o("throw",s,i,l))}catch(s){l(s)}},a=u=>c[u]=n=>new Promise((i,l)=>o(u,n,i,l)),c={};return r=r.apply(e,t),c[T("asyncIterator")]=()=>c,a("next"),a("throw"),a("return"),c};var M=(e,t,r)=>(t=e[T("asyncIterator")])?t.call(e):(e=e[T("iterator")](),t={},r=(o,a)=>(a=e[o])&&(t[o]=c=>new Promise((u,n,i)=>(c=a.call(e,c),i=c.done,Promise.resolve(c.value).then(l=>u({value:l,done:i}),n)))),r("next"),r("return"),t);import{j as y,M as D,r as p,e as G,a as H}from"./fg33krlcm0qyi6yw.js";import{l as Y,de as B,df as J,fe as V,eD as Z,b$ as I}from"./mtk1qztvnb31pw5r.js";import{jX as O,gg as ee}from"./k65njl5wlgspihfr.js";import{i as N}from"./sy1xvqwioh9ks4z8.js";import{j as te}from"./n0ab5m1z76n8mazm.js";function be({className:e,linesAdded:t,linesRemoved:r}){return!t&&!r?null:y.jsxs("div",{className:Y("flex flex-row gap-1 font-medium",e),children:[y.jsx("span",{className:"text-green-500",children:y.jsx(D,{id:"wham.message.modal.repoAndDiffStats.linesAdded",defaultMessage:"+{linesAdded}",values:{linesAdded:t}})}),y.jsx("span",{className:"text-red-500",children:y.jsx(D,{id:"wham.message.modal.repoAndDiffStats.linesRemoved",defaultMessage:"-{linesRemoved}",values:{linesRemoved:r}})})]})}function re(e){const t=p.useMemo(()=>e.join("\0"),[e]);return p.useMemo(()=>e,[t])}const se=["task_turn_event","work_log_message","log","task_title_generated","app_server_event"];function Se(e,t,r){"use no forget";const o=G(),[a,c]=p.useState(r?o.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[u,n]=p.useState(a);p.useEffect(()=>{const l=V(()=>n(a),200);return l(),l.cancel},[a]);const i=p.useMemo(()=>"last-event-".concat(e,"-").concat(r!=null?r:"","-").concat(Math.random().toString(36).slice(2)),[e,r]);return ne(e,r,["task_turn_event"],{enabled:!!r&&!N(t),subscriberId:i,onEvent:l=>c(l.task_turn_event.text)}),u}function ne(e,t,r,{enabled:o=!0,subscriberId:a,onEvent:c,onComplete:u}){"use no forget";const n=O(c),i=O(u),l=re(r),b=H(),f=p.useCallback(s=>{n.current(s)},[n]),m=p.useCallback(()=>{var s;(s=i.current)==null||s.call(i)},[i]);p.useEffect(()=>{if(!(!t||!o))return L.retainTurnStream(b,e,t,a,l,f,m),()=>{L.releaseTurnStream(e,t,a)}},[e,t,a,l,o,b,f,m])}function ae(a){return R(this,arguments,function*({taskId:e,turnId:t,abortSignal:r,types:o}){let u="".concat(window.location.origin+"/backend-api","/wham/tasks/").concat(e,"/turns/").concat(t,"/stream");if(o.length>0){const m=o.map(s=>"item_type=".concat(encodeURIComponent(s))).join("&");u+="?".concat(m)}const n=ee(u,{method:"GET",signal:r,headers:$(P({},Z({isAuthOptional:!1})),{"Content-Type":"text/event-stream"}),observer:{onClose:(m,s)=>{if(s&&!x(s))throw s}}});try{try{for(var i=M(n),l,b,f;l=!(b=yield new w(i.next())).done;l=!1){const m=b.value;const s=oe(m);s&&(!o||o.includes(s.item_type)?yield s:I.warn("Unknown event type",{event:m}))}}catch(b){f=[b]}finally{try{l&&(b=i.return)&&(yield new w(b.call(i)))}finally{if(f)throw f[0]}}}catch(m){if(x(m))return;throw m}})}function oe(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function x(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const U=B(J(()=>({turnStreams:{}}))),A=U.getState,v=U.setState;function Q(e,t){return"".concat(e,":").concat(t)}const K=20;function ie(e,t,r,o){var c,u;let a;return v(n=>{const i=n.turnStreams[t];if(!i)return;if(i.initPromise){a=i.initPromise;return}const{abortController:l}=i,f=(async()=>{var j;let m=0;const s=d=>{const h=[];v(g=>{const E=g.turnStreams[t];E&&(E.seenEventIds.has(d.id)||(E.seenEventIds.add(d.id),E.emittedEvents.push(d),Object.values(E.subscribers).forEach(S=>{if(!S.types.includes(d.item_type))return;const _=S.lastTimestamps[d.item_type];_&&d.timestamp<=_||(S.lastTimestamps[d.item_type]=d.timestamp,h.push(S.onEvent))})))}),h.forEach(g=>g(d))};for(;!l.signal.aborted&&m<K;){try{const S=ae({taskId:r,turnId:o,abortSignal:l.signal,types:se});try{for(var he=M(S),Ee,ye,ve;Ee=!(ye=await he.next()).done;Ee=!1){const _=ye.value;if(l.signal.aborted)break;s(_)}}catch(ye){ve=[ye]}finally{try{Ee&&(ye=he.return)&&await ye.call(he)}finally{if(ve)throw ve[0]}}}catch(S){if(x(S)||l.signal.aborted)break}const d=te(r,o),h=await e.fetchQuery(d),g=N(h.turn.turn_status);if(g&&await Promise.all([e.refetchQueries({queryKey:["wham","task",r]}),e.invalidateQueries({queryKey:["wham","tasks"]})]),m+=1,m>=K||l.signal.aborted||g)break;const E=Math.min(16e3,1e3*2**m)+Math.random()*500;await new Promise(S=>setTimeout(S,E))}if(!l.signal.aborted){const d=(j=A().turnStreams[t])==null?void 0:j.subscribers;Object.values(d!=null?d:{}).forEach(h=>{var g;(g=h.onComplete)==null||g.call(h)})}})().finally(()=>{v(m=>{const s=m.turnStreams[t];s&&s.initPromise===f&&(s.initPromise=null,Object.keys(s.subscribers).length||delete m.turnStreams[t])})});i.initPromise=f,a=f}),(u=a!=null?a:(c=A().turnStreams[t])==null?void 0:c.initPromise)!=null?u:Promise.resolve()}const L={async retainTurnStream(e,t,r,o,a,c,u){const n=Q(t,r);let i=!1;v(b=>{let f=b.turnStreams[n];f?f.initPromise||(i=!0,f.abortController=new AbortController):(i=!0,f={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},b.turnStreams[n]=f);const m=f.subscribers[o];m?(m.types=Array.from(a),m.onEvent=c,m.onComplete=u):f.subscribers[o]={subscriberId:o,types:Array.from(a),onEvent:c,onComplete:u,lastTimestamps:{}}});const l=A().turnStreams[n].emittedEvents;for(const b of l)a.includes(b.item_type)&&c(b);i&&await ie(e,n,t,r)},releaseTurnStream(e,t,r){const o=Q(e,t);let a=!1,c;v(u=>{const n=u.turnStreams[o];!n||!n.subscribers[r]||(delete n.subscribers[r],Object.keys(n.subscribers).length||(a=!0,c=n.abortController,delete u.turnStreams[o]))}),a&&c&&c.abort()}};export{be as W,ne as a,x as i,Se as u};
//# sourceMappingURL=bes67zhi4fr5gq8i.js.map
