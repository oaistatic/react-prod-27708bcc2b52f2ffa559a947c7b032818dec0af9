import{r as o,a as I,e as K,i as A,d as O,j as c,ae as U,m as q,a9 as B,a0 as N}from"./fg33krlcm0qyi6yw.js";import{lX as H,m as Q,vs as z,hg as $}from"./mtk1qztvnb31pw5r.js";import{W as G}from"./gq2vu050vpxxbur2.js";import{n as X,o as Y,h as J,q as V}from"./n0ab5m1z76n8mazm.js";import{pY as Z,dU as D,cD as j,cE as L}from"./k65njl5wlgspihfr.js";import{u as ee}from"./bbzlu7xqes2h12wz.js";import{useSetupBaseWhamKeyboardActions as te}from"./iqonnsay2vmalfwk.js";import{b as re,g as oe,T as ne,W as se,c as ue}from"./dalowvhac5so9p7u.js";import{W as ae,c as ie,b as me}from"./sy1xvqwioh9ks4z8.js";import"./mbql81gwv5du9dtu.js";import"./k43gn7pl526u53kc.js";import"./dm7q440f2oraxz29.js";import"./eqi3xjytwhmszqqa.js";import"./cmaobpdpreyiep8p.js";import"./j3x02iqqi345yx57.js";import"./lbq5605sor1ah5hb.js";import"./mmn9462oogkapcg8.js";import"./blmsijdyv0yxybpw.js";import"./npp0xpas090zc0qr.js";import"./0hruh9i7xt25bbur.js";import"./bgx9m29b5moow7ak.js";import"./j4u691tk1tplayl2.js";import"./d0444mle8cdypjta.js";import"./klzrztgvm2c9gs50.js";import"./zqbip2ya77i1mx4s.js";import"./kg0cp341m64rddpv.js";import"./lbbnz7rb7sd2lk50.js";import"./ck1u9icgxosmytry.js";import"./dq5a57hcb44a83mi.js";import"./bes67zhi4fr5gq8i.js";import"./lptwpbjabrvjmhsj.js";import"./ose6175gtasqnfv0.js";import"./o51gjyxad96i2yey.js";import"./cv3wsu6uenrjij6h.js";import"./n0qmvbt3dffalvvl.js";import"./jcfo2542d2wvunuv.js";import"./j37p94g6trtb4j3z.js";import"./lad8yx56mqsdspc9.js";import"./fznnr8l9owxbou6l.js";import"./haneze5lyzwaewf8.js";import"./j0vhwkpwiqu2ejer.js";import"./l09h2qppleubii6l.js";import"./bm9dehzwm3r2l9jr.js";import"./kpobiwwkg2o2u14w.js";import"./ir7nzwbolrsm3ds2.js";import"./btdpwmi6j9nv6qc2.js";import"./mg1nwivo9tzc7m2p.js";import"./cnrdqaihcmlb57i1.js";import"./j7vr3wxxnh5g6uxz.js";import"./kzbknm4lxuyoq9wi.js";import"./jed1ux7qibe55pmj.js";import"./h1em0bjkpkjv8ykw.js";import"./f5ep9o7usovyn4vf.js";import"./ly75bs3d14n5v622.js";import"./hu1bt0oauegdhua6.js";function ce(){return o.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function de(t){var b,h,E,T,_,k,w;const a=I(),i=H(),m=ce(),{data:e,error:p}=X(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=Y(t),n=J(o.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:P}=re({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(b=e==null?void 0:e.current_user_turn)!=null?b:null,currentAssistantTurn:(h=e==null?void 0:e.current_assistant_turn)!=null?h:null}),y=o.useMemo(()=>{var s,u;return oe({focusedAssistantTurn:r,pastTurns:n,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(E=e==null?void 0:e.current_diff_task_turn)==null?void 0:E.id,n]),l=(T=e==null?void 0:e.task)==null?void 0:T.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&l===((_=e==null?void 0:e.current_assistant_turn)==null?void 0:_.id),g=((k=e==null?void 0:e.current_assistant_turn)==null?void 0:k.turn_status)==="completed";o.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(w=e==null?void 0:e.task)==null?void 0:w.title]),o.useEffect(()=>{!C||!g||ae.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const M=o.useMemo(()=>{var W,x,S,v;const s=ie(r),u=((S=r==null?void 0:r.sibling_turn_ids)==null?void 0:S.includes((x=(W=e==null?void 0:e.current_assistant_turn)==null?void 0:W.id)!=null?x:""))||(r==null?void 0:r.id)===((v=e==null?void 0:e.current_assistant_turn)==null?void 0:v.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:p,loadingTurnMapping:d,turns:n,focusedAssistantTurn:r,setFocusedAssistantTurnId:P,currentDiffTaskTurn:y,canFollowUp:M,isCommentFocused:m}}function pe(){const[t,a]=o.useState([]),[i,m]=o.useState(!1),e=o.useCallback(()=>{a([])},[]),p=o.useCallback(({onClose:d,isComposerEmpty:n})=>({force:r=!1}={})=>{if(r||t.length===0&&n){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:p}}function le({taskId:t,onClose:a}){"use no forget";var v,F;const i=Q(),m=K(),e=A(),{composerController:p,isComposerEmpty:d}=Z(),{taskDetails:n,taskDetailsError:r,loadingTurnMapping:P,turns:y,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:M,isCommentFocused:b}=de(t),h=o.useMemo(()=>me(l),[l]),E=o.useMemo(()=>({taskId:t,task:n==null?void 0:n.task,pastTurns:y,canFollowUp:M,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,n,y,M,l,C,g]),{comments:T,setComments:_,confirmClose:k,setConfirmClose:w,clearComments:s,createCloseHandler:u}=pe(),f=o.useMemo(()=>({comments:T,setComments:_,clearComments:s,readonlyComments:h}),[T,_,s,h]),W=D.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});te(),ee([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:L.Chat,keyboardBinding:[j.Mod,j.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:L.Chat,keyboardBinding:[j.Escape],enabled:!W&&!b}]);const S=o.useCallback(({force:R=!1}={})=>{x({force:R})},[x]);return r?(i.danger(O({id:"wham.task-details.error",defaultMessage:"Error loading task"}),{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(U,{to:"/codex"})):c.jsx(z.Provider,{value:p,children:c.jsx(ne,{value:f,children:c.jsx(se,{value:E,children:c.jsx(ue,{permissions:"write",turnId:(F=(v=n==null?void 0:n.current_assistant_turn)==null?void 0:v.id)!=null?F:"",confirmClose:k,setConfirmClose:w,handleClose:S,loadingTurnMapping:P})})})})}function fe(){var d;const t=A(),a=q(),{taskId:i}=B();V();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,p=o.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx($,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:p})})}):null}const gt=()=>[{title:"Codex"}],ht=N(function(){return c.jsx(fe,{})});export{ht as default,gt as meta};
//# sourceMappingURL=btnht1yxqbv4m2by.js.map
