var H=Object.defineProperty,V=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var T=(r,t,e)=>t in r?H(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,_=(r,t)=>{for(var e in t||(t={}))Z.call(t,e)&&T(r,e,t[e]);if(j)for(var e of j(t))J.call(t,e)&&T(r,e,t[e]);return r},D=(r,t)=>V(r,X(t));import{r as n,e as Q,ap as Y,j as f,M as U}from"./fg33krlcm0qyi6yw.js";import{_ as O,eM as ee,fA as te,oe as I,a9 as N,i9 as q,l as B,c0 as L,mo as re,P as ne,$ as se}from"./mtk1qztvnb31pw5r.js";import{ny as G,nz as oe,nA as z,nB as P,ca as $}from"./k65njl5wlgspihfr.js";function A(r,t){return e=>{O.addAction("".concat(r,".").concat(t),e)}}function ce(r){return(t,e)=>{O.addError(t,D(_({},e),{name:r,status:"error"}))}}const M={recording:{start:A("whisper-recording","start"),cancel:A("whisper-recording","cancel"),submit:A("whisper-recording","submit")},transcription:{request:A("whisper-transcription","request"),transcriptDelivered:A("whisper-transcription","transcriptDelivered"),error:ce("whisper-transcription"),requestSuccess:A("whisper-transcription","requestSuccess")}};class ae{static async transcribe(t,e,S={}){const w=new FormData;w.append("file",t),e&&w.append("language",e);const h={durationMs:S.durationMs,language:e,fileSize:t.size},g=performance.now();return M.transcription.request(h),ee.post("".concat(te,"/transcribe"),w).then(o=>{const c=performance.now()-g;return M.transcription.requestSuccess(D(_({},h),{durationMs:c})),o}).catch(o=>{const c=performance.now()-g;throw M.transcription.error(o,D(_({},h),{durationMs:c})),o})}}const ie=48e3,ue=10,W=ie*ue,le=4e3,de=600*1e3,y=r=>G.setState(t=>{t.status=r}),pe=r=>{const t=n.useRef(r);t.current=r;const e=n.useRef(null),S=n.useRef([]),w=n.useRef(null),h=n.useRef(null),g=n.useRef(null),o=n.useRef(new Float32Array(0)),c=n.useRef(null),b=n.useRef(null),x=n.useRef(!1),i=n.useCallback(()=>{o.current=new Float32Array,t.current.onWaveformDataUpdate(void 0)},[]),v=n.useCallback(async(u,m)=>{var p;y("transcribing");try{let l;I()?l=new File([u],"whisper.mp3",{type:"audio/mpeg"}):l=new File([u],"whisper.".concat(u.type.split(/[\/;]/)[1]||"mp3"),{type:u.type});const a=await ae.transcribe(l,void 0,{durationMs:m});y("idle"),M.transcription.transcriptDelivered({durationMs:m,transcriptLength:a.text.length}),t.current.onSuccess(a.text,a.asset_pointer,a.asset_ttl,(p=a.asset_format)!=null?p:null),i()}catch(l){y("error"),M.transcription.error(l,{durationMs:m}),i()}},[i]),R=n.useCallback(u=>{var p,l,a,d,s;if(!x.current)return;x.current=!1,b.current!==null&&(clearTimeout(b.current),b.current=null);const m=c.current!=null?performance.now()-c.current:void 0;u&&e.current&&(e.current.ondataavailable=null,e.current.onstop=null,y("idle"),i(),M.recording.cancel({durationMs:m}),c.current=null),(p=e.current)==null||p.stop(),(l=e.current)==null||l.stream.getTracks().forEach(k=>k.stop()),e.current=null,(a=g.current)==null||a.disconnect(),g.current=null,(d=h.current)==null||d.disconnect(),h.current=null,(s=w.current)==null||s.close(),w.current=null,u||M.recording.submit({durationMs:m})},[i]),F=n.useCallback(()=>{i(),y("recording"),oe.getUserMedia({audio:{sampleRate:le,channelCount:1}}).then(u=>{c.current=performance.now(),M.recording.start(),e.current=new MediaRecorder(u);const m=I();x.current=!0,m?(S.current=[],e.current.ondataavailable=d=>{d.data.size>0&&S.current.push(d.data)},e.current.onstop=async()=>{const d=new Blob(S.current,{type:"audio/mpeg-3"}),s=c.current!=null?performance.now()-c.current:void 0;await v(d,s)},e.current.start(1e3)):(e.current.ondataavailable=async d=>{const s=c.current!=null?performance.now()-c.current:void 0;await v(d.data,s)},e.current.start()),o.current=new Float32Array(W).fill(t.current.initialValue),t.current.onWaveformDataUpdate(o.current),y("recording"),b.current=window.setTimeout(()=>{R()},de);const p=new AudioContext;w.current=p;const l=p.createMediaStreamSource(u);h.current=l;const a=p.createScriptProcessor(2048,1,1);g.current=a,a.onaudioprocess=d=>{const s=d.inputBuffer.getChannelData(0);for(let C=0;C<s.length;C++)s[C]=Math.max(s[C],t.current.initialValue);const k=o.current,E=new Float32Array(k.length+s.length);if(E.set(k,0),E.set(s,k.length),E.length>W){const C=E.length-W;o.current=E.slice(C)}else o.current=E;t.current.onWaveformDataUpdate(o.current)},l.connect(a),a.connect(p.destination)}).catch(()=>{y("error"),i(),M.recording.cancel()})},[i,R,v]);return n.useEffect(()=>()=>{R(!0)},[R]),{startRecording:F,stopRecording:R}};function we({disabled:r=!1,initialValue:t,onSuccess:e,onWaveformDataUpdate:S,onExit:w,buttonClassName:h,visualTreatment:g}){const o=Q(),c=G(s=>s.status),b=n.useRef(!1),{startRecording:x,stopRecording:i}=pe({onSuccess:e,onWaveformDataUpdate:S,initialValue:t}),v=Y();n.useEffect(()=>()=>{i()},[i]),n.useEffect(()=>{b.current||(x(),b.current=!0)},[x]),n.useEffect(()=>{v.state!=="idle"&&i()},[v.state,i]);const R=()=>{i(!0),w()},F=g==="codex"?f.jsx(N,{type:"button",color:"ghost",size:"small",onClick:R,icon:q,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:f.jsx(U,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):f.jsx("div",{children:f.jsx("button",{"aria-label":o.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:r||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:B(g==="composer-btn"?"composer-btn":B(z,r?"opacity-30":P,h)),children:f.jsx(q,{"aria-label":o.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),u=c==="transcribing",m=u?f.jsx(L,{}):f.jsx($,{className:"icon-lg"}),p=u?o.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):o.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),l=()=>{ne.logEvent("Whisper on Web/Windows: Clicked to end dictation"),se.logEvent("chatgpt_composer_whisper_button_clicked_end"),i()},a=s=>{s.key==="Escape"&&re(s)&&(R(),s.preventDefault())},d=g==="codex"?f.jsx(N,{type:"button",color:"secondary",size:"small",disabled:r,icon:u?L:$,onClick:l,onKeyDown:a,ref:K,children:f.jsx(U,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):f.jsx("div",{children:f.jsx("button",{type:"button","aria-label":p,disabled:r,className:g==="composer-btn"?"composer-btn":B(z,r?"opacity-30":P,h),onClick:l,onKeyDown:a,ref:K,children:m})});return f.jsxs("div",{className:"flex gap-x-1.5",children:[F,d]})}function K(r){r==null||r.focus()}export{we as WhisperModeControls};
//# sourceMappingURL=ne3xqzlpqw6avp2c.js.map
