const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/n7gd6rqa6iqi6t4a.js","assets/fg33krlcm0qyi6yw.js","assets/k65njl5wlgspihfr.js","assets/mtk1qztvnb31pw5r.js","assets/root-mcq3deyb.css","assets/conversation-small-332fs9rk.css","assets/pdv21chic8hs0mt3.js","assets/haneze5lyzwaewf8.js","assets/gqx9i5tb3deqoo5z.js","assets/dg5jraediw4l39ow.js","assets/hb1mva1gmw4bcs8w.js","assets/efooahjtdr85x1lo.js","assets/km71i01x6ma5r62b.js","assets/mbql81gwv5du9dtu.js","assets/k43gn7pl526u53kc.js","assets/engbryqfkwtfab1c.js","assets/m3nchqrpfl8vs80b.js","assets/d6c194b8r37zigga.js","assets/fj25p15jq4efcoma.js","assets/os4f80dxb1x5vcar.js","assets/image-gen-gradient-loading-shimmer-mlm41gpm.css"])))=>i.map(i=>d[i]);
var pt=Object.freeze,vt=Object.defineProperty,nn=Object.defineProperties;var an=Object.getOwnPropertyDescriptors;var _t=Object.getOwnPropertySymbols;var sn=Object.prototype.hasOwnProperty,rn=Object.prototype.propertyIsEnumerable;var xt=(t,e,n)=>e in t?vt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,de=(t,e)=>{for(var n in e||(e={}))sn.call(e,n)&&xt(t,n,e[n]);if(_t)for(var n of _t(e))rn.call(e,n)&&xt(t,n,e[n]);return t},Re=(t,e)=>nn(t,an(e));var It=(t,e)=>pt(vt(t,"raw",{value:pt(e||t.slice())}));import{r as i,j as r,e as ge,i as on,a as Lt,n as cn,M as ie,c as zt,f as ln,_ as qe}from"./fg33krlcm0qyi6yw.js";import{zM as Me,e8 as N,P as Ft,zN as dn,dH as Ke,dF as ke,e2 as un,bg as xe,l as oe,e as Bt,V as Xe,a9 as Pe,ad as wt,Q as gn,S as yt,U as St,zO as mn,O as bt,qi as fn,X as Mt,H as hn,b as De,o as $e,bv as pn,F as _n,bb as xn,_ as Ee,c_ as Ye,go as vn,gp as In,gq as wn,p as yn,fN as Sn,kh as bn,R as Ae,dL as He,dR as Mn,m as Ot,r5 as Et,B as En,e3 as kn,dB as Nn,d as kt,e5 as Nt,nm as jn,vb as Cn,eW as Rn,cU as Tn,bh as Qe}from"./mtk1qztvnb31pw5r.js";import{zw as An,cV as Gn,ik as Un,kY as Pn,kZ as Dn,gc as Ln,ge as zn,fu as Fn,g2 as Bn,dq as $t,o9 as Ve,ou as Ht,eX as On,iN as $n,zx as Hn,zy as Vn,zz as Wn}from"./k65njl5wlgspihfr.js";import{I as ze,D as Vt,u as qn}from"./eoe4b0mmb8r0rg3f.js";import{u as Kn,b as re,D as Xn,L as Yn,i as Qn,c as Je,d as Jn,I as Zn}from"./engbryqfkwtfab1c.js";import{C as Wt}from"./ir7nzwbolrsm3ds2.js";import{D as ea}from"./je866d95n4n31rpb.js";import{C as ta}from"./jskmg2zu1nebndza.js";import"./m3nchqrpfl8vs80b.js";import"./l9v3ntkj34comb67.js";import"./d30pfo25z1qctykl.js";import"./h0pbwkfesoibvhzi.js";const na={handleRenderPercentUpdate:()=>{}},ue=new Map,qt=600*1e3,aa=60*1e3;let jt=0;const sa="image_gen_checkpoint_dedupe:",Ze="image_gen_did_navigate_away:",ia=qt+60*1e3;function ra(t){if(typeof localStorage>"u")return null;try{return localStorage.getItem(t)}catch(e){return null}}function oa(t,e){if(!(typeof localStorage>"u"))try{localStorage.setItem(t,e)}catch(n){}}function Kt(t){if(!(typeof localStorage>"u"))try{localStorage.removeItem(t)}catch(e){}}function Ct(t){const e="".concat(Ze).concat(t),n=Date.now(),a=ra(e);if(!a)return!1;const s=Number(a);return Number.isFinite(s)?n-s>ia?(Kt(e),!1):!0:!1}function ca(t){oa("".concat(Ze).concat(t),"".concat(Date.now()))}function Rt(t){Kt("".concat(Ze).concat(t))}function la(t){const{dedupeId:e,stageType:n,segmentPercent:a}=t;if(typeof sessionStorage>"u"||!e)return!0;const s="".concat(sa).concat(e,":").concat(n,":").concat(a!=null?a:"");try{return sessionStorage.getItem(s)==="1"?!1:(sessionStorage.setItem(s,"1"),!0)}catch(l){return!0}}function da({clientThreadId:t,toolCallMessage:e,imageMessages:n}){var I,b,g,h,_,x;if(!t)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const a=Ke(t),s=(b=e==null?void 0:e.id)!=null?b:(I=n[0])==null?void 0:I.id;if(!a||!s)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const c=ke.getTree(a).getBranchFromLeaf(ke.getCurrentLeafId(a)).map(v=>v.message),o=c.findIndex(v=>v.id===s);if(o===-1)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const p=(g=c[o].metadata)==null?void 0:g.turn_exchange_id;if(!p)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const d=c.map((v,w)=>({message:v,idx:w})).filter(({message:v,idx:w})=>{var M;return w<o&&((M=v.metadata)==null?void 0:M.turn_exchange_id)===p}).map(({message:v})=>v).reverse().find(v=>v.author.role===un.User);if(!d)return{containsUserUploadedContent:void 0,userUploadedContentCount:void 0};const u=(x=(_=(h=d.metadata)==null?void 0:h.attachments)==null?void 0:_.filter(v=>v.height!=null&&v.width!=null).length)!=null?x:0;return{containsUserUploadedContent:u>0?!!u:void 0,userUploadedContentCount:u>0?u:void 0}}function ua({toolCallMessage:t,imageMessages:e,conversationId:n,clientThreadId:a,imageGenerationState:s}){"use no forget";const l=i.useRef(s);i.useEffect(()=>{l.current=s},[s]);const c=i.useRef(Te(s)),o=i.useMemo(()=>e.map(g=>g.id),[e]),p=i.useMemo(()=>o.join(","),[o]),m=i.useMemo(()=>ga({toolCallMessage:t,imageMessages:e,conversationId:n,imageMessageIds:o,messageIdsKey:p,clientThreadId:a}),[t,e,n,o,p,a]),d=i.useRef(m);i.useEffect(()=>{d.current=m},[m]),i.useEffect(()=>{const g="".concat(window.location.pathname).concat(window.location.search).concat(window.location.hash),h=()=>{if(!c.current||!Te(l.current))return;const _=d.current;if(!(_!=null&&_.key))return;const x=Ge(_);x&&(x.metadata.didNavigateAway=!0,ca(_.key))};return window.addEventListener("pagehide",h),window.addEventListener("beforeunload",h),()=>{window.removeEventListener("pagehide",h),window.removeEventListener("beforeunload",h),"".concat(window.location.pathname).concat(window.location.search).concat(window.location.hash)!==g&&h()}},[]),i.useEffect(()=>{m!=null&&m.key&&Te(s)&&(c.current=!0,Ge(m))},[m,s]);const u=i.useCallback(({messageId:g,renderCompletePercent:h})=>{var f,j;if(!c.current)return;const _=d.current;if(!(_!=null&&_.key)||!g||h==null||!Number.isFinite(h))return;const x=Ge(_);if(!x)return;const v=_a(h);if(v<=0)return;const w=Math.min(100,Math.max(1,Math.round(v*100))),M=(f=x.lastLoggedPercent.get(g))!=null?f:0;if(w<=M)return;x.lastLoggedPercent.set(g,w),x.firstTokenLogged.has(g)||(x.firstTokenLogged.add(g),Ue(x,{stageType:Me.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_FIRST_TOKEN_RENDERED,messageId:g}));const R=((j=x.segmentIndexByMessage.get(g))!=null?j:0)+1;if(x.segmentIndexByMessage.set(g,R),Ue(x,{stageType:Me.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_SEGMENT_RENDERED,messageId:g,segmentPercent:w,segmentIndex:R}),w>=100){x.completedMessageIds.add(g),Ue(x,{stageType:Me.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_GENERATION_COMPLETED,messageId:g}),Tt(_)&&(c.current=!1);return}},[]),I=i.useMemo(()=>({handleRenderPercentUpdate:u}),[u]),b=Te(s);return i.useEffect(()=>{b?c.current=!0:(s===N.Errored||s===N.Empty)&&(c.current=!1)},[b,s]),i.useEffect(()=>{b&&pa(d.current)},[b]),i.useEffect(()=>{if(s!==N.Complete&&s!==N.Errored&&s!==N.Empty)return;Tt(d.current)&&(c.current=!1)},[s,p]),m!=null&&m.key?I:na}function ga({toolCallMessage:t,imageMessages:e,conversationId:n,imageMessageIds:a,messageIdsKey:s,clientThreadId:l}){var I,b,g,h,_;const c=ma(e,t),o=(b=c!=null?c:t==null?void 0:t.id)!=null?b:(I=e[0])==null?void 0:I.id;if(!o)return null;const p=fa(t,e),m=e[0],{containsUserUploadedContent:d,userUploadedContentCount:u}=da({clientThreadId:l,toolCallMessage:t,imageMessages:e});return{key:o,promptStartMs:p,metadata:{conversationId:n,toolInvocationMessageId:t==null?void 0:t.id,modelSlug:(_=(g=t==null?void 0:t.metadata)==null?void 0:g.model_slug)!=null?_:(h=m==null?void 0:m.metadata)==null?void 0:h.model_slug,containsUserUploadedContent:d,userUploadedContentCount:u,defaultMessageId:m==null?void 0:m.id,imageGenGroupId:c},messageIds:a,messageIdsKey:s}}function ma(t,e){var n,a;for(const s of t){const l=(n=s.metadata)==null?void 0:n.image_gen_group_id;if(l)return l}return(a=e==null?void 0:e.metadata)==null?void 0:a.image_gen_group_id}function fa(t,e){const n=[];if(typeof(t==null?void 0:t.create_time)=="number"&&n.push(t.create_time),e==null||e.forEach(s=>{typeof s.create_time=="number"&&n.push(s.create_time)}),n.length===0)return Date.now();const a=Math.min(...n);return Math.floor(a*1e3)}function Ge(t){var a,s,l,c,o,p,m,d,u,I,b,g,h,_,x;if(!(t!=null&&t.key))return null;const e=Date.now();let n=ue.get(t.key);return n?(t.messageIds.forEach(v=>n==null?void 0:n.messageIds.add(v)),t.promptStartMs<n.promptStartMs&&(n.promptStartMs=t.promptStartMs),(s=(a=n.metadata).modelSlug)!=null||(a.modelSlug=t.metadata.modelSlug),(c=(l=n.metadata).containsUserUploadedContent)!=null||(l.containsUserUploadedContent=t.metadata.containsUserUploadedContent),(p=(o=n.metadata).userUploadedContentCount)!=null||(o.userUploadedContentCount=t.metadata.userUploadedContentCount),(d=(m=n.metadata).toolInvocationMessageId)!=null||(m.toolInvocationMessageId=t.metadata.toolInvocationMessageId),(I=(u=n.metadata).conversationId)!=null||(u.conversationId=t.metadata.conversationId),(g=(b=n.metadata).defaultMessageId)!=null||(b.defaultMessageId=t.metadata.defaultMessageId),(_=(h=n.metadata).imageGenGroupId)!=null||(h.imageGenGroupId=t.metadata.imageGenGroupId),(x=n.metadata).didNavigateAway||(x.didNavigateAway=Ct(t.key)),n.lastUpdatedMs=e):(n={promptStartMs:t.promptStartMs,placeholderLogged:!1,firstTokenLogged:new Set,completedMessageIds:new Set,lastLoggedPercent:new Map,segmentIndexByMessage:new Map,metadata:Re(de({},t.metadata),{didNavigateAway:Ct(t.key)}),messageIds:new Set(t.messageIds),lastUpdatedMs:e},ue.set(t.key,n)),ha(e),n}function ha(t){if(!(t-jt<aa)){jt=t;for(const[e,n]of ue.entries())t-n.lastUpdatedMs>qt&&ue.delete(e)}}function Ue(t,{stageType:e,messageId:n,segmentPercent:a,segmentIndex:s}){t.lastUpdatedMs=Date.now();const l=t.metadata.toolInvocationMessageId,c=n!=null?n:t.metadata.defaultMessageId,o=e===Me.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_PLACEHOLDER_RENDERED?l:l&&c?"".concat(l,":").concat(c):void 0;la({dedupeId:o,stageType:e,segmentPercent:a})&&Ft.logStructuredEvent(dn,{conversationId:t.metadata.conversationId,messageId:n,toolInvocationMessageId:t.metadata.toolInvocationMessageId,imageGenGroupId:t.metadata.imageGenGroupId,stageType:e,elapsedTimeSincePromptMs:Math.max(t.lastUpdatedMs-t.promptStartMs,0),segmentMetadata:a!==void 0?Re(de({},s!==void 0?{segmentIndex:s}:{}),{renderCompletePercent:a}):void 0,containsUserUploadedContent:t.metadata.containsUserUploadedContent,userUploadedContentCount:t.metadata.userUploadedContentCount,modelSlug:t.metadata.modelSlug,didNavigateAway:t.metadata.didNavigateAway})}function pa(t){const e=Ge(t);!e||e.placeholderLogged||(e.placeholderLogged=!0,Ue(e,{stageType:Me.CHATGPT_IMAGE_GEN_CLIENT_STAGE_TYPE_PLACEHOLDER_RENDERED,messageId:e.metadata.defaultMessageId}))}function Tt(t){if(!(t!=null&&t.key))return!1;const e=ue.get(t.key);return e&&(t.messageIds.length===0||t.messageIds.every(a=>e.completedMessageIds.has(a)))?(ue.delete(t.key),Rt(t.key),!0):!1}function Te(t){return t===N.Thinking||t===N.Generating||t===N.AsyncGenerating||t===N.AsyncHanging}function _a(t){return!Number.isFinite(t)||t<0?0:t>1?1:t}const Xt=({children:t,isDimensionsUnknown:e})=>r.jsxs(xe.div,{className:oe(["relative max-w-[480px] rounded-2xl",e&&"aspect-square overflow-hidden"]),children:[r.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),r.jsx("div",{className:"relative h-full",children:t})]}),xa=({children:t,isDimensionsUnknown:e,width:n,height:a})=>r.jsxs(xe.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:oe(["relative max-w-[480px] overflow-hidden rounded-2xl",e&&"aspect-square"]),style:{width:n!=null?n:"auto",height:a!=null?a:"auto"},children:[r.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),r.jsx("div",{className:"relative h-full",children:t})]}),va=()=>{const t=ge(),e=on(),n=Bt(),a=An(n),l=Xe(n,"2781751539").get("updated_copy",!1);return r.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[r.jsxs("div",{className:"flex min-w-0 flex-col",children:[r.jsx("span",{className:"text-sm font-medium text-white",children:l?t.formatMessage({id:"JGOOjL",defaultMessage:"Upgrade to create faster"}):t.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),r.jsx("span",{className:"text-sm font-normal text-white/80",children:l?t.formatMessage({id:"LWhaGH",defaultMessage:"Your current plan uses a slower model for images."}):t.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),r.jsx(Pe,{size:"medium",color:"primary-inverse",onClick:()=>Gn(e,"Image Gen Latency Upsell"),children:a?t.formatMessage(wt.getGo):t.formatMessage(wt.getPlus)})]})};function Ia(t){const[e,n]=gn(yt.ImageGenProgressUpsellV2,null,o=>o!=null&&typeof o=="object"&&(typeof o.lastSeenUpsellAt=="number"||o.lastSeenUpsellAt==null)&&(typeof o.lastUsedImageGen=="number"||o.lastUsedImageGen==null)&&(typeof o.lastMessageId=="string"||o.lastMessageId==null)&&(typeof o.lastCanBeSeen=="boolean"||o.lastCanBeSeen==null)),a=e&&e.lastSeenUpsellAt?St(e.lastSeenUpsellAt):null,s=e&&e.lastUsedImageGen?St(e.lastUsedImageGen):null,l=t?e&&e.lastMessageId===t?e.lastCanBeSeen:(a==null||mn(a,bt(new Date,3)))&&s!=null&&fn(s,bt(new Date,1)):!1;return{canBeSeen:l,markImageGenUsed:()=>{var o;if(t){const p={lastSeenUpsellAt:l?Mt(new Date):(o=e==null?void 0:e.lastSeenUpsellAt)!=null?o:null,lastUsedImageGen:Mt(new Date),lastMessageId:t!=null?t:null,lastCanBeSeen:l};n(p),localStorage.setItem(yt.ImageGenProgressUpsellV2,JSON.stringify(p))}}}}function wa(){const[e,n]=i.useState(new Date);i.useEffect(()=>{n(new Date)},[]);const a=Pn(+e,12e4);return r.jsx(Dn,{percentage:a,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:"".concat((100-a)/100*.2,"s"),transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Yt=({isGettingStarted:t,messageId:e})=>{var d;const n=De(),a=hn(),s=(d=a==null?void 0:a.isFree())!=null?d:!1,{canBeSeen:l,markImageGenUsed:c}=Ia(e),o=s&&l&&Xe(n,"1997515563").get("should_show_image_gen_latency_upsell",!1);Un(()=>{c()});const p=$e(n,"3018147683"),m=i.useMemo(()=>t?r.jsx(Wt,{size:30,arcPercentage:.2,strokeWidth:2}):r.jsx(wa,{}),[t]);return r.jsxs("div",{className:oe("absolute inset-0 flex justify-between px-6 py-6",o?"items-start":"items-end"),children:[r.jsx(pn,{mode:"popLayout",children:!p&&r.jsx("div",{className:"flex flex-1 items-center justify-end",children:m})}),o&&r.jsx(va,{})]})};var Dt;const At=_n.div(Dt||(Dt=It(["invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2\n  ","\n  ",""])),({$rightAlign:t})=>t?"end-3":"start-3",({$alwaysVisible:t})=>t?"visible":""),ya=({imageUrl:t})=>{const[e,n]=i.useState(void 0),a=ge(),s=Kn(),l=i.useCallback(()=>{const c=new Date,o=a.formatDate(c,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});return"".concat(o,".png")},[a]);return r.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[r.jsxs(At,{$alwaysVisible:!0,children:[e!==!1&&r.jsx(ze,{icon:Ln,selected:e===!0,variant:"large",onClick:c=>{c.stopPropagation(),re.paragenImageRated({liked:!0,analyticsContext:s}),n(!0)}}),e!==!0&&r.jsx(ze,{icon:zn,selected:e===!1,variant:"large",onClick:c=>{c.stopPropagation(),re.paragenImageRated({liked:!1,analyticsContext:s}),n(!1)}})]}),r.jsx(At,{$alwaysVisible:!0,$rightAlign:!0,children:r.jsx(ze,{icon:Fn,variant:"large",onClick:c=>{c.stopPropagation(),re.paragenDownload({analyticsContext:s}),Bn({url:t,fileName:l()})}})})]})};function Qt({withLottie:t}){const n=ge().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return r.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":n,children:r.jsx(Wt,{size:40,arcPercentage:.2,children:r.jsx(ea,{animate:t,matchTextColor:!0,className:"h-6 w-6"})})})}const Sa=Object.freeze(Object.defineProperty({__proto__:null,ProgressIndicator:Qt},Symbol.toStringTag,{value:"Module"})),Jt=300,ba=1.3,Gt=.05,Ma=/blur\(([\d.]+)px\)/,Ea={duration:Jt/1e3,ease:"linear"};function Fe(t,e,n){var c,o,p,m,d;t.sort((u,I)=>u.lastSrcReceivedTime-I.lastSrcReceivedTime);const a=new Array(t.length).fill(0);for(let u=0;u<=t.length;u+=1){const I=u-1,b=u,g=(o=(c=t[I])==null?void 0:c.availablePercentComplete)!=null?o:0,h=(m=(p=t[b])==null?void 0:p.availablePercentComplete)!=null?m:1;if(e>=g&&e<=h&&g!==h){const _=(e-g)/(h-g);a[I]=1-_,a[b]=_}}const s=a[a.length-1],l=a[a.length-2];return s===1&&l===0&&(a[a.length-2]=.01),n&&e<=((d=t[0])==null?void 0:d.availablePercentComplete)&&(a[0]=1),a}const ka=({alt:t,src:e,availablePercentComplete:n,onAnimationUpdate:a,ignoreFirstChunk:s=!1,isTransparent:l=!1,dimensions:c,onError:o,unconstrainedWidth:p=!1,progressLoaderProps:m,datadogImageContext:d})=>{const u=xn(),I=i.useMemo(()=>"url(".concat(u?Xn:Yn,")"),[u]),[b,g]=i.useState(!1),[h,_]=i.useState(1e3),[x,v]=i.useState(n!=null?n:0),[w,M]=i.useState(n===1?1:0),R=i.useRef(performance.now()),f=i.useRef(0),j=i.useRef([]),X=i.useRef({}),ce=i.useRef(new Set),[H,B]=i.useState([0]),[Y,ne]=i.useState(n===1),W=i.useRef(!1),J=i.useRef(null),Z=x===1,F=n===1&&Y,P=c?c.width/c.height:1;i.useEffect(()=>{!b&&n&&(g(!0),f.current=performance.now())},[b,n]),i.useEffect(()=>{var D;const E=(D=j.current[j.current.length-1])==null?void 0:D.src;if(e&&e!==E){const O=j.current.findIndex(A=>A.availablePercentComplete===n);O!==-1?j.current[O]={src:e,availablePercentComplete:n!=null?n:0,lastSrcReceivedTime:performance.now()}:j.current.push({src:e,availablePercentComplete:n!=null?n:0,lastSrcReceivedTime:performance.now()}),X.current[e]==null&&(X.current[e]=performance.now()),B(Fe(j.current,x,s))}},[e,x,s,n]);const K=i.useCallback(({requestedSrc:E,actualSrc:D,isFinalChunk:O})=>{var me,le;if(ce.current.has(E))return;ce.current.add(E);const A=(me=X.current[E])!=null?me:X.current[D],Q=A!=null?performance.now()-A:void 0,ae=Q==null,ee=fe=>performance.getEntriesByName(fe).filter(te=>te.entryType==="resource").slice(-1)[0],L=(le=ee(D))!=null?le:ee(E);Ee.addAction("image-gen-image-bytes-loaded",de({load_ms:Q,load_ms_missing:ae,is_complete:O,resource_duration_ms:L==null?void 0:L.duration,transfer_size:L==null?void 0:L.transferSize,encoded_body_size:L==null?void 0:L.encodedBodySize,decoded_body_size:L==null?void 0:L.decodedBodySize,initiator_type:L==null?void 0:L.initiatorType},d))},[d]),y=i.useCallback(()=>{J.current&&n&&(_(F?Jt:(performance.now()-R.current)*ba),(!s||W.current||n>=Gt)&&n!==1&&M(n),W.current=!0,R.current=performance.now(),m==null||m.setHasImageReady(!0))},[n,F,s,m]),S=i.useCallback(E=>{const D=parseFloat(E.height)/100;a==null||a(D),v(D),B(Fe(j.current,parseFloat(E.height)/100,s))},[a,s]),k=i.useCallback(E=>{var ee,L;const D=(L=(ee=E.filter.toString().match(Ma))==null?void 0:ee[1])!=null?L:"0",A=(16-parseFloat(D))/16,Q=1-w,ae=w+Q*A;a==null||a(ae),v(ae),B(Fe(j.current,ae,s))},[s,w,a]);if(!b)return r.jsx(Xt,{isDimensionsUnknown:!0,children:r.jsx(Qt,{withLottie:!0})});const U={duration:h/1e3,ease:"linear"},C=n!==1||!l;return r.jsxs("div",{className:oe("relative z-0 cursor-pointer overflow-hidden",P<1?"max-w-[400px]":"max-w-[480px]",!Z&&"pointer-events-none",!W.current&&"bg-token-main-surface-secondary",p&&"max-w-full"),"aria-label":t,style:{aspectRatio:P},children:[!(m!=null&&m.shouldHideDiagonalShimmer)&&n&&n<Gt&&r.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:r.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:r.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),r.jsxs(xe.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:F?!1:{height:"0%"},animate:Z?{height:"100%"}:{height:"".concat(w*100,"%")},onUpdate:F?void 0:S,transition:F?{duration:0,ease:"linear"}:U,style:Z?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[e&&r.jsx("img",{ref:J,src:e,onLoad:y,onError:o,alt:t,className:"absolute top-0 z-1 w-full",style:{aspectRatio:P}}),l&&r.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:r.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:I,backgroundSize:"auto"}})})]}),r.jsx(xe.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:F?{filter:"blur(0px)"}:void 0,transition:F?Ea:void 0,onUpdate:F?k:void 0,style:{aspectRatio:P},children:j.current.map((E,D)=>{const O=H[D],A=E.availablePercentComplete===1;return O!==0||A?r.jsx("img",{src:E.src,alt:t,style:{opacity:O,willChange:"opacity",aspectRatio:P},className:!F&&(m!=null&&m.shouldShowPulseAnimation)?"bg-scale-pulse":"",onLoad:Q=>{const ae=Q.currentTarget.currentSrc||Q.currentTarget.src;K({requestedSrc:E.src,actualSrc:ae,isFinalChunk:A}),A&&ne(!0)}},E.src):null})}),r.jsx(xe.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:P},children:C&&j.current.filter((E,D)=>H[D]!==0).map(E=>r.jsx("img",{src:E.src,alt:t,className:"absolute top-0 w-full"},E.src))})]})},Be="sediment://",Na="000000000000000";function ja(t){if(!t.startsWith(Be))return t;const e=t.slice(Be.length),n=e.indexOf("?"),a=n===-1?e:e.slice(0,n),s=n===-1?"":e.slice(n);return!a||a.includes("#")?t:"".concat(Be).concat(Na,"#").concat(a,"#md").concat(s)}const Ca=({imageAssetPointer:t,serverThreadId:e})=>{var m;const[n,a]=i.useState(void 0),s=De(),l=Qn(s),c=(m=t.metadata)==null?void 0:m.watermarked_asset_pointer,o=i.useRef(!1),p=!Ye();return i.useEffect(()=>{if(l&&c&&!o.current){o.current=!0;const d=vn(c);In(d,void 0,p,e,!1).then(u=>{u.status===wn.Success&&a(u.download_url)}).catch(u=>{u instanceof yn||Ee.addError(new Error("Could not fetch watermarked image with ID ".concat(c," from file service"),{cause:u}))})}},[l,c,p,e]),n},Ut=2,Ne=({pointer:t,altLabel:e,isEditorAvailable:n,onPercentageRendered:a,messageId:s,imageIndex:l,clientThreadId:c,serverThreadId:o,onEditorClick:p,compact:m,progressLoaderProps:d,checkpointLogger:u})=>{var ve,je,pe,Ce,Ie,we,ye;const I=De(),b=Lt(),[g,h]=i.useState(void 0),_=i.useRef(void 0),x=i.useRef(void 0),v=i.useRef(!1),w=(je=(ve=t.metadata)==null?void 0:ve.generation)==null?void 0:je.gen_id,M=(Ie=(Ce=(pe=t.metadata)==null?void 0:pe.generation)==null?void 0:Ce.height)!=null?Ie:void 0,R=t.height,f=(M!=null?M:0)/R,j=i.useRef({}),[X]=cn(),ce=!Ye(),[H,B]=i.useState(!1),Y=i.useContext(Vt),ne=t.width/t.height,W=Xe(I,"2023018368"),J=W.get("use_md_images_inline",!1)===!0,Z=W.get("download_full_image",!1)===!0,F=ja(t.asset_pointer),P=J&&F!==t.asset_pointer,[K,y]=i.useState(()=>P),k=x.current!==t.asset_pointer?P:K,G=Z&&P&&k;i.useEffect(()=>{const z=q=>{queueMicrotask(()=>y(q))};if(x.current!==t.asset_pointer){x.current=t.asset_pointer,v.current=!1,z(P);return}if(!P){K&&z(!1);return}v.current||K||z(!0)},[t.asset_pointer,P,K]);const U=i.useMemo(()=>!k||F===t.asset_pointer?t:Re(de({},t),{asset_pointer:F}),[k,F,t]),C=U.asset_pointer,E=Ca({imageAssetPointer:t,serverThreadId:o}),D=i.useRef(0),O=i.useCallback((z=!1)=>{!z&&_.current===C||(_.current=C,$t.fetch(b,{asset:U,conversationId:o,force:z,isUnauthenticated:ce}).then(q=>{h(q)}).catch(q=>{if(k){v.current=!0,y(!1);return}Ee.addError(q)}).finally(()=>{_.current=void 0}))},[C,U,k,b,o,ce]);i.useEffect(()=>{const z=C!==(g==null?void 0:g.asset_pointer);(!g||z)&&O()},[g,C,O]);const A=i.useMemo(()=>Je({pointer:g,conversationId:o,messageId:s,source:Y?"paragen":"chat",imageIndex:l.toString()}),[g,o,s,Y,l]),Q=i.useRef(f);i.useEffect(()=>{f===1&&Q.current<1&&re.renderingComplete({analyticsContext:A})},[f,A]);const ae=i.useCallback(()=>{g&&(p==null||p({image:g,messageId:s,analyticsContext:A}))},[g,s,p,A]),ee=i.useMemo(()=>({width:t.width,height:t.height}),[t]),L=i.useCallback(()=>{var q;if(k){v.current=!0,y(!1);return}const z=((q=j.current[C])!=null?q:0)+1;if(j.current[C]=z,j.current[C]>Ut)return Ee.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:o,asset_pointer:C,max_retries:Ut});Ee.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:o,asset_pointer:C,current_retry:z}),j.current[C]=z,O(!0)},[C,O,o,k]),me=i.useCallback(z=>{z===1&&B(!0),a==null||a(z)},[a]),le=i.useRef(null),fe=i.useRef(null);i.useEffect(()=>{if(le.current&&(d!=null&&d.setContainerSize)){const z=le.current.getBoundingClientRect(),q={width:z.width,height:z.height},_e=fe.current;(!_e||_e.width!==q.width||_e.height!==q.height)&&(fe.current=q,d.setContainerSize(q))}},[d]),i.useEffect(()=>{D.current=0},[s,t.asset_pointer]),i.useEffect(()=>{u&&Number.isFinite(f)&&(f<=D.current||(D.current=f,u.handleRenderPercentUpdate({messageId:s,renderCompletePercent:f})))},[f,u,s]);const te=g==null?void 0:g.url,he=E!=null?E:te;return r.jsx(Jn.Provider,{value:A,children:r.jsxs("div",{ref:le,className:oe("group/imagegen-image corner-superellipse/1.1 relative w-full overflow-hidden",ne<1?"max-w-[400px]":"max-w-[480px]",m?"rounded-lg":"rounded-2xl",Y&&"max-w-full",s===X.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:"image-".concat(s),style:{aspectRatio:ne},onClick:n?ae:void 0,tabIndex:0,children:[E&&r.jsx("img",{alt:e,className:"absolute inset-0 z-1 opacity-0",src:E}),r.jsx(ka,{alt:e,src:te,availablePercentComplete:f,onAnimationUpdate:me,isEditorAvailable:n,ignoreFirstChunk:!0,isTransparent:(ye=(we=t.metadata)==null?void 0:we.generation)==null?void 0:ye.transparent_background,dimensions:ee,onError:L,unconstrainedWidth:Y,progressLoaderProps:d,datadogImageContext:{message_id:s,conversation_id:o,source:Y?"paragen":"chat",using_md:k}},w),(d==null?void 0:d.state)&&(d==null?void 0:d.state)!==N.Complete&&!H&&(d==null?void 0:d.hasImageReady)&&r.jsx(Yt,{isGettingStarted:!1,messageId:s}),H&&!m&&(Y?r.jsx(ya,{imageUrl:te!=null?te:""}):r.jsx(Zn,{imageAssetPointer:te,imageUrl:he,fullSizeImageAsset:t,downloadFullImage:G,messageId:s,clientThreadId:c,serverThreadId:o,shouldShowOverflow:E!==void 0}))]},w)})},Ra=({pointersToRender:t,altLabel:e,isEditorAvailable:n,updatePercentageRendered:a,toolCallMessage:s,toolOutputMessageIds:l,clientThreadId:c,serverThreadId:o,handleEditorClick:p,checkpointLogger:m})=>{const d=Ve.useStore(),u=Ve.useSelectedIndex();i.useEffect(()=>{d.setSelectedIndex(Math.max(l.findIndex(w=>{var M;return w===((M=s==null?void 0:s.metadata)==null?void 0:M.selected_image_message_id)}),0))},[]);const I=i.useRef({}),b=i.useCallback(w=>M=>{I.current[w]=M;const R=Object.keys(I.current).length,f=Object.values(I.current).reduce((j,X)=>j+X,0);a==null||a(f/R)},[a]),[g,h]=i.useState(null),_=Sn(c,ke.getRequestId),x=bn(_);i.useEffect(()=>{!x&&g!=null&&s!=null&&o!=null&&(We(s.id,l[g],c,o),h(null))},[x]);const v=i.useCallback(w=>{d.setSelectedIndex(w);const M=Object.values(I.current);Ft.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:o,messageId:l[w],imageIndex:w.toString(),isLoading:(M.length===0||M.some(j=>j<1)).toString()});const R=ke.getConversationLastTurn(Ke(c)),f=(R==null?void 0:R.messages.find(j=>j.id===(s==null?void 0:s.id)))!=null;s!=null&&o!=null&&(f&&x?h(w):We(s.id,l[w],c,o))},[s,l,c,o,d,x,h]);return r.jsxs("div",{className:"flex gap-2",children:[r.jsx(Ne,{pointer:t[u],altLabel:e,isEditorAvailable:n,messageId:l[u],imageIndex:u,clientThreadId:c,serverThreadId:o,onEditorClick:p,checkpointLogger:m},l[u]),r.jsx("div",{className:"flex flex-col gap-2",children:t.map((w,M)=>{var R,f;return r.jsx(Ta,{pointer:w,altLabel:e,isSelected:M===u,onClick:()=>v(M),onPercentageRendered:(f=(R=w.metadata)==null?void 0:R.generation)!=null&&f.gen_id?b(w.metadata.generation.gen_id):void 0,messageId:l[M],imageIndex:M,clientThreadId:c,serverThreadId:o,checkpointLogger:m},l[M])})})]})},Ta=({pointer:t,altLabel:e,isSelected:n,onClick:a,onPercentageRendered:s,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:p,checkpointLogger:m})=>r.jsxs("button",{type:"button",onClick:a,className:"relative w-14 rounded-lg p-1",children:[r.jsx("div",{className:oe(n&&"opacity-70"),children:r.jsx(Ne,{pointer:t,altLabel:e,isEditorAvailable:!1,onPercentageRendered:s,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:p,compact:!0,checkpointLogger:m})}),n&&r.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function We(t,e,n,a){const s=await Ae.safePost("/image-gen/message-select",{requestBody:{message_id:t,selected_image_message_id:e,conversation_id:a}}),l=s.id;l!=null&&He(n,c=>{Mn.updateTree(c,o=>{o.updateNodeMessage(l,s)})})}const Aa=({clientThreadId:t,serverThreadId:e,toolCallMessageId:n,pointers:a,messageIds:s,isEditorAvailable:l,onEditorClick:c,onComplete:o,onPercentageRendered:p,checkpointLogger:m})=>{"use no forget";const d=ge(),u=Ot(),I=i.useMemo(()=>a.length>0&&s.length===a.length&&a.every(y=>typeof y.width=="number"&&y.width>0&&typeof y.height=="number"&&y.height>0),[s.length,a]),[b,g]=i.useState(()=>a.map(()=>!1)),[h,_]=i.useState(!1),[x,v]=i.useState(null),[w,M]=i.useState(!1),R=i.useRef(null),f=i.useRef(null),j=i.useRef(!1),X=Ht.useStore();i.useEffect(()=>{I&&g(y=>y.length===a.length?y:a.map(()=>!1))},[I,a]),i.useEffect(()=>{R.current=Math.floor(Date.now()/1e3),f.current=null},[a,s]),i.useEffect(()=>{b.every(Boolean)&&f.current==null&&(f.current=Math.floor(Date.now()/1e3))},[b]);const H=b.length===a.length&&b.every(Boolean)&&!w;i.useEffect(()=>(X.setIsMultigenParagenVotingActive(H),()=>{X.setIsMultigenParagenVotingActive(!1)}),[X,H]);const B=i.useMemo(()=>{if(a.length<2)return!1;const[y,...S]=a,k=y.width,G=y.height;if(!k||!G)return!1;const U=k/G;return S.every(C=>{if(!C.width||!C.height)return!1;const E=C.width/C.height;return Math.abs(E-U)<.001})},[a]),Y=i.useMemo(()=>a.map(y=>{const S=y.width,k=y.height;return!S||!k?1:S/k}),[a]),ne=i.useMemo(()=>Y.map(y=>"".concat(Number.isFinite(y)&&y>0?y:1,"fr")).join(" "),[Y]),W=i.useMemo(()=>a.map((y,S)=>s[S]).filter(y=>typeof y=="string"),[a,s]);i.useEffect(()=>{var U,C;if(j.current||!e||!b.every(Boolean)||W.length!==a.length)return;j.current=!0;const y=(U=R.current)!=null?U:Math.floor(Date.now()/1e3),S=(C=f.current)!=null?C:y,k=Math.floor(Date.now()/1e3),G=B?"horizontal_buttons":"vertical_buttons";Ae.safePost("/image-gen/image-paragen-display",{requestBody:{conversation_id:e,displayed_message_ids:W,count:a.length,render_format:G,load_start_ts_utc:y,load_end_ts_utc:S,event_ts_utc:k}}).catch(()=>{})},[b,e,B,W,a.length]);const J=i.useMemo(()=>s.length!==a.length?[]:a.map((y,S)=>Je({pointer:y,conversationId:e,messageId:s[S],source:"paragen",imageIndex:S.toString()})),[s,a,e]),Z=i.useCallback(y=>S=>{p==null||p(S),!(S<1)&&g(k=>{if(k[y])return k;const G=[...k];return G[y]=!0,G})},[p]),F=i.useCallback(async y=>{var k,G;if(!e){u.danger(d.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),M(!0),o();return}const S=s[y];if(!S){u.danger(d.formatMessage({id:"imageParagen.multigen.missingMessageError",defaultMessage:"We couldn’t submit your choice. Please try again."})),M(!0),o();return}_(!0),v(y);try{const U=(k=R.current)!=null?k:Math.floor(Date.now()/1e3),C=(G=f.current)!=null?G:U,E=Math.floor(Date.now()/1e3),D=B?"horizontal_buttons":"vertical_buttons";await Ae.safePost("/image-gen/image-paragen-submit",{requestBody:{conversation_id:e,selected_message_id:S,count:a.length,render_format:D,load_start_ts_utc:U,load_end_ts_utc:C,event_ts_utc:E}});const O=J[y];if(O&&re.paragenImageRated({liked:!0,analyticsContext:O}),J.forEach((A,Q)=>{!A||Q===y||re.paragenImageRated({liked:!1,analyticsContext:A})}),n&&e)try{await We(n,S,t,e)}catch(A){}_(!1),v(null),M(!0),o()}catch(U){_(!1),v(null),u.danger(d.formatMessage({id:"imageParagen.multigen.submitError",defaultMessage:"We couldn’t submit your choice. Please try again."}))}},[J,t,d,s,o,a.length,e,u,n,B]),P=i.useCallback(async()=>{var y,S;if(!e){u.danger(d.formatMessage({id:"imageParagen.multigen.missingConversationError",defaultMessage:"We couldn’t submit your choice because the conversation isn’t saved yet."})),M(!0),o();return}_(!0);try{const k=(y=R.current)!=null?y:Math.floor(Date.now()/1e3),G=(S=f.current)!=null?S:k,U=Math.floor(Date.now()/1e3),C=B?"horizontal_buttons":"vertical_buttons";await Ae.safePost("/image-gen/image-paragen-dismiss",{requestBody:{conversation_id:e,dismissed_message_ids:W,count:a.length,render_format:C,load_start_ts_utc:k,load_end_ts_utc:G,event_ts_utc:U}}),M(!0),o()}catch(k){u.danger(d.formatMessage({id:"imageParagen.multigen.dismissError",defaultMessage:"We couldn’t skip the image comparison. Please try again."}))}finally{_(!1)}},[e,u,d,o,W,a.length,B]),K=i.useMemo(()=>a.map((y,S)=>d.formatMessage({id:"imageParagen.multigen.imageAlt",defaultMessage:"Generated image {index}"},{index:S+1})),[d,a]);return I?r.jsxs("div",{"data-testid":"image-paragen-multigen",children:[H&&r.jsxs("div",{className:"flex flex-wrap items-start gap-2 pb-4 md:flex-nowrap md:justify-between",children:[r.jsx("div",{className:"flex flex-col gap-1 md:max-w-[70%]",children:r.jsx("p",{className:"text-token-text-primary text-base",children:r.jsx(ie,{id:"imageParagen.multigen.prompt",defaultMessage:"Which image do you like more?"})})}),r.jsx("button",{type:"button",onClick:P,disabled:h,className:oe("text-token-text-tertiary hover:text-token-text-primary ms-auto whitespace-nowrap",h&&"pointer-events-none opacity-60"),children:r.jsx("span",{className:"underline decoration-dotted",children:r.jsx(ie,{id:"imageParagen.multigen.skip",defaultMessage:"Skip"})})})]}),r.jsx("div",{className:oe("grid [grid-template-columns:var(--paragen-cols)] gap-3",B?"md:gap-2":"md:gap-3"),style:{"--paragen-cols":ne},children:a.map((y,S)=>{var k,G,U;return r.jsxs("div",{className:"flex flex-col gap-3",children:[r.jsxs("div",{className:"relative",children:[r.jsx(Ne,{pointer:y,altLabel:(k=K[S])!=null?k:"Generated image",isEditorAvailable:l,onEditorClick:c,onPercentageRendered:Z(S),messageId:(G=s[S])!=null?G:String(S),imageIndex:S,clientThreadId:t,serverThreadId:e,compact:!0,checkpointLogger:m}),H&&r.jsx("div",{className:"absolute start-0 bottom-0 flex h-6 w-6 items-center justify-center rounded-md bg-black px-1 text-center text-sm font-semibold text-white dark:bg-white dark:text-black",children:r.jsx(ie,{id:"imageParagen.multigen.imageLabel",defaultMessage:"{index, number}",values:{index:S+1}})})]}),B&&H&&r.jsxs(Pe,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start",disabled:h,loading:x===S&&h,onClick:()=>F(S),children:[r.jsx(Et,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),r.jsx("span",{className:"sm:hidden",children:r.jsx(ie,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:S+1}})}),r.jsx("span",{className:"hidden sm:inline",children:r.jsx(ie,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:S+1}})})]})]},(U=s[S])!=null?U:S)})}),!B&&H&&r.jsx("div",{className:"mt-4 flex flex-col gap-2 md:items-start",children:a.map((y,S)=>r.jsxs(Pe,{fullWidth:!0,size:"large",color:"secondary",className:"justify-start gap-2 text-start md:w-1/2",disabled:h,loading:x===S&&h,onClick:()=>F(S),children:[r.jsx(Et,{"aria-hidden":"true",className:"text-token-text-primary me-2"}),r.jsx("span",{className:"sm:hidden",children:r.jsx(ie,{id:"imageParagen.multigen.choiceShort",defaultMessage:"Image {index}",values:{index:S+1}})}),r.jsx("span",{className:"hidden sm:inline",children:r.jsx(ie,{id:"imageParagen.multigen.choice",defaultMessage:"Image {index} is better",values:{index:S+1}})})]},"choice-".concat(S)))}),r.jsx("div",{className:"mt-2"})]}):null},Ga=({imageGenerationState:t,isInterrupted:e,asyncMessage:n,imageAssetPointer:a,altLabel:s,clientThreadId:l,serverThreadId:c,onEditorClick:o,isEditorAvailable:p,setAnimationPercentage:m,messageId:d,checkpointLogger:u})=>{var w;const[I,b]=i.useState(null),g=I==null,[h,_]=i.useState(!0),x=t===N.Thinking||t===N.AsyncGenerating&&!((w=n==null?void 0:n.metadata)!=null&&w.is_visually_hidden_from_conversation),v=t===N.Generating||t===N.Complete;return i.useEffect(()=>{x&&_(!1)},[x]),e?null:r.jsxs("div",{className:v?"relative pb-2":"relative",children:[(x||!h)&&r.jsx(xa,{isDimensionsUnknown:g,width:I==null?void 0:I.width,height:I==null?void 0:I.height,children:g&&r.jsx(Yt,{isGettingStarted:!0,messageId:d})}),v&&r.jsx(xe.div,{className:h?"relative":"absolute inset-0 w-full",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:h?"visible":"hidden",exit:"hidden",children:a&&r.jsx(Ne,{pointer:a,altLabel:s,isEditorAvailable:p,onPercentageRendered:m,messageId:d,clientThreadId:l,serverThreadId:c,imageIndex:0,onEditorClick:o,checkpointLogger:u,progressLoaderProps:{state:t,setContainerSize:b,hasImageReady:h,setHasImageReady:_,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})},Oe=t=>{"use forget";const e=zt.c(11),{conversation:n,cotMessages:a,visualPercentComplete:s,isInterrupted:l,state:c,showTitle:o,title:p,isTitleClickable:m,onRedirectClick:d}=t,u=l===void 0?!1:l,I=o===void 0?!1:o,b=m===void 0?!1:m,g=ge();let h;e[0]!==g?(h=g.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),e[0]=g,e[1]=h):h=e[1];const _=h,x=c===N.Complete||s===1;let v;e:{if(u){v=_;break e}else if(!a){v=void 0;break e}if(x){v=a.complete;break e}if(s){const R=Object.keys(a.generating);for(let f=0;f<R.length;f=f+1,f){const j=parseFloat(R[f]);if(s<j){v=a.generating[R[f]];break e}}}else{v=a.thinking;break e}v=a.complete}const w=v;let M;return e[2]!==n||e[3]!==w||e[4]!==u||e[5]!==b||e[6]!==d||e[7]!==I||e[8]!==p||e[9]!==x?(M=w&&r.jsx(ta,{conversation:n,latestHeadline:w,isComplete:x||u,showChunkIcon:!1,isExpandDisabled:!0,showTitle:I,title:p,isTitleClickable:b,onTitleClick:d}),e[2]=n,e[3]=w,e[4]=u,e[5]=b,e[6]=d,e[7]=I,e[8]=p,e[9]=x,e[10]=M):M=e[10],M};function Ua(t){"use forget";const e=zt.c(20),{pointer:n,altLabel:a,serverThreadId:s}=t;let l;e[0]===Symbol.for("react.memo_cache_sentinel")?(l=Bt(),e[0]=l):l=e[0];const c=l;let o;e[1]!==n||e[2]!==s?(o={asset:n,conversationId:s},e[1]=n,e[2]=s,e[3]=o):o=e[3];const{data:p,isLoading:m}=On(o),d=p==null?void 0:p.url,u=n.width&&n.height?n.width/n.height:1;let I;e[4]===Symbol.for("react.memo_cache_sentinel")?(I=()=>{En(c,{fallbackScreenHint:"login",skipLoginModal:!1})},e[4]=I):I=e[4];const b=I;if(!d&&!m)return null;const g=u<1?"max-w-[400px]":"max-w-[480px]";let h;e[5]!==g?(h=oe("relative w-full overflow-clip",g,"corner-superellipse/1.1 rounded-2xl"),e[5]=g,e[6]=h):h=e[6];let _;e[7]!==u?(_={aspectRatio:u},e[7]=u,e[8]=_):_=e[8];let x;e[9]!==a||e[10]!==n.height||e[11]!==n.width||e[12]!==d?(x=d?r.jsx($n,{src:d,alt:a,width:n.width,height:n.height,className:"h-full w-full scale-110 object-cover blur-2xl"}):r.jsx("div",{className:"bg-tertiary corner-superellipse/1.1 h-64 w-full rounded-2xl motion-safe:animate-pulse"}),e[9]=a,e[10]=n.height,e[11]=n.width,e[12]=d,e[13]=x):x=e[13];let v;e[14]===Symbol.for("react.memo_cache_sentinel")?(v=r.jsx("div",{className:"flex h-full items-center justify-center",children:r.jsx("span",{children:r.jsx(ie,de({},Pt.placeholderOverlay))})}),e[14]=v):v=e[14];let w;e[15]===Symbol.for("react.memo_cache_sentinel")?(w=r.jsxs("div",{className:"pointer-events-none absolute inset-0 bg-black/40 font-medium text-white",children:[v,r.jsx("div",{className:"pointer-events-auto absolute end-3 bottom-3",children:r.jsx(Pe,{as:"button",size:"medium",color:"secondary",onClick:b,children:r.jsx(ie,de({},Pt.loginCta))})})]}),e[15]=w):w=e[15];let M;return e[16]!==h||e[17]!==_||e[18]!==x?(M=r.jsxs("div",{className:h,style:_,children:[x,w]}),e[16]=h,e[17]=_,e[18]=x,e[19]=M):M=e[19],M}const Pt=ln({placeholderOverlay:{id:"imagegen.streamingImage.placeholderOverlay",defaultMessage:"Sign up or log in to view this image"},loginCta:{id:"imagegen.streamingImage.loginCta",defaultMessage:"Log in"}});function Pa(t){const e=t.find(c=>c.author.role==="tool"&&c.author.name===kn&&c.content.content_type==="text"),[n,...a]=(e==null?void 0:e.content.content_type)==="text"?e.content.parts:[],s=a.pop(),l=a.length;return n&&s&&a.length>0?{thinking:n,complete:s,generating:a.reduce((c,o,p)=>{const m=(p+1)/l;return c[m.toFixed(2)]=o,c},{})}:void 0}const Da=t=>{const e=ge(),{size:n="image",count:a=1}=t||{};return a>1?{thinking:e.formatMessage({id:"RyNwg3",defaultMessage:"Creating images"}),generating:{"0.33":e.formatMessage({id:"P/XIfT",defaultMessage:"Creating images"}),"0.67":e.formatMessage({id:"j2g/KZ",defaultMessage:"Creating images"}),"1.00":e.formatMessage({id:"hIsQxN",defaultMessage:"Creating images"})},complete:e.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:n==="xlimage"?{thinking:e.formatMessage({id:"PHKRzn",defaultMessage:"Creating image"}),generating:{"0.33":e.formatMessage({id:"7eNFXa",defaultMessage:"Creating image"}),"0.67":e.formatMessage({id:"md5juI",defaultMessage:"Creating image"}),"1.00":e.formatMessage({id:"g7GPZq",defaultMessage:"Creating image"})},complete:e.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:e.formatMessage({id:"Sdy/Av",defaultMessage:"Creating image"}),generating:{"0.33":e.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":e.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":e.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:e.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},La=Qe(()=>qe(()=>import("./n7gd6rqa6iqi6t4a.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18])).then(t=>t.ImageGenConversationLightboxNew)),za=Qe(()=>qe(()=>Promise.resolve().then(()=>Sa),void 0).then(t=>t.ProgressIndicator)),Fa=Qe(()=>qe(()=>import("./os4f80dxb1x5vcar.js"),__vite__mapDeps([19,1,3,4,20])).then(t=>t.ImageGenGradientLoadingShimmer)),Ba=[N.Empty,N.Errored],Oa=t=>t!=null&&typeof t=="object"&&"image_gen_paragen_metadata"in t,ss=({messages:t,clientThreadId:e,isLastTurnInConversation:n,isParagen:a=!1})=>{"use no forget";var Ie,we,ye,z,q,_e,et,tt;const s=De(),l=Nn(s,e),c=kt(l.serverId$),o=ge(),p=o.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{imageMessages:m,messageIds:d,imageAssetPointers:u}=i.useMemo(()=>Nt(t),[t]),I=t.find(Hn),b=Ve.useSelectedIndex(),g=(ye=(we=(Ie=u==null?void 0:u[b])==null?void 0:Ie.metadata)==null?void 0:we.generation)==null?void 0:ye.gen_size,h=Da({size:g!=null?g:"image",count:(z=u==null?void 0:u.length)!=null?z:1}),_=i.useMemo(()=>{var T;return(T=Pa(t))!=null?T:h},[t,h]),x=t.find(T=>{var V;return(V=T.metadata)==null?void 0:V.image_gen_async}),v=i.useMemo(()=>m.find(T=>{var se;const V=(se=T.metadata)==null?void 0:se.response_message_id;return typeof V=="string"&&V!==T.id}),[m]),w=(q=v==null?void 0:v.metadata)==null?void 0:q.response_message_id,M=!!w,R=(et=(_e=t.find(T=>{var V;return(V=T.metadata)==null?void 0:V.async_task_title}))==null?void 0:_e.metadata)==null?void 0:et.async_task_title,f=i.useMemo(()=>Vn(t,n),[t,n]),j=!Ye(),ce=u.some(T=>{var V;return(V=T.metadata)==null?void 0:V.is_no_auth_placeholder})&&f===N.Complete&&j,H=ua({toolCallMessage:I,imageMessages:m,conversationId:c,clientThreadId:e,imageGenerationState:f}),B=Ot(),Y=jn(),ne=i.useRef(!1),W=i.useRef(!1),J=i.useRef(null),Z=i.useMemo(()=>Je({pointer:u[b],conversationId:c,messageId:d[b],source:a?"paragen":"chat",imageIndex:b.toString()}),[u,d,b,c,a]),F=Wn();i.useEffect(()=>{if(!ne.current&&(f===N.Thinking||f===N.Generating))ne.current=!0,J.current=performance.now();else if(ne.current&&!W.current)if(f===N.Complete){const T=J.current?performance.now()-J.current:void 0;re.generationSuccess({analyticsContext:Z,durationMs:T}),W.current=!0}else f===N.Errored&&(re.generationFailure({analyticsContext:Z,errorReason:"assistant_error"}),W.current=!0)},[f,Z]);const P=t[t.length-1],K=i.useMemo(()=>P&&Cn(P),[P]),y=kt(()=>Rn(l).id),S=$e(s,"1971465707"),k=$e(s,"3175281277")===!1,G=qn({clientThreadId:l.id})&&f===N.Complete,[U,C]=i.useState(0),E=i.useMemo(()=>d.join(","),[d]),[D,O]=i.useState(null),A=m,Q=i.useMemo(()=>u.length!==2||d.length!==2||A.length!==2?!1:A.every(T=>{const V=T.metadata;if(!Oa(V))return!1;const se=V.image_gen_paragen_metadata;return typeof se=="object"&&(se==null?void 0:se.voted)!==!0}),[u.length,A,d.length]),ee=k&&Q&&n&&!(D===E),L=Ht.useIsMultigenParagenVotingActive(),me=a||ee,le=ee&&L,fe=i.useCallback(()=>{O(E)},[E]),te=Lt(),he=i.useCallback(async({image:T,messageId:V,analyticsContext:se})=>{var ot,ct,lt;if(Y)return B.warning(o.formatMessage({id:"imagegen.message.editorClick.integratedVoiceMode",defaultMessage:"Exit voice mode to view / edit the image"}));const nt=Ke(l.id),Zt=(nt?ke.getConversationTurns(nt).flatMap($=>$.messages):t).filter($=>{var be;const Se=(be=$.metadata)==null?void 0:be.response_message_id;return typeof Se!="string"||Se===$.id}),{imageAssetPointers:en,messageIds:at}=Nt(Zt,{skipSort:!0}),st=await Promise.all(en.map($=>$.asset_pointer===T.asset_pointer?Promise.resolve(T):$t.fetch(te,{asset:$,conversationId:c}))),Le=(st.length>0?st:[T]).map(($,Se)=>{var dt,ut,gt,mt,ft,ht;const be=at[Se]!=null?at[Se]:V;return{id:(gt=(ut=(dt=$.metadata)==null?void 0:dt.generation)==null?void 0:ut.gen_id)!=null?gt:be,archived:!1,transformationId:(ht=(ft=(mt=$.metadata)==null?void 0:mt.generation)==null?void 0:ft.gen_id)!=null?ht:null,url:$.url,assetPointer:$.asset_pointer,thumbnail:null,width:$.width,height:$.height,title:null,conversationId:c,messageId:be}});re.editorClick({sourceOperation:(lt=(ct=(ot=T.metadata)==null?void 0:ot.dalle)==null?void 0:ct.edit_op)!=null?lt:"none",analyticsContext:se});const it=Le.findIndex($=>$.assetPointer===T.asset_pointer),tn=Le.findIndex($=>$.messageId===V),rt=it!==-1?it:tn;Tn(s,La,{images:Le,initialIndex:rt===-1?0:rt,conversation:l,currentModelId:y})},[Y,l,t,s,B,o,te,c,y]),[ve,je]=i.useState(!1);i.useEffect(()=>{(f===N.Generating||f===N.Thinking)&&!n&&je(!0)},[f,n,ve]);const pe=ve||M,Ce=i.useCallback(()=>{w&&(He(l.id,T=>{T.scrollToMessageId=w,T.scrollToMessageIsAssistant=!0}),requestAnimationFrame(()=>{He(l.id,T=>{T.scrollToMessageId=void 0,T.scrollToMessageIsAssistant=void 0})}))},[l.id,w]);return Ba.includes(f)?null:r.jsx(Vt.Provider,{value:me,children:r.jsxs("div",{className:"flex flex-col",children:[f!==N.Unavailable&&f!==N.AsyncHanging&&!((tt=P==null?void 0:P.metadata)!=null&&tt.async_completion_id)&&!le&&!pe&&r.jsx("div",{className:"pb-2",children:r.jsx(Oe,{conversation:l,cotMessages:_,visualPercentComplete:U,isInterrupted:K,state:f,showTitle:!0,title:R,isTitleClickable:!1})}),(f===N.Thinking||f===N.AsyncGenerating)&&!K&&n&&r.jsx(Xt,{isDimensionsUnknown:!0,children:F?r.jsx(Fa,{}):r.jsx(za,{withLottie:!0})}),(f===N.Thinking||f===N.AsyncGenerating)&&pe&&r.jsx("div",{className:"pb-2",children:r.jsx(Oe,{conversation:l,cotMessages:_,visualPercentComplete:U,isInterrupted:K,state:f,showTitle:!0,title:R,isTitleClickable:!1})}),(f===N.Generating||f===N.Complete)&&!K&&r.jsx("div",{className:"pb-2",children:pe?r.jsx(Oe,{conversation:l,cotMessages:_,visualPercentComplete:U,isInterrupted:K,state:f,showTitle:!0,title:R,isTitleClickable:f===N.Complete,onRedirectClick:w?Ce:void 0}):ce?r.jsx(Ua,{pointer:u[0],altLabel:p,serverThreadId:c}):ee?r.jsx(Aa,{clientThreadId:l.id,serverThreadId:c,toolCallMessageId:I==null?void 0:I.id,pointers:u,messageIds:d,isEditorAvailable:G,onEditorClick:he,onComplete:fe,onPercentageRendered:C,checkpointLogger:H},E):u.length>1?r.jsx(Ra,{pointersToRender:u,altLabel:p,isEditorAvailable:G,updatePercentageRendered:C,toolCallMessage:I,toolOutputMessageIds:d,clientThreadId:l.id,serverThreadId:c,handleEditorClick:he,checkpointLogger:H}):S?r.jsx(Ga,{imageGenerationState:f,isInterrupted:K,asyncMessage:x,imageAssetPointer:u[0],messageId:d[0],altLabel:p,clientThreadId:l.id,serverThreadId:c,onEditorClick:he,setAnimationPercentage:C,isEditorAvailable:G,checkpointLogger:H}):r.jsx(Ne,{pointer:u[0],altLabel:p,isEditorAvailable:G,onPercentageRendered:C,messageId:d[0],imageIndex:0,clientThreadId:l.id,serverThreadId:c,onEditorClick:he,checkpointLogger:H})})]})})};export{ss as ImageGenMessage};
//# sourceMappingURL=oxou6hzxyw0w4jtf.js.map
