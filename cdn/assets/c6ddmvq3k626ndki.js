var P=Object.defineProperty,I=Object.defineProperties;var _=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var b=(t,n,s)=>n in t?P(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s,h=(t,n)=>{for(var s in n||(n={}))E.call(n,s)&&b(t,s,n[s]);if(k)for(var s of k(n))C.call(n,s)&&b(t,s,n[s]);return t},y=(t,n)=>I(t,_(n));import{E as O,r as R,j as p,v as M}from"./fg33krlcm0qyi6yw.js";import{ka as j,R as $,m3 as u,m4 as m,ai as v,aj as N,ak as A,ao as L}from"./mtk1qztvnb31pw5r.js";const U=(t,n)=>"".concat(t,":").concat(n),x=j((t,n)=>({async getToken(s,r){const l=U(s,r),a=n()._tokens[l];if(a)try{const e=await a;if(Date.now()+1800*1e3<e.expires_at*1e3)return e.access_token}catch(e){}const o=$.safeGet("/connectors/{connector_name}/oauth/scoped_token",{parameters:{path:{connector_name:s},query:{oauth_scope:r}}});return t(e=>y(h({},e),{_tokens:y(h({},e._tokens),{[l]:o})})),o.then(e=>e.access_token)},_tokens:{}}));async function B(t,n,s,r){if(s.type==="business"){const i=new URL(s.baseUrl);n=await x.getState().getToken(u.O365_BUSINESS,"".concat(i.origin,"/.default"))}const l=z(r,s.baseUrl),a=new URLSearchParams({filePicker:JSON.stringify(l)}),o="".concat(s.parsedUrl,"?").concat(a),e=t.document.createElement("form");e.setAttribute("action",o),e.setAttribute("method","POST");const c=t.document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name","access_token"),c.setAttribute("value",n),e.appendChild(c),t.document.body.append(e),e.submit()}function z(t,n){return{sdk:"8.0",messaging:{channelId:t,origin:location.origin},authentication:{},entry:{sharePoint:{byPath:{list:n}}},typesAndSources:{mode:"files"},selection:{mode:"multiple"},search:{enabled:!0}}}function q(t,n,s,r,l,a){function o(e){if((e==null?void 0:e.source)!==n)return;const c=e.data;if(c.type==="initialize"&&c.channelId===s){m.filePickerLoaded(a);const i=e.ports[0],f=T(t,async g=>{if(i.removeEventListener("message",f),i.close(),n.close(),g!=null){const S=await Promise.all(g.map(w=>G(w,t,l)));r({type:"pick",docs:S})}else r({type:"cancel"})},i,a);i.addEventListener("message",f),i.start(),i.postMessage({type:"activate"})}}window.addEventListener("message",o)}async function G(t,n,s){var e,c,i,d;let r="https://graph.microsoft.com/v1.0/drives/".concat(encodeURIComponent(t.parentReference.driveId),"/items/").concat(encodeURIComponent(t.id));s.type==="personal"&&(r="https://api.onedrive.com/v1.0/drives/".concat(encodeURIComponent(t.parentReference.driveId),"/items/").concat(encodeURIComponent(t.id)));const a=await(await fetch(r,{method:"GET",headers:{Authorization:"Bearer ".concat(n),"Content-Type":"application/json"}})).json();return{connector:s.type==="personal"?u.O365_PERSONAL:u.O365_BUSINESS,id:t.id,title:(e=a.name)!=null?e:"",mimeType:(i=(c=a.file)==null?void 0:c.mimeType)!=null?i:"",url:(d=a.webUrl)!=null?d:"",syntheticExtension:null,o365DriveId:t.parentReference.driveId}}function T(t,n,s,r){return async function(a){const o=a.data;if(o.type==="notification"||o.type!=="command")return;const e=o.data;switch(s.postMessage({type:"acknowledge",id:a.data.id}),e.command){case"authenticate":{r===u.O365_BUSINESS&&(t=await x.getState().getToken(r,"".concat(e.resource,"/.default"))),s.postMessage({type:"result",id:a.data.id,data:{result:"token",token:t}});break}case"close":{n(null);break}case"pick":{try{n(e.items),s.postMessage({type:"result",id:a.data.id,data:{result:"success"}})}catch(c){s.postMessage({type:"result",id:a.data.id,data:{result:"error",error:{code:"unusableItem",message:c.message}}})}break}default:{s.postMessage({type:"result",id:a.data.id,data:{result:"error",error:{code:"unsupportedCommand",message:e.command}}});break}}}}const W=O.memo(function({onClose:n,accessToken:s,oneDriveURL:r,uploadPickedFile:l}){const{current:a}=R.useRef(new WeakMap),o=r.type==="personal"?u.O365_PERSONAL:u.O365_BUSINESS;return p.jsx(v,{open:!0,onOpenChange:e=>{e||n()},children:p.jsx(N,{children:p.jsx(A,{className:"fixed inset-0 flex items-center justify-center bg-black/50 dark:bg-black/80",children:p.jsx(L,{className:"flex h-full max-h-[600px] w-full max-w-[1300px] items-center justify-center",onPointerDownOutside:()=>{m.filePickerCancelled(o)},children:p.jsx("iframe",{className:"mx-[32px] my-[32px] h-full w-full",src:"about:blank",ref:e=>{const c=e==null?void 0:e.contentWindow;if(e==null||c==null||a.has(e))return;a.set(e,!0);const i=M();m.filePickerStarted(o),B(c,s,r,i),q(s,c,i,d=>{switch(d.type){case"pick":m.filePickerPicked(o,d.docs.length),d.docs.forEach(f=>l(f,o));break;case"cancel":m.filePickerCancelled(o);break}n()},r,o)}})})})})})});export{W as OneDrivePickerModal};
//# sourceMappingURL=c6ddmvq3k626ndki.js.map
