var m2=Object.defineProperty,_2=Object.defineProperties;var g2=Object.getOwnPropertyDescriptors;var um=Object.getOwnPropertySymbols;var $0=Object.prototype.hasOwnProperty,Z0=Object.prototype.propertyIsEnumerable;var q0=(z,C,$)=>C in z?m2(z,C,{enumerable:!0,configurable:!0,writable:!0,value:$}):z[C]=$,Pr=(z,C)=>{for(var $ in C||(C={}))$0.call(C,$)&&q0(z,$,C[$]);if(um)for(var $ of um(C))Z0.call(C,$)&&q0(z,$,C[$]);return z},gn=(z,C)=>_2(z,g2(C));var uf=(z,C)=>{var $={};for(var ue in z)$0.call(z,ue)&&C.indexOf(ue)<0&&($[ue]=z[ue]);if(z!=null&&um)for(var ue of um(z))C.indexOf(ue)<0&&Z0.call(z,ue)&&($[ue]=z[ue]);return $};import{r as Ke,j as ur,E as ao,k as hf,M as Lg,c as y2}from"./fg33krlcm0qyi6yw.js";import{M as vg}from"./kx34yg3blv92o8xp.js";import{n9 as x2,na as v2,nc as b2,nb as w2,nh as T2,bv as cb,bg as ub,l as S2,T as E2,da as I2,_ as A2}from"./mtk1qztvnb31pw5r.js";import{d as M2}from"./goc4414xjv43pin0.js";import{E as rs,c as Og}from"./ej6tlexkw0sv7caa.js";import{E as W0,n as bg}from"./f96c6fguu1kcw0go.js";import{a as C2}from"./jdzosouyvpzu0tpb.js";import{uV as P2}from"./k65njl5wlgspihfr.js";import{s as R2}from"./mw40q7txi1y5m4dq.js";import"./hwa6pbq6i57ntwuh.js";import"./fmwvxydiodjqi0t8.js";import"./nb22pb07i8ebbv0i.js";const wg="#3B82F6",qa=12;function mf(z,C){return z.width/(C.widthEmu*rs)}function D2(z,C,$){return C>=z.x&&C<=z.x+z.width&&$>=z.y&&$<=z.y+z.height}function hb(z,C,$,ue,Ie){var tt;if(!z)return null;const ve=fb(z,C,$);return(tt=["nw","ne","sw","se"].find(o=>D2(ve[o],ue,Ie)))!=null?tt:null}function db(z,C,$){var ue;return(ue=[...z.elements].sort((Ie,ve)=>{var tt,o;return((tt=ve.zIndex)!=null?tt:0)-((o=Ie.zIndex)!=null?o:0)}).find(({bbox:Ie})=>{if(!Ie||!Ie.xEmu||!Ie.yEmu||!Ie.widthEmu||!Ie.heightEmu)return!1;const{xEmu:ve,yEmu:tt,widthEmu:o,heightEmu:Oe}=Ie,$e=ve*rs,It=tt*rs,lt=o*rs,Tt=Oe*rs;return C>=$e&&C<=$e+lt&&$>=It&&$<=It+Tt}))!=null?ue:null}function z2(z,C,$,ue,Ie,ve){z.save(),z.lineJoin="miter";const tt=(o,Oe,$e,It=null)=>{const{x:lt,y:Tt,width:Rt,height:ai}=Og(o,C,ve);It&&z.setLineDash(It),z.lineWidth=Oe,z.strokeStyle=$e,z.strokeRect(lt,Tt,Rt,ai),z.setLineDash([])};if($&&$!==ue&&tt($,2,wg),ue&&!Ie){tt(ue,2,wg);const o=fb(ue,C,ve);Object.values(o).forEach(Oe=>{z.fillStyle="#FFFFFF",z.strokeStyle=wg,z.lineWidth=2,z.fillRect(Oe.x,Oe.y,Oe.width,Oe.height),z.strokeRect(Oe.x,Oe.y,Oe.width,Oe.height)})}z.restore()}function fb(z,C,$){const{x:ue,y:Ie,width:ve,height:tt}=Og(z,C,$),o=qa/2;return{nw:new DOMRect(ue-o,Ie-o,qa,qa),ne:new DOMRect(ue+ve-o,Ie-o,qa,qa),sw:new DOMRect(ue-o,Ie+tt-o,qa,qa),se:new DOMRect(ue+ve-o,Ie+tt-o,qa,qa)}}class L2{constructor(C){this.getTargets=C}hitTest(C){const $=this.getTargets();let ue=null,Ie=-1/0;for(const ve of $){if(!O2(ve.bounds)||!k2(ve.bounds,C)||typeof ve.hitTest=="function"&&!ve.hitTest(C)||ue&&ve.zIndex<Ie)continue;const tt={x:C.x-ve.bounds.x,y:C.y-ve.bounds.y};ue={targetId:ve.id,kind:ve.kind,world:{x:C.x,y:C.y},local:tt,path:[ve.id]},Ie=ve.zIndex}return ue}}function O2(z){return Number.isFinite(z.x)&&Number.isFinite(z.y)&&Number.isFinite(z.width)&&Number.isFinite(z.height)&&z.width>0&&z.height>0}function k2(z,C){const $=C.x>=z.x&&C.x<=z.x+z.width,ue=C.y>=z.y&&C.y<=z.y+z.height;return $&&ue}class F2{constructor(){this.listeners=new Map}on(C,$){let ue=this.listeners.get(C);return ue||(ue=new Set,this.listeners.set(C,ue)),ue.add($),()=>{ue==null||ue.delete($),(ue==null?void 0:ue.size)===0&&this.listeners.delete(C)}}emit(C){const $=this.listeners.get(C.type);if($)for(const ue of Array.from($))ue(C)}}const B2=5,N2=250;class V2{constructor(C){var $,ue;this.lastHit=null,this.activePointerId=null,this.downPosition=null,this.downTime=null,this.lastClickTime=null,this.lastClickTargetId=null,this.hitTester=C.hitTester,this.events=C.events,this.clickDistanceThreshold=($=C.clickDistanceThreshold)!=null?$:B2,this.clickTimeThresholdMs=(ue=C.clickTimeThresholdMs)!=null?ue:N2}handlePointerEvent(C){switch(C.type){case"pointerMove":this.handlePointerMove(C);break;case"pointerDown":this.handlePointerDown(C);break;case"pointerUp":this.handlePointerUp(C);break;case"pointerLeave":this.handlePointerLeave();break}}handlePointerMove(C){const $=this.hitTester.hitTest(C.world);this.updateHover($)}handlePointerDown(C){this.activePointerId!==null&&this.activePointerId!==C.pointerId||(this.activePointerId=C.pointerId,this.downPosition={x:C.world.x,y:C.world.y},this.downTime=C.time)}handlePointerUp(C){if(this.activePointerId===null||C.pointerId!==this.activePointerId)return;const $=this.hitTester.hitTest(C.world);if(this.updateHover($),this.shouldEmitClick(C,$)&&$){if(C.button===2)this.events.emit({type:"contextMenu",hit:$});else{const Ie=this.computeClickCount(C,$);this.events.emit({type:"click",hit:$,clicks:Ie})}this.lastClickTime=C.time,this.lastClickTargetId=$.targetId}this.activePointerId=null,this.downPosition=null,this.downTime=null}handlePointerLeave(){this.clearHover()}updateHover(C){const $=this.lastHit;if(($==null?void 0:$.targetId)===(C==null?void 0:C.targetId)){this.lastHit=C;return}$&&this.events.emit({type:"pointerLeave",hit:$}),C&&this.events.emit({type:"pointerEnter",hit:C}),this.lastHit=C,this.events.emit({type:"hoverChanged",hit:C})}clearHover(){if(!this.lastHit)return;const C=this.lastHit;this.lastHit=null,this.events.emit({type:"pointerLeave",hit:C}),this.events.emit({type:"hoverChanged",hit:null})}shouldEmitClick(C,$){if(!$||!this.downPosition||this.downTime===null)return!1;const ue=C.world.x-this.downPosition.x,Ie=C.world.y-this.downPosition.y;return ue*ue+Ie*Ie>this.clickDistanceThreshold**2?!1:C.time-this.downTime<=this.clickTimeThresholdMs}computeClickCount(C,$){return this.lastClickTime!==null&&this.lastClickTargetId===$.targetId&&C.time-this.lastClickTime<=this.clickTimeThresholdMs?2:1}}class U2{constructor(C){this.events=C,this.selected=null,this.unsubscribeClick=null,this.unsubscribeClick=this.events.on("click",$=>{$.clicks===1&&this.setSelected($.hit.targetId)})}getSelected(){return this.selected}dispose(){var C;(C=this.unsubscribeClick)==null||C.call(this),this.unsubscribeClick=null}setSelected(C){this.selected!==C&&(this.selected=C,this.events.emit({type:"selectionChanged",targetId:C}))}}function X0(z,C,$=12){var ue,Ie,ve,tt;for(let o=z.length-1;o>=0;o-=1){const Oe=z[o];if(Oe){if(j2(Oe.kind)){if(Oe.x===void 0||Oe.y===void 0||Oe.width===void 0||Oe.height===void 0)continue;const $e=Oe.x+Oe.width/2,It=Oe.y+Oe.height/2,lt=Math.max(Oe.width,Oe.height)/2+Math.max(0,$);if(C.x>=$e-lt&&C.x<=$e+lt&&C.y>=It-lt&&C.y<=It+lt)return Oe;continue}if(G2(Oe.kind)){if(Oe.x!==void 0&&Oe.y!==void 0&&Oe.width!==void 0&&Oe.height!==void 0&&C.x>=Oe.x&&C.x<=Oe.x+Oe.width&&C.y>=Oe.y&&C.y<=Oe.y+Oe.height)return Oe;continue}if(Oe.kind==="pie"&&Oe.cx!=null&&Oe.cy!=null){const $e=C.x-Oe.cx,It=C.y-Oe.cy,lt=Math.hypot($e,It);if(lt<((ue=Oe.rInner)!=null?ue:0)||lt>((Ie=Oe.rOuter)!=null?Ie:0))continue;let Tt=Math.atan2(It,$e);Tt<0&&(Tt+=Math.PI*2);let Rt=(ve=Oe.startAngle)!=null?ve:0,ai=(tt=Oe.endAngle)!=null?tt:0;if(Rt<0&&(Rt+=Math.PI*2),ai<0&&(ai+=Math.PI*2),Rt<=ai?Tt>=Rt&&Tt<=ai:Tt>=Rt||Tt<=ai)return Oe}}}return null}function j2(z){return z==="scatter-point"||z==="bubble-point"||z==="line-point"}function G2(z){return z==="bar-vertical"||z==="bar-horizontal"||z==="line-point"||z==="area-point"||z==="legend"}const H2="shadow-[0_5px_8px_3px_rgba(0,0,0,0.025),_0_0.5px_1px_0px_rgba(0,0,0,0.045)] dark:shadow-[0_8px_20px_rgba(0,0,0,0.35),_0_0.5px_1px_rgba(0,0,0,0.6)]";function q2({canvasRef:z,stageRef:C,chartTargetsRef:$,slideW:ue,slideH:Ie,onLegendToggle:ve,minPointHitRadius:tt=12,scrollContainerRef:o,subscribeToPointerEvents:Oe}){"use no forget";var yi,Ii,xr,Lr,vr;const[$e,It]=Ke.useState(null),{x:lt,y:Tt,strategy:Rt,refs:ai,update:_t}=x2({placement:"top",middleware:[v2(6),b2(),w2({padding:8})],whileElementsMounted:T2,strategy:"fixed"}),Ot=Ke.useRef(null),li=Math.max(1,ue),Xt=Math.max(1,Ie);Ke.useEffect(()=>{if(!$e||$e.kind==="legend"||!z.current)return;const mi=z.current.getBoundingClientRect(),Pt=mi.width/li,wr=mi.height/Xt,ir=$e.anchorX*Pt,qi=$e.anchorY*wr,di={getBoundingClientRect:()=>new DOMRect(mi.left+ir,mi.top+qi,0,0)};Ot.current=di,ai.setReference(di),_t==null||_t()},[$e,ai,_t,z,li,Xt]);const gi=Ke.useCallback(mi=>{const Pt=z.current;Pt&&(Pt.style.cursor=mi);const wr=C.current;wr&&(wr.style.cursor=mi)},[z,C]),hi=Ke.useCallback(()=>{It(null),gi("default")},[gi]),Wi=Ke.useCallback((mi,Pt)=>{const wr=z.current;if(!wr){hi();return}const ir=wr.getBoundingClientRect();if(ir.width===0||ir.height===0){hi();return}const qi=mi*li/ir.width,di=Pt*Xt/ir.height,ar=X0($.current,{x:qi,y:di},tt);It(ar),gi(ar?"pointer":"default")},[z,$,tt,hi,Xt,li,gi]);Ke.useEffect(()=>Oe?Oe(Pt=>{if(Pt.type==="pointerLeave"){hi();return}if(Pt.type==="pointerUp"&&Pt.pointerType!=="mouse"){hi();return}(Pt.type==="pointerMove"||Pt.type==="pointerDown")&&Wi(Pt.world.x,Pt.world.y)}):void 0,[Oe,hi,Wi]),Ke.useEffect(()=>{if(Oe)return;const mi=z.current;if(!mi)return;const Pt=C.current,wr=di=>{if(!ve)return;const ar=mi.getBoundingClientRect();if(ar.width===0||ar.height===0)return;const Wr=(di.clientX-ar.left)*li/ar.width,Cn=(di.clientY-ar.top)*Xt/ar.height,hr=X0($.current,{x:Wr,y:Cn},tt);hr&&hr.kind==="legend"&&hr.elementId!==void 0&&hr.seriesIndex!=null&&(di.stopPropagation(),ve(hr.elementId,hr.seriesIndex))},ir=di=>{Wi(di.clientX-mi.getBoundingClientRect().left,di.clientY-mi.getBoundingClientRect().top)},qi=()=>{hi()};return mi.addEventListener("mousemove",ir),mi.addEventListener("mouseleave",qi),mi.addEventListener("click",wr),()=>{mi.removeEventListener("mousemove",ir),mi.removeEventListener("mouseleave",qi),mi.removeEventListener("click",wr),hi(),Pt&&(Pt.style.cursor="default")}},[z,$,tt,ve,hi,Xt,li,C,Oe,Wi]);const ci=(yi=o==null?void 0:o.current)!=null?yi:null;return Ke.useEffect(()=>{const mi=ci!=null?ci:window,Pt=()=>{It(null);const wr=z.current;wr&&(wr.style.cursor="default");const ir=C.current;ir&&(ir.style.cursor="default")};return mi.addEventListener("scroll",Pt,{passive:!0}),()=>{mi.removeEventListener("scroll",Pt)}},[ci,z,C]),ur.jsx(cb,{children:$e&&$e.kind!=="legend"&&ur.jsx(ub.div,{ref:ai.setFloating,initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.12,ease:"easeOut"},style:{position:Rt,left:lt!=null?lt:0,top:Tt!=null?Tt:0,zIndex:1e3},className:"pointer-events-none font-sans",children:ur.jsxs("div",{className:S2("bg-token-main-surface-primary outline-token-border-light text-token-text-primary relative rounded-lg px-2 py-1.5 outline outline-[0.5px]",H2),children:[ur.jsx("div",{className:"flex w-full flex-col px-1 py-0.5 text-xs leading-tight",children:ur.jsx("div",{className:"me-6 w-full min-w-[88px]",children:(xr=(Ii=$e.category)!=null?Ii:$e.seriesName)!=null?xr:""})}),ur.jsx("div",{className:"border-default mt-0.5 flex flex-col border-t border-solid pt-2",children:ur.jsxs("div",{className:"flex flex-row items-stretch px-1 py-0 text-xs leading-tight",children:[ur.jsxs("div",{className:"flex items-center",children:[ur.jsx("div",{className:"me-1.5 h-2 w-2 rounded-[2px]",style:{backgroundColor:(Lr=$e.color)!=null?Lr:"transparent"}}),ur.jsx("div",{className:"me-6 min-w-[88px]",children:(vr=$e.seriesName)!=null?vr:""})]}),ur.jsx("div",{className:"text-default grow text-end",children:$e.value})]})})]})})})}const $2=ao[typeof document<"u"&&document.createElement!==void 0?"useLayoutEffect":"useEffect"],Z2=z=>{const C=Ke.useRef(z);return Ke.useEffect(()=>{C.current=z}),C};function W2(){}function X2(z,C,$={}){const ue=K2($.polyfill),Ie=Z2(C);return $2(()=>{let ve=!1;const tt=z&&"current"in z?z.current:z;if(!tt)return W2;function o(Oe,$e){ve||Ie.current(Oe,$e)}return ue.subscribe(tt,o),()=>{ve=!0,ue.unsubscribe(tt,o)}},[z,ue,Ie]),ue.observer}function Y2(z){let C=!1,$=[];const ue=new Map,Ie=new(z||window.ResizeObserver)((ve,tt)=>{$=$.concat(ve);function o(){const Oe=new Set;for(let $e=0;$e<$.length;$e++){if(Oe.has($[$e].target))continue;Oe.add($[$e].target);const It=ue.get($[$e].target);It==null||It.forEach(lt=>lt($[$e],tt))}$=[],C=!1}C||window.requestAnimationFrame(o),C=!0});return{observer:Ie,subscribe(ve,tt){var o;Ie.observe(ve);const Oe=(o=ue.get(ve))!==null&&o!==void 0?o:[];Oe.push(tt),ue.set(ve,Oe)},unsubscribe(ve,tt){var o;const Oe=(o=ue.get(ve))!==null&&o!==void 0?o:[];if(Oe.length===1){Ie.unobserve(ve),ue.delete(ve);return}const $e=Oe.indexOf(tt);$e!==-1&&Oe.splice($e,1),ue.set(ve,Oe)}}}let Tg;const K2=z=>Tg||(Tg=Y2(z));function J2(z,C=100){const[$,ue]=Ke.useState({width:0,height:0});X2(z,ve=>{const{width:tt,height:o}=ve.contentRect;ue({width:tt,height:o})});const[Ie]=C2($,C);return Ie}const Q2=(z,C,$,ue,Ie,ve,tt)=>Ke.useCallback(o=>{if(!z||!C||!$.current||!ue.current)return;const Oe=o.currentTarget.getBoundingClientRect(),$e=mf(Oe,C),It=$.current.getBoundingClientRect(),lt=ue.current.getBoundingClientRect(),Tt=lt.left-It.left,Rt=lt.top-It.top,ai=(o.clientX-Oe.left)/$e,_t=(o.clientY-Oe.top)/$e,Ot=ve.find(ci=>ai>=ci.x&&ai<=ci.x+ci.width&&_t>=ci.y&&_t<=ci.y+ci.height);if(!Ot)return;if(o.stopPropagation(),Ot.action==="ppaction://hlinksldjump"){const ci=Ot.url.match(/slide(\d+)\.xml$/);if(ci){const yi=Number(ci[1])-1;yi>=0&&yi<z.slides.length&&tt(yi)}return}const li=Ot.x*$e+Tt,Xt=(Ot.x+Ot.width)*$e+Tt,gi=(Ot.y+Ot.height/2)*$e+Rt,hi=It.width-Xt>=li?"right":"left",Wi=hi==="right"?Xt:li;Ie({url:Ot.url,x:Wi,y:gi,placement:hi})},[z,C,ve,ue,Ie,$,tt]),eS=(z,C,$,ue,Ie,ve,tt,o,Oe)=>Ke.useCallback($e=>{if(!z||!C||!$.current||!ue.current)return;const It=$e.currentTarget.getBoundingClientRect(),lt=mf(It,C),Tt=($e.clientX-It.left)/lt,Rt=($e.clientY-It.top)/lt;if(!Ie)return;let ai="move",_t=null;ve&&(_t=hb(ve,z,C,Tt,Rt),_t&&(ai="resize"));const Ot=ai==="move"?db(C,Tt,Rt):ve;if(!Ot){tt(null),o(null);return}tt(Ot),o(Ot);const{x:li,y:Xt,width:gi,height:hi}=Og(Ot,z,C);Oe({element:Ot,origin:{x:li,y:Xt,w:gi,h:hi},mouseStart:{x:Tt,y:Rt},mode:ai,corner:_t,preserveRatio:$e.shiftKey,moved:!1})},[z,C,ve,Ie,ue,Oe,o,tt,$]),tS=(z,C,$,ue,Ie,ve,tt,o)=>Ke.useCallback(Oe=>{if(!z||!C||!$.current)return;if(ue){if(!ue.element.bbox)return;const _t=Oe.currentTarget.getBoundingClientRect(),Ot=mf(_t,C),li=(Oe.clientX-_t.left)/Ot,Xt=(Oe.clientY-_t.top)/Ot,gi=li-ue.mouseStart.x,hi=Xt-ue.mouseStart.y;if(ue.mode==="move"){if(gi===0&&hi===0)return;ue.element.bbox.xEmu=(ue.origin.x+gi)/rs,ue.element.bbox.yEmu=(ue.origin.y+hi)/rs}else if(ue.mode==="resize"){const Wi=ue.preserveRatio||Oe.shiftKey,{x:ci,y:yi,w:Ii,h:xr}=ue.origin;let Lr=ci,vr=yi,mi=Ii,Pt=xr;const wr=Ii/xr;switch(ue.corner){case"nw":Lr=ci+gi,vr=yi+hi,mi=Ii-gi,Pt=xr-hi;break;case"ne":vr=yi+hi,mi=Ii+gi,Pt=xr-hi;break;case"sw":Lr=ci+gi,mi=Ii-gi,Pt=xr+hi;break;case"se":default:mi=Ii+gi,Pt=xr+hi;break}Wi&&(Math.abs(mi/Pt)>wr?Pt=mi/wr:mi=Pt*wr,(ue.corner==="nw"||ue.corner==="sw")&&(Lr=ci+(Ii-mi)),(ue.corner==="nw"||ue.corner==="ne")&&(vr=yi+(xr-Pt))),mi=Math.max(1,mi),Pt=Math.max(1,Pt),ue.element.bbox.xEmu=Lr/rs,ue.element.bbox.yEmu=vr/rs,ue.element.bbox.widthEmu=mi/rs,ue.element.bbox.heightEmu=Pt/rs}Ie(gn(Pr({},ue),{moved:!0}));return}const $e=Oe.currentTarget.getBoundingClientRect(),It=mf($e,C),lt=(Oe.clientX-$e.left)/It,Tt=(Oe.clientY-$e.top)/It,Rt=hb(ve,z,C,lt,Tt);Rt?($.current.style.cursor="".concat(Rt,"-resize"),tt(ve)):($.current.style.cursor="",tt(db(C,lt,Tt)));const ai=o.find(_t=>lt>=_t.x&&lt<=_t.x+_t.width&&Tt>=_t.y&&Tt<=_t.y+_t.height);$.current.style.cursor=ai?"pointer":""},[z,C,ue,ve,$,tt,Ie,o]),iS=(z,C,$)=>{Ke.useEffect(()=>{if(!z.current)return;const ue=z.current;if(ue.querySelectorAll("video[data-slide-video]").forEach(ve=>{const tt=ve.dataset.url;tt&&(URL.revokeObjectURL(tt),ve.remove())}),!C)return;const Ie=mf(ue.getBoundingClientRect(),C);C.elements.filter(ve=>ve.video).forEach(ve=>{var Rt,ai;if(!ve.bbox||!ve.bbox.xEmu||!ve.bbox.yEmu||!ve.bbox.widthEmu||!ve.bbox.heightEmu)return;const{xEmu:tt,yEmu:o,widthEmu:Oe,heightEmu:$e}=ve.bbox;if(!ve.video)return;const It=new Blob([P2(ve.video.data)],{type:ve.video.contentType}),lt=URL.createObjectURL(It),Tt=document.createElement("video");Tt.src=lt,Tt.dataset.slideVideo="true",Tt.dataset.url=lt,Tt.autoplay=!0,Tt.loop=!0,Tt.muted=!0,Tt.playsInline=!0,Object.assign(Tt.style,{position:"absolute",left:"".concat(tt*rs*Ie,"px"),top:"".concat(o*rs*Ie,"px"),width:"".concat(Oe*rs*Ie,"px"),height:"".concat($e*rs*Ie,"px"),objectFit:"cover",zIndex:(ai=(Rt=ve.zIndex)==null?void 0:Rt.toString())!=null?ai:"0",pointerEvents:"none"}),ue.appendChild(Tt)})},[C,$,z])};var hm={exports:{}},rS=hm.exports,Y0;function nS(){return Y0||(Y0=1,(function(z,C){(function($,ue){z.exports=ue()})(rS,(function(){var $,ue,Ie;function ve(o,Oe){if(!$)$=Oe;else if(!ue)ue=Oe;else{var $e="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+$+")(sharedChunk); ("+ue+")(sharedChunk); self.onerror = null;",It={};$(It),Ie=Oe(It),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Ie.workerUrl=window.URL.createObjectURL(new Blob([$e],{type:"text/javascript"})))}}ve(["exports"],(function(o){var Oe=1e-6,$e=typeof Float32Array<"u"?Float32Array:Array;function It(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*u-a*s;return h?(r[0]=u*(h=1/h),r[1]=-s*h,r[2]=-a*h,r[3]=i*h,r):null}function lt(){var r=new $e(9);return $e!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function Tt(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8];return r[0]=h*v-f*g,r[1]=a*g-s*v,r[2]=s*f-a*h,r[3]=f*_-u*v,r[4]=i*v-a*_,r[5]=a*u-i*f,r[6]=u*g-h*_,r[7]=s*_-i*g,r[8]=i*h-s*u,r}function Rt(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=i[0],I=i[1],A=i[2],R=i[3],L=i[4],k=i[5],U=i[6],G=i[7],q=i[8];return r[0]=w*s+I*h+A*g,r[1]=w*a+I*f+A*v,r[2]=w*u+I*_+A*b,r[3]=R*s+L*h+k*g,r[4]=R*a+L*f+k*v,r[5]=R*u+L*_+k*b,r[6]=U*s+G*h+q*g,r[7]=U*a+G*f+q*v,r[8]=U*u+G*_+q*b,r}function ai(){var r=new $e(16);return $e!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function _t(r){var e=new $e(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function Ot(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function li(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8],b=e[9],w=e[10],I=e[11],A=e[12],R=e[13],L=e[14],k=e[15],U=i*f-s*h,G=i*_-a*h,q=i*g-u*h,ie=s*_-a*f,J=s*g-u*f,se=a*g-u*_,le=v*R-b*A,he=v*L-w*A,Ce=v*k-I*A,ye=b*L-w*R,Pe=b*k-I*R,ke=w*k-I*L,Ve=U*ke-G*Pe+q*ye+ie*Ce-J*he+se*le;return Ve?(r[0]=(f*ke-_*Pe+g*ye)*(Ve=1/Ve),r[1]=(a*Pe-s*ke-u*ye)*Ve,r[2]=(R*se-L*J+k*ie)*Ve,r[3]=(w*J-b*se-I*ie)*Ve,r[4]=(_*Ce-h*ke-g*he)*Ve,r[5]=(i*ke-a*Ce+u*he)*Ve,r[6]=(L*q-A*se-k*G)*Ve,r[7]=(v*se-w*q+I*G)*Ve,r[8]=(h*Pe-f*Ce+g*le)*Ve,r[9]=(s*Ce-i*Pe-u*le)*Ve,r[10]=(A*J-R*q+k*U)*Ve,r[11]=(b*q-v*J-I*U)*Ve,r[12]=(f*he-h*ye-_*le)*Ve,r[13]=(i*ye-s*he+a*le)*Ve,r[14]=(R*G-A*ie-L*U)*Ve,r[15]=(v*ie-b*G+w*U)*Ve,r):null}function Xt(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=e[9],I=e[10],A=e[11],R=e[12],L=e[13],k=e[14],U=e[15],G=i[0],q=i[1],ie=i[2],J=i[3];return r[0]=G*s+q*f+ie*b+J*R,r[1]=G*a+q*_+ie*w+J*L,r[2]=G*u+q*g+ie*I+J*k,r[3]=G*h+q*v+ie*A+J*U,r[4]=(G=i[4])*s+(q=i[5])*f+(ie=i[6])*b+(J=i[7])*R,r[5]=G*a+q*_+ie*w+J*L,r[6]=G*u+q*g+ie*I+J*k,r[7]=G*h+q*v+ie*A+J*U,r[8]=(G=i[8])*s+(q=i[9])*f+(ie=i[10])*b+(J=i[11])*R,r[9]=G*a+q*_+ie*w+J*L,r[10]=G*u+q*g+ie*I+J*k,r[11]=G*h+q*v+ie*A+J*U,r[12]=(G=i[12])*s+(q=i[13])*f+(ie=i[14])*b+(J=i[15])*R,r[13]=G*a+q*_+ie*w+J*L,r[14]=G*u+q*g+ie*I+J*k,r[15]=G*h+q*v+ie*A+J*U,r}function gi(r,e,i){var s,a,u,h,f,_,g,v,b,w,I,A,R=i[0],L=i[1],k=i[2];return e===r?(r[12]=e[0]*R+e[4]*L+e[8]*k+e[12],r[13]=e[1]*R+e[5]*L+e[9]*k+e[13],r[14]=e[2]*R+e[6]*L+e[10]*k+e[14],r[15]=e[3]*R+e[7]*L+e[11]*k+e[15]):(a=e[1],u=e[2],h=e[3],f=e[4],_=e[5],g=e[6],v=e[7],b=e[8],w=e[9],I=e[10],A=e[11],r[0]=s=e[0],r[1]=a,r[2]=u,r[3]=h,r[4]=f,r[5]=_,r[6]=g,r[7]=v,r[8]=b,r[9]=w,r[10]=I,r[11]=A,r[12]=s*R+f*L+b*k+e[12],r[13]=a*R+_*L+w*k+e[13],r[14]=u*R+g*L+I*k+e[14],r[15]=h*R+v*L+A*k+e[15]),r}function hi(r,e,i){var s=i[0],a=i[1],u=i[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*u,r[9]=e[9]*u,r[10]=e[10]*u,r[11]=e[11]*u,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function Wi(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[4],h=e[5],f=e[6],_=e[7],g=e[8],v=e[9],b=e[10],w=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=u*a+g*s,r[5]=h*a+v*s,r[6]=f*a+b*s,r[7]=_*a+w*s,r[8]=g*a-u*s,r[9]=v*a-h*s,r[10]=b*a-f*s,r[11]=w*a-_*s,r}function ci(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],_=e[3],g=e[8],v=e[9],b=e[10],w=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a-g*s,r[1]=h*a-v*s,r[2]=f*a-b*s,r[3]=_*a-w*s,r[8]=u*s+g*a,r[9]=h*s+v*a,r[10]=f*s+b*a,r[11]=_*s+w*a,r}function yi(r,e,i){var s=Math.sin(i),a=Math.cos(i),u=e[0],h=e[1],f=e[2],_=e[3],g=e[4],v=e[5],b=e[6],w=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=u*a+g*s,r[1]=h*a+v*s,r[2]=f*a+b*s,r[3]=_*a+w*s,r[4]=g*a-u*s,r[5]=v*a-h*s,r[6]=b*a-f*s,r[7]=w*a-_*s,r}function Ii(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function xr(r,e,i){var s,a,u,h=i[0],f=i[1],_=i[2],g=Math.sqrt(h*h+f*f+_*_);return g<Oe?null:(h*=g=1/g,f*=g,_*=g,s=Math.sin(e),a=Math.cos(e),r[0]=h*h*(u=1-a)+a,r[1]=f*h*u+_*s,r[2]=_*h*u-f*s,r[3]=0,r[4]=h*f*u-_*s,r[5]=f*f*u+a,r[6]=_*f*u+h*s,r[7]=0,r[8]=h*_*u+f*s,r[9]=f*_*u-h*s,r[10]=_*_*u+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Lr(r,e){var i=e[0],s=e[1],a=e[2],u=e[4],h=e[5],f=e[6],_=e[8],g=e[9],v=e[10];return r[0]=Math.sqrt(i*i+s*s+a*a),r[1]=Math.sqrt(u*u+h*h+f*f),r[2]=Math.sqrt(_*_+g*g+v*v),r}function vr(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i+i,f=s+s,_=a+a,g=i*h,v=s*h,b=s*f,w=a*h,I=a*f,A=a*_,R=u*h,L=u*f,k=u*_;return r[0]=1-b-A,r[1]=v+k,r[2]=w-L,r[3]=0,r[4]=v-k,r[5]=1-g-A,r[6]=I+R,r[7]=0,r[8]=w+L,r[9]=I-R,r[10]=1-g-b,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}var mi=Xt;function Pt(){var r=new $e(3);return $e!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function wr(r){var e=new $e(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function ir(r){var e=r[0],i=r[1],s=r[2];return Math.sqrt(e*e+i*i+s*s)}function qi(r,e,i){var s=new $e(3);return s[0]=r,s[1]=e,s[2]=i,s}function di(r,e,i,s){return r[0]=e,r[1]=i,r[2]=s,r}function ar(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function Wr(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Cn(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function hr(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function dn(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function Xi(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function ns(r,e,i,s){return r[0]=e[0]+i[0]*s,r[1]=e[1]+i[1]*s,r[2]=e[2]+i[2]*s,r}function Mo(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return Math.sqrt(i*i+s*s+a*a)}function xn(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return i*i+s*s+a*a}function lo(r){var e=r[0],i=r[1],s=r[2];return e*e+i*i+s*s}function ss(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function Yi(r,e){var i=e[0],s=e[1],a=e[2],u=i*i+s*s+a*a;return u>0&&(u=1/Math.sqrt(u)),r[0]=e[0]*u,r[1]=e[1]*u,r[2]=e[2]*u,r}function Qi(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function Fr(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[0],f=i[1],_=i[2];return r[0]=a*_-u*f,r[1]=u*h-s*_,r[2]=s*f-a*h,r}function Xn(r,e,i,s){var a=e[0],u=e[1],h=e[2];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r}function dr(r,e,i){var s=e[0],a=e[1],u=e[2],h=i[3]*s+i[7]*a+i[11]*u+i[15];return r[0]=(i[0]*s+i[4]*a+i[8]*u+i[12])/(h=h||1),r[1]=(i[1]*s+i[5]*a+i[9]*u+i[13])/h,r[2]=(i[2]*s+i[6]*a+i[10]*u+i[14])/h,r}function os(r,e,i){var s=e[0],a=e[1],u=e[2];return r[0]=s*i[0]+a*i[3]+u*i[6],r[1]=s*i[1]+a*i[4]+u*i[7],r[2]=s*i[2]+a*i[5]+u*i[8],r}function Vn(r,e,i){var s=i[0],a=i[1],u=i[2],h=i[3],f=e[0],_=e[1],g=e[2],v=a*g-u*_,b=u*f-s*g,w=s*_-a*f;return r[0]=f+h*(v+=v)+a*(w+=w)-u*(b+=b),r[1]=_+h*b+u*v-s*w,r[2]=g+h*w+s*b-a*v,r}function Br(r){return r[0]=0,r[1]=0,r[2]=0,r}function fs(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var Rr=Wr,co=Cn,Un=ir;function nn(){var r=new $e(4);return $e!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function ps(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function uo(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=i*i+s*s+a*a+u*u;return h>0&&(h=1/Math.sqrt(h)),r[0]=i*h,r[1]=s*h,r[2]=a*h,r[3]=u*h,r}function En(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3];return r[0]=i[0]*s+i[4]*a+i[8]*u+i[12]*h,r[1]=i[1]*s+i[5]*a+i[9]*u+i[13]*h,r[2]=i[2]*s+i[6]*a+i[10]*u+i[14]*h,r[3]=i[3]*s+i[7]*a+i[11]*u+i[15]*h,r}function zs(){var r=new $e(4);return $e!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function ms(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function Yn(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=s*_+h*f,r[1]=a*_+u*f,r[2]=u*_-a*f,r[3]=h*_-s*f,r}function Kn(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=s*_-u*f,r[1]=a*_+h*f,r[2]=u*_+s*f,r[3]=h*_-a*f,r}Pt(),nn();var vn,Ls,Tr,Hs=uo,sn=(vn=Pt(),Ls=qi(1,0,0),Tr=qi(0,1,0),function(r,e,i){var s=Qi(e,i);return s<-.999999?(Fr(vn,Ls,e),Un(vn)<1e-6&&Fr(vn,Tr,e),Yi(vn,vn),(function(a,u,h){h*=.5;var f=Math.sin(h);a[0]=f*u[0],a[1]=f*u[1],a[2]=f*u[2],a[3]=Math.cos(h)})(r,vn,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Fr(vn,e,i),r[0]=vn[0],r[1]=vn[1],r[2]=vn[2],r[3]=1+s,Hs(r,r))});function Ki(){var r=new $e(2);return $e!=Float32Array&&(r[0]=0,r[1]=0),r}function Jr(r,e){var i=new $e(2);return i[0]=r,i[1]=e,i}function Os(r,e,i){return r[0]=e,r[1]=i,r}function Dn(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Jn(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function zn(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function fr(r){var e=r[0],i=r[1];return Math.sqrt(e*e+i*i)}function fn(r,e){var i=e[0],s=e[1],a=i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function Es(r,e){return r[0]*e[0]+r[1]*e[1]}zs(),zs(),lt();var Xr,jr,In=Jn;function Qn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Ki();var Ln=(function(){if(jr)return Xr;function r(e,i,s,a){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=a}return jr=1,Xr=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,a=0;a<8;a++){var u=this.sampleCurveX(s)-e;if(Math.abs(u)<i)return s;var h=this.sampleCurveDerivativeX(s);if(Math.abs(h)<1e-6)break;s-=u/h}var f=0,_=1;for(s=e,a=0;a<20&&(u=this.sampleCurveX(s),!(Math.abs(u-e)<i));a++)e>u?f=s:_=s,s=.5*(_-f)+f;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Xr})(),bn=Qn(Ln);function Be(r,e){this.x=r,this.y=e}function On(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!On(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!On(r[i],e[i]))return!1;return!0}return r===e}Be.prototype={clone(){return new Be(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){const e=r.x-this.x,i=r.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){const e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){const r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){const e=Math.cos(r),i=Math.sin(r),s=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=s,this},_rotateAround(r,e){const i=Math.cos(r),s=Math.sin(r),a=e.y+s*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-s*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Be},Be.convert=function(r){if(r instanceof Be)return r;if(Array.isArray(r))return new Be(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Be(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};const cn=Math.PI/180,as=180/Math.PI;function Qt(r){return r*cn}function Qr(r){return r*as}const ks=[[0,0],[1,0],[1,1],[0,1]];function xs(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function pe(r,e,i,s){const a=new bn(r,e,i,s);return function(u){return a.solve(u)}}const F=pe(.25,.1,.25,1);function B(r,e,i){return Math.min(i,Math.max(e,r))}function X(r,e,i){return(i=B((i-r)/(e-r),0,1))*i*(3-2*i)}function ae(r,e,i){const s=i-e,a=((r-e)%s+s)%s+e;return a===e?i:a}function oe(r,e,i){if(!r.length)return i(null,[]);let s=r.length;const a=new Array(r.length);let u=null;r.forEach(((h,f)=>{e(h,((_,g)=>{_&&(u=_),a[f]=g,--s==0&&i(u,a)}))}))}let de=1;function Se(){return de++}function me(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log2(r)))}function be(r,e){r.forEach((i=>{e[i]&&(e[i]=e[i].bind(e))}))}function Ze(r,e,i){const s={};for(const a in r)s[a]=e.call(this,r[a],a,r);return s}function Ue(r,e,i){const s={};for(const a in r)e.call(this,r[a],a,r)&&(s[a]=r[a]);return s}function vt(r){return Array.isArray(r)?r.map(vt):typeof r=="object"&&r?Ze(r,vt):r}function Bt(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}const Lt={};function Mt(r){Lt[r]||(typeof console<"u"&&console.warn(r),Lt[r]=!0)}function ei(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function ri(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function Fi([r,e,i]){const s=Qt(e+90),a=Qt(i);return{x:r*Math.cos(s)*Math.sin(a),y:r*Math.sin(s)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function Sr(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function en(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((i,s,a,u)=>{const h=a||u;return e[s]=!h||h.toLowerCase(),""})),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Dr=null;function Er(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function Ai(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<s?e=a+1:i=a}return e}function ui(r,e,i,s){for(;e<i;){const a=e+i>>1;r[a]<=s?e=a+1:i=a}return e}function lr(r){return r>0?1/(1.001-r):1+r}function pr(r){return r>0?1-1/(1.001-r):-r}function Di(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const er={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!er.API_URL)return null;try{const r=new URL(er.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch(r){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Yr(r){return er.API_URL_REGEX.test(r)}function wn(r){return er.API_SPRITE_REGEX.test(r)}let _s,Co,pn,Is,es,Ht;function Ut(){return _s==null&&(_s=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),_s}const Mi={now:()=>Is!==void 0?Is:performance.now(),setNow(r){Is=r},restoreNow(){Is=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:s}=r;es||(es=document.createElement("canvas"));const a=es.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>es.width||s>es.height)&&(es.width=i,es.height=s),a.clearRect(-e,-e,i+2*e,s+2*e),a.drawImage(r,0,0,i,s),a.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(Co||(Co=document.createElement("a")),Co.href=r,Co.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(pn==null&&(pn=window.matchMedia("(prefers-reduced-motion: reduce)")),pn.matches)},hasCanvasFingerprintNoise(){if(Ht!==void 0)return Ht;if(!Ut())return Ht=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let a=0;a<r.width;++a)e.fillStyle="rgba(".concat(i++,",").concat(i++,",").concat(i++,", 255)"),e.fillRect(a,0,1,1);const s=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<s.data.length;++a)if(a%4!=3&&i++!==s.data[a])return Ht=!0,!0;return Ht=!1,!1}};function ji(r,e){const i=r.indexOf("?");if(i<0)return"".concat(r,"?").concat(new URLSearchParams(e).toString());const s=new URLSearchParams(r.slice(i));for(const a in e)s.set(a,e[a]);return"".concat(r.slice(0,i),"?").concat(s.toString())}function mr(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const s=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(const h of e.persistentParams){const f=a.get(h);f&&s.set(h,f)}const u=s.toString();return"".concat(r.slice(0,i)).concat(u.length>0?"?".concat(u):"")}const hn="mapbox-tiles";let sr=500,jn=50;const As=["language","worldview","jobid"];let Gn,vs;function ho(){try{return caches}catch(r){}}function Po(){const r=ho();r&&Gn==null&&(Gn=r.open(hn))}let ba=1/0;const Ro={supported:!1,testSupport:function(r){!$a&&Ms&&(wa?lh(r):qs=r)}};let qs,Ms,$a=!1,wa=!1;const Fs=typeof self<"u"?self:{};function lh(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ms),r.isContextLost())return;Ro.supported=!0}catch(i){}r.deleteTexture(e),$a=!0}Fs.document&&(Ms=Fs.document.createElement("img"),Ms.onload=function(){qs&&lh(qs),qs=null,wa=!0},Ms.onerror=function(){$a=!0,qs=null},Ms.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ta={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Ta);class Sa extends Error{constructor(e,i,s){i===401&&Yr(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return"".concat(this.name,": ").concat(this.message," (").concat(this.status,"): ").concat(this.url)}}const ch=Sr()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Vl=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(ch())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return(function(s,a){const u=new AbortController,h=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:ch(),referrerPolicy:s.referrerPolicy,signal:u.signal});let f=!1,_=!1;const g=(v=h.url).indexOf("sku=")>0&&Yr(v);var v;s.type==="json"&&h.headers.set("Accept","application/json");const b=(I,A,R)=>{if(_)return;if(I&&I.message!=="SecurityError"&&Mt(I.toString()),A&&R)return w(A);const L=Date.now();fetch(h).then((k=>{if(k.ok){const U=g?k.clone():null;return w(k,U,L)}return a(new Sa(k.statusText,k.status,s.url))})).catch((k=>{k.name!=="AbortError"&&a(new Error("".concat(k.message," ").concat(s.url)))}))},w=(I,A,R)=>{(s.type==="arrayBuffer"?I.arrayBuffer():s.type==="json"?I.json():I.text()).then((L=>{_||(A&&R&&(function(k,U,G){if(Po(),Gn==null)return;const q=en(U.headers.get("Cache-Control")||"");if(q["no-store"])return;const ie={status:U.status,statusText:U.statusText,headers:new Headers};U.headers.forEach(((le,he)=>ie.headers.set(he,le))),q["max-age"]&&ie.headers.set("Expires",new Date(G+1e3*q["max-age"]).toUTCString());const J=ie.headers.get("Expires");if(!J||new Date(J).getTime()-G<42e4)return;let se=mr(k.url,{persistentParams:As});if(U.status===206){const le=k.headers.get("Range");if(!le)return;ie.status=200,se=ji(se,{range:le})}(function(le,he){if(vs===void 0)try{new Response(new ReadableStream),vs=!0}catch(Ce){vs=!1}vs?he(le.body):le.blob().then(he).catch((Ce=>Mt(Ce.message)))})(U,(le=>{const he=new Response((Ce=U.status)!==200&&Ce!==404&&[101,103,204,205,304].includes(Ce)?null:le,ie);var Ce;Po(),Gn!=null&&Gn.then((ye=>ye.put(se,he))).catch((ye=>Mt(ye.message)))}))})(h,A,R),f=!0,a(null,L,I.headers))})).catch((L=>{_||a(new Error(L.message))}))};return g?(function(I,A){if(Po(),Gn==null)return A(null);Gn.then((R=>{let L=mr(I.url,{persistentParams:As});const k=I.headers.get("Range");k&&(L=ji(L,{range:k})),R.match(L).then((U=>{const G=(function(q){if(!q)return!1;const ie=new Date(q.headers.get("Expires")||0),J=en(q.headers.get("Cache-Control")||"");return Number(ie)>Date.now()&&!J["no-cache"]})(U);R.delete(L).catch(A),G&&R.put(L,U.clone()).catch(A),A(null,U,G)})).catch(A)})).catch(A)})(h,b):b(null,null),{cancel:()=>{_=!0,f||u.abort()}}})(r,e);if(Sr(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return(function(s,a){const u=new XMLHttpRequest;u.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(u.responseType="arraybuffer");for(const h in s.headers)u.setRequestHeader(h,s.headers[h]);return s.type==="json"&&(u.responseType="text",u.setRequestHeader("Accept","application/json")),u.withCredentials=s.credentials==="include",u.onerror=()=>{a(new Error(u.statusText))},u.onload=()=>{if((u.status>=200&&u.status<300||u.status===0)&&u.response!==null){let h=u.response;if(s.type==="json")try{h=JSON.parse(u.response)}catch(_){return a(_)}const f=new Headers;u.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((_=>{const g=_.split(": "),v=g.shift(),b=g.join(": ");f.append(v,b)})),a(null,h,f)}else a(new Sa(u.statusText,u.status,s.url))},u.send(s.body),{cancel:()=>u.abort()}})(r,e)},Za=function(r,e){return Vl(Object.assign(r,{type:"arrayBuffer"}),e)};function Bi(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const uh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Ul,jl;Ul=[],jl=0;const hh=function(r,e){if(Ro.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),jl>=er.MAX_PARALLEL_IMAGE_REQUESTS){const u={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ul.push(u),u}jl++;let i=!1;const s=()=>{if(!i)for(i=!0,jl--;Ul.length&&jl<er.MAX_PARALLEL_IMAGE_REQUESTS;){const u=Ul.shift(),{requestParameters:h,callback:f,cancelled:_}=u;_||(u.cancel=hh(h,f).cancel)}},a=Za(r,((u,h,f)=>{s(),u?e(u):h&&(self.createImageBitmap?(function(_,g){const v=new Blob([new Uint8Array(_)],{type:"image/png"});createImageBitmap(v).then((b=>{g(null,b)})).catch((b=>{g(new Error("Could not load image because of ".concat(b.message,". Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.")))}))})(h,((_,g)=>e(_,g,f))):(function(_,g){const v=new Image;v.onload=()=>{g(null,v),URL.revokeObjectURL(v.src),v.onload=null,requestAnimationFrame((()=>{v.src=uh}))},v.onerror=()=>g(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const b=new Blob([new Uint8Array(_)],{type:"image/png"});v.src=_.byteLength?URL.createObjectURL(b):uh})(h,((_,g)=>e(_,g,f))))}));return{cancel:()=>{a.cancel(),s()}}};var Gl,Hl,ql,Ea={exports:{}},vf={exports:{}},Oc={exports:{}},gm=(function(){if(ql)return Ea.exports;ql=1;var r=(Gl||(Gl=1,vf.exports=function(i,s){var a,u,h,f,_,g,v,b;for(u=i.length-(a=3&i.length),h=s,_=3432918353,g=461845907,b=0;b<u;)v=255&i.charCodeAt(b)|(255&i.charCodeAt(++b))<<8|(255&i.charCodeAt(++b))<<16|(255&i.charCodeAt(++b))<<24,++b,h=27492+(65535&(f=5*(65535&(h=(h^=v=(65535&(v=(v=(65535&v)*_+(((v>>>16)*_&65535)<<16)&4294967295)<<15|v>>>17))*g+(((v>>>16)*g&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(v=0,a){case 3:v^=(255&i.charCodeAt(b+2))<<16;case 2:v^=(255&i.charCodeAt(b+1))<<8;case 1:h^=v=(65535&(v=(v=(65535&(v^=255&i.charCodeAt(b)))*_+(((v>>>16)*_&65535)<<16)&4294967295)<<15|v>>>17))*g+(((v>>>16)*g&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),vf.exports),e=(Hl||(Hl=1,Oc.exports=function(i,s){for(var a,u=i.length,h=s^u,f=0;u>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(a>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),u-=4,++f;switch(u){case 3:h^=(255&i.charCodeAt(f+2))<<16;case 2:h^=(255&i.charCodeAt(f+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(f)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),Oc.exports);return Ea.exports=r,Ea.exports.murmur3=r,Ea.exports.murmur2=e,Ea.exports})(),$l=Qn(gm);class $s{constructor(e,...i){Object.assign(this,i[0]||{}),this.type=e}}class Zl extends $s{constructor(e,i={}){super("error",Object.assign({error:e},i))}}function Wa(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function Wl(r,e,i){if(i&&i[r]){const s=i[r].indexOf(e);s!==-1&&i[r].splice(s,1)}}class Vo{on(e,i){return this._listeners=this._listeners||{},Wa(e,i,this._listeners),this}off(e,i){return Wl(e,i,this._listeners),Wl(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Wa(e,i,this._oneTimeListeners),this):new Promise((s=>{this.once(e,s)}))}fire(e,i){const s=typeof e=="string"?new $s(e,i):e,a=s.type;if(this.listens(a)){s.target=this;const u=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const _ of u)_.call(this,s);const h=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const _ of h)Wl(a,_,this._oneTimeListeners),_.call(this,s);const f=this._eventedParent;if(f){const _=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(s,_),f.fire(s)}}else s instanceof Zl&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class An{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new An(e)}static toString(e){return e.iconsetId?"".concat(e.name,"").concat(e.iconsetId):e.name}static parse(e){const[i,s]=e.split("");return new An({name:i,iconsetId:s})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return An.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var dh,fh={},ph=(function(){if(dh)return fh;dh=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(u){return(u=Math.round(u))<0?0:u>255?255:u}function i(u){return e(u[u.length-1]==="%"?parseFloat(u)/100*255:parseInt(u))}function s(u){return(h=u[u.length-1]==="%"?parseFloat(u)/100:parseFloat(u))<0?0:h>1?1:h;var h}function a(u,h,f){return f<0?f+=1:f>1&&(f-=1),6*f<1?u+(h-u)*f*6:2*f<1?h:3*f<2?u+(h-u)*(2/3-f)*6:u}try{fh.parseCSSColor=function(u){var h,f=u.replace(/ /g,"").toLowerCase();if(f in r)return r[f].slice();if(f[0]==="#")return f.length===4?(h=parseInt(f.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:f.length===7&&(h=parseInt(f.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var _=f.indexOf("("),g=f.indexOf(")");if(_!==-1&&g+1===f.length){var v=f.substr(0,_),b=f.substr(_+1,g-(_+1)).split(","),w=1;switch(v){case"rgba":if(b.length!==4)return null;w=s(b.pop());case"rgb":return b.length!==3?null:[i(b[0]),i(b[1]),i(b[2]),w];case"hsla":if(b.length!==4)return null;w=s(b.pop());case"hsl":if(b.length!==3)return null;var I=(parseFloat(b[0])%360+360)%360/360,A=s(b[1]),R=s(b[2]),L=R<=.5?R*(A+1):R+A-R*A,k=2*R-L;return[e(255*a(k,L,I+1/3)),e(255*a(k,L,I)),e(255*a(k,L,I-1/3)),w];default:return null}}return null}}catch(u){}return fh})();class Gi{constructor(e,i,s,a=1){this.r=e,this.g=i,this.b=s,this.a=a}static parse(e){if(!e)return;if(e instanceof Gi)return e;if(typeof e!="string")return;const i=ph.parseCSSColor(e);return i?new Gi(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,s,a]=[this.r,this.g,this.b,this.a];return"rgba(".concat(Math.round(255*e),",").concat(Math.round(255*i),",").concat(Math.round(255*s),",").concat(a,")")}toNonPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new bf(e,i,s,a,u)}toPremultipliedRenderColor(e){const{r:i,g:s,b:a,a:u}=this;return new wf(e,i*u,s*u,a*u,u)}clone(){return new Gi(this.r,this.g,this.b,this.a)}}class mh{constructor(e,i,s,a,u,h=!1){if(this.premultiplied=!1,this.premultiplied=h,e){const f=e.image.height,_=f*f;this.premultiplied?(i=u===0?0:i/u*(f-1),s=u===0?0:s/u*(f-1),a=u===0?0:a/u*(f-1)):(i*=f-1,s*=f-1,a*=f-1);const g=Math.floor(i),v=Math.floor(s),b=Math.floor(a),w=Math.ceil(i),I=Math.ceil(s),A=Math.ceil(a),R=i-g,L=s-v,k=a-b,U=e.image.data,G=4*(g+v*_+b*f),q=4*(g+v*_+A*f),ie=4*(g+I*_+b*f),J=4*(g+I*_+A*f),se=4*(w+v*_+b*f),le=4*(w+v*_+A*f),he=4*(w+I*_+b*f),Ce=4*(w+I*_+A*f);if(G<0||Ce>=U.length)throw new Error("out of range");this.r=Vt(Vt(Vt(U[G],U[q],k),Vt(U[ie],U[J],k),L),Vt(Vt(U[se],U[le],k),Vt(U[he],U[Ce],k),L),R)/255*(this.premultiplied?u:1),this.g=Vt(Vt(Vt(U[G+1],U[q+1],k),Vt(U[ie+1],U[J+1],k),L),Vt(Vt(U[se+1],U[le+1],k),Vt(U[he+1],U[Ce+1],k),L),R)/255*(this.premultiplied?u:1),this.b=Vt(Vt(Vt(U[G+2],U[q+2],k),Vt(U[ie+2],U[J+2],k),L),Vt(Vt(U[se+2],U[le+2],k),Vt(U[he+2],U[Ce+2],k),L),R)/255*(this.premultiplied?u:1),this.a=u}else this.r=i,this.g=s,this.b=a,this.a=u}toArray(){const{r:e,g:i,b:s,a}=this;return[255*e,255*i,255*s,a]}toHslaArray(){let{r:e,g:i,b:s,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];const A=1/a;e*=A,i*=A,s*=A}const u=Math.min(Math.max(e,0),1),h=Math.min(Math.max(i,0),1),f=Math.min(Math.max(s,0),1),_=Math.min(u,h,f),g=Math.max(u,h,f),v=g-_,b=.5*(_+g);if(v===0)return[0,0,100*b,a];const w=b>.5?v/(2-g-_):v/(g+_);let I;switch(g){case u:I=60*((h-f)/v+(h<f?6:0));break;case h:I=60*((f-u)/v+2);break;default:I=60*((u-h)/v+4)}return[I,100*w,100*b,a]}toArray01(){const{r:e,g:i,b:s,a}=this;return[e,i,s,a]}toArray01Scaled(e){const{r:i,g:s,b:a}=this;return[i*e,s*e,a*e]}toArray01Linear(){const{r:e,g:i,b:s,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(s,2.2),a]}}class bf extends mh{constructor(e,i,s,a,u){super(e,i,s,a,u,!1)}}class wf extends mh{constructor(e,i,s,a,u){super(e,i,s,a,u,!0)}}function Vt(r,e,i){return r*(1-i)+e*i}function Xl(r,e,i){return r.map(((s,a)=>Vt(s,e[a],i)))}Gi.black=new Gi(0,0,0,1),Gi.white=new Gi(1,1,1,1),Gi.transparent=new Gi(0,0,0,0),Gi.red=new Gi(1,0,0,1),Gi.blue=new Gi(0,0,1,1);var Uo=Object.freeze({__proto__:null,array:Xl,color:function(r,e,i){return new Gi(Vt(r.r,e.r,i),Vt(r.g,e.g,i),Vt(r.b,e.b,i),Vt(r.a,e.a,i))},number:Vt});class fo extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class po{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[s,a]of i)this.bindings[s]=a}concat(e){return new po(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error("".concat(e," not found in scope."))}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Xa={kind:"null"},At={kind:"number"},Ci={kind:"string"},Vi={kind:"boolean"},Bs={kind:"color"},Ya={kind:"object"},$i={kind:"value"},Yl={kind:"collator"},Ia={kind:"formatted"},Kl={kind:"resolvedImage"};function Hn(r,e){return{kind:"array",itemType:r,N:e}}function Tn(r){if(r.kind==="array"){const e=Tn(r.itemType);return typeof r.N=="number"?"array<".concat(e,", ").concat(r.N,">"):r.itemType.kind==="value"?"array":"array<".concat(e,">")}return r.kind}const ym=[Xa,At,Ci,Vi,Bs,Ia,Ya,Hn($i),Kl];function Jl(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Jl(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const i of ym)if(!Jl(i,e))return null}}return"Expected ".concat(Tn(r)," but found ").concat(Tn(e)," instead.")}function _h(r,e){return e.some((i=>i.kind===r.kind))}function Ql(r,e){return e.some((i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r))}function kc(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&kc(r.itemType,e.itemType):r.kind===e.kind}class gh{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ec{constructor(e,i,s,a,u){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=a,this.textColor=u}}class kn{constructor(e){this.sections=e}static fromString(e){return new kn([new ec(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((e=>e.text.length!==0||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof kn?e:kn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);const s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class jo{constructor(e,i={}){if(this.id=An.from(e),this.options=Object.assign({},i),i.transform){const{a:s,b:a,c:u,d:h,e:f,f:_}=i.transform;this.options.transform=new DOMMatrix([s,a,u,h,f,_])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:s,d:a,e:u,f:h}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:s,d:a,e:u,f:h}})}static parse(e){let i,s,a,u;try{({name:i,iconsetId:s,params:a,transform:u}=JSON.parse(e)||{})}catch(w){return null}if(!i)return null;const{a:h,b:f,c:_,d:g,e:v,f:b}=u||{};return new jo({name:i,iconsetId:s},{params:a,transform:new DOMMatrix([h,f,_,g,v,b])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class Cs{constructor(e,i,s,a,u=!1){this.primaryId=An.from(e),this.primaryOptions=i,s&&(this.secondaryId=An.from(s)),this.secondaryOptions=a,this.available=u}toString(){return this.primaryId&&this.secondaryId?"[".concat(this.primaryId.name,",").concat(this.secondaryId.name,"]"):this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new jo(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new jo(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Cs.build({name:e}):e}static build(e,i,s,a){return!e||typeof e=="object"&&!("name"in e)?null:new Cs(e,s,i,a)}}function Fc(r,e,i,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:"Invalid rgba value [".concat([r,e,i,s].join(", "),"]: 'a' must be between 0 and 1."):"Invalid rgba value [".concat((typeof s=="number"?[r,e,i,s]:[r,e,i]).join(", "),"]: 'r', 'g', and 'b' must be between 0 and 255.")}function Ka(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Gi||r instanceof gh||r instanceof kn||r instanceof Cs)return!0;if(Array.isArray(r)){for(const e of r)if(!Ka(e))return!1;return!0}if(typeof r=="object"){for(const e in r)if(!Ka(r[e]))return!1;return!0}return!1}function Pn(r){if(r===null)return Xa;if(typeof r=="string")return Ci;if(typeof r=="boolean")return Vi;if(typeof r=="number")return At;if(r instanceof Gi)return Bs;if(r instanceof gh)return Yl;if(r instanceof kn)return Ia;if(r instanceof Cs)return Kl;if(Array.isArray(r)){const e=r.length;let i;for(const s of r){const a=Pn(s);if(i){if(i===a)continue;i=$i;break}i=a}return Hn(i||$i,e)}return Ya}function Do(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof kn||r instanceof Cs||r instanceof Gi?r.toString():JSON.stringify(r)}class Go{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error("'literal' expression requires exactly one argument, but found ".concat(e.length-1," instead."));if(!Ka(e[1]))return i.error("invalid value");const s=e[1];let a=Pn(s);const u=i.expectedType;return a.kind!=="array"||a.N!==0||!u||u.kind!=="array"||typeof u.N=="number"&&u.N!==0||(a=u),new Go(a,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Gi?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof kn?this.value.serialize():this.value}}class on{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const ni={string:Ci,number:At,boolean:Vi,object:Ya};class wt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,a=1;const u=e[0];if(u==="array"){let f,_;if(e.length>2){const g=e[1];if(typeof g!="string"||!(g in ni)||g==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);f=ni[g],a++}else f=$i;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);_=e[2],a++}s=Hn(f,_)}else s=ni[u];const h=[];for(;a<e.length;a++){const f=i.parse(e[a],a,$i);if(!f)return null;h.push(f)}return new wt(s,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const s=this.args[i].evaluate(e);if(!Jl(this.type,Pn(s)))return s;if(i===this.args.length-1)throw new on("The expression ".concat(JSON.stringify(this.args[i].serialize())," evaluated to ").concat(Tn(Pn(s))," but was expected to be of type ").concat(Tn(this.type),"."))}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map((s=>s.serialize())))}}class Aa{constructor(e){this.type=Ia,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");const a=[];let u=!1;for(let h=1;h<=e.length-1;++h){const f=e[h];if(u&&typeof f=="object"&&!Array.isArray(f)){u=!1;let _=null;if(f["font-scale"]&&(_=i.parseObjectValue(f["font-scale"],h,"font-scale",At),!_))return null;let g=null;if(f["text-font"]&&(g=i.parseObjectValue(f["text-font"],h,"text-font",Hn(Ci)),!g))return null;let v=null;if(f["text-color"]&&(v=i.parseObjectValue(f["text-color"],h,"text-color",Bs),!v))return null;const b=a[a.length-1];b.scale=_,b.font=g,b.textColor=v}else{const _=i.parse(e[h],h,$i);if(!_)return null;const g=_.type.kind;if(g!=="string"&&g!=="value"&&g!=="null"&&g!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");u=!0,a.push({content:_,scale:null,font:null,textColor:null})}}return new Aa(a)}evaluate(e){return new kn(this.sections.map((i=>{const s=i.content.evaluate(e);return kc(Pn(s),Kl)?new ec("",s,null,null,null):new ec(Do(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)})))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class Zt{constructor(e,i,s,a){this._imageWarnHistory={},this.type=Kl,this.namePrimary=e,this.nameSecondary=i,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1;const a=[];function u(){if(s<e.length){const f=i.parse(e[s],s++,Ci);return f?(a.push({image:f,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(s<e.length){const _=e[s];if((f=_)===null||typeof f!="object"||Array.isArray(f))return!0;const g=_.params,v=_.iconset,b=i.concat(s);if(!g&&!v)return s++,!0;if(g){if(typeof g!="object"||g.constructor!==Object)return b.error('Image options "params" should be an object'),!1;const w={},I=b.concat(void 0,"params");for(const A in g){if(!A)return I.error("Image parameter name should be non-empty"),!1;const R=I.concat(void 0,A).parse(g[A],void 0,Bs,void 0,{typeAnnotation:"coerce"});if(!R)return!1;w[A]=R}a[a.length-1].options.params=w}if(v){if(typeof v!="object"||v.constructor!==Object)return b.error('Image options "iconset" should be an object'),!1;if(!v.id)return b.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=v}return s++,!0}var f;return!0}for(let f=0;f<2;f++)if(!u()||!h())return;return new Zt(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){const s={};if(i){for(const a in i)if(i[a])try{s[a]=i[a].evaluate(e)}catch(u){continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=Cs.build(i,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){const u=a.getPrimary().id;if(a.available=e.availableImages.some((h=>An.isEqual(h,u))),a.available){const h=a.getSecondary()?a.getSecondary().id:null;h&&(a.available=e.availableImages.some((f=>An.isEqual(f,h))))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const s={};if(i&&(s.iconset={id:i}),e){s.params={};for(const a in e)e[a]&&(s.params[a]=e[a].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function Ja(r){return jt(r)?"string":tc(r)?"number":Nc(r)?"boolean":Array.isArray(r)?"array":r===null?"null":Bc(r)?"object":typeof r}function Bc(r){return r!=null&&!Array.isArray(r)&&typeof r!="function"&&!(r instanceof String||r instanceof Number||r instanceof Boolean)&&typeof r=="object"}function jt(r){return typeof r=="string"||r instanceof String}function tc(r){return typeof r=="number"||r instanceof Number}function Nc(r){return typeof r=="boolean"||r instanceof Boolean}const Tf={"to-boolean":Vi,"to-color":Bs,"to-number":At,"to-string":Ci};class zo{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[0],a=[];let u=Xa;if(s==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error("Expected ".concat(i.expectedType.kind," but found array."));u=Hn(i.expectedType.itemType,h)}else{if(!(h>0&&Ka(e[1][0])))return null;u=Hn(Pn(e[1][0]),h)}for(let f=0;f<h;f++){const _=e[1][f];let g;if(Array.isArray(_))g=i.parse(_,void 0,u.itemType);else{const v=Ja(_);if(v!==u.itemType.kind)return i.error("Expected ".concat(u.itemType.kind," but found ").concat(v,"."));g=i.registry.literal.parse(["literal",_===void 0?null:_],i)}if(!g)return null;a.push(g)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");u=Tf[s];for(let h=1;h<e.length;h++){const f=i.parse(e[h],h,$i);if(!f)return null;a.push(f)}}return new zo(u,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(const a of this.args){if(i=a.evaluate(e),s=null,i instanceof Gi)return i;if(typeof i=="string"){const u=e.parseColor(i);if(u)return u}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?"Invalid rbga value ".concat(JSON.stringify(i),": expected an array containing either three or four numeric values."):Fc(i[0],i[1],i[2],i[3]),!s))return new Gi(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new on(s||"Could not parse color from value '".concat(typeof i=="string"?i:String(JSON.stringify(i)),"'"))}if(this.type.kind==="number"){let i=null;for(const s of this.args){if(i=s.evaluate(e),i===null)return 0;const a=Number(i);if(!isNaN(a))return a}throw new on("Could not convert ".concat(JSON.stringify(i)," to number."))}return this.type.kind==="formatted"?kn.fromString(Do(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Cs.build(Do(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map((i=>i.evaluate(e))):Do(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if(this.type.kind==="formatted")return new Aa([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Zt(this.args[0]).serialize();const e=this.type.kind==="array"?[]:["to-".concat(this.type.kind)];return this.eachChild((i=>{e.push(i.serialize())})),e}}const Vc=["Unknown","Point","LineString","Polygon"];class qn{constructor(e,i,s){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i,this.iconImageUseTheme=s}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Vc[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Gi.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class gs{constructor(e,i,s,a,u){this.name=e,this.type=i,this._evaluate=s,this.args=a,this._overloadIndex=u}evaluate(e){if(!this._evaluate){const i=gs.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,i){const s=e[0],a=gs.definitions[s];if(!a)return i.error('Unknown expression "'.concat(s,'". If you wanted a literal array, use ["literal", [...]].'),0);const u=Array.isArray(a)?a[0]:a.type,h=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[];let _=null,g=-1;for(const[v,b]of h){if(Array.isArray(v)&&v.length!==e.length-1)continue;f.push(v),g++,_=new Yc(i.registry,i.path,null,i.scope,void 0,i._scope,i.options,i.iconImageUseTheme);const w=[];let I=!1;for(let A=1;A<e.length;A++){const R=e[A],L=Array.isArray(v)?v[A-1]:v.type,k=_.parse(R,1+w.length,L);if(!k){I=!0;break}w.push(k)}if(!I)if(Array.isArray(v)&&v.length!==w.length)_.error("Expected ".concat(v.length," arguments, but found ").concat(w.length," instead."));else{for(let A=0;A<w.length;A++){const R=Array.isArray(v)?v[A]:v.type,L=w[A];_.concat(A+1).checkSubtype(R,L.type)}if(_.errors.length===0)return new gs(s,u,b,w,g)}}if(f.length===1)i.errors.push(..._.errors);else{const v=(f.length?f:h.map((([w])=>w))).map(Ma).join(" | "),b=[];for(let w=1;w<e.length;w++){const I=i.parse(e[w],1+b.length);if(!I)return null;b.push(Tn(I.type))}i.error("Expected arguments of type ".concat(v,", but found (").concat(b.join(", "),") instead."))}return null}static register(e,i){gs.definitions=i;for(const s in i)e[s]=gs}}function Ma(r){return Array.isArray(r)?"(".concat(r.map(Tn).join(", "),")"):"(".concat(Tn(r.type),"...)")}class Qa{constructor(e,i,s){this.type=Yl,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");const a=s["case-sensitive"]===void 0?i.parse(!1,1,Vi):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",Vi);if(!a)return null;const u=s["diacritic-sensitive"]===void 0?i.parse(!1,1,Vi):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",Vi);if(!u)return null;let h=null;return s.locale&&(h=i.parseObjectValue(s.locale,1,"locale",Ci),!h)?null:new Qa(a,u,h)}evaluate(e){return new gh(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Ho(r,e,i=0,s=r.length-1,a=xm){for(;s>i;){if(s-i>600){const _=s-i+1,g=e-i+1,v=Math.log(_),b=.5*Math.exp(2*v/3),w=.5*Math.sqrt(v*b*(_-b)/_)*(g-_/2<0?-1:1);Ho(r,e,Math.max(i,Math.floor(e-g*b/_+w)),Math.min(s,Math.floor(e+(_-g)*b/_+w)),a)}const u=r[e];let h=i,f=s;for($n(r,i,e),a(r[s],u)>0&&$n(r,i,s);h<f;){for($n(r,h,f),h++,f--;a(r[h],u)<0;)h++;for(;a(r[f],u)>0;)f--}a(r[i],u)===0?$n(r,i,f):(f++,$n(r,f,s)),f<=e&&(i=f+1),e<=f&&(s=f-1)}}function $n(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function xm(r,e){return r<e?-1:r>e?1:0}function vm(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}function ic(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function na(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Sf(r,e,i){const s=r[0]-e[0],a=r[1]-e[1],u=r[0]-i[0],h=r[1]-i[1];return s*h-u*a==0&&s*u<=0&&a*h<=0}function mo(r,e,i=!1){let s=!1;for(let f=0,_=e.length;f<_;f++){const g=e[f];for(let v=0,b=g.length,w=b-1;v<b;w=v++){const I=g[w],A=g[v];if(Sf(r,I,A))return i;(u=I)[1]>(a=r)[1]!=(h=A)[1]>a[1]&&a[0]<(h[0]-u[0])*(a[1]-u[1])/(h[1]-u[1])+u[0]&&(s=!s)}}var a,u,h;return s}function Ef(r,e,i,s){const a=s[0]-i[0],u=s[1]-i[1],h=(r[0]-i[0])*u-a*(r[1]-i[1]),f=(e[0]-i[0])*u-a*(e[1]-i[1]);return h>0&&f<0||h<0&&f>0}function Uc(r,e,i,s){return(a=[s[0]-i[0],s[1]-i[1]])[0]*(u=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*u[0]!=0&&!(!Ef(r,e,i,s)||!Ef(i,s,r,e));var a,u}function rc(r){const e=new Be(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new Be(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y);return{min:e,max:i}}const sa=8192;function bm(r,e){const i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*sa),Math.round(s*a*sa)]}function If(r,e){for(let i=0;i<e.length;i++)if(mo(r,e[i]))return!0;return!1}function wm(r,e,i){for(const s of i)for(let a=0,u=s.length,h=u-1;a<u;h=a++)if(Uc(r,e,s[h],s[a]))return!0;return!1}function oa(r,e){for(let i=0;i<r.length;++i)if(!mo(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(wm(r[i],r[i+1],e))return!1;return!0}function Tm(r,e){for(let i=0;i<e.length;i++)if(oa(r,e[i]))return!0;return!1}function yh(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=[];for(let h=0;h<r[a].length;h++){const f=bm(r[a][h],i);ic(e,f),u.push(f)}s.push(u)}return s}function jc(r,e,i){const s=[];for(let a=0;a<r.length;a++){const u=yh(r[a],e,i);s.push(u)}return s}function xh(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){const a=.5*s;let u=r[0]-i[0]>a?-s:i[0]-r[0]>a?s:0;u===0&&(u=r[0]-i[2]>a?-s:i[2]-r[0]>a?s:0),r[0]+=u}ic(e,r)}function vh(r,e,i,s){const a=Math.pow(2,s.z)*sa,u=[s.x*sa,s.y*sa],h=[];if(!r)return h;for(const f of r)for(const _ of f){const g=[_.x+u[0],_.y+u[1]];xh(g,e,i,a),h.push(g)}return h}function _o(r,e,i,s){const a=Math.pow(2,s.z)*sa,u=[s.x*sa,s.y*sa],h=[];if(!r)return h;for(const _ of r){const g=[];for(const v of _){const b=[v.x+u[0],v.y+u[1]];ic(e,b),g.push(b)}h.push(g)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(const _ of h)for(const g of _)xh(g,e,i,a)}var f;return h}class Ca{constructor(e,i){this.type=Vi,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error("'within' expression requires exactly one argument, but found ".concat(e.length-1," instead."));if(Ka(e[1])){const s=e[1];if(s.type==="FeatureCollection")for(let a=0;a<s.features.length;++a){const u=s.features[a].geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new Ca(s,s.features[a].geometry)}else if(s.type==="Feature"){const a=s.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Ca(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Ca(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const f=yh(s.coordinates,u,h),_=vh(i.geometry(),a,u,h);if(!na(a,u))return!1;for(const g of _)if(!mo(g,f))return!1}if(s.type==="MultiPolygon"){const f=jc(s.coordinates,u,h),_=vh(i.geometry(),a,u,h);if(!na(a,u))return!1;for(const g of _)if(!If(g,f))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(i,s){const a=[1/0,1/0,-1/0,-1/0],u=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(s.type==="Polygon"){const f=yh(s.coordinates,u,h),_=_o(i.geometry(),a,u,h);if(!na(a,u))return!1;for(const g of _)if(!oa(g,f))return!1}if(s.type==="MultiPolygon"){const f=jc(s.coordinates,u,h),_=_o(i.geometry(),a,u,h);if(!na(a,u))return!1;for(const g of _)if(!Tm(g,f))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const nc={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},bh=1/298.257223563,wh=bh*(2-bh),el=Math.PI/180;class tl{static fromTile(e,i,s){const a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),u=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/el;return new tl(u,s)}static get units(){return nc}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!nc[i])throw new Error("Unknown unit ".concat(i,". Use one of: ").concat(Object.keys(nc).join(", ")));const s=6378.137*el*(i?nc[i]:1),a=Math.cos(e*el),u=1/(1-wh*(1-a*a)),h=Math.sqrt(u);this.kx=s*h*a,this.ky=s*h*u*(1-wh)}distance(e,i){const s=Zs(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+a*a)}bearing(e,i){const s=Zs(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/el}destination(e,i,s){const a=s*el;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){const a=e[s];for(let u=0,h=a.length,f=h-1;u<h;f=u++)i+=Zs(a[u][0]-a[f][0])*(a[u][1]+a[f][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){const u=e[a],h=e[a+1],f=this.distance(u,h);if(s+=f,s>i)return Gc(u,h,(i-(s-f))/f)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[a,u]=i,h=Zs(s[0]-a)*this.kx,f=(s[1]-u)*this.ky;if(h!==0||f!==0){const _=(Zs(e[0]-a)*this.kx*h+(e[1]-u)*this.ky*f)/(h*h+f*f);_>1?(a=s[0],u=s[1]):_>0&&(a+=h/this.kx*_,u+=f/this.ky*_)}return h=Zs(e[0]-a)*this.kx,f=(e[1]-u)*this.ky,Math.sqrt(h*h+f*f)}pointOnLine(e,i){let s=1/0,a=e[0][0],u=e[0][1],h=0,f=0;for(let _=0;_<e.length-1;_++){let g=e[_][0],v=e[_][1],b=Zs(e[_+1][0]-g)*this.kx,w=(e[_+1][1]-v)*this.ky,I=0;b===0&&w===0||(I=(Zs(i[0]-g)*this.kx*b+(i[1]-v)*this.ky*w)/(b*b+w*w),I>1?(g=e[_+1][0],v=e[_+1][1]):I>0&&(g+=b/this.kx*I,v+=w/this.ky*I)),b=Zs(i[0]-g)*this.kx,w=(i[1]-v)*this.ky;const A=b*b+w*w;A<s&&(s=A,a=g,u=v,h=_,f=I)}return{point:[a,u],index:h,t:Math.max(0,Math.min(1,f))}}lineSlice(e,i,s){let a=this.pointOnLine(s,e),u=this.pointOnLine(s,i);if(a.index>u.index||a.index===u.index&&a.t>u.t){const g=a;a=u,u=g}const h=[a.point],f=a.index+1,_=u.index;!Th(s[f],h[0])&&f<=_&&h.push(s[f]);for(let g=f+1;g<=_;g++)h.push(s[g]);return Th(s[_],u.point)||h.push(u.point),h}lineSliceAlong(e,i,s){let a=0;const u=[];for(let h=0;h<s.length-1;h++){const f=s[h],_=s[h+1],g=this.distance(f,_);if(a+=g,a>e&&u.length===0&&u.push(Gc(f,_,(e-(a-g))/g)),a>=i)return u.push(Gc(f,_,(i-(a-g))/g)),u;a>e&&u.push(_)}return u}bufferPoint(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[0]+a,e[1]+s]}bufferBBox(e,i){const s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[2]+a,e[3]+s]}insideBBox(e,i){return Zs(e[0]-i[0])>=0&&Zs(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function Th(r,e){return r[0]===e[0]&&r[1]===e[1]}function Gc(r,e,i){const s=Zs(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function Zs(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Hc{constructor(e=[],i=((s,a)=>s<a?-1:s>a?1:0)){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:s}=this,a=i[e];for(;e>0;){const u=e-1>>1,h=i[u];if(s(a,h)>=0)break;i[e]=h,e=u}i[e]=a}_down(e){const{data:i,compare:s}=this,a=this.length>>1,u=i[e];for(;e<a;){let h=1+(e<<1);const f=h+1;if(f<this.length&&s(i[f],i[h])<0&&(h=f),s(i[h],u)>=0)break;i[e]=i[h],e=h}i[e]=u}}var it=8192;function Sh(r,e){return e.dist-r.dist}const il=100,rl=50;function sc(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function oc(r){return r[1]-r[0]+1}function Lo(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function qc(r,e){if(r[0]>r[1])return[null,null];const i=oc(r);if(e){if(i===2)return[r,null];const s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(i===1)return[r,null];const s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function go(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!Lo(e,r.length))return i;for(let s=e[0];s<=e[1];++s)ic(i,r[s]);return i}function _i(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)ic(e,r[i][s]);return e}function nl(r,e,i){if(sc(r)||sc(e))return NaN;let s=0,a=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[s,a])}function Sm(r){return 360*r-180}function Em(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function $c(r,e){const i=Math.pow(2,e.z),s=(r.y/it+e.y)/i;return[Sm((r.x/it+e.x)/i),Em(s)]}function Im(r,e){const i=[];for(let s=0;s<r.length;++s)i.push($c(r[s],e));return i}function Nr(r,e,i){const s=i.pointOnLine(e,r).point;return i.distance(r,s)}function Af(r,e,i,s,a){const u=i.slice(s[0],s[1]+1);let h=1/0;for(let f=e[0];f<=e[1];++f)if((h=Math.min(h,Nr(r[f],u,a)))===0)return 0;return h}function Eh(r,e,i,s,a){const u=Math.min(a.pointToSegmentDistance(r,i,s),a.pointToSegmentDistance(e,i,s)),h=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(s,r,e));return Math.min(u,h)}function Am(r,e,i,s,a){if(!Lo(e,r.length)||!Lo(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<e[1];++h)for(let f=s[0];f<s[1];++f){if(Uc(r[h],r[h+1],i[f],i[f+1]))return 0;u=Math.min(u,Eh(r[h],r[h+1],i[f],i[f+1],a))}return u}function Mm(r,e,i,s,a){if(!Lo(e,r.length)||!Lo(s,i.length))return NaN;let u=1/0;for(let h=e[0];h<=e[1];++h)for(let f=s[0];f<=s[1];++f)if((u=Math.min(u,a.distance(r[h],i[f])))===0)return u;return u}function Cm(r,e,i){if(mo(r,e,!0))return 0;let s=1/0;for(const a of e){const u=a.length;if(u<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[u-1]&&(s=Math.min(s,i.pointToSegmentDistance(r,a[u-1],a[0])))===0||(s=Math.min(s,Nr(r,a,i)))===0)return s}return s}function Pm(r,e,i,s){if(!Lo(e,r.length))return NaN;for(let u=e[0];u<=e[1];++u)if(mo(r[u],i,!0))return 0;let a=1/0;for(let u=e[0];u<e[1];++u)for(const h of i)for(let f=0,_=h.length,g=_-1;f<_;g=f++){if(Uc(r[u],r[u+1],h[g],h[f]))return 0;a=Math.min(a,Eh(r[u],r[u+1],h[g],h[f],s))}return a}function Mf(r,e){for(const i of r)for(let s=0;s<=i.length-1;++s)if(mo(i[s],e,!0))return!0;return!1}function Rm(r,e,i,s=1/0){const a=_i(r),u=_i(e);if(s!==1/0&&nl(a,u,i)>=s)return s;if(na(a,u)){if(Mf(r,e))return 0}else if(Mf(e,r))return 0;let h=s;for(const f of r)for(let _=0,g=f.length,v=g-1;_<g;v=_++)for(const b of e)for(let w=0,I=b.length,A=I-1;w<I;A=w++){if(Uc(f[v],f[_],b[A],b[w]))return 0;h=Math.min(h,Eh(f[v],f[_],b[A],b[w],i))}return h}function Zc(r,e,i,s,a,u,h){if(u===null||h===null)return;const f=nl(go(s,u),go(a,h),i);f<e&&r.push({dist:f,range1:u,range2:h})}function Dm(r,e,i,s,a=1/0){let u=Math.min(s.distance(r[0],i[0][0]),a);if(u===0)return u;const h=new Hc([{dist:0,range1:[0,r.length-1],range2:[0,0]}],Sh),f=e?rl:il,_=_i(i);for(;h.length;){const g=h.pop();if(g.dist>=u)continue;const v=g.range1;if(oc(v)<=f){if(!Lo(v,r.length))return NaN;if(e){const b=Pm(r,v,i,s);if((u=Math.min(u,b))===0)return u}else for(let b=v[0];b<=v[1];++b){const w=Cm(r[b],i,s);if((u=Math.min(u,w))===0)return u}}else{const b=qc(v,e);if(b[0]!==null){const w=nl(go(r,b[0]),_,s);w<u&&h.push({dist:w,range1:b[0],range2:[0,0]})}if(b[1]!==null){const w=nl(go(r,b[1]),_,s);w<u&&h.push({dist:w,range1:b[1],range2:[0,0]})}}}return u}function Cf(r,e,i,s,a,u=1/0){let h=Math.min(u,a.distance(r[0],i[0]));if(h===0)return h;const f=new Hc([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],Sh),_=e?rl:il,g=s?rl:il;for(;f.length;){const v=f.pop();if(v.dist>=h)continue;const b=v.range1,w=v.range2;if(oc(b)<=_&&oc(w)<=g){if(!Lo(b,r.length)||!Lo(w,i.length))return NaN;if(e&&s?h=Math.min(h,Am(r,b,i,w,a)):e||s?e&&!s?h=Math.min(h,Af(i,w,r,b,a)):!e&&s&&(h=Math.min(h,Af(r,b,i,w,a))):h=Math.min(h,Mm(r,b,i,w,a)),h===0)return h}else{const I=qc(b,e),A=qc(w,s);Zc(f,h,a,r,i,I[0],A[0]),Zc(f,h,a,r,i,I[0],A[1]),Zc(f,h,a,r,i,I[1],A[0]),Zc(f,h,a,r,i,I[1],A[1])}}return h}function Ih(r,e,i,s,a=1/0){let u=a;const h=go(r,[0,r.length-1]);for(const f of i)if(!(u!==1/0&&nl(h,go(f,[0,f.length-1]),s)>=u)&&(u=Math.min(u,Cf(r,e,f,!0,s,u)),u===0))return u;return u}function Wc(r,e,i,s,a=1/0){let u=a;const h=go(r,[0,r.length-1]);for(const f of i){if(u!==1/0&&nl(h,_i(f),s)>=u)continue;const _=Dm(r,e,f,s,u);if(isNaN(_))return _;if((u=Math.min(u,_))===0)return u}return u}function Ah(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class Pa{constructor(e,i){this.type=At,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error("'distance' expression requires either one argument, but found ' ".concat(e.length-1," instead."));if(Ka(e[1])){const s=e[1];if(s.type==="FeatureCollection"){for(let a=0;a<s.features.length;++a)if(Ah(s.features[a].geometry.type))return new Pa(s,s.features[a].geometry)}else if(s.type==="Feature"){if(Ah(s.geometry.type))return new Pa(s,s.geometry)}else if(Ah(s.type))return new Pa(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return(function(a,u,h){const f=[];for(const g of a)for(const v of g)f.push($c(v,u));const _=new tl(f[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?Cf(f,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",_):h.type==="MultiLineString"?Ih(f,!1,h.coordinates,_):h.type==="Polygon"||h.type==="MultiPolygon"?Wc(f,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,_):null})(i,s,this.geometries);if(e.geometryType()==="LineString")return(function(a,u,h){const f=[];for(const g of a){const v=[];for(const b of g)v.push($c(b,u));f.push(v)}const _=new tl(f[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Ih(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,_);if(h.type==="MultiLineString"){let g=1/0;for(let v=0;v<h.coordinates.length;v++){const b=Ih(h.coordinates[v],!0,f,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}if(h.type==="Polygon"||h.type==="MultiPolygon"){let g=1/0;for(let v=0;v<f.length;v++){const b=Wc(f[v],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return null})(i,s,this.geometries);if(e.geometryType()==="Polygon")return(function(a,u,h){const f=[];for(const g of(function(v,b){const w=v.length;if(w<=1)return[v];const I=[];let A,R;for(let L=0;L<w;L++){const k=vm(v[L]);k!==0&&(v[L].area=Math.abs(k),R===void 0&&(R=k<0),R===k<0?(A&&I.push(A),A=[v[L]]):A.push(v[L]))}return A&&I.push(A),I})(a)){const v=[];for(let b=0;b<g.length;++b)v.push(Im(g[b],u));f.push(v)}const _=new tl(f[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Wc(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",f,_);if(h.type==="MultiLineString"){let g=1/0;for(let v=0;v<h.coordinates.length;v++){const b=Wc(h.coordinates[v],!0,f,_,g);if(isNaN(b))return b;if((g=Math.min(g,b))===0)return g}return g}return h.type==="Polygon"||h.type==="MultiPolygon"?(function(g,v,b){let w=1/0;for(const I of g)for(const A of v){const R=Rm(I,A,b,w);if(isNaN(R))return R;if((w=Math.min(w,R))===0)return w}return w})(h.type==="Polygon"?[h.coordinates]:h.coordinates,f,_):null})(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function sl(r){if(r instanceof gs&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Ca||r instanceof Pa)return!1;if(r instanceof al)return r.featureConstant;let e=!0;return r.eachChild((i=>{e&&!sl(i)&&(e=!1)})),e}function ac(r){if(r instanceof gs&&r.name==="feature-state")return!1;let e=!0;return r.eachChild((i=>{e&&!ac(i)&&(e=!1)})),e}function ol(r,e){if(r instanceof gs&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild((s=>{i&&!ol(s,e)&&(i=!1)})),i}function Pf(r,e,i){return[r,e,i].filter(Boolean).join("")}function Mh(r,e){switch(r){case"string":return Do(e);case"number":return+e;case"boolean":return!!e;case"color":return Gi.parse(e);case"formatted":return kn.fromString(Do(e));case"resolvedImage":return Cs.build(Do(e))}return e}function Rf(r,e,i,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class al{constructor(e,i,s,a=!1){this.type=e,this.key=i,this.scope=s,this.featureConstant=a}static parse(e,i){let s=i.expectedType;if(s==null&&(s=$i),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const a=i.parse(e[1],1);if(!(a instanceof Go))return i.error("Key name of 'config' expression must be a string literal.");let u,h=!0;const f=Do(a.value);if(e.length>=3){const _=i.parse(e[2],2);if(!(_ instanceof Go))return i.error("Scope of 'config' expression must be a string literal.");u=Do(_.value)}if(i.options){const _=Pf(f,u,i._scope),g=i.options.get(_);g&&(h=sl(g.value||g.default))}return new al(s,f,u,h)}evaluate(e){const i=Pf(this.key,this.scope,e.scope),s=e.getConfig(i);if(!s)return null;const{type:a,value:u,values:h,minValue:f,maxValue:_,stepValue:g}=s,v=s.default.evaluate(e);let b=v;if(u){const w=e.scope;e.scope=(w||"").split("").slice(1).join(""),b=u.evaluate(e),e.scope=w}return a&&(b=Mh(a,b)),b===void 0||f===void 0&&_===void 0&&g===void 0||(typeof b=="number"?b=Rf(b,f,_,g):Array.isArray(b)&&(b=b.map((w=>typeof w=="number"?Rf(w,f,_,g):w)))),u!==void 0&&b!==void 0&&h&&!h.includes(b)&&(b=v,a&&(b=Mh(a,b))),(a&&a!==this.type||b!==void 0&&!kc(Pn(b),this.type))&&(b=Mh(this.type.kind,b)),b}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Xc{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const s=e[1];return i.scope.has(s)?new Xc(s,i.scope.get(s)):i.error('Unknown variable "'.concat(s,'". Make sure "').concat(s,'" has been bound in an enclosing "let" expression before using it.'),1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Yc{constructor(e,i=[],s,a=new po,u=[],h,f,_){this.registry=e,this.path=i,this.key=i.map((g=>typeof g=="string"?"['".concat(g,"']"):"[".concat(g,"]"))).join(""),this.scope=a,this.errors=u,this.expectedType=s,this._scope=h,this.options=f,this.iconImageUseTheme=_}parse(e,i,s,a,u={}){return i||s?this.concat(i,null,s,a)._parse(e,u):this._parse(e,u)}parseObjectValue(e,i,s,a,u,h={}){return this.concat(i,s,a,u)._parse(e,h)}_parse(e,i){function s(a,u,h){return h==="assert"?new wt(u,[a]):h==="coerce"?new zo(u,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let u=a.parse(e,this);if(!u)return null;if(this.expectedType){const h=this.expectedType,f=u.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||f.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(h,f))return null}else u=s(u,h,i.typeAnnotation||"coerce");else u=s(u,h,i.typeAnnotation||"assert")}if(!(u instanceof Go)&&u.type.kind!=="resolvedImage"&&Ch(u)){const h=new qn(this._scope,this.options,this.iconImageUseTheme);try{u=new Go(u.type,u.evaluate(h))}catch(f){return this.error(f.message),null}}return u}return zo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':"Expected an array, but found ".concat(typeof e," instead."))}concat(e,i,s,a){let u=typeof e=="number"?this.path.concat(e):this.path;u=typeof i=="string"?u.concat(i):u;const h=a?this.scope.concat(a):this.scope;return new Yc(this.registry,u,s||null,h,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...i){const s="".concat(this.key).concat(i.map((a=>"[".concat(a,"]"))).join(""));this.errors.push(new fo(s,e))}checkSubtype(e,i){const s=Jl(e,i);return s&&this.error(s),s}}function Ch(r){if(r instanceof Xc)return Ch(r.boundExpression);if(r instanceof gs&&r.name==="error"||r instanceof Qa||r instanceof Ca||r instanceof Pa||r instanceof al)return!1;const e=r instanceof zo||r instanceof wt;let i=!0;return r.eachChild((s=>{i=e?i&&Ch(s):i&&s instanceof Go})),!!i&&sl(r)&&ol(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Kc(r,e){const i=r.length-1;let s,a,u=0,h=i,f=0;for(;u<=h;)if(f=Math.floor((u+h)/2),s=r[f],a=r[f+1],s<=e){if(f===i||e<a)return f;u=f+1}else{if(!(s>e))throw new on("Input is not a number.");h=f-1}return 0}class lc{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[a,u]of s)this.labels.push(a),this.outputs.push(u)}static parse(e,i){if(e.length-1<4)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const s=i.parse(e[1],1,At);if(!s)return null;const a=[];let u=null;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);for(let h=1;h<e.length;h+=2){const f=h===1?-1/0:e[h],_=e[h+1],g=h,v=h+1;if(typeof f!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',g);if(a.length&&a[a.length-1][0]>=f)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',g);const b=i.parse(_,v,u);if(!b)return null;u=u||b.type,a.push([f,b])}return new lc(u,s,a)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;return a>=i[u-1]?s[u-1].evaluate(e):s[Kc(i,a)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Df=.95047,zf=1.08883,Lf=4/29,ll=6/29,Jc=3*ll*ll,zm=ll*ll*ll,Of=Math.PI/180,Lm=180/Math.PI;function Ph(r){return r>zm?Math.pow(r,1/3):r/Jc+Lf}function Rh(r){return r>ll?r*r*r:Jc*(r-Lf)}function Qc(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function eu(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Ra(r){const e=eu(r.r),i=eu(r.g),s=eu(r.b),a=Ph((.4124564*e+.3575761*i+.1804375*s)/Df),u=Ph((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*u-16,a:500*(a-u),b:200*(u-Ph((.0193339*e+.119192*i+.9503041*s)/zf)),alpha:r.a}}function Dh(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Rh(e),i=Df*Rh(i),s=zf*Rh(s),new Gi(Qc(3.2404542*i-1.5371385*e-.4985314*s),Qc(-.969266*i+1.8760108*e+.041556*s),Qc(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function kf(r,e,i){const s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}const cc={forward:Ra,reverse:Dh,interpolate:function(r,e,i){return{l:Vt(r.l,e.l,i),a:Vt(r.a,e.a,i),b:Vt(r.b,e.b,i),alpha:Vt(r.alpha,e.alpha,i)}}},Da={forward:function(r){const{l:e,a:i,b:s}=Ra(r),a=Math.atan2(s,i)*Lm;return{h:a<0?a+360:a,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){const e=r.h*Of,i=r.c;return Dh({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:kf(r.h,e.h,i),c:Vt(r.c,e.c,i),l:Vt(r.l,e.l,i),alpha:Vt(r.alpha,e.alpha,i)}}};var tu=Object.freeze({__proto__:null,hcl:Da,lab:cc});class Ws{constructor(e,i,s,a,u){this.type=e,this.operator=i,this.interpolation=s,this.input=a,this.labels=[],this.outputs=[];for(const[h,f]of u)this.labels.push(h),this.outputs.push(f)}static interpolationFactor(e,i,s,a){let u=0;if(e.name==="exponential")u=zh(i,e.base,s,a);else if(e.name==="linear")u=zh(i,1,s,a);else if(e.name==="cubic-bezier"){const h=e.controlPoints;u=new bn(h[0],h[1],h[2],h[3]).solve(zh(i,1,s,a))}return u}static parse(e,i){let[s,a,u,...h]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const g=a[1];if(typeof g!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:g}}else{if(a[0]!=="cubic-bezier")return i.error("Unknown interpolation type ".concat(String(a[0])),1,0);{const g=a.slice(1);if(g.length!==4||g.some((v=>typeof v!="number"||v<0||v>1)))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:g}}}if(e.length-1<4)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(u=i.parse(u,2,At),!u)return null;const f=[];let _=null;s==="interpolate-hcl"||s==="interpolate-lab"?_=Bs:i.expectedType&&i.expectedType.kind!=="value"&&(_=i.expectedType);for(let g=0;g<h.length;g+=2){const v=h[g],b=h[g+1],w=g+3,I=g+4;if(typeof v!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(f.length&&f[f.length-1][0]>=v)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',w);const A=i.parse(b,I,_);if(!A)return null;_=_||A.type,f.push([v,A])}return _.kind==="number"||_.kind==="color"||_.kind==="array"&&_.itemType.kind==="number"&&typeof _.N=="number"?new Ws(_,s,a,u,f):i.error("Type ".concat(Tn(_)," is not interpolatable."))}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);const u=i.length;if(a>=i[u-1])return s[u-1].evaluate(e);const h=Kc(i,a),f=Ws.interpolationFactor(this.interpolation,a,i[h],i[h+1]),_=s[h].evaluate(e),g=s[h+1].evaluate(e);return this.operator==="interpolate"?Uo[this.type.kind.toLowerCase()](_,g,f):this.operator==="interpolate-hcl"?Da.reverse(Da.interpolate(Da.forward(_),Da.forward(g),f)):cc.reverse(cc.interpolate(cc.forward(_),cc.forward(g),f))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function zh(r,e,i,s){const a=s-i,u=r-i;return a===0?0:e===1?u/a:(Math.pow(e,u)-1)/(Math.pow(e,a)-1)}class uc{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null;const a=i.expectedType;a&&a.kind!=="value"&&(s=a);const u=[];for(const f of e.slice(1)){const _=i.parse(f,1+u.length,s,void 0,{typeAnnotation:"omit"});if(!_)return null;s=s||_.type,u.push(_)}const h=a&&u.some((f=>Jl(a,f.type)));return new uc(h?$i:s,u)}evaluate(e){let i,s=null,a=0;for(const u of this.args){if(a++,s=u.evaluate(e),s&&s instanceof Cs&&!s.available&&(i||(i=s),s=null,a===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class hc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error("Expected at least 3 arguments, but found ".concat(e.length-1," instead."));const s=[];for(let u=1;u<e.length-1;u+=2){const h=e[u];if(typeof h!="string")return i.error("Expected string, but found ".concat(typeof h," instead."),u);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",u);const f=i.parse(e[u+1],u+1);if(!f)return null;s.push([h,f])}const a=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return a?new hc(s,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class Lh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,At),a=i.parse(e[2],2,Hn(i.expectedType||$i));return s&&a?new Lh(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new on("Array index out of bounds: negative index");if(i>=s.length)throw new on("Array index out of bounds: index exceeds array size");if(i!==Math.floor(i))throw new on("Array index must be an integer. Use at-interpolated for fractional indices");return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Oh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,At),a=i.parse(e[2],2,Hn(i.expectedType||$i));return s&&a?new Oh(a.type.itemType,s,a):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new on("Array index out of bounds: ".concat(i," < 0."));if(i>s.length-1)throw new on("Array index out of bounds: ".concat(i," > ").concat(s.length-1,"."));if(i===Math.floor(i))return s[i];const a=Math.floor(i),u=Math.ceil(i),h=s[a],f=s[u];if(typeof h!="number"||typeof f!="number")throw new on("Cannot interpolate between non-number values at index ".concat(i,"."));const _=i-a;return h*(1-_)+f*_}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class kh{constructor(e,i){this.type=Vi,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,$i),a=i.parse(e[2],2,$i);return s&&a?_h(s.type,[Vi,Ci,At,Xa,$i])?new kh(s,a):i.error("Expected first argument to be of type boolean, string, number or null, but found ".concat(Tn(s.type)," instead")):null}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Ql(i,["boolean","string","number","null"]))throw new on("Expected first argument to be of type boolean, string, number or null, but found ".concat(Tn(Pn(i))," instead."));if(!Ql(s,["string","array"]))throw new on("Expected second argument to be of type array or string, but found ".concat(Tn(Pn(s))," instead."));return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class dc{constructor(e,i,s){this.type=At,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error("Expected 3 or 4 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,$i),a=i.parse(e[2],2,$i);if(!s||!a)return null;if(!_h(s.type,[Vi,Ci,At,Xa,$i]))return i.error("Expected first argument to be of type boolean, string, number or null, but found ".concat(Tn(s.type)," instead"));if(e.length===4){const u=i.parse(e[3],3,At);return u?new dc(s,a,u):null}return new dc(s,a)}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Ql(i,["boolean","string","number","null"]))throw new on("Expected first argument to be of type boolean, string, number or null, but found ".concat(Tn(Pn(i))," instead."));if(!Ql(s,["string","array"]))throw new on("Expected second argument to be of type array or string, but found ".concat(Tn(Pn(s))," instead."));if(this.fromIndex){const a=this.fromIndex.evaluate(e);return s.indexOf(i,a)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class iu{constructor(e,i,s,a,u,h){this.inputType=e,this.type=i,this.input=s,this.cases=a,this.outputs=u,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error("Expected at least 4 arguments, but found only ".concat(e.length-1,"."));if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);const u={},h=[];for(let g=2;g<e.length-1;g+=2){let v=e[g];const b=e[g+1];Array.isArray(v)||(v=[v]);const w=i.concat(g);if(v.length===0)return w.error("Expected at least one branch label.");for(const A of v){if(typeof A!="number"&&typeof A!="string")return w.error("Branch labels must be numbers or strings.");if(typeof A=="number"&&Math.abs(A)>Number.MAX_SAFE_INTEGER)return w.error("Branch labels must be integers no larger than ".concat(Number.MAX_SAFE_INTEGER,"."));if(typeof A=="number"&&Math.floor(A)!==A)return w.error("Numeric branch labels must be integer values.");if(s){if(w.checkSubtype(s,Pn(A)))return null}else s=Pn(A);if(u[String(A)]!==void 0)return w.error("Branch labels must be unique.");u[String(A)]=h.length}const I=i.parse(b,g,a);if(!I)return null;a=a||I.type,h.push(I)}const f=i.parse(e[1],1,$i);if(!f)return null;const _=i.parse(e[e.length-1],e.length-1,a);return _?f.type.kind!=="value"&&i.concat(1).checkSubtype(s,f.type)?null:new iu(s,a,f,u,h,_):null}evaluate(e){const i=this.input.evaluate(e);return(kc(Pn(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],a={};for(const h of i){const f=a[this.cases[h]];f===void 0?(a[this.cases[h]]=s.length,s.push([this.cases[h],[h]])):s[f][1].push(h)}const u=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,f]of s)e.push(f.length===1?u(f[0]):f.map(u)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class cl{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error("Expected at least 3 arguments, but found only ".concat(e.length-1,"."));if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);const a=[];for(let h=1;h<e.length-1;h+=2){const f=i.parse(e[h],h,Vi);if(!f)return null;const _=i.parse(e[h+1],h+1,s);if(!_)return null;a.push([f,_]),s=s||_.type}const u=i.parse(e[e.length-1],e.length-1,s);return u?new cl(s,a,u):null}evaluate(e){for(const[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every((([e,i])=>i.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class ru{constructor(e,i,s,a){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error("Expected 3 or 4 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,$i),a=i.parse(e[2],2,At);if(!s||!a)return null;if(!_h(s.type,[Hn($i),Ci,$i]))return i.error("Expected first argument to be of type array or string, but found ".concat(Tn(s.type)," instead"));if(e.length===4){const u=i.parse(e[3],3,At);return u?new ru(s.type,s,a,u):null}return new ru(s.type,s,a)}evaluate(e){const i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Ql(i,["string","array"]))throw new on("Expected first argument to be of type array or string, but found ".concat(Tn(Pn(i))," instead."));if(this.endIndex){const a=this.endIndex.evaluate(e);return i.slice(s,a)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class nu{constructor(e,i){this.type=Hn(Ci),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error("Expected 2 arguments, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1,Ci),a=i.parse(e[2],2,Ci);return s&&a?new nu(s,a):void 0}evaluate(e){const i=this.str.evaluate(e),s=this.delimiter.evaluate(e);return i.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Ff(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Bf(r,e,i,s){return s.compare(e,i)===0}function ul(r,e,i){const s=r!=="=="&&r!=="!=";return class pb{constructor(u,h,f){this.type=Vi,this.lhs=u,this.rhs=h,this.collator=f,this.hasUntypedArgument=u.type.kind==="value"||h.type.kind==="value"}static parse(u,h){if(u.length!==3&&u.length!==4)return h.error("Expected two or three arguments.");const f=u[0];let _=h.parse(u[1],1,$i);if(!_)return null;if(!Ff(f,_.type))return h.concat(1).error('"'.concat(f,"\" comparisons are not supported for type '").concat(Tn(_.type),"'."));let g=h.parse(u[2],2,$i);if(!g)return null;if(!Ff(f,g.type))return h.concat(2).error('"'.concat(f,"\" comparisons are not supported for type '").concat(Tn(g.type),"'."));if(_.type.kind!==g.type.kind&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error("Cannot compare types '".concat(Tn(_.type),"' and '").concat(Tn(g.type),"'."));s&&(_.type.kind==="value"&&g.type.kind!=="value"?_=new wt(g.type,[_]):_.type.kind!=="value"&&g.type.kind==="value"&&(g=new wt(_.type,[g])));let v=null;if(u.length===4){if(_.type.kind!=="string"&&g.type.kind!=="string"&&_.type.kind!=="value"&&g.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(v=h.parse(u[3],3,Yl),!v)return null}return new pb(_,g,v)}evaluate(u){const h=this.lhs.evaluate(u),f=this.rhs.evaluate(u);if(s&&this.hasUntypedArgument){const _=Pn(h),g=Pn(f);if(_.kind!==g.kind||_.kind!=="string"&&_.kind!=="number")throw new on('Expected arguments for "'.concat(r,'" to be (string, string) or (number, number), but found (').concat(_.kind,", ").concat(g.kind,") instead."))}if(this.collator&&!s&&this.hasUntypedArgument){const _=Pn(h),g=Pn(f);if(_.kind!=="string"||g.kind!=="string")return e(u,h,f)}return this.collator?i(u,h,f,this.collator.evaluate(u)):e(u,h,f)}eachChild(u){u(this.lhs),u(this.rhs),this.collator&&u(this.collator)}outputDefined(){return!0}serialize(){const u=[r];return this.eachChild((h=>{u.push(h.serialize())})),u}}}const Nf=ul("==",(function(r,e,i){return e===i}),Bf),Vf=ul("!=",(function(r,e,i){return e!==i}),(function(r,e,i,s){return!Bf(0,e,i,s)})),Om=ul("<",(function(r,e,i){return e<i}),(function(r,e,i,s){return s.compare(e,i)<0})),km=ul(">",(function(r,e,i){return e>i}),(function(r,e,i,s){return s.compare(e,i)>0})),Fm=ul("<=",(function(r,e,i){return e<=i}),(function(r,e,i,s){return s.compare(e,i)<=0})),su=ul(">=",(function(r,e,i){return e>=i}),(function(r,e,i,s){return s.compare(e,i)>=0}));class Fh{constructor(e,i,s,a,u,h){this.type=Ci,this.number=e,this.locale=i,this.currency=s,this.unit=a,this.minFractionDigits=u,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const s=i.parse(e[1],1,At);if(!s)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let u=null;if(a.locale&&(u=i.parseObjectValue(a.locale,2,"locale",Ci),!u))return null;let h=null;if(a.currency&&(h=i.parseObjectValue(a.currency,2,"currency",Ci),!h))return null;let f=null;if(a.unit&&(f=i.parseObjectValue(a.unit,2,"unit",Ci),!f))return null;let _=null;if(a["min-fraction-digits"]&&(_=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",At),!_))return null;let g=null;return a["max-fraction-digits"]&&(g=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",At),!g)?null:new Fh(s,u,h,f,_,g)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Bh{constructor(e){this.type=At,this.input=e}static parse(e,i){if(e.length!==2)return i.error("Expected 1 argument, but found ".concat(e.length-1," instead."));const s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error("Expected argument of type string or array, but found ".concat(Tn(s.type)," instead.")):new Bh(s):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new on("Expected value to be of type string or array, but found ".concat(Tn(Pn(i))," instead."))}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((i=>{e.push(i.serialize())})),e}}function Uf(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const hl={"==":Nf,"!=":Vf,">":km,"<":Om,">=":su,"<=":Fm,array:wt,at:Lh,"at-interpolated":Oh,boolean:wt,case:cl,coalesce:uc,collator:Qa,format:Aa,image:Zt,in:kh,"index-of":dc,interpolate:Ws,"interpolate-hcl":Ws,"interpolate-lab":Ws,length:Bh,let:hc,literal:Go,match:iu,number:wt,"number-format":Fh,object:wt,slice:ru,step:lc,string:wt,"to-boolean":zo,"to-color":zo,"to-number":zo,"to-string":zo,var:Xc,within:Ca,distance:Pa,config:al,split:nu};function Nh(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=Fc(e,i,s,u);if(h)throw new on(h);return new Gi(e/255,i/255,s/255,u)}function jf(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const u=a?a.evaluate(r):1,h=(function(g,v,b,w){return typeof g=="number"&&g>=0&&g<=360?typeof v=="number"&&v>=0&&v<=100&&typeof b=="number"&&b>=0&&b<=100?w===void 0||typeof w=="number"&&w>=0&&w<=1?null:"Invalid hsla value [".concat([g,v,b,w].join(", "),"]: 'a' must be between 0 and 1."):"Invalid hsla value [".concat((typeof w=="number"?[g,v,b,w]:[g,v,b]).join(", "),"]: 's', and 'l' must be between 0 and 100."):"Invalid hsla value [".concat((typeof w=="number"?[g,v,b,w]:[g,v,b]).join(", "),"]: 'h' must be between 0 and 360.")})(e,i,s,u);if(h)throw new on(h);const f="hsla(".concat(e,", ").concat(i,"%, ").concat(s,"%, ").concat(u,")"),_=Gi.parse(f);if(!_)throw new on("Failed to parse HSLA color: ".concat(f));return _}function Gf(r,e){return r in e}function ou(r,e){const i=e[r];return i===void 0?null:i}function qo(r){return{type:r}}function fc(r){if(r instanceof al)return new Set([r.key]);let e=new Set;return r.eachChild((i=>{e=new Set([...e,...fc(i)])})),e}function au(r){if(r instanceof gs&&r.name==="is-active-floor")return!0;let e=!1;return r.eachChild((i=>{!e&&au(i)&&(e=!0)})),e}function za(r){return{result:"success",value:r}}function aa(r){return{result:"error",value:r}}function Vh(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function lu(r){return r["property-type"]==="data-driven"}function Uh(r){return Vh(r.expression,"measure-light")}function jh(r){return Vh(r.expression,"zoom")}function cu(r){return!!r.expression&&r.expression.interpolated}function uu(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function Gh(r){return r}function hu(r,e){const i=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",a=s||!(s||r.property!==void 0),u=r.type||(cu(e)?"exponential":"interval");if(i&&((r=Object.assign({},r)).stops&&(r.stops=r.stops.map((g=>[g[0],Gi.parse(g[1])]))),r.default=Gi.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!tu[r.colorSpace])throw new Error("Unknown color space: ".concat(r.colorSpace));let h,f,_;if(u==="exponential")h=Hf;else if(u==="interval")h=la;else if(u==="categorical"){h=Bm,f=Object.create(null);for(const g of r.stops)f[g[0]]=g[1];_=typeof r.stops[0][0]}else{if(u!=="identity")throw new Error('Unknown function type "'.concat(u,'"'));h=Nm}if(s){const g={},v=[];for(let I=0;I<r.stops.length;I++){const A=r.stops[I],R=A[0].zoom;g[R]===void 0&&(g[R]={zoom:R,type:r.type,property:r.property,default:r.default,stops:[]},v.push(R)),g[R].stops.push([A[0].value,A[1]])}const b=[];for(const I of v)b.push([g[I].zoom,hu(g[I],e)]);const w={name:"linear"};return{kind:"composite",interpolationType:w,interpolationFactor:Ws.interpolationFactor.bind(void 0,w),zoomStops:b.map((I=>I[0])),evaluate:({zoom:I},A)=>Hf({stops:b,base:r.base},e,I).evaluate(I,A)}}if(a){const g=u==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:g,interpolationFactor:Ws.interpolationFactor.bind(void 0,g),zoomStops:r.stops.map((v=>v[0])),evaluate:({zoom:v})=>h(r,e,v,f,_)}}return{kind:"source",evaluate(g,v){const b=v&&v.properties?v.properties[r.property]:void 0;return b===void 0?dl(r.default,e.default):h(r,e,b,f,_)}}}function dl(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function Bm(r,e,i,s,a){return dl(typeof i===a?s[i]:void 0,r.default,e.default)}function la(r,e,i){if(!tc(i))return dl(r.default,e.default);const s=r.stops.length;if(s===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];const a=Kc(r.stops.map((u=>u[0])),i);return r.stops[a][1]}function Hf(r,e,i){const s=r.base!==void 0?r.base:1;if(!tc(i))return dl(r.default,e.default);const a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];const u=Kc(r.stops.map((v=>v[0])),i),h=(function(v,b,w,I){const A=I-w,R=v-w;return A===0?0:b===1?R/A:(Math.pow(b,R)-1)/(Math.pow(b,A)-1)})(i,s,r.stops[u][0],r.stops[u+1][0]),f=r.stops[u][1],_=r.stops[u+1][1];let g=Uo[e.type]||Gh;if(r.colorSpace&&r.colorSpace!=="rgb"){const v=tu[r.colorSpace];g=(b,w)=>v.reverse(v.interpolate(v.forward(b),v.forward(w),h))}return typeof f.evaluate=="function"?{evaluate(...v){const b=f.evaluate.apply(void 0,v),w=_.evaluate.apply(void 0,v);if(b!==void 0&&w!==void 0)return g(b,w,h)}}:g(f,_,h)}function Nm(r,e,i){return e.type==="color"?i=Gi.parse(i):e.type==="formatted"?i=kn.fromString(i.toString()):e.type==="resolvedImage"?i=Cs.build(i.toString()):Ja(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),dl(i,r.default,e.default)}gs.register(hl,{error:[{kind:"error"},[Ci],(r,[e])=>{throw new on(e.evaluate(r))}],typeof:[Ci,[$i],(r,[e])=>Tn(Pn(e.evaluate(r)))],"to-rgba":[Hn(At,4),[Bs],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Hn(At,4),[Bs],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Bs,[At,At,At],Nh],rgba:[Bs,[At,At,At,At],Nh],hsl:[Bs,[At,At,At],jf],hsla:[Bs,[At,At,At,At],jf],has:{type:Vi,overloads:[[[Ci],(r,[e])=>Gf(e.evaluate(r),r.properties())],[[Ci,Ya],(r,[e,i])=>Gf(e.evaluate(r),i.evaluate(r))]]},get:{type:$i,overloads:[[[Ci],(r,[e])=>ou(e.evaluate(r),r.properties())],[[Ci,Ya],(r,[e,i])=>ou(e.evaluate(r),i.evaluate(r))]]},"feature-state":[$i,[Ci],(r,[e])=>ou(e.evaluate(r),r.featureState||{})],properties:[Ya,[],r=>r.properties()],"geometry-type":[Ci,[],r=>r.geometryType()],worldview:[Ci,[],r=>r.globals.worldview||""],"is-active-floor":[Vi,qo(Ci),(r,e)=>{if(!(r.globals.activeFloors&&r.globals.activeFloors.size>0))return!1;const i=r.globals.activeFloors;return e.some((s=>{const a=s.evaluate(r);return i.has(a)}))}],id:[$i,[],r=>r.id()],zoom:[At,[],r=>r.globals.zoom],pitch:[At,[],r=>r.globals.pitch||0],"distance-from-center":[At,[],r=>r.distanceFromCenter()],"measure-light":[At,[Ci],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[At,[],r=>r.globals.heatmapDensity||0],"line-progress":[At,[],r=>r.globals.lineProgress||0],"raster-value":[At,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[At,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[At,[],r=>r.globals.skyRadialProgress||0],accumulated:[$i,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[At,qo(At),(r,e)=>{let i=0;for(const s of e)i+=s.evaluate(r);return i}],"*":[At,qo(At),(r,e)=>{let i=1;for(const s of e)i*=s.evaluate(r);return i}],"-":{type:At,overloads:[[[At,At],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[At],(r,[e])=>-e.evaluate(r)]]},"/":[At,[At,At],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[At,[At,At],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[At,[],()=>Math.LN2],pi:[At,[],()=>Math.PI],e:[At,[],()=>Math.E],"^":[At,[At,At],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[At,[At],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[At,[At],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[At,[At],(r,[e])=>Math.log(e.evaluate(r))],log2:[At,[At],(r,[e])=>Math.log2(e.evaluate(r))],sin:[At,[At],(r,[e])=>Math.sin(e.evaluate(r))],cos:[At,[At],(r,[e])=>Math.cos(e.evaluate(r))],tan:[At,[At],(r,[e])=>Math.tan(e.evaluate(r))],asin:[At,[At],(r,[e])=>Math.asin(e.evaluate(r))],acos:[At,[At],(r,[e])=>Math.acos(e.evaluate(r))],atan:[At,[At],(r,[e])=>Math.atan(e.evaluate(r))],min:[At,qo(At),(r,e)=>Math.min(...e.map((i=>i.evaluate(r))))],max:[At,qo(At),(r,e)=>Math.max(...e.map((i=>i.evaluate(r))))],abs:[At,[At],(r,[e])=>Math.abs(e.evaluate(r))],round:[At,[At],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[At,[At],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[At,[At],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Vi,[Ci,$i],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[Vi,[$i],(r,[e])=>r.id()===e.value],"filter-type-==":[Vi,[Ci],(r,[e])=>r.geometryType()===e.value],"filter-<":[Vi,[Ci,$i],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<a}],"filter-id-<":[Vi,[$i],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[Vi,[Ci,$i],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>a}],"filter-id->":[Vi,[$i],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[Vi,[Ci,$i],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<=a}],"filter-id-<=":[Vi,[$i],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[Vi,[Ci,$i],(r,[e,i])=>{const s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>=a}],"filter-id->=":[Vi,[$i],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[Vi,[$i],(r,[e])=>e.value in r.properties()],"filter-has-id":[Vi,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Vi,[Hn(Ci)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Vi,[Hn($i)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Vi,[Ci,Hn($i)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Vi,[Ci,Hn($i)],(r,[e,i])=>(function(s,a,u,h){for(;u<=h;){const f=u+h>>1;if(a[f]===s)return!0;a[f]>s?h=f-1:u=f+1}return!1})(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Vi,overloads:[[[Vi,Vi],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[qo(Vi),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:Vi,overloads:[[[Vi,Vi],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[qo(Vi),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[Vi,[Vi],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Vi,[Ci],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Ci,[Ci],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Ci,[Ci],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Ci,qo($i),(r,e)=>e.map((i=>Do(i.evaluate(r)))).join("")],"resolved-locale":[Ci,[Yl],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[At,[At,At,$i],(r,e)=>{const[i,s,a]=e.map((h=>h.evaluate(r)));if(i>s||i===s)return i;let u;if(typeof a=="string")u=(function(h){let f=0;if(h.length===0)return f;for(let _=0;_<h.length;_++)f=(f<<5)-f+h.charCodeAt(_),f|=0;return f})(a);else{if(typeof a!="number")throw new on("Invalid seed input: ".concat(a));u=a}return i+Uf(u)()*(s-i)}]});class du{constructor(e,i,s,a,u){this.expression=e,this._warningHistory={},this._scope=s,this._options=a,this._iconImageUseTheme=u,this._evaluator=new qn(s,a,u),this._defaultValue=i?(function(h){return h.type==="color"&&(uu(h.default)||Array.isArray(h.default))?new Gi(0,0,0,0):h.type==="color"?Gi.parse(h.default)||null:h.default===void 0?null:h.default})(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=fc(e),this.isIndoorDependent=au(e)}evaluateWithoutErrorHandling(e,i,s,a,u,h,f,_){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=_||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,a,u,h,f,_,g){this._evaluator||(this._evaluator=new qn(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=u||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=_||null,this._evaluator.iconImageUseTheme=g||null;try{const v=this.expression.evaluate(this._evaluator);if(v==null||typeof v=="number"&&v!=v)return this._defaultValue;if(this._enumValues&&!(v in this._enumValues))throw new on("Expected value to be one of ".concat(Object.keys(this._enumValues).map((b=>JSON.stringify(b))).join(", "),", but found ").concat(JSON.stringify(v)," instead."));return v}catch(v){return this._warningHistory[v.message]||(this._warningHistory[v.message]=!0,typeof console<"u"&&console.warn('Failed to evaluate expression "'.concat(JSON.stringify(this.expression.serialize()),'". ').concat(v.message))),this._defaultValue}}}function fu(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in hl}function Oo(r,e,i,s,a){const u=new Yc(hl,[],e?(function(f){const _={color:Bs,string:Ci,number:At,enum:Ci,boolean:Vi,formatted:Ia,resolvedImage:Kl};return f.type==="array"?Hn(_[f.value]||$i,f.length):_[f.type]})(e):void 0,void 0,void 0,i,s,a),h=u.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?za(new du(h,e,i,s,a)):aa(u.errors)}class pc{constructor(e,i,s,a){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!ac(i.expression),this.configDependencies=fc(i.expression),this.isIndoorDependent=au(i.expression)}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h,f){return this._styleExpression.evaluate(e,i,s,a,u,h,void 0,void 0,f)}}class ca{constructor(e,i,s,a,u,h){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!ac(i.expression),this.isIndoorDependent=au(i.expression),this.isLightConstant=u,this.isLineProgressConstant=h,this.configDependencies=fc(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,s,a,u,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,u,h)}evaluate(e,i,s,a,u,h){return this._styleExpression.evaluate(e,i,s,a,u,h)}interpolationFactor(e,i,s){return this.interpolationType?Ws.interpolationFactor(this.interpolationType,e,i,s):0}}function Hh(r,e,i,s,a){if((r=Oo(r,e,i,s,a)).result==="error")return r;const u=r.value.expression,h=sl(u);if(!h&&!lu(e))return aa([new fo("","data expressions not supported")]);const f=ol(u,["zoom","pitch","distance-from-center"]);if(!f&&!jh(e))return aa([new fo("","zoom expressions not supported")]);const _=ol(u,["measure-light"]);if(!_&&!Uh(e))return aa([new fo("","measure-light expression not supported")]);const g=ol(u,["line-progress"]);if(!g&&!(function(w){return Vh(w.expression,"line-progress")})(e))return aa([new fo("","line-progress expression not supported")]);const v=e.expression&&e.expression.relaxZoomRestriction,b=mu(u);return b||f||v?b instanceof fo?aa([b]):b instanceof Ws&&!cu(e)?aa([new fo("",'"interpolate" expressions cannot be used with this property')]):za(b?new ca(h&&g?"camera":"composite",r.value,b.labels,b instanceof Ws?b.interpolation:void 0,_,g):new pc(h&&g?"constant":"source",r.value,_,g)):aa([new fo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class pu{constructor(e,i){this._parameters=e,this._specification=i,Object.assign(this,hu(this._parameters,this._specification))}static deserialize(e){return new pu(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function mu(r){let e=null;if(r instanceof hc)e=mu(r.result);else if(r instanceof uc){for(const i of r.args)if(e=mu(i),e)break}else(r instanceof lc||r instanceof Ws)&&r.input instanceof gs&&r.input.name==="zoom"&&(e=r);return e instanceof fo||r.eachChild((i=>{const s=mu(i);s instanceof fo?e=s:e&&s&&e!==s&&(e=new fo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}var mc,_u,qf=(function(){if(_u)return mc;_u=1,mc=e;var r=3;function e(i,s,a){var u=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(s=h[1])+2*(a=h[2]);for(var f=0;f<this.d*this.d;f++){var _=h[r+f],g=h[r+f+1];u.push(_===g?null:h.subarray(_,g))}var v=h[r+u.length+1];this.keys=h.subarray(h[r+u.length],v),this.bboxes=h.subarray(v),this.insert=this._insertReadonly}else{this.d=s+2*a;for(var b=0;b<this.d*this.d;b++)u.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=a,this.scale=s/i,this.uid=0;var w=a/s*i;this.min=-w,this.max=i+w}return e.prototype.insert=function(i,s,a,u,h){this._forEachCell(s,a,u,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,a,u,h,f){this.cells[h].push(f)},e.prototype.query=function(i,s,a,u,h){var f=this.min,_=this.max;if(i<=f&&s<=f&&_<=a&&_<=u&&!h)return Array.prototype.slice.call(this.keys);var g=[];return this._forEachCell(i,s,a,u,this._queryCell,g,{},h),g},e.prototype._queryCell=function(i,s,a,u,h,f,_,g){var v=this.cells[h];if(v!==null)for(var b=this.keys,w=this.bboxes,I=0;I<v.length;I++){var A=v[I];if(_[A]===void 0){var R=4*A;(g?g(w[R+0],w[R+1],w[R+2],w[R+3]):i<=w[R+2]&&s<=w[R+3]&&a>=w[R+0]&&u>=w[R+1])?(_[A]=!0,f.push(b[A])):_[A]=!1}}},e.prototype._forEachCell=function(i,s,a,u,h,f,_,g){for(var v=this._convertToCellCoord(i),b=this._convertToCellCoord(s),w=this._convertToCellCoord(a),I=this._convertToCellCoord(u),A=v;A<=w;A++)for(var R=b;R<=I;R++){var L=this.d*R+A;if((!g||g(this._convertFromCellCoord(A),this._convertFromCellCoord(R),this._convertFromCellCoord(A+1),this._convertFromCellCoord(R+1)))&&h.call(this,i,s,a,u,L,f,_,g))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,a=0,u=0;u<this.cells.length;u++)a+=this.cells[u].length;var h=new Int32Array(s+a+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var f=s,_=0;_<i.length;_++){var g=i[_];h[r+_]=f,h.set(g,f),f+=g.length}return h[r+i.length]=f,h.set(this.keys,f),h[r+i.length+1]=f+=this.keys.length,h.set(this.bboxes,f),f+=this.bboxes.length,h.buffer},mc})(),La=Qn(qf);const fl={};function mt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),fl[e]={klass:r,omit:i.omit||[]}}mt(Object,"Object"),La.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},La.deserialize=function(r){return new La(r.buffer)},Object.defineProperty(La,"name",{value:"Grid"}),mt(La,"Grid"),delete Be.prototype.constructor,typeof DOMMatrix<"u"&&mt(DOMMatrix,"DOMMatrix"),mt(Gi,"Color"),mt(Error,"Error"),mt(kn,"Formatted"),mt(ec,"FormattedSection"),mt(Sa,"AJAXError"),mt(Cs,"ResolvedImage"),mt(pu,"StylePropertyFunction"),mt(du,"StyleExpression",{omit:["_evaluator"]}),mt(An,"ImageId"),mt(jo,"ImageVariant"),mt(ca,"ZoomDependentExpression"),mt(pc,"ZoomConstantExpression"),mt(gs,"CompoundExpression",{omit:["_evaluate"]});for(const r in hl)fl[hl[r]._classRegistryKey]||mt(hl[r],"Expression".concat(r));function qh(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function $o(r){return self.ImageBitmap&&r instanceof ImageBitmap}function ua(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(qh(r)||$o(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const s of r)i.push(ua(s,e));return i}if(r instanceof Map){const i={$name:"Map",entries:[]};for(const[s,a]of r.entries())i.entries.push(ua(s),ua(a,e));return i}if(r instanceof Set){const i={$name:"Set"};let s=0;for(const a of r.values())i[++s]=ua(a);return i}if(r instanceof DOMMatrix){const i={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const a of s)i[a]=r[a];return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){const i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error("Can't serialize object of unregistered class \"".concat(i.name,'".'));const a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const u in r)r.hasOwnProperty(u)&&(fl[s].omit.indexOf(u)>=0||(a[u]=ua(r[u],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(a.$name=s),a}throw new Error("can't serialize object of type "+typeof r)}function ha(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||qh(r)||$o(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(ha);if(typeof r=="object"){const e=r.$name||"Object";if(e==="Map"){const a=r.entries||[],u=new Map;for(let h=0;h<a.length;h+=2)u.set(ha(a[h]),ha(a[h+1]));return u}if(e==="Set"){const a=new Set;for(const u of Object.keys(r))u!=="$name"&&a.add(ha(r[u]));return a}if(e==="DOMMatrix"){let a;return a=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(r.value);const{klass:i}=fl[e];if(!i)throw new Error("Can't deserialize unregistered class \"".concat(e,'".'));if(i.deserialize)return i.deserialize(r);const s=Object.create(i.prototype);for(const a of Object.keys(r))a!=="$name"&&(s[a]=ha(r[a]));return s}throw new Error("can't deserialize object of type "+typeof r)}const Dt={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function $h(r){for(const e of r)if(yu(e.charCodeAt(0)))return!0;return!1}function $f(r){for(const e of r)if(!gu(e.charCodeAt(0)))return!1;return!0}function gu(r){return!(Dt.Arabic(r)||Dt["Arabic Supplement"](r)||Dt["Arabic Extended-A"](r)||Dt["Arabic Presentation Forms-A"](r)||Dt["Arabic Presentation Forms-B"](r))}function yu(r){return!(r!==746&&r!==747&&(r<4352||!(Dt["Bopomofo Extended"](r)||Dt.Bopomofo(r)||Dt["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Dt["CJK Compatibility Ideographs"](r)||Dt["CJK Compatibility"](r)||Dt["CJK Radicals Supplement"](r)||Dt["CJK Strokes"](r)||!(!Dt["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Dt["CJK Unified Ideographs Extension A"](r)||Dt["CJK Unified Ideographs"](r)||Dt["Enclosed CJK Letters and Months"](r)||Dt["Hangul Compatibility Jamo"](r)||Dt["Hangul Jamo Extended-A"](r)||Dt["Hangul Jamo Extended-B"](r)||Dt["Hangul Jamo"](r)||Dt["Hangul Syllables"](r)||Dt.Hiragana(r)||Dt["Ideographic Description Characters"](r)||Dt.Kanbun(r)||Dt["Kangxi Radicals"](r)||Dt["Katakana Phonetic Extensions"](r)||Dt.Katakana(r)&&r!==12540||!(!Dt["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Dt["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Dt["Unified Canadian Aboriginal Syllabics"](r)||Dt["Unified Canadian Aboriginal Syllabics Extended"](r)||Dt["Vertical Forms"](r)||Dt["Yijing Hexagram Symbols"](r)||Dt["Yi Syllables"](r)||Dt["Yi Radicals"](r))))}function Zh(r){return!(yu(r)||(function(e){return!!(Dt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Dt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Dt["Letterlike Symbols"](e)||Dt["Number Forms"](e)||Dt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Dt["Control Pictures"](e)&&e!==9251||Dt["Optical Character Recognition"](e)||Dt["Enclosed Alphanumerics"](e)||Dt["Geometric Shapes"](e)||Dt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Dt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Dt["CJK Symbols and Punctuation"](e)||Dt.Katakana(e)||Dt["Private Use Area"](e)||Dt["CJK Compatibility Forms"](e)||Dt["Small Form Variants"](e)||Dt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)})(r))}function Wh(r){return Dt.Arabic(r)||Dt["Arabic Supplement"](r)||Dt["Arabic Extended-A"](r)||Dt["Arabic Presentation Forms-A"](r)||Dt["Arabic Presentation Forms-B"](r)}function Zf(r){return r>=1424&&r<=2303||Dt["Arabic Presentation Forms-A"](r)||Dt["Arabic Presentation Forms-B"](r)}function Vm(r,e){return!(!e&&Zf(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Dt.Khmer(r))}function Um(r){for(const e of r)if(Zf(e.charCodeAt(0)))return!0;return!1}const Ns={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Xh=null,bs=Ns.unavailable,da=null;const Wf=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(bs=Ns.error),Xh&&Xh(r)};function Yh(){Kh.fire(new $s("pluginStateChange",{pluginStatus:bs,pluginURL:da}))}const Kh=new Vo,Jh=function(){return bs},Qh=function(){if(bs!==Ns.deferred||!da)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");bs=Ns.loading,Yh(),da&&Za({url:da},(r=>{r?Wf(r):(bs=Ns.loaded,Yh())}))},Vs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>bs===Ns.loaded||Vs.applyArabicShaping!=null,isLoading:()=>bs===Ns.loading,setState(r){bs=r.pluginStatus,da=r.pluginURL},isParsing:()=>bs===Ns.parsing,isParsed:()=>bs===Ns.parsed,getPluginURL:()=>da};class yr{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview,this.activeFloors=i.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return(function(i,s){for(const a of i)if(!Vm(a.charCodeAt(0),s))return!1;return!0})(e,Vs.isLoaded())}}class _c{constructor(e,i,s,a,u){this.property=e,this.value=i,this.expression=(function(h,f,_,g,v){if(uu(h))return new pu(h,f);if(fu(h)||Array.isArray(h)&&h.length>0){const b=Hh(h,f,_,g,v);if(b.result==="error")throw new Error(b.value.map((w=>"".concat(w.key,": ").concat(w.message))).join(", "));return b.value}{let b=h;return typeof h=="string"&&f.type==="color"&&(b=Gi.parse(h)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>b}}})(i===void 0?e.specification.default:i,e.specification,s,a,u)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s,a){return this.property.possiblyEvaluate(this,e,i,s,a)}}class pl{constructor(e,i,s,a){this.property=e,this.value=new _c(e,void 0,i,s,a)}transitioned(e,i){return new Yf(this.property,this.value,i,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new Yf(this.property,this.value,null,{},0)}}class Xf{constructor(e,i,s,a){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return vt(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new pl(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new _c(this._values[e].property,i===null?void 0:vt(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,i){i&&(this._options=i);const s=this._properties.properties;if(e)for(const a in e){const u=e[a];if(a.endsWith("-transition")){const h=a.slice(0,-11);s[h]&&this.setTransition(h,u)}else s.hasOwnProperty(a)&&this.setValue(a,u)}}getTransition(e){return vt(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new pl(this._values[e].property)),this._values[e].transition=vt(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s);const a=this.getTransition(i);a!==void 0&&(e["".concat(i,"-transition")]=a)}return e}transitioned(e,i){const s=new Zo(this._properties);for(const a of Object.keys(this._values))s._values[a]=this._values[a].transitioned(e,i._values[a]);return s}untransitioned(){const e=new Zo(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class Yf{constructor(e,i,s,a,u){const h=a.delay||0,f=a.duration||0;u=u||0,this.property=e,this.value=i,this.begin=u+h,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){const a=e.now||0,u=this.value.possiblyEvaluate(e,i,s),h=this.prior;if(h){if(a>this.end)return this.prior=null,u;if(this.value.isDataDriven())return this.prior=null,u;if(a<this.begin)return h.possiblyEvaluate(e,i,s);{const f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,s),u,xs(f))}}return u}}class Zo{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){const a=new Oa(this._properties);for(const u of Object.keys(this._values))a._values[u]=this._values[u].possiblyEvaluate(e,i,s);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class ed{constructor(e,i,s,a){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this._iconImageUseTheme=a,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return vt(this._values[e].value)}setValue(e,i){this._values[e]=new _c(this._values[e].property,i===null?void 0:vt(i),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s,a){const u=new Oa(this._properties);for(const h of Object.keys(this._values))u._values[h]=this._values[h].possiblyEvaluate(e,i,s,a);return u}isIndoorDependent(){return this._isIndoorDependent}}class yo{constructor(e,i,s,a){this.property=e,this.value=i,this.parameters=s,this.iconImageUseTheme=a}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,a){return this.property.evaluate(this.value,this.parameters,e,i,s,a,this.iconImageUseTheme)}}class Oa{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class We{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){const a=Uo[this.specification.type];return a?a(e,i,s):e}}class ct{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,a,u){return e.expression.kind==="constant"||e.expression.kind==="camera"?new yo(this,{kind:"constant",value:e.expression.evaluate(i,null,{},s,a,void 0,u)},i):new yo(this,e.expression,i,u)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new yo(this,{kind:"constant",value:void 0},e.parameters);const a=Uo[this.specification.type];return a?new yo(this,{kind:"constant",value:a(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,a,u,h,f){return e.kind==="constant"?e.value:e.evaluate(i,s,a,u,h,void 0,f)}}class ml{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,a){return!!e.expression.evaluate(i,null,{},s,a)}interpolate(){return!1}}class $r{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new yr(0,{});for(const s in e){const a=e[s];a.specification.overridable&&this.overridableProperties.push(s);const u=this.defaultPropertyValues[s]=new _c(a,void 0),h=this.defaultTransitionablePropertyValues[s]=new pl(a);this.defaultTransitioningPropertyValues[s]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=u.possiblyEvaluate(i)}}}mt(ct,"DataDrivenProperty"),mt(We,"DataConstantProperty"),mt(ml,"ColorRampProperty");var ge=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function td(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function _l(r){if(Array.isArray(r))return r.map(_l);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=_l(r[i]);return e}return td(r)}function gl(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!gl(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function xu(r,e="",i=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};gl(r)||(r=Xs(r));const a=r;let u=!0;try{u=(function(v){if(!xl(v))return v;let b=_l(v);return yl(b),b=vu(b),b})(a)}catch(v){console.warn("Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n".concat(JSON.stringify(a,null,2),"\n        "))}let h=null,f=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){f=ge["filter_".concat(s)];const v=Oo(u,f,e,i);if(v.result==="error")throw new Error(v.value.map((b=>"".concat(b.key,": ").concat(b.message))).join(", "));h=(b,w,I)=>v.value.evaluate(b,w,{},I)}let _=null,g=null;if(u!==a){const v=Oo(a,f,e,i);if(v.result==="error")throw new Error(v.value.map((b=>"".concat(b.key,": ").concat(b.message))).join(", "));_=(b,w,I,A,R)=>v.value.evaluate(b,w,{},I,void 0,void 0,A,R),g=!sl(v.value.expression)}return{filter:h,dynamicFilter:_||void 0,needGeometry:Jf(u),needFeature:!!g}}function vu(r){if(!Array.isArray(r))return r;const e=(function(i){if(jm.has(i[0])){for(let s=1;s<i.length;s++)if(xl(i[s]))return!0}return i})(r);return e===!0?e:e.map((i=>vu(i)))}function yl(r){let e=!1;const i=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||xl(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||xl(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||xl(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)yl(r[s])}function xl(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(xl(r[i]))return!0;return!1}const jm=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Kf(r,e){return r<e?-1:r>e?1:0}function Jf(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(Jf(r[e]))return!0;return!1}function Xs(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?id(r[1],r[2],"=="):e==="!="?bu(id(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?id(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(Xs))):e==="all"?["all"].concat(r.slice(1).map(Xs)):e==="none"?["all"].concat(r.slice(1).map(Xs).map(bu)):e==="in"?rd(r[1],r.slice(2)):e==="!in"?bu(rd(r[1],r.slice(2))):e==="has"?Qf(r[1]):e!=="!has"||bu(Qf(r[1]));var i}function id(r,e,i){switch(r){case"$type":return["filter-type-".concat(i),e];case"$id":return["filter-id-".concat(i),e];default:return["filter-".concat(i),r,e]}}function rd(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((i=>typeof i!=typeof e[0]))?["filter-in-large",r,["literal",e.sort(Kf)]]:["filter-in-small",r,["literal",e]]}}function Qf(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function bu(r){return["!",r]}const gc="";function ka(r,e){return e?"".concat(r).concat(gc).concat(e):r}let ep;const tp=()=>ep||(ep=new $r({"icon-size":new ct(ge.layout_symbol["icon-size"]),"icon-image":new ct(ge.layout_symbol["icon-image"]),"icon-rotate":new ct(ge.layout_symbol["icon-rotate"]),"icon-offset":new ct(ge.layout_symbol["icon-offset"])}));class Gm{constructor(e,i,s,a,u,h){this.cachedIconPrimary=null;const f=Oo(e,ge.appearance.condition);if(f.result==="success"&&(this.condition=f.value),this.name=i,s){this.properties=new Oa(tp()),this.unevaluatedLayout=new ed(tp(),a,u,h);for(const _ in s)this.unevaluatedLayout.setValue(_,s[_])}}hasCachedIconPrimary(){return this.cachedIconPrimary!==null}setCachedIconPrimary(e){this.cachedIconPrimary=e}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(e,i,s){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,i,s))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}}const ip="-transition",Hm=new Set(["fill","line","background","hillshade","raster"]);class ys extends Vo{constructor(e,i,s,a,u,h){if(super(),this.id=e.id,this.fqid=ka(this.id,s),this.type=e.type,this.scope=s,this.lut=a,this.options=u,this.iconImageUseTheme=h,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const f=Oo(this.filter,ge["filter_".concat(e.type)]);f.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...f.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||f.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),i.layout&&(this._unevaluatedLayout=new ed(i.layout,this.scope,u,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),i.paint){this._transitionablePaint=new Xf(i.paint,this.scope,u);for(const f in e.paint)this.setPaintProperty(f,e.paint[f]);for(const f in e.layout)this.setLayoutProperty(f,e.layout[f]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Oa(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Hm.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...s.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||s.isIndoorDependent(),e==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach((i=>{this.appearances.push(new Gm(i.condition,i.name,i.properties,this.scope,this.options,this.iconImageUseTheme))}))}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(ip)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,i){const s=this._transitionablePaint,a=s._properties.properties;if(e.endsWith(ip)){const b=e.slice(0,-11);return a[b]&&s.setTransition(b,i||void 0),!1}if(!a[e])return!1;const u=s._values[e],h=u.value.isDataDriven(),f=u.value;s.setValue(e,i),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...s.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||s.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const _=s._values[e].value,g=_.isDataDriven(),v=e.endsWith("pattern")||e==="line-dasharray";return g||h||v||this._handleOverridablePaintPropertyUpdate(e,f,_)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map((i=>i.serialize()))),Ue(e,((i,s)=>!(i===void 0||s==="layout"&&!Object.keys(i).length||s==="paint"&&!Object.keys(i).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof yo&&lu(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}for(const e of this.appearances)if(!ac(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=xu(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,i,s){return{}}queryRadius(e){}queryIntersectsFeature(e,i,s,a,u,h,f,_,g){}}const qm={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class yc{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ir{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function fi(r,e=1){let i=0,s=0;return{members:r.map((a=>{const u=qm[a.type].BYTES_PER_ELEMENT,h=i=nd(i,Math.max(e,u)),f=a.components||1;return s=Math.max(s,u),i+=u*f,{name:a.name,type:a.type,components:f,offset:h}})),size:nd(i,Math.max(s,e)),alignment:e}}function nd(r,e){return Math.ceil(r/e)*e}class Ps extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.int16[a+0]=i,this.int16[a+1]=s,e}}Ps.prototype.bytesPerElement=4,mt(Ps,"StructArrayLayout2i4");class Fa extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}Fa.prototype.bytesPerElement=6,mt(Fa,"StructArrayLayout3i6");class vl extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,this.int16[h+3]=u,e}}vl.prototype.bytesPerElement=8,mt(vl,"StructArrayLayout4i8");class Wo extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Wo.prototype.bytesPerElement=4,mt(Wo,"StructArrayLayout1f4");class sd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e,h=2*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.float32[h+1]=a,e}}sd.prototype.bytesPerElement=8,mt(sd,"StructArrayLayout2i1f8");class od extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,e}}od.prototype.bytesPerElement=8,mt(od,"StructArrayLayout3i8");class wu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=5*e;return this.int16[f+0]=i,this.int16[f+1]=s,this.int16[f+2]=a,this.int16[f+3]=u,this.int16[f+4]=h,e}}wu.prototype.bytesPerElement=10,mt(wu,"StructArrayLayout5i10");class Tu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,_){const g=6*e,v=12*e,b=3*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.uint8[v+4]=a,this.uint8[v+5]=u,this.uint8[v+6]=h,this.uint8[v+7]=f,this.float32[b+2]=_,e}}Tu.prototype.bytesPerElement=12,mt(Tu,"StructArrayLayout2i4ub1f12");class Ys extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=a,e}}Ys.prototype.bytesPerElement=12,mt(Ys,"StructArrayLayout3f12");class fa extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=6*e,_=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=s,this.uint16[f+2]=a,this.uint16[f+3]=u,this.float32[_+2]=h,e}}fa.prototype.bytesPerElement=12,mt(fa,"StructArrayLayout4ui1f12");class Ba extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=a,this.uint16[h+3]=u,e}}Ba.prototype.bytesPerElement=8,mt(Ba,"StructArrayLayout4ui8");class Su extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const _=6*e;return this.int16[_+0]=i,this.int16[_+1]=s,this.int16[_+2]=a,this.int16[_+3]=u,this.int16[_+4]=h,this.int16[_+5]=f,e}}Su.prototype.bytesPerElement=12,mt(Su,"StructArrayLayout6i12");class Eu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b,w){const I=this.length;return this.resize(I+1),this.emplace(I,e,i,s,a,u,h,f,_,g,v,b,w)}emplace(e,i,s,a,u,h,f,_,g,v,b,w,I){const A=12*e;return this.int16[A+0]=i,this.int16[A+1]=s,this.int16[A+2]=a,this.int16[A+3]=u,this.uint16[A+4]=h,this.uint16[A+5]=f,this.uint16[A+6]=_,this.uint16[A+7]=g,this.int16[A+8]=v,this.int16[A+9]=b,this.int16[A+10]=w,this.int16[A+11]=I,e}}Eu.prototype.bytesPerElement=24,mt(Eu,"StructArrayLayout4i4ui4i24");class bl extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const _=10*e,g=5*e;return this.int16[_+0]=i,this.int16[_+1]=s,this.int16[_+2]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=f,e}}bl.prototype.bytesPerElement=20,mt(bl,"StructArrayLayout3i3f20");class pa extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=a,this.float32[h+3]=u,e}}pa.prototype.bytesPerElement=16,mt(pa,"StructArrayLayout4f16");class ad extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}ad.prototype.bytesPerElement=4,mt(ad,"StructArrayLayout1ul4");class xo extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,e}}xo.prototype.bytesPerElement=4,mt(xo,"StructArrayLayout2ui4");class ld extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b,w,I){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,s,a,u,h,f,_,g,v,b,w,I)}emplace(e,i,s,a,u,h,f,_,g,v,b,w,I,A){const R=20*e,L=10*e;return this.int16[R+0]=i,this.int16[R+1]=s,this.int16[R+2]=a,this.int16[R+3]=u,this.int16[R+4]=h,this.float32[L+3]=f,this.float32[L+4]=_,this.float32[L+5]=g,this.float32[L+6]=v,this.int16[R+14]=b,this.uint32[L+8]=w,this.uint16[R+18]=I,this.uint16[R+19]=A,e}}ld.prototype.bytesPerElement=40,mt(ld,"StructArrayLayout5i4f1i1ul2ui40");class Iu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,_){const g=8*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.int16[g+4]=u,this.int16[g+5]=h,this.int16[g+6]=f,this.int16[g+7]=_,e}}Iu.prototype.bytesPerElement=16,mt(Iu,"StructArrayLayout3i2i2i16");class wl extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=4*e,_=8*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.int16[_+6]=u,this.int16[_+7]=h,e}}wl.prototype.bytesPerElement=16,mt(wl,"StructArrayLayout2f1f2i16");class Tl extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const _=20*e,g=5*e;return this.uint8[_+0]=i,this.uint8[_+1]=s,this.float32[g+1]=a,this.float32[g+2]=u,this.float32[g+3]=h,this.float32[g+4]=f,e}}Tl.prototype.bytesPerElement=20,mt(Tl,"StructArrayLayout2ub4f20");class zr extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){const u=3*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=a,e}}zr.prototype.bytesPerElement=6,mt(zr,"StructArrayLayout3ui6");class Sl extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie){const J=this.length;return this.resize(J+1),this.emplace(J,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie)}emplace(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie,J){const se=30*e,le=15*e,he=60*e;return this.int16[se+0]=i,this.int16[se+1]=s,this.int16[se+2]=a,this.float32[le+2]=u,this.float32[le+3]=h,this.uint16[se+8]=f,this.uint16[se+9]=_,this.uint32[le+5]=g,this.uint32[le+6]=v,this.uint32[le+7]=b,this.uint16[se+16]=w,this.uint16[se+17]=I,this.uint16[se+18]=A,this.float32[le+10]=R,this.float32[le+11]=L,this.uint8[he+48]=k,this.uint8[he+49]=U,this.uint8[he+50]=G,this.uint32[le+13]=q,this.int16[se+28]=ie,this.uint8[he+58]=J,e}}Sl.prototype.bytesPerElement=60,mt(Sl,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class cd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie,J,se,le,he,Ce,ye,Pe,ke,Ve,Qe,qe,Fe){const He=this.length;return this.resize(He+1),this.emplace(He,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie,J,se,le,he,Ce,ye,Pe,ke,Ve,Qe,qe,Fe)}emplace(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie,J,se,le,he,Ce,ye,Pe,ke,Ve,Qe,qe,Fe,He){const Ae=20*e,Ee=40*e,Ge=80*e;return this.float32[Ae+0]=i,this.float32[Ae+1]=s,this.int16[Ee+4]=a,this.int16[Ee+5]=u,this.int16[Ee+6]=h,this.int16[Ee+7]=f,this.int16[Ee+8]=_,this.int16[Ee+9]=g,this.int16[Ee+10]=v,this.int16[Ee+11]=b,this.int16[Ee+12]=w,this.uint16[Ee+13]=I,this.uint16[Ee+14]=A,this.uint16[Ee+15]=R,this.uint16[Ee+16]=L,this.uint16[Ee+17]=k,this.uint16[Ee+18]=U,this.uint16[Ee+19]=G,this.uint16[Ee+20]=q,this.uint16[Ee+21]=ie,this.uint16[Ee+22]=J,this.uint16[Ee+23]=se,this.uint16[Ee+24]=le,this.uint16[Ee+25]=he,this.uint16[Ee+26]=Ce,this.uint16[Ee+27]=ye,this.uint32[Ae+14]=Pe,this.float32[Ae+15]=ke,this.float32[Ae+16]=Ve,this.float32[Ae+17]=Qe,this.float32[Ae+18]=qe,this.uint8[Ge+76]=Fe,this.uint16[Ee+39]=He,e}}cd.prototype.bytesPerElement=80,mt(cd,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class ud extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,u,h)}emplace(e,i,s,a,u,h,f){const _=6*e;return this.float32[_+0]=i,this.float32[_+1]=s,this.float32[_+2]=a,this.float32[_+3]=u,this.float32[_+4]=h,this.float32[_+5]=f,e}}ud.prototype.bytesPerElement=24,mt(ud,"StructArrayLayout6f24");class Na extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a,u)}emplace(e,i,s,a,u,h){const f=5*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.float32[f+3]=u,this.float32[f+4]=h,e}}Na.prototype.bytesPerElement=20,mt(Na,"StructArrayLayout5f20");class hd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,_){const g=7*e;return this.float32[g+0]=i,this.float32[g+1]=s,this.float32[g+2]=a,this.float32[g+3]=u,this.float32[g+4]=h,this.float32[g+5]=f,this.float32[g+6]=_,e}}hd.prototype.bytesPerElement=28,mt(hd,"StructArrayLayout7f28");class xc extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,s,a,u,h,f,_,g,v,b)}emplace(e,i,s,a,u,h,f,_,g,v,b,w){const I=11*e;return this.float32[I+0]=i,this.float32[I+1]=s,this.float32[I+2]=a,this.float32[I+3]=u,this.float32[I+4]=h,this.float32[I+5]=f,this.float32[I+6]=_,this.float32[I+7]=g,this.float32[I+8]=v,this.float32[I+9]=b,this.float32[I+10]=w,e}}xc.prototype.bytesPerElement=44,mt(xc,"StructArrayLayout11f44");class dd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,s,a,u,h,f,_,g)}emplace(e,i,s,a,u,h,f,_,g,v){const b=9*e;return this.float32[b+0]=i,this.float32[b+1]=s,this.float32[b+2]=a,this.float32[b+3]=u,this.float32[b+4]=h,this.float32[b+5]=f,this.float32[b+6]=_,this.float32[b+7]=g,this.float32[b+8]=v,e}}dd.prototype.bytesPerElement=36,mt(dd,"StructArrayLayout9f36");class ma extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const a=2*e;return this.float32[a+0]=i,this.float32[a+1]=s,e}}ma.prototype.bytesPerElement=8,mt(ma,"StructArrayLayout2f8");class fd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a)}emplace(e,i,s,a,u){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=s,this.uint16[h+3]=a,this.uint16[h+4]=u,e}}fd.prototype.bytesPerElement=12,mt(fd,"StructArrayLayout1ul3ui12");class Au extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Au.prototype.bytesPerElement=2,mt(Au,"StructArrayLayout1ui2");class Mu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L){const k=this.length;return this.resize(k+1),this.emplace(k,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L)}emplace(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k){const U=16*e;return this.float32[U+0]=i,this.float32[U+1]=s,this.float32[U+2]=a,this.float32[U+3]=u,this.float32[U+4]=h,this.float32[U+5]=f,this.float32[U+6]=_,this.float32[U+7]=g,this.float32[U+8]=v,this.float32[U+9]=b,this.float32[U+10]=w,this.float32[U+11]=I,this.float32[U+12]=A,this.float32[U+13]=R,this.float32[U+14]=L,this.float32[U+15]=k,e}}Mu.prototype.bytesPerElement=64,mt(Mu,"StructArrayLayout16f64");class El extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,u,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,e,i,s,a,u,h,f)}emplace(e,i,s,a,u,h,f,_){const g=10*e,v=5*e;return this.uint16[g+0]=i,this.uint16[g+1]=s,this.uint16[g+2]=a,this.uint16[g+3]=u,this.float32[v+2]=h,this.float32[v+3]=f,this.float32[v+4]=_,e}}El.prototype.bytesPerElement=20,mt(El,"StructArrayLayout4ui3f20");class pd extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}pd.prototype.bytesPerElement=2,mt(pd,"StructArrayLayout1i2");class Cu extends Ir{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Cu.prototype.bytesPerElement=1,mt(Cu,"StructArrayLayout1ub1");class md extends yc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}md.prototype.size=40;class rp extends ld{get(e){return new md(this,e)}}mt(rp,"CollisionBoxArray");class Pu extends yc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Pu.prototype.size=60;class vc extends Sl{get(e){return new Pu(this,e)}}mt(vc,"PlacedSymbolArray");class _d extends yc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}_d.prototype.size=80;class np extends cd{get(e){return new _d(this,e)}}mt(np,"SymbolInstanceArray");class gd extends Wo{getoffsetX(e){return this.float32[1*e+0]}}mt(gd,"GlyphOffsetArray");class sp extends Ps{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}mt(sp,"SymbolLineVertexArray");class Ru extends yc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Ru.prototype.size=12;class op extends fd{get(e){return new Ru(this,e)}}mt(op,"FeatureIndexArray");class ap extends xo{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}mt(ap,"FillExtrusionCentroidArray");class lp extends yc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}lp.prototype.size=6;class cp extends Fa{get(e){return new lp(this,e)}}mt(cp,"FillExtrusionWallArray");const up=fi([{name:"a_pos",components:2,type:"Int16"}],4),$m=fi([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Zm=fi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Vr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,a){let u=this.segments[this.segments.length-1];return e>Vr.MAX_VERTEX_ARRAY_LENGTH&&Mt("Max vertices per segment is ".concat(Vr.MAX_VERTEX_ARRAY_LENGTH,": bucket requested ").concat(e)),(!u||u.vertexLength+e>Vr.MAX_VERTEX_ARRAY_LENGTH||u.sortKey!==a)&&(u={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},a!==void 0&&(u.sortKey=a),this.segments.push(u)),u}prepareSegment(e,i,s,a){return this._prepareSegment(e,i.length,s.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,a){return new Vr([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:a,vaos:{},sortKey:0}])}}function hp(r,e){return 256*(r=B(Math.floor(r),0,255))+B(Math.floor(e),0,255)}Vr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,mt(Vr,"SegmentVector");const Wm=fi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Xm=fi([{name:"a_pattern_b",components:4,type:"Uint16"}]),Ym=fi([{name:"a_dash",components:4,type:"Uint16"}]);class bc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,a){this.ids.push(wc(e)),this.positions.push(i,s,a)}eachPosition(e,i){const s=wc(e);let a=0,u=this.ids.length-1;for(;a<u;){const h=a+u>>1;this.ids[h]>=s?u=h:a=h+1}for(;this.ids[a]===s;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){const s=new Float64Array(e.ids),a=new Uint32Array(e.positions);return yd(s,a,0,s.length-1),i&&(i.add(s.buffer),i.add(a.buffer)),{ids:s,positions:a}}static deserialize(e){const i=new bc;let s;i.ids=e.ids,i.positions=e.positions;for(const a of i.ids)a!==s&&i.uniqueIds.push(a),s=a;return i.indexed=!0,i}}function wc(r){const e=+r;return Number.isSafeInteger(e)?e:$l(String(r))}function yd(r,e,i,s){for(;i<s;){const a=r[i+s>>1];let u=i-1,h=s+1;for(;;){do u++;while(r[u]<a);do h--;while(r[h]>a);if(u>=h)break;Du(r,u,h),Du(e,3*u,3*h),Du(e,3*u+1,3*h+1),Du(e,3*u+2,3*h+2)}h-i<s-h?(yd(r,e,i,h),i=h+1):(yd(r,e,h+1,s),s=h)}}function Du(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}mt(bc,"FeaturePositionMap");class vo{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class zu extends vo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class un extends vo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class ko extends vo{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Il extends vo{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class Tc extends vo{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class xd extends vo{constructor(e){super(e),this.current=Gi.transparent.toPremultipliedRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}const dp=new Float32Array(16);class Sc extends vo{constructor(e){super(e),this.current=dp}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let a=1;a<16;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}const Km=new Float32Array(9),fp=new Float32Array(4);class vd extends vo{constructor(e){super(e),this.current=fp}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function bd(r){return[hp(255*r.r,255*r.g),hp(255*r.b,255*r.a)]}function Lu(r,e,i,s,a,u,h,f){return!!r&&(r.kind==="composite"||r.kind==="source"?r.evaluate(new yr(0,{brightness:u,worldview:f}),e,i,a,s,h)==="none":r.value==="none")}class Ou{constructor(e,i,s,a){this.value=e,this.uniformNames=i.map((u=>"u_".concat(u))),this.type=s,this.context=a}setUniform(e,i,s,a,u){const h=a.constantOr(this.value);i.set(e,u,h instanceof Gi?h.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new xd(e):new un(e)}}class Ec{constructor(e,i){this.uniformNames=i.map((s=>"u_".concat(s))),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,s,a,u){let h=null;u!=="u_pattern"&&u!=="u_dash"||(h=this.pattern),u==="u_pattern_b"&&(h=this.patternTransition),u==="u_pixel_ratio"&&(h=this.pixelRatio),h&&i.set(e,u,h)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Tc(e):new un(e)}}class Xo{constructor(e,i,s,a){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map((u=>({name:"a_".concat(u),type:"Float32",components:s==="color"?2:1,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,i,s,a,u,h,f,_){const g=this.paintVertexArray.length,v=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new yr(0,{brightness:h,worldview:_}),i,{},u,a,f):this.expression.kind==="constant"&&this.expression.value,b=Lu(this.lutExpression,i,{},a,u,h,f,_);this.paintVertexArray.resize(e),this._setPaintValue(g,e,v,b?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,f,_){const g=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:f,worldview:_},s,a,void 0,u):this.expression.kind==="constant"&&this.expression.value,v=Lu(this.lutExpression,s,a,u,void 0,f,void 0,_);this._setPaintValue(e,i,g,v?null:this.context.lut)}_setPaintValue(e,i,s,a){if(this.type==="color"){const u=bd(s.toPremultipliedRenderColor(a));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,u[0],u[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class To{constructor(e,i,s,a,u,h){this.expression=e,this.uniformNames=i.map((f=>"u_".concat(f,"_t"))),this.type=s,this.useIntegerZoom=a,this.context=u,this.maxValue=0,this.paintVertexAttributes=i.map((f=>({name:"a_".concat(f),type:"Float32",components:s==="color"?4:2,offset:0}))),this.paintVertexArray=new h}populatePaintArray(e,i,s,a,u,h,f,_){const g=this.expression.evaluate(new yr(this.context.zoom,{brightness:h,worldview:_}),i,{},u,a,f),v=this.expression.evaluate(new yr(this.context.zoom+1,{brightness:h,worldview:_}),i,{},u,a,f),b=Lu(this.lutExpression,i,{},a,u,h,f,_),w=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(w,e,g,v,b?null:this.context.lut)}updatePaintArray(e,i,s,a,u,h,f,_){const g=this.expression.evaluate({zoom:this.context.zoom,brightness:f,worldview:_},s,a,void 0,u),v=this.expression.evaluate({zoom:this.context.zoom+1,brightness:f,worldview:_},s,a,void 0,u),b=Lu(this.lutExpression,s,a,u,void 0,f,void 0,_);this._setPaintValue(e,i,g,v,b?null:this.context.lut)}_setPaintValue(e,i,s,a,u){if(this.type==="color"){const h=bd(s.toPremultipliedRenderColor(u)),f=bd(s.toPremultipliedRenderColor(u));for(let _=e;_<i;_++)this.paintVertexArray.emplace(_,h[0],h[1],f[0],f[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s,a);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,a,u){const h=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,f=B(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,u,f)}getBinding(e,i){return new un(e)}}class ls{constructor(e,i,s,a,u){this.expression=e,this.layerId=u,this.paintVertexAttributes=(s==="array"?Ym:Wm).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new a,this.paintTransitionVertexArray=new Ba}populatePaintArray(e,i,s,a){const u=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(u,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,a,u,h,f){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],h)}_setPaintValues(e,i,s,a){if(!a||!s)return;const u=a[s[0]],h=a[s[1]];if(u){if(u){const{tl:f,br:_,pixelRatio:g}=u;for(let v=e;v<i;v++)this.paintVertexArray.emplace(v,f[0],f[1],_[0],_[1],g)}if(h){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:f,br:_}=h;for(let g=e;g<i;g++)this.paintTransitionVertexArray.emplace(g,f[0],f[1],_[0],_[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Xm.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Yo{constructor(e,i,s=(()=>!0)){this.binders={},this._buffers=[],this.context=i;const a=[];for(const u in e.paint._values){const h=e.paint.get(u);if(u.endsWith("-use-theme")||!s(u)||!(h instanceof yo&&lu(h.property.specification)))continue;const f=Qm(u,e.type),_=h.value,g=h.property.specification.type,v=!!h.property.useIntegerZoom,b=u==="line-dasharray"||u.endsWith("pattern"),w=e.paint.get("".concat(u,"-use-theme")),I=u==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||w&&w.value.kind!=="constant";if(_.kind!=="constant"||I)if(_.kind==="source"||I||b){const A=wd(u,g,"source");this.binders[u]=b?new ls(_,f,g,A,e.id):new Xo(_,f,g,A),a.push("/a_".concat(u))}else{const A=wd(u,g,"composite");this.binders[u]=new To(_,f,g,v,i,A),a.push("/z_".concat(u))}else this.binders[u]=b?new Ec(_.value,f):new Ou(_.value,f,g,i),a.push("/u_".concat(u));w&&(this.binders[u].lutExpression=w.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Xo||i instanceof To?i.maxValue:0}populatePaintArrays(e,i,s,a,u,h,f,_){for(const g in this.binders){const v=this.binders[g];v.context=this.context,(v instanceof Xo||v instanceof To||v instanceof ls)&&v.populatePaintArray(e,i,s,a,u,h,f,_)}}setConstantPatternPositions(e,i){for(const s in this.binders){const a=this.binders[s];a instanceof Ec&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof ls?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,s,a,u,h,f,_,g,v){let b=!1;const w=Object.keys(e),I=w.length!==0&&!_,A=I?w:i.uniqueIds;this.context.lut=u.lut;for(const R in this.binders){const L=this.binders[R];if(L.context=this.context,(L instanceof Xo||L instanceof To||L instanceof ls)&&L.expression&&L.expression.kind&&L.expression.kind!=="constant"&&(L.expression.isStateDependent===!0||L.expression.isLightConstant===!1)){const k=u.paint.get(R);L.expression=k.value;for(const U of A){const G=e[U.toString()];i.eachPosition(U,((q,ie,J)=>{const se=a.feature(q);L.updatePaintArray(ie,J,se,G,h,f,g,v)}))}if(!I)for(const U of s.uniqueIds){const G=e[U.toString()];s.eachPosition(U,((q,ie,J)=>{const se=a.feature(q);L.updatePaintArray(ie,J,se,G,h,f,g,v)}))}b=!0}}return b}defines(){const e=[];for(const i in this.binders){const s=this.binders[i];(s instanceof Ou||s instanceof Ec)&&e.push(...s.uniformNames.map((a=>"#define HAS_UNIFORM_".concat(a))))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const s in this.binders){const a=this.binders[s];if(a instanceof Ou||a instanceof Ec||a instanceof To)for(const u of a.uniformNames)i.push({name:u,property:s,binding:a.getBinding(e,u)})}return i}setUniforms(e,i,s,a,u){for(const{name:h,property:f,binding:_}of s)this.binders[f].setUniform(e,_,u,a.get(f),h)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Xo||i instanceof To||i instanceof ls)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof ls&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const s=this.binders[i];(s instanceof Xo||s instanceof To||s instanceof ls)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Xo||i instanceof To||i instanceof ls)&&i.destroy()}}}class So{constructor(e,i,s=(()=>!0)){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new Yo(a,i,s);this.needsUpload=!1,this._featureMap=new bc,this._featureMapWithoutIds=new bc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,a,u,h,f,_,g){for(const v in this.programConfigurations)this.programConfigurations[v].populatePaintArrays(e,i,a,u,h,f,_,g);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,a,u,h,f,_){for(const g of s)this.needsUpload=this.programConfigurations[g.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,g,a,u,h,f||0,_)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Jm={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Qm(r,e){return Jm[r]||[r.replace("".concat(e,"-"),"").replace(/-/g,"_")]}const e_={"line-pattern":{source:fa,composite:fa},"fill-pattern":{source:fa,composite:fa},"fill-extrusion-pattern":{source:fa,composite:fa},"line-dasharray":{source:Ba,composite:Ba}},t_={color:{source:ma,composite:pa},number:{source:Wo,composite:ma}};function wd(r,e,i){const s=e_[r];return s&&s[i]||t_[e][i]}mt(Ou,"ConstantBinder"),mt(Ec,"PatternConstantBinder"),mt(Xo,"SourceExpressionBinder"),mt(ls,"PatternCompositeBinder"),mt(To,"CompositeExpressionBinder"),mt(Yo,"ProgramConfiguration",{omit:["_buffers"]}),mt(So,"ProgramConfigurationSet");const Rs=it/Math.PI/2,l=5,t=6,n=16383,c=64,d=[c,32,16],p=-Rs,m=Rs;function y(r,e,i,s=Rs){return i=Qt(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function x(r,e,i){return y(Math.cos(Qt(r)),Math.sin(Qt(r)),e,i)}const T=63710088e-1,S=2*Math.PI*T;class M{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error("Invalid LngLat object: (".concat(e,", ").concat(i,")"));if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new M(ae(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return"LngLat(".concat(this.lng,", ").concat(this.lat,")")}distanceTo(e){const i=Math.PI/180,s=this.lat*i,a=e.lat*i,u=Math.sin(s)*Math.sin(a)+Math.cos(s)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return T*Math.acos(Math.min(u,1))}toBounds(e=0){const i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new E({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return x(this.lat,this.lng,Rs+e*Rs/T)}static convert(e){if(e instanceof M)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new M(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new M(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class E{constructor(e,i){e&&(i?this.setSouthWest(e).setNorthEast(i):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof M?new M(e.lng,e.lat):M.convert(e),this}setSouthWest(e){return this._sw=e instanceof M?new M(e.lng,e.lat):M.convert(e),this}extend(e){const i=this._sw,s=this._ne;let a,u;if(e instanceof M)a=e,u=e;else{if(!(e instanceof E))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(E.convert(e)):this.extend(M.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(M.convert(e)):this;if(a=e._sw,u=e._ne,!a||!u)return this}return i||s?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),s.lng=Math.max(u.lng,s.lng),s.lat=Math.max(u.lat,s.lat)):(this._sw=new M(a.lng,a.lat),this._ne=new M(u.lng,u.lat)),this}getCenter(){return new M((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new M(this.getWest(),this.getNorth())}getSouthEast(){return new M(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return"LngLatBounds(".concat(this._sw.toString(),", ").concat(this._ne.toString(),")")}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=M.convert(e);let a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&a}static convert(e){if(e)return e instanceof E?e:new E(e)}}const P=0,D=25.5;function O(r){return S*Math.cos(r*Math.PI/180)}function V(r){return(180+r)/360}function N(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function j(r,e){return r/O(e)}function Z(r){return 360*r-180}function H(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function te(r,e){return r*O(H(e))}const W=85.051129;function re(r){return Math.cos(Qt(B(r,-W,W)))}function ee(r,e){const i=B(e,P,D),s=Math.pow(2,i);return re(r)*S/(512*s)}function K(r){return 1/Math.cos(r*Math.PI/180)}function ne(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/it)/(1<<r.z)*2));return 80150034*i/(i*i+1)/it/(1<<r.z)}class _e{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){const s=M.convert(e);return new _e(V(s.lng),N(s.lat),j(i,s.lat))}toLngLat(){return new M(Z(this.x),H(this.y))}toAltitude(){return te(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/S*K(H(this.y))}}function fe(r,e,i,s,a,u,h,f,_){const g=(e+s)/2,v=(i+a)/2,b=new Be(g,v);f(b),(function(w,I,A,R,L,k){const U=A-L,G=R-k;return Math.abs((R-I)*U-(A-w)*G)/Math.hypot(U,G)})(b.x,b.y,u.x,u.y,h.x,h.y)>=_?(fe(r,e,i,g,v,u,b,f,_),fe(r,g,v,s,a,b,h,f,_)):r.push(h)}function Me(r,e,i){let s=r[0],a=s.x,u=s.y;e(s);const h=[s];for(let f=1;f<r.length;f++){const _=r[f],{x:g,y:v}=_;e(_),fe(h,a,u,g,v,s,_,e,i),a=g,u=v,s=_}return h}function we(r,e,i,s){if(s(e,i)){const a=e.add(i)._mult(.5);we(r,e,a,s),we(r,a,i,s)}else r.push(i)}function ze(r,e){let i=r[0];const s=[i];for(let a=1;a<r.length;a++){const u=r[a];we(s,i,u,e),i=u}return s}const Je=Math.pow(2,14)-1,xe=-Je-1;function ce(r,e){const i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=B(i,xe,Je),r.y=B(s,xe,Je),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&Mt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function Le(r,e,i){const s=r.loadGeometry(),a=r.extent,u=it/a;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:f,x:_,y:g,projection:v}=i,b=w=>{const I=Z((e.x+w.x/a)/h),A=H((e.y+w.y/a)/h),R=v.project(I,A);w.x=(R.x*f-_)*a,w.y=(R.y*f-g)*a};for(let w=0;w<s.length;w++)if(r.type!==1)s[w]=Me(s[w],b,1);else{const I=[];for(const A of s[w])A.x<0||A.x>=a||A.y<0||A.y>=a||(b(A),I.push(A));s[w]=I}}for(const h of s)for(const f of h)ce(f,u);return s}function Te(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?Le(r):[]}}class je{constructor(e,i,s,a,u){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=u,e.readFields(rt,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,s=[];let a,u=1,h=0,f=0,_=0;for(;e.pos<i;){if(h<=0){const g=e.readVarint();u=7&g,h=g>>3}if(h--,u===1||u===2)f+=e.readSVarint(),_+=e.readSVarint(),u===1&&(a&&s.push(a),a=[]),a&&a.push(new Be(f,_));else{if(u!==7)throw new Error("unknown command ".concat(u));a&&a.push(a[0].clone())}}return a&&s.push(a),s}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let s=1,a=0,u=0,h=0,f=1/0,_=-1/0,g=1/0,v=-1/0;for(;e.pos<i;){if(a<=0){const b=e.readVarint();s=7&b,a=b>>3}if(a--,s===1||s===2)u+=e.readSVarint(),h+=e.readSVarint(),u<f&&(f=u),u>_&&(_=u),h<g&&(g=h),h>v&&(v=h);else if(s!==7)throw new Error("unknown command ".concat(s))}return[f,g,_,v]}toGeoJSON(e,i,s){const a=this.extent*Math.pow(2,s),u=this.extent*e,h=this.extent*i,f=this.loadGeometry();function _(w){return[360*(w.x+u)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(w.y+h)/a)*Math.PI))-90]}function g(w){return w.map(_)}let v;if(this.type===1){const w=[];for(const A of f)w.push(A[0]);const I=g(w);v=w.length===1?{type:"Point",coordinates:I[0]}:{type:"MultiPoint",coordinates:I}}else if(this.type===2){const w=f.map(g);v=w.length===1?{type:"LineString",coordinates:w[0]}:{type:"MultiLineString",coordinates:w}}else{if(this.type!==3)throw new Error("unknown feature type");{const w=(function(A){const R=A.length;if(R<=1)return[A];const L=[];let k,U;for(let G=0;G<R;G++){const q=gt(A[G]);q!==0&&(U===void 0&&(U=q<0),U===q<0?(k&&L.push(k),k=[A[G]]):k&&k.push(A[G]))}return k&&L.push(k),L})(f),I=[];for(const A of w)I.push(A.map(g));v=I.length===1?{type:"Polygon",coordinates:I[0]}:{type:"MultiPolygon",coordinates:I}}}const b={type:"Feature",geometry:v,properties:this.properties};return this.id!=null&&(b.id=this.id),b}}function rt(r,e,i){r===1?e.id=i.readVarint():r===2?(function(s,a){const u=s.readVarint()+s.pos;for(;s.pos<u;){const h=a._keys[s.readVarint()],f=a._values[s.readVarint()];a.properties[h]=f}})(i,e):r===3?e.type=i.readVarint():r===4&&(e._geometry=i.pos)}function gt(r){let e=0;for(let i,s,a=0,u=r.length,h=u-1;a<u;h=a++)i=r[a],s=r[h],e+=(s.x-i.x)*(i.y+s.y);return e}je.types=["Unknown","Point","LineString","Polygon"];class Xe{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(et,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new je(this._pbf,i,this.extent,this._keys,this._values)}}function et(r,e,i){r===15?e.version=i.readVarint():r===1?e.name=i.readString():r===5?e.extent=i.readVarint():r===2?e._features.push(i.pos):r===3?e._keys.push(i.readString()):r===4&&e._values.push((function(s){let a=null;const u=s.readVarint()+s.pos;for(;s.pos<u;){const h=s.readVarint()>>3;a=h===1?s.readString():h===2?s.readFloat():h===3?s.readDouble():h===4?s.readVarint64():h===5?s.readVarint():h===6?s.readSVarint():h===7?s.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a})(i))}class xt{constructor(e,i){this.layers=e.readFields(dt,{},i)}}function dt(r,e,i){if(r===3){const s=new Xe(i,i.readVarint()+i.pos);s.length&&(e[s.name]=s)}}const ut="3d_elevation_id",ft="level";class zt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,s){return this.get(e,!0,i,s)}optional(e,i,s){return this.get(e,!1,i,s)}success(){return this._valid}get(e,i,s,a){const u=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&u!==void 0&&!Number.isNaN(u)?s(a?a(u):u):i&&(this._valid=!1),this}}class pi{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,s){return this.featureFunc(e,i,s)}parseVertex(e,i,s){return this.vertexFunc(e,i,s)}}const vi=new pi(((r,e,i)=>r.reset(e).require(ut,(s=>{i.id=s})).optional("fixed_height_relative",(s=>{i.constantHeight=s}),Gt.decodeRelativeHeight).geometry((s=>{i.bounds=s}),rc).success()),((r,e,i)=>r.reset(e).require(ut,(s=>{i.id=s})).require("elevation_idx",(s=>{i.idx=s})).require("extent",(s=>{i.extent=s})).require("height_relative",(s=>{i.height=s}),Gt.decodeRelativeHeight).geometry((s=>{i.position=s}),Gt.getPoint).success())),tr=new pi(((r,e,i)=>r.reset(e).require(ut,(s=>{i.id=s})).optional("fixed_height",(s=>{i.constantHeight=s}),Gt.decodeMetricHeight).geometry((s=>{i.bounds=s}),rc).success()),((r,e,i)=>r.reset(e).require(ut,(s=>{i.id=s})).require("elevation_idx",(s=>{i.idx=s})).require("extent",(s=>{i.extent=s})).require("height",(s=>{i.height=s}),Gt.decodeMetricHeight).geometry((s=>{i.position=s}),Gt.getPoint).success()));class Gt{static getPoint(e){return Jr(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?tr:void 0:vi}static parse(e){const i=[],s=[],a=e.length,u=new zt;for(let h=0;h<a;h++){const f=e.feature(h),_=f.properties.version,g=Gt.getVersionSchema(_);if(g===void 0){Mt("Unknown elevation feature version number ".concat(_||"(unknown)"));continue}const v=f.properties.type;if(!v)continue;const b=je.types[f.type];if(b==="Point"&&v==="curve_point"){const w={};g.parseVertex(u,f,w)&&i.push(w)}else if(b==="Polygon"&&v==="curve_meta"){const w={};g.parseFeature(u,f,w)&&s.push(w)}}return{vertices:i,features:s}}}class xi{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=Es(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,!0}}class ti{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const a=Qi(i,this.dir);if(Math.abs(a)<1e-6)return!1;const u=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return s[0]=this.pos[0]+this.dir[0]*u,s[1]=this.pos[1]+this.dir[1]*u,s[2]=this.pos[2]+this.dir[2]*u,!0}closestPointOnSphere(e,i,s){if((function(I,A){var R=I[0],L=I[1],k=I[2],U=A[0],G=A[1],q=A[2];return Math.abs(R-U)<=Oe*Math.max(1,Math.abs(R),Math.abs(U))&&Math.abs(L-G)<=Oe*Math.max(1,Math.abs(L),Math.abs(G))&&Math.abs(k-q)<=Oe*Math.max(1,Math.abs(k),Math.abs(q))})(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;const[a,u,h]=this.dir,f=this.pos[0]-e[0],_=this.pos[1]-e[1],g=this.pos[2]-e[2],v=a*a+u*u+h*h,b=2*(f*a+_*u+g*h),w=b*b-4*v*(f*f+_*_+g*g-i*i);if(w<0){const I=Math.max(-b/2,0),A=f+a*I,R=_+u*I,L=g+h*I,k=Math.hypot(A,R,L);return s[0]=A*i/k,s[1]=R*i/k,s[2]=L*i/k,!1}{const I=(-b-Math.sqrt(w))/(2*v);if(I<0){const A=Math.hypot(f,_,g);return s[0]=f*i/A,s[1]=_*i/A,s[2]=g*i/A,!1}return s[0]=f+a*I,s[1]=_+u*I,s[2]=g+h*I,!0}}}class Zi{constructor(e,i,s,a,u){this.TL=e,this.TR=i,this.BR=s,this.BL=a,this.horizon=u}static fromInvProjectionMatrix(e,i,s){const a=[-1,1,1],u=[1,1,1],h=[1,-1,1],f=[-1,-1,1],_=dr(a,a,e),g=dr(u,u,e),v=dr(h,h,e),b=dr(f,f,e);return new Zi(_,g,v,b,i/s)}}function bi(r,e,i){let s=1/0,a=-1/0;const u=[];for(const h of r){Rr(u,h,e);const f=Qi(u,i);s=Math.min(s,f),a=Math.max(a,f)}return[s,a]}function cr(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){const a=r.planes[s];let u=0;for(let h=0;h<e.length;h++)u+=+(Qi(a,e[h])+a[3]>=0);if(u===0)return 0;u!==e.length&&(i=!1)}return i?2:1}function Pi(r,e){for(const i of r.projections){const s=bi(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function ii(r,e){let i=0;const s=[0,0,0,0];for(let h=0;h<r.length;h++)s[0]=r[h][0],s[1]=r[h][1],s[2]=r[h][2],s[3]=1,(a=s)[0]*(u=e)[0]+a[1]*u[1]+a[2]*u[2]+a[3]*u[3]>=0&&i++;var a,u;return i}class Ni{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=si.fromPoints(this.points),this.projections=[],this.frustumEdges=[Rr([],this.points[2],this.points[3]),Rr([],this.points[0],this.points[3]),Rr([],this.points[4],this.points[0]),Rr([],this.points[5],this.points[1]),Rr([],this.points[6],this.points[2]),Rr([],this.points[7],this.points[3])];for(const s of this.frustumEdges){const a=[0,-s[2],s[1]],u=[s[2],0,-s[0]];this.projections.push({axis:a,projection:bi(this.points,this.points[0],a)}),this.projections.push({axis:u,projection:bi(this.points,this.points[0],u)})}}static fromInvProjectionMatrix(e,i,s,a){const u=Math.pow(2,s),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((g=>{const v=En([],g,e),b=1/v[3]/i*u;return(w=v)[0]=(I=v)[0]*(A=[b,b,a?1/v[3]:b,b])[0],w[1]=I[1]*A[1],w[2]=I[2]*A[2],w[3]=I[3]*A[3],w;var w,I,A})),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((g=>{const v=Yi([],Fr([],Rr([],h[g[0]],h[g[1]]),Rr([],h[g[2]],h[g[1]]))),b=-Qi(v,h[g[1]]);return v.concat(b)})),_=[];for(let g=0;g<h.length;g++)_.push([h[g][0],h[g][1],h[g][2]]);return new Ni(_,f)}intersectsPrecise(e,i,s){for(let a=0;a<i.length;a++)if(!ii(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!ii(e,this.planes[a]))return 0;for(const a of s)for(const u of this.frustumEdges){const h=Fr([],a,u),f=ir(h);if(f===0)continue;Xi(h,h,1/f);const _=bi(this.points,this.points[0],h),g=bi(e,this.points[0],h);if(_[0]>g[1]||g[0]>_[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const s=i[3];if(Qi([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class si{static fromPoints(e){const i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(const a of e)hr(i,i,a),dn(s,s,a);return new si(i,s)}static fromTileIdAndHeight(e,i,s){const a=1<<e.canonical.z,u=e.canonical.x,h=e.canonical.y;return new si([u/a,h/a,i],[(u+1)/a,(h+1)/a,s])}static applyTransform(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)dr(s[a],s[a],i);return si.fromPoints(s)}static applyTransformFast(e,i){const s=[i[12],i[13],i[14]],a=[...s];for(let u=0;u<3;u++)for(let h=0;h<3;h++){const f=i[4*h+u],_=f*e.min[h],g=f*e.max[h];s[u]+=Math.min(_,g),a[u]+=Math.max(_,g)}return new si(s,a)}static projectAabbCorners(e,i){const s=e.getCorners();for(let a=0;a<s.length;++a)dr(s[a],s[a],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=Xi([],ar([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=wr(this.min),a=wr(this.max);for(let u=0;u<i.length;u++)s[u]=i[u]?this.min[u]:this.center[u],a[u]=i[u]?this.center[u]:this.max[u];return a[2]=this.max[2],new si(s,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?cr(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?cr(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Pi(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Pi(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}mt(si,"Aabb");class br{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,s=i[1],a=-i[0],u=(e.extent+1)*this.metersToTile;return[new Be(Math.trunc(e.position[0]+s*u),Math.trunc(e.position[1]+a*u)),new Be(Math.trunc(e.position[0]-s*u),Math.trunc(e.position[1]-a*u))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ui{constructor(e,i,s,a,u,h){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[Ki(),Ki(),Ki(),Ki(),Ki(),Ki(),Ki()],this.id=e,this.heightRange={min:s,max:s},this.safeArea=i,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=u,this.edges=this.edges.filter((f=>{return f.a<this.vertices.length&&f.b<this.vertices.length&&!((_=this.vertices[f.a].position)[0]===(g=this.vertices[f.b].position)[0]&&_[1]===g[1]);var _,g})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const f of this.vertices)this.vertexProps.push({dir:Jr(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,f.height),this.heightRange.max=Math.max(this.heightRange.max,f.height);for(const f of this.edges){const _=this.vertices[f.a].position,g=this.vertices[f.b].position,v=Jn(Ki(),g,_),b=fr(v),w=zn(Ki(),v,1/b);this.edgeProps.push({vec:v,dir:w,len:b});const I=this.vertexProps[f.a].dir,A=this.vertexProps[f.b].dir;Dn(I,I,w),Dn(A,A,w)}for(const f of this.vertexProps)f.dir[0]===0&&f.dir[1]===0||fn(f.dir,f.dir);this.tessellate(h)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[s,a]=i;return Vt(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,a)}computeSlopeNormal(e,i){const s=this.getClosestEdge(e);if(!s)return qi(0,0,1);const a=s[0],u=this.edges[a],h=this.edgeProps[a].vec,f=qi(h[0],h[1],(this.vertices[u.b].height-this.vertices[u.a].height)*i),_=qi(f[1],-f[0],0);Fr(_,_,f);const g=ir(_);return g>0?Xi(_,_,1/g):di(_,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,s=Number.POSITIVE_INFINITY,a=0;const[u,h,f,_,g,v,b]=this._tmpVec2;Os(b,e.x,e.y);const w=new xi(b,null);for(let I=0;I<this.edges.length;I++){const A=this.edges[I],R=this.edgeProps[I].dir;w.dir=R;const L=this.vertices[A.a].position,k=this.vertices[A.b].position,U=w.intersectsPlane(L,this.vertexProps[A.a].dir,u),G=w.intersectsPlane(k,this.vertexProps[A.b].dir,h);if(!U||!G)continue;Jn(f,h,u),Jn(_,b,u);const q=Es(f,f),ie=q>0?Es(_,f)/q:0,J=B(ie,0,1),se=Math.abs((ie-J)*this.edgeProps[I].len);Jn(g,b,L),Os(v,R[1],-R[0]);const le=se+Math.abs(Es(g,v));le<s&&(i=I,s=le,a=J)}return[i,a]}tessellate(e){const i=Pt(),s=Pt(),a=Pt(),u=Pt();for(let h=this.edges.length-1;h>=0;--h){const f=this.edges[h].a,_=this.edges[h].b,{position:g,height:v,extent:b}=this.vertices[f],{position:w,height:I,extent:A}=this.vertices[_],R=this.vertexProps[f].dir,L=this.vertexProps[_].dir;if(di(i,g[0]/e,g[1]/e,v),di(s,w[0]/e,w[1]/e,I),di(a,R[1],-R[0],0),Xi(a,a,b),di(u,L[1],-L[0],0),Xi(u,u,A),this.distSqLines(qi(i[0]+.5*a[0],i[1]+.5*a[1],i[2]+.5*a[2]),qi(s[0]-.5*u[0],s[1]-.5*u[1],s[2]-.5*u[2]),qi(i[0]-.5*a[0],i[1]-.5*a[1],i[2]-.5*a[2]),qi(s[0]+.5*u[0],s[1]+.5*u[1],s[2]+.5*u[2]))<=.0025000000000000005)continue;const k=this.vertices.length,U=Dn(Ki(),g,w);this.vertices.push({position:zn(U,U,.5),height:.5*(v+I),extent:.5*(b+A)});const G=Dn(Ki(),R,L);this.vertexProps.push({dir:fn(G,G)}),this.edges.splice(h,1),this.edgeProps.splice(h,1),this.edges.push({a:f,b:k}),this.edges.push({a:k,b:_});const q=Jn(Ki(),this.vertices[k].position,g),ie=fr(q),J={vec:q,dir:zn(Ki(),q,1/ie),len:ie};this.edgeProps.push(J),this.edgeProps.push(J)}}distSqLines(e,i,s,a){const u=Wr(Pt(),i,e),h=Wr(Pt(),a,s),f=Wr(Pt(),e,s),_=Qi(u,u),g=Qi(u,h),v=Qi(u,f),b=Qi(h,h),w=Qi(h,f),I=_*b-g*g;if(I===0)return xn(Xn(u,s,a,Qi(f,h)/Qi(h,h)),e);const A=(_*w-g*v)/I;return xn(Xn(u,e,i,(g*w-v*b)/I),Xn(h,s,a,A))}}class qt{static parseFrom(e,i){const s=Gt.parse(e);if(!s)return[];let{vertices:a,features:u}=s;const h=1/ne(i);u.sort(((v,b)=>v.id-b.id)),a.sort(((v,b)=>v.id-b.id||v.idx-b.idx)),a=a.filter(((v,b,w)=>b===w.findIndex((I=>I.id===v.id&&I.idx===v.idx))));const f=new Array;let _=0;const g=a.length;for(const v of u){if(v.constantHeight){f.push(new Ui(v.id,v.bounds,v.constantHeight));continue}for(;_!==g&&a[_].id<v.id;)_++;if(_===g||a[_].id!==v.id)continue;const b=new Array,w=new Array,I=_;for(;_!==g&&a[_].id===v.id;){const A=a[_];if(b.push({position:A.position,height:A.height,extent:A.extent}),_!==I&&a[_-1].idx===A.idx-1){const R=_-I;w.push({a:R-1,b:R})}_++}f.push(new Ui(v.id,v.bounds,void 0,b,w,h))}return f}static getElevationFeature(e,i){if(!i)return;const s=+e.properties[ut];return Number.isNaN(s)?void 0:i.find((a=>a.id===s))}}class Ti{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*it,this.yOffset=(e.y*this.zScale-i.y)*it)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,s){const a=this.constantElevation(i,s);return a!=null?a:(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),s))}computeBiasedHeight(e,i){return i<=0?e:e+i*X(0,i,e>=0?e:Math.abs(.5*e))}}mt(Ui,"ElevationFeature");class Or{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ps,this.indexArray=new zr,this.segments=new Vr,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Wo),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){const u=this.layers[0],h=[];let f=null;u.type==="circle"&&(f=u.layout.get("circle-sort-key"));for(const{feature:g,id:v,index:b,sourceLayerIndex:w}of e){const I=this.layers[0]._featureFilter.needGeometry,A=Te(g,I);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),A,s))continue;const R=f?f.evaluate(A,{},s):void 0,L={id:v,properties:g.properties,type:g.type,sourceLayerIndex:w,index:b,geometry:I?A.geometry:Le(g,s,a),patterns:{},sortKey:R};h.push(L)}f&&h.sort(((g,v)=>g.sortKey-v.sortKey));let _=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new Su,_=a.projection);for(const g of h){const{geometry:v,index:b,sourceLayerIndex:w}=g,I=e[b].feature;this.addFeature(g,v,b,i.availableImages,s,_,i.brightness,i.elevationFeatures),i.featureIndex.insert(I,v,b,w,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,up.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Zm.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,$m.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,s,a,u,h,f,_){let g;this.elevationMode!=="none"&&(g=qt.getElevationFeature(e,_));for(const v of i)for(const b of v){const w=b.x,I=b.y;if(w<0||w>=it||I<0||I>=it)continue;if(h){const L=h.projectTilePoint(w,I,u),k=h.upVector(u,w,I);this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k),this.addGlobeExtVertex(L,k)}const A=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),R=A.vertexLength;if(this.addCircleVertex(w,I,-1,-1),this.addCircleVertex(w,I,1,-1),this.addCircleVertex(w,I,1,1),this.addCircleVertex(w,I,-1,1),this.elevationMode!=="none"){const L=g?g.pointElevation(new Be(w,I)):0;this.hasElevation=this.hasElevation||L!==0;for(let k=0;k<4;k++)this.elevatedLayoutVertexArray.emplaceBack(L)}this.indexArray.emplaceBack(R,R+1,R+2),this.indexArray.emplaceBack(R,R+2,R+3),A.vertexLength+=4,A.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},a,u,f,void 0,this.worldview)}addCircleVertex(e,i,s,a){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function tn(r,e){for(let i=0;i<r.length;i++)if(Fn(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(Fn(r,e[i]))return!0;return!!ws(r,e)}function Ur(r,e,i){return!!Fn(r,e)||!!is(e,r,i)}function Zr(r,e){if(r.length===1)return bo(e,r[0]);for(let i=0;i<e.length;i++){const s=e[i];for(let a=0;a<s.length;a++)if(Fn(r,s[a]))return!0}for(let i=0;i<r.length;i++)if(bo(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(ws(r,e[i]))return!0;return!1}function Ds(r,e,i){if(r.length>1){if(ws(r,e))return!0;for(let s=0;s<e.length;s++)if(is(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(is(r[s],e,i))return!0;return!1}function ws(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){const s=r[i],a=r[i+1];for(let u=0;u<e.length-1;u++)if(ts(s,a,e[u],e[u+1]))return!0}return!1}function ts(r,e,i,s){return ei(r,i,s)!==ei(e,i,s)&&ei(r,e,i)!==ei(r,e,s)}function cs(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function Ks(r,e,i,s){const a=cs(r,e,s),u=cs(r,e,i);if(Math.sign(a)===Math.sign(u))return;const h=cs(i,s,r),f=h+u-a;return Math.sign(h)!==Math.sign(f)?[h/(h-f),u/(u-a)]:void 0}function is(r,e,i){const s=i*i;if(e.length===1)return r.distSqr(e[0])<s;for(let a=1;a<e.length;a++)if(Js(r,e[a-1],e[a])<s)return!0;return!1}function Js(r,e,i){const s=e.distSqr(i);if(s===0)return r.distSqr(e);const a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function bo(r,e){let i,s,a,u=!1;for(let h=0;h<r.length;h++){i=r[h];for(let f=0,_=i.length-1;f<i.length;_=f++)s=i[f],a=i[_],s.y>e.y!=a.y>e.y&&e.x<(a.x-s.x)*(e.y-s.y)/(a.y-s.y)+s.x&&(u=!u)}return u}function Fn(r,e){let i=!1;for(let s=0,a=r.length-1;s<r.length;a=s++){const u=r[s],h=r[a];u.y>e.y!=h.y>e.y&&e.x<(h.x-u.x)*(e.y-u.y)/(h.y-u.y)+u.x&&(i=!i)}return i}function Gr(r,e,i,s,a){for(const h of r)if(e<=h.x&&i<=h.y&&s>=h.x&&a>=h.y)return!0;const u=[new Be(e,i),new Be(e,a),new Be(s,a),new Be(s,i)];if(r.length>2){for(const h of u)if(Fn(r,h))return!0}for(let h=0;h<r.length-1;h++)if(rn(r[h],r[h+1],u))return!0;return!1}function rn(r,e,i){const s=i[0],a=i[2];if(r.x<s.x&&e.x<s.x||r.x>a.x&&e.x>a.x||r.y<s.y&&e.y<s.y||r.y>a.y&&e.y>a.y)return!1;const u=ei(r,e,i[0]);return u!==ei(r,e,i[1])||u!==ei(r,e,i[2])||u!==ei(r,e,i[3])}function or(r,e,i,s,a,u){let h=e.y-r.y,f=r.x-e.x;if(u=u||0){const _=h*h+f*f;if(_===0)return!0;const g=Math.sqrt(_);h/=g,f/=g}return!((i.x-r.x)*h+(i.y-r.y)*f-u<0||(s.x-r.x)*h+(s.y-r.y)*f-u<0||(a.x-r.x)*h+(a.y-r.y)*f-u<0)}function an(r,e,i,s,a,u,h){return!(or(r,e,s,a,u,h)||or(e,i,s,a,u,h)||or(i,r,s,a,u,h)||or(s,a,r,e,i,h)||or(a,u,r,e,i,h)||or(u,s,r,e,i,h))}function Bn(r,e,i){const s=e.paint.get(r).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Hr(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function Qs(r,e,i,s,a){if(!e[0]&&!e[1])return r;const u=Be.convert(e)._mult(a);i==="viewport"&&u._rotate(-s);const h=[];for(let f=0;f<r.length;f++)h.push(r[f].sub(u));return h}function Al(r,e,i,s){const a=Be.convert(r)._mult(s);return e==="viewport"&&a._rotate(-i),a}let Ko,Ml;function Cl(r,e,i){var s=2*Math.PI*6378137/256/Math.pow(2,i);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}mt(Or,"CircleBucket",{omit:["layers"]});class eo{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=to(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const s=(function(u,h,f){var _=Cl(256*u,256*(h=Math.pow(2,f)-h-1),f),g=Cl(256*(u+1),256*(h+1),f);return _[0]+","+_[1]+","+g[0]+","+g[1]})(this.x,this.y,this.z),a=(function(u,h,f){let _,g="";for(let v=u;v>0;v--)_=1<<v-1,g+=(h&_?1:0)+(f&_?2:0);return g})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",s)}toString(){return"".concat(this.z,"/").concat(this.x,"/").concat(this.y)}}class Fo{constructor(e,i){this.wrap=e,this.canonical=i,this.key=to(e,i.z,i.z,i.x,i.y)}}class Rn{constructor(e,i,s,a,u){this.overscaledZ=e,this.wrap=i,this.canonical=new eo(s,+a,+u),this.key=i===0&&e===s?this.canonical.key:to(i,e,s,a,u)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new Rn(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Rn(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return to(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return to(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Rn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,s=2*this.canonical.x,a=2*this.canonical.y;return[new Rn(i,this.wrap,i,s,a),new Rn(i,this.wrap,i,s+1,a),new Rn(i,this.wrap,i,s,a+1),new Rn(i,this.wrap,i,s+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Rn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Rn(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Fo(this.wrap,this.canonical)}toString(){return"".concat(this.overscaledZ,"/").concat(this.canonical.x,"/").concat(this.canonical.y)}}function to(r,e,i,s,a){const u=1<<Math.min(i,22);let h=u*(a%u)+s%u;return r&&i<22&&(h+=u*u*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const Va=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new Rn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new Rn(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new Rn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new Rn(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];mt(eo,"CanonicalTileID"),mt(Rn,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const pp=fi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:ku}=pp,Rb=fi([{name:"a_pos_3",components:3,type:"Int16"}]);var Zg=fi([{name:"a_pos",type:"Int16",components:2}]);function mp(r){return r*Rs/T}const Db=[new si([p,p,p],[m,m,m]),new si([p,p,p],[0,0,m]),new si([0,p,p],[m,0,m]),new si([p,0,p],[0,m,m]),new si([0,0,p],[m,m,m])];function Wg(r,e,i,s=!0){const a=Xi([],r._camera.position,r.worldSize),u=[e,i,1,1];En(u,u,r.pixelMatrixInverse),ps(u,u,1/u[3]);const h=Yi([],Rr([],u,a)),f=r.globeMatrix,_=[f[12],f[13],f[14]],g=Rr([],_,a),v=ir(g),b=Yi([],g),w=r.worldSize/(2*Math.PI),I=Qi(b,h),A=Math.asin(w/v);if(A<Math.acos(I)){if(!s)return null;const Ce=[],ye=[];Xi(Ce,h,v/I),Yi(ye,Rr(ye,Ce,g)),Yi(h,ar(h,g,Xi(h,ye,Math.tan(A)*v)))}const R=[];new ti(a,h).closestPointOnSphere(_,w,R);const L=Yi([],Er(f,0)),k=Yi([],Er(f,1)),U=Yi([],Er(f,2)),G=Qi(L,R),q=Qi(k,R),ie=Qi(U,R),J=Qr(Math.asin(-q/w));let se=Qr(Math.atan2(G,ie));se=r.center.lng+(function(Ce,ye){const Pe=(ye-Ce+180)%360-180;return Pe<-180?Pe+360:Pe})(r.center.lng,se);const le=V(se),he=B(N(J),0,1);return new _e(le,he)}class zb{constructor(e,i,s){this.a=Rr([],e,s),this.b=Rr([],i,s),this.center=s;const a=Yi([],this.a),u=Yi([],this.b);this.angle=Math.acos(Qi(a,u))}}function i_(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:(function(s,a,u,h){const f=Math.sin(u);return s*(Math.sin((1-h)*u)/f)+a*(Math.sin(h*u)/f)})(r.a[e],r.b[e],r.angle,B(i,0,1))+r.center[e]}function _a(r){if(r.z<=1)return Db[r.z+2*r.y+r.x];const e=r_(_p(r));return si.fromPoints(e)}function Ua(r,e,i){return Xi(r,r,1-i),ns(r,r,e,i)}function Xg(r,e,i){for(const s of r)dr(s,s,e),Xi(s,s,i)}function Yg(r,e,i,s){const a=e/r.worldSize,u=r.globeMatrix;if(i.z<=1){const he=_a(i).getCorners();return Xg(he,u,a),si.fromPoints(he)}const h=_p(i,s),f=r_(h,Rs+mp(r._tileCoverLift));Xg(f,u,a);const _=Number.MAX_VALUE,g=[-_,-_,-_],v=[_,_,_];if(h.contains(r.center)){for(const ye of f)hr(v,v,ye),dn(g,g,ye);g[2]=0;const he=r.point,Ce=[he.x*a,he.y*a,0];return hr(v,v,Ce),dn(g,g,Ce),new si(v,g)}if(r._tileCoverLift>0){for(const he of f)hr(v,v,he),dn(g,g,he);return new si(v,g)}const b=[u[12]*a,u[13]*a,u[14]*a],w=h.getCenter(),I=B(r.center.lat,-W,W),A=B(w.lat,-W,W),R=V(r.center.lng),L=N(I);let k=R-V(w.lng);const U=L-N(A);k>.5?k-=1:k<-.5&&(k+=1);let G=0;Math.abs(k)>Math.abs(U)?G=k>=0?1:3:(G=U>=0?0:2,ns(b,b,[u[4]*a,u[5]*a,u[6]*a],-Math.sin(Qt(U>=0?h.getSouth():h.getNorth()))*Rs));const q=f[G],ie=f[(G+1)%4],J=new zb(q,ie,b),se=[i_(J,0)||q[0],i_(J,1)||q[1],i_(J,2)||q[2]],le=Pl(r.zoom);if(le>0){const he=(function({x:ye,y:Pe,z:ke},Ve,Qe,qe,Fe){const He=1/(1<<ke);let Ae=ye*He,Ee=Ae+He,Ge=Pe*He,Ye=Ge+He,Ne=0;const pt=(Ae+Ee)/2-qe;return pt>.5?Ne=-1:pt<-.5&&(Ne=1),Ae=((Ae+Ne)*Ve-(qe*=Ve))*Qe+qe,Ee=((Ee+Ne)*Ve-qe)*Qe+qe,Ge=(Ge*Ve-(Fe*=Ve))*Qe+Fe,Ye=(Ye*Ve-Fe)*Qe+Fe,[[Ae,Ye,0],[Ee,Ye,0],[Ee,Ge,0],[Ae,Ge,0]]})(i,e,r._pixelsPerMercatorPixel,R,L);for(let ye=0;ye<f.length;ye++)Ua(f[ye],he[ye],le);const Ce=ar([],he[G],he[(G+1)%4]);Xi(Ce,Ce,.5),Ua(se,Ce,le)}for(const he of f)hr(v,v,he),dn(g,g,he);return v[2]=Math.min(q[2],ie[2]),hr(v,v,se),dn(g,g,se),new si(v,g)}function _p({x:r,y:e,z:i},s=!1){const a=1/(1<<i),u=new M(Z(r*a),e===(1<<i)-1&&s?-90:H((e+1)*a)),h=new M(Z((r+1)*a),e===0&&s?90:H(e*a));return new E(u,h)}function r_(r,e=Rs){const i=Qt(r.getNorth()),s=Qt(r.getSouth()),a=Math.cos(i),u=Math.cos(s),h=Math.sin(i),f=Math.sin(s),_=r.getWest(),g=r.getEast();return[y(u,f,_,e),y(u,f,g,e),y(a,h,g,e),y(a,h,_,e)]}function Td(r,e,i,s){const a=1<<i.z,u=(r/it+i.x)/a;return x(H((e/it+i.y)/a),Z(u),s)}function gp({min:r,max:e}){return n/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const Kg=new Float64Array(16);function yp(r){const e=gp(r),i=Ii(Kg,[e,e,e]);return gi(i,i,ss([],r.min))}function n_(r){const e=(s=r.min,(i=Kg)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i);var i,s;const a=1/gp(r);return hi(e,e,[a,a,a])}function s_(r){const e=it/(2*Math.PI);return r/(2*Math.PI)/e}function Jg(r,e){return it/(512*Math.pow(2,r))*gp(_a(e))}function Qg(r,e,i,s,a){const u=s_(i),h=[r,e,-i/(2*Math.PI)],f=Ot(new Float64Array(16));return gi(f,f,h),hi(f,f,[u,u,u]),Wi(f,f,Qt(-a)),ci(f,f,Qt(-s)),f}function Pl(r){return X(l,t,r)}function ey(r,e){const i=x(e.lat,e.lng),s=(function(A){const R=x(A._center.lat,A._center.lng);let L=Fr([],qi(0,1,0),R);const k=xr([],-A.angle,R);L=dr(L,L,k),xr(k,-A._pitch,L);const U=Yi([],R);return Xi(U,U,mp(A.cameraToCenterDistance/A.pixelsPerMeter)),dr(U,U,k),ar([],R,U)})(r);return h=(a=Wr([],s,i))[0],f=a[1],_=a[2],g=(u=i)[0],v=u[1],b=u[2],I=(w=Math.sqrt((h*h+f*f+_*_)*(g*g+v*v+b*b)))&&Qi(a,u)/w,Math.acos(Math.min(Math.max(I,-1),1));var a,u,h,f,_,g,v,b,w,I}function o_(r,e){return ey(r,e)>Math.PI/2*1.01}const ty=Qt(85),Lb=Math.cos(ty),Ob=Math.sin(ty),kb=ai(),iy=r=>{const e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function ry(r,e,i,s,a,u,h,f,_){if(u&&r.queryGeometry.isAboveHorizon)return!1;u&&(_*=r.pixelToTileUnitsFactor);const g=r.tileID.canonical,v=i.projection.upVectorScale(g,i.center.lat,i.worldSize).metersToTile;for(const b of e)for(const w of b){const I=w.add(f),A=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(I.x,I.y,!0):0,R=i.projection.projectTilePoint(I.x,I.y,g);if(A>0){const G=i.projection.upVector(g,I.x,I.y);R.x+=G[0]*v*A,R.y+=G[1]*v*A,R.z+=G[2]*v*A}const L=u?I:Fb(R.x,R.y,R.z,s),k=u?r.tilespaceRays.map((G=>Nb(G,A))):r.queryGeometry.screenGeometry,U=En([],[R.x,R.y,R.z,1],s);if(!h&&u?_*=U[3]/i.cameraToCenterDistance:h&&!u&&(_*=i.cameraToCenterDistance/U[3]),u){const G=H((w.y/it+g.y)/(1<<g.z));_/=i.projection.pixelsPerMeter(G,1)/j(1,G)}if(Ur(k,L,_))return!0}return!1}function Fb(r,e,i,s){const a=En([],[r,e,i,1],s);return new Be(a[0]/a[3],a[1]/a[3])}const ny=qi(0,0,0),Bb=qi(0,0,1);function Nb(r,e){const i=Pt();return ny[2]=e,r.intersectsPlane(ny,Bb,i),new Be(i[0],i[1])}class sy extends Or{}let oy,ay,ly,cy;function uy(r,{width:e,height:i},s,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*s)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=a,r}function hy(r,e,i){const{width:s,height:a}=e;s===r.width&&a===r.height||(a_(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,a)},i,null),r.width=s,r.height=a,r.data=e.data)}function a_(r,e,i,s,a,u,h,f){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||s.x>e.width-a.width||s.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const _=r.data,g=e.data,v=u===4&&f;for(let b=0;b<a.height;b++){const w=((i.y+b)*r.width+i.x)*u,I=((s.y+b)*e.width+s.x)*u;if(v)for(let A=0;A<a.width;A++){const R=w+A*u+3,L=I+A*u;g[L+0]=255,g[L+1]=255,g[L+2]=255,g[L+3]=_[R]}else if(h)for(let A=0;A<a.width;A++){const R=w+A*u,L=I+A*u,k=new Gi(_[R+0]/255,_[R+1]/255,_[R+2]/255,_[R+3]).toNonPremultipliedRenderColor(h).toArray();g[L+0]=k[0],g[L+1]=k[1],g[L+2]=k[2],g[L+3]=k[3]}else for(let A=0;A<a.width*u;A++)g[I+A]=_[w+A]}return e}mt(sy,"HeatmapBucket",{omit:["layers"]});class Rl{constructor(e,i){uy(this,e,1,i)}resize(e){hy(this,new Rl(e),1)}clone(){return new Rl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u){a_(e,i,s,a,u,1,null)}}class us{constructor(e,i){uy(this,e,4,i)}resize(e){hy(this,new us(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new us({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,u,h,f){a_(e,i,s,a,u,4,h,f)}}class dy{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Sd(r){const e={},i=r.resolution||256,s=r.clips?r.clips.length:1,a=r.image||new us({width:i,height:s}),u=(h,f,_)=>{e[r.evaluationKey]=_;const g=r.expression.evaluate(e),v=g?g.toNonPremultipliedRenderColor(null):null;v&&(a.data[h+f+0]=Math.floor(255*v.r),a.data[h+f+1]=Math.floor(255*v.g),a.data[h+f+2]=Math.floor(255*v.b),a.data[h+f+3]=Math.floor(255*v.a))};if(r.clips)for(let h=0,f=0;h<s;++h,f+=4*i)for(let _=0,g=0;_<i;_++,g+=4){const v=_/(i-1),{start:b,end:w}=r.clips[h];u(f,g,b*(1-v)+w*v)}else for(let h=0,f=0;h<i;h++,f+=4)u(0,f,h/(i-1));return a}mt(Rl,"AlphaImage"),mt(us,"RGBAImage");const Vb=fi([{name:"a_pos",components:2,type:"Int16"}],4),Ub=fi([{name:"a_road_z_offset",components:1,type:"Float32"}],4),jb=fi([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Gb=fi([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Fu(r,e,i=2){const s=e&&e.length,a=s?e[0]*i:r.length;let u=fy(r,0,a,i,!0);const h=[];if(!u||u.next===u.prev)return h;let f,_,g;if(s&&(u=(function(v,b,w,I){const A=[];for(let R=0,L=b.length;R<L;R++){const k=fy(v,b[R]*I,R<L-1?b[R+1]*I:v.length,I,!1);k===k.next&&(k.steiner=!0),A.push(Kb(k))}A.sort(Wb);for(let R=0;R<A.length;R++)w=Xb(A[R],w);return w})(r,e,u,i)),r.length>80*i){f=r[0],_=r[1];let v=f,b=_;for(let w=i;w<a;w+=i){const I=r[w],A=r[w+1];I<f&&(f=I),A<_&&(_=A),I>v&&(v=I),A>b&&(b=A)}g=Math.max(v-f,b-_),g=g!==0?32767/g:0}return Ed(u,h,i,f,_,g,0),h}function fy(r,e,i,s,a){let u;if(a===(function(h,f,_,g){let v=0;for(let b=f,w=_-g;b<_;b+=g)v+=(h[w]-h[b])*(h[b+1]+h[w+1]),w=b;return v})(r,e,i,s)>0)for(let h=e;h<i;h+=s)u=gy(h/s|0,r[h],r[h+1],u);else for(let h=i-s;h>=e;h-=s)u=gy(h/s|0,r[h],r[h+1],u);return u&&Bu(u,u.next)&&(Md(u),u=u.next),u}function Ic(r,e){if(!r)return r;e||(e=r);let i,s=r;do if(i=!1,s.steiner||!Bu(s,s.next)&&Nn(s.prev,s,s.next)!==0)s=s.next;else{if(Md(s),s=e=s.prev,s===s.next)break;i=!0}while(i||s!==e);return e}function Ed(r,e,i,s,a,u,h){if(!r)return;!h&&u&&(function(_,g,v,b){let w=_;do w.z===0&&(w.z=l_(w.x,w.y,g,v,b)),w.prevZ=w.prev,w.nextZ=w.next,w=w.next;while(w!==_);w.prevZ.nextZ=null,w.prevZ=null,(function(I){let A,R=1;do{let L,k=I;I=null;let U=null;for(A=0;k;){A++;let G=k,q=0;for(let J=0;J<R&&(q++,G=G.nextZ,G);J++);let ie=R;for(;q>0||ie>0&&G;)q!==0&&(ie===0||!G||k.z<=G.z)?(L=k,k=k.nextZ,q--):(L=G,G=G.nextZ,ie--),U?U.nextZ=L:I=L,L.prevZ=U,U=L;k=G}U.nextZ=null,R*=2}while(A>1)})(w)})(r,s,a,u);let f=r;for(;r.prev!==r.next;){const _=r.prev,g=r.next;if(u?qb(r,s,a,u):Hb(r))e.push(_.i,r.i,g.i),Md(r),r=g.next,f=g.next;else if((r=g)===f){h?h===1?Ed(r=$b(Ic(r),e),e,i,s,a,u,2):h===2&&Zb(r,e,i,s,a,u):Ed(Ic(r),e,i,s,a,u,1);break}}}function Hb(r){const e=r.prev,i=r,s=r.next;if(Nn(e,i,s)>=0)return!1;const a=e.x,u=i.x,h=s.x,f=e.y,_=i.y,g=s.y,v=Math.min(a,u,h),b=Math.min(f,_,g),w=Math.max(a,u,h),I=Math.max(f,_,g);let A=s.next;for(;A!==e;){if(A.x>=v&&A.x<=w&&A.y>=b&&A.y<=I&&Id(a,f,u,_,h,g,A.x,A.y)&&Nn(A.prev,A,A.next)>=0)return!1;A=A.next}return!0}function qb(r,e,i,s){const a=r.prev,u=r,h=r.next;if(Nn(a,u,h)>=0)return!1;const f=a.x,_=u.x,g=h.x,v=a.y,b=u.y,w=h.y,I=Math.min(f,_,g),A=Math.min(v,b,w),R=Math.max(f,_,g),L=Math.max(v,b,w),k=l_(I,A,e,i,s),U=l_(R,L,e,i,s);let G=r.prevZ,q=r.nextZ;for(;G&&G.z>=k&&q&&q.z<=U;){if(G.x>=I&&G.x<=R&&G.y>=A&&G.y<=L&&G!==a&&G!==h&&Id(f,v,_,b,g,w,G.x,G.y)&&Nn(G.prev,G,G.next)>=0||(G=G.prevZ,q.x>=I&&q.x<=R&&q.y>=A&&q.y<=L&&q!==a&&q!==h&&Id(f,v,_,b,g,w,q.x,q.y)&&Nn(q.prev,q,q.next)>=0))return!1;q=q.nextZ}for(;G&&G.z>=k;){if(G.x>=I&&G.x<=R&&G.y>=A&&G.y<=L&&G!==a&&G!==h&&Id(f,v,_,b,g,w,G.x,G.y)&&Nn(G.prev,G,G.next)>=0)return!1;G=G.prevZ}for(;q&&q.z<=U;){if(q.x>=I&&q.x<=R&&q.y>=A&&q.y<=L&&q!==a&&q!==h&&Id(f,v,_,b,g,w,q.x,q.y)&&Nn(q.prev,q,q.next)>=0)return!1;q=q.nextZ}return!0}function $b(r,e){let i=r;do{const s=i.prev,a=i.next.next;!Bu(s,a)&&my(s,i,i.next,a)&&Ad(s,a)&&Ad(a,s)&&(e.push(s.i,i.i,a.i),Md(i),Md(i.next),i=r=a),i=i.next}while(i!==r);return Ic(i)}function Zb(r,e,i,s,a,u){let h=r;do{let f=h.next.next;for(;f!==h.prev;){if(h.i!==f.i&&Jb(h,f)){let _=_y(h,f);return h=Ic(h,h.next),_=Ic(_,_.next),Ed(h,e,i,s,a,u,0),void Ed(_,e,i,s,a,u,0)}f=f.next}h=h.next}while(h!==r)}function Wb(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function Xb(r,e){const i=(function(a,u){let h=u;const f=a.x,_=a.y;let g,v=-1/0;if(Bu(a,h))return h;do{if(Bu(a,h.next))return h.next;if(_<=h.y&&_>=h.next.y&&h.next.y!==h.y){const R=h.x+(_-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(R<=f&&R>v&&(v=R,g=h.x<h.next.x?h:h.next,R===f))return g}h=h.next}while(h!==u);if(!g)return null;const b=g,w=g.x,I=g.y;let A=1/0;h=g;do{if(f>=h.x&&h.x>=w&&f!==h.x&&py(_<I?f:v,_,w,I,_<I?v:f,_,h.x,h.y)){const R=Math.abs(_-h.y)/(f-h.x);Ad(h,a)&&(R<A||R===A&&(h.x>g.x||h.x===g.x&&Yb(g,h)))&&(g=h,A=R)}h=h.next}while(h!==b);return g})(r,e);if(!i)return e;const s=_y(i,r);return Ic(s,s.next),Ic(i,i.next)}function Yb(r,e){return Nn(r.prev,r,e.prev)<0&&Nn(e.next,r,r.next)<0}function l_(r,e,i,s,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Kb(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function py(r,e,i,s,a,u,h,f){return(a-h)*(e-f)>=(r-h)*(u-f)&&(r-h)*(s-f)>=(i-h)*(e-f)&&(i-h)*(u-f)>=(a-h)*(s-f)}function Id(r,e,i,s,a,u,h,f){return!(r===h&&e===f)&&py(r,e,i,s,a,u,h,f)}function Jb(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!(function(i,s){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==s.i&&a.next.i!==s.i&&my(a,a.next,i,s))return!0;a=a.next}while(a!==i);return!1})(r,e)&&(Ad(r,e)&&Ad(e,r)&&(function(i,s){let a=i,u=!1;const h=(i.x+s.x)/2,f=(i.y+s.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&h<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(u=!u),a=a.next;while(a!==i);return u})(r,e)&&(Nn(r.prev,r,e.prev)||Nn(r,e.prev,e))||Bu(r,e)&&Nn(r.prev,r,r.next)>0&&Nn(e.prev,e,e.next)>0)}function Nn(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function Bu(r,e){return r.x===e.x&&r.y===e.y}function my(r,e,i,s){const a=vp(Nn(r,e,i)),u=vp(Nn(r,e,s)),h=vp(Nn(i,s,r)),f=vp(Nn(i,s,e));return a!==u&&h!==f||!(a!==0||!xp(r,i,e))||!(u!==0||!xp(r,s,e))||!(h!==0||!xp(i,r,s))||!(f!==0||!xp(i,e,s))}function xp(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function vp(r){return r>0?1:r<0?-1:0}function Ad(r,e){return Nn(r.prev,r,r.next)<0?Nn(r,e,r.next)>=0&&Nn(r,r.prev,e)>=0:Nn(r,e,r.prev)<0||Nn(r,r.next,e)<0}function _y(r,e){const i=c_(r.i,r.x,r.y),s=c_(e.i,e.x,e.y),a=r.next,u=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,s.next=i,i.prev=s,u.next=s,s.prev=u,s}function gy(r,e,i,s){const a=c_(r,e,i);return s?(a.next=s.next,a.prev=s,s.next.prev=a,s.next=a):(a.prev=a,a.next=a),a}function Md(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function c_(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Cd(r,e){const i=r.length;if(i<=1)return[r];const s=[];let a,u;for(let h=0;h<i;h++){const f=ri(r[h]);f!==0&&(r[h].area=Math.abs(f),u===void 0&&(u=f<0),u===f<0?(a&&s.push(a),a=[r[h]]):a.push(r[h]))}if(a&&s.push(a),e>1)for(let h=0;h<s.length;h++)s[h].length<=e||(Ho(s[h],e,1,s[h].length-1,Qb),s[h]=s[h].slice(0,e));return s}function Qb(r,e){return e.area-r.area}function yy(r,e,i=1){if(!r)return null;const s=typeof r=="string"?Cs.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(const u of[s,a]){if(!u)continue;const h=u.id.toString();e.has(h)||e.set(h,[]),u.scaleSelf(i),e.get(h).push(u)}return{primary:s.toString(),secondary:a?a.toString():null}}function u_(r,e,i,s){const a=s.patternDependencies;let u=!1;for(const h of e){const f=h.paint.get("".concat(r,"-pattern"));f.isConstant()||(u=!0),yy(f.constantOr(null),a,i)&&(u=!0)}return u}function h_(r,e,i,s,a,u){const h=u.patternDependencies;for(const f of e){const _=f.paint.get("".concat(r,"-pattern")).value;if(_.kind!=="constant"){let g=_.evaluate({zoom:s},i,{},u.availableImages);g=g&&g.name?g.name:g;const v=yy(g,h,a);if(!v)continue;const{primary:b,secondary:w}=v;b&&(i.patterns[f.id]=[b,w].filter(Boolean))}}return i}class xy{constructor(){this.polygons=new Map}add(e,...i){const s=this.polygons.get(e);s?s.push(...i):this.polygons.set(e,i)}merge(e){for(const[i,s]of e.polygons)this.add(i,...s)}}class ja{constructor(){this.portals=[]}static isOnBorder(e,i){return e<=0&&i<=0||e>=it&&i>=it}static evaluate(e){if(e.length===0)return new ja;let i=[];for(const _ of e)i.push(..._.portals);if(i.length===0)return new ja;for(const _ of i){const g=_.va,v=_.vb;(ja.isOnBorder(g.x,v.x)||ja.isOnBorder(g.y,v.y))&&(_.type="border")}const s=i.filter((_=>_.type!=="unevaluated")),a=i.filter((_=>_.type==="unevaluated"));if(a.length===0)return new ja;a.sort(((_,g)=>_.hash===g.hash?_.isTunnel===g.isTunnel?0:_.isTunnel?-1:1:_.hash<g.hash?1:-1)),i=s.concat(a);let u=s.length,h=u,f=u;do if(h++,h===i.length||i[u].hash!==i[h].hash){if(h-u==2){f<u&&(i[f]=i[u],i[u]=null);const _=i[f],g=i[h-1];_.type=_.isTunnel!==g.isTunnel?"tunnel":"polygon",_.connection={a:_.connection.a,b:g.connection.a},f++}u=h}while(u!==i.length);return i.splice(f),i.sort(((_,g)=>_.hash<g.hash?1:-1)),{portals:i}}}mt(ja,"ElevationPortalGraph"),mt(xy,"ElevationPolygons");class e1{constructor(e,i,s){this.outPositions=e,this.outNormals=i,this.outIndices=s,this.vertexLookup=new Map}addVertex(e,i,s){let a=e[2];s!=null&&(a*=s);const u="".concat(e[0],",").concat(e[1],",").concat(e[2],",").concat(i[0],",").concat(i[1],",").concat(i[2]),h=this.vertexLookup.get(u);if(h!=null)return h;const f=this.outPositions.length;this.vertexLookup.set(u,f);const _=Math.trunc(16384*i[0]),g=Math.trunc(16384*i[1]),v=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(_,g,v),f}addTriangle(e,i,s){this.outIndices.emplaceBack(e,i,s)}addTriangles(e,i,s){if(e.length===0)return;const a=s.length===1,u=Pt(),h=Pt();for(let f=0;f<e.length;f+=3){const _=i[e[f+0]],g=i[e[f+1]],v=i[e[f+2]],b=a?s[0]:s[e[f+1]],w=a?s[0]:s[e[f+2]];di(u,_.x,_.y,a?s[0]:s[e[f+0]]);const I=this.addVertex(u,h);di(u,g.x,g.y,b);const A=this.addVertex(u,h);di(u,v.x,v.y,w);const R=this.addVertex(u,h);this.outIndices.emplaceBack(I,A,R)}}addQuad(e,i,s,a,u,h){const f=this.addVertex(e,u,h),_=this.addVertex(i,u,h),g=this.addVertex(s,u,h),v=this.addVertex(a,u,h);this.addTriangle(f,_,g),this.addTriangle(g,v,f)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class io{constructor(e,i,s,a){this.unevaluatedPortals=new ja,this.portalPolygons=new xy,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new sd,this.vertexNormals=new od,this.indexArray=new zr,this.tileToMeters=ne(e),this.bridgeProgramConfigurations=new So(i,{zoom:s,lut:a},(u=>u!=="fill-tunnel-structure-color")),this.tunnelProgramConfigurations=new So(i,{zoom:s,lut:a},(u=>u!=="fill-bridge-guard-rail-color"))}addVertices(e,i){const s=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return s}addTriangles(e,i,s){const a=s?this.unevalTunnelTriangles:this.unevalTriangles;for(const u of e)a.push(u+i)}addRenderableRing(e,i,s,a,u,h){const f=[new Be(u.min.x,u.min.y),new Be(u.max.x,u.min.y),new Be(u.max.x,u.max.y),new Be(u.min.x,u.max.y)];for(let _=0;_<s-1;_++){const g=i+_,v=g+1,b=this.unevalVertices[g],w=this.unevalVertices[v];if(!(b.x>=u.min.x&&b.x<=u.max.x&&b.y>=u.min.y&&b.y<=u.max.y||w.x>=u.min.x&&w.x<=u.max.x&&w.y>=u.min.y&&w.y<=u.max.y||rn(b,w,f))||this.isOnBorder(b.x,w.x)||this.isOnBorder(b.y,w.y))continue;const I=io.computeEdgeHash(this.unevalVertices[g],this.unevalVertices[v]);let A,R=this.vertexHashLookup.get(io.computePosHash(b));R!=null?A=R.next:(R=this.vertexHashLookup.get(io.computePosHash(w)),A=R!=null?R.prev:I),this.unevalEdges.push({polygonIdx:e,a:g,b:v,hash:I,portalHash:A,isTunnel:a,type:"unevaluated",featureInfo:h})}}addPortalCandidates(e,i,s,a,u){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:u});const h=i[0];this.vertexHashLookup.clear();let f=io.computeEdgeHash(h[h.length-2],h[h.length-1]);for(let _=0;_<h.length-1;_++){const g=h[_+0],v=h[_+1],b=Jr(v.x-g.x,v.y-g.y),w=fr(b);if(w===0)continue;let I="unevaluated";const A=a.pointElevation(g),R=a.pointElevation(v);Math.abs(A)<.01&&Math.abs(R)<.01?I="entrance":(this.isOnBorder(g.x,v.x)||this.isOnBorder(g.y,v.y))&&(I="border");const L=io.computeEdgeHash(g,v);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:g,vb:v,vab:b,length:w,hash:L,isTunnel:s,type:I});const k=io.computePosHash(g);this.vertexHashLookup.set(k,{prev:f,next:L}),f=L}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=w=>{w.primitiveLength=this.indexArray.length-w.primitiveOffset},a=new e1(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const u=i(),h=i(),f=i(),_=(w,I)=>{w.sort(((R,L)=>R.type===I&&L.type!==I?-1:R.type!==I&&L.type===I?1:0));const A=w.findIndex((R=>R.type!==I));return A>=0?A:w.length};let g=0;this.unevalEdges.length>0&&(g=_(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},this.tileToMeters)),s(f);const v=i(),b=i();if(this.unevalEdges.length>0){const w=this.unevalEdges.splice(g),I=_(w,"tunnel")+g;this.unevalEdges.push(...w),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:g},{min:g,max:I})}s(v),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(b),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(h),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(u),this.maskSegments=Vr.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.depthSegments=Vr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength),this.renderableBridgeSegments=Vr.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableTunnelSegments=Vr.simpleSegment(0,v.primitiveOffset,0,v.primitiveLength),this.shadowCasterSegments=Vr.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength)}update(e,i,s,a,u,h,f,_){this.bridgeProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,f,_),this.tunnelProgramConfigurations.updatePaintArrays(e,i,u,s,a,h,f,_)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,jb.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Gb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,s,a,u){const h=(f,_)=>{for(let g=0;g<_.length-1;g++){const v=_[g].featureIndex,b=_[g+1].vertexStart,w=e.feature(v);f.populatePaintArrays(b,w,v,{},s,i,a,void 0,u)}};h(this.bridgeProgramConfigurations,this.bridgeFeatureSections),h(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,s,a,u){const h=new Map;for(let f=a;f<u;f++){const _=s[f],g=_.a,v=_.b,b=io.computePosHash(e[g]),w=io.computePosHash(e[v]);let I=h.get(b);I||(I={},h.set(b,I));let A=h.get(w);A||(A={},h.set(w,A)),i[g]<=0&&i[v]<=0||(I.to=v,A.from=g)}return h}isTerminalVertex(e,i){const s=io.computePosHash(this.unevalVertices[e]),a=i.get(s);return!a||!a.from||!a.to}constructBridgeStructures(e,i,s,a,u,h){e.clearVertexLookup();const f=this.computeVertexConnections(i,s,a,u.min,u.max),_=1/h,g=.5*_,v=(Qe,qe)=>di(Qe,i[qe].x,i[qe].y,s[qe]*_),b=Pt(),w=Pt(),I=Pt(),A=Pt(),R=Pt(),L=(Qe,qe)=>{const Fe=f.get(io.computePosHash(i[qe])),He=Fe.from,Ae=Fe.to;if(!He||!Ae)return;v(b,He),v(w,qe),v(I,Ae),Br(A),fs(b,w)||(Rr(R,w,b),Yi(A,R)),fs(I,w)||(Rr(R,I,w),ar(A,A,Yi(R,R)));const Ee=Un(A);return Ee>0?Xi(Qe,A,1/Ee):void 0};let k=Number.POSITIVE_INFINITY;this.sortSubarray(a,u.min,u.max,((Qe,qe)=>Qe.featureInfo.featureIndex-qe.featureInfo.featureIndex));const U=Pt(),G=Pt(),q=Pt(),ie=Pt(),J=Pt(),se=Pt(),le=Pt(),he=Pt(),Ce=Pt(),ye=[Pt(),Pt(),Pt(),Pt()],Pe=[Pt(),Pt(),Pt(),Pt()],ke=[{coord:new Be(0,0),height:0},{coord:new Be(0,0),height:0}],Ve=(Qe,qe)=>Qe>qe;for(let Qe=u.min;Qe<u.max;Qe++){const qe=a[Qe];if(!qe.featureInfo.guardRailEnabled||!this.prepareEdgePoints(ke,i,s,qe,Ve))continue;const[Fe,He]=ke;if(di(U,Fe.coord.x,Fe.coord.y,_*Fe.height),di(G,He.coord.x,He.coord.y,_*He.height),fs(U,G))continue;Rr(q,G,U),Yi(q,q);const Ae=L(he,qe.a)||q,Ee=L(Ce,qe.b)||q;di(ie,Ae[1],-Ae[0],0),Yi(ie,ie),di(J,Ee[1],-Ee[0],0),Yi(J,J),Fr(he,ie,Ae),Yi(se,he),Fr(he,J,Ee),Yi(le,he),ar(ye[0],U,Xi(he,Rr(he,ie,se),g)),ar(ye[1],U,Xi(he,ar(he,ie,se),g)),ar(ye[2],U,Xi(he,se,g)),ye[3]=U,ar(Pe[0],G,Xi(he,Rr(he,J,le),g)),ar(Pe[1],G,Xi(he,ar(he,J,le),g)),ar(Pe[2],G,Xi(he,le,g)),Pe[3]=G,k=this.addFeatureSection(qe.featureInfo.featureIndex,k,this.bridgeFeatureSections,e);const Ge=e.addVertex(ye[0],ie,h),Ye=e.addVertex(ye[1],ie,h),Ne=e.addVertex(Pe[0],J,h),pt=e.addVertex(Pe[1],J,h);e.addTriangle(Ge,Ye,Ne),e.addTriangle(Ye,pt,Ne);const yt=e.addVertex(ye[1],se,h),ht=e.addVertex(ye[2],se,h),st=e.addVertex(Pe[1],le,h),$t=e.addVertex(Pe[2],le,h);e.addTriangle(yt,ht,st),e.addTriangle(ht,$t,st),ss(ie,ie),ss(J,J);const at=e.addVertex(ye[2],ie,h),Ct=e.addVertex(ye[3],ie,h),Wt=e.addVertex(Pe[2],J,h),oi=e.addVertex(Pe[3],J,h);e.addTriangle(at,Ct,Wt),e.addTriangle(Ct,oi,Wt);const Si=this.isTerminalVertex(qe.a,f),Yt=this.isTerminalVertex(qe.b,f);Fe.height<.01&&Si&&e.addQuad(ye[3],ye[2],ye[1],ye[0],ss(Ae,Ae),h),He.height<.01&&Yt&&e.addQuad(Pe[0],Pe[1],Pe[2],Pe[3],Ee,h)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,s,a,u,h){e.clearVertexLookup();let f=Number.POSITIVE_INFINITY;const _=(k,U)=>k.featureInfo.featureIndex-U.featureInfo.featureIndex;this.sortSubarray(a,u.min,u.max,_),this.sortSubarray(a,h.min,h.max,_);const g=k=>Yi(k,k),v=[{coord:new Be(0,0),height:0},{coord:new Be(0,0),height:0}],b=(k,U)=>k<U,w=Pt(),I=Pt(),A=Pt(),R=Pt(),L=Pt();for(let k=u.min;k<u.max;k++){if(!this.prepareEdgePoints(v,i,s,a[k],b))continue;const[U,G]=v,q=g(di(L,-(G.coord.y-U.coord.y),G.coord.x-U.coord.x,0));f=this.addFeatureSection(a[k].featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(di(w,U.coord.x,U.coord.y,U.height),di(I,G.coord.x,G.coord.y,G.height),di(A,G.coord.x,G.coord.y,a[k].isTunnel?-.1:0),di(R,U.coord.x,U.coord.y,a[k].isTunnel?-.1:0),q)}for(let k=h.min;k<h.max;k++){const U=a[k];U.isTunnel&&([U.a,U.b]=[U.b,U.a]);const G=i[U.a],q=i[U.b],ie=g(di(L,-(q.y-G.y),q.x-G.x,0));f=this.addFeatureSection(U.featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(di(w,q.x,q.y,0),di(I,G.x,G.y,0),di(A,G.x,G.y,s[U.a]+4),di(R,q.x,q.y,s[U.b]+4),ie),e.addQuad(di(w,G.x,G.y,0),di(I,q.x,q.y,0),di(A,q.x,q.y,s[U.b]+4),di(R,G.x,G.y,s[U.a]+4),ie)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,s,a){e.coord.x=i,e.coord.y=s,e.height=a}prepareEdgePoints(e,i,s,a,u){let h=i[a.a].x,f=i[a.a].y,_=i[a.b].x,g=i[a.b].y,v=s[a.a],b=s[a.b];const w=u(v,0),I=u(b,0);if(w&&I)return this.setElevatedPoint(e[0],h,f,v),this.setElevatedPoint(e[1],_,g,b),!0;if(!w&&!I)return!1;if(w){if(!I){const A=b/(b-v);_=Vt(_,h,A),g=Vt(g,f,A),b=Vt(b,v,A)}}else{const A=v/(v-b);h=Vt(h,_,A),f=Vt(f,g,A),v=Vt(v,b,A)}return this.setElevatedPoint(e[0],h,f,v),this.setElevatedPoint(e[1],_,g,b),!0}prepareEdges(e,i){if(i.length===0)return;i.sort(((f,_)=>f.hash===_.hash?_.polygonIdx-f.polygonIdx:_.hash>f.hash?1:-1));let s=0,a=0,u=0,h=i[s].polygonIdx;do a++,(a===i.length||i[s].hash!==i[a].hash)&&((a-s==1||i[a-1].polygonIdx!==h)&&(u<s&&(i[u]=i[s],i[s]=null),i[u].type="none",u++),s=a,s!==i.length&&(h=i[s].polygonIdx));while(s!==i.length);if(i.splice(u),i.length!==0&&e.length!==0){i.sort(((g,v)=>g.portalHash<v.portalHash?1:-1));let f=0,_=0;for(;f!==i.length&&_!==e.length;){const g=i[f],v=e[_];g.portalHash>v.hash?f++:v.hash>g.portalHash?_++:(g.type=v.type,f++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=it&&i>=it}addFeatureSection(e,i,s,a){return e!==i&&(i=e,s.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,s,a){const u=e.slice(i,s);u.sort(a),e.splice(i,u.length,...u)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(io.computePosHash(e))<<BigInt(32)|BigInt(io.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var vy,by={exports:{}},wy=(vy||(vy=1,(function(r,e){(function(i){function s(Q,Y){return Q>Y?1:Q<Y?-1:0}var a=function(Q,Y){Q===void 0&&(Q=s),Y===void 0&&(Y=!1),this._compare=Q,this._root=null,this._size=0,this._noDuplicates=!!Y},u={size:{configurable:!0}};function h(Q,Y,Re,nt,De){var ot=De-nt;if(ot>0){var Et=nt+Math.floor(ot/2),St={key:Y[Et],data:Re[Et],parent:Q};return St.left=h(St,Y,Re,nt,Et),St.right=h(St,Y,Re,Et+1,De),St}return null}function f(Q,Y,Re,nt,De){if(!(Re>=nt)){for(var ot=Q[Re+nt>>1],Et=Re-1,St=nt+1;;){do Et++;while(De(Q[Et],ot)<0);do St--;while(De(Q[St],ot)>0);if(Et>=St)break;var Kt=Q[Et];Q[Et]=Q[St],Q[St]=Kt,Kt=Y[Et],Y[Et]=Y[St],Y[St]=Kt}f(Q,Y,Re,St,De),f(Q,Y,St+1,nt,De)}}a.prototype.rotateLeft=function(Q){var Y=Q.right;Y&&(Q.right=Y.left,Y.left&&(Y.left.parent=Q),Y.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=Y:Q.parent.right=Y:this._root=Y,Y&&(Y.left=Q),Q.parent=Y},a.prototype.rotateRight=function(Q){var Y=Q.left;Y&&(Q.left=Y.right,Y.right&&(Y.right.parent=Q),Y.parent=Q.parent),Q.parent?Q===Q.parent.left?Q.parent.left=Y:Q.parent.right=Y:this._root=Y,Y&&(Y.right=Q),Q.parent=Y},a.prototype._splay=function(Q){for(;Q.parent;){var Y=Q.parent;Y.parent?Y.left===Q&&Y.parent.left===Y?(this.rotateRight(Y.parent),this.rotateRight(Y)):Y.right===Q&&Y.parent.right===Y?(this.rotateLeft(Y.parent),this.rotateLeft(Y)):Y.left===Q&&Y.parent.right===Y?(this.rotateRight(Y),this.rotateLeft(Y)):(this.rotateLeft(Y),this.rotateRight(Y)):Y.left===Q?this.rotateRight(Y):this.rotateLeft(Y)}},a.prototype.splay=function(Q){for(var Y,Re,nt,De,ot;Q.parent;)(Re=(Y=Q.parent).parent)&&Re.parent?((nt=Re.parent).left===Re?nt.left=Q:nt.right=Q,Q.parent=nt):(Q.parent=null,this._root=Q),De=Q.left,ot=Q.right,Q===Y.left?(Re&&(Re.left===Y?(Y.right?(Re.left=Y.right,Re.left.parent=Re):Re.left=null,Y.right=Re,Re.parent=Y):(De?(Re.right=De,De.parent=Re):Re.right=null,Q.left=Re,Re.parent=Q)),ot?(Y.left=ot,ot.parent=Y):Y.left=null,Q.right=Y,Y.parent=Q):(Re&&(Re.right===Y?(Y.left?(Re.right=Y.left,Re.right.parent=Re):Re.right=null,Y.left=Re,Re.parent=Y):(ot?(Re.left=ot,ot.parent=Re):Re.left=null,Q.right=Re,Re.parent=Q)),De?(Y.right=De,De.parent=Y):Y.right=null,Q.left=Y,Y.parent=Q)},a.prototype.replace=function(Q,Y){Q.parent?Q===Q.parent.left?Q.parent.left=Y:Q.parent.right=Y:this._root=Y,Y&&(Y.parent=Q.parent)},a.prototype.minNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.left;)Q=Q.left;return Q},a.prototype.maxNode=function(Q){if(Q===void 0&&(Q=this._root),Q)for(;Q.right;)Q=Q.right;return Q},a.prototype.insert=function(Q,Y){var Re=this._root,nt=null,De=this._compare;if(this._noDuplicates)for(;Re;){if(nt=Re,De(Re.key,Q)===0)return;Re=De(Re.key,Q)<0?Re.right:Re.left}else for(;Re;)nt=Re,Re=De(Re.key,Q)<0?Re.right:Re.left;return Re={key:Q,data:Y,left:null,right:null,parent:nt},nt?De(nt.key,Re.key)<0?nt.right=Re:nt.left=Re:this._root=Re,this.splay(Re),this._size++,Re},a.prototype.find=function(Q){for(var Y=this._root,Re=this._compare;Y;){var nt=Re(Y.key,Q);if(nt<0)Y=Y.right;else{if(!(nt>0))return Y;Y=Y.left}}return null},a.prototype.contains=function(Q){for(var Y=this._root,Re=this._compare;Y;){var nt=Re(Q,Y.key);if(nt===0)return!0;Y=nt<0?Y.left:Y.right}return!1},a.prototype.remove=function(Q){var Y=this.find(Q);if(!Y)return!1;if(this.splay(Y),Y.left)if(Y.right){var Re=this.minNode(Y.right);Re.parent!==Y&&(this.replace(Re,Re.right),Re.right=Y.right,Re.right.parent=Re),this.replace(Y,Re),Re.left=Y.left,Re.left.parent=Re}else this.replace(Y,Y.left);else this.replace(Y,Y.right);return this._size--,!0},a.prototype.removeNode=function(Q){if(!Q)return!1;if(this.splay(Q),Q.left)if(Q.right){var Y=this.minNode(Q.right);Y.parent!==Q&&(this.replace(Y,Y.right),Y.right=Q.right,Y.right.parent=Y),this.replace(Q,Y),Y.left=Q.left,Y.left.parent=Y}else this.replace(Q,Q.left);else this.replace(Q,Q.right);return this._size--,!0},a.prototype.erase=function(Q){var Y=this.find(Q);if(Y){this.splay(Y);var Re=Y.left,nt=Y.right,De=null;Re&&(Re.parent=null,De=this.maxNode(Re),this.splay(De),this._root=De),nt&&(Re?De.right=nt:this._root=nt,nt.parent=De),this._size--}},a.prototype.pop=function(){var Q=this._root,Y=null;if(Q){for(;Q.left;)Q=Q.left;Y={key:Q.key,data:Q.data},this.remove(Q.key)}return Y},a.prototype.next=function(Q){var Y=Q;if(Y)if(Y.right)for(Y=Y.right;Y&&Y.left;)Y=Y.left;else for(Y=Q.parent;Y&&Y.right===Q;)Q=Y,Y=Y.parent;return Y},a.prototype.prev=function(Q){var Y=Q;if(Y)if(Y.left)for(Y=Y.left;Y&&Y.right;)Y=Y.right;else for(Y=Q.parent;Y&&Y.left===Q;)Q=Y,Y=Y.parent;return Y},a.prototype.forEach=function(Q){for(var Y=this._root,Re=[],nt=!1,De=0;!nt;)Y?(Re.push(Y),Y=Y.left):Re.length>0?(Q(Y=Re.pop(),De++),Y=Y.right):nt=!0;return this},a.prototype.range=function(Q,Y,Re,nt){for(var De=[],ot=this._compare,Et=this._root;De.length!==0||Et;)if(Et)De.push(Et),Et=Et.left;else{if(ot((Et=De.pop()).key,Y)>0)break;if(ot(Et.key,Q)>=0&&Re.call(nt,Et))return this;Et=Et.right}return this},a.prototype.keys=function(){for(var Q=this._root,Y=[],Re=[],nt=!1;!nt;)Q?(Y.push(Q),Q=Q.left):Y.length>0?(Q=Y.pop(),Re.push(Q.key),Q=Q.right):nt=!0;return Re},a.prototype.values=function(){for(var Q=this._root,Y=[],Re=[],nt=!1;!nt;)Q?(Y.push(Q),Q=Q.left):Y.length>0?(Q=Y.pop(),Re.push(Q.data),Q=Q.right):nt=!0;return Re},a.prototype.at=function(Q){for(var Y=this._root,Re=[],nt=!1,De=0;!nt;)if(Y)Re.push(Y),Y=Y.left;else if(Re.length>0){if(Y=Re.pop(),De===Q)return Y;De++,Y=Y.right}else nt=!0;return null},a.prototype.load=function(Q,Y,Re){if(Q===void 0&&(Q=[]),Y===void 0&&(Y=[]),Re===void 0&&(Re=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var nt=Q.length;return Re&&f(Q,Y,0,nt-1,this._compare),this._root=h(null,Q,Y,0,nt),this._size=nt,this},a.prototype.min=function(){var Q=this.minNode(this._root);return Q?Q.key:null},a.prototype.max=function(){var Q=this.maxNode(this._root);return Q?Q.key:null},a.prototype.isEmpty=function(){return this._root===null},u.size.get=function(){return this._size},a.createTree=function(Q,Y,Re,nt,De){return new a(Re,De).load(Q,Y,nt)},Object.defineProperties(a.prototype,u);var _=0,g=1,v=2,b=3,w=0,I=1,A=2,R=3;function L(Q,Y,Re){Y===null?(Q.inOut=!1,Q.otherInOut=!0):(Q.isSubject===Y.isSubject?(Q.inOut=!Y.inOut,Q.otherInOut=Y.otherInOut):(Q.inOut=!Y.otherInOut,Q.otherInOut=Y.isVertical()?!Y.inOut:Y.inOut),Y&&(Q.prevInResult=!k(Y,Re)||Y.isVertical()?Y.prevInResult:Y));var nt=k(Q,Re);Q.resultTransition=nt?(function(De,ot){var Et,St=!De.inOut,Kt=!De.otherInOut;switch(ot){case w:Et=St&&Kt;break;case I:Et=St||Kt;break;case R:Et=St^Kt;break;case A:Et=De.isSubject?St&&!Kt:Kt&&!St}return Et?1:-1})(Q,Re):0}function k(Q,Y){switch(Q.type){case _:switch(Y){case w:return!Q.otherInOut;case I:return Q.otherInOut;case A:return Q.isSubject&&Q.otherInOut||!Q.isSubject&&!Q.otherInOut;case R:return!0}break;case v:return Y===w||Y===I;case b:return Y===A;case g:return!1}return!1}var U=function(Q,Y,Re,nt,De){this.left=Y,this.point=Q,this.otherEvent=Re,this.isSubject=nt,this.type=De||_,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},G={inResult:{configurable:!0}};function q(Q,Y){return Q[0]===Y[0]&&Q[1]===Y[1]}U.prototype.isBelow=function(Q){var Y=this.point,Re=this.otherEvent.point;return this.left?(Y[0]-Q[0])*(Re[1]-Q[1])-(Re[0]-Q[0])*(Y[1]-Q[1])>0:(Re[0]-Q[0])*(Y[1]-Q[1])-(Y[0]-Q[0])*(Re[1]-Q[1])>0},U.prototype.isAbove=function(Q){return!this.isBelow(Q)},U.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},G.inResult.get=function(){return this.resultTransition!==0},U.prototype.clone=function(){var Q=new U(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Q.contourId=this.contourId,Q.resultTransition=this.resultTransition,Q.prevInResult=this.prevInResult,Q.isExteriorRing=this.isExteriorRing,Q.inOut=this.inOut,Q.otherInOut=this.otherInOut,Q},Object.defineProperties(U.prototype,G);var ie=11102230246251565e-32,J=134217729,se=(3+8*ie)*ie;function le(Q,Y,Re,nt,De){var ot,Et,St,Kt,kt=Y[0],bt=nt[0],Ri=0,rr=0;bt>kt==bt>-kt?(ot=kt,kt=Y[++Ri]):(ot=bt,bt=nt[++rr]);var Nt=0;if(Ri<Q&&rr<Re)for(bt>kt==bt>-kt?(St=ot-((Et=kt+ot)-kt),kt=Y[++Ri]):(St=ot-((Et=bt+ot)-bt),bt=nt[++rr]),ot=Et,St!==0&&(De[Nt++]=St);Ri<Q&&rr<Re;)bt>kt==bt>-kt?(St=ot-((Et=ot+kt)-(Kt=Et-ot))+(kt-Kt),kt=Y[++Ri]):(St=ot-((Et=ot+bt)-(Kt=Et-ot))+(bt-Kt),bt=nt[++rr]),ot=Et,St!==0&&(De[Nt++]=St);for(;Ri<Q;)St=ot-((Et=ot+kt)-(Kt=Et-ot))+(kt-Kt),kt=Y[++Ri],ot=Et,St!==0&&(De[Nt++]=St);for(;rr<Re;)St=ot-((Et=ot+bt)-(Kt=Et-ot))+(bt-Kt),bt=nt[++rr],ot=Et,St!==0&&(De[Nt++]=St);return ot===0&&Nt!==0||(De[Nt++]=ot),Nt}function he(Q){return new Float64Array(Q)}var Ce=33306690738754716e-32,ye=22204460492503146e-32,Pe=11093356479670487e-47,ke=he(4),Ve=he(8),Qe=he(12),qe=he(16),Fe=he(4);function He(Q,Y,Re){var nt=(function(De,ot,Et,St,Kt,kt){var bt=(ot-kt)*(Et-Kt),Ri=(De-Kt)*(St-kt),rr=bt-Ri;if(bt===0||Ri===0||bt>0!=Ri>0)return rr;var Nt=Math.abs(bt+Ri);return Math.abs(rr)>=Ce*Nt?rr:-(function(wi,nr,Hi,qr,Ar,_r,Ji){var Oi,Jt,ki,gr,Ft,Ei,Mr,Kr,ln,Sn,Cr,mn,Us,_n,no,hs,Io,js,so=wi-Ar,ds=Hi-Ar,oo=nr-_r,Ao=qr-_r;ke[0]=(no=(Kr=so-(Mr=(Ei=J*so)-(Ei-so)))*(Sn=Ao-(ln=(Ei=J*Ao)-(Ei-Ao)))-((_n=so*Ao)-Mr*ln-Kr*ln-Mr*Sn))-((Cr=no-(Io=(Kr=oo-(Mr=(Ei=J*oo)-(Ei-oo)))*(Sn=ds-(ln=(Ei=J*ds)-(Ei-ds)))-((hs=oo*ds)-Mr*ln-Kr*ln-Mr*Sn)))+(Ft=no-Cr))+(Ft-Io),ke[1]=(Us=_n-((mn=_n+Cr)-(Ft=mn-_n))+(Cr-Ft))-((Cr=Us-hs)+(Ft=Us-Cr))+(Ft-hs),ke[2]=mn-((js=mn+Cr)-(Ft=js-mn))+(Cr-Ft),ke[3]=js;var Wn=(function(Fl,va){for(var cm=va[0],rh=1;rh<4;rh++)cm+=va[rh];return cm})(0,ke),Ts=ye*Ji;if(Wn>=Ts||-Wn>=Ts||(Oi=wi-(so+(Ft=wi-so))+(Ft-Ar),ki=Hi-(ds+(Ft=Hi-ds))+(Ft-Ar),Jt=nr-(oo+(Ft=nr-oo))+(Ft-_r),gr=qr-(Ao+(Ft=qr-Ao))+(Ft-_r),Oi===0&&Jt===0&&ki===0&&gr===0)||(Ts=Pe*Ji+se*Math.abs(Wn),(Wn+=so*gr+Ao*Oi-(oo*ki+ds*Jt))>=Ts||-Wn>=Ts))return Wn;Fe[0]=(no=(Kr=Oi-(Mr=(Ei=J*Oi)-(Ei-Oi)))*(Sn=Ao-(ln=(Ei=J*Ao)-(Ei-Ao)))-((_n=Oi*Ao)-Mr*ln-Kr*ln-Mr*Sn))-((Cr=no-(Io=(Kr=Jt-(Mr=(Ei=J*Jt)-(Ei-Jt)))*(Sn=ds-(ln=(Ei=J*ds)-(Ei-ds)))-((hs=Jt*ds)-Mr*ln-Kr*ln-Mr*Sn)))+(Ft=no-Cr))+(Ft-Io),Fe[1]=(Us=_n-((mn=_n+Cr)-(Ft=mn-_n))+(Cr-Ft))-((Cr=Us-hs)+(Ft=Us-Cr))+(Ft-hs),Fe[2]=mn-((js=mn+Cr)-(Ft=js-mn))+(Cr-Ft),Fe[3]=js;var xa=le(4,ke,4,Fe,Ve);Fe[0]=(no=(Kr=so-(Mr=(Ei=J*so)-(Ei-so)))*(Sn=gr-(ln=(Ei=J*gr)-(Ei-gr)))-((_n=so*gr)-Mr*ln-Kr*ln-Mr*Sn))-((Cr=no-(Io=(Kr=oo-(Mr=(Ei=J*oo)-(Ei-oo)))*(Sn=ki-(ln=(Ei=J*ki)-(Ei-ki)))-((hs=oo*ki)-Mr*ln-Kr*ln-Mr*Sn)))+(Ft=no-Cr))+(Ft-Io),Fe[1]=(Us=_n-((mn=_n+Cr)-(Ft=mn-_n))+(Cr-Ft))-((Cr=Us-hs)+(Ft=Us-Cr))+(Ft-hs),Fe[2]=mn-((js=mn+Cr)-(Ft=js-mn))+(Cr-Ft),Fe[3]=js;var kl=le(xa,Ve,4,Fe,Qe);Fe[0]=(no=(Kr=Oi-(Mr=(Ei=J*Oi)-(Ei-Oi)))*(Sn=gr-(ln=(Ei=J*gr)-(Ei-gr)))-((_n=Oi*gr)-Mr*ln-Kr*ln-Mr*Sn))-((Cr=no-(Io=(Kr=Jt-(Mr=(Ei=J*Jt)-(Ei-Jt)))*(Sn=ki-(ln=(Ei=J*ki)-(Ei-ki)))-((hs=Jt*ki)-Mr*ln-Kr*ln-Mr*Sn)))+(Ft=no-Cr))+(Ft-Io),Fe[1]=(Us=_n-((mn=_n+Cr)-(Ft=mn-_n))+(Cr-Ft))-((Cr=Us-hs)+(Ft=Us-Cr))+(Ft-hs),Fe[2]=mn-((js=mn+Cr)-(Ft=js-mn))+(Cr-Ft),Fe[3]=js;var ih=le(kl,Qe,4,Fe,qe);return qe[ih-1]})(De,ot,Et,St,Kt,kt,Nt)})(Q[0],Q[1],Y[0],Y[1],Re[0],Re[1]);return nt>0?-1:nt<0?1:0}function Ae(Q,Y){var Re=Q.point,nt=Y.point;return Re[0]>nt[0]?1:Re[0]<nt[0]?-1:Re[1]!==nt[1]?Re[1]>nt[1]?1:-1:(function(De,ot,Et,St){return De.left!==ot.left?De.left?1:-1:He(Et,De.otherEvent.point,ot.otherEvent.point)!==0?De.isBelow(ot.otherEvent.point)?-1:1:!De.isSubject&&ot.isSubject?1:-1})(Q,Y,Re)}function Ee(Q,Y,Re){var nt=new U(Y,!1,Q,Q.isSubject),De=new U(Y,!0,Q.otherEvent,Q.isSubject);return q(Q.point,Q.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Q),nt.contourId=De.contourId=Q.contourId,Ae(De,Q.otherEvent)>0&&(Q.otherEvent.left=!0,De.left=!1),Q.otherEvent.otherEvent=De,Q.otherEvent=nt,Re.push(De),Re.push(nt),Re}function Ge(Q,Y){return Q[0]*Y[1]-Q[1]*Y[0]}function Ye(Q,Y){return Q[0]*Y[0]+Q[1]*Y[1]}function Ne(Q,Y,Re){var nt=(function(Kt,kt,bt,Ri,rr){var Nt=[kt[0]-Kt[0],kt[1]-Kt[1]],wi=[Ri[0]-bt[0],Ri[1]-bt[1]];function nr(Ei,Mr,Kr){return[Ei[0]+Mr*Kr[0],Ei[1]+Mr*Kr[1]]}var Hi=[bt[0]-Kt[0],bt[1]-Kt[1]],qr=Ge(Nt,wi),Ar=qr*qr,_r=Ye(Nt,Nt);if(Ar>0){var Ji=Ge(Hi,wi)/qr;if(Ji<0||Ji>1)return null;var Oi=Ge(Hi,Nt)/qr;return Oi<0||Oi>1?null:Ji===0||Ji===1?[nr(Kt,Ji,Nt)]:Oi===0||Oi===1?[nr(bt,Oi,wi)]:[nr(Kt,Ji,Nt)]}if((Ar=(qr=Ge(Hi,Nt))*qr)>0)return null;var Jt=Ye(Nt,Hi)/_r,ki=Jt+Ye(Nt,wi)/_r,gr=Math.min(Jt,ki),Ft=Math.max(Jt,ki);return gr<=1&&Ft>=0?gr===1?[nr(Kt,gr>0?gr:0,Nt)]:Ft===0?[nr(Kt,Ft<1?Ft:1,Nt)]:[nr(Kt,gr>0?gr:0,Nt),nr(Kt,Ft<1?Ft:1,Nt)]:null})(Q.point,Q.otherEvent.point,Y.point,Y.otherEvent.point),De=nt?nt.length:0;if(De===0||De===1&&(q(Q.point,Y.point)||q(Q.otherEvent.point,Y.otherEvent.point))||De===2&&Q.isSubject===Y.isSubject)return 0;if(De===1)return q(Q.point,nt[0])||q(Q.otherEvent.point,nt[0])||Ee(Q,nt[0],Re),q(Y.point,nt[0])||q(Y.otherEvent.point,nt[0])||Ee(Y,nt[0],Re),1;var ot=[],Et=!1,St=!1;return q(Q.point,Y.point)?Et=!0:Ae(Q,Y)===1?ot.push(Y,Q):ot.push(Q,Y),q(Q.otherEvent.point,Y.otherEvent.point)?St=!0:Ae(Q.otherEvent,Y.otherEvent)===1?ot.push(Y.otherEvent,Q.otherEvent):ot.push(Q.otherEvent,Y.otherEvent),Et&&St||Et?(Y.type=g,Q.type=Y.inOut===Q.inOut?v:b,Et&&!St&&Ee(ot[1].otherEvent,ot[0].point,Re),2):St?(Ee(ot[0],ot[1].point,Re),3):ot[0]!==ot[3].otherEvent?(Ee(ot[0],ot[1].point,Re),Ee(ot[1],ot[2].point,Re),3):(Ee(ot[0],ot[1].point,Re),Ee(ot[3].otherEvent,ot[2].point,Re),3)}function pt(Q,Y){if(Q===Y)return 0;if(He(Q.point,Q.otherEvent.point,Y.point)!==0||He(Q.point,Q.otherEvent.point,Y.otherEvent.point)!==0)return q(Q.point,Y.point)?Q.isBelow(Y.otherEvent.point)?-1:1:Q.point[0]===Y.point[0]?Q.point[1]<Y.point[1]?-1:1:Ae(Q,Y)===1?Y.isAbove(Q.point)?-1:1:Q.isBelow(Y.point)?-1:1;if(Q.isSubject!==Y.isSubject)return Q.isSubject?-1:1;var Re=Q.point,nt=Y.point;return Re[0]===nt[0]&&Re[1]===nt[1]?(Re=Q.otherEvent.point)[0]===(nt=Y.otherEvent.point)[0]&&Re[1]===nt[1]?0:Q.contourId>Y.contourId?1:-1:Ae(Q,Y)===1?1:-1}var yt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function ht(Q,Y,Re,nt){var De,ot=Q+1,Et=Y[Q].point,St=Y.length;for(ot<St&&(De=Y[ot].point);ot<St&&De[0]===Et[0]&&De[1]===Et[1];){if(!Re[ot])return ot;++ot<St&&(De=Y[ot].point)}for(ot=Q-1;Re[ot]&&ot>nt;)ot--;return ot}yt.prototype.isExterior=function(){return this.holeOf==null};var st=at,$t=at;function at(Q,Y){if(!(this instanceof at))return new at(Q,Y);if(this.data=Q||[],this.length=this.data.length,this.compare=Y||Ct,this.length>0)for(var Re=(this.length>>1)-1;Re>=0;Re--)this._down(Re)}function Ct(Q,Y){return Q<Y?-1:Q>Y?1:0}at.prototype={push:function(Q){this.data.push(Q),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Q=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Q}},peek:function(){return this.data[0]},_up:function(Q){for(var Y=this.data,Re=this.compare,nt=Y[Q];Q>0;){var De=Q-1>>1,ot=Y[De];if(Re(nt,ot)>=0)break;Y[Q]=ot,Q=De}Y[Q]=nt},_down:function(Q){for(var Y=this.data,Re=this.compare,nt=this.length>>1,De=Y[Q];Q<nt;){var ot=1+(Q<<1),Et=ot+1,St=Y[ot];if(Et<this.length&&Re(Y[Et],St)<0&&(ot=Et,St=Y[Et]),Re(St,De)>=0)break;Y[Q]=St,Q=ot}Y[Q]=De}},st.default=$t;var Wt=Math.max,oi=Math.min,Si=0;function Yt(Q,Y,Re,nt,De,ot){var Et,St,Kt,kt,bt,Ri;for(Et=0,St=Q.length-1;Et<St;Et++)if(kt=Q[Et+1],bt=new U(Kt=Q[Et],!1,void 0,Y),Ri=new U(kt,!1,bt,Y),bt.otherEvent=Ri,Kt[0]!==kt[0]||Kt[1]!==kt[1]){bt.contourId=Ri.contourId=Re,ot||(bt.isExteriorRing=!1,Ri.isExteriorRing=!1),Ae(bt,Ri)>0?Ri.left=!0:bt.left=!0;var rr=Kt[0],Nt=Kt[1];De[0]=oi(De[0],rr),De[1]=oi(De[1],Nt),De[2]=Wt(De[2],rr),De[3]=Wt(De[3],Nt),nt.push(bt),nt.push(Ri)}}var zi=[];function Li(Q,Y,Re){typeof Q[0][0][0]=="number"&&(Q=[Q]),typeof Y[0][0][0]=="number"&&(Y=[Y]);var nt=(function(Nt,wi,nr){var Hi=null;return Nt.length*wi.length==0&&(nr===w?Hi=zi:nr===A?Hi=Nt:nr!==I&&nr!==R||(Hi=Nt.length===0?wi:Nt)),Hi})(Q,Y,Re);if(nt)return nt===zi?null:nt;var De=[1/0,1/0,-1/0,-1/0],ot=[1/0,1/0,-1/0,-1/0],Et=(function(Nt,wi,nr,Hi,qr){var Ar,_r,Ji,Oi,Jt,ki,gr=new st(null,Ae);for(Ji=0,Oi=Nt.length;Ji<Oi;Ji++)for(Jt=0,ki=(Ar=Nt[Ji]).length;Jt<ki;Jt++)(_r=Jt===0)&&Si++,Yt(Ar[Jt],!0,Si,gr,nr,_r);for(Ji=0,Oi=wi.length;Ji<Oi;Ji++)for(Jt=0,ki=(Ar=wi[Ji]).length;Jt<ki;Jt++)_r=Jt===0,qr===A&&(_r=!1),_r&&Si++,Yt(Ar[Jt],!1,Si,gr,Hi,_r);return gr})(Q,Y,De,ot,Re);if(nt=(function(Nt,wi,nr,Hi,qr){var Ar=null;return(nr[0]>Hi[2]||Hi[0]>nr[2]||nr[1]>Hi[3]||Hi[1]>nr[3])&&(qr===w?Ar=zi:qr===A?Ar=Nt:qr!==I&&qr!==R||(Ar=Nt.concat(wi))),Ar})(Q,Y,De,ot,Re))return nt===zi?null:nt;for(var St=(function(Nt){var wi,nr,Hi=(function(Ji){var Oi,Jt,ki,gr,Ft=[];for(Jt=0,ki=Ji.length;Jt<ki;Jt++)((Oi=Ji[Jt]).left&&Oi.inResult||!Oi.left&&Oi.otherEvent.inResult)&&Ft.push(Oi);for(var Ei=!1;!Ei;)for(Ei=!0,Jt=0,ki=Ft.length;Jt<ki;Jt++)Jt+1<ki&&Ae(Ft[Jt],Ft[Jt+1])===1&&(gr=Ft[Jt],Ft[Jt]=Ft[Jt+1],Ft[Jt+1]=gr,Ei=!1);for(Jt=0,ki=Ft.length;Jt<ki;Jt++)(Oi=Ft[Jt]).otherPos=Jt;for(Jt=0,ki=Ft.length;Jt<ki;Jt++)(Oi=Ft[Jt]).left||(gr=Oi.otherPos,Oi.otherPos=Oi.otherEvent.otherPos,Oi.otherEvent.otherPos=gr);return Ft})(Nt),qr={},Ar=[],_r=function(){if(!qr[wi]){var Ji=Ar.length,Oi=(function(Ft,Ei,Mr){var Kr=new yt;if(Ft.prevInResult!=null){var ln=Ft.prevInResult,Sn=ln.outputContourId;if(ln.resultTransition>0){var Cr=Ei[Sn];if(Cr.holeOf!=null){var mn=Cr.holeOf;Ei[mn].holeIds.push(Mr),Kr.holeOf=mn,Kr.depth=Ei[Sn].depth}else Ei[Sn].holeIds.push(Mr),Kr.holeOf=Sn,Kr.depth=Ei[Sn].depth+1}else Kr.holeOf=null,Kr.depth=Ei[Sn].depth}else Kr.holeOf=null,Kr.depth=0;return Kr})(Hi[wi],Ar,Ji),Jt=function(Ft){qr[Ft]=!0,Ft<Hi.length&&Hi[Ft]&&(Hi[Ft].outputContourId=Ji)},ki=wi,gr=wi;for(Oi.points.push(Hi[wi].point);Jt(ki),Jt(ki=Hi[ki].otherPos),Oi.points.push(Hi[ki].point),!((ki=ht(ki,Hi,qr,gr))==gr||ki>=Hi.length)&&Hi[ki];);Ar.push(Oi)}};for(wi=0,nr=Hi.length;wi<nr;wi++)_r();return Ar})((function(Nt,wi,nr,Hi,qr,Ar){for(var _r,Ji,Oi,Jt=new a(pt),ki=[],gr=Math.min(Hi[2],qr[2]);Nt.length!==0;){var Ft=Nt.pop();if(ki.push(Ft),Ar===w&&Ft.point[0]>gr||Ar===A&&Ft.point[0]>Hi[2])break;if(Ft.left){Ji=_r=Jt.insert(Ft),_r=_r!==(Oi=Jt.minNode())?Jt.prev(_r):null,Ji=Jt.next(Ji);var Ei=_r?_r.key:null;if(L(Ft,Ei,Ar),Ji&&Ne(Ft,Ji.key,Nt)===2&&(L(Ft,Ei,Ar),L(Ji.key,Ft,Ar)),_r&&Ne(_r.key,Ft,Nt)===2){var Mr=_r;L(Ei,(Mr=Mr!==Oi?Jt.prev(Mr):null)?Mr.key:null,Ar),L(Ft,Ei,Ar)}}else Ji=_r=Jt.find(Ft=Ft.otherEvent),_r&&Ji&&(_r=_r!==Oi?Jt.prev(_r):null,Ji=Jt.next(Ji),Jt.remove(Ft),Ji&&_r&&Ne(_r.key,Ji.key,Nt))}return ki})(Et,0,0,De,ot,Re)),Kt=[],kt=0;kt<St.length;kt++){var bt=St[kt];if(bt.isExterior()){for(var Ri=[bt.points],rr=0;rr<bt.holeIds.length;rr++)Ri.push(St[bt.holeIds[rr]].points);Kt.push(Ri)}}return Kt}var kr={UNION:I,DIFFERENCE:A,INTERSECTION:w,XOR:R};i.diff=function(Q,Y){return Li(Q,Y,A)},i.intersection=function(Q,Y){return Li(Q,Y,w)},i.operations=kr,i.union=function(Q,Y){return Li(Q,Y,I)},i.xor=function(Q,Y){return Li(Q,Y,R)},Object.defineProperty(i,"__esModule",{value:!0})})(e)})(0,by.exports)),by.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function bp(r,e,i,s){const a=[],u=s===0?(h,f,_,g,v,b)=>{h.push(new Be(b,_+(b-f)/(g-f)*(v-_)))}:(h,f,_,g,v,b)=>{h.push(new Be(f+(b-_)/(v-_)*(g-f),b))};for(const h of r){const f=[];for(const _ of h){if(_.length<=2)continue;const g=[];for(let w=0;w<_.length-1;w++){const I=_[w].x,A=_[w].y,R=_[w+1].x,L=_[w+1].y,k=s===0?I:A,U=s===0?R:L;k<e?U>e&&u(g,I,A,R,L,e):k>i?U<i&&u(g,I,A,R,L,i):g.push(_[w]),U<e&&k>=e&&u(g,I,A,R,L,e),U>i&&k<=i&&u(g,I,A,R,L,i)}let v=_[_.length-1];const b=s===0?v.x:v.y;b>=e&&b<=i&&g.push(v),g.length&&(v=g[g.length-1],g[0].x===v.x&&g[0].y===v.y||g.push(g[0]),f.push(g))}f.length&&a.push(f)}return a}function t1(r,e){const i=d_(r),s=d_([e]),a=wy.intersection(i,s);return a==null?[]:Ty(a)}function i1(r,e){let s=d_(r,65536);const a=[];for(;e.valid();e.next()){const[u,h]=e.get(),f=u.x*65536,_=u.y*65536,g=h.x*65536,v=h.y*65536,b=g-f,w=v-_,I=Math.hypot(b,w);if(I===0)continue;const A=Math.trunc(w/I*3),R=-Math.trunc(b/I*3);a.push([[[f,_],[g,v],[g+A,v+R],[f+A,_+R],[f,_]]])}return a.length>0&&(s=wy.diff(s,a)),Ty(s,1/65536)}function d_(r,e=1){return[r.map((i=>i.map((s=>[s.x*e,s.y*e]))))]}function Ty(r,e=1){return r.map((i=>i.map(((s,a)=>{const u=s.map((h=>new Be(h[0]*e,h[1]*e).round()));return a>0&&u.reverse(),u}))))}class f_{constructor(e,i){this.layoutVertexArray=new Ps,this.indexArray=new zr,this.lineIndexArray=new xo,this.triangleSegments=new Vr,this.lineSegments=new Vr,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Wo)}update(e,i,s,a,u,h,f,_){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,_)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Vb.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Ub.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,s,a,u,h,f){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,s,a,u,h,void 0,f)}}class p_{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new f_(e,!1),this.elevationBufferData=new f_(e,!0),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.hasPattern=u_("fill",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:f,id:_,index:g,sourceLayerIndex:v}of e){const b=this.layers[0]._featureFilter.needGeometry,w=Te(f,b);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),w,s))continue;const I=u?u.evaluate(w,{},s,i.availableImages):void 0,A={id:_,properties:f.properties,type:f.type,sourceLayerIndex:v,index:g,geometry:b?w.geometry:Le(f,s,a),patterns:{},sortKey:I};h.push(A)}u&&h.sort(((f,_)=>f.sortKey-_.sortKey));for(const f of h){const{geometry:_,index:g,sourceLayerIndex:v}=f;if(this.hasPattern){const b=h_("fill",this.layers,f,this.zoom,this.pixelRatio,i);this.patternFeatures.push(b)}else this.addFeature(f,_,g,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[g].feature,_,g,v,this.index)}}update(e,i,s,a,u,h,f){this.bufferData.update(e,i,s,a,u,h,f,this.worldview),this.elevationBufferData.update(e,i,s,a,u,h,f,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,s,a,u,h,f,this.worldview)}addFeatures(e,i,s,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,h,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,s,a,u,h=[],f,_){const g=Cd(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,g,a,s,_):this.addGeometry(g,this.bufferData),this.bufferData.populatePaintArrays(e,s,u,h,a,f,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,u,h,a,f,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,s,a,u){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,s,a,u,this.worldview))}addElevatedRoadFeature(e,i,s,a,u){const h=new Array,f=qt.getElevationFeature(e,u);if(!f)return void this.addGeometry(i,this.bufferData);{const g=this.clipPolygonsToTile(i,1);g.length>0&&h.push({polygons:g,elevationFeature:f,elevationTileID:s})}const _={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:a};for(const g of h)if(g.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new io(g.elevationTileID,this.layers,this.zoom,this.lut));const b=g.elevationFeature.isTunnel();let w=0;e.properties.hasOwnProperty(ft)&&(w=+e.properties[ft]);for(const I of g.polygons)this.elevatedStructures.addPortalCandidates(g.elevationFeature.id,I,b,g.elevationFeature,w)}g.elevationFeature.constantHeight==null&&(g.polygons=this.prepareElevatedPolygons(g.polygons,g.elevationFeature,g.elevationTileID));const v=new Ti(s,g.elevationTileID);this.addElevatedGeometry(g.polygons,v,g.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,_)}}addElevatedGeometry(e,i,s,a,u,h){const f={elevation:s,elevationSampler:i,bias:a,index:u,featureInfo:h},[_,g]=this.addGeometry(e,this.elevationBufferData,f);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:_,max:g}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,_),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,g))}addGeometry(e,i,s){let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,h=null;s&&(h=s.elevationSampler.constantElevation(s.elevation,s.bias),h!=null&&(a=h,u=h));const f=(_,g,v)=>{if(s!=null)if(g.push(_),h!=null)i.elevatedLayoutVertexArray.emplaceBack(h),v.push(h);else{const b=s.elevationSampler.pointElevation(_,s.elevation,s.bias);i.elevatedLayoutVertexArray.emplaceBack(b),v.push(b),a=Math.min(a,b),u=Math.max(u,b)}};for(const _ of e){let g=0;for(const G of _)g+=G.length;const v=i.triangleSegments.prepareSegment(g,i.layoutVertexArray,i.indexArray),b=v.vertexLength,w=[],I=[],A=[],R=[],L=[],k=i.layoutVertexArray.length;for(const G of _){if(G.length===0)continue;G!==_[0]&&I.push(w.length/2);const q=i.lineSegments.prepareSegment(G.length,i.layoutVertexArray,i.lineIndexArray),ie=q.vertexLength;s&&L.push(i.layoutVertexArray.length-k),f(G[0],A,R),i.layoutVertexArray.emplaceBack(G[0].x,G[0].y),i.lineIndexArray.emplaceBack(ie+G.length-1,ie),w.push(G[0].x),w.push(G[0].y);for(let J=1;J<G.length;J++)f(G[J],A,R),i.layoutVertexArray.emplaceBack(G[J].x,G[J].y),i.lineIndexArray.emplaceBack(ie+J-1,ie+J),w.push(G[J].x),w.push(G[J].y);q.vertexLength+=G.length,q.primitiveLength+=G.length}const U=Fu(w,I);for(let G=0;G<U.length;G+=3)i.indexArray.emplaceBack(b+U[G],b+U[G+1],b+U[G+2]);if(U.length>0&&s&&this.elevationMode==="hd-road-base"){const G=s.elevation.isTunnel(),q=s.elevation.safeArea,ie=this.elevatedStructures.addVertices(A,R);this.elevatedStructures.addTriangles(U,ie,G);const J=L.length;if(J>0){for(let se=0;se<J-1;se++)this.elevatedStructures.addRenderableRing(s.index,L[se]+ie,L[se+1]-L[se],G,q,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,L[J-1]+ie,A.length-L[J-1],G,q,s.featureInfo)}}v.vertexLength+=g,v.primitiveLength+=U.length/3}return[a,u]}prepareElevatedPolygons(e,i,s){const a=1/ne(s),u=[];for(const h of e){const f=i1(h,new br(i,a));u.push(...f)}return u}clipPolygonsToTile(e,i){const s=-i,a=-i,u=it+i,h=it+i;let f=0;const _=[],g=[];for(;f<e.length;f++){const w=e[f],I=rc(w);(I.min.x>=s&&I.max.x<=u&&I.min.y>=a&&I.max.y<=h?_:g).push(w)}if(_.length===e.length)return e;const v=[new Be(s,a),new Be(u,a),new Be(u,h),new Be(s,h),new Be(s,a)],b=_;for(const w of g)b.push(...t1(w,v));return b}}let Sy,Ey,Iy,Ay;mt(p_,"FillBucket",{omit:["layers","patternFeatures"]}),mt(f_,"FillBufferData"),mt(io,"ElevatedStructures");class wp{constructor(e,i,s,a){if(this.triangleCount=i.length/3,this.min=new Be(0,0),this.max=new Be(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[u,h]=[e[0].clone(),e[0].clone()];for(let b=1;b<e.length;++b){const w=e[b];u.x=Math.min(u.x,w.x),u.y=Math.min(u.y,w.y),h.x=Math.max(h.x,w.x),h.y=Math.max(h.y,w.y)}if(a){const b=Math.ceil(Math.max(h.x-u.x,h.y-u.y)/a);s=Math.max(s,b)}if(s===0)return;this.min=u,this.max=h;const f=this.max.sub(this.min);f.x=Math.max(f.x,1),f.y=Math.max(f.y,1);const _=Math.max(f.x,f.y)/s;this.cellsX=Math.max(1,Math.ceil(f.x/_)),this.cellsY=Math.max(1,Math.ceil(f.y/_)),this.xScale=1/_,this.yScale=1/_;const g=[];for(let b=0;b<this.triangleCount;b++){const w=e[i[3*b+0]].sub(this.min),I=e[i[3*b+1]].sub(this.min),A=e[i[3*b+2]].sub(this.min),R=ga(Math.floor(Math.min(w.x,I.x,A.x)),this.xScale,this.cellsX),L=ga(Math.floor(Math.max(w.x,I.x,A.x)),this.xScale,this.cellsX),k=ga(Math.floor(Math.min(w.y,I.y,A.y)),this.yScale,this.cellsY),U=ga(Math.floor(Math.max(w.y,I.y,A.y)),this.yScale,this.cellsY),G=new Be(0,0),q=new Be(0,0),ie=new Be(0,0),J=new Be(0,0);for(let se=k;se<=U;++se){G.y=q.y=se*_,ie.y=J.y=(se+1)*_;for(let le=R;le<=L;++le)G.x=ie.x=le*_,q.x=J.x=(le+1)*_,(an(w,I,A,G,q,J)||an(w,I,A,G,J,ie))&&g.push({cellIdx:se*this.cellsX+le,triIdx:b})}}if(g.length===0)return;g.sort(((b,w)=>b.cellIdx-w.cellIdx||b.triIdx-w.triIdx));let v=0;for(;v<g.length;){const b=g[v].cellIdx,w={start:this.payload.length,len:0};for(;v<g.length&&g[v].cellIdx===b;)++w.len,this.payload.push(g[v++].triIdx);this.cells[b]=w}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const s=ga(e.x-this.min.x,this.xScale,this.cellsX),a=ga(e.y-this.min.y,this.yScale,this.cellsY),u=this.cells[a*this.cellsX+s];if(u){this._lazyInitLookup();for(let h=0;h<u.len;h++){const f=this.payload[u.start+h],_=Math.floor(f/8),g=1<<f%8;if(!(this.lookup[_]&g)&&(this.lookup[_]|=g,i.push(f),i.length===this.triangleCount))return}}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const a=ga(e.x-this.min.x,this.xScale,this.cellsX),u=ga(i.x-this.min.x,this.xScale,this.cellsX),h=ga(e.y-this.min.y,this.yScale,this.cellsY),f=ga(i.y-this.min.y,this.yScale,this.cellsY);for(let _=h;_<=f;_++)for(let g=a;g<=u;g++){const v=this.cells[_*this.cellsX+g];if(v)for(let b=0;b<v.len;b++){const w=this.payload[v.start+b],I=Math.floor(w/8),A=1<<w%8;if(!(this.lookup[I]&A)&&(this.lookup[I]|=A,s.push(w),s.length===this.triangleCount))return}}}}function ga(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}mt(wp,"TriangleGridIndex");class My{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){for(const s of this.footprints)i.push({footprint:s,id:e})}updateAppearances(e,i,s,a){}populate(e,i,s,a){const u=[];for(const{feature:h,id:f,index:_,sourceLayerIndex:g}of e){const v=this.layers[0]._featureFilter.needGeometry,b=Te(h,v);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),b,s))continue;const w={id:f,properties:h.properties,type:h.type,sourceLayerIndex:g,index:_,geometry:v?b.geometry:Le(h,s,a),patterns:{}};u.push(w)}for(const h of u){const{geometry:f,index:_,sourceLayerIndex:g}=h;this.addFeature(h,f,_,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[_].feature,f,_,g,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,s,a,u,h,f){}destroy(){}addFeature(e,i,s,a,u,h=[],f){for(const _ of Cd(i,2)){const g=[],v=[],b=[],w=new Be(1/0,1/0),I=new Be(-1/0,-1/0);for(const L of _)if(L.length!==0){L!==_[0]&&b.push(v.length/2);for(let k=0;k<L.length;k++)v.push(L[k].x),v.push(L[k].y),g.push(L[k]),w.x=Math.min(w.x,L[k].x),w.y=Math.min(w.y,L[k].y),I.x=Math.max(I.x,L[k].x),I.y=Math.max(I.y,L[k].y)}const A=Fu(v,b),R=new wp(g,A,8,256);this.footprints.push({vertices:g,indices:A,grid:R,min:w,max:I})}}}mt(My,"ClipBucket",{omit:["layers"]});const r1=fi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),n1=fi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),s1=fi([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),o1=fi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),a1=fi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),l1=fi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),c1=fi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:u1}=r1,Pd=Number.MAX_SAFE_INTEGER,Cy=Pd-1;function Py(r,e,i,s){return r.order<e||r.order===Pd||!(r.clipMask&i)||(function(a,u){return u.length!==0&&u.find((h=>h===a))===void 0})(s,r.clipScope)}function Tp(r,e){return r.x-e.x||r.y-e.y}function Ry(r,e){return Tp(r.min,e.min)===0&&Tp(r.max,e.max)===0}function m_(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function Sp(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!Ry(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!On(r[i].clipScope,e[i].clipScope))return!1;return!0}function Dy(r,e,i){const s=1/it,a=1/(1<<i.canonical.z),u=(e.x*s+i.canonical.x)*a+i.wrap,h=(e.y*s+i.canonical.y)*a;return{min:new Be((r.x*s+i.canonical.x)*a+i.wrap,(r.y*s+i.canonical.y)*a),max:new Be(u,h)}}function h1(r,e,i){const s=1<<i.canonical.z,a=((e.x-i.wrap)*s-i.canonical.x)*it,u=(e.y*s-i.canonical.y)*it;return{min:new Be(((r.x-i.wrap)*s-i.canonical.x)*it,(r.y*s-i.canonical.y)*it),max:new Be(a,u)}}function __(r,e,i,s,a,u,h){const f=r.indices,_=r.vertices,g=[];for(let v=s;v<s+a;v+=3){const b=e[i[v+0]+u],w=e[i[v+1]+u],I=e[i[v+2]+u],A=Math.min(b.x,w.x,I.x),R=Math.max(b.x,w.x,I.x),L=Math.min(b.y,w.y,I.y),k=Math.max(b.y,w.y,I.y);g.length=0,r.grid.query(new Be(A,L),new Be(R,k),g);for(let U=0;U<g.length;U++){const G=g[U];if(an(_[f[3*G+0]],_[f[3*G+1]],_[f[3*G+2]],b,w,I,h))return!0}}return!1}function zy(r,e,i,s){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return zy(i,s,r,e);const u=e.canonical,h=s.canonical,f=Math.pow(2,h.z-u.z);a=r.vertices.map((_=>new Be((_.x+u.x*it)*f-h.x*it,(_.y+u.y*it)*f-h.y*it)))}return __(i,a,r.indices,0,r.indices.length,0,0)}function Ly(r,e,i,s){const a=Math.pow(2,s.z-i.z);return new Be((r+i.x*it)*a-s.x*it,(e+i.y*it)*a-s.y*it)}function g_(r,e){const i=[];e.grid.queryPoint(r,i);const s=e.indices,a=e.vertices;for(let u=0;u<i.length;u++){const h=i[u];if(Fn([a[s[3*h+0]],a[s[3*h+1]],a[s[3*h+2]]],r))return!0}return!1}const y_=[new Be(0,0),new Be(it,0),new Be(it,it),new Be(0,it)];function Oy(r,e){const i=[];let s=[];if(!e||r.length<2)return[r];if(r.length===2)return rn(r[0],r[1],y_)?[r]:[];for(let a=0;a<r.length+2;a++){const u=r[a%r.length],h=r[(a+1)%r.length],f=rn(a===0?r[r.length-1]:r[(a-1)%r.length],u,y_),_=rn(u,h,y_),g=f||_;g&&s.push(u),g&&_||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}const x_=je.types,d1=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],f1=["fill-extrusion-flood-light-ground-radius"],p1=Math.pow(2,13),m1=Math.pow(2,15)-1,ky=new Be(0,1),Dl=2147483648,Fy=7,By=450;function Rd(r,e,i,s,a,u,h,f){r.emplaceBack((e<<1)+h,(i<<1)+u,(Math.floor(s*p1)<<1)+a,Math.round(f))}function Dd(r,e,i){r.emplaceBack(e.x*it,e.y*it,i?1:0)}function Ep(r,e,i,s,a,u){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+a,u)}function zd(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Ny{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Vy{constructor(){this.centroidXY=new Be(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Be(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Be(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Be(this.max.x-this.min.x,this.max.y-this.min.y)}}class Uy{constructor(){this.acc=new Be(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===it)&&i.x===s.x)!=((i.y===0||i.y===it)&&i.y===s.y)&&this.processBorderOverlap(i,s),a&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Vt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>it!=e.x>it&&this.addBorderIntersection(1,Vt(i.y,e.y,(it-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Vt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>it!=e.y>it&&this.addBorderIntersection(3,Vt(i.x,e.x,(it-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{const s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new Be(0,0):new Be(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,i)=>e+ +(i[0]!==Number.MAX_VALUE)),0):0}}function jy(r,e){const i=r.add(e)._unit(),s=B(r.x*i.x+r.y*i.y,-1,1);var a,u,h;return a=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(a)))/4*m1*((u=r).x*(h=e).y-u.y*h.x<0?-1:1)}const _1=[r=>r.x<0,r=>r.x>it,r=>r.y<0,r=>r.y>it];function g1(r,e,i,s){const a=[4];if(s===0)return a;i._mult(s);const u=r.sub(i),h=e.sub(i),f=[r,e,u,h];for(let _=0;_<4;_++)for(const g of f)if(_1[_](g)){a.push(_);break}return a}class v_{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new wu,this.indexArray=new zr,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut},(i=>f1.includes(i))),this._segments=new Vr,this.hiddenByLandmarkVertexArray=new Cu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Vr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,a=!1){const u=e.length;if(u>2){let h=Math.max(0,this._segments.get().length-1);const f=this._segments._prepareSegment(4*u,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let _;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const g=e[0],v=e[1];_=jy(g.sub(e[u-1])._perp()._unit(),v.sub(g)._perp()._unit())}for(let g=0;g<u;g++){const v=g===u-1?0:g+1,b=e[g],w=e[v],I=e[v===u-1?0:v+1],A=w.sub(b)._perp()._unit(),R=jy(A,I.sub(w)._perp()._unit()),L=_,k=R;if(b_(b,w,i)||a&&qy(b,i)&&qy(w,i)){_=R;continue}const U=f.vertexLength;Ep(this.vertexArray,b,w,1,1,L),Ep(this.vertexArray,b,w,1,0,L),Ep(this.vertexArray,b,w,0,1,k),Ep(this.vertexArray,b,w,0,0,k),f.vertexLength+=4;const G=g1(b,w,A,s);for(const q of G)this._segmentToGroundQuads[h].push({id:U,region:q}),this._segmentToRegionTriCounts[h][q]+=2,f.primitiveLength+=2;_=R}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort(((a,u)=>a.region-u.region));for(let s=0;s<i;s++){const a=this._segmentToGroundQuads[s],u=e[s],h=this._segmentToRegionTriCounts[s];h.reduce(((_,g)=>_+g),0);let f=0;for(let _=0;_<=4;_++){const g=h[_];if(g!==0){let v=this.regionSegments[_];v||(v=this.regionSegments[_]=new Vr);const b={vertexOffset:u.vertexOffset,primitiveOffset:u.primitiveOffset+f,vertexLength:u.vertexLength,primitiveLength:g};v.get().push(b)}f+=g}for(let _=0;_<a.length;_++){const g=a[_].id;this.indexArray.emplaceBack(g,g+1,g+3),this.indexArray.emplaceBack(g,g+3,g+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,a,u,h,f){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,a,u,h,void 0,f)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,n1.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,s1.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,a,u,h,f,_){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,a,u,h,f,_)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Dl))}updateHiddenByLandmarkRange(e,i,s){if(!this.hasData())return;const a=i+e;if(i!==0){for(let u=e;u<a;++u)this.hiddenByLandmarkVertexArray.emplace(u,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,l1.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class Ip{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new zr,this.footprintVertices=new Ps,this.footprintSegments=[],this.layoutVertexArray=new vl,this.centroidVertexArray=new ap,this.wallVertexArray=new cp,this.indexArray=new zr,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut},(i=>d1.includes(i))),this.segments=new Vr,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.groundEffect=new v_(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.features=[],this.hasPattern=u_("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=ne(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:u,id:h,index:f,sourceLayerIndex:_}of e){const g=this.layers[0]._featureFilter.needGeometry,v=Te(u,g);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),v,s))continue;const b={id:h,sourceLayerIndex:_,index:f,geometry:g?v.geometry:Le(u,s,a),properties:u.properties,type:u.type,patterns:{}},w=this.layoutVertexArray.length,I=x_[b.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:u.id,feature:h_("fill-extrusion",this.layers,b,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const A of b.geometry)for(const R of Oy(A,I))this.addFeature(u.id,b,[R],f,s,{},i.availableImages,a,i.brightness);else this.addFeature(u.id,b,b.geometry,f,s,{},i.availableImages,a,i.brightness);i.featureIndex.insert(u,b.geometry,f,_,this.index,w)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,a,u,h){for(const{featureId:f,feature:_}of this.features){const g=x_[_.type]==="Polygon",{geometry:v}=_;if(this.wallMode)for(const b of v)for(const w of Oy(b,g))this.addFeature(f,_,[w],_.index,i,s,a,u,h);else this.addFeature(f,_,v,_.index,i,s,a,u,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview),this.groundEffect.update(e,i,u,s,a,h,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,u1),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,a1.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,c1.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,o1.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,a,u,h,f,_,g){const v=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,b=[new Be(0,0),new Be(it,it)],w=_.projection,I=w.name==="globe",A=this.wallMode||x_[i.type]==="Polygon",R=new Uy;R.centroidDataIndex=this.centroidData.length;const L=new Vy;L.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(L.buildingId=i.properties.building_id);const k=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},u)<=0,U=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},u);let G;if(L.height=U,L.vertexArrayOffset=this.layoutVertexArray.length,L.groundVertexArrayOffset=this.groundEffect.vertexArray.length,I&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Su),this.wallMode){if(I)return void Mt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;G=(function(ye){const Pe=ye[0].x===ye[ye.length-1].x&&ye[0].y===ye[ye.length-1].y;(function(ht){let st=0;const $t=ht.length;for(let at=0;at<$t;at++)st+=(ht[(at+1)%$t].x-ht[at].x)*(ht[(at+1)%$t].y+ht[at].y);return st>=0})(ye)||(ye=ye.reverse());const Ve={geometry:[],joinNormals:[],indices:[]},Qe=[],qe=[],Fe=[];let He=ye.length;for(;He>=2&&ye[He-1].equals(ye[He-2]);)He--;if(He<(Pe?3:2))return Ve;let Ae,Ee,Ge,Ye,Ne,pt=0;for(;pt<He-1&&ye[pt].equals(ye[pt+1]);)pt++;Pe&&(Ae=ye[He-2],Ne=ye[pt].sub(Ae)._unit()._perp());for(let ht=pt;ht<He;ht++){if(Ge=ht===He-1?Pe?ye[pt+1]:void 0:ye[ht+1],Ge&&ye[ht].equals(Ge))continue;Ne&&(Ye=Ne),Ae&&(Ee=Ae),Ae=ye[ht],Ne=Ge?Ge.sub(Ae)._unit()._perp():Ye,Ye=Ye||Ne;let st=Ye.add(Ne);st.x===0&&st.y===0||st._unit();const $t=st.x*Ne.x+st.y*Ne.y,at=$t!==0?1/$t:1/0,Ct=Ye.x*Ne.y-Ye.y*Ne.x>0;let Wt="miter";const oi=2;Wt==="miter"&&at>oi&&(Wt="bevel"),Wt==="bevel"&&(at>100&&(Wt="flipbevel"),at<oi&&(Wt="miter"));const Si=(Yt,zi,Li,kr)=>{const Q=new Be(Yt.x,Yt.y),Y=new Be(Yt.x,Yt.y);Q.x+=zi.x*kr,Q.y+=zi.y*kr,Y.x-=zi.x*Math.max(Li,1),Y.y-=zi.y*Math.max(Li,1),Fe.push(zi),Qe.push(Q),qe.push(Y)};if(Wt==="miter")st._mult(at),Si(Ae,st,0,0);else if(Wt==="flipbevel")st=Ne.mult(-1),Si(Ae,st,0,0),Si(Ae,st.mult(-1),0,0);else{const Yt=-Math.sqrt(at*at-1),zi=Ct?Yt:0,Li=Ct?0:Yt;Ee&&Si(Ae,Ye,zi,Li),Ge&&Si(Ae,Ne,zi,Li)}}Ve.geometry=[...Qe,...qe.reverse(),Qe[0]],Ve.joinNormals=[...Fe,...Fe.reverse(),Fe[Fe.length-1]];const yt=Ve.geometry.length-1;for(let ht=0;ht<yt/2;ht++)if(ht+1<yt/2){let st=ht,$t=ht+1,at=yt-1-ht,Ct=yt-2-ht;st=st===0?yt-1:st-1,$t=$t===0?yt-1:$t-1,at=at===0?yt-1:at-1,Ct=Ct===0?yt-1:Ct-1,Ve.indices.push(at),Ve.indices.push($t),Ve.indices.push(st),Ve.indices.push(at),Ve.indices.push(Ct),Ve.indices.push($t)}return Ve})(s[0]),s=[G.geometry]}const q=(ye,Pe)=>ye<(Pe.length-1)/2||ye===Pe.length-1,ie=this.wallMode?[s]:Cd(s,500);for(let ye=ie.length-1;ye>=0;ye--){const Pe=ie[ye];(Pe.length===0||(J=Pe[0]).every((ke=>ke.x<=0))||J.every((ke=>ke.x>=it))||J.every((ke=>ke.y<=0))||J.every((ke=>ke.y>=it)))&&ie.splice(ye,1)}var J;let se;if(I)se=Xy(ie,b,u);else{se=[];for(const ye of ie)se.push({polygon:ye,bounds:b})}const le=A?this.edgeRadius:0,he=le>0&&this.zoom<17,Ce=(ye,Pe)=>{if(ye.length===0)return!1;const ke=ye[ye.length-1];return Pe.x===ke.x&&Pe.y===ke.y};for(const{polygon:ye,bounds:Pe}of se){let ke=0,Ve=0;for(const He of ye)A&&!He[0].equals(He[He.length-1])&&He.push(He[0]),Ve+=A?He.length-1:He.length;const Qe=this.segments.prepareSegment((A?5:4)*Ve,this.layoutVertexArray,this.indexArray);L.footprintSegIdx<0&&(L.footprintSegIdx=this.footprintSegments.length),L.polygonSegIdx<0&&(L.polygonSegIdx=this.polygonSegments.length);const qe={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Fe=new Ny;if(Fe.vertexOffset=this.footprintVertices.length,Fe.indexOffset=3*this.footprintIndices.length,Fe.ringIndices=[],A){const He=[],Ae=[];ke=Qe.vertexLength;for(let Ge=0;Ge<ye.length;Ge++){const Ye=ye[Ge];Ye.length&&Ge!==0&&Ae.push(He.length/2);const Ne=[];let pt,yt;pt=Ye[1].sub(Ye[0])._perp()._unit(),Fe.ringIndices.push(Ye.length-1);for(let ht=1;ht<Ye.length;ht++){const st=Ye[ht],$t=Ye[ht===Ye.length-1?1:ht+1],at=st.clone();if(le){yt=$t.sub(st)._perp()._unit();const Ct=pt.add(yt)._unit(),Wt=le*Math.min(4,1/(pt.x*Ct.x+pt.y*Ct.y));at.x+=Wt*Ct.x,at.y+=Wt*Ct.y,at.x=Math.round(at.x),at.y=Math.round(at.y),pt=yt}if(!k||le!==0&&!he||Ce(Ne,at)||Ne.push(at),Rd(this.layoutVertexArray,at.x,at.y,0,0,1,1,0),this.wallMode){const Ct=q(ht,Ye);Dd(this.wallVertexArray,G.joinNormals[ht],!Ct)}Qe.vertexLength++,this.footprintVertices.emplaceBack(st.x,st.y),He.push(st.x,st.y),I&&zd(this.layoutVertexExtArray,w.projectTilePoint(at.x,at.y,u),w.upVector(u,at.x,at.y))}k&&(le===0||he)&&(Ne.length!==0&&Ce(Ne,Ne[0])&&Ne.pop(),this.groundEffect.addData(Ne,Pe,v))}const Ee=this.wallMode?G.indices:Fu(He,Ae);for(let Ge=0;Ge<Ee.length;Ge+=3)this.footprintIndices.emplaceBack(Fe.vertexOffset+Ee[Ge+0],Fe.vertexOffset+Ee[Ge+1],Fe.vertexOffset+Ee[Ge+2]),this.indexArray.emplaceBack(ke+Ee[Ge],ke+Ee[Ge+2],ke+Ee[Ge+1]),Qe.primitiveLength++;Fe.indexCount+=Ee.length,Fe.vertexCount+=this.footprintVertices.length-Fe.vertexOffset}for(let He=0;He<ye.length;He++){const Ae=ye[He];R.startRing(L,Ae[0]);let Ee=Ae.length>4&&$y(Ae[Ae.length-2],Ae[0],Ae[1]),Ge=le?y1(Ae[Ae.length-2],Ae[0],Ae[1],le):0;const Ye=[];let Ne,pt,yt;pt=Ae[1].sub(Ae[0])._perp()._unit();let ht=!0;for(let st=1,$t=0;st<Ae.length;st++){let at=Ae[st-1],Ct=Ae[st];const Wt=Ae[st===Ae.length-1?1:st+1];if(R.appendEdge(L,Ct,at),b_(Ct,at,Pe)){le&&(pt=Wt.sub(Ct)._perp()._unit(),ht=!ht);continue}const oi=Ct.sub(at)._perp(),Si=oi.x/(Math.abs(oi.x)+Math.abs(oi.y)),Yt=oi.y>0?1:0,zi=at.dist(Ct);if($t+zi>32768&&($t=0),le){yt=Wt.sub(Ct)._perp()._unit();let Y=Hy(at,Ct,Wt,Gy(pt,yt),le);isNaN(Y)&&(Y=0);const Re=Ct.sub(at)._unit();at=at.add(Re.mult(Ge))._round(),Ct=Ct.add(Re.mult(-Y))._round(),Ge=Y,pt=yt,k&&this.zoom>=17&&(Ce(Ye,at)||Ye.push(at),Ce(Ye,Ct)||Ye.push(Ct))}const Li=Qe.vertexLength,kr=Ae.length>4&&$y(at,Ct,Wt);let Q=Zy($t,Ee,ht);if(Rd(this.layoutVertexArray,at.x,at.y,Si,Yt,0,0,Q),Rd(this.layoutVertexArray,at.x,at.y,Si,Yt,0,1,Q),this.wallMode){const Y=q(st-1,Ae),Re=G.joinNormals[st-1];Dd(this.wallVertexArray,Re,Y),Dd(this.wallVertexArray,Re,Y)}if($t+=zi,Q=Zy($t,kr,!ht),Ee=kr,Rd(this.layoutVertexArray,Ct.x,Ct.y,Si,Yt,0,0,Q),Rd(this.layoutVertexArray,Ct.x,Ct.y,Si,Yt,0,1,Q),this.wallMode){const Y=q(st,Ae),Re=G.joinNormals[st];Dd(this.wallVertexArray,Re,Y),Dd(this.wallVertexArray,Re,Y)}if(Qe.vertexLength+=4,this.indexArray.emplaceBack(Li+0,Li+1,Li+2),this.indexArray.emplaceBack(Li+1,Li+3,Li+2),Qe.primitiveLength+=2,le){const Y=ke+(st===1?Ae.length-2:st-2),Re=st===1?ke:Y+1;if(this.indexArray.emplaceBack(Li+1,Y,Li+3),this.indexArray.emplaceBack(Y,Re,Li+3),Qe.primitiveLength+=2,Ne===void 0&&(Ne=Li),!b_(Wt,Ae[st],Pe)){const nt=st===Ae.length-1?Ne:Qe.vertexLength;this.indexArray.emplaceBack(Li+2,Li+3,nt),this.indexArray.emplaceBack(Li+3,nt+1,nt),this.indexArray.emplaceBack(Li+3,Re,nt+1),Qe.primitiveLength+=3}ht=!ht}if(I){const Y=this.layoutVertexExtArray,Re=w.projectTilePoint(at.x,at.y,u),nt=w.projectTilePoint(Ct.x,Ct.y,u),De=w.upVector(u,at.x,at.y),ot=w.upVector(u,Ct.x,Ct.y);zd(Y,Re,De),zd(Y,Re,De),zd(Y,nt,ot),zd(Y,nt,ot)}}A&&(ke+=Ae.length-1),k&&le&&this.zoom>=17&&(Ye.length!==0&&Ce(Ye,Ye[0])&&Ye.pop(),this.groundEffect.addData(Ye,Pe,v,le>0))}this.footprintSegments.push(Fe),qe.triangleCount=this.indexArray.length-qe.triangleArrayOffset,this.polygonSegments.push(qe),++L.footprintSegLen,++L.polygonSegLen}if(L.vertexCount=this.layoutVertexArray.length-L.vertexArrayOffset,L.groundVertexCount=this.groundEffect.vertexArray.length-L.groundVertexArrayOffset,L.vertexCount!==0){if(L.centroidXY=R.borders?ky:this.encodeCentroid(R,L),this.centroidData.push(L),R.borders){this.featuresOnBorder.push(R);const ye=this.featuresOnBorder.length-1;for(let Pe=0;Pe<R.borders.length;Pe++)R.borders[Pe][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Pe].push(ye)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,h,f,u,g,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,h,f,u,g,this.worldview),this.maxHeight=Math.max(this.maxHeight,U)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0]))}splitToSubtiles(){const e=[];for(let f=0;f<this.centroidData.length;f++){const _=this.centroidData[f],g=+(_.min.y+_.max.y>it),v=2*g+(+(_.min.x+_.max.x>it)^g);for(let b=0;b<_.polygonSegLen;b++){const w=_.polygonSegIdx+b;e.push({centroidIdx:f,subtile:v,polygonSegmentIdx:w,triangleSegmentIdx:this.polygonSegments[w].triangleSegIdx})}}const i=new zr;e.sort(((f,_)=>f.triangleSegmentIdx===_.triangleSegmentIdx?f.subtile-_.subtile:f.triangleSegmentIdx-_.triangleSegmentIdx));let s=0,a=0,u=0;for(const f of e){if(f.triangleSegmentIdx!==s)break;u++}const h=e.length;for(;a!==e.length;){s=e[a].triangleSegmentIdx;let f=0,_=a,g=a;for(let v=_;v<u&&e[v].subtile===f;v++)g++;for(;_!==u;){const v=e[_];f=v.subtile;const b=this.centroidData[v.centroidIdx].min.clone(),w=this.centroidData[v.centroidIdx].max.clone(),I={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let A=_;A<g;A++){const R=e[A],L=this.polygonSegments[R.polygonSegmentIdx],k=this.centroidData[R.centroidIdx].min,U=this.centroidData[R.centroidIdx].max,G=this.indexArray.uint16;for(let q=L.triangleArrayOffset;q<L.triangleArrayOffset+L.triangleCount;q++)i.emplaceBack(G[3*q],G[3*q+1],G[3*q+2]);I.primitiveLength+=L.triangleCount,b.x=Math.min(b.x,k.x),b.y=Math.min(b.y,k.y),w.x=Math.max(w.x,U.x),w.y=Math.max(w.y,U.y)}I.primitiveLength>0&&this.triangleSubSegments.push({segment:I,min:b,max:w}),_=g;for(let A=_;A<u&&e[A].subtile===e[_].subtile;A++)g++}a=u;for(let v=a;v<h&&e[v].triangleSegmentIdx===e[a].triangleSegmentIdx;v++)u++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){const a=new Vr;if(this.wallMode){for(const R of this.triangleSubSegments)a.segments.push(R.segment);return a}let u=0,h=0;const f=1<<e.canonical.z;if(i){const R=i.getMinMaxForTile(e);R&&(u=R.min,h=R.max)}h+=this.maxHeight;const _=e.toUnwrapped();let g;const v=[_.canonical.x/f+_.wrap,_.canonical.y/f],b=[(_.canonical.x+1)/f+_.wrap,(_.canonical.y+1)/f],w=(R,L,k)=>[R[0]*(1-k[0])+L[0]*k[0],R[1]*(1-k[1])+L[1]*k[1]],I=[],A=[];for(const R of this.triangleSubSegments){I[0]=R.min.x/it,I[1]=R.min.y/it,A[0]=R.max.x/it,A[1]=R.max.y/it;const L=w(v,b,I),k=w(v,b,A);if(new si([L[0],L[1],u],[k[0],k[1],h]).intersectsPrecise(s)===0){g&&(a.segments.push(g),g=void 0);continue}const U=R.segment;g&&g.vertexOffset!==U.vertexOffset&&(a.segments.push(g),g=void 0),g?(g.vertexLength+=U.vertexLength,g.primitiveLength+=U.primitiveLength):g={vertexOffset:U.vertexOffset,primitiveLength:U.primitiveLength,vertexLength:U.vertexLength,primitiveOffset:U.primitiveOffset,sortKey:void 0,vaos:{}}}return g&&a.segments.push(g),a}encodeCentroid(e,i){const s=e.centroid(),a=i.span(),u=Math.min(7,Math.round(a.x*this.tileToMeter/10)),h=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new Be(B(s.x,1,it-1)<<3|u,B(s.y,1,it-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new Be(0,0);const i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){const a=i[0][0]!==s?0:1;return new Be(6|(i[0][0]!==s?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{const a=i[2][0]!==s?2:3;return new Be((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,a=e.flags&Dl?ky:e.centroidXY,u=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||u!==a.x){for(let h=i;h<s;++h)this.centroidVertexArray.emplace(h,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Sp(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const u=[];for(const h of this.activeReplacements){if(h.order<s)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));if(h.footprint.buildingId){const _=h.footprint.buildingId;for(const g of this.centroidData)g.buildingId===_&&(g.flags|=Dl)}else for(const _ of this.centroidData)if(!(_.flags&Dl||h.min.x>_.max.x||_.min.x>h.max.x||h.min.y>_.max.y||_.min.y>h.max.y))for(let g=0;g<_.footprintSegLen;g++){const v=this.footprintSegments[_.footprintSegIdx+g];if(u.length=0,x1(this.footprintVertices,v.vertexOffset,v.vertexCount,h.footprintTileId.canonical,e.canonical,u),__(h.footprint,u,this.footprintIndices.uint16,v.indexOffset,v.indexCount,-v.vertexOffset,-f)){_.flags|=Dl;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let a=!1;for(let u=0;u<s.footprintSegLen;u++){const h=this.footprintSegments[s.footprintSegIdx+u];let f=0;for(const _ of h.ringIndices){for(let g=f,v=_+f-1;g<_+f;v=g++){const b=this.footprintVertices.int16[2*(g+h.vertexOffset)+0],w=this.footprintVertices.int16[2*(g+h.vertexOffset)+1],I=this.footprintVertices.int16[2*(v+h.vertexOffset)+1];w>i!=I>i&&e<(this.footprintVertices.int16[2*(v+h.vertexOffset)+0]-b)*(i-w)/(I-w)+b&&(a=!a)}f=_}}return a}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+it)*it+(i+it);if(this.partLookup.hasOwnProperty(u)){const h=this.partLookup[u];return h?{height:h.height,hidden:!!(h.flags&Dl)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||h.height<=s||this.footprintContainsPoint(e,i,h)&&(s=h.height,this.partLookup[u]=h,a=!!(h.flags&Dl));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.partLookup[u]=void 0}}function Gy(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function y1(r,e,i,s){const a=e.sub(r)._perp()._unit(),u=i.sub(e)._perp()._unit();return Hy(r,e,i,Gy(a,u),s)}function Hy(r,e,i,s,a){const u=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,a*u/s)}function b_(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function qy(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function $y(r,e,i){if(r.x<0||r.x>=it||e.x<0||e.x>=it||i.x<0||i.x>=it)return!1;const s=i.sub(e),a=s.perp(),u=r.sub(e);return(s.x*u.x+s.y*u.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(u.x*u.x+u.y*u.y))>-.866&&a.x*u.x+a.y*u.y<0}function Zy(r,e,i){const s=e?2|r:-3&r;return i?1|s:-2&s}function Wy(){const r=Math.PI/32,e=Math.tan(r),i=T;return i*Math.sqrt(1+2*e*e)-i}function Xy(r,e,i){const s=1<<i.z,a=Z(i.x/s),u=Z((i.x+1)/s),h=H(i.y/s),f=H((i.y+1)/s);return(function(_,g,v,b,w=0,I){const A=[];if(!_.length||!v||!b)return A;const R=(J,se)=>{for(const le of J)A.push({polygon:le,bounds:se})},L=Math.ceil(Math.log2(v)),k=Math.ceil(Math.log2(b)),U=L-k,G=[];for(let J=0;J<Math.abs(U);J++)G.push(U>0?0:1);for(let J=0;J<Math.min(L,k);J++)G.push(0),G.push(1);let q=_;if(q=bp(q,g[0].y-w,g[1].y+w,1),q=bp(q,g[0].x-w,g[1].x+w,0),!q.length)return A;const ie=[];for(G.length?ie.push({polygons:q,bounds:g,depth:0}):R(q,g);ie.length;){const J=ie.pop(),se=J.depth,le=G[se],he=J.bounds[0],Ce=J.bounds[1],ye=le===0?he.x:he.y,Pe=le===0?Ce.x:Ce.y,ke=I?I(le,ye,Pe):.5*(ye+Pe),Ve=bp(J.polygons,ye-w,ke+w,le),Qe=bp(J.polygons,ke-w,Pe+w,le);if(Ve.length){const qe=[he,new Be(le===0?ke:Ce.x,le===1?ke:Ce.y)];G.length>se+1?ie.push({polygons:Ve,bounds:qe,depth:se+1}):R(Ve,qe)}if(Qe.length){const qe=[new Be(le===0?ke:he.x,le===1?ke:he.y),Ce];G.length>se+1?ie.push({polygons:Qe,bounds:qe,depth:se+1}):R(Qe,qe)}}return A})(r,e,Math.ceil((u-a)/11.25),Math.ceil((h-f)/11.25),1,((_,g,v)=>{if(_===0)return .5*(g+v);{const b=H((i.y+g/it)/s);return(N(.5*(H((i.y+v/it)/s)+b))*s-i.y)*it}}))}function x1(r,e,i,s,a,u){const h=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let _=r.int16[2*(f+e)+0],g=r.int16[2*(f+e)+1];_=(_+a.x*it)*h-s.x*it,g=(g+a.y*it)*h-s.y*it,u.push(new Be(_,g))}}let Yy,Ky;mt(Ip,"FillExtrusionBucket",{omit:["layers","features"]}),mt(Vy,"PartData"),mt(Ny,"FootprintSegment"),mt(Uy,"BorderCentroidData"),mt(v_,"GroundEffect");class Ac extends Be{constructor(e,i,s){super(e,i),this.z=s}}class Jy extends Ac{constructor(e,i,s,a){super(e,i,s),this.w=a}}function Qy(r,e,i,s){const a=i==="x"?"y":"x",u=(s-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*u),r[i]=s,r.hasOwnProperty("z")&&(r.z=Vt(r.z,e.z,u)),r.hasOwnProperty("w")&&(r.w=Vt(r.w,e.w,u))}function ex(r,e,i,s){const a=i,u=s;for(const h of["x","y"]){let f=r,_=e;f[h]>=_[h]&&(f=e,_=r),f[h]<a&&_[h]>a&&Qy(f,_,h,a),f[h]<u&&_[h]>u&&Qy(_,f,h,u)}}function Ap(r,e,i,s,a,u){const h=[];for(let f=0;f<r.length;f++){const _=r[f];let g;const v=h.length;let b=0;for(let w=0;w<_.length-1;w++){let I=_[w],A=_[w+1],R=0;const L=b;let k,U;u&&(R=Math.hypot(A.x-I.x,A.y-I.y),b+=R,k=I,U=A),I.x<e&&A.x<e||(I.x<e?I=new Be(e,I.y+(e-I.x)/(A.x-I.x)*(A.y-I.y))._round():A.x<e&&(A=new Be(e,I.y+(e-I.x)/(A.x-I.x)*(A.y-I.y))._round()),I.y<i&&A.y<i||(I.y<i?I=new Be(I.x+(i-I.y)/(A.y-I.y)*(A.x-I.x),i)._round():A.y<i&&(A=new Be(I.x+(i-I.y)/(A.y-I.y)*(A.x-I.x),i)._round()),I.x>=s&&A.x>=s||(I.x>=s?I=new Be(s,I.y+(s-I.x)/(A.x-I.x)*(A.y-I.y))._round():A.x>=s&&(A=new Be(s,I.y+(s-I.x)/(A.x-I.x)*(A.y-I.y))._round()),I.y>=a&&A.y>=a||(I.y>=a?I=new Be(I.x+(a-I.y)/(A.y-I.y)*(A.x-I.x),a)._round():A.y>=a&&(A=new Be(I.x+(a-I.y)/(A.y-I.y)*(A.x-I.x),a)._round()),g&&I.equals(g[g.length-1])||(g=[I],h.push(g),u&&u.push({progress:{min:L+tx(k,U,I)*R,max:1},parentIndex:f,prevPoint:k,nextPoint:U})),g.push(A),u&&(u[u.length-1].progress.max=L+tx(k,U,A)*R,u[u.length-1].nextPoint=U)))))}if(u&&b>0)for(let w=v;w<h.length;w++)u[w].progress.min/=b,u[w].progress.max/=b}return h}function v1(r,e,i,s,a){if(r.length<2)return void s.push(r);const u=[];for(;e.valid();){const[g,v]=e.get();for(let b=0;b<r.length-1;b++){const w=r[b],I=r[b+1],A=Ks(w,I,g,v);if(A){const[R]=A,L=new Be(Vt(w.x,I.x,R),Vt(w.y,I.y,R));u.push({t:b+R,distance:0,point:L})}}e.next()}if(u.length===0)return void s.push(r);u.sort(((g,v)=>g.t-v.t));let h=0,f=0,_=[];for(s.push(_);h!==r.length;){if(f===u.length){for(;h!==r.length;)_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++;break}u[f].t<=h?(_.length!==0&&_[_.length-1].equals(u[f].point)||_.push(u[f].point),Math.trunc(u[f].t),f++):(_.length!==0&&_[_.length-1].equals(r[h])||_.push(r[h]),h++)}}function tx(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function Ld(r,e){return r.x*e.x+r.y*e.y}function ix(r,e){if(r.length===1){let i=0;const s=e[i++];let a;for(;!a||s.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){const u=e[i],h=r[0],f=a.sub(s),_=u.sub(s),g=h.sub(s),v=Ld(f,f),b=Ld(f,_),w=Ld(_,_),I=Ld(g,f),A=Ld(g,_),R=v*w-b*b,L=(w*I-b*A)/R,k=(v*A-b*I)/R,U=s.z*(1-L-k)+a.z*L+u.z*k;if(isFinite(U))return U}return 1/0}{let i=1/0;for(const s of e)i=Math.min(i,s.z);return i}}function rx(r,e,i){let s=1/0;Zr(i,e)&&(s=ix(i,e[0]));for(let a=0;a<e.length;a++){const u=e[a],h=r[a];for(let f=0;f<u.length-1;f++){const _=u[f],g=[_,u[f+1],h[f+1],h[f],_];tn(i,g)&&(s=Math.min(s,ix(i,g)))}}return s!==1/0&&s}function nx(r,e,i,s,a,u,h,f,_,g,v){return r.projection.name==="globe"?(function(b,w,I,A,R,L,k,U,G,q,ie){const J=[],se=[],le=b.projection.upVectorScale(ie,b.center.lat,b.worldSize).metersToTile,he=[0,0,0,1],Ce=[0,0,0,1],ye=(ke,Ve,Qe,qe)=>{ke[0]=Ve,ke[1]=Qe,ke[2]=qe,ke[3]=1},Pe=Wy();I>0&&(I+=Pe),A+=Pe;for(const ke of w){const Ve=[],Qe=[];for(const qe of ke){const Fe=qe.x+R.x,He=qe.y+R.y,Ae=b.projection.projectTilePoint(Fe,He,ie),Ee=b.projection.upVector(ie,qe.x,qe.y);let Ge=I,Ye=A;if(k){const Ne=sx(Fe,He,I,A,k,U,G,q);Ge+=Ne.base,Ye+=Ne.top}I!==0?ye(he,Ae.x+Ee[0]*le*Ge,Ae.y+Ee[1]*le*Ge,Ae.z+Ee[2]*le*Ge):ye(he,Ae.x,Ae.y,Ae.z),ye(Ce,Ae.x+Ee[0]*le*Ye,Ae.y+Ee[1]*le*Ye,Ae.z+Ee[2]*le*Ye),dr(he,he,L),dr(Ce,Ce,L),Ve.push(new Ac(he[0],he[1],he[2])),Qe.push(new Ac(Ce[0],Ce[1],Ce[2]))}J.push(Ve),se.push(Qe)}return[J,se]})(r,e,i,s,a,u,h,f,_,g,v):h?(function(b,w,I,A,R,L,k,U,G){const q=[],ie=[],J=[0,0,0,1];for(const se of b){const le=[],he=[];for(const Ce of se){const ye=Ce.x+A.x,Pe=Ce.y+A.y,ke=sx(ye,Pe,w,I,L,k,U,G);J[0]=ye,J[1]=Pe,J[2]=ke.base,J[3]=1,En(J,J,R),J[3]=Math.max(J[3],1e-5);const Ve=new Ac(J[0]/J[3],J[1]/J[3],J[2]/J[3]);J[0]=ye,J[1]=Pe,J[2]=ke.top,J[3]=1,En(J,J,R),J[3]=Math.max(J[3],1e-5);const Qe=new Ac(J[0]/J[3],J[1]/J[3],J[2]/J[3]);le.push(Ve),he.push(Qe)}q.push(le),ie.push(he)}return[q,ie]})(e,i,s,a,u,h,f,_,g):(function(b,w,I,A,R){const L=[],k=[],U=R[8]*w,G=R[9]*w,q=R[10]*w,ie=R[11]*w,J=R[8]*I,se=R[9]*I,le=R[10]*I,he=R[11]*I;for(const Ce of b){const ye=[],Pe=[];for(const ke of Ce){const Ve=ke.x+A.x,Qe=ke.y+A.y,qe=R[0]*Ve+R[4]*Qe+R[12],Fe=R[1]*Ve+R[5]*Qe+R[13],He=R[2]*Ve+R[6]*Qe+R[14],Ae=R[3]*Ve+R[7]*Qe+R[15],Ee=qe+U,Ge=Fe+G,Ye=He+q,Ne=Math.max(Ae+ie,1e-5),pt=qe+J,yt=Fe+se,ht=He+le,st=Math.max(Ae+he,1e-5);ye.push(new Ac(Ee/Ne,Ge/Ne,Ye/Ne)),Pe.push(new Ac(pt/st,yt/st,ht/st))}L.push(ye),k.push(Pe)}return[L,k]})(e,i,s,a,u)}function sx(r,e,i,s,a,u,h,f){const _=h*a.getElevationAt(r,e,!0,!0),g=u[0]!==0,v=g?u[1]===0?h*(u[0]/Fy-By):h*(function(b,w,I){const A=Math.floor(w[0]/8),R=Math.floor(w[1]/8),L=10*(w[0]-8*A),k=10*(w[1]-8*R),U=b.getElevationAt(A,R,!0,!0),G=b.getMeterToDEM(I),q=Math.floor(.5*(L*G-1)),ie=Math.floor(.5*(k*G-1)),J=b.tileCoordToPixel(A,R),se=2*q+1,le=2*ie+1,he=(function(Qe,qe,Fe,He,Ae){return[Qe.getElevationAtPixel(qe,Fe,!0),Qe.getElevationAtPixel(qe+Ae,Fe,!0),Qe.getElevationAtPixel(qe,Fe+Ae,!0),Qe.getElevationAtPixel(qe+He,Fe+Ae,!0)]})(b,J.x-q,J.y-ie,se,le),Ce=Math.abs(he[0]-he[1]),ye=Math.abs(he[2]-he[3]),Pe=Math.abs(he[0]-he[2])+Math.abs(he[1]-he[3]),ke=Math.min(.25,.5*G*(Ce+ye)/se),Ve=Math.min(.25,.5*G*Pe/le);return U+Math.max(ke*L,Ve*k)})(a,u,f):_;return{base:_+(i===0?-1:i),top:g?Math.max(v+s,_+i+2):_+s}}class b1{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class w1{constructor(){this.tasks={},this.taskQueue=[],be(["process"],this),this.invoker=new b1(this.process),this.nextId=0}add(e,i){const s=this.nextId++,a=(function({type:u,isSymbolTile:h,zoom:f}){return f=f||0,u==="message"?0:u!=="maybePrepare"||h?u!=="parseTile"||h?u==="parseTile"&&h?300-f:u==="maybePrepare"&&h?400-f:500:200-f:100-f})(i);if(a===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:a,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((s=>!!this.tasks[s])),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){const u=this.tasks[this.taskQueue[a]];u.priority<i&&(i=u.priority,e=a)}if(e===null)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class ox{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},be(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new w1}send(e,i,s,a,u=!1,h){const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=h,this.callbacks[f]=s);const _=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!s,targetMapId:a,mustQueue:u,sourceMapId:this.mapId,data:ua(i,_)},_),{cancel:()=>{s&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const a=this.cancelCallbacks[s];delete this.cancelCallbacks[s],a&&a.cancel()}else if(i.mustQueue||Sr(self)){const a=this.callbacks[s],u=this.scheduler.add((()=>this.processTask(s,i)),a&&a.metadata||{type:"message"});u&&(this.cancelCallbacks[s]=u)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(ha(i.error)):s(null,ha(i.data)))}else{const s=new Set,a=i.hasCallback?(h,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?ua(h):null,data:ua(f,s)},s)}:()=>{},u=ha(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,u,a);else if(this.parent.getWorkerSource){const h=i.type.split("."),{source:f,scope:_}=u;this.parent.getWorkerSource(i.sourceMapId,h[0],f,_)[h[1]](u,a)}else a(new Error("Could not find function ".concat(i.type)))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Od={workerUrl:"",workerClass:null,workerParams:void 0};const w_="mapboxgl_preloaded_worker_pool";class Mc{constructor(){this.active={}}acquire(e,i=Mc.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(Od.workerClass!=null?new Od.workerClass:new self.Worker(Od.workerUrl,Od.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach((i=>{i.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[w_]}numActive(){return Object.keys(this.active).length}}Mc.workerCount=2;class Nu{constructor(e,i,s="Worker",a=Mc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Se();const u=this.workerPool.acquire(this.id,a);for(let h=0;h<u.length;h++){const f=new Nu.Actor(u[h],i,this.id);f.name="".concat(s," ").concat(h),this.actors.push(f)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,i,s){oe(this.actors,((a,u)=>{a.send(e,i,u)}),s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let kd,T_;function Mp(){return kd||(kd=new Mc),kd}Nu.Actor=ox;class T1{constructor(e){this.module=e}createIntArray(e){const i=new Int32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,s/i.BYTES_PER_ELEMENT),s}createFloatArray(e){const i=new Float32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,s/i.BYTES_PER_ELEMENT),s}createStringBuffer(e){const i=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[i+s]=e.charCodeAt(s);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.entranceColorRgb,s=e.facadeGlazingColorRgb,a=e.roofColorRgb,u=e.wallColorRgb,h=e.normalScale;this.module.setStyle(i[0],i[1],i[2],s[0],s[1],s[2],a[0],a[1],a[2],u[0],u[1],u[2],h[0],h[1],h[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,s){this.module.setFauxFacadeOptions(e?1:0,i?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(const f of e){const _=this.createStringBuffer(f.roofType),g=[0],v=[];for(const I of f.coordinates)if(Array.isArray(I)){for(const A of I)v.push(A.x),v.push(A.y);g.push(v.length)}const b=this.createIntArray(g),w=this.createFloatArray(v);this.module.addFeature(f.id,f.sourceId,f.minHeight,f.height,_,f.roofType.length,w,b,g.length-1),this.module.free(_),this.module.free(b),this.module.free(w)}for(const f of i){let _;_=f.entrances?JSON.parse(f.entrances):[];const g=this.createFloatArray(_),v=[];for(const w of f.coordinates)v.push(w.x),v.push(w.y);const b=this.createFloatArray(v);this.module.addFacade(f.sourceId,f.crossPerc,f.distanceToRoad,g,_.length,b,v.length),this.module.free(g),this.module.free(b)}if(!this.module.generateMesh()){const f=this.module.getLastError();return this.readStringBuffer(f)}const s=this.module.getMeshCount(),a=new Array(s);for(let f=0;f<s;f++){const _=this.module.getPositionsPtr(f),g=this.module.getPositionsLength(f),v=new Float32Array(this.module.heapF32.buffer,_,g),b=this.module.getNormalsPtr(f),w=this.module.getNormalsLength(f),I=new Float32Array(this.module.heapF32.buffer,b,w),A=this.module.getColorsPtr(f),R=this.module.getColorsLength(f),L=new Uint8Array(this.module.heapU8.buffer,A,R),k=this.module.getAOPtr(f),U=this.module.getAOLength(f),G=new Float32Array(this.module.heapF32.buffer,k,U),q=this.module.getUVPtr(f),ie=this.module.getUVLength(f),J=new Float32Array(this.module.heapF32.buffer,q,ie),se=this.module.getFauxFacadePtr(f),le=this.module.getFauxFacadeLength(f),he=new Uint8Array(this.module.heapU8.buffer,se,le),Ce=this.module.getIndicesPtr(f),ye=this.module.getIndicesLength(f),Pe=new Int32Array(this.module.heap32.buffer,Ce,ye),ke=this.module.getBuildingPart(f),Ve=this.readStringBuffer(ke);a[f]={positions:v,normals:I,colors:L,ao:G,uv:J,isFauxFacade:he,indices:Pe,buildingPart:Ve}}const u=this.module.getRingCount(),h=[];for(let f=0;f<u;f++){const _=this.module.getRingPtr(f),g=this.module.getRingLength(f),v=new Float32Array(this.module.heapF32.buffer,_,g);h.push(v)}return{meshes:a,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:h}}}let Fd,S_,Jo,Vu,E_,Uu=null,ju=null,ax=null,Cp=null;function lx(){return Sr(self)&&self.worker.dracoUrl?self.worker.dracoUrl:S_||er.DRACO_URL}function cx(){if(Sr(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Vu)return Vu;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Vu=WebAssembly.validate(r)?er.MESHOPT_SIMD_URL:er.MESHOPT_URL,Vu}function S1(){return Cp}const Pp={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},E1={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Bd={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function ux(r,e,i){const s=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}const I_="KHR_draco_mesh_compression";function I1(r,e){const i=r.extensions&&r.extensions[I_];if(!i)return;const s=new Jo.Decoder,a=px(e,i.bufferView),u=new Jo.Mesh;if(!s.DecodeArrayToMesh(a,a.byteLength,u))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[r.indices],f=Pp[h.componentType],_=h.count*f.BYTES_PER_ELEMENT,g=Jo._malloc(_);f===Uint16Array?s.GetTrianglesUInt16Array(u,_,g):s.GetTrianglesUInt32Array(u,_,g),ux(Jo.memory.buffer.slice(g,g+_),h,e),Jo._free(g);for(const v of Object.keys(i.attributes)){const b=s.GetAttributeByUniqueId(u,i.attributes[v]),w=e.json.accessors[r.attributes[v]],I=E1[w.componentType],A=w.count*Bd[w.type]*Pp[w.componentType].BYTES_PER_ELEMENT,R=Jo._malloc(A);s.GetAttributeDataArrayForAllPoints(u,b,Jo[I],A,R),ux(Jo.memory.buffer.slice(R,R+A),w,e),Jo._free(R)}s.destroy(),u.destroy(),delete r.extensions[I_]}const Rp="EXT_meshopt_compression";function A1(r,e){if(!r.extensions||!r.extensions[Rp])return;const i=r.extensions[Rp],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);E_.decodeGltfBuffer(a,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[Rp]}const hx=1179937895,dx=new TextDecoder("utf8");function fx(r,e){return new URL(r,e).href}function M1(r,e,i,s){return fetch(fx(r.uri,s)).then((a=>a.arrayBuffer())).then((a=>{e.buffers[i]=a}))}function px(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function C1(r,e,i,s){if(r.uri){const a=fx(r.uri,s);return fetch(a).then((u=>u.blob())).then((u=>createImageBitmap(u))).then((u=>{e.images[i]=u}))}if(r.bufferView!==void 0){const a=px(e,r.bufferView),u=new Blob([a],{type:r.mimeType});return createImageBitmap(u).then((h=>{e.images[i]=h}))}}function mx(r,e=0,i){const s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===hx){const v=new Uint32Array(r,e);let b=2;const w=(v[b++]>>2)-3,I=v[b++]>>2;if(b++,s.json=JSON.parse(dx.decode(v.subarray(b,b+I))),b+=I,b<w){const A=v[b++];b++;const R=e+(b<<2);s.buffers[0]=r.slice(R,R+A)}}else s.json=JSON.parse(dx.decode(new Uint8Array(r,e)));const{buffers:a,images:u,meshes:h,extensionsUsed:f,bufferViews:_}=s.json;let g=Promise.resolve();if(a){const v=[];for(let b=0;b<a.length;b++){const w=a[b];w.uri?v.push(M1(w,s,b,i)):s.buffers[b]||(s.buffers[b]=null)}g=Promise.all(v)}return g.then((()=>{const v=[],b=f&&f.includes(I_),w=f&&f.includes(Rp);if(b&&v.push((function(){if(!Jo)return Fd!=null?Fd:(Fd=(function(I){let A,R=null;function L(){A=new Uint8Array(R.buffer)}function k(){throw new Error("Unexpected Draco error.")}const U={a:{a:k,d:function(G,q,ie){return A.copyWithin(G,q,q+ie)},c:function(G){const q=A.length,ie=Math.max(G>>>0,Math.ceil(1.2*q)),J=Math.ceil((ie-q)/65536);try{return R.grow(J),L(),!0}catch(se){return!1}},b:k}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(I,U):I.then((G=>G.arrayBuffer())).then((G=>WebAssembly.instantiate(G,U)))).then((G=>{const{Rb:q,Qb:ie,P:J,T:se,X:le,Ja:he,La:Ce,Qa:ye,Va:Pe,Wa:ke,eb:Ve,jb:Qe,f:qe,e:Fe,yb:He,zb:Ae,Ab:Ee,Bb:Ge,Db:Ye,Gb:Ne}=G.instance.exports;R=Fe;const pt=(()=>{let yt=0,ht=0,st=0,$t=0;return at=>{st&&(q($t),q(yt),ht+=st,st=yt=0),yt||(ht+=128,yt=ie(ht));const Ct=at.length+7&-8;let Wt=yt;Ct>=ht&&(st=Ct,Wt=$t=ie(Ct));for(let oi=0;oi<at.length;oi++)A[Wt+oi]=at[oi];return Wt}})();return L(),qe(),{memory:Fe,_free:q,_malloc:ie,Mesh:class{constructor(){this.ptr=J()}destroy(){se(this.ptr)}},Decoder:class{constructor(){this.ptr=he()}destroy(){Qe(this.ptr)}DecodeArrayToMesh(yt,ht,st){const $t=pt(yt),at=Ce(this.ptr,$t,ht,st.ptr);return!!le(at)}GetAttributeByUniqueId(yt,ht){return{ptr:ye(this.ptr,yt.ptr,ht)}}GetTrianglesUInt16Array(yt,ht,st){Pe(this.ptr,yt.ptr,ht,st)}GetTrianglesUInt32Array(yt,ht,st){ke(this.ptr,yt.ptr,ht,st)}GetAttributeDataArrayForAllPoints(yt,ht,st,$t,at){Ve(this.ptr,yt.ptr,ht.ptr,st,$t,at)}},DT_INT8:He(),DT_UINT8:Ae(),DT_INT16:Ee(),DT_UINT16:Ge(),DT_UINT32:Ye(),DT_FLOAT32:Ne()}}))})(fetch(lx())),Fd.then((I=>{Jo=I,Fd=void 0})))})()),w&&v.push((function(){if(E_)return;const I=(function(A){let R;const L=WebAssembly.instantiateStreaming(A,{}).then((G=>{R=G.instance,R.exports.__wasm_call_ctors()})),k={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},U={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:L,supported:!0,decodeGltfBuffer(G,q,ie,J,se,le){(function(he,Ce,ye,Pe,ke,Ve,Qe){const qe=he.exports.sbrk,Fe=Pe+3&-4,He=qe(Fe*ke),Ae=qe(Ve.length),Ee=new Uint8Array(he.exports.memory.buffer);Ee.set(Ve,Ae);const Ge=Ce(He,Pe,ke,Ae,Ve.length);if(Ge===0&&Qe&&Qe(He,Fe,ke),ye.set(Ee.subarray(He,He+Pe*ke)),qe(He-qe(0)),Ge!==0)throw new Error("Malformed buffer data: ".concat(Ge))})(R,R.exports[U[se]],G,q,ie,J,R.exports[k[le]])}}})(fetch(cx()));return I.ready.then((()=>{E_=I}))})()),u)for(let I=0;I<u.length;I++)v.push(C1(u[I],s,I,i));return(v.length?Promise.all(v):Promise.resolve()).then((()=>{if(b&&h)for(const{primitives:I}of h)for(const A of I)I1(A,s);if(w&&h&&_)for(const I of _)A1(I,s);return s}))}))}function _x(r){return fetch(r).then((e=>e.arrayBuffer())).then((e=>mx(e,0,r)))}function A_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function M_(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class C_{constructor(e,i,s,a){this.context=e,this.format=s,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){const s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:u}=this,{gl:h}=u,{x:f,y:_}=i&&i.position?i.position:{x:0,y:0},g=f+s,v=_+a;!this.size||this.size[0]===g&&this.size[1]===v||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),u.pixelStoreUnpackFlipY.set(!1),u.pixelStoreUnpack.set(1),u.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const b=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&g>0&&v>0){const w=this.useMipmap?Math.floor(Math.log2(Math.max(g,v)))+1:1;h.texStorage2D(h.TEXTURE_2D,w,this.format,g,v),this.size=[g,v]}this.size&&(b?h.texSubImage2D(h.TEXTURE_2D,0,f,_,A_(this.format),M_(this.format),e):"data"in e&&e.data&&h.texSubImage2D(h.TEXTURE_2D,0,f,_,s,a,A_(this.format),M_(this.format),e.data)),this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,s=!1){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,a,u){const{context:h}=this,{gl:f}=h;f.bindTexture(f.TEXTURE_2D,this.texture),i!==this.magFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,s),this.wrapS=s),a!==this.wrapT&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,a),this.wrapT=a),u!==this.compareMode&&(u?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_FUNC,u)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.NONE),this.compareMode=u)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Nd{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}const P1=fi([{name:"a_pos_3f",components:3,type:"Float32"}]),R1=fi([{name:"a_color_3f",components:3,type:"Float32"}]),D1=fi([{name:"a_color_4f",components:4,type:"Float32"}]),z1=fi([{name:"a_uv_2f",components:2,type:"Float32"}]),L1=fi([{name:"a_normal_3f",components:3,type:"Float32"}]),O1=fi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),k1=fi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function gx(r,e){const i=Dp(r.projection,r.zoom,r.width,r.height),s=(function(u,h,f,_,g){const v=new M(f.lng-180*zl,f.lat),b=new M(f.lng+180*zl,f.lat),w=u.project(v.lng,v.lat),I=u.project(b.lng,b.lat),A=-Math.atan2(I.y-w.y,I.x-w.x),R=_e.fromLngLat(f);R.y=B(R.y,-1+zl,1-zl);const L=R.toLngLat(),k=u.project(L.lng,L.lat),U=_e.fromLngLat(L);U.x+=zl;const G=U.toLngLat(),q=u.project(G.lng,G.lat),ie=xx(q.x-k.x,q.y-k.y,A),J=_e.fromLngLat(L);J.y+=zl;const se=J.toLngLat(),le=u.project(se.lng,se.lat),he=xx(le.x-k.x,le.y-k.y,A),Ce=Math.abs(ie.x)/Math.abs(he.y),ye=Ot([]);yi(ye,ye,-A*(1-(g?0:_)));const Pe=Ot([]);return hi(Pe,Pe,[1,1-(1-Ce)*_,1]),Pe[4]=-he.x/he.y*_,yi(Pe,Pe,A),Xt(Pe,ye,Pe),Pe})(r.projection,0,r.center,i,e),a=yx(r);return hi(s,s,[a,a,1]),s}function yx(r){const e=r.projection,i=Dp(r.projection,r.zoom,r.width,r.height),s=P_(e,r.center),a=P_(e,M.convert(e.center));return Math.pow(2,s*i+(1-i)*a)}function Dp(r,e,i,s,a=1/0){const u=r.range;if(!u)return 0;const h=Math.min(a,Math.max(i,s)),f=Math.log2(h/1024);return X(u[0]+f,u[1]+f,e)}const zl=1/4e4;function P_(r,e){const i=B(e.lat,-W,W),s=new M(e.lng-180*zl,i),a=new M(e.lng+180*zl,i),u=r.project(s.lng,i),h=r.project(a.lng,i),f=_e.fromLngLat(s),_=_e.fromLngLat(a),g=h.x-u.x,v=h.y-u.y,b=_.x-f.x,w=_.y-f.y,I=Math.sqrt((b*b+w*w)/(g*g+v*v));return Math.log2(I)}function xx(r,e,i){const s=Math.cos(i),a=Math.sin(i);return{x:r*s-e*a,y:r*a+e*s}}function vx(r,e,i){Ot(r),yi(r,r,Qt(e[2])),Wi(r,r,Qt(e[0])),ci(r,r,Qt(e[1])),hi(r,r,i),Xt(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function zp(r,e,i,s,a,u,h,f){const _=[i[0]-e[0],i[1]-e[1],0],g=[s[0]-e[0],s[1]-e[1],0];if(ir(_)<1e-12||ir(g)<1e-12)return ms(r);const v=Fr([],_,g);Yi(v,v),Wr(g,s,e),_[2]=(u-a)*f,g[2]=(h-a)*f;const b=_;return Fr(b,_,g),Yi(b,b),sn(r,v,b)}function Lp(r,e,i=!1){const s=Pl(e.zoom),a=(function(u,h,f){const _=h.worldSize,g=[u[12],u[13],u[14]],v=H(g[1]/_),b=Z(g[0]/_),w=Ot([]),I=j(1,v)*_,A=j(1,0)*_*ee(v,h.zoom),R=1/s_(_);let L=A*R;if(f){const q=Dp(h.projection,h.zoom,h.width,h.height,1024);L=R*h.projection.pixelSpaceConversion(h.center.lat,_,q)}const k=x(v,b);ar(k,k,Xi([],Yi([],k),I*L*g[2]));const U=(function(q){const ie=[q[0],q[1],q[2]];let J=[0,1,0];const se=Fr([],J,ie);return Fr(J,ie,se),lo(J)===0&&(J=[0,1,0],Fr(se,ie,J)),Yi(se,se),Yi(J,J),Yi(ie,ie),[se[0],se[1],se[2],0,J[0],J[1],J[2],0,ie[0],ie[1],ie[2],0,q[0],q[1],q[2],1]})(k);hi(w,w,[L,L,L*I]),gi(w,w,[-g[0],-g[1],-g[2]]);const G=Xt([],h.globeMatrix,U);return Xt(G,G,w),Xt(G,G,u),G})(r,e,i);if(s>0){const u=(function(h,f){const _=f.worldSize,g=j(1,0)*_*ee(f.center.lat,f.zoom)/s_(_),v=j(1,f.center.lat)*_,b=Ot([]);ci(b,b,Qt(f.center.lng)),Wi(b,b,Qt(f.center.lat)),gi(b,b,[0,0,Rs]),hi(b,b,[g,g,g*v]);const w=f.point;return gi(b,b,[-w.x,-w.y,0]),Xt(b,b,h),Xt(b,f.globeMatrix,b)})(r,e);return(function(h,f,_){const g=(A,R,L)=>{const k=ir(A),U=ir(R),G=Ua(A,R,L);return Xi(G,G,1/ir(G)*Vt(k,U,L))},v=g([h[0],h[1],h[2]],[f[0],f[1],f[2]],_),b=g([h[4],h[5],h[6]],[f[4],f[5],f[6]],_),w=g([h[8],h[9],h[10]],[f[8],f[9],f[10]],_),I=Ua([h[12],h[13],h[14]],[f[12],f[13],f[14]],_);return[v[0],v[1],v[2],0,b[0],b[1],b[2],0,w[0],w[1],w[2],0,I[0],I[1],I[2],1]})(a,u,s)}return a}function R_(r,e,i,s){const a=si.projectAabbCorners(s,i);let u=Number.MAX_VALUE;for(let f=0;f<a.length;++f){const _=a[f];_[0]=(.5*_[0]+.5)*e.width,_[1]=(.5-.5*_[1])*e.height,_[2]<u&&(u=_[2])}const h=(function(f){const _=[];let g=0;for(let I=1;I<f.length;I++)(f[I][0]<f[g][0]||f[I][0]===f[g][0]&&f[I][1]<f[g][1])&&(g=I);let v,b=g;const w=new Uint8Array(f.length);do{if(w[b])break;_.push(new Be(f[b][0],f[b][1])),w[b]=1,v=(b+1)%f.length;for(let I=0;I<f.length;I++){if(f[I][0]===f[v][0]&&f[I][1]===f[v][1]||f[I][0]===f[b][0]&&f[I][1]===f[b][1])continue;const A=[f[I][0]-f[b][0],f[I][1]-f[b][1]],R=[f[v][0]-f[b][0],f[v][1]-f[b][1]],L=A[0]*R[1]-A[1]*R[0];(L>0||L===0&&A[0]*R[0]+A[1]*R[1]>=0&&A[0]*A[0]+A[1]*A[1]>R[0]*R[0]+R[1]*R[1])&&(v=I)}b=v}while(b!==g);return _.length>0&&_.push(_[0]),_})(a);if(tn(r,h))return u}const Cc=64,Gu={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Op(r,e,i,s,a,u,h,f,_,g=!1){const v=i.zoom,b=i.project(s),w=ee(s.lat,v),I=1/w;Ot(r),gi(r,r,[b.x+h[0]*I,b.y+h[1]*I,h[2]]);let A=1,R=1;const L=i.worldSize;if(g){if(i.projection.name==="mercator"){let q=0;i.elevation&&(q=i.elevation.getAtPointOrZero(new _e(b.x/L,b.y/L),0));const ie=En([],[b.x,b.y,q,1],i.projMatrix)[3]/i.cameraToCenterDistance;A=ie,R=ie*ee(i.center.lat,v)}else if(i.projection.name==="globe"){const q=Lp(r,i),ie=[0,0,0,1];En(ie,ie,Xt([],i.projMatrix,q));const J=ie[3]/i.cameraToCenterDistance,se=Pl(v),le=i.projection.pixelsPerMeter(s.lat,L)*ee(s.lat,v),he=i.projection.pixelsPerMeter(i.center.lat,L)*ee(i.center.lat,v);A=J/Vt(le,re(i.center.lat),se),R=J*w/le,A*=he,R*=he}}else A=I;hi(r,r,[A,A,R]);const k=[...r],U=e.orientation,G=[];if(vx(G,[U[0]+(a?a[0]:0),U[1]+(a?a[1]:0),U[2]+(a?a[2]:0)],u),Xt(r,k,G),f&&i.elevation){let q=0;const ie=[];if(_&&i.elevation){q=(function(se,le,he,Ce,ye){const Pe=le.elevation;if(!Pe)return 0;const ke=si.projectAabbCorners(he,Ce),Ve=j(1,ye.lat)*le.worldSize,Qe=(function(ht,st){const $t=[0,0,1],at=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Ct of at){const Wt=ht[Ct.corners[0]],oi=ht[Ct.corners[1]],Si=ht[Ct.corners[2]],Yt=[oi[0]-Wt[0],oi[1]-Wt[1],st*(oi[2]-Wt[2])],zi=Fr(Yt,Yt,[Si[0]-Wt[0],Si[1]-Wt[1],st*(Si[2]-Wt[2])]);Yi(zi,zi),Ct.dotProductWithUp=Qi(zi,$t)}return at.sort(((Ct,Wt)=>Ct.dotProductWithUp-Wt.dotProductWithUp)),at[0].corners})(ke,Ve),qe=ke[Qe[0]],Fe=ke[Qe[1]],He=ke[Qe[2]],Ae=ke[Qe[3]],Ee=Pe.getAtPointOrZero(new _e(qe[0]/le.worldSize,qe[1]/le.worldSize),0),Ge=Pe.getAtPointOrZero(new _e(Fe[0]/le.worldSize,Fe[1]/le.worldSize),0),Ye=Pe.getAtPointOrZero(new _e(He[0]/le.worldSize,He[1]/le.worldSize),0),Ne=Pe.getAtPointOrZero(new _e(Ae[0]/le.worldSize,Ae[1]/le.worldSize),0),pt=(Ee+Ne)/2,yt=(Ge+Ye)/2;return pt>yt?Ge<Ye?zp(se,Fe,Ae,qe,Ge,Ne,Ee,Ve):zp(se,He,qe,Ae,Ye,Ee,Ne,Ve):Ee<Ne?zp(se,qe,Fe,He,Ee,Ge,Ye,Ve):zp(se,Ae,He,Fe,Ne,Ye,Ge,Ve),Math.max(pt,yt)})(ie,i,e.aabb,r,s);const J=Xt([],vr([],ie),G);Xt(r,k,J)}else q=i.elevation.getAtPointOrZero(new _e(b.x/L,b.y/L),0);q!==0&&(r[14]+=q)}}class bx{constructor(e,i,s,a,u){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=i,this.position=s!=null?new M(s[0],s[1]):new M(0,0),this.orientation=a!=null?a:[0,0,0],this.nodes=u,this.uploaded=!1,this.aabb=new si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,i){Xt(e.globalMatrix,i,e.localMatrix);const s=this.nodeOverrides.get(e.name);if(s!==void 0){const h=[];u=s.orientation,Ot(a=h),ci(a,a,Qt(u[1])),yi(a,a,Qt(u[2])),Wi(a,a,Qt(u[0])),Xt(e.globalMatrix,e.globalMatrix,h)}var a,u;if(e.meshes)for(const h of e.meshes){const f=si.applyTransformFast(h.aabb,e.globalMatrix);this.aabb.encapsulate(f)}if(e.children)for(const h of e.children)this._applyTransformations(h,e.globalMatrix)}computeBoundsAndApplyParent(){const e=Ot([]);this.aabb=new si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const i of this.nodes)this._applyTransformations(i,e)}computeModelMatrix(e,i,s,a,u,h,f=!1){Op(this.matrix,this,e.transform,this.position,i,s,a,u,h,f)}upload(e){if(!this.uploaded){for(const i of this.nodes)D_(i,e);for(const i of this.nodes)kp(i);this.uploaded=!0}}destroy(){for(const e of this.nodes)z_(e)}}function Vd(r,e,i=!1){r.uploaded||(r.gfxTexture=new C_(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function F1(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,P1.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,L1.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,z1.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?R1:D1).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,k1.members,!0)),r.segments=Vr.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const s=r.material;s.pbrMetallicRoughness.baseColorTexture&&Vd(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Vd(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Vd(s.normalTexture,e),s.occlusionTexture&&Vd(s.occlusionTexture,e,i),s.emissionTexture&&Vd(s.emissionTexture,e)}function D_(r,e,i){if(r.meshes)for(const s of r.meshes)F1(s,e,i);if(r.children)for(const s of r.children)D_(s,e,i)}function kp(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)kp(e)}function z_(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)z_(i)}function Pc(r,e){const i=r.json.bufferViews[e.bufferView],s=Pp[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Bd[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:Bd[e.type]))}function L_(r,e,i,s){const a=Pp[e.componentType],u=(function(v){switch(v){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}})(a),h=r.json.bufferViews[e.bufferView],f=h.byteStride?h.byteStride/a.BYTES_PER_ELEMENT:Bd[e.type],_=i.float32,g=_.length/i.capacity;for(let v=0,b=0;v<e.count*f;v+=f,b+=g)for(let w=0;w<g;w++)_[b+w]=s[v+w]*u;i._trim()}function B1(r,e,i){const s=r.indices,a=r.attributes,u={};u.indexArray=new zr;const h=e.json.accessors[s],f=h.count/3;u.indexArray.reserve(f);const _=Pc(e,h);for(let w=0;w<f;w++)u.indexArray.emplaceBack(_[3*w],_[3*w+1],_[3*w+2]);u.indexArray._trim(),u.vertexArray=new Ys;const g=e.json.accessors[a.POSITION];u.vertexArray.reserve(g.count);const v=Pc(e,g);for(let w=0;w<g.count;w++)u.vertexArray.emplaceBack(v[3*w],v[3*w+1],v[3*w+2]);if(u.vertexArray._trim(),u.aabb=new si(g.min,g.max),u.centroid=(function(w,I){const A=[0,0,0],R=w.length;if(R>0){for(let L=0;L<R;L++){const k=3*w[L];A[0]+=I[k],A[1]+=I[k+1],A[2]+=I[k+2]}A[0]/=R,A[1]/=R,A[2]/=R}return A})(_,v),a.COLOR_0!==void 0){const w=e.json.accessors[a.COLOR_0],I=Bd[w.type],A=Pc(e,w);u.colorArray=I===3?new Ys:new pa,u.colorArray.resize(w.count),L_(e,w,u.colorArray,A)}if(a.NORMAL!==void 0){u.normalArray=new Ys;const w=e.json.accessors[a.NORMAL];u.normalArray.resize(w.count);const I=Pc(e,w);L_(e,w,u.normalArray,I)}if(a.TEXCOORD_0!==void 0&&i.length>0){u.texcoordArray=new ma;const w=e.json.accessors[a.TEXCOORD_0];u.texcoordArray.resize(w.count);const I=Pc(e,w);L_(e,w,u.texcoordArray,I)}if(a._FEATURE_ID_RGBA4444!==void 0){const w=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(u.featureData=Pc(e,w))}a._FEATURE_RGBA4444!==void 0&&(u.featureData=new Uint32Array(Pc(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const b=r.material;return u.material=(function(w,I){const{emissiveFactor:A=[0,0,0],alphaMode:R="OPAQUE",alphaCutoff:L=.5,normalTexture:k,occlusionTexture:U,emissiveTexture:G,doubleSided:q,name:ie}=w,{baseColorFactor:J=[1,1,1,1],metallicFactor:se=1,roughnessFactor:le=1,baseColorTexture:he,metallicRoughnessTexture:Ce}=w.pbrMetallicRoughness||{},ye=U?I[U.index]:void 0;if(U&&U.extensions&&U.extensions.KHR_texture_transform&&ye){const Pe=U.extensions.KHR_texture_transform;ye.offsetScale=[Pe.offset[0],Pe.offset[1],Pe.scale[0],Pe.scale[1]]}return{name:ie,pbrMetallicRoughness:{baseColorFactor:new Gi(...J),metallicFactor:se,roughnessFactor:le,baseColorTexture:he?I[he.index]:void 0,metallicRoughnessTexture:Ce?I[Ce.index]:void 0},doubleSided:q,emissiveFactor:new Gi(...A),alphaMode:R,alphaCutoff:L,normalTexture:k?I[k.index]:void 0,occlusionTexture:ye,emissionTexture:G?I[G.index]:void 0,defined:w.defined===void 0}})(b!==void 0?e.json.materials[b]:{defined:!1},i),u}function wx(r,e,i){const{matrix:s,rotation:a,translation:u,scale:h,mesh:f,extras:_,children:g,name:v}=r,b={};if(b.name=v,b.localMatrix=s||(function(w,I,A,R){var L=I[0],k=I[1],U=I[2],G=I[3],q=L+L,ie=k+k,J=U+U,se=L*q,le=L*ie,he=L*J,Ce=k*ie,ye=k*J,Pe=U*J,ke=G*q,Ve=G*ie,Qe=G*J,qe=R[0],Fe=R[1],He=R[2];return w[0]=(1-(Ce+Pe))*qe,w[1]=(le+Qe)*qe,w[2]=(he-Ve)*qe,w[3]=0,w[4]=(le-Qe)*Fe,w[5]=(1-(se+Pe))*Fe,w[6]=(ye+ke)*Fe,w[7]=0,w[8]=(he+Ve)*He,w[9]=(ye-ke)*He,w[10]=(1-(se+Ce))*He,w[11]=0,w[12]=A[0],w[13]=A[1],w[14]=A[2],w[15]=1,w})([],a||[0,0,0,1],u||[0,0,0],h||[1,1,1]),b.globalMatrix=_t(b.localMatrix),f!==void 0){b.meshes=i[f];const w=b.anchor=[0,0];for(const I of b.meshes){const{min:A,max:R}=I.aabb;w[0]+=A[0]+R[0],w[1]+=A[1]+R[1]}w[0]=Math.floor(w[0]/b.meshes.length/2),w[1]=Math.floor(w[1]/b.meshes.length/2)}if(_&&(_.id&&(b.id=_.id),_.lights&&(b.lights=(function(w){if(!w.length)return[];const I=(function(U){const G=atob(U),q=new Uint8Array(G.length);for(let ie=0;ie<G.length;ie++)q[ie]=G.codePointAt(ie);return q})(w),A=[],R=I.length/24,L=new Uint16Array(I.buffer),k=new Float32Array(I.buffer);for(let U=0;U<R;U++){const G=L[2*U*6]/30,q=L[2*U*6+1]/30,ie=L[2*U*6+10]/100,J=k[6*U+1],se=k[6*U+2],le=k[6*U+3],he=k[6*U+4],Ce=le-J,ye=he-se,Pe=Math.hypot(Ce,ye);A.push({pos:[J+.5*Ce,se+.5*ye,q],normal:[ye/Pe,-Ce/Pe,0],width:Pe,height:G,depth:ie,points:[J,se,le,he]})}return A})(_.lights)),_.MAPBOX_geometry_bloom&&(b.isGeometryBloom=_.MAPBOX_geometry_bloom)),g){const w=[];for(const I of g)w.push(wx(e.json.nodes[I],e,i));b.children=w}return b}function N1(r){if(r.vertices.length===0||r.indices.length===0)return null;const e=new wp(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function V1(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const s=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const f=h[0],_=h[1];typeof f=="number"&&typeof _=="number"&&s.push(new Be(f,_))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let a=0;for(let h=0;h<s.length;h++){const f=s[h],_=s[(h+1)%s.length],g=s[(h+2)%s.length];a+=(f.x-_.x)*(g.y-_.y)-(g.x-_.x)*(f.y-_.y)}a>0&&s.reverse();const u=Fu(s.flatMap((h=>[h.x,h.y])),[]);return u.length===0?null:{vertices:s,indices:u}}function U1(r,e){const i=[],s=[];let a=0;const u=[];for(const h of r){a=i.length;const f=h.vertexArray.float32,_=h.indexArray.uint16;for(let g=0;g<h.vertexArray.length;g++)u[0]=f[3*g+0],u[1]=f[3*g+1],u[2]=f[3*g+2],dr(u,u,e),i.push(new Be(u[0],u[1]));for(let g=0;g<3*h.indexArray.length;g++)s.push(_[g]+a)}if(s.length%3!=0)return null;for(let h=0;h<s.length;h+=3){const f=i[s[h+0]],_=i[s[h+1]],g=i[s[h+2]];(f.x-_.x)*(g.y-_.y)-(g.x-_.x)*(f.y-_.y)>0&&([s[h+1],s[h+2]]=[s[h+2],s[h+1]])}return{vertices:i,indices:s}}function O_(r){const e=(function(_,g){const v=[],b=WebGL2RenderingContext;if(_.json.textures)for(const w of _.json.textures){const I={magFilter:b.LINEAR,minFilter:b.NEAREST,wrapS:b.REPEAT,wrapT:b.REPEAT};w.sampler!==void 0&&Object.assign(I,_.json.samplers[w.sampler]),v.push({image:g[w.source],sampler:I,uploaded:!1})}return v})(r,r.images),i=(function(_,g){const v=[];for(const b of _.json.meshes){const w=[];for(const I of b.primitives)w.push(B1(I,_,g));v.push(w)}return v})(r,e),{scenes:s,scene:a,nodes:u}=r.json,h=s?s[a||0].nodes:[...u.keys()],f=[];for(const _ of h)f.push(wx(u[_],r,i));return(function(_,g,v){const b={},w=new Set;for(let I=0;I<_.length;I++){const A=v[g[I]];if(!A.extras)continue;const R=A.extras["mapbox:footprint:version"],L=A.extras["mapbox:footprint:id"];(R||L)&&w.add(I),R==="1.0.0"&&L&&(b[L]=I)}for(let I=0;I<_.length;I++){if(w.has(I))continue;const A=_[I],R=v[g[I]];if(!R.extras)continue;let L=null;A.id in b&&(L=U1(_[b[A.id]].meshes,A.localMatrix)),L||(L=V1(R)),L&&(A.footprint=N1(L))}if(w.size>0){const I=Array.from(w.values()).sort(((A,R)=>A-R));for(let A=I.length-1;A>=0;A--)_.splice(I[A],1)}})(f,h,r.json.nodes),f}function j1(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,a=Cc/(r.aabb.max[0]-i+2),u=Cc/(r.aabb.max[1]-s+2);for(let h=0;h<e.length;h+=3){const f=e[h+2],_=(e[h+0]-i)*a|0,g=(e[h+1]-s)*u|0;f>r.heightmap[g*Cc+_]&&(r.heightmap[g*Cc+_]=f)}}function Tx(r,e,i,s,a){i.reserve(i.length+4*r.length),s.reserve(s.length+10*r.length),a.reserve(a.length+10*r.length);let u=s.length;for(const h of r){const f=Math.min(10,Math.max(4,1.3*h.height))*e,_=[-h.normal[1],h.normal[0],0],g=Math.min(.29,.1*h.width/h.depth),v=h.width-2*h.depth*e*(g+.01),b=ns([],h.pos,_,v/2),w=ns([],h.pos,_,-v/2),I=[b[0],b[1],b[2]+h.height],A=[w[0],w[1],w[2]+h.height],R=ns([],h.normal,_,g);Xi(R,R,f);const L=ns([],h.normal,_,-g);Xi(L,L,f),ar(R,b,R),ar(L,w,L),b[2]+=.1,w[2]+=.1,s.emplaceBack(R[0],R[1],R[2]),s.emplaceBack(L[0],L[1],L[2]),s.emplaceBack(b[0],b[1],b[2]),s.emplaceBack(w[0],w[1],w[2]),s.emplaceBack(I[0],I[1],I[2]),s.emplaceBack(A[0],A[1],A[2]),s.emplaceBack(b[0],b[1],b[2]),s.emplaceBack(w[0],w[1],w[2]),s.emplaceBack(R[0],R[1],R[2]),s.emplaceBack(L[0],L[1],L[2]);const k=v/f/2;a.emplaceBack(-k-g,-1,k,.8),a.emplaceBack(k+g,-1,k,.8),a.emplaceBack(-k,0,k,1.3),a.emplaceBack(k,0,k,1.3),a.emplaceBack(k+g,-.8,k,.7),a.emplaceBack(k+g,-.8,k,.7),a.emplaceBack(0,0,k,1.3),a.emplaceBack(0,0,k,1.3),a.emplaceBack(k+g,-1.2,k,.8),a.emplaceBack(k+g,-1.2,k,.8),i.emplaceBack(6+u,4+u,8+u),i.emplaceBack(7+u,9+u,5+u),i.emplaceBack(0+u,1+u,2+u),i.emplaceBack(1+u,3+u,2+u),u+=10}}function G1(r,e){const i={};i.indexArray=new zr,i.vertexArray=new Ys,i.colorArray=new pa,Tx(r,e,i.indexArray,i.vertexArray,i.colorArray);const s={defined:!0};s.emissiveFactor=Gi.black;const a={};return a.baseColorFactor=Gi.white,s.pbrMetallicRoughness=a,i.material=s,i.aabb=new si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const Sx=fi([{name:"a_pos_3f",components:3,type:"Float32"}]),H1=fi([{name:"a_normal_3",components:3,type:"Int16"}]),q1=fi([{name:"a_centroid_3",components:3,type:"Int16"}]),Ex=fi([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),$1=fi([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),Z1=fi([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),W1=fi([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),X1=fi([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),Y1=fi([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),Ix=je.types,Fp=32767;function K1(r,e){const i=it+e;for(const s of r)for(const a of s)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}class Ax{constructor(){this.layoutVertexArray=new Ys,this.layoutAttenuationArray=new pa,this.layoutColorArray=new xo,this.indexArray=new zr,this.indexArrayForConflation=new zr,this.segmentsBucket=new Vr}}class k_{constructor(){this.layoutVertexArray=new Ys,this.layoutNormalArray=new Fa,this.layoutCentroidArray=new Fa,this.layoutColorArray=new xo,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new Au,this.layoutAOArray=new Wo,this.indexArray=new zr,this.indexArrayForConflation=new zr,this.segmentsBucket=new Vr,this.entranceBloom=new Ax}}class Mx{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new k_,this.buildingWithFacade=new k_,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.buildingWithFacade.layoutFacadePaintArray=new xo,this.buildingWithFacade.layoutFacadeDataArray=new Ba,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new xo,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.groundEffect=new v_(e),this.groundEffect.groundRadiusArray=new Wo,this.hasAppearances=null}updateFootprints(e,i){for(const s of this.footprints)i.push({footprint:s,id:e})}updateAppearances(e,i,s,a){}prepare(){return(function(){if(Cp!=null||ax!=null)return null;if(ju!=null)return ju;const e=fetch(er.BUILDING_GEN_URL);return ju=(function(i){let s,a,u,h;function f(){s=new Uint8Array(h.buffer),a=new Int32Array(h.buffer),u=new Float32Array(h.buffer)}function _(){throw new Error("Unexpected BuildingGen error.")}const g=()=>{},v={a:{a:_,f:function(b){const w=s.length,I=Math.max(b>>>0,Math.ceil(1.2*w)),A=Math.ceil((I-w)/65536);try{return h.grow(A),f(),!0}catch(R){return!1}},g:_,b:g,c:g,d:g,e:g}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,v):i.then((b=>b.arrayBuffer())).then((b=>WebAssembly.instantiate(b,v)))).then((b=>{const w=b.instance.exports;return(0,w.g)(),h=w.f,f(),new T1({setStyle:w.h,setAOOptions:w.i,setMetricOptions:w.j,setStructuralOptions:w.k,setFacadeOptions:w.l,setFauxFacadeOptions:w.m,setFacadeClassifierOptions:w.n,addFeature:w.o,addFacade:w.p,generateMesh:w.q,getLastError:w.r,getOuterRingLength:w.s,getMeshCount:w.t,getPositionsPtr:w.u,getPositionsLength:w.v,getNormalsPtr:w.w,getNormalsLength:w.x,getColorsPtr:w.y,getColorsLength:w.z,getAOPtr:w.A,getAOLength:w.B,getUVPtr:w.C,getUVLength:w.D,getFauxFacadePtr:w.E,getFauxFacadeLength:w.F,getIndicesPtr:w.G,getIndicesLength:w.H,getBuildingPart:w.I,getRingCount:w.J,getRingPtr:w.K,getRingLength:w.L,free:w.M,malloc:w.N,heapU8:s,heap32:a,heapF32:u})}))})(e).then((i=>(ju=null,Cp=i,Cp))).catch((i=>{Mt("Could not load building-gen"),ju=null,ax=i})),ju})()}populate(e,i,s,a){const u=S1();if(!u)return;const h=ne(s);this.tileToMeter=h,this.brightness=i.brightness,u.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,h],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:h,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),u.setAOOptions(!1,.3),u.setMetricOptions(!1,16),u.setStructuralOptions(!0),u.setFacadeClassifierOptions(3);const f=new Map,_=new Map;for(const{feature:g}of e){if(Ix[g.type]!=="LineString"){f.set(g.id,g.properties.source_id);continue}const v=this.layers[0]._featureFilter.needGeometry,b=Te(g,v);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),b,s))continue;const w=v?b.geometry:Le(g,s,a),I=[];for(const k of w)for(const U of k)I.push({x:U.x,y:U.y});const A={coordinates:I,crossPerc:g.properties.cross_perc,distanceToRoad:g.properties.distance_to_road,entrances:g.properties.entrances,sourceId:0},R=g.properties.source_id;let L=_.get(R);L||(L=[],_.set(R,L)),L.push(A)}this.maxHeight=0;for(const{feature:g,id:v,index:b,sourceLayerIndex:w}of e){if(Ix[g.type]==="LineString")continue;const I=this.layers[0]._featureFilter.needGeometry,A=Te(g,I);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),A,s))continue;const R=I?A.geometry:Le(g,s,a),L=Cd(R,500);if(!K1(R,163))continue;const k=this.layers[0],U=k.layout.get("building-roof-shape").evaluate(g,{},s);if(U==="flat")continue;const G=k.layout.get("building-base").evaluate(g,{},s),q=k.layout.get("building-height").evaluate(g,{},s),ie=k.layout.get("building-flood-light-ground-radius").evaluate(g,{},s),J=k.paint.get("building-ambient-occlusion-intensity"),se=ie/this.tileToMeter;let le=k.layout.get("building-flood-light-wall-radius").evaluate(g,{},s);le=B(le,0,2048);const he=le/2048*Fp,Ce=f.get(v);let ye;ye=_.has(Ce)?_.get(Ce):[];const Pe=ye.length!==0&&k.layout.get("building-facade").evaluate(g,{},s);u.setFacadeOptions(4,!0),u.setFauxFacadeOptions(Pe,!1,1);let ke=0,Ve=0,Qe=0,qe=0,Fe=0,He=0;if(Pe){let De=Math.round(k.layout.get("building-facade-floors").evaluate(g,{},s));if(G===0){De=Math.max(1,De-(ye.length>0?1:0));let Et=4;if(q>100){const St=[10,13,15];Et=St[g.id?g.id%St.length:0],u.setFacadeOptions(Et,!0)}Fe=1.6803*Et/h}else Fe=G/h;He=q/h,Fe=Math.min(Fe,He),Qe=k.layout.get("building-facade-unit-width").evaluate(g,{},s)/h,qe=(He-Fe)/De,u.setFauxFacadeOptions(!0,!0,Qe);const ot=k.layout.get("building-facade-window").evaluate(g,{},s);ke=ot[0],Ve=ot[1]}const Ae=[],Ee=new Be(1/0,1/0),Ge=new Be(-1/0,-1/0),Ye=new Be(0,0);let Ne=0;for(const De of L)if(De.length>0){const ot=[];for(const Et of De){const St=[];for(let Kt=Et.length-1;Kt>=0;Kt--){const kt=Et[Kt];St.push({x:kt.x,y:kt.y}),Ee.x=Math.min(Ee.x,kt.x),Ee.y=Math.min(Ee.y,kt.y),Ge.x=Math.max(Ge.x,kt.x),Ge.y=Math.max(Ge.y,kt.y),Ye.x+=kt.x,Ye.y+=kt.y,Ne++}ot.push(St)}Ae.push({id:g.id?g.id:0,height:q,minHeight:G,sourceId:0,roofType:U,coordinates:ot})}Ye.x/=Ne||1,Ye.y/=Ne||1;const pt=u.generateMesh(Ae,ye);if(typeof pt=="string"){Mt("Unable to generate building ".concat(g.id,": ").concat(pt));continue}if(pt.meshes.length===0||pt.modifiedPolygonRings.length===0)continue;let yt=0;for(const De of pt.meshes)yt+=De.positions.length/3;const ht=Pe?this.buildingWithFacade:this.buildingWithoutFacade,st=ht.segmentsBucket.prepareSegment(yt,ht.layoutVertexArray,ht.indexArray),$t=[];let at=null,Ct=0,Wt=-1;const oi=ht.layoutVertexArray.length,Si=ht.indexArray.length;let Yt=0;for(const De of pt.meshes){const ot=ht.layoutVertexArray.length;if(De.buildingPart==="entrance"){const bt=new Array;for(let wi=0;wi<De.positions.length;wi+=12){const nr=De.positions[wi+0],Hi=De.positions[wi+1],qr=De.positions[wi+3],Ar=De.positions[wi+4],_r=De.positions[wi+2],Ji=De.positions[wi+8]-_r,Oi=1,Jt=qr-nr,ki=Ar-Hi,gr=Math.hypot(Jt,ki);bt.push({pos:[nr+.5*Jt,Hi+.5*ki,_r],normal:[ki/gr,-Jt/gr,0],width:gr,height:Ji,depth:Oi,points:[nr,Hi,qr,Ar]})}const Ri=ht.entranceBloom.segmentsBucket.prepareSegment(10*bt.length,ht.entranceBloom.layoutVertexArray,ht.entranceBloom.indexArray),rr=ht.entranceBloom.layoutVertexArray.length;Ct=ht.entranceBloom.indexArray.length,Tx(bt,.5/this.tileToMeter,ht.entranceBloom.indexArray,ht.entranceBloom.layoutVertexArray,ht.entranceBloom.layoutAttenuationArray);const Nt=ht.entranceBloom.layoutVertexArray.length-rr;Wt=ht.entranceBloom.indexArray.length-Ct;for(let wi=0;wi<Nt;wi++)ht.entranceBloom.layoutColorArray.emplaceBack(65535,65535);Ri.vertexLength+=Nt,Ri.primitiveLength+=Wt,at={part:De.buildingPart,vertexOffset:rr,vertexLength:Nt}}for(let bt=0;bt<De.positions.length;bt+=3)Yt=Math.max(Yt,De.positions[bt+2]),ht.layoutVertexArray.emplaceBack(De.positions[bt],De.positions[bt+1],De.positions[bt+2]);const Et=Math.floor(Ye.x),St=Math.floor(Ye.y),Kt=Math.floor(Yt);for(let bt=0;bt<De.positions.length;bt+=3)ht.layoutCentroidArray.emplaceBack(Et,St,Kt),ht.layoutFloodLightDataArray.emplaceBack(De.buildingPart==="wall"?he:0);for(let bt=0;bt<De.normals.length;bt+=3)ht.layoutNormalArray.emplaceBack(De.normals[bt+0]*Fp,De.normals[bt+1]*Fp,De.normals[bt+2]*Fp);for(let bt=0;bt<De.ao.length;bt++)ht.layoutAOArray.emplaceBack(De.ao[bt]);for(let bt=0;bt<De.colors.length;bt+=3){const Ri=1+(De.ao[bt/3]-1)*J;ht.layoutColorArray.emplaceBack(De.colors[bt]*Ri<<8|De.colors[bt+1]*Ri,De.colors[bt+2]*Ri<<8)}if(Pe){for(let bt=0;bt<De.positions.length;bt+=3)ht.layoutFacadePaintArray.emplaceBack(65535,255);for(let bt=0;bt<De.isFauxFacade.length;bt++)if(De.isFauxFacade[bt]){const Ri=1|Math.min(65535,Math.floor(De.uv[2*bt]*pt.outerRingLength)),rr=Math.floor(255*ke)<<8|Math.floor(255*Ve),Nt=Math.floor(65535*Math.min(1,Qe/it)),wi=Math.floor(65535*Math.min(1,qe/it));ht.layoutFacadeDataArray.emplaceBack(Ri,rr,Nt,wi);const nr=Math.floor(65535*Math.min(1,Fe/it)),Hi=Math.floor(65535*Math.min(1,He/it));ht.layoutFacadeVerticalRangeArray.emplaceBack(nr,Hi)}else ht.layoutFacadeDataArray.emplaceBack(0,0,0,0),ht.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const kt=st.vertexLength;for(let bt=0;bt<De.indices.length;bt+=3)ht.indexArray.emplaceBack(kt+De.indices[bt],kt+De.indices[bt+1],kt+De.indices[bt+2]);st.vertexLength+=De.positions.length/3,st.primitiveLength+=De.indices.length/3,(De.buildingPart==="roof"||De.buildingPart==="wall"||De.buildingPart==="facade_glazing"||De.buildingPart==="entrance")&&$t.push({part:De.buildingPart,vertexOffset:ot,vertexLength:De.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Yt),this.buildingFeatures.push({promoteId:v,feature:A,hasFauxFacade:Pe,segment:st,parts:$t,buildingBloom:at});const zi=ht.indexArray.length-Si,Li=[],kr=[],Q=new Be(1/0,1/0),Y=new Be(-1/0,-1/0),Re=this.groundEffect.vertexArray.length;for(const De of pt.modifiedPolygonRings){const ot=[],Et=new Be(1/0,1/0),St=new Be(-1/0,-1/0);for(let Kt=0;Kt<De.length;Kt+=2){const kt=De.length-Kt-2;Et.x=Math.min(Et.x,De[kt]),Et.y=Math.min(Et.y,De[kt+1]),St.x=Math.max(St.x,De[kt]),St.y=Math.max(St.y,De[kt+1]);const bt=new Be(De[kt],De[kt+1]);ot.push(bt),Li.push(bt.x,bt.y),kr.push(bt.clone())}Q.x=Math.min(Q.x,Et.x),Q.y=Math.min(Q.y,Et.y),Y.x=Math.max(Y.x,St.x),Y.y=Math.max(Y.y,St.y),this.groundEffect.addData(ot,[Et,St],se)}const nt=this.groundEffect.vertexArray.length-Re;for(let De=0;De<nt;De++)this.groundEffect.groundRadiusArray.emplaceBack(ie);(Ee.x<0||Ge.x>it||Ee.y<0||Ge.y>it)&&this.featuresOnBorder.push({featureId:g.id,footprintIndex:this.footprints.length});{const De=Fu(Li,null,2),ot=new wp(kr,De,8,256);let Et=g.id;g.properties&&g.properties.hasOwnProperty("building_id")&&(Et=g.properties.building_id);const St={vertices:kr,indices:De,grid:ot,min:Q,max:Y,buildingId:Et,hiddenFlags:0,indicesOffset:Si,indicesLength:zi,bloomIndicesOffset:Ct,bloomIndicesLength:Wt,groundEffectVertexOffset:Re,groundEffectVertexLength:nt,hasFauxFacade:Pe,segment:st,height:Yt};g.id!==void 0&&this.featureFootprintLookup.set(g.id,this.footprints.length),this.footprints.push(St)}this.programConfigurations.populatePaintArrays(ht.layoutVertexArray.length,g,b,{},i.availableImages,s,i.brightness),this.groundEffect.addPaintPropertiesData(g,b,{},i.availableImages,s,i.brightness),i.featureIndex.insert(g,R,b,w,this.index,oi)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(e,i,s,a,u,h,f){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f),this.groundEffect.update(e,i,u,s,a,h,f),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const i=s=>{s.layoutVertexBuffer=e.createVertexBuffer(s.layoutVertexArray,Sx.members),s.layoutNormalBuffer=e.createVertexBuffer(s.layoutNormalArray,H1.members),s.layoutCentroidBuffer=e.createVertexBuffer(s.layoutCentroidArray,q1.members),s.layoutFloodLightDataBuffer=e.createVertexBuffer(s.layoutFloodLightDataArray,Y1.members),s.layoutFacadeDataArray&&s.layoutFacadeDataArray.length&&(s.layoutFacadeDataBuffer=e.createVertexBuffer(s.layoutFacadeDataArray,Z1.members)),s.layoutFacadeVerticalRangeArray&&s.layoutFacadeVerticalRangeArray.length&&(s.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(s.layoutFacadeVerticalRangeArray,W1.members)),s.entranceBloom.layoutVertexArray.length&&(s.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(s.entranceBloom.layoutVertexArray,Sx.members),s.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(s.entranceBloom.layoutAttenuationArray,X1.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=i=>{i.layoutVertexBuffer&&(i.layoutVertexBuffer.destroy(),i.layoutNormalBuffer.destroy(),i.layoutColorBuffer.destroy(),i.segmentsBucket.destroy(),i.indexBuffer&&i.indexBuffer.destroy(),i.entranceBloom.layoutVertexBuffer&&(i.entranceBloom.layoutVertexBuffer.destroy(),i.entranceBloom.layoutColorBuffer.destroy(),i.entranceBloom.layoutAttenuationBuffer.destroy(),i.entranceBloom.indexBuffer.destroy(),i.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,i,s=!0){let a=!1;const u=s?i:0,h=0|(s?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const f of e){const _=this.footprints[f],g=_.hiddenFlags&h|u;_.hiddenFlags!==g&&(_.hiddenFlags=g,a=!0,this.groundEffect.updateHiddenByLandmarkRange(_.groundEffectVertexOffset,_.groundEffectVertexLength,_.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const i=a=>{a.indexArray.length!==0&&(a.indexArrayForConflation.resize(a.indexArray.length),a.indexArrayForConflation.uint16.set(a.indexArray.uint16),a.entranceBloom.indexArrayForConflation.resize(a.entranceBloom.indexArray.length),a.entranceBloom.indexArrayForConflation.uint16.set(a.entranceBloom.indexArray.uint16))};i(this.buildingWithoutFacade),i(this.buildingWithFacade);for(const a of this.footprints){const u=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,h=a.indicesOffset+a.indicesLength;if(a.hiddenFlags!==0){for(let _=a.indicesOffset;_<h;_++)u.indexArrayForConflation.uint16[3*_+0]=0,u.indexArrayForConflation.uint16[3*_+1]=0,u.indexArrayForConflation.uint16[3*_+2]=0;const f=a.bloomIndicesOffset+a.bloomIndicesLength;for(let _=a.bloomIndicesOffset;_<f;_++)u.entranceBloom.indexArrayForConflation.uint16[3*_+0]=0,u.entranceBloom.indexArrayForConflation.uint16[3*_+1]=0,u.entranceBloom.indexArrayForConflation.uint16[3*_+2]=0}}const s=a=>{a.indexArray.length!==0&&(a.indexBuffer?a.indexBuffer.updateData(a.indexArrayForConflation):a.indexBuffer=e.createIndexBuffer(a.indexArrayForConflation,!0),a.entranceBloom.indexBuffer?a.entranceBloom.indexBuffer.updateData(a.entranceBloom.indexArrayForConflation):a.entranceBloom.indexBuffer=e.createIndexBuffer(a.entranceBloom.indexArrayForConflation,!0))};s(this.buildingWithoutFacade),s(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const i=s=>{s.layoutColorBuffer?s.layoutColorBuffer.updateData(s.layoutColorArray):s.layoutColorBuffer=e.createVertexBuffer(s.layoutColorArray,Ex.members,!0),s.layoutFacadePaintArray&&(s.layoutFacadePaintBuffer?s.layoutFacadePaintBuffer.updateData(s.layoutFacadePaintArray):s.layoutFacadePaintBuffer=e.createVertexBuffer(s.layoutFacadePaintArray,$1.members,!0)),s.entranceBloom.layoutColorBuffer?s.entranceBloom.layoutColorBuffer.updateData(s.entranceBloom.layoutColorArray):s.entranceBloom.layoutColorBuffer=e.createVertexBuffer(s.entranceBloom.layoutColorArray,Ex.members,!0)};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,i){const s=e.paint.get("building-ambient-occlusion-intensity");for(const a of this.buildingFeatures){const u=i[a.promoteId],h=a.feature;h.properties["building-part"]="roof";const f=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),_=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="wall";const g=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),v=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="window";const b=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),w=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical);h.properties["building-part"]="door";const I=e.paint.get("building-color").evaluate(h,u,this.canonical).toPremultipliedRenderColor(this.lut),A=e.paint.get("building-emissive-strength").evaluate(h,u,this.canonical),R=a.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const k of a.parts){let U,G=f;k.part==="roof"?(G=f,U=_):k.part==="wall"?(G=g,U=v):k.part==="facade_glazing"?(G=b,U=w):k.part==="entrance"&&(G=I,U=A),U=B(U,0,1);for(let q=0;q<k.vertexLength;q++){const ie=k.vertexOffset+q,J=1+(R.layoutAOArray.float32[ie]-1)*s;R.layoutColorArray.emplace(ie,G.r*J*255<<8|G.g*J*255,G.b*J*255<<8|255*U),a.hasFauxFacade&&R.layoutFacadePaintArray.emplace(ie,255*b.r<<8|255*b.g,255*b.b<<8|255*w)}}const L=a.buildingBloom;if(L)for(let k=0;k<L.vertexLength;k++)R.entranceBloom.layoutColorArray.emplace(L.vertexOffset+k,255*I.r<<8|255*I.g,255*I.b<<8|51*A)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Sp(this.activeReplacements,a))return;this.activeReplacements=a;for(const h of this.footprints)h.hiddenFlags&=-2;const u=[];for(const h of this.activeReplacements){if(h.order<=Cy)continue;const f=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const _ of this.footprints)_.min.x>h.max.x||_.max.x<h.min.x||_.min.y>h.max.y||_.max.y<h.min.y||(u.length=0,J1(_.vertices,0,_.vertices.length,h.footprintTileId.canonical,e.canonical,u),__(h.footprint,u,_.indices,0,_.indices.length,0,-f)&&(_.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const h of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(h.groundEffectVertexOffset,h.groundEffectVertexLength,h.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(e.id!==void 0){const i=this.featureFootprintLookup.get(e.id);return this.footprints[i]}return null}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0;const u=4*(e+it)*it+(i+it);if(this.footprintLookup.hasOwnProperty(u)){const f=this.footprintLookup[u];return f?{height:f.height,hidden:f.hiddenFlags!==0}:void 0}const h=new Be(e,i);for(const f of this.footprints)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=s||g_(h,f)&&(s=f.height,this.footprintLookup[u]=f,a=f.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.footprintLookup[u]=void 0}}function J1(r,e,i,s,a,u){const h=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let _=r[f+e].x,g=r[f+e].y;_=(_+a.x*it)*h-s.x*it,g=(g+a.y*it)*h-s.y*it,u.push(new Be(_,g))}}let Cx,Px;mt(Mx,"BuildingBucket",{omit:["layers"]}),mt(k_,"BuildingGeometry"),mt(Ax,"BuildingBloomGeometry");const Q1=fi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),ew=fi([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:tw}=Q1,iw=fi([{name:"a_packed",components:3,type:"Float32"}]),{members:rw}=iw,nw=fi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:sw}=nw;class Rx{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Rl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const s=this.getKey(e,i);return this.positions[s]}trim(){const e=this.width,i=this.height=me(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){const a=[];let u=e.length%2==1?-e[e.length-1]*s:0,h=e[0]*s,f=!0;a.push({left:u,right:h,isDash:f,zeroLength:e[0]===0});let _=e[0];for(let g=1;g<e.length;g++){f=!f;const v=e[g];u=_*s,_+=v,h=_*s,a.push({left:u,right:h,isDash:f,zeroLength:v===0})}return a}addRoundDash(e,i,s){const a=i/2;for(let u=-s;u<=s;u++){const h=this.width*(this.nextRow+s+u);let f=0,_=e[f];for(let g=0;g<this.width;g++){g/_.right>1&&(_=e[++f]);const v=Math.abs(g-_.left),b=Math.abs(g-_.right),w=Math.min(v,b);let I;const A=u/s*(a+1);if(_.isDash){const R=a-Math.abs(A);I=Math.sqrt(w*w+R*R)}else I=a-Math.sqrt(w*w+A*A);this.image.data[h+g]=Math.max(0,Math.min(255,I+128))}}}addRegularDash(e,i){for(let _=e.length-1;_>=0;--_){const g=e[_],v=e[_+1];g.zeroLength?e.splice(_,1):v&&v.isDash===g.isDash&&(v.left=g.left,e.splice(_,1))}const s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);const u=this.width*this.nextRow;let h=0,f=e[h];for(let _=0;_<this.width;_++){_/f.right>1&&(f=e[++h]);const g=Math.abs(_-f.left),v=Math.abs(_-f.right),b=Math.min(g,v);this.image.data[u+_]=Math.max(0,Math.min(255,(f.isDash?b:-b)+i+128))}}addDash(e,i){const s=this.getKey(e,i);if(this.positions[s])return this.positions[s];const a=i==="round",u=a?7:0,h=2*u+1;if(this.nextRow+h>this.height)return Mt("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let v=0;v<e.length;v++)e[v]<0&&(Mt("Negative value is found in line dasharray, replacing values with 0"),e[v]=0),f+=e[v];if(f!==0){const v=this.width/f,b=this.getDashRanges(e,this.width,v);a?this.addRoundDash(b,v,u):this.addRegularDash(b,i==="square"?.5*v:0)}const _=this.nextRow+u;this.nextRow+=h;const g={tl:[_,u],br:[f,0]};return this.positions[s]=g,g}}mt(Rx,"LineAtlas");const ow=je.types,aw=Math.cos(Math.PI/180*37.5),lw=Math.cos(Math.PI/180*5);class F_{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((i=>{this.gradients[i.id]={}})),this.layoutVertexArray=new Tu,this.layoutVertexArray2=new Ys,this.patternVertexArray=new Ys,this.indexArray=new zr,this.programConfigurations=new So(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Vr,this.maxLineLength=0,this.zOffsetVertexArray=new Ys,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:it/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.hasPattern=u_("line",this.layers,this.pixelRatio,i);const u=this.layers[0].layout.get("line-sort-key");this.tileToMeter=ne(s);const h=this.layers[0].layout.get("line-elevation-reference");if(h==="hd-road-markup")this.elevationType="road";else{const w=this.layers[0].layout.get("line-z-offset"),I=w.isConstant()&&!w.constantOr(0);this.elevationType=h!=="sea"&&h!=="ground"&&I?"none":"offset",this.elevationType==="offset"&&h==="none"&&Mt("line-elevation-reference: ground is used for the layer ".concat(this.layerIds[0]," because non-zero line-z-offset value was found."))}const f=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&f!==void 0;const _=[];for(const{feature:w,id:I,index:A,sourceLayerIndex:R}of e){const L=this.layers[0]._featureFilter.needGeometry,k=Te(w,L);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),k,s))continue;const U=u?u.evaluate(k,{},s):void 0,G={id:I,properties:w.properties,type:w.type,sourceLayerIndex:R,index:A,geometry:L?k.geometry:Le(w,s,a),patterns:{},sortKey:U};_.push(G)}u&&_.sort(((w,I)=>w.sortKey-I.sortKey));const{lineAtlas:g,featureIndex:v}=i,b=this.addConstantDashes(g);for(const w of _){const{geometry:I,index:A,sourceLayerIndex:R}=w;if(b&&this.addFeatureDashes(w,g),this.hasPattern){const L=h_("line",this.layers,w,this.zoom,this.pixelRatio,i);this.patternFeatures.push(L)}else this.addFeature(w,I,A,s,g.positions,i.availableImages,i.brightness,i.elevationFeatures);v.insert(e[A].feature,I,A,R,this.index)}}addConstantDashes(e){let i=!1;for(const s of this.layers){const a=s.paint.get("line-dasharray").value,u=s.layout.get("line-cap").value;if(a.kind!=="constant"||u.kind!=="constant")i=!0;else{const h=u.value,f=a.value;if(!f)continue;e.addDash(f,h)}}return i}addFeatureDashes(e,i){const s=this.zoom;for(const a of this.layers){const u=a.paint.get("line-dasharray").value,h=a.layout.get("line-cap").value;if(u.kind==="constant"&&h.kind==="constant")continue;let f,_;if(u.kind==="constant"){if(f=u.value,!f)continue}else f=u.evaluate({zoom:s},e);_=h.kind==="constant"?h.value:h.evaluate({zoom:s},e),i.addDash(f,_),e.patterns[a.id]=[i.getKey(f,_)]}}update(e,i,s,a,u,h,f,_){this.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,_)}addFeatures(e,i,s,a,u,h){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,rw)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,sw)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,ew.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tw),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,i){let s,a;if(i&&i>0?(s="mapbox_clip_start_".concat(i),a="mapbox_clip_end_".concat(i)):(s="mapbox_clip_start",a="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(s)&&e.properties.hasOwnProperty(a))return{start:+e.properties[s],end:+e.properties[a]}}addFeature(e,i,s,a,u,h,f,_){const g=this.layers[0].layout,v=g.get("line-join").evaluate(e,{}),b=g.get("line-cap").evaluate(e,{}),w=g.get("line-miter-limit"),I=g.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const A=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=g.get("line-z-offset").value;const R=this.layers[0].paint.get("line-width").value;if(R.kind!=="constant"&&R.isLineProgressConstant===!1&&(this.variableWidthValue=R),this.elevationType==="road"){const L=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,_,v,b,w,I)){const[k,U]=this.clipRuntimeLinesToTile(i,1);for(let G=0;G<k.length;G++){const q=k[G],ie=U[G],J={progress:{min:ie.progress.min,max:ie.progress.max},nextDir:this.computeSegNextDir(ie,q),prevDir:this.computeSegPrevDir(ie,q)};this.addLine(q,e,a,v,b,w,I,J,A&&ie.parentIndex>0?ie.parentIndex:null)}this.fillNonElevatedRoadSegment(L)}}else for(let L=0;L<i.length;L++)this.addLine(i[L],e,a,v,b,w,I,void 0,A&&L>0?L:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,u,h,a,f,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Ap(e,-i,-i,it+i,it+i)}clipRuntimeLinesToTile(e,i){const s=[];return[Ap(e,-i,-i,it+i,it+i,s),s]}addElevatedRoadFeature(e,i,s,a,u,h,f,_){const g=[],v=qt.getElevationFeature(e,a);if(v){const b=this.clipLinesToTile(i,1),w=this.prepareElevatedLines(b,v,s);for(const I of w)g.push({geometry:I,elevation:v,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(g.length===0)return!1;for(const b of g){const w=this.layoutVertexArray.length;this.addLine(b.geometry,e,s,u,h,f,_);const I=new Ti(s,b.elevationTileID);if(b.elevation)for(let A=w;A<this.layoutVertexArray.length;A++){const R=new Be(this.layoutVertexArray.int16[6*A]>>1,this.layoutVertexArray.int16[6*A+1]>>1),L=I.pointElevation(R,b.elevation,.05);this.updateHeightRange(L),this.zOffsetVertexArray.emplaceBack(L,0,0)}else this.fillNonElevatedRoadSegment(w)}return!0}prepareElevatedLines(e,i,s){if(i.constantHeight!=null)return e;const a=[],u=1/ne(s);for(const h of e)v1(h,new br(i,u),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,s,a,u,h,f,_,g){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=g?this.lineFeatureClips(i,g):this.lineClips;const v=a==="none";this.patternJoinNone=this.hasPattern&&v,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const b=_&&_.progress.min>0,w=_&&_.progress.max<1;if(this.lineClips){let he={min:this.lineClips.start,max:this.lineClips.end},Ce=1;if(_){const ke=this.lineClips.end-this.lineClips.start;he=(function(Ve,Qe,qe){return{min:Di(Ve.min,Qe,qe),max:Di(Ve.max,Qe,qe)}})(_.progress,{min:0,max:1},he),ke>0&&(Ce=(he.max-he.min)/ke)}const ye=+i.properties.mapbox_clip_feature_len,Pe=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(ye)||Number.isNaN(Pe)){for(let Ve=0;Ve<e.length-1;Ve++)this.totalDistance+=e[Ve].dist(e[Ve+1]);const ke=this.totalDistance/(he.max-he.min);this.totalFeatureLength=Number.isFinite(ke)?ke:0,this.lineClips.start=he.min,this.lineClips.end=he.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ye,this.distance=Pe*Ce,this.lineClips.start=he.min,this.lineClips.end=he.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const I=ow[i.type]==="Polygon";let A=e.length;for(;A>=2&&e[A-1].equals(e[A-2]);)A--;let R=0;for(;R<A-1&&e[R].equals(e[R+1]);)R++;if(A<(I?3:2))return;a==="bevel"&&(h=1.05);const L=this.segments.prepareSegment(10*A,this.layoutVertexArray,this.indexArray);let k,U,G,q,ie,J,se,le;_&&_.prevDir&&(J=_.prevDir.perp()),_&&_.nextDir&&(se=_.nextDir.perp()),this.e1=this.e2=-1,I&&(k=e[A-2],ie=e[R].sub(k)._unit()._perp());for(let he=R;he<A;he++){if(G=he===A-1?I?e[R+1]:void 0:e[he+1],G&&e[he].equals(G))continue;ie&&(q=ie),k&&(U=k),k=e[he],le=this.evaluateLineProgressFeatures(U?U.dist(k):0),ie=G?G.sub(k)._unit()._perp():q,q=q||ie;const Ce=U&&G;let ye=Ce?a:I||v?"butt":u;const Pe=q.x*ie.x+q.y*ie.y;if(v){const Ee=function(Ge){if(Ge.patternJoinNone){const Ye=Ge.segmentPoints.length/2,Ne=Ge.lineSoFar-Ge.segmentStart;for(let pt=0;pt<Ye;++pt){const yt=Ge.segmentPoints[2*pt+1],ht=Math.round(Ge.segmentPoints[2*pt])+.5+.25*yt;Ge.patternVertexArray.emplaceBack(ht,Ne,Ge.segmentStart),Ge.patternVertexArray.emplaceBack(ht,Ne,Ge.segmentStart)}Ge.segmentPoints.length=0}Ge.e1=Ge.e2=-1};if(Ce&&Pe<lw){this.updateDistance(U,k),this.addCurrentVertex(k,q,1,1,L,le),Ee(this),this.addCurrentVertex(k,ie,-1,-1,L,le);continue}if(U){if(!G){this.updateDistance(U,k),this.addCurrentVertex(k,q,1,1,L,le),Ee(this);continue}ye="miter"}}let ke=q.add(ie);ke.x===0&&ke.y===0||ke._unit();const Ve=ke.x*ie.x+ke.y*ie.y,Qe=Ve!==0?1/Ve:1/0,qe=2*Math.sqrt(2-2*Ve),Fe=Ve<aw&&U&&G,He=q.x*ie.y-q.y*ie.x>0,Ae=this.overscaling<=16?15*it/(512*this.overscaling):0;if(Ce&&ye==="round"){if(Qe<f)ye="miter";else if(Qe<=2){const Ee=B_(k,-10,it+10);ye=this.elevationType==="offset"&&(Ee||this.hasCrossSlope)?"miter":"fakeround"}}if(ye==="miter"&&Qe>h&&(ye="bevel"),ye==="bevel"&&(Qe>2&&(ye="flipbevel"),Qe<h&&(ye="miter")),U&&!(ye==="miter"&&Fe)&&this.updateDistance(U,k),ye==="miter")if(Fe){const Ee=k.dist(U);if(Ee>2*Ae){const Ye=k.sub(k.sub(U)._mult(Ae/Ee)._round());this.updateDistance(U,Ye),this.addCurrentVertex(Ye,q,0,0,L,le),U=Ye}this.updateDistance(U,k),ke._mult(Qe),this.addCurrentVertex(k,ke,0,0,L,le);const Ge=k.dist(G);if(Ge>2*Ae){const Ye=k.add(G.sub(k)._mult(Ae/Ge)._round());this.updateDistance(k,Ye),this.addCurrentVertex(Ye,ie,0,0,L,le),k=Ye}}else ke._mult(Qe),this.addCurrentVertex(k,ke,0,0,L,le);else if(ye==="flipbevel"){if(Qe>100)ke=ie.mult(-1);else{const Ee=Qe*q.add(ie).mag()/q.sub(ie).mag();ke._perp()._mult(Ee*(He?-1:1))}this.addCurrentVertex(k,ke,0,0,L,le),this.addCurrentVertex(k,ke.mult(-1),0,0,L,le)}else if(ye==="bevel"||ye==="fakeround"){le!=null&&U&&this.addCurrentVertex(k,se||q,-1,-1,L,le);const Ee=k.dist(U)<=2*Ae&&ye!=="bevel",Ge=ke.mult(He?1:-1);Ge._mult(Qe);const Ye=ie.mult(He?-1:1),Ne=q.mult(He?-1:1),pt=this.evaluateLineProgressFeatures(this.distance);if(le==null&&(this.addHalfVertex(k,Ge.x,Ge.y,!1,!He,0,L,pt),Ee||this.addHalfVertex(k,Ge.x+2*Ne.x,Ge.y+2*Ne.y,!1,He,0,L,pt)),ye==="fakeround"){const yt=Math.round(180*qe/Math.PI/20);this.addHalfVertex(k,Ne.x,Ne.y,!1,He,0,L,pt);for(let ht=0;ht<yt;ht++){let st=ht/yt;if(st!==.5){const at=st-.5;st+=st*at*(st-1)*((1.0904+Pe*(Pe*(3.55645-1.43519*Pe)-3.2452))*at*at+(.848013+Pe*(.215638*Pe-1.06021)))}const $t=Ye.sub(Ne)._mult(st)._add(Ne)._unit();this.addHalfVertex(k,$t.x,$t.y,!1,He,0,L,pt)}this.addHalfVertex(k,Ye.x,Ye.y,!1,He,0,L,pt)}Ee||le!=null||this.addHalfVertex(k,Ge.x+2*Ye.x,Ge.y+2*Ye.y,!1,He,0,L,pt),le!=null&&G&&this.addCurrentVertex(k,J||ie,1,1,L,le)}else if(ye==="butt")this.addCurrentVertex(k,ke,0,0,L,le);else if(ye==="square"){if(!U){const Ee=b?0:-1;this.addCurrentVertex(k,ke,Ee,Ee,L,le)}if(this.addCurrentVertex(k,ke,0,0,L,le),U){const Ee=w?0:1;this.addCurrentVertex(k,ke,Ee,Ee,L,le)}}else if(ye==="round"){if(U){const Ee=!Ce&&se?se:q;this.addCurrentVertex(k,Ee,0,0,L,le),!Ce&&w||this.addCurrentVertex(k,Ee,1,1,L,le,!0)}if(G){const Ee=!Ce&&J?J:ie;!Ce&&b||this.addCurrentVertex(k,Ee,-1,-1,L,le,!0),this.addCurrentVertex(k,Ee,0,0,L,le)}}}}addVerticesTo(e,i,s,a,u,h,f,_,g,v){const b=(i.w-e.w)/this.tessellationStep|0;let w=0;const I=this.scaledDistance;if(b>1){this.lineSoFar=e.w;const R=(i.x-e.x)/b,L=(i.y-e.y)/b,k=(i.z-e.z)/b,U=(i.w-e.w)/b;for(let G=1;G<b;++G){e.x+=R,e.y+=L,e.z+=k,this.lineSoFar+=U,w+=U;const q=this.evaluateLineProgressFeatures(this.prevDistance+w);this.scaledDistance=(this.prevDistance+w)/this.totalDistance,this.addHalfVertex(e,s,a,v,!1,f,g,q),this.addHalfVertex(e,u,h,v,!0,-_,g,q)}}this.lineSoFar=i.w,this.scaledDistance=I;const A=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,a,v,!1,f,g,A),this.addHalfVertex(i,u,h,v,!0,-_,g,A)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Mt("line-progress evaluation for ".concat(this.layerIds[0]," requires enabling 'lineMetrics' for the source."));let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,s,a,u,h,f=!1){const _=i.x+i.y*s,g=i.y-i.x*s,v=i.y*a-i.x,b=-i.y-i.x*a;if(h!=null){const w=this.elevationType==="offset",I=-10,A=it+10,R=h.zOffset,L=new Jy(e.x,e.y,R,this.lineSoFar),k=!!w&&B_(e,I,A),U=this.lineSoFar,G=this.distance;if(this.currentVertex)if(k){const q=this.currentVertexIsOutside,ie=this.currentVertex,J=new Jy(e.x,e.y,R,this.lineSoFar);if(ex(ie,J,I,A),!B_(J,I,A)){if(q){this.e1=this.e2=-1,this.distance-=ie.dist(L),this.lineSoFar=ie.w;const se=this.evaluateLineProgressFeatures(ie.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(ie,_,g,f,!1,s,u,se),this.addHalfVertex(ie,v,b,f,!0,-a,u,se),this.prevDistance=this.distance}this.distance=this.prevDistance+ie.dist(J),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(ie,J,_,g,v,b,s,a,u,f),this.distance=G,this.scaledDistance=this.distance/this.totalDistance}}else{const q=this.currentVertex;if(this.currentVertexIsOutside){ex(q,L,I,A),this.e1=this.e2=-1,this.distance-=q.dist(L),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=q.w;const ie=this.evaluateLineProgressFeatures(q.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(q,_,g,f,!1,s,u,ie),this.addHalfVertex(q,v,b,f,!0,-a,u,ie),this.prevDistance=this.distance,this.distance=G,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(q,L,_,g,v,b,s,a,u,f)}else k||(this.addHalfVertex(e,_,g,f,!1,s,u,h),this.addHalfVertex(e,v,b,f,!0,-a,u,h));this.currentVertex=L,this.currentVertexIsOutside=k,this.lineSoFar=U}else this.addHalfVertex(e,_,g,f,!1,s,u,h),this.addHalfVertex(e,v,b,f,!0,-a,u,h)}addHalfVertex({x:e,y:i},s,a,u,h,f,_,g){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,f)),this.layoutVertexArray.emplaceBack((e<<1)+(u?1:0),(i<<1)+(h?1:0),Math.round(63*s)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const b=Vt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,b)}const v=_.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,v),_.primitiveLength++),h?this.e2=v:this.e1=v,g!=null&&this.zOffsetVertexArray.emplaceBack(g.zOffset,g.variableWidth,g.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function B_(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let Dx,zx;function Lx(r,e,i){return e*(it/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}mt(F_,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Ox=(r,e,i)=>(1-i)*r+i*e;function kx(r,e){return 1/Lx(r,1,e.tileZoom)}function Fx(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const Bx=r=>{const e=[];Nx(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const s=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return s&&a&&e.push("LINE_JOIN_NONE"),e};function Nx(r){const e=r.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let N_;const Vx=()=>N_||(N_={layout:Dx||(Dx=new $r({"line-cap":new ct(ge.layout_line["line-cap"]),"line-join":new ct(ge.layout_line["line-join"]),"line-miter-limit":new We(ge.layout_line["line-miter-limit"]),"line-round-limit":new We(ge.layout_line["line-round-limit"]),"line-sort-key":new ct(ge.layout_line["line-sort-key"]),"line-z-offset":new ct(ge.layout_line["line-z-offset"]),"line-elevation-reference":new We(ge.layout_line["line-elevation-reference"]),"line-cross-slope":new We(ge.layout_line["line-cross-slope"]),visibility:new We(ge.layout_line.visibility),"line-width-unit":new We(ge.layout_line["line-width-unit"])})),paint:zx||(zx=new $r({"line-opacity":new ct(ge.paint_line["line-opacity"]),"line-color":new ct(ge.paint_line["line-color"]),"line-translate":new We(ge.paint_line["line-translate"]),"line-translate-anchor":new We(ge.paint_line["line-translate-anchor"]),"line-width":new ct(ge.paint_line["line-width"]),"line-gap-width":new ct(ge.paint_line["line-gap-width"]),"line-offset":new ct(ge.paint_line["line-offset"]),"line-blur":new ct(ge.paint_line["line-blur"]),"line-dasharray":new ct(ge.paint_line["line-dasharray"]),"line-pattern":new ct(ge.paint_line["line-pattern"]),"line-pattern-cross-fade":new We(ge.paint_line["line-pattern-cross-fade"]),"line-gradient":new ml(ge.paint_line["line-gradient"]),"line-trim-offset":new We(ge.paint_line["line-trim-offset"]),"line-trim-fade-range":new We(ge.paint_line["line-trim-fade-range"]),"line-trim-color":new We(ge.paint_line["line-trim-color"]),"line-emissive-strength":new We(ge.paint_line["line-emissive-strength"]),"line-border-width":new ct(ge.paint_line["line-border-width"]),"line-border-color":new ct(ge.paint_line["line-border-color"]),"line-occlusion-opacity":new We(ge.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},N_);class cw extends ct{possiblyEvaluate(e,i){return i=new yr(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,a){return i=Object.assign({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,a)}}let Ud;function Ux(r,e){return e>0?e+2*r:r}const uw=fi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),hw=fi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),dw=fi([{name:"a_projected_pos",components:4,type:"Float32"}],4);fi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const fw=fi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),pw=fi([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),mw=fi([{name:"a_texb",components:2,type:"Uint16"}]),_w=fi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),gw=fi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);fi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const jx=fi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),yw=fi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);fi([{name:"triangle",components:3,type:"Uint16"}]),fi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),fi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),fi([{type:"Float32",name:"offsetX"}]),fi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Zn=24;function xw(r,e,i){return r.sections.forEach((s=>{s.text=(function(a,u,h){const f=u.layout.get("text-transform").evaluate(h,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),Vs.applyArabicShaping&&(a=Vs.applyArabicShaping(a)),a})(s.text,e,i)})),r}const jd={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function vw(r){return r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""}function bw(r){return r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""||r===""}const V_=4294967296,Gx=1/V_,Hx=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let Bp=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,i=this.length){for(;this.pos<i;){const s=this.readVarint(),a=s>>3,u=this.pos;this.type=7&s,r(a,e,this),this.pos===u&&this.skip(s)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){const r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){const r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*V_;return this.pos+=8,r}readSFixed64(){const r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*V_;return this.pos+=8,r}readFloat(){const r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){const r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){const e=this.buf;let i,s;return s=e[this.pos++],i=127&s,s<128?i:(s=e[this.pos++],i|=(127&s)<<7,s<128?i:(s=e[this.pos++],i|=(127&s)<<14,s<128?i:(s=e[this.pos++],i|=(127&s)<<21,s<128?i:(s=e[this.pos],i|=(15&s)<<28,(function(a,u,h){const f=h.buf;let _,g;if(g=f[h.pos++],_=(112&g)>>4,g<128||(g=f[h.pos++],_|=(127&g)<<3,g<128)||(g=f[h.pos++],_|=(127&g)<<10,g<128)||(g=f[h.pos++],_|=(127&g)<<17,g<128)||(g=f[h.pos++],_|=(127&g)<<24,g<128)||(g=f[h.pos++],_|=(1&g)<<31,g<128))return Hu(a,_,u);throw new Error("Expected varint not more than 10 bytes")})(i,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){const r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&Hx?Hx.decode(this.buf.subarray(e,r)):(function(i,s,a){let u="",h=s;for(;h<a;){const f=i[h];let _,g,v,b=null,w=f>239?4:f>223?3:f>191?2:1;if(h+w>a)break;w===1?f<128&&(b=f):w===2?(_=i[h+1],(192&_)==128&&(b=(31&f)<<6|63&_,b<=127&&(b=null))):w===3?(_=i[h+1],g=i[h+2],(192&_)==128&&(192&g)==128&&(b=(15&f)<<12|(63&_)<<6|63&g,(b<=2047||b>=55296&&b<=57343)&&(b=null))):w===4&&(_=i[h+1],g=i[h+2],v=i[h+3],(192&_)==128&&(192&g)==128&&(192&v)==128&&(b=(15&f)<<18|(63&_)<<12|(63&g)<<6|63&v,(b<=65535||b>=1114112)&&(b=null))),b===null?(b=65533,w=1):b>65535&&(b-=65536,u+=String.fromCharCode(b>>>10&1023|55296),b=56320|1023&b),u+=String.fromCharCode(b),h+=w}return u})(this.buf,e,r)}readBytes(){const r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){const i=this.readPackedEnd();for(;this.pos<i;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){const e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){const e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error("Unimplemented type: ".concat(e));this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*Gx),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*Gx),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?(function(e,i){let s,a;if(e>=0?(s=e%4294967296|0,a=e/4294967296|0):(s=~(-e%4294967296),a=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),(function(u,h,f){f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,u>>>=7,f.buf[f.pos++]=127&u|128,f.buf[f.pos]=127&(u>>>=7)})(s,0,i),(function(u,h){const f=(7&u)<<4;h.buf[h.pos++]|=f|((u>>>=3)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u|((u>>>=7)?128:0),u&&(h.buf[h.pos++]=127&u)))))})(a,i)})(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;const e=this.pos;this.pos=(function(s,a,u){for(let h,f,_=0;_<a.length;_++){if(h=a.charCodeAt(_),h>55295&&h<57344){if(!f){h>56319||_+1===a.length?(s[u++]=239,s[u++]=191,s[u++]=189):f=h;continue}if(h<56320){s[u++]=239,s[u++]=191,s[u++]=189,f=h;continue}h=f-55296<<10|h-56320|65536,f=null}else f&&(s[u++]=239,s[u++]=191,s[u++]=189,f=null);h<128?s[u++]=h:(h<2048?s[u++]=h>>6|192:(h<65536?s[u++]=h>>12|224:(s[u++]=h>>18|240,s[u++]=h>>12&63|128),s[u++]=h>>6&63|128),s[u++]=63&h|128)}return u})(this.buf,r,this.pos);const i=this.pos-e;i>=128&&qx(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){const e=r.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=r[i]}writeRawMessage(r,e){this.pos++;const i=this.pos;r(e,this);const s=this.pos-i;s>=128&&qx(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s}writeMessage(r,e,i){this.writeTag(r,2),this.writeRawMessage(e,i)}writePackedVarint(r,e){e.length&&this.writeMessage(r,ww,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,Tw,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,Iw,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,Sw,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,Ew,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,Aw,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,Mw,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,Cw,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,Pw,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function Hu(r,e,i){return i?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function qx(r,e,i){const s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(s);for(let a=i.pos-1;a>=r;a--)i.buf[a+s]=i.buf[a]}function ww(r,e){for(let i=0;i<r.length;i++)e.writeVarint(r[i])}function Tw(r,e){for(let i=0;i<r.length;i++)e.writeSVarint(r[i])}function Sw(r,e){for(let i=0;i<r.length;i++)e.writeFloat(r[i])}function Ew(r,e){for(let i=0;i<r.length;i++)e.writeDouble(r[i])}function Iw(r,e){for(let i=0;i<r.length;i++)e.writeBoolean(r[i])}function Aw(r,e){for(let i=0;i<r.length;i++)e.writeFixed32(r[i])}function Mw(r,e){for(let i=0;i<r.length;i++)e.writeSFixed32(r[i])}function Cw(r,e){for(let i=0;i<r.length;i++)e.writeFixed64(r[i])}function Pw(r,e){for(let i=0;i<r.length;i++)e.writeSFixed64(r[i])}const U_=3;function Rw(r,e,i){e.glyphs=[],r===1&&i.readMessage(Dw,e)}function Dw(r,e,i){if(r===3){const{id:s,bitmap:a,width:u,height:h,left:f,top:_,advance:g}=i.readMessage(zw,{});e.glyphs.push({id:s,bitmap:new Rl({width:u+2*U_,height:h+2*U_},a),metrics:{width:u,height:h,left:f,top:_,advance:g}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function zw(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}const $x=U_,ro={horizontal:1,vertical:2,horizontalOnly:3};class Gd{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const s=new Gd;return s.scale=e||1,s.fontStack=i,s}static forImage(e){const i=new Gd;return i.image=e,i}}class qu{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,s){const a=new qu;for(let u=0;u<e.sections.length;u++){const h=e.sections[u];h.image?a.addImageSection(h,s):a.addTextSection(h,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=(function(i,s){let a="";for(let u=0;u<i.length;u++){const h=i.charCodeAt(u+1)||null,f=i.charCodeAt(u-1)||null;a+=!s&&(h&&Zh(h)&&!jd[i[u+1]]||f&&Zh(f)&&!jd[i[u-1]])||!jd[i[u]]?i[u]:jd[i[u]]}return a})(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&Np[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&Np[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const s=new qu;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,i)=>Math.max(e,this.sections[i].scale)),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Gd.forText(e.scale,e.fontStack||i));const s=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(s)}addImageSection(e,i){const s=e.image?e.image.getPrimary():null;if(!s)return void Mt("Can't add FormattedSection with an empty image.");s.scaleSelf(i);const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(Gd.forImage(s)),this.sectionIndex.push(this.sections.length-1)):Mt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function j_(r,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R=1){const L=qu.fromFeature(r,a,R);b===ro.vertical&&L.verticalizePunctuation(w);let k=[];const U=(function(se,le,he,Ce,ye,Pe){if(!se)return[];const ke=[],Ve=(function(He,Ae,Ee,Ge,Ye,Ne){let pt=0;for(let yt=0;yt<He.length();yt++){const ht=He.getSection(yt);pt+=Zx(He.getCodePoint(yt),ht,Ge,Ye,Ae,Ne)}return pt/Math.max(1,Math.ceil(pt/Ee))})(se,le,he,Ce,ye,Pe),Qe=se.text.indexOf("")>=0;let qe=0;for(let He=0;He<se.length();He++){const Ae=se.getSection(He),Ee=se.getCodePoint(He);if(Np[Ee]||(qe+=Zx(Ee,Ae,Ce,ye,le,Pe)),He<se.length()-1){const Ge=!((Fe=Ee)<11904||!(Dt["Bopomofo Extended"](Fe)||Dt.Bopomofo(Fe)||Dt["CJK Compatibility Forms"](Fe)||Dt["CJK Compatibility Ideographs"](Fe)||Dt["CJK Compatibility"](Fe)||Dt["CJK Radicals Supplement"](Fe)||Dt["CJK Strokes"](Fe)||Dt["CJK Symbols and Punctuation"](Fe)||Dt["CJK Unified Ideographs Extension A"](Fe)||Dt["CJK Unified Ideographs"](Fe)||Dt["Enclosed CJK Letters and Months"](Fe)||Dt["Halfwidth and Fullwidth Forms"](Fe)||Dt.Hiragana(Fe)||Dt["Ideographic Description Characters"](Fe)||Dt["Kangxi Radicals"](Fe)||Dt["Katakana Phonetic Extensions"](Fe)||Dt.Katakana(Fe)||Dt["Vertical Forms"](Fe)||Dt["Yi Radicals"](Fe)||Dt["Yi Syllables"](Fe)));(Lw[Ee]||Ge||Ae.image)&&ke.push(Xx(He+1,qe,Ve,ke,Ow(Ee,se.getCodePoint(He+1),Ge&&Qe),!1))}}var Fe;return Yx(Xx(se.length(),qe,Ve,ke,0,!0))})(L,g,u,e,s,I),{processBidirectionalText:G,processStyledBidirectionalText:q}=Vs;if(G&&L.sections.length===1){const se=G(L.toString(),U);for(const le of se){const he=new qu;he.text=le,he.sections=L.sections;for(let Ce=0;Ce<le.length;Ce++)he.sectionIndex.push(0);k.push(he)}}else if(q){const se=q(L.text,L.sectionIndex,U);for(const le of se){const he=new qu;he.text=le[0],he.sectionIndex=le[1],he.sections=L.sections,k.push(he)}}else k=(function(se,le){const he=[],Ce=se.text;let ye=0;for(const Pe of le)he.push(se.substring(ye,Pe)),ye=Pe;return ye<Ce.length&&he.push(se.substring(ye,Ce.length)),he})(L,U);const ie=[],J={positionedLines:ie,text:L.toString(),top:v[1],bottom:v[1],left:v[0],right:v[0],writingMode:b,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if((function(se,le,he,Ce,ye,Pe,ke,Ve,Qe,qe,Fe,He){let Ae=0,Ee=0,Ge=0;const Ye=Ve==="right"?1:Ve==="left"?0:.5;let Ne=!1;for(const at of ye){const Ct=at.getSections();for(const Wt of Ct){if(Wt.image)continue;const oi=le[Wt.fontStack];if(oi&&(Ne=oi.ascender!==void 0&&oi.descender!==void 0,!Ne))break}if(!Ne)break}let pt=0;for(const at of ye){at.trim();const Ct=at.getMaxScale(),Wt=(Ct-1)*Zn,oi={positionedGlyphs:[],lineOffset:0};se.positionedLines[pt]=oi;const Si=oi.positionedGlyphs;let Yt=0;if(!at.length()){Ee+=Pe,++pt;continue}let zi=0,Li=0;for(let Q=0;Q<at.length();Q++){const Y=at.getSection(Q),Re=at.getSectionIndex(Q),nt=at.getCodePoint(Q);let De=Y.scale,ot=null,Et=null,St=null,Kt=Zn,kt=0,bt=Qe;bt===ro.vertical&&((yt=nt)===12312||yt===12313||yt===12316||yt===12540||yt===12448)&&(bt=ro.horizontal);const Ri=!(bt===ro.horizontal||!Fe&&!yu(nt)||Fe&&(Np[nt]||Wh(nt)));if(Y.image){const rr=Ce.get(Y.image.toString());if(!rr)continue;St=Y.image,se.iconsInText=se.iconsInText||!0,Et=rr.paddedRect;const Nt=rr.displaySize;De=De*Zn/He,ot={width:Nt[0],height:Nt[1],left:0,top:-$x,advance:Ri?Nt[1]:Nt[0],localGlyph:!1},kt=Ne?-ot.height*De:Ct*Zn-17-Nt[1]*De,Kt=ot.advance;const wi=(Ri?Nt[0]:Nt[1])*De-Zn*Ct;wi>0&&wi>Yt&&(Yt=wi)}else{const rr=he[Y.fontStack];if(!rr)continue;rr[nt]&&(Et=rr[nt]);const Nt=le[Y.fontStack];if(!Nt)continue;const wi=Nt.glyphs[nt];if(!wi)continue;if(ot=wi.metrics,Kt=nt!==8203?Zn:0,Ne){const nr=Nt.ascender!==void 0?Math.abs(Nt.ascender):0,Hi=Nt.descender!==void 0?Math.abs(Nt.descender):0,qr=(nr+Hi)*De;zi<qr&&(zi=qr,Li=(nr-Hi)/2*De),kt=-nr*De}else kt=(Ct-De)*Zn-17}Ri?(se.verticalizable=!0,Si.push({glyph:nt,image:St,x:Ae,y:Ee+kt,vertical:Ri,scale:De,localGlyph:ot.localGlyph,fontStack:Y.fontStack,sectionIndex:Re,metrics:ot,rect:Et}),Ae+=Kt*De+qe):(Si.push({glyph:nt,image:St,x:Ae,y:Ee+kt,vertical:Ri,scale:De,localGlyph:ot.localGlyph,fontStack:Y.fontStack,sectionIndex:Re,metrics:ot,rect:Et}),Ae+=ot.advance*De+qe)}Si.length!==0&&(Ge=Math.max(Ae-qe,Ge),Ne?Kx(Si,Ye,Yt,Li,Pe*Ct/2):Kx(Si,Ye,Yt,0,Pe/2)),Ae=0;const kr=Pe*Ct+Yt;oi.lineOffset=Math.max(Yt,Wt),Ee+=kr,++pt}var yt;const ht=Ee,{horizontalAlign:st,verticalAlign:$t}=G_(ke);(function(at,Ct,Wt,oi,Si,Yt){const zi=(Ct-Wt)*Si,Li=-Yt*oi;for(const kr of at)for(const Q of kr.positionedGlyphs)Q.x+=zi,Q.y+=Li})(se.positionedLines,Ye,st,$t,Ge,ht),se.top+=-$t*ht,se.bottom=se.top+ht,se.left+=-st*Ge,se.right=se.left+Ge,se.hasBaseline=Ne})(J,e,i,s,k,h,f,_,b,g,w,A),!(function(se){for(const le of se)if(le.positionedGlyphs.length!==0)return!1;return!0})(ie))return J}const Np={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Lw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Zx(r,e,i,s,a,u){if(e.image){const h=s.get(e.image.toString());return h?h.displaySize[0]*e.scale*Zn/u+a:0}{const h=i[e.fontStack],f=h&&h.glyphs[r];return f?f.metrics.advance*e.scale+a:0}}function Wx(r,e,i,s){const a=Math.pow(r-e,2);return s?r<e?a/2:2*a:a+Math.abs(i)*i}function Ow(r,e,i){let s=0;return r===10&&(s-=1e4),i&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function Xx(r,e,i,s,a,u){let h=null,f=Wx(e,i,a,u);for(const _ of s){const g=Wx(e-_.x,i,a,u)+_.badness;g<=f&&(h=_,f=g)}return{index:r,x:e,priorBreak:h,badness:f}}function Yx(r){return r?Yx(r.priorBreak).concat(r.index):[]}function G_(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Kx(r,e,i,s,a){if(!(e||i||s||a))return;const u=r.length-1,h=r[u],f=(h.x+h.metrics.advance*h.scale)*e;for(let _=0;_<=u;_++)r[_].x-=f,r[_].y+=i+s+a}function Jx(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function Vp(r,e,i,s){const{horizontalAlign:a,verticalAlign:u}=G_(s),h=i[0]-r.displaySize[0]*a,f=i[1]-r.displaySize[1]*u;return{imagePrimary:r,imageSecondary:e,top:f,bottom:f+r.displaySize[1],left:h,right:h+r.displaySize[0]}}function H_(r,e,i,s,a,u){const h=r.imagePrimary;let f;if(h.content){const L=h.content,k=h.pixelRatio||1;f=[L[0]/k,L[1]/k,h.displaySize[0]-L[2]/k,h.displaySize[1]-L[3]/k]}const _=e.left*u,g=e.right*u;let v,b,w,I;i==="width"||i==="both"?(I=a[0]+_-s[3],b=a[0]+g+s[1]):(I=a[0]+(_+g-h.displaySize[0])/2,b=I+h.displaySize[0]);const A=e.top*u,R=e.bottom*u;return i==="height"||i==="both"?(v=a[1]+A-s[0],w=a[1]+R+s[2]):(v=a[1]+(A+R-h.displaySize[1])/2,w=v+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:v,right:b,bottom:w,left:I,collisionPadding:f}}function Qx(r){return!r.imagePrimary.stretchX}function ev(r){return!r.imagePrimary.stretchY}function tv(r){return{width:r.right-r.left,height:r.bottom-r.top}}const Qo=128;function $u(r,e,i){const{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new yr(r+1,{worldview:i}))};if(s.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:u}=s;let h=0;for(;h<a.length&&a[h]<=r;)h++;h=Math.max(0,h-1);let f=h;for(;f<a.length&&a[f]<r+1;)f++;f=Math.min(a.length-1,f);const _=a[h],g=a[f];return s.kind==="composite"?{kind:"composite",minZoom:_,maxZoom:g,interpolationType:u}:{kind:"camera",minZoom:_,maxZoom:g,minSize:s.evaluate(new yr(_,{worldview:i})),maxSize:s.evaluate(new yr(g,{worldview:i})),interpolationType:u}}}function q_(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:a}){return r.kind==="source"?s/Qo:r.kind==="composite"?Vt(s/Qo,a/Qo,i):e}function Zu(r,e,i=1){let s=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){const{interpolationType:u,minZoom:h,maxZoom:f}=r,_=u?B(Ws.interpolationFactor(u,e,h,f),0,1):0;r.kind==="camera"?a=Vt(r.minSize,r.maxSize,_)*i:s=_*i}return{uSizeT:s,uSize:a}}class Ga extends Be{constructor(e,i,s,a,u){super(e,i),this.angle=a,this.z=s,u!==void 0&&(this.segment=u)}clone(){return new Ga(this.x,this.y,this.z,this.angle,this.segment)}}function iv(r,e,i,s,a){if(e.segment===void 0)return!0;let u=e,h=e.segment+1,f=0;for(;f>-i/2;){if(h--,h<0)return!1;f-=r[h].dist(u),u=r[h]}f+=r[h].dist(r[h+1]),h++;const _=[];let g=0;for(;f<i/2;){const v=r[h],b=r[h+1];if(!b)return!1;let w=r[h-1].angleTo(v)-v.angleTo(b);for(w=Math.abs((w+3*Math.PI)%(2*Math.PI)-Math.PI),_.push({distance:f,angleDelta:w}),g+=w;f-_[0].distance>s;)g-=_.shift().angleDelta;if(g>a)return!1;h++,f+=v.dist(b)}return!0}function rv(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function nv(r,e,i){return r?.6*e*i:0}function sv(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function kw(r,e,i,s,a,u){const h=nv(i,a,u),f=sv(i,s)*u;let _=0;const g=rv(r)/2;for(let v=0;v<r.length-1;v++){const b=r[v],w=r[v+1],I=b.dist(w);if(_+I>g){const A=(g-_)/I,R=Vt(b.x,w.x,A),L=Vt(b.y,w.y,A),k=new Ga(R,L,0,w.angleTo(b),v);return!h||iv(r,k,f,h,e)?k:void 0}_+=I}}function Fw(r,e,i,s,a,u,h,f,_){const g=nv(s,u,h),v=sv(s,a),b=v*h,w=r[0].x===0||r[0].x===_||r[0].y===0||r[0].y===_;return e-b<e/4&&(e=b+e/4),ov(r,w?e/2*f%e:(v/2+2*u)*h*f%e,e,g,i,b,w,!1,_)}function ov(r,e,i,s,a,u,h,f,_){const g=u/2,v=rv(r);let b=0,w=e-i,I=[];for(let A=0;A<r.length-1;A++){const R=r[A],L=r[A+1],k=R.dist(L),U=L.angleTo(R);for(;w+i<b+k;){w+=i;const G=(w-b)/k,q=Vt(R.x,L.x,G),ie=Vt(R.y,L.y,G);if(q>=0&&q<_&&ie>=0&&ie<_&&w-g>=0&&w+g<=v){const J=new Ga(q,ie,0,U,A);s&&!iv(r,J,u,s,a)||I.push(J)}}b+=k}return f||I.length||h||(I=ov(r,b/2,i,s,a,u,h,!0,_)),I}function av(r){let e=0,i=0;for(const h of r)e+=h.w*h.h,i=Math.max(i,h.w);r.sort(((h,f)=>f.h-h.h));const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let a=0,u=0;for(const h of r)for(let f=s.length-1;f>=0;f--){const _=s[f];if(!(h.w>_.w||h.h>_.h)){if(h.x=_.x,h.y=_.y,u=Math.max(u,h.y+h.h),a=Math.max(a,h.x+h.w),h.w===_.w&&h.h===_.h){const g=s.pop();g&&f<s.length&&(s[f]=g)}else h.h===_.h?(_.x+=h.w,_.w-=h.w):h.w===_.w?(_.y+=h.h,_.h-=h.h):(s.push({x:_.x+h.w,y:_.y,w:_.w-h.w,h:h.h}),_.y+=h.h,_.h-=h.h);break}}return{w:a,h:u,fill:e/(a*u)||0}}mt(Ga,"Anchor");const Rc=1;class Hd{static getImagePositionScale(e,i,s){if(i&&e&&e.options&&e.options.transform){const a=e.options.transform;return{x:a.a,y:a.d}}return{x:s,y:s}}constructor(e,i,s,a){this.paddedRect=e;const{pixelRatio:u,version:h,stretchX:f,stretchY:_,content:g,sdf:v,usvg:b}=i;this.pixelRatio=u,this.stretchX=f,this.stretchY=_,this.content=g,this.version=h,this.padding=s,this.sdf=v,this.usvg=b,this.scale=Hd.getImagePositionScale(a,b,u)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function $_(r,e,i){const s=jo.parse(r),a=(function(u,h,f=[1,1]){return{x:0,y:0,w:(u.data?u.data.width:u.width*f[0])+2*h,h:(u.data?u.data.height:u.height*f[1])+2*h}})(e,i,[s.options.transform.a,s.options.transform.d]);return{bin:a,imagePosition:new Hd(a,e,i,s),imageVariant:s}}class lv{constructor(e,i,s){const a=new Map,u=new Map;this.haveRenderCallbacks=[];const h=[];this.addImages(e,a,Rc,h),this.addImages(i,u,2,h);const{w:f,h:_}=av(h),g=new us({width:f||1,height:_||1});for(const[v,b]of e.entries()){const w=a.get(v).paddedRect;us.copy(b.data,g,{x:0,y:0},{x:w.x+Rc,y:w.y+Rc},b.data,null,b.sdf)}for(const[v,b]of i.entries()){const w=u.get(v),I=w.paddedRect;let A=w.padding;const R=I.x+A,L=I.y+A,k=b.data.width,U=b.data.height;A=A>1?A-1:A,us.copy(b.data,g,{x:0,y:0},{x:R,y:L},b.data,s),us.copy(b.data,g,{x:0,y:U-A},{x:R,y:L-A},{width:k,height:A},s),us.copy(b.data,g,{x:0,y:0},{x:R,y:L+U},{width:k,height:A},s),us.copy(b.data,g,{x:k-A,y:0},{x:R-A,y:L},{width:A,height:U},s),us.copy(b.data,g,{x:0,y:0},{x:R+k,y:L},{width:A,height:U},s),us.copy(b.data,g,{x:k-A,y:U-A},{x:R-A,y:L-A},{width:A,height:A},s),us.copy(b.data,g,{x:0,y:U-A},{x:R+k,y:L-A},{width:A,height:A},s),us.copy(b.data,g,{x:0,y:0},{x:R+k,y:L+U},{width:A,height:A},s),us.copy(b.data,g,{x:k-A,y:0},{x:R-A,y:L+U},{width:A,height:A},s)}this.lut=s,this.image=g,this.iconPositions=a,this.patternPositions=u}addImages(e,i,s,a){for(const[u,h]of e.entries()){const{bin:f,imagePosition:_,imageVariant:g}=$_(u,h,s);i.set(u,_),a.push(f),h.hasRenderCallback&&this.haveRenderCallbacks.push(g.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((a=>e.hasImage(a,s))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(const a of e.getUpdatedImages(s)){for(const u of this.iconPositions.keys()){const h=jo.parse(u);if(An.isEqual(h.id,a)){const f=e.getImage(a,s);this.patchUpdatedImage(this.iconPositions.get(u),f,i,null)}}for(const u of this.patternPositions.keys()){const h=jo.parse(u);if(An.isEqual(h.id,a)){const f=e.getImage(a,s);this.patchUpdatedImage(this.patternPositions.get(u),f,i,this.lut)}}}}patchUpdatedImage(e,i,s,a=null){if(!e||!i||e.version===i.version)return;e.version=i.version;const[u,h]=e.tl,f=e.sdf;if(this.lut||f){const _={width:i.data.width,height:i.data.height},g=new us(_);us.copy(i.data,g,{x:0,y:0},{x:0,y:0},_,a,f),s.update(g,{position:{x:u,y:h}})}else s.update(i.data,{position:{x:u,y:h}})}}mt(Hd,"ImagePosition"),mt(lv,"ImageAtlas");const qd=1e20;function cv(r,e,i,s,a,u,h,f,_){for(let g=e;g<e+s;g++)uv(r,i*u+g,u,a,h,f,_);for(let g=i;g<i+a;g++)uv(r,g*u+e,1,s,h,f,_)}function uv(r,e,i,s,a,u,h){u[0]=0,h[0]=-qd,h[1]=qd,a[0]=r[e];for(let f=1,_=0,g=0;f<s;f++){a[f]=r[e+f*i];const v=f*f;do{const b=u[_];g=(a[f]-a[b]+v-b*b)/(f-b)/2}while(g<=h[_]&&--_>-1);_++,u[_]=f,h[_]=g,h[_+1]=qd}for(let f=0,_=0;f<s;f++){for(;h[_+1]<f;)_++;const g=u[_],v=f-g;r[e+f*i]=a[g]+v*v}}const ea=2,Z_={none:0,ideographs:1,all:2};class Wu{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const s=[],a=this.url||er.GLYPHS_URL;for(const u in e)for(const h of e[u])s.push({stack:u,id:h});oe(s,(({stack:u,id:h},f)=>{let _=this.entries[u];_||(_=this.entries[u]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let g=_.glyphs[h];if(g!==void 0)return void f(null,{stack:u,id:h,glyph:g});if(g=this._tinySDF(_,u,h),g)return _.glyphs[h]=g,void f(null,{stack:u,id:h,glyph:g});const v=Math.floor(h/256);if(256*v>65535)return Mt("glyphs > 65535 not supported"),void f(null,{stack:u,id:h,glyph:g});if(_.ranges[v])return void f(null,{stack:u,id:h,glyph:g});let b=_.requests[v];b||(b=_.requests[v]=[],Wu.loadGlyphRange(u,v,a,this.requestManager,((w,I)=>{if(I){_.ascender=I.ascender,_.descender=I.descender;for(const A in I.glyphs)this._doesCharSupportLocalGlyph(+A)||(_.glyphs[+A]=I.glyphs[+A]);_.ranges[v]=!0}for(const A of b)A(w,I);delete _.requests[v]}))),b.push(((w,I)=>{w?f(w):I&&f(null,{stack:u,id:h,glyph:I.glyphs[h]||null})}))}),((u,h)=>{if(u)i(u);else if(h){const f={};for(const{stack:_,id:g,glyph:v}of h)f[_]===void 0&&(f[_]={}),f[_].glyphs===void 0&&(f[_].glyphs={}),f[_].glyphs[g]=v&&{id:v.id,bitmap:v.bitmap.clone(),metrics:v.metrics},f[_].ascender=this.entries[_].ascender,f[_].descender=this.entries[_].descender;i(null,f)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Z_.none&&(this.localGlyphMode===Z_.all?!!this.localFontFamily:!!this.localFontFamily&&(Dt["CJK Unified Ideographs"](e)||Dt["Hangul Syllables"](e)||Dt.Hiragana(e)||Dt.Katakana(e)||Dt["CJK Symbols and Punctuation"](e)||Dt["CJK Unified Ideographs Extension A"](e)||Dt["CJK Unified Ideographs Extension B"](e)||Dt.Osage(e)))}_tinySDF(e,i,s){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(s))return;let u=e.tinySDF;if(!u){let R="400";/bold/i.test(i)?R="900":/medium/i.test(i)?R="500":/light/i.test(i)&&(R="200"),u=e.tinySDF=new Wu.TinySDF({fontFamily:a,fontWeight:R,fontSize:24*ea,buffer:3*ea,radius:8*ea}),u.fontWeight=R}if(this.localGlyphs[u.fontWeight][s])return this.localGlyphs[u.fontWeight][s];const h=String.fromCodePoint(s),{data:f,width:_,height:g,glyphWidth:v,glyphHeight:b,glyphLeft:w,glyphTop:I,glyphAdvance:A}=u.draw(h);return this.localGlyphs[u.fontWeight][s]={id:s,bitmap:new Rl({width:_,height:g},f),metrics:{width:v/ea,height:b/ea,left:w/ea,top:I/ea-27,advance:A/ea,localGlyph:!0}}}}Wu.loadGlyphRange=function(r,e,i,s,a){const u=256*e,h=u+255,f=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}","".concat(u,"-").concat(h)),Ta.Glyphs);Za(f,((_,g)=>{if(_)a(_);else if(g){const v={},b=(function(w){return new Bp(w).readFields(Rw,{})})(g);for(const w of b.glyphs)v[w.id]=w;a(null,{glyphs:v,ascender:b.ascender,descender:b.descender})}}))},Wu.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:u="normal",fontStyle:h="normal",lang:f=null}={}){this.buffer=e,this.cutoff=s,this.radius=i,this.lang=f;const _=this.size=r+4*e,g=this._createCanvas(_),v=this.ctx=g.getContext("2d",{willReadFrequently:!0});v.font="".concat(h," ").concat(u," ").concat(r,"px ").concat(a),v.textBaseline="alphabetic",v.textAlign="left",v.fillStyle="black",this.gridOuter=new Float64Array(_*_),this.gridInner=new Float64Array(_*_),this.f=new Float64Array(_),this.z=new Float64Array(_+1),this.v=new Uint16Array(_)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:u}=this.ctx.measureText(r),h=Math.ceil(i),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-a))),_=Math.min(this.size-this.buffer,h+Math.ceil(s)),g=f+2*this.buffer,v=_+2*this.buffer,b=Math.max(g*v,0),w=new Uint8ClampedArray(b),I={data:w,width:g,height:v,glyphWidth:f,glyphHeight:_,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(f===0||_===0)return I;const{ctx:A,buffer:R,gridInner:L,gridOuter:k}=this;this.lang&&(A.lang=this.lang),A.clearRect(R,R,f,_),A.fillText(r,R,R+h);const U=A.getImageData(R,R,f,_);k.fill(qd,0,b),L.fill(0,0,b);for(let G=0;G<_;G++)for(let q=0;q<f;q++){const ie=U.data[4*(G*f+q)+3]/255;if(ie===0)continue;const J=(G+R)*g+q+R;if(ie===1)k[J]=0,L[J]=qd;else{const se=.5-ie;k[J]=se>0?se*se:0,L[J]=se<0?se*se:0}}cv(k,0,0,g,v,g,this.f,this.v,this.z),cv(L,R,R,f,_,g,this.f,this.v,this.z);for(let G=0;G<b;G++){const q=Math.sqrt(k[G])-Math.sqrt(L[G]);w[G]=Math.round(255-255*(q/this.radius+this.cutoff))}return I}};const ya=Rc;function hv(r,e){return r+e[1]-e[0]}function W_(r,e,i,s,a=1){const u=[],h=r.imagePrimary,f=h.pixelRatio,_=h.paddedRect.w-2*ya,g=h.paddedRect.h-2*ya,v=(r.right-r.left)*a,b=(r.bottom-r.top)*a,w=h.stretchX||[[0,_]],I=h.stretchY||[[0,g]],A=w.reduce(hv,0),R=I.reduce(hv,0),L=_-A,k=g-R;let U=0,G=A,q=0,ie=R,J=0,se=L,le=0,he=k;if(h.content&&s){const ye=h.content;U=Up(w,0,ye[0]),q=Up(I,0,ye[1]),G=Up(w,ye[0],ye[2]),ie=Up(I,ye[1],ye[3]),J=ye[0]-U,le=ye[1]-q,se=ye[2]-ye[0]-G,he=ye[3]-ye[1]-ie}const Ce=(ye,Pe,ke,Ve)=>{const Qe=jp(ye.stretch-U,G,v,r.left*a),qe=Gp(ye.fixed-J,se,ye.stretch,A),Fe=jp(Pe.stretch-q,ie,b,r.top*a),He=Gp(Pe.fixed-le,he,Pe.stretch,R),Ae=jp(ke.stretch-U,G,v,r.left*a),Ee=Gp(ke.fixed-J,se,ke.stretch,A),Ge=jp(Ve.stretch-q,ie,b,r.top*a),Ye=Gp(Ve.fixed-le,he,Ve.stretch,R),Ne=new Be(Qe,Fe),pt=new Be(Ae,Fe),yt=new Be(Ae,Ge),ht=new Be(Qe,Ge),st=new Be(qe/f,He/f),$t=new Be(Ee/f,Ye/f),at=e*Math.PI/180;if(at){const zi=Math.sin(at),Li=Math.cos(at),kr=[Li,-zi,zi,Li];Ne._matMult(kr),pt._matMult(kr),ht._matMult(kr),yt._matMult(kr)}const Ct=ye.stretch+ye.fixed,Wt=ke.stretch+ke.fixed,oi=Pe.stretch+Pe.fixed,Si=Ve.stretch+Ve.fixed,Yt=r.imageSecondary;return{tl:Ne,tr:pt,bl:ht,br:yt,texPrimary:{x:h.paddedRect.x+ya+Ct,y:h.paddedRect.y+ya+oi,w:Wt-Ct,h:Si-oi},texSecondary:Yt?{x:Yt.paddedRect.x+ya+Ct,y:Yt.paddedRect.y+ya+oi,w:Wt-Ct,h:Si-oi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:st,pixelOffsetBR:$t,minFontScaleX:se/f/v,minFontScaleY:he/f/b,isSDF:i}};if(s&&(h.stretchX||h.stretchY)){const ye=dv(w,L,A),Pe=dv(I,k,R);for(let ke=0;ke<ye.length-1;ke++){const Ve=ye[ke],Qe=ye[ke+1];for(let qe=0;qe<Pe.length-1;qe++)u.push(Ce(Ve,Pe[qe],Qe,Pe[qe+1]))}}else u.push(Ce({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:_+1},{fixed:0,stretch:g+1}));return u}function Bw(r,e){const i=r.stretchY||[[0,r.paddedRect.h-2*ya]];return e&&(r.stretchX||r.stretchY)?fv(r.stretchX||[[0,r.paddedRect.w-2*ya]])*fv(i):1}function Up(r,e,i){let s=0;for(const a of r)s+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return s}function dv(r,e,i){const s=[{fixed:-ya,stretch:0}];for(const[a,u]of r){const h=s[s.length-1];s.push({fixed:a-h.stretch,stretch:h.stretch}),s.push({fixed:a-h.stretch,stretch:h.stretch+(u-a)})}return s.push({fixed:e+ya,stretch:i}),s}function fv(r){return 2*r.length+1}function jp(r,e,i,s){return r/e*i+s}function Gp(r,e,i,s){return r-e*i/s}function Nw(r,e,i,s){const a=e+r.positionedLines[s].lineOffset;return s===0?i+a/2:i+(a+(e+r.positionedLines[s-1].lineOffset))/2}function Vw(r,e=1,i=!1){let s=1/0,a=1/0,u=-1/0,h=-1/0;const f=r[0];for(let I=0;I<f.length;I++){const A=f[I];(!I||A.x<s)&&(s=A.x),(!I||A.y<a)&&(a=A.y),(!I||A.x>u)&&(u=A.x),(!I||A.y>h)&&(h=A.y)}const _=Math.min(u-s,h-a);let g=_/2;const v=new Hc([],Uw);if(_===0)return new Be(s,a);for(let I=s;I<u;I+=_)for(let A=a;A<h;A+=_)v.push(new Xu(I+g,A+g,g,r));let b=(function(I){let A=0,R=0,L=0;const k=I[0];for(let U=0,G=k.length,q=G-1;U<G;q=U++){const ie=k[U],J=k[q],se=ie.x*J.y-J.x*ie.y;R+=(ie.x+J.x)*se,L+=(ie.y+J.y)*se,A+=3*se}return new Xu(R/A,L/A,0,I)})(r),w=v.length;for(;v.length;){const I=v.pop();(I.d>b.d||!b.d)&&(b=I,i&&console.log("found best %d after %d probes",Math.round(1e4*I.d)/1e4,w)),I.max-b.d<=e||(g=I.h/2,v.push(new Xu(I.p.x-g,I.p.y-g,g,r)),v.push(new Xu(I.p.x+g,I.p.y-g,g,r)),v.push(new Xu(I.p.x-g,I.p.y+g,g,r)),v.push(new Xu(I.p.x+g,I.p.y+g,g,r)),w+=4)}return i&&(console.log("num probes: ".concat(w)),console.log("best distance: ".concat(b.d))),b.p}function Uw(r,e){return e.max-r.max}class Xu{constructor(e,i,s,a){this.p=new Be(e,i),this.h=s,this.d=(function(u,h){let f=!1,_=1/0;for(let g=0;g<h.length;g++){const v=h[g];for(let b=0,w=v.length,I=w-1;b<w;I=b++){const A=v[b],R=v[I];A.y>u.y!=R.y>u.y&&u.x<(R.x-A.x)*(u.y-A.y)/(R.y-A.y)+A.x&&(f=!f),_=Math.min(_,Js(u,A,R))}}return(f?1:-1)*Math.sqrt(_)})(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const jw=Object.keys,X_=Number.POSITIVE_INFINITY,Gw=Math.sqrt(2);function Hp(r,e,i,s){const a=r.collisionPadding||[0,0,0,0],u={top:r.top-a[1],bottom:r.bottom+a[3],left:r.left-a[0],right:r.right+a[2],scaled:!1};return s!==void 0&&(function(h,f){h.top*=f,h.bottom*=f,h.left*=f,h.right*=f,h.scaled=!0})(u,s),i&&(function(h,f){if(!f)return;const _=Qt(f),g=new Be(h.left,h.top),v=new Be(h.right,h.top),b=new Be(h.left,h.bottom),w=new Be(h.right,h.bottom);g._rotateAround(_,new Be(0,0)),v._rotateAround(_,new Be(0,0)),b._rotateAround(_,new Be(0,0)),w._rotateAround(_,new Be(0,0)),h.left=Math.min(g.x,v.x,b.x,w.x),h.right=Math.max(g.x,v.x,b.x,w.x),h.top=Math.min(g.y,v.y,b.y,w.y),h.bottom=Math.max(g.y,v.y,b.y,w.y)})(u,i),e?{top:Math.min(e.top,u.top),bottom:Math.max(e.bottom,u.bottom),left:Math.min(e.left,u.left),right:Math.max(e.right,u.right),scaled:e.scaled||u.scaled}:u}function pv(r,[e,i]){let s=0,a=0;if(i===X_){e<0&&(e=0);const u=e/Gw;switch(r){case"top-right":case"top-left":a=u-7;break;case"bottom-right":case"bottom-left":a=7-u;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":s=-u;break;case"top-left":case"bottom-left":s=u;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,a]}function Hw(r,e,i,s,a,u,h,f,_,g,v){const b=r.layers[0],w=b.appearances;if(w.length===0)return{iconBBox:null,iconVerticalBBox:null};let I=null,A=null;const R=s.get("icon-rotate").evaluate(a,{},u);e&&(I=Hp(e,I,R,h),i)&&(A=Hp(i,A,R+90,h));const[L,k]=s.get("icon-size-scale-range"),U=B(1,L,k);for(const G of w){const q=G.getUnevaluatedProperties(),ie=q._values["icon-image"].value!==void 0,J=q._values["icon-size"].value!==void 0,se=q._values["icon-offset"].value!==void 0,le=q._values["icon-rotate"].value!==void 0;if(ie||J||se||le){const he=se?b.getAppearanceValueAndResolveTokens(G,"icon-offset",a,u,[]):null,Ce=he&&Array.isArray(he)?he:f,ye=le?b.getAppearanceValueAndResolveTokens(G,"icon-rotate",a,u,[]):null,Pe=typeof ye=="number"?ye:R,ke=J?b.getAppearanceValueAndResolveTokens(G,"icon-size",a,u,[]):null,Ve=typeof ke=="number"?ke*_.iconScaleFactor:h;let Qe=null,qe=null,Fe=null;if(ie){const He=b.getAppearanceValueAndResolveTokens(G,"icon-image",a,u,[]);if(He){const Ae=r.getResolvedImageFromTokens(He),Ee=q._values["icon-size"],Ge=$d(Ae,$u(r.zoom,Ee,r.worldview),Ee,u,r.zoom,a,r.pixelRatio,U,r.worldview);Fe=g.get(Ge.iconPrimary.toString())}}else e&&(Fe=e.imagePrimary);Fe&&(Qe=Vp(Fe,null,Ce,v),r.allowVerticalPlacement&&(qe=Vp(Fe,null,Ce,v))),Qe&&(I=Hp(Qe,I,Pe,Ve)),qe&&(A=Hp(qe,A,Pe+90,Ve))}}return{iconBBox:I,iconVerticalBBox:A}}function qp(r,e,i,s,a,u,h,f,_){if(!e||!e.usvg)return;const g=tv(s),v=tv(a),b=u!=="both"&&u!=="width"||!Qx(s)?1:v.width/g.width,w=u!=="both"&&u!=="height"||!ev(s)?1:v.height/g.height;i.scaleSelf(b,w);const I=i.toString();h.set(I,i),f.set(I,e);const{imagePosition:A}=$_(I,e,Rc);_.set(I,A)}function mv(r,e,i,s,a,u,h,f,_){if(!r)return;const g=(function(v,b,w,I,A,R){if(v.kind==="camera")return v.maxSize;if(v.kind==="composite"){const L=b.possiblyEvaluate(new yr(v.maxZoom,{worldview:R}),w).evaluate(A,{},w),k=b.possiblyEvaluate(new yr(v.minZoom,{worldview:R}),w).evaluate(A,{},w);return Math.max(L,k)}return b.possiblyEvaluate(new yr(I,{worldview:R})).evaluate(A,{},w)})(e,i,s,a,u,_);return r.scaleSelf(g*f*h)}function $d(r,e,i,s,a,u,h,f,_){return{iconPrimary:mv(r.getPrimary(),e,i,s,a,u,h,f,_),iconSecondary:mv(r.getSecondary(),e,i,s,a,u,h,f,_)}}function qw(r,e,i){if(!e)return;const s=i.get(r.toString()),a=i.get(e.toString());s&&a&&(s.paddedRect.w===a.paddedRect.w&&s.paddedRect.h===a.paddedRect.h||Mt("Mismatch in icon variant sizes: ".concat(r.toString()," and ").concat(e.toString())),s.usvg!==a.usvg&&Mt("Mismatch in icon variant image types: ".concat(r.id," and ").concat(e.id)))}function _v(r,e,i,s){if(!r)return;const a=e.get(i.toString());if(r.imagePrimary=a,s){const u=e.get(s.toString());r.imageSecondary=u}}function $w(r,e){for(const i in r.horizontal)gv(r.horizontal[i],e);gv(r.vertical,e)}function gv(r,e){if(r){for(const i of r.positionedLines)for(const s of i.positionedGlyphs)if(s.image!==null){const a=s.image.toString();s.rect=e.get(a).paddedRect}}}function Y_(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Zw(r,e,i,s,a,u,h,f,_){const g=K_(u.horizontal)||u.vertical,v=i.get("icon-text-fit-padding").evaluate(s,{},a);let b,w=e;return e&&_!=="none"&&(r.allowVerticalPlacement&&u.vertical&&(b=H_(e,u.vertical,_,v,f,h)),g&&(w=H_(e,g,_,v,f,h))),{defaultShapedIcon:w,verticallyShapedIcon:b}}function Ww(r,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U,G,q,ie){let J=h.textMaxSize.evaluate(e,{},w);J===void 0?J=f*h.textScaleFactor:J*=h.textScaleFactor;const se=r.layers[0].layout,le=Zn,he=f*h.textScaleFactor/le,Ce=K_(i.horizontal)||i.vertical;if(L!=="none"&&r.appearanceFeatureData&&e.index<r.appearanceFeatureData.length){const Ne=r.appearanceFeatureData[e.index];Ne&&(Ne.textShaping=Ce,Ne.iconTextFitPadding=se.get("icon-text-fit-padding").evaluate(e,{},w),Ne.fontScale=he)}const ye=I.name==="globe",Pe=r.tilePixelRatio*J/le,ke=(Ae=r.overscaling,r.zoom>18&&Ae>2&&(Ae>>=1),Math.max(it/(512*Ae),1)*se.get("symbol-spacing")),Ve=se.get("text-padding")*r.tilePixelRatio,Qe=se.get("icon-padding")*r.tilePixelRatio,qe=Qt(se.get("text-max-angle")),Fe=se.get("icon-rotation-alignment")==="map"&&G!=="point",He=ke/2;var Ae;r.hasAnyIconTextFit===!1&&L!=="none"&&(r.hasAnyIconTextFit=!0);const Ee=e.properties?+e.properties[ut]:null,Ge=Ee&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Ee):65535,Ye=(Ne,pt,yt)=>{if(pt.x<0||pt.x>=it||pt.y<0||pt.y>=it)return;let ht=null;if(ye){const{x:st,y:$t,z:at}=I.projectTilePoint(pt.x,pt.y,yt);ht={anchor:new Ga(st,$t,at,0,void 0),up:I.upVector(yt,pt.x,pt.y)}}(function(st,$t,at,Ct,Wt,oi,Si,Yt,zi,Li,kr,Q,Y,Re,nt,De,ot,Et,St,Kt,kt,bt,Ri,rr,Nt,wi,nr,Hi,qr,Ar,_r){const Ji=st.addToLineVertexArray($t,Ct);let Oi,Jt,ki,gr,Ft,Ei,Mr,Kr=0,ln=0,Sn=0,Cr=0,mn=-1,Us=-1;const _n={};let no=$l("");const hs=at?at.anchor:$t,Io=Hi!=="none";let js=0,so=0;if(zi._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Wn=zi.layout.get("text-offset").evaluate(kt,{},Nt);js=Wn[0]*Zn,so=Wn[1]*Zn}else js=zi.layout.get("text-radial-offset").evaluate(kt,{},Nt)*Zn,so=X_;if(st.allowVerticalPlacement&&Wt.vertical){const Wn=Wt.vertical;if(nt)Ei=J_(Wn),Yt&&(Mr=J_(Yt));else{const Ts=zi.layout.get("text-rotate").evaluate(kt,{},Nt)+90;ki=$p(Li,hs,$t,kr,Q,Y,Wn,Re,Ts,De),Yt&&(gr=$p(Li,hs,$t,kr,Q,Y,Yt,Et,Ts,null,_r))}}if(oi){const Wn=st.iconSizeData,Ts=zi.layout.get("icon-rotate").evaluate(kt,{},Nt),xa=W_(oi,Ts,Ri,Io,bt.iconScaleFactor),kl=Yt?W_(Yt,Ts,Ri,Io,bt.iconScaleFactor):void 0;Jt=$p(Li,hs,$t,kr,Q,Y,oi,Et,Ts,null,Ar);const ih=(function(va,cm,rh,a2,k0,F0,l2,c2){const B0=va.layers[0],N0=B0.appearances;let nh=cm.length;if(rh&&(nh=Math.max(nh,rh.length)),N0.length===0)return nh;const[u2,h2]=a2.get("icon-size-scale-range"),d2=B(1,u2,h2);for(const V0 of N0){const U0=V0.getUnevaluatedProperties();if(U0._values["icon-image"].value!==void 0){const j0=B0.getAppearanceValueAndResolveTokens(V0,"icon-image",k0,F0,[]);if(j0){const G0=va.getResolvedImageFromTokens(j0);if(G0){const H0=U0._values["icon-size"],f2=$d(G0,$u(va.zoom,H0,va.worldview),H0,F0,va.zoom,k0,va.pixelRatio,d2,va.worldview),p2=l2.get(f2.iconPrimary.toString());nh=Math.max(nh,Bw(p2,c2))}}}}return nh})(st,xa,kl,zi.layout,kt,Nt,st.iconAtlasPositions,Io);Kr=4*ih;let Fl=null;Wn.kind==="source"?(Fl=[Qo*zi.layout.get("icon-size").evaluate(kt,{},Nt)*bt.iconScaleFactor],Fl[0]>Ha&&Mt("".concat(st.layerIds[0],': Value for "icon-size" is >= ').concat(Zd,'. Reduce your "icon-size".'))):Wn.kind==="composite"&&(Fl=[Qo*bt.compositeIconSizes[0].evaluate(kt,{},Nt)*bt.iconScaleFactor,Qo*bt.compositeIconSizes[1].evaluate(kt,{},Nt)*bt.iconScaleFactor],(Fl[0]>Ha||Fl[1]>Ha)&&Mt("".concat(st.layerIds[0],': Value for "icon-size" is >= ').concat(Zd,'. Reduce your "icon-size".'))),st.addSymbols(st.icon,xa,Fl,Kt,St,kt,void 0,at,$t,Ji.lineStartIndex,Ji.lineLength,-1,rr,Nt,wi,nr,st.symbolInstances.length,ih),mn=st.icon.placedSymbolArray.length-1,kl&&(ln=4*ih,st.addSymbols(st.icon,kl,Fl,Kt,St,kt,ro.vertical,at,$t,Ji.lineStartIndex,Ji.lineLength,-1,rr,Nt,wi,nr,st.symbolInstances.length,ih),Us=st.icon.placedSymbolArray.length-1)}for(const Wn in Wt.horizontal){const Ts=Wn,xa=Wt.horizontal[Ts];Oi||(no=$l(xa.text),nt?Ft=J_(xa):Oi=$p(Li,hs,$t,kr,Q,Y,xa,Re,zi.layout.get("text-rotate").evaluate(kt,{},Nt),De));const kl=xa.positionedLines.length===1;if(Sn+=yv(st,at,$t,xa,Si,zi,nt,kt,De,Ji,Wt.vertical?ro.horizontal:ro.horizontalOnly,kl?jw(Wt.horizontal):[Ts],_n,mn,bt,rr,Nt,st.symbolInstances.length,wi),kl)break}Wt.vertical&&(Cr+=yv(st,at,$t,Wt.vertical,Si,zi,nt,kt,De,Ji,ro.vertical,["vertical"],_n,Us,bt,rr,Nt,st.symbolInstances.length,wi));let ds=-1;const oo=(Wn,Ts)=>Wn?Math.max(Wn,Ts):Ts;ds=oo(Ft,ds),ds=oo(Ei,ds),ds=oo(Mr,ds);const Ao=ds>-1?1:0;st.glyphOffsetArray.length>=65535&&Mt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),kt.sortKey!==void 0&&st.addToSortKeyRanges(st.symbolInstances.length,kt.sortKey),st.symbolInstances.emplaceBack($t.x,$t.y,hs.x,hs.y,hs.z,_n.right>=0?_n.right:-1,_n.center>=0?_n.center:-1,_n.left>=0?_n.left:-1,_n.vertical>=0?_n.vertical:-1,mn,Us,no,Oi!==void 0?Oi:st.collisionBoxArray.length,Oi!==void 0?Oi+1:st.collisionBoxArray.length,ki!==void 0?ki:st.collisionBoxArray.length,ki!==void 0?ki+1:st.collisionBoxArray.length,Jt!==void 0?Jt:st.collisionBoxArray.length,Jt!==void 0?Jt+1:st.collisionBoxArray.length,gr||st.collisionBoxArray.length,gr?gr+1:st.collisionBoxArray.length,kr,Sn,Cr,Kr,ln,Ao,0,js,so,ds,0,Io?1:0,qr)})(r,pt,ht,Ne,i,s,u,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,Ve,U,g,0,Qe,Fe,k,e,h,v,b,w,A,R,L,Ge,q,ie)};if(G==="line")for(const Ne of Ap(e.geometry,0,0,it,it)){const pt=Fw(Ne,ke,qe,i.vertical||Ce,s,le,Pe,r.overscaling,it);for(const yt of pt)Ce&&Xw(r,Ce.text,He,yt)||Ye(Ne,yt,w)}else if(G==="line-center"){for(const Ne of e.geometry)if(Ne.length>1){const pt=kw(Ne,qe,i.vertical||Ce,s,le,Pe);pt&&Ye(Ne,pt,w)}}else if(e.type==="Polygon")for(const Ne of Cd(e.geometry,0)){const pt=Vw(Ne,16);Ye(Ne[0],new Ga(pt.x,pt.y,0,0,void 0),w)}else if(e.type==="LineString")for(const Ne of e.geometry)Ye(Ne,new Ga(Ne[0].x,Ne[0].y,0,0,void 0),w);else if(e.type==="Point")for(const Ne of e.geometry)for(const pt of Ne)Ye([pt],new Ga(pt.x,pt.y,0,0,void 0),w)}const Zd=255,Ha=Zd*Qo;function yv(r,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U){const G=(function(J,se,le,he,Ce,ye,Pe,ke){const Ve=[];if(se.positionedLines.length===0)return Ve;const Qe=he.layout.get("text-rotate").evaluate(ye,{})*Math.PI/180,qe=(function(Ge){const Ye=Ge[0],Ne=Ge[1],pt=Ye*Ne;return pt>0?[Ye,-Ne]:pt<0?[-Ye,Ne]:Ye===0?[Ne,Ye]:[Ne,-Ye]})(le);let Fe=Math.abs(se.top-se.bottom);for(const Ge of se.positionedLines)Fe-=Ge.lineOffset;const He=se.positionedLines.length,Ae=Fe/He;let Ee=se.top-le[1];for(let Ge=0;Ge<He;++Ge){const Ye=se.positionedLines[Ge];Ee=Nw(se,Ae,Ee,Ge);for(const Ne of Ye.positionedGlyphs){if(!Ne.rect)continue;const pt=Ne.rect||{};let yt=$x+1,ht=!0,st=1,$t=0;if(Ne.image){const St=Pe.get(Ne.image.toString());if(!St)continue;if(St.sdf){Mt("SDF images are not supported in formatted text and will be ignored.");continue}ht=!1,st=St.pixelRatio,yt=Rc/st}const at=(Ce||ke)&&Ne.vertical,Ct=Ne.metrics.advance*Ne.scale/2,Wt=Ne.metrics,oi=Ne.rect;if(oi===null)continue;ke&&se.verticalizable&&($t=Ne.image?Ct-Ne.metrics.width*Ne.scale/2:0);const Si=Ce?[Ne.x+Ct,Ne.y]:[0,0];let Yt=[0,0],zi=[0,0],Li=!1;Ce||(at?(zi=[Ne.x+Ct+qe[0],Ne.y+qe[1]-$t],Li=!0):Yt=[Ne.x+Ct+le[0],Ne.y+le[1]-$t]);const kr=oi.w*Ne.scale/(st*(Ne.localGlyph?ea:1)),Q=oi.h*Ne.scale/(st*(Ne.localGlyph?ea:1));let Y,Re,nt,De;if(at){const St=Ne.y-Ee,Kt=new Be(-Ct,Ct-St),kt=-Math.PI/2,bt=new Be(...zi);Y=new Be(-Ct+Yt[0],Yt[1]),Y._rotateAround(kt,Kt)._add(bt),Y.x+=-St+Ct,Y.y-=(Wt.left-yt)*Ne.scale;const Ri=Ne.image?Wt.advance*Ne.scale:Zn*Ne.scale,rr=String.fromCodePoint(Ne.glyph);vw(rr)?Y.x+=(1-yt)*Ne.scale:bw(rr)?Y.x+=Ri-Wt.height*Ne.scale+(-yt-1)*Ne.scale:Y.x+=Ne.image||Wt.width+2*yt===oi.w&&Wt.height+2*yt===oi.h?(Ri-Q)/2:(Ri-(Wt.height+2*yt)*Ne.scale)/2,Re=new Be(Y.x,Y.y-kr),nt=new Be(Y.x+Q,Y.y),De=new Be(Y.x+Q,Y.y-kr)}else{const St=(Wt.left-yt)*Ne.scale-Ct+Yt[0],Kt=(-Wt.top-yt)*Ne.scale+Yt[1],kt=St+kr,bt=Kt+Q;Y=new Be(St,Kt),Re=new Be(kt,Kt),nt=new Be(St,bt),De=new Be(kt,bt)}if(Qe){let St;St=Ce?new Be(0,0):Li?new Be(qe[0],qe[1]):new Be(le[0],le[1]),Y._rotateAround(Qe,St),Re._rotateAround(Qe,St),nt._rotateAround(Qe,St),De._rotateAround(Qe,St)}const ot=new Be(0,0),Et=new Be(0,0);Ve.push({tl:Y,tr:Re,bl:nt,br:De,texPrimary:pt,texSecondary:void 0,writingMode:se.writingMode,glyphOffset:Si,sectionIndex:Ne.sectionIndex,isSDF:ht,pixelOffsetTL:ot,pixelOffsetBR:Et,minFontScaleX:0,minFontScaleY:0})}}return Ve})(0,s,_,u,h,f,a,r.allowVerticalPlacement),q=r.textSizeData;let ie=null;q.kind==="source"?(ie=[Qo*u.layout.get("text-size").evaluate(f,{},L)*A.textScaleFactor],ie[0]>Ha&&Mt("".concat(r.layerIds[0],': Value for "text-size" is >= ').concat(Zd,'. Reduce your "text-size".'))):q.kind==="composite"&&(ie=[Qo*A.compositeTextSizes[0].evaluate(f,{},L)*A.textScaleFactor,Qo*A.compositeTextSizes[1].evaluate(f,{},L)*A.textScaleFactor],(ie[0]>Ha||ie[1]>Ha)&&Mt("".concat(r.layerIds[0],': Value for "text-size" is >= ').concat(Zd,'. Reduce your "text-size".'))),r.addSymbols(r.text,G,ie,_,h,f,v,e,i,g.lineStartIndex,g.lineLength,I,R,L,U,!1,k,G.length);for(const J of b)w[J]=r.text.placedSymbolArray.length-1;return 4*G.length}function K_(r){for(const e in r)return r[e];return null}function $p(r,e,i,s,a,u,h,f,_,g,v){let b,w,I,A;if(b=v?v.top:h.top,w=v?v.bottom:h.bottom,I=v?v.left:h.left,A=v?v.right:h.right,Jx(h)&&h.collisionPadding){const R=h.collisionPadding;I-=R[0],b-=R[1],A+=R[2],w+=R[3]}if(_){const R=new Be(I,b),L=new Be(A,b),k=new Be(I,w),U=new Be(A,w),G=Qt(_);let q=new Be(0,0);g&&(q=new Be(g[0],g[1])),R._rotateAround(G,q),L._rotateAround(G,q),k._rotateAround(G,q),U._rotateAround(G,q),I=Math.min(R.x,L.x,k.x,U.x),A=Math.max(R.x,L.x,k.x,U.x),b=Math.min(R.y,L.y,k.y,U.y),w=Math.max(R.y,L.y,k.y,U.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,I,b,A,w,f,s,a,u),r.length-1}function J_(r){Jx(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function Xw(r,e,i,s){const a=r.compareText;if(e in a){const u=a[e];for(let h=u.length-1;h>=0;h--)if(s.dist(u[h])<i)return!0}else a[e]=[];return a[e].push(s),!1}function xv(r,e){const i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),u=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let h=Math.sin(r._pitch)*u+a;const f=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let _=Math.max(r.zoom-17,0);r.isOrthographic&&(_/=10),h*=1+_}return Math.min(1.01*h,f)}function Wd(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),s=r.x*i,a=(r.x+1)*i,u=r.y*i,h=(r.y+1)*i,f=Z(s),_=Z(a),g=H(u),v=H(h),b=e.project(f,g),w=e.project(_,g),I=e.project(_,v),A=e.project(f,v);let R=Math.min(b.x,w.x,I.x,A.x),L=Math.min(b.y,w.y,I.y,A.y),k=Math.max(b.x,w.x,I.x,A.x),U=Math.max(b.y,w.y,I.y,A.y);const G=i/16;function q(J,se,le,he,Ce,ye){const Pe=(le+Ce)/2,ke=(he+ye)/2,Ve=e.project(Z(Pe),H(ke)),Qe=Math.max(0,R-Ve.x,L-Ve.y,Ve.x-k,Ve.y-U);R=Math.min(R,Ve.x),k=Math.max(k,Ve.x),L=Math.min(L,Ve.y),U=Math.max(U,Ve.y),Qe>G&&(q(J,Ve,le,he,Pe,ke),q(Ve,se,Pe,ke,Ce,ye))}q(b,w,s,u,a,u),q(w,I,a,u,a,h),q(I,A,a,h,s,h),q(A,b,s,h,s,u),R-=G,L-=G,k+=G,U+=G;const ie=1/Math.max(k-R,U-L);return{scale:ie,x:R*ie,y:L*ie,x2:k*ie,y2:U*ie,projection:e}}function vv(r,{x:e,y:i},s=0){return new Be(((e-s)*r.scale-r.x)*it,(i*r.scale-r.y)*it)}const Yw=Ot(new Float32Array(16));class Ll{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new M(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s,a=!0){return e._coordinatePoint(e.locationCoordinate(i,s),a)}pixelsPerMeter(e,i){return j(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return xv(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,a){const u=e.horizonLineFromTop(!1),h=new Be(i,Math.max(u,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,a))}pointCoordinate3D(e,i,s){const a=new Be(i,s);if(e.elevation)return e.elevation.pointCoordinate(a);{const u=this.pointCoordinate(e,a.x,a.y,0);return[u.x,u.y,u.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return Yw}createTileMatrix(e,i,s){let a,u,h;const f=s.canonical,_=Ot(new Float64Array(16));if(this.isReprojectedInTileSpace){const g=Wd(f,this);a=1,u=g.x+s.wrap*g.scale,h=g.y,hi(_,_,[a/g.scale,a/g.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(f.z),u=(f.x+Math.pow(2,f.z)*s.wrap)*a,h=f.y*a;return gi(_,_,[u,h,0]),hi(_,_,[a/it,a/it,1]),_}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class Kw extends Ll{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,s]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(Qt(i));this.n=(a+Math.sin(Qt(s)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:s,c:a,r0:u}=this,h=Qt(e-this.center[0]),f=Qt(i),_=Math.sqrt(a-2*s*Math.sin(f))/s;return{x:_*Math.sin(h*s),y:_*Math.cos(h*s)-u,z:0}}unproject(e,i){const{n:s,c:a,r0:u}=this,h=u+i;let f=Math.atan2(e,Math.abs(h))*Math.sign(h);h*s<0&&(f-=Math.PI*Math.sign(e)*Math.sign(h));const _=Qt(this.center[0])*s;f=ae(f,-Math.PI-_,Math.PI-_);const g=B(Qr(f/s)+this.center[0],-180,180),v=Math.asin(B((a-(e*e+h*h)*s*s)/(2*s),-1,1)),b=B(Qr(v),-W,W);return new M(g,b)}}const Xd=1.340264,Yd=-.081106,Kd=893e-6,Jd=.003796,Zp=Math.sqrt(3)/2;class Jw extends Ll{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const s=Math.asin(Zp*Math.sin(i)),a=s*s,u=a*a*a;return{x:.5*(e*Math.cos(s)/(Zp*(Xd+3*Yd*a+u*(7*Kd+9*Jd*a)))/Math.PI+.5),y:1-.5*(s*(Xd+Yd*a+u*(Kd+Jd*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=s*s,u=a*a*a;for(let v,b,w,I=0;I<12&&(b=s*(Xd+Yd*a+u*(Kd+Jd*a))-i,w=Xd+3*Yd*a+u*(7*Kd+9*Jd*a),v=b/w,s=B(s-v,-Math.PI/3,Math.PI/3),a=s*s,u=a*a*a,!(Math.abs(v)<1e-12));++I);const h=Zp*e*(Xd+3*Yd*a+u*(7*Kd+9*Jd*a))/Math.cos(s),f=Math.asin(Math.sin(s)/Zp),_=B(180*h/Math.PI,-180,180),g=B(180*f/Math.PI,-W,W);return new M(_,g)}}class Qw extends Ll{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const s=360*(e-.5),a=B(360*(.5-i),-W,W);return new M(s,a)}}const Yu=Math.PI/2;function Wp(r){return Math.tan((Yu+r)/2)}class eT extends Ll{constructor(e){super(e),this.center=e.center||[0,30];const[i,s]=this.parallels=e.parallels||[30,30];let a=Qt(i),u=Qt(s);this.southernCenter=a+u<0,this.southernCenter&&(a=-a,u=-u);const h=Math.cos(a),f=Wp(a);this.n=a===u?Math.sin(a):Math.log(h/Math.cos(u))/Math.log(Wp(u)/f),this.f=h*Math.pow(Wp(a),this.n)/this.n}project(e,i){i=Qt(i),this.southernCenter&&(i=-i),e=Qt(e-this.center[0]);const s=1e-6,{n:a,f:u}=this;u>0?i<-Yu+s&&(i=-Yu+s):i>Yu-s&&(i=Yu-s);const h=u/Math.pow(Wp(i),a);let f=h*Math.sin(a*e),_=u-h*Math.cos(a*e);return f=.5*(f/Math.PI+.5),_=.5*(_/Math.PI+.5),{x:f,y:this.southernCenter?_:1-_,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:s,f:a}=this,u=a-i,h=Math.sign(u),f=Math.sign(s)*Math.sqrt(e*e+u*u);let _=Math.atan2(e,Math.abs(u))*h;u*s<0&&(_-=Math.PI*Math.sign(e)*h);const g=B(Qr(_/s)+this.center[0],-180,180),v=B(Qr(2*Math.atan(Math.pow(a/f,1/s))-Yu),-W,W);return new M(g,this.southernCenter?-v:v)}}class bv extends Ll{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:V(e),y:N(i),z:0}}unproject(e,i){const s=Z(e),a=H(i);return new M(s,a)}}const wv=Qt(W);class tT extends Ll{project(e,i){const s=(i=Qt(i))*i,a=s*s;return{x:.5*((e=Qt(e))*(.8707-.131979*s+a*(a*(.003971*s-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+a*(.028874*s-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=25,u=0,h=s*s;do{h=s*s;const g=h*h;u=(s*(1.007226+h*(.015085+g*(.028874*h-.044475-.005916*g)))-i)/(1.007226+h*(.045255+g*(.259866*h-.311325-.005916*11*g))),s=B(s-u,-wv,wv)}while(Math.abs(u)>1e-6&&--a>0);h=s*s;const f=B(Qr(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),_=Qr(s);return new M(f,_)}}const Tv=Qt(W);class iT extends Ll{project(e,i){i=Qt(i),e=Qt(e);const s=Math.cos(i),a=2/Math.PI,u=Math.acos(s*Math.cos(e/2)),h=Math.sin(u)/u,f=.5*(e*a+2*s*Math.sin(e/2)/h)||0,_=.5*(i+Math.sin(i)/h)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(_/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,u=25;const h=1e-6;let f=0,_=0;do{const g=Math.cos(a),v=Math.sin(a),b=2*v*g,w=v*v,I=g*g,A=Math.cos(s/2),R=Math.sin(s/2),L=2*A*R,k=R*R,U=1-I*A*A,G=U?1/U:0,q=U?Math.acos(g*A)*Math.sqrt(1/U):0,ie=.5*(2*q*g*R+2*s/Math.PI)-e,J=.5*(q*v+a)-i,se=.5*G*(I*k+q*g*A*w)+1/Math.PI,le=G*(L*b/4-q*v*R),he=.125*G*(b*R-q*v*I*L),Ce=.5*G*(w*A+q*k*g)+.5,ye=le*he-Ce*se;f=(J*le-ie*Ce)/ye,_=(ie*he-J*se)/ye,s=B(s-f,-Math.PI,Math.PI),a=B(a-_,-Tv,Tv)}while((Math.abs(f)>h||Math.abs(_)>h)&&--u>0);return new M(Qr(s),Qr(a))}}class Sv extends Ll{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Qt(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:s,cosPhi:a}=this;return{x:Qt(e)*a*s+.5,y:-Math.sin(Qt(i))/a*s+.5,z:0}}unproject(e,i){const{scale:s,cosPhi:a}=this,u=-(i-.5)/s,h=B(Qr((e-.5)/s)/a,-180,180),f=Math.asin(B(u*a,-1,1)),_=B(Qr(f),-W,W);return new M(h,_)}}class rT extends bv{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){const a=Td(e,i,s);return dr(a,a,yp(_a(s))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,s){const a=x(i.lat,i.lng),u=Yi([],a),h=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;ns(a,a,u,j(1,0)*it*h);const f=Ot(new Float64Array(16));return Xt(f,e.pixelMatrix,e.globeMatrix),dr(a,a,f),new Be(a[0],a[1])}pixelsPerMeter(e,i){return j(1,0)*i}pixelSpaceConversion(e,i,s){const a=j(1,e)*i,u=Vt(j(1,45)*i,a,s);return this.pixelsPerMeter(e,i)/u}createTileMatrix(e,i,s){const a=n_(_a(s.canonical));return Xt(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){const{center:s}=e,a=yp(_a(i));return ci(a,a,Qt(s.lng)),Wi(a,a,Qt(s.lat)),hi(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,s,a){return Wg(e,i,s,!0)||new _e(0,0)}pointCoordinate3D(e,i,s){const a=this.pointCoordinate(e,i,s,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!Wg(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=(function(a,u){const h=a.cameraToCenterDistance,f=a._centerAltitude*u,_=a._camera,g=a._camera.forward(),v=ar([],Xi([],g,-h),[0,0,f]),b=a.worldSize/(2*Math.PI),w=[0,0,-b],I=a.width/a.height,A=Math.tan(a.fovAboveCenter),R=Xi([],_.up(),A),L=Xi([],_.right(),A*I),k=Yi([],ar([],ar([],g,R),L)),U=[];let G;if(new ti(v,k).closestPointOnSphere(w,b,U)){const q=ar([],U,w),ie=Rr([],q,v);G=Math.cos(a.fovAboveCenter)*ir(ie)}else{const q=Rr([],v,w),ie=Rr([],w,v);Yi(ie,ie);const J=ir(q)-b;G=Math.sqrt(J*(J+2*b));const se=Math.acos(G/(b+J))-Math.acos(Qi(g,ie));G*=Math.cos(se)}return 1.01*G})(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Pl(e.zoom);if(s>0){const a=xv(e,j(1,e.center.lat)*e.worldSize),u=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Vt(i,a+u*(1-Math.cos(h)),Math.pow(s,10))}return i}upVector(e,i,s){return Td(i,s,e,1)}upVectorScale(e){return{metersToTile:mp(gp(_a(e)))}}}function Ev(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new bv(r);case"equirectangular":return new Qw(r);case"naturalEarth":return new tT(r);case"equalEarth":return new Jw(r);case"winkelTripel":return new iT(r);case"albers":return i?new Sv(r):new Kw(r);case"lambertConformalConic":return i?new Sv(r):new eT(r);case"globe":return new rT(r)}throw new Error("Invalid projection name: ".concat(r.name))}const nT=je.types,sT=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Qd(r,e,i,s,a,u,h,f,_,g,v,b,w){const I=f?Math.min(Ha,Math.round(f[0])):0,A=f?Math.min(Ha,Math.round(f[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*a),u,h,(I<<1)+(_?1:0),0+(A<<1),16*g,16*v,256*b,256*w)}function ef(r,e,i){r.emplaceBack(e,i)}function tf(r,e,i,s,a,u,h){r.emplaceBack(e,i,s,a,u,h)}const Xp=(r,e,i,s)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],s[0],s[1],s[2])};function Ku(r,e,i,s,a){r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a)}function oT(r){for(const e of r.sections)if(Um(e.text))return!0;return!1}class Q_{constructor(e){this.layoutVertexArray=new Eu,this.indexArray=new zr,this.programConfigurations=e,this.segments=new Vr,this.dynamicLayoutVertexArray=new pa,this.opacityVertexArray=new ad,this.placedSymbolArray=new vc,this.iconTransitioningVertexArray=new xo,this.globeExtVertexArray=new bl,this.zOffsetVertexArray=new Wo,this.orientationVertexArray=new ud,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(e,i){const s=[],a=this.layoutVertexArray.uint16;for(let u=0;u<i;++u){const h=12*(e+u);s.push(...a.slice(h,h+12))}return s}updateIconVertexData(e,i,s,a,u,h,f,_,g,v,b,w,I){const A=this.layoutVertexArray.uint16,R=12*e;A[R]=i,A[R+1]=s,A[R+2]=a,A[R+3]=u,A[R+4]=h,A[R+5]=f,A[R+6]=_,A[R+7]=g,A[R+8]=v,A[R+9]=b,A[R+10]=w,A[R+11]=I}upload(e,i,s,a,u,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,uw.members,!!h),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,dw.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,sT,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,mw.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,hw.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||u)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,fw.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,pw.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}mt(Q_,"SymbolBuffers");class eg{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new Vr,this.collisionVertexArray=new Tl,this.collisionVertexArrayExt=new pa}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,_w.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,gw.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}mt(eg,"CollisionBuffers");class Yp{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((h=>h.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Ot([]),this.placementViewportMatrix=Ot([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=$u(this.zoom,i["text-size"],this.worldview),this.iconSizeData=$u(this.zoom,i["icon-size"],this.worldview);const s=this.layers[0].layout,a=s.get("symbol-sort-key"),u=s.get("symbol-z-order");this.lut=e.lut,this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=u!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(u==="viewport-y"||u==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map((h=>ro[h])),this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(e){const i=this.layers[0].getAppearances();return!(!i||i.length===0)&&i.some((s=>s.getProperty(e)!=null))}createArrays(){this.text=new Q_(new So(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new Q_(new So(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new gd,this.lineVertexArray=new sp,this.symbolInstances=new np}calculateGlyphDependencies(e,i,s,a,u){for(const h of e){const f=h.codePointAt(0);if(f===void 0)break;if(i[f]=!0,a&&u&&f<=65535){const _=jd[h];_&&(i[_.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,i,s,a,u,h){let f=1;const _=e.getUnevaluatedProperties()._values["icon-size"],g=$u(this.zoom,_,this.worldview),v=Zu(g,i);if(g.kind!=="constant"&&g.kind!=="camera"||(f=v.uSize),g.kind==="composite"){const{minZoom:b,maxZoom:w}=g,I=_.possiblyEvaluate(new yr(b,{worldview:this.worldview}),a),A=_.possiblyEvaluate(new yr(w,{worldview:this.worldview}),a),R=I.evaluate(s,{},a,u);f=R+(A.evaluate(s,{},a,u)-R)*v.uSizeT}return g.kind==="source"&&(f=_.possiblyEvaluate(new yr(this.zoom,{worldview:this.worldview}),a).evaluate(s,{},a,u)),f*h}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Sp(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}getResolvedImageFromTokens(e){return typeof e=="string"?Cs.build(e):e}populate(e,i,s,a){const u=this.layers[0],h=u.layout,f=this.projection.name==="globe",_=h.get("text-font"),g=h.get("text-field"),v=h.get("icon-image"),[b,w]=h.get("icon-size-scale-range"),I=B(i.scaleFactor||1,b,w),A=(g.value.kind!=="constant"||g.value.value instanceof kn&&!g.value.value.isEmpty()||g.value.value.toString().length>0)&&(_.value.kind!=="constant"||_.value.value.length>0),R=v.value.kind!=="constant"||!!v.value.value||Object.keys(v.parameters).length>0,L=this.hasAnyAppearanceProperty("icon-image"),k=h.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!A&&!R&&!L)return;const U=i.iconDependencies,G=i.glyphDependencies,q=i.availableImages,ie=new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),J=se=>{const le=se.id.toString();U.has(le)?U.get(le).push(se):U.set(le,[se])};for(const se of e){const{feature:le,id:he,index:Ce,sourceLayerIndex:ye}=se,Pe=u._featureFilter.needGeometry,ke=Te(le,Pe);if(!u._featureFilter.filter(ie,ke,s))continue;if(Pe||(ke.geometry=Le(le,s,a)),f&&le.type!==1&&s.z<=5){const Ge=ke.geometry,Ye=.98078528056,Ne=(pt,yt)=>Qi(Td(pt.x,pt.y,s,1),Td(yt.x,yt.y,s,1))<Ye;for(let pt=0;pt<Ge.length;pt++)Ge[pt]=ze(Ge[pt],Ne)}let Ve,Qe;if(A){const Ge=u.getValueAndResolveTokens("text-field",ke,s,q),Ye=kn.factory(Ge);oT(Ye)&&(this.hasRTLText=!0),(!this.hasRTLText||Jh()==="unavailable"||this.hasRTLText&&Vs.isParsed())&&(Ve=xw(Ye,u,ke))}if(R){const Ge=u.getValueAndResolveTokens("icon-image",ke,s,q);Qe=this.getResolvedImageFromTokens(Ge)}const qe=this.layers[0];let Fe=!1;if(!Qe&&L){const Ge=qe.getAppearances();for(const Ye of Ge)if(Ye.getProperty("icon-image")){const Ne=qe.getAppearanceValueAndResolveTokens(Ye,"icon-image",ke,s,q);if(Ne){Qe=this.getResolvedImageFromTokens(Ne),Fe=!0;break}}}if(!Ve&&!Qe)continue;const He=this.sortFeaturesByKey?k.evaluate(ke,{},s):void 0,Ae={id:he,text:Ve,icon:Qe,index:Ce,sourceLayerIndex:ye,geometry:ke.geometry,properties:le.properties,type:nT[le.type],sortKey:He};if(this.features.push(Ae),this.appearanceFeatureData.push({id:he,properties:le.properties,usesAppearanceIconAsPlaceholder:Fe,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),Qe){const Ge=qe._unevaluatedLayout._values,{iconPrimary:Ye,iconSecondary:Ne}=$d(Qe,this.iconSizeData,Ge["icon-size"],s,this.zoom,Ae,this.pixelRatio,I,this.worldview);J(Ye),Ne&&(this.hasAnySecondaryIcon=!0,J(Ne))}const Ee=qe.getAppearances();if(Ee.length!==0&&Ee.forEach((Ge=>{if(!Ge.getProperty("icon-image"))return;const Ye=this.getCombinedIconPrimary(Ge,qe,ke,s,q,Ae,I);Ye&&J(Ye)})),Ve){const Ge=_.evaluate(ke,{},s).join(","),Ye=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(ro.vertical)>=0;for(const Ne of Ve.sections)if(Ne.image){const pt=Ne.image.getPrimary().scaleSelf(this.pixelRatio),yt=pt.id.toString(),ht=U.get(yt)||[];ht.push(pt),U.set(yt,ht)}else{const pt=$h(Ve.toString()),yt=Ne.fontStack||Ge,ht=G[yt]=G[yt]||{};this.calculateGlyphDependencies(Ne.text,ht,Ye,this.allowVerticalPlacement,pt)}}}if(h.get("symbol-placement")==="line"&&(this.features=(function(se){const le={},he={},Ce=[];let ye=0;function Pe(qe){Ce.push(se[qe]),ye++}function ke(qe,Fe,He){const Ae=he[qe];return delete he[qe],he[Fe]=Ae,Ce[Ae].geometry[0].pop(),Ce[Ae].geometry[0]=Ce[Ae].geometry[0].concat(He[0]),Ae}function Ve(qe,Fe,He){const Ae=le[Fe];return delete le[Fe],le[qe]=Ae,Ce[Ae].geometry[0].shift(),Ce[Ae].geometry[0]=He[0].concat(Ce[Ae].geometry[0]),Ae}function Qe(qe,Fe,He){const Ae=He?Fe[0][Fe[0].length-1]:Fe[0][0];return"".concat(qe,":").concat(Ae.x,":").concat(Ae.y)}for(let qe=0;qe<se.length;qe++){const Fe=se[qe],He=Fe.geometry,Ae=Fe.text?Fe.text.toString():null;if(!Ae){Pe(qe);continue}const Ee=Qe(Ae,He),Ge=Qe(Ae,He,!0);if(Ee in he&&Ge in le&&he[Ee]!==le[Ge]){const Ye=Ve(Ee,Ge,He),Ne=ke(Ee,Ge,Ce[Ye].geometry);delete le[Ee],delete he[Ge],he[Qe(Ae,Ce[Ne].geometry,!0)]=Ne,Ce[Ye].geometry=null}else Ee in he?ke(Ee,Ge,He):Ge in le?Ve(Ee,Ge,He):(Pe(qe),le[Ee]=ye-1,he[Ge]=ye-1)}return Ce.filter((qe=>qe.geometry))})(this.features)),h.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const se of i.elevationFeatures)this.elevationFeatureIdToIndex.set(se.id,this.elevationFeatures.length),this.elevationFeatures.push(se)}}else h.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((se,le)=>se.sortKey-le.sortKey))}getCombinedIconPrimary(e,i,s,a,u,h,f){let _,g;const v=e.getUnevaluatedProperties();if(v._values["icon-image"].value!==void 0){const b=i.getAppearanceValueAndResolveTokens(e,"icon-image",s,a,u);_=this.getResolvedImageFromTokens(b)}else{const b=i.getValueAndResolveTokens("icon-image",s,a,u);_=this.getResolvedImageFromTokens(b)}if(_){const b=v._values["icon-size"]||i._unevaluatedLayout._values["icon-size"];g=$d(_,$u(this.zoom,b,this.worldview),b,a,this.zoom,h,this.pixelRatio,f,this.worldview).iconPrimary}return g}updateAppearanceBasedIconTextures(e,i,s,a){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const u=this.layers[0];let h=!1,f=0;const _=u.layout,[g,v]=_.get("icon-size-scale-range"),b=B(1,g,v);for(let w=0;w<this.symbolInstances.length;w++){const I=this.symbolInstances.get(w),A=this.appearanceFeatureData[I.featureIndex];if(A&&I.placedIconSymbolIndex>=0){const R=A.id,L=i&&R!==void 0?i[String(R)]:void 0,k={type:"Point",id:A.id,properties:A.properties,geometry:[]},U=this.layers[0].appearances&&this.layers[0].appearances.find((G=>G.isActive({globals:a,feature:k,canonical:e,featureState:L})));if(A.activeAppearance===U)continue;if(U){A.activeAppearance=U;const G={sortKey:void 0,text:void 0,icon:null,index:I.featureIndex,sourceLayerIndex:I.featureIndex,geometry:[],properties:A.properties,type:"Point",id:A.id};if(!U.hasCachedIconPrimary()){const se=this.getCombinedIconPrimary(U,u,k,e,s,G,b);U.setCachedIconPrimary(se)}const q=U.getCachedIconPrimary();if(!q)continue;const ie=q.toString(),J=this.iconAtlasPositions&&this.iconAtlasPositions.get(ie);if(J){const se=u.getAppearanceValueAndResolveTokens(U,"icon-offset",k,e,s),le=se&&Array.isArray(se)?se:[0,0];let he=Vp(J,void 0,le,u.layout.get("icon-anchor").evaluate(k,{},e));const Ce=u.getAppearanceValueAndResolveTokens(U,"icon-rotate",k,e,s),ye=typeof Ce=="number"?Ce:0,Pe=J.sdf,ke=u.layout.get("icon-text-fit").constantOr("none");ke!=="none"&&A.textShaping&&A.iconTextFitPadding&&A.fontScale&&(he=H_(he,A.textShaping,ke,A.iconTextFitPadding,le,A.fontScale));const Ve=this.calculateEffectiveAppearanceIconSize(U,a.zoom,k,e,s,b),Qe=0,qe=1+(Math.min(Ha,Math.round(Ve*Qo))<<1),Fe=W_(he,ye,Pe,ke!=="none",b);A.isUsingAppearanceVertexData||(A.isUsingAppearanceVertexData=!0,A.layoutBasedVertexData=this.icon.getIconVertexData(f,I.numIconVertices));for(let Ae=0;Ae<Fe.length;++Ae){const Ee=Fe[Ae],Ge=A.layoutBasedVertexData[0]||I.tileAnchorX,Ye=A.layoutBasedVertexData[1]||I.tileAnchorY,Ne=16*Ee.pixelOffsetTL.x,pt=16*Ee.pixelOffsetTL.y,yt=16*Ee.pixelOffsetBR.x,ht=16*Ee.pixelOffsetBR.y,st=16*Ee.minFontScaleX,$t=16*Ee.minFontScaleY;this.icon.updateIconVertexData(f,Ge,Ye,Math.round(32*Ee.tl.x),Math.round(32*Ee.tl.y),Ee.texPrimary.x,Ee.texPrimary.y,Qe,qe,Ne,pt,st,$t),this.icon.updateIconVertexData(f+1,Ge,Ye,Math.round(32*Ee.tr.x),Math.round(32*Ee.tr.y),Ee.texPrimary.x+Ee.texPrimary.w,Ee.texPrimary.y,Qe,qe,yt,pt,st,$t),this.icon.updateIconVertexData(f+2,Ge,Ye,Math.round(32*Ee.bl.x),Math.round(32*Ee.bl.y),Ee.texPrimary.x,Ee.texPrimary.y+Ee.texPrimary.h,Qe,qe,Ne,ht,st,$t),this.icon.updateIconVertexData(f+3,Ge,Ye,Math.round(32*Ee.br.x),Math.round(32*Ee.br.y),Ee.texPrimary.x+Ee.texPrimary.w,Ee.texPrimary.y+Ee.texPrimary.h,Qe,qe,yt,ht,st,$t),f+=4}const He=I.numIconVertices-4*Fe.length;for(let Ae=0;Ae<He;++Ae)this.icon.updateIconVertexData(f+Ae,0,0,0,0,0,0,0,0,0,0,0,0);h=!0}else f+=I.numIconVertices}else if(A.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(f,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(f+3,0,0,0,0,0,0,0,0,0,0,0,0),h=!0),f+=I.numIconVertices,A.activeAppearance=null;else if(A.isUsingAppearanceVertexData){const q=A.layoutBasedVertexData.length/12;for(let ie=0;ie<q;++ie){const J=ie*12;this.icon.updateIconVertexData(f+ie,A.layoutBasedVertexData[J+0],A.layoutBasedVertexData[J+1],A.layoutBasedVertexData[J+2],A.layoutBasedVertexData[J+3],A.layoutBasedVertexData[J+4],A.layoutBasedVertexData[J+5],A.layoutBasedVertexData[J+6],A.layoutBasedVertexData[J+7],A.layoutBasedVertexData[J+8],A.layoutBasedVertexData[J+9],A.layoutBasedVertexData[J+10],A.layoutBasedVertexData[J+11])}f+=q,A.isUsingAppearanceVertexData=!1,A.activeAppearance=null,h=!0}else f+=I.numIconVertices,A.activeAppearance=null}}return h}update(e,i,s,a,u,h,f){this.text.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,u,s,a,h,f,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const s=ne(e),a=1/s;let u=!1,h=!1;for(let f=0;f<this.symbolInstances.length;f++){const _=this.symbolInstances.get(f),g=qi(1,0,0),v=qi(0,1,0),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:w,numIconVertices:I,numVerticalIconVertices:A}=_,R=b>0||w>0,L=I>0,k=this.elevationFeatures[_.elevationFeatureIndex];if(k){const U=new Be(_.tileAnchorX,_.tileAnchorY),G=.075+k.pointElevation(U);_.zOffset!==G&&(i=!0,_.zOffset=G),G!==0&&(this.hasAnyZOffset=!0);const q=k.computeSlopeNormal(U,a),ie=sn(zs(),qi(0,0,1),q);Vn(g,g,ie),Vn(v,v,ie),g[2]*=s,v[2]*=s,g[0]===1&&g[1]===0&&g[2]===0&&v[0]===0&&v[1]===1&&v[2]===0||(u=u||R,h=h||L)}if(R&&(Xp(this.text.orientationVertexArray,b,g,v),Xp(this.text.orientationVertexArray,w,g,v)),L){const{placedIconSymbolIndex:U,verticalPlacedIconSymbolIndex:G}=_;U>=0&&Xp(this.icon.orientationVertexArray,I,g,v),G>=0&&Xp(this.icon.orientationVertexArray,A,g,v)}}u||(this.text.orientationVertexArray=void 0),h||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(u,h,f)=>{s+=h,s>u.length&&u.resize(s);for(let _=-h;_<0;_++)u.emplace(_+s,f)},i=(u,h,f)=>{a+=h,a>u.length&&u.resize(a);for(let _=-h;_<0;_++)u.emplace(_+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,a=0;for(let u=0;u<this.symbolInstances.length;u++){const h=this.symbolInstances.get(u),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:_,numIconVertices:g}=h,v=h.zOffset,b=g>0;if((f>0||_>0)&&(e(this.text.zOffsetVertexArray,f,v),e(this.text.zOffsetVertexArray,_,v)),b){const{placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:I}=h;w>=0&&i(this.icon.zOffsetVertexArray,g,v),I>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,v)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,i,s,a,u){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some((h=>h.appearances&&h.appearances.length>0))),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,i,s,a){return!!(e&&i&&s)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,i,s,a)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Ev(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const s=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:u}of i)this.lineVertexArray.emplaceBack(a,u);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,a,u,h,f,_,g,v,b,w,I,A,R,L,k,U){const G=e.indexArray,q=e.layoutVertexArray,ie=e.globeExtVertexArray,J=e.segments.prepareSegment(4*U,q,G,this.canOverlap?h.sortKey:void 0),se=this.glyphOffsetArray.length,le=J.vertexLength,he=this.allowVerticalPlacement&&f===ro.vertical?Math.PI/2:0,Ce=h.text&&h.text.sections;for(let ke=0;ke<i.length;ke++){const{tl:Ve,tr:Qe,bl:qe,br:Fe,texPrimary:He,texSecondary:Ae,pixelOffsetTL:Ee,pixelOffsetBR:Ge,minFontScaleX:Ye,minFontScaleY:Ne,glyphOffset:pt,isSDF:yt,sectionIndex:ht}=i[ke],st=J.vertexLength,$t=pt[1];if(Qd(q,g.x,g.y,Ve.x,$t+Ve.y,He.x,He.y,s,yt,Ee.x,Ee.y,Ye,Ne),Qd(q,g.x,g.y,Qe.x,$t+Qe.y,He.x+He.w,He.y,s,yt,Ge.x,Ee.y,Ye,Ne),Qd(q,g.x,g.y,qe.x,$t+qe.y,He.x,He.y+He.h,s,yt,Ee.x,Ge.y,Ye,Ne),Qd(q,g.x,g.y,Fe.x,$t+Fe.y,He.x+He.w,He.y+He.h,s,yt,Ge.x,Ge.y,Ye,Ne),_){const{x:at,y:Ct,z:Wt}=_.anchor,[oi,Si,Yt]=_.up;tf(ie,at,Ct,Wt,oi,Si,Yt),tf(ie,at,Ct,Wt,oi,Si,Yt),tf(ie,at,Ct,Wt,oi,Si,Yt),tf(ie,at,Ct,Wt,oi,Si,Yt),Ku(e.dynamicLayoutVertexArray,at,Ct,Wt,he)}else Ku(e.dynamicLayoutVertexArray,g.x,g.y,g.z,he);if(L){const at=Ae||He;ef(e.iconTransitioningVertexArray,at.x,at.y),ef(e.iconTransitioningVertexArray,at.x+at.w,at.y),ef(e.iconTransitioningVertexArray,at.x,at.y+at.h),ef(e.iconTransitioningVertexArray,at.x+at.w,at.y+at.h)}G.emplaceBack(st,st+1,st+2),G.emplaceBack(st+1,st+2,st+3),J.vertexLength+=4,J.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(pt[0]),ke!==i.length-1&&ht===i[ke+1].sectionIndex||e.programConfigurations.populatePaintArrays(q.length,h,h.index,{},I,A,R,Ce&&Ce[ht],this.worldview)}const ye=U-i.length;ye!==0&&this._addNullVertices(ye,q,s,_,ie,e,L,J,G);const Pe=_?_.anchor:g;e.placedSymbolArray.emplaceBack(Pe.x,Pe.y,Pe.z,g.x,g.y,se,this.glyphOffsetArray.length-se,le,v,b,g.segment,s?s[0]:0,s?s[1]:0,a[0],a[1],f,0,0,0,w,0),e.symbolInstanceIndices.push(k)}_addNullVertices(e,i,s,a,u,h,f,_,g){for(let v=0;v<e;v++){for(let w=0;w<4;w++)Qd(i,0,0,0,0,0,0,s,!1,0,0,0,0),a&&tf(u,0,0,0,0,0,0),Ku(h.dynamicLayoutVertexArray,0,0,0,0),f&&ef(h.iconTransitioningVertexArray,0,0);const b=_.vertexLength;g.emplaceBack(b,b+1,b+2),g.emplaceBack(b+1,b+2,b+3),_.vertexLength+=4,_.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,i,s,a,u,h,f){e.emplaceBack(i,s,a,u,h,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,i,s,a,u,h,f){const _=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),g=_.vertexLength,v=f.tileAnchorX,b=f.tileAnchorY;for(let I=0;I<4;I++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,f.zOffset),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,v,b,new Be(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,v,b,new Be(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,v,b,new Be(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,a,u,h,v,b,new Be(e.x1,e.y2)),_.vertexLength+=4;const w=s.indexArray;w.emplaceBack(g,g+1),w.emplaceBack(g+1,g+2),w.emplaceBack(g+2,g+3),w.emplaceBack(g+3,g),_.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,a,u,h){for(let f=a;f<u;f++){const _=s.get(f),g=this.getSymbolInstanceTextSize(e,h,i,f);this._addCollisionDebugVertices(_,g,this.textCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,s,a,u,h){for(let f=a;f<u;f++){const _=s.get(f),g=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(_,g,this.iconCollisionBox,_.projectedAnchorX,_.projectedAnchorY,_.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new eg(Iu,jx.members,xo),this.iconCollisionBox=new eg(Iu,jx.members,xo);const a=Zu(this.iconSizeData,e),u=Zu(this.textSizeData,e,s);for(let h=0;h<this.symbolInstances.length;h++){const f=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(u,e,i,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(u,e,i,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,i,s,a){const u=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),h=q_(this.textSizeData,e,u)/Zn;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,s){const a=this.icon.placedSymbolArray.get(s),u=q_(this.iconSizeData,e,a);return this.tilePixelRatio*u}_commitDebugCollisionVertexUpdate(e,i,s,a){e.emplaceBack(i,-s,-s,a),e.emplaceBack(i,s,-s,a),e.emplaceBack(i,s,s,a),e.emplaceBack(i,-s,s,a)}_updateTextDebugCollisionBoxes(e,i,s,a,u,h,f){for(let _=a;_<u;_++){const g=s.get(_),v=this.getSymbolInstanceTextSize(e,h,i,_);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,v,g.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,a,u,h,f){for(let _=a;_<u;_++){const g=s.get(_),v=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,v,g.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,s,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const u=Zu(this.iconSizeData,e,a),h=Zu(this.textSizeData,e,s);for(let f=0;f<this.symbolInstances.length;f++){const _=this.symbolInstances.get(f);this._updateTextDebugCollisionBoxes(h,e,i,_.textBoxStartIndex,_.textBoxEndIndex,_,s),this._updateTextDebugCollisionBoxes(h,e,i,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_,s),this._updateIconDebugCollisionBoxes(u,e,i,_.iconBoxStartIndex,_.iconBoxEndIndex,_,a),this._updateIconDebugCollisionBoxes(u,e,i,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,a,u,h,f,_,g){const v={};if(i<s){const{x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q,featureIndex:ie}=e.get(i);v.textBox={x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q},v.textFeatureIndex=ie}if(a<u){const{x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q,featureIndex:ie}=e.get(a);v.verticalTextBox={x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q},v.verticalTextFeatureIndex=ie}if(h<f){const{x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q,featureIndex:ie}=e.get(h);v.iconBox={x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q},v.iconFeatureIndex=ie}if(_<g){const{x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q,featureIndex:ie}=e.get(_);v.verticalIconBox={x1:b,y1:w,x2:I,y2:A,padding:R,projectedAnchorX:L,projectedAnchorY:k,projectedAnchorZ:U,tileAnchorX:G,tileAnchorY:q},v.verticalIconFeatureIndex=ie}return v}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const s=e.placedSymbolArray.get(i),a=s.vertexStartIndex+4*s.numGlyphs;for(let u=s.vertexStartIndex;u<a;u+=4)e.indexArray.emplaceBack(u,u+1,u+2),e.indexArray.emplaceBack(u+1,u+2,u+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),s=Math.cos(e),a=[],u=[],h=[];for(let f=0;f<this.symbolInstances.length;++f){h.push(f);const _=this.symbolInstances.get(f);a.push(0|Math.round(i*_.tileAnchorX+s*_.tileAnchorY)),u.push(_.featureIndex)}return h.sort(((f,_)=>a[f]-a[_]||u[_]-u[f])),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,i){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:u,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:_,verticalPlacedIconSymbolIndex:g}=s;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),u>=0&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),h>=0&&h!==u&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),_>=0&&this.addIndicesForPlacedSymbol(this.icon,_),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const i=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let s;return this.elevationFeatures&&i<this.elevationFeatures.length&&(s=this.elevationFeatures[i]),s}}function Iv(r,e){return e.replace(/{([^{}]+)}/g,((i,s)=>s in r?String(r[s]):""))}let Av,Mv,tg;mt(Yp,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),Yp.addDynamicAttributes=Ku;class Cv{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Xa,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}mt(Cv,"FormatSectionOverride",{omit:["defaultValue"]});const ig=()=>tg||(tg={layout:Av||(Av=new $r({"symbol-placement":new We(ge.layout_symbol["symbol-placement"]),"symbol-spacing":new We(ge.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new We(ge.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ct(ge.layout_symbol["symbol-sort-key"]),"symbol-z-order":new We(ge.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new We(ge.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new We(ge.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new We(ge.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new We(ge.layout_symbol["icon-ignore-placement"]),"icon-optional":new We(ge.layout_symbol["icon-optional"]),"icon-rotation-alignment":new We(ge.layout_symbol["icon-rotation-alignment"]),"icon-size":new ct(ge.layout_symbol["icon-size"]),"icon-size-scale-range":new We(ge.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new ct(ge.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ct(ge.layout_symbol["icon-text-fit-padding"]),"icon-image":new ct(ge.layout_symbol["icon-image"]),"icon-image-use-theme":new We({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new ct(ge.layout_symbol["icon-rotate"]),"icon-padding":new We(ge.layout_symbol["icon-padding"]),"icon-keep-upright":new We(ge.layout_symbol["icon-keep-upright"]),"icon-offset":new ct(ge.layout_symbol["icon-offset"]),"icon-anchor":new ct(ge.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new We(ge.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new We(ge.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new We(ge.layout_symbol["text-rotation-alignment"]),"text-field":new ct(ge.layout_symbol["text-field"]),"text-font":new ct(ge.layout_symbol["text-font"]),"text-size":new ct(ge.layout_symbol["text-size"]),"text-size-scale-range":new We(ge.layout_symbol["text-size-scale-range"]),"text-max-width":new ct(ge.layout_symbol["text-max-width"]),"text-line-height":new ct(ge.layout_symbol["text-line-height"]),"text-letter-spacing":new ct(ge.layout_symbol["text-letter-spacing"]),"text-justify":new ct(ge.layout_symbol["text-justify"]),"text-radial-offset":new ct(ge.layout_symbol["text-radial-offset"]),"text-variable-anchor":new We(ge.layout_symbol["text-variable-anchor"]),"text-anchor":new ct(ge.layout_symbol["text-anchor"]),"text-max-angle":new We(ge.layout_symbol["text-max-angle"]),"text-writing-mode":new We(ge.layout_symbol["text-writing-mode"]),"text-rotate":new ct(ge.layout_symbol["text-rotate"]),"text-padding":new We(ge.layout_symbol["text-padding"]),"text-keep-upright":new We(ge.layout_symbol["text-keep-upright"]),"text-transform":new ct(ge.layout_symbol["text-transform"]),"text-offset":new ct(ge.layout_symbol["text-offset"]),"text-allow-overlap":new We(ge.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new We(ge.layout_symbol["text-ignore-placement"]),"text-optional":new We(ge.layout_symbol["text-optional"]),visibility:new We(ge.layout_symbol.visibility)})),paint:Mv||(Mv=new $r({"icon-opacity":new ct(ge.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new ct(ge.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new ct(ge.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ct(ge.paint_symbol["text-emissive-strength"]),"icon-color":new ct(ge.paint_symbol["icon-color"]),"icon-halo-color":new ct(ge.paint_symbol["icon-halo-color"]),"icon-halo-width":new ct(ge.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ct(ge.paint_symbol["icon-halo-blur"]),"icon-translate":new We(ge.paint_symbol["icon-translate"]),"icon-translate-anchor":new We(ge.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new We(ge.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ct(ge.paint_symbol["text-opacity"]),"text-occlusion-opacity":new ct(ge.paint_symbol["text-occlusion-opacity"]),"text-color":new ct(ge.paint_symbol["text-color"],{runtimeType:Bs,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new ct(ge.paint_symbol["text-halo-color"]),"text-halo-width":new ct(ge.paint_symbol["text-halo-width"]),"text-halo-blur":new ct(ge.paint_symbol["text-halo-blur"]),"text-translate":new We(ge.paint_symbol["text-translate"]),"text-translate-anchor":new We(ge.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new We(ge.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new We(ge.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new We(ge.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new We(ge.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new ct(ge.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},tg);class Kp extends ys{constructor(e,i,s,a){super(e,ig(),i,s,a,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=Ot([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,i){super.recalculate(e,i),this.appearances&&this.appearances.forEach((a=>{a.recalculate(e,i,this.iconImageUseTheme)})),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const a=[];for(const u of s)a.indexOf(u)<0&&a.push(u);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===a||(this._colorAdjustmentMatrix=(function(u,h,f,_){u=pr(u),h=lr(h);const g=ai(),v=u/3,b=1-2*v,w=[b,v,v,0,v,b,v,0,v,v,b,0,0,0,0,1],I=.5-.5*h,A=_-f;return Xt(g,[A,0,0,0,0,A,0,0,0,0,A,0,f,f,f,1],[h,0,0,0,0,h,0,0,0,0,h,0,I,I,I,1]),Xt(g,g,w),g})(e,i,s,a),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,a){const u=this.layout.get(e).evaluate(i,{},s,a),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||fu(h.value)||!u?u:Iv(i.properties,u)}getAppearanceValueAndResolveTokens(e,i,s,a,u){const h=e.getProperty(i);if(!h)return;const f=h.evaluate(s,{},a,u),_=e.getUnevaluatedProperties()._values[i];return _.isDataDriven()||fu(_.value)||!f||typeof f!="string"?f:Iv(s.properties,f)}createBucket(e){return new Yp(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of ig().paint.overridableProperties){if(!Kp.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),s=new Cv(i),a=new du(s,i.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let u=null;u=i.value.kind==="constant"||i.value.kind==="source"?new pc("source",a):new ca("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new yo(i.property,u,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&Kp.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const s=e.get("text-field"),a=ig().paint.properties[i];let u=!1;const h=f=>{for(const _ of f)if(a.overrides&&a.overrides.hasOverride(_))return void(u=!0)};if(s.value.kind==="constant"&&s.value.value instanceof kn)h(s.value.value.sections);else if(s.value.kind==="source"){const f=g=>{u||(g instanceof Go&&Pn(g.value)===Ia?h(g.value.sections):g instanceof Aa?h(g.sections):g.eachChild(f))},_=s.value;_._styleExpression&&f(_._styleExpression.expression)}return u}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new Yo(this,{zoom:i,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Pv,Rv,Dv,zv;var rg=fi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Jp(r,e,i,s,a,u,h,f){const _=[r,e,1,i,s,1,a,u,1],g=[h,f,1],v=Tt([],_),[b,w,I]=os(g,g,v);return Rt(_,_,[b,0,0,0,w,0,0,0,I])}function Lv(r,e,i,s,a,u,h,f){const _=(function(g,v,b,w,I,A,R,L){const k=Jp(0,0,1,0,1,1,0,1),U=Jp(g,v,b,w,I,A,R,L);return Rt(U,U,Tt([],k))})(r,e,i,s,a,u,h,f);return[_[2]/_[8]/it,_[5]/_[8]/it]}function Qp(r){return[r[0],Math.min(Math.max(r[1],-W),W)]}class Ov extends Vo{constructor(e,i,s,a){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new $s("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=hh(this.map._requestManager.transformRequest(this.url,Ta.Image),((s,a)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new Zl(s)):a&&(this.image=a instanceof HTMLImageElement?Mi.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Nd(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new $s("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Nd||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(const u of e)u[1]>s&&(s=u[1]),u[1]<i&&(i=u[1]);const a=(s+i)/2;if(a>W?this.onNorthPole=!0:a<-W&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const u=e.map(_e.fromLngLat);this.tileID=(function(h){let f=1/0,_=1/0,g=-1/0,v=-1/0;for(const R of h)f=Math.min(f,R.x),_=Math.min(_,R.y),g=Math.max(g,R.x),v=Math.max(v,R.y);const b=Math.max(g-f,v-_),w=Math.max(0,Math.floor(-Math.log2(b))),I=Math.pow(2,w);let A=Math.floor((f+g)/2*I);return A>1&&(A-=1),new eo(w,A,Math.floor((_+v)/2*I))})(u),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new $s("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Nd||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const k in this.tiles){const U=this.tiles[k];U.state!=="loaded"&&(U.state="loaded",U.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Wd(new eo(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!(function(k){const U=k[1].x-k[0].x,G=k[1].y-k[0].y,q=k[2].x-k[1].x,ie=k[2].y-k[1].y,J=k[3].x-k[2].x,se=k[3].y-k[2].y,le=k[0].x-k[3].x,he=k[0].y-k[3].y,Ce=U*ie-q*G,ye=q*se-J*ie,Pe=J*he-le*se,ke=le*G-U*he;return Ce>0&&ye>0&&Pe>0&&ke>0||Ce<0&&ye<0&&Pe<0&&ke<0})(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=Wd(this.tileID,this.map.transform.projection),[u,h,f,_]=this.coordinates.map((k=>{const U=a.projection.project(k[0],k[1]);return vv(a,U)._round()}));this.perspectiveTransform=Lv(u.x,u.y,h.x,h.y,f.x,f.y,_.x,_.y);const g=this._boundsArray=new vl;g.emplaceBack(u.x,u.y,0,0),g.emplaceBack(h.x,h.y,it,0),g.emplaceBack(_.x,_.y,0,it),g.emplaceBack(f.x,f.y,it,it),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(g,rg.members),this.boundsSegments=Vr.simpleSegment(0,0,4,2);const v=[],b=[Qp((w=this.coordinates)[0]),Qp(w[1]),Qp(w[2]),Qp(w[3])];var w;const[I,A,R,L]=(function(k){let U=k[0][0],G=U,q=k[0][1],ie=q;for(let J=1;J<k.length;J++)k[J][0]<U?U=k[J][0]:k[J][0]>G&&(G=k[J][0]),k[J][1]<q?q=k[J][1]:k[J][1]>ie&&(ie=k[J][1]);return[U,q,G-U,ie-q]})(b);{const k=new vl,[U,G,q,ie]=(function(Fe){let He=Fe[0].x,Ae=He,Ee=Fe[0].y,Ge=Ee;for(let Ye=1;Ye<Fe.length;Ye++)Fe[Ye].x<He?He=Fe[Ye].x:Fe[Ye].x>Ae&&(Ae=Fe[Ye].x),Fe[Ye].y<Ee?Ee=Fe[Ye].y:Fe[Ye].y>Ge&&(Ge=Fe[Ye].y);return[He,Ee,Ae-He,Ge-Ee]})(s),J=Fe=>[(Fe.x-U)/q,(Fe.y-G)/ie],[se,le,he,Ce]=s.map(J),ye=(function(Fe,He,Ae,Ee,Ge,Ye,Ne,pt){const yt=Jp(0,0,1,0,1,1,0,1);return Rt(yt,yt,Tt([],Jp(Fe,He,Ae,Ee,Ge,Ye,Ne,pt)))})(se[0],se[1],le[0],le[1],he[0],he[1],Ce[0],Ce[1]);this.elevatedGlobePerspectiveTransform=Lv(se[0],se[1],le[0],le[1],he[0],he[1],Ce[0],Ce[1]);const Pe=(Fe,He)=>{v.push(Fe.lng);const Ae=Math.round((Fe.lng-I)/R*it),Ee=Math.round((Fe.lat-A)/L*it),Ge=J(He),Ye=os([],[Ge[0],Ge[1],1],ye),Ne=Math.round(Ye[0]/Ye[2]*it),pt=Math.round(Ye[1]/Ye[2]*it);k.emplaceBack(Ae,Ee,Ne,pt)},ke=s[3].x-s[0].x,Ve=s[3].y-s[0].y,Qe=s[2].x-s[1].x,qe=s[2].y-s[1].y;for(let Fe=0;Fe<65;Fe++){const He=Fe/64,Ae=[s[0].x+He*ke,s[0].y+He*Ve],Ee=[s[1].x+He*Qe,s[1].y+He*qe],Ge=Ee[0]-Ae[0],Ye=Ee[1]-Ae[1];for(let Ne=0;Ne<65;Ne++){const pt=Ne/64,yt={x:Ae[0]+Ge*pt,y:Ae[1]+Ye*pt};Pe(i.projection.unproject(yt.x,yt.y),yt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(k,rg.members)}{this.maxLongitudeTriangleSize=0;let k=[],U=new zr;const G=(q,ie,J)=>{U.emplaceBack(q,ie,J);const se=v[q],le=v[ie],he=v[J],Ce=Math.min(Math.min(se,le),he),ye=Math.max(Math.max(se,le),he)-Ce;ye>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=ye),k.push(Ce+ye/2)};for(let q=0;q<64;q++)for(let ie=0;ie<64;ie++){const J=65*q+ie,se=J+1,le=J+65,he=le+1;G(J,le,se),G(se,le,he)}[k,U]=(function(q,ie){const J=Array.from({length:q.length},((he,Ce)=>Ce));J.sort(((he,Ce)=>q[he]-q[Ce]));const se=[],le=new zr;for(let he=0;he<J.length;he++){const Ce=J[he];se.push(q[Ce]);const ye=3*Ce,Pe=ye+1;le.emplaceBack(ie.uint16[ye],ie.uint16[Pe],ie.uint16[Pe+1])}return[se,le]})(k,U),this.elevatedGlobeTrianglesCenterLongitudes=k,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(U)}this.elevatedGlobeSegments=Vr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,R/it,0,L/it,0,0,A,I,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Nd||(this.texture?this.texture.update(this.image):(this.texture=new C_(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const s=this.elevatedGlobeTrianglesCenterLongitudes;let a=(u=e+180)+360*Math.round((s[0]-u)/360);var u;const h=new Vr,f=(b,w)=>{h.segments.push({vertexOffset:0,primitiveOffset:b,vertexLength:i.segments[0].vertexLength,primitiveLength:w,sortKey:void 0,vaos:{}})},_=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-a)<=_){const b=ui(s,0,s.length,a+_);return b===s.length||f(b,Ai(s,b+1,s.length,a+360-_)-b),h}a<s[0]&&(a+=360);const g=Ai(s,0,s.length,a-_);if(g===s.length)return f(0,s.length),h;f(0,g-0);const v=ui(s,g+1,s.length,a+_);return v!==s.length&&f(v,s.length-v),h}}const aT=(Math.pow(256,2)-1)/16907520;class kv extends ys{constructor(e,i,s,a){super(e,{layout:Dv||(Dv=new $r({visibility:new We(ge.layout_raster.visibility)})),paint:zv||(zv=new $r({"raster-opacity":new We(ge.paint_raster["raster-opacity"]),"raster-color":new ml(ge.paint_raster["raster-color"]),"raster-color-mix":new We(ge.paint_raster["raster-color-mix"]),"raster-color-range":new We(ge.paint_raster["raster-color-range"]),"raster-hue-rotate":new We(ge.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new We(ge.paint_raster["raster-brightness-min"]),"raster-brightness-max":new We(ge.paint_raster["raster-brightness-max"]),"raster-saturation":new We(ge.paint_raster["raster-saturation"]),"raster-contrast":new We(ge.paint_raster["raster-contrast"]),"raster-resampling":new We(ge.paint_raster["raster-resampling"]),"raster-fade-duration":new We(ge.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new We(ge.paint_raster["raster-emissive-strength"]),"raster-array-band":new We(ge.paint_raster["raster-array-band"]),"raster-elevation":new We(ge.paint_raster["raster-elevation"]),"raster-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof Ov&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[s,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(a)||s===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=Sd({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,a])}}let Fv,Bv,Nv,Vv,Uv;class jv extends ys{constructor(e,i,s,a){super(e,{layout:Fv||(Fv=new $r({visibility:new We(ge["layout_raster-particle"].visibility)})),paint:Bv||(Bv=new $r({"raster-particle-array-band":new We(ge["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new We(ge["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new ml(ge["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new We(ge["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new We(ge["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new We(ge["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new We(ge["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new We(ge["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this._updateColorRamp(),this.lastInvalidatedAt=Mi.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Sd({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Mi.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class lT extends ys{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function ng(r,e,i){const s=[0,0,1],a=ms([]);return Kn(a,a,i?-Qt(r)+Math.PI:Qt(r)),Yn(a,a,-Qt(e)),Vn(s,s,a),Yi(s,s)}const Gv={None:0,Model:1,Symbol:2,FillExtrusion:4};class em{constructor(e,i,s,a){this.message=(e?"".concat(e,": "):"")+s,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function sg(r,e){const i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch(s){return!1}}class Hv{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class qv{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new Mu,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const i=16*e,s=this.instancedDataArray.float32;let a=Math.floor(s[i+2]);const u=1.05*(s[i+2]-a);return a/=100,[s[i]%1*1.05,s[i+1]%1*1.05,u,a]}tileCoordinatesForInstance(e){const i=16*e,s=this.instancedDataArray.float32;let a=s[i+0];return a=a>it?a-it:a,new Be(Math.trunc(a),Math.trunc(s[i+1]))}translationForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+4],s[i+5],s[i+6]]}rotationScaleForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+7],s[i+8],s[i+9],s[i+10],s[i+11],s[i+12],s[i+13],s[i+14],s[i+15]]}transformForInstance(e){const i=16*e,s=this.instancedDataArray.float32;return[s[i+7],s[i+8],s[i+9],s[i+4],s[i+10],s[i+11],s[i+12],s[i+5],s[i+13],s[i+14],s[i+15],s[i+6],0,0,0,1]}}class og{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,i){}updateAppearances(e,i,s,a){}populate(e,i,s,a){this.tileToMeter=ne(s);const u=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:f,index:_,sourceLayerIndex:g}of e){const v=f!=null?f:h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0,b=Te(h,u);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom,{worldview:this.worldview,activeFloors:i.activeFloors}),b,s))continue;const w={id:v,sourceLayerIndex:g,index:_,geometry:u?b.geometry:Le(h,s,a),properties:h.properties,type:h.type,patterns:{}},I=this.addFeature(w,w.geometry,b);I&&i.featureIndex.insert(h,w.geometry,_,g,this.index,this.instancesPerModel[I].instancedDataArray.length,it/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,i=this.layers[0].scope;let s=0;for(const a of this.modelUris){const u=e.getModel(a,i);if(!u)continue;const h=this.instancesPerModel[a];if(h){const f=.5*Mo(u.aabb.max,u.aabb.min)*h.maxScale+h.maxXYTranslationDistance,_=Math.min(it,Math.max(f/this.tileToMeter,it/32));s=Math.max(_,s)}}return s}update(e,i,s,a){for(const u in this.instancesPerModel){const h=this.instancesPerModel[u];for(const f in e)h.idToFeaturesIndex.hasOwnProperty(f)&&(this.evaluate(h.features[h.idToFeaturesIndex[f]],e[f],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];for(const a of s.features){const u=this.layers[0],h=a.feature,f=this.canonical,_=u.paint.get("model-rotation").evaluate(h,{},f),g=u.paint.get("model-scale").evaluate(h,{},f),v=u.paint.get("model-translation").evaluate(h,{},f);fs(a.rotation,_)&&fs(a.scale,g)&&fs(a.translation,v)||(this.evaluate(a,a.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Sp(this.activeReplacements,u))return!1;this.activeReplacements=u;let h=!1;for(const f in this.instancesPerModel){const _=this.instancesPerModel[f],g=_.instancedDataArray;for(const v of _.features){const b=v.instancedDataOffset,w=v.instancedDataCount;for(let I=0;I<w;I++){const A=16*(I+b);let R=g.float32[A+0];const L=R>it;R=L?R-it:R;const k=Math.floor(R),U=Math.floor(g.float32[A+1]);let G=!1;for(const q of this.activeReplacements)if(!Py(q,s,Gv.Model,a)&&!(q.min.x>k||k>q.max.x||q.min.y>U||U>q.max.y)&&(G=g_(Ly(k,U,e.canonical,q.footprintTileId.canonical),q.footprint),G))break;g.float32[A]=G?R+it:R,h=h||G!==L}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,O1.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,s){const a=this.layers[0],u=a.layout.get("model-id").evaluate(s,{},this.canonical);if(!u)return Mt("modelId is not evaluated for layer ".concat(a.id," and it is not going to get rendered.")),u;(sg(u,!1)||this.styleDefinedModelURLs[u]!==void 0)&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new qv);const h=this.instancesPerModel[u],f=h.instancedDataArray,_=new Hv(s,f.length);for(const g of i)for(const v of g){if(v.x<0||v.x>=it||v.y<0||v.y>=it)continue;if(this.lookupDim!==0){const w=(this.lookupDim-1)/it,I=this.lookupDim*(v.y*w|0)+v.x*w|0;if(this.lookup){if(this.lookup[I]!==0)continue;this.lookup[I]=1}}this.instanceCount++;const b=f.length;f.resize(b+1),h.instancesEvaluatedElevation.push(0),f.float32[16*b]=v.x,f.float32[16*b+1]=v.y}return _.instancedDataCount=h.instancedDataArray.length-_.instancedDataOffset,_.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(_),this.evaluate(_,{},h,!1)),u}getModelUris(){return this.modelUris}evaluate(e,i,s,a){const u=this.layers[0],h=e.feature,f=this.canonical,_=e.rotation=u.paint.get("model-rotation").evaluate(h,i,f),g=e.scale=u.paint.get("model-scale").evaluate(h,i,f),v=e.translation=u.paint.get("model-translation").evaluate(h,i,f),b=Object.assign({},u.paint.get("model-color").evaluate(h,i,f));b.a=u.paint.get("model-color-mix-intensity").evaluate(h,i,f);const w=[];this.maxVerticalOffset<v[2]&&(this.maxVerticalOffset=v[2]);const I=v[0]*v[0]+v[1]*v[1],A=I>0?Math.sqrt(I):0;s.maxScale=Math.max(Math.max(s.maxScale,g[0]),Math.max(g[1],g[2])),s.maxXYTranslationDistance=Math.max(s.maxXYTranslationDistance,A),this.maxScale=Math.max(Math.max(this.maxScale,g[0]),Math.max(g[1],g[2])),vx(w,_,g);const R=Math.round(100*b.a)+b.b/1.05;for(let L=0;L<e.instancedDataCount;++L){const k=e.instancedDataOffset+L,U=16*k,G=s.instancedDataArray.float32;let q=0;a&&(q=G[U+6]-s.instancesEvaluatedElevation[k]);const ie=0|G[U+1];G[U]=(0|G[U])+b.r/1.05,G[U+1]=ie+b.g/1.05,G[U+2]=R,G[U+3]=1/(f.z>10?this.tileToMeter:ne(f,ie)),G[U+4]=v[0],G[U+5]=v[1],G[U+6]=v[2]+q,G[U+7]=w[0],G[U+8]=w[1],G[U+9]=w[2],G[U+10]=w[4],G[U+11]=w[5],G[U+12]=w[6],G[U+13]=w[8],G[U+14]=w[9],G[U+15]=w[10],s.instancesEvaluatedElevation[k]=v[2]}}}let $v,Zv;mt(og,"ModelBucket",{omit:["layers"]}),mt(qv,"PerModelAttributes"),mt(Hv,"ModelFeature");class Ju{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){const a=s||e.findDEMTileFor(i);if(!a||!a.dem)return;const u=a.dem,h=a.tileID,f=1<<i.canonical.z-h.canonical.z;return new Ju(a,u.dim/it/f,[(i.canonical.x/f-h.canonical.x)*u.dim,(i.canonical.y/f-h.canonical.y)*u.dim])}tileCoordToPixel(e,i){const s=i*this._scale+this._offset[1];return new Be(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,i,s,a){const u=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],f=Math.floor(u),_=Math.floor(h),g=this._dem;return a=!!a,s?Vt(Vt(g.get(f,_,a),g.get(f,_+1,a),h-_),Vt(g.get(f+1,_,a),g.get(f+1,_+1,a),h-_),u-f):g.get(f,_,a)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*j(1,e)*this._dem.stride}}const ag=new Float32Array(262144),Dc=new Uint8Array(262144);function Wv(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,Wv(i));return e}function Xv(r,e,i){if(r.meshes)for(const s of r.meshes){if(s.aabb.min[0]===1/0)continue;const a=si.applyTransform(s.aabb,r.globalMatrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(const s of r.children)Xv(s,e,i)}const Yv=["","wall","door","roof","window","lamp","logo"];class Kv{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Wv(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=si.applyTransformFast(s.aabb,this.node.globalMatrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class tm{constructor(e,i,s,a,u,h,f,_){this.id=s,this.layers=e,this.layerIds=this.layers.map((g=>g.fqid)),this.stateDependentLayerIds=this.layers.filter((g=>g.isStateDependent())).map((g=>g.id)),this.modelTraits|=Gu.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Gu.HasMapboxMeshFeatures),u&&(this.modelTraits|=Gu.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.worldview=_,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const g of i)this.nodesInfo.push(new Kv(g)),Xv(g,f.featureIndexArray.length,f.grid),f.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,f.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,i){for(const s of this.getNodesInfo()){const a=s.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}updateAppearances(e,i,s,a){}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const s=i?this.stateDependentLayers:this.layers;if(!On(e,this.states))for(const a of s)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const s of i){const a=s.node;this.uploaded?this.updatePbrBuffer(a):D_(a,e,!0)}for(const s of i)kp(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){const a=e.transform.projectionOptions,u=e.style.getBrightness(),h=this.brightness!==u;if(!this.uploaded||this.dirty||a.name!==this.projection.name||rf(s.paint.get("model-color").value,h)||rf(s.paint.get("model-color-mix-intensity").value,h)||rf(s.paint.get("model-roughness").value,h)||rf(s.paint.get("model-emissive-strength").value,h)||rf(s.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=a,this.brightness=u;const f=this.getNodesInfo();for(const _ of f)_.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const s=this.getNodesInfo(),a=this.id.canonical;for(const u of s){const h=u.feature;u.evaluatedTranslation=i.paint.get("model-translation").evaluate(h,{},a),u.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},a)}}evaluate(e,i){const s=this.getNodesInfo();for(const a of s){if(!a.node.meshes)continue;const u=a.feature,h=i&&i[u.id];if(On(h,a.state))continue;a.state=structuredClone(h);const f=a.node.meshes&&a.node.meshes[0].featureData,_=a.evaluatedColor[2],g=a.evaluatedRMEA[2],v=this.id.canonical;if(a.hasTranslucentParts=!1,f){for(let b=0;b<Yv.length;b++){const w=Yv[b];w.length&&(u.properties.part=w);const I=e.paint.get("model-color").evaluate(u,h,v).toPremultipliedRenderColor(null),A=e.paint.get("model-color-mix-intensity").evaluate(u,h,v);a.evaluatedColor[b]=[I.r,I.g,I.b,A],a.evaluatedRMEA[b][0]=e.paint.get("model-roughness").evaluate(u,h,v),a.evaluatedRMEA[b][2]=e.paint.get("model-emissive-strength").evaluate(u,h,v),a.evaluatedRMEA[b][3]=I.a,a.emissionHeightBasedParams[b]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(u,h,v),!a.hasTranslucentParts&&I.a<1&&(a.hasTranslucentParts=!0)}delete u.properties.part,uT(a,_!==a.evaluatedColor[2]||g!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(u,h,v);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(u,h,v),a.evaluatedScale=e.paint.get("model-scale").evaluate(u,h,v),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,a){const u=e.findDEMTileFor(s);if(u&&(u.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(u.dem&&u.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=u.tileID.overscaledZ;const h=Ju.create(e,s,u);if(!h)return;this.modelTraits&Gu.HasMapboxMeshFeatures&&this.updateDEM(e,h,s,a);for(const f of this.getNodesInfo()){const _=f.node;if(!_.footprint||!_.footprint.vertices||!_.footprint.vertices.length)continue;const g=_.footprint.vertices;let v=h.getElevationAt(g[0].x,g[0].y,!0,!0);for(let b=1;b<g.length;b++)v=Math.min(v,h.getElevationAt(g[b].x,g[b].y,!0,!0));_.elevation=v}}this.terrainTile=u.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,a){let u=i._dem._modifiedForSources[a];if(u===void 0&&(i._dem._modifiedForSources[a]=[],u=i._dem._modifiedForSources[a]),u.includes(s.canonical))return;const h=i._dem.dim;u.push(s.canonical);let f=!1;for(const _ of this.getNodesInfo()){const g=_.node;if(!g.footprint||!g.footprint.grid)continue;const v=g.footprint.grid,b=i.tileCoordToPixel(v.min.x,v.min.y),w=i.tileCoordToPixel(v.max.x,v.max.y),I=Math.min(Math.min(h-w.y,b.x),Math.min(b.y,h-w.x));if(I<0)continue;const A=B(I,2,5);let R=Math.max(0,b.x-A),L=Math.max(0,b.y-A),k=Math.min(w.x+A,h-1),U=Math.min(w.y+A,h-1);for(let J=L;J<=U;++J)for(let se=R;se<=k;++se)Dc[J*h+se]=255;let G=0,q=0;for(let J=0;J<v.cellsY;++J)for(let se=0;se<v.cellsX;++se){if(!v.cells[J*v.cellsX+se])continue;const le=i.tileCoordToPixel(v.min.x+se/v.xScale,v.min.y+J/v.yScale),he=i.tileCoordToPixel(v.min.x+(se+1)/v.xScale,v.min.y+(J+1)/v.yScale);for(let Ce=le.y;Ce<=Math.min(he.y+1,h-1);++Ce)for(let ye=le.x;ye<=Math.min(he.x+1,h-1);++ye)Dc[Ce*h+ye]===255&&(Dc[Ce*h+ye]=0,G+=i.getElevationAtPixel(ye,Ce),q++)}const ie=G/q;R=Math.max(1,b.x-A),L=Math.max(1,b.y-A),k=Math.min(w.x+A,h-2),U=Math.min(w.y+A,h-2),f=!0;for(let J=L;J<=U;++J)for(let se=R;se<=k;++se)Dc[J*h+se]===0&&(ag[J*h+se]=i._dem.set(se,J,ie));for(let J=1;J<A;++J){R=Math.max(1,b.x-J),L=Math.max(1,b.y-J),k=Math.min(w.x+J,h-2),U=Math.min(w.y+J,h-2);for(let se=L;se<=U;++se)for(let le=R;le<=k;++le){const he=se*h+le;if(Dc[he]===255){let Ce=0,ye=0,Pe=-1,ke=-1;for(let Ve=-1;Ve<=1;++Ve)for(let Qe=-1;Qe<=1;++Qe){const qe=(se+Ve)*h+le+Qe;if(Dc[qe]>=J)continue;const Fe=ag[qe],He=Math.abs(Fe);He>ye&&(Ce=Fe,ye=He,Pe=Qe,ke=Ve)}if(ye>.1){const Ve=1-(J+.5*Math.abs(Pe*ke))/A;let Qe=i._dem.get(le,se)+Ce*Ve;const qe=i._dem.get(le+Pe,se+ke),Fe=i._dem.get(le-Pe,se-ke,!0);(Qe-qe)*(Qe-Fe)>0&&(Qe=(qe+Fe)/2),ag[he]=i._dem.set(le,se,Qe),Dc[he]=J}}}}}f&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=Mi.now())}setFilter(e){this.filter=e?xu(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new yr(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)kp(i.node),z_(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped());for(const a of this.getNodesInfo()){const u=a.node.footprint;a.hiddenByReplacement=!!u&&!s.find((h=>h.footprint===u))}}getHeightAtTileCoord(e,i){const s=[],a=[0,0,0],u=Ot([]);for(const h of this.getNodesInfo()){const f=h.node.meshes[0],_=f.transformedAabb;if(e<_.min[0]||i<_.min[1]||e>_.max[0]||i>_.max[1])continue;if(h.node.hidden===!0)return{height:1/0,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};li(u,h.node.globalMatrix),a[0]=e,a[1]=i,dr(a,a,u);const g=(a[0]-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*Cc|0,v=Math.min(63,(a[1]-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*Cc|0)*Cc+Math.min(63,g),b=f.heightmap[v];if(!(b<0&&h.node.footprint))return h.hiddenByReplacement?void 0:{height:b,maxHeight:h.feature.properties.height,hidden:!1,verticalScale:h.evaluatedScale[2]};if(h.node.footprint.grid.query(new Be(e,i),new Be(e,i),s),s.length>0)return{height:void 0,maxHeight:h.feature.properties.height,hidden:h.hiddenByReplacement,verticalScale:h.evaluatedScale[2]}}}}function rf(r,e){return r instanceof pc&&!r.isLightConstant&&e}function cT(r,e,i,s,a,u,h,f){let _=(61440&e|(61440&e)>>4)>>8,g=(3840&e|(3840&e)>>4)>>4,v=240&e|(240&e)>>4;i[3]>0&&(_=Vt(_,255*i[0],i[3]),g=Vt(g,255*i[1],i[3]),v=Vt(v,255*i[2],i[3]));const b=_<<8|g,w=v<<8|Math.floor(255*s[3]),I=(function(J){const se=B(J,0,2);return Math.min(Math.round(.5*se*255),255)})(s[2])<<8|15*s[0]<<4|15*s[1],A=B(a[0],0,1),R=B(a[1],0,1),L=B(a[2],0,1),k=B(a[3],0,1);let U,G,q,ie;if(A!==R&&h!==u&&R!==A){const J=h-u;G=1/(J*(R-A)),q=-(u+J*A)/(J*(R-A));const se=B(a[4],-1,1);ie=Math.pow(10,se),U=255*L<<8|255*k}else U=65535,G=0,q=1,ie=1;if(r.emplaceBack(b,w,I,U,G,q,ie),f){const J=f.length;f.clear();for(let se=0;se<J;se++)f.emplaceBack(b,w,I,U,G,q,ie)}}function uT(r,e,i){const s=r.node;let a=0;const u=i&Gu.HasMeshoptCompression;for(const h of s.meshes){if(s.lights&&s.lightMeshIndex===a||!h.featureData)continue;h.featureArray=new El,h.featureArray.reserve(h.featureData.length);let f=e;for(const _ of h.featureData){const g=u?65535&_:_>>16&65535,v=u?_>>16&65535:65535&_,b=(15&v)<8?15&v:0,w=r.evaluatedRMEA[b],I=r.evaluatedColor[b],A=r.emissionHeightBasedParams[b];let R;if(f&&b===2&&s.lights&&(R=new El,R.resize(10*s.lights.length)),cT(h.featureArray,g,I,w,A,h.aabb.min[2],h.aabb.max[2],R),R&&f){f=!1;const L=s.meshes[s.lightMeshIndex];L.featureArray=R,L.featureArray._trim()}}h.featureArray._trim(),a++}}mt(tm,"Tiled3dModelBucket",{omit:["layers"]}),mt(Kv,"Tiled3dModelFeature");const hT=["id","tile","layer","source","sourceLayer","state"];class zc{constructor(e,i,s,a,u){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=a,this.properties=e?e.properties:{},this.id=u}clone(){const e=new zc(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of hT)this[i]!==void 0&&(e[i]=this[i]);return e}}class Lc extends Vo{constructor(e,i,s,a){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=i,this._modelsInfo=new Map}load(){const e=[];for(const i in this._options.models){const s=this._options.models[i],a=this._modelsInfo.get(i);if(a){const u=a.model;u.position=s.position!=null?new M(s.position[0],s.position[1]):new M(0,0),u.orientation=s.orientation!=null?s.orientation:[0,0,0],a.modelSpec=s,Lc.applyModelSpecification(u,s),u.computeBoundsAndApplyParent(),this.models.push(u)}else{const u=_x(this.map._requestManager.transformRequest(s.uri,Ta.Model).url).then((h=>{if(!h)return;const f=O_(h),_=new bx(i,s.uri,s.position,s.orientation,f);Lc.applyModelSpecification(_,s),_.computeBoundsAndApplyParent(),this.models.push(_),this._modelsInfo.set(i,{modelSpec:s,model:_})})).catch((h=>{this.fire(new Zl(new Error("Could not load model ".concat(i," from ").concat(s.uri,": ").concat(h.message))))}));e.push(u)}}Promise.allSettled(e).then((()=>{this._loaded=!0,this.fire(new $s("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((i=>{this._loaded=!0,this.fire(new Zl(new Error("Could not load models: ".concat(i.message))))}))}static applyModelSpecification(e,i){i.nodeOverrides&&Lc.convertNodeOverrides(e,i.nodeOverrides),i.materialOverrides&&Lc.convertMaterialOverrides(e,i.materialOverrides),i.nodeOverrideNames&&(e.nodeOverrideNames=[...i.nodeOverrideNames]),i.materialOverrideNames&&(e.materialOverrideNames=[...i.materialOverrideNames]),i.featureProperties&&(e.featureProperties=i.featureProperties)}static convertNodeOverrides(e,i){if(Array.isArray(i)&&i.every((s=>typeof s=="string"))){e.nodeOverrideNames=[];for(const s of i)e.nodeOverrideNames.push(s)}else Object.entries(i).forEach((([s,a])=>{const u={orientation:[0,0,0]};if(a.hasOwnProperty("orientation")){const h=a.orientation;h&&(u.orientation=h)}e.nodeOverrides.set(s,u)}))}static convertMaterialOverrides(e,i){if(Array.isArray(i)&&i.every((s=>typeof s=="string"))){e.materialOverrideNames=[];for(const s of i)e.materialOverrideNames.push(s)}else Object.entries(i).forEach((([s,a])=>{const u={color:new Gi(1,1,1),colorMix:0,emissionStrength:0,opacity:1},h=a["model-color"];h!==void 0&&(u.color.r=h[0],u.color.g=h[1],u.color.b=h[2]);const f=a["model-color-mix-intensity"];f!==void 0&&(u.colorMix=f);const _=a["model-emissive-strength"];_!==void 0&&(u.emissionStrength=_);const g=a["model-opacity"];g!==void 0&&(u.opacity=g),e.materialOverrides.set(s,u)}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,i){}serialize(){return this._options}setProperty(e,i){return!1}reload(){const e=ka(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];const i=new Map;for(const s in e){const a=e[s];if(this._modelsInfo.has(s)){const u=this._modelsInfo.get(s);u&&u.modelSpec.uri===a.uri&&i.set(s,u)}}this._modelsInfo=i,this._options.models=e,this._loaded=!1,this.load()}}function lg(r,e,i,s){const a=1<<r.z;e.lat=H((s/it+r.y)/a),e.lng=Z((i/it+r.x)/a)}function dT(r,e,i,s){const a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let u=Number.MAX_VALUE;const h=a.node,f=i.tile,_=s.calculatePosMatrix(f.tileID.toUnwrapped(),s.worldSize),g=a.evaluatedScale;let v=0;s.elevation&&h.elevation&&(v=h.elevation*s.elevation.exaggeration()),gi(_,_,[(h.anchor?h.anchor[0]:0)*(g[0]-1),(h.anchor?h.anchor[1]:0)*(g[1]-1),v]),hi(_,_,g);const b=i.queryGeometry,w=b.isPointQuery()?b.screenBounds:b.screenGeometry,I=function(R){const L=Xt([],_,R.globalMatrix);Xt(L,s.expandedFarZProjMatrix,L);for(let k=0;k<R.meshes.length;++k){const U=R.meshes[k];if(k===R.lightMeshIndex)continue;const G=R_(w,s,L,U.aabb);G!=null&&(u=Math.min(G,u))}if(R.children)for(const k of R.children)I(k)};if(I(h),u===Number.MAX_VALUE)return;const A=new M(0,0);return lg(f.tileID.canonical,A,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:u,position:A,feature:a.feature}}const fT={circle:class extends ys{constructor(r,e,i,s){super(r,{layout:Ko||(Ko=new $r({"circle-sort-key":new ct(ge.layout_circle["circle-sort-key"]),"circle-elevation-reference":new We(ge.layout_circle["circle-elevation-reference"]),visibility:new We(ge.layout_circle.visibility)})),paint:Ml||(Ml=new $r({"circle-radius":new ct(ge.paint_circle["circle-radius"]),"circle-color":new ct(ge.paint_circle["circle-color"]),"circle-blur":new ct(ge.paint_circle["circle-blur"]),"circle-opacity":new ct(ge.paint_circle["circle-opacity"]),"circle-translate":new We(ge.paint_circle["circle-translate"]),"circle-translate-anchor":new We(ge.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new We(ge.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new We(ge.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ct(ge.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ct(ge.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ct(ge.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new We(ge.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new Or(r)}queryRadius(r){const e=r;return Bn("circle-radius",this,e)+Bn("circle-stroke-width",this,e)+Hr(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,a,u,h,f){const _=Al(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),g=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return ry(r,s,u,h,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",_,g)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const s=iy(this);return{config:new Yo(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends ys{createBucket(r){return new sy(r)}constructor(r,e,i,s){super(r,{layout:oy||(oy=new $r({visibility:new We(ge.layout_heatmap.visibility)})),paint:ay||(ay=new $r({"heatmap-radius":new ct(ge.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ct(ge.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new We(ge.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ml(ge.paint_heatmap["heatmap-color"]),"heatmap-opacity":new We(ge.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Sd({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return Bn("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,a,u,h,f){const _=this.paint.get("heatmap-radius").evaluate(e,i);return ry(r,s,u,h,f,!0,!0,new Be(0,0),_)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new Yo(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends ys{constructor(r,e,i,s){super(r,{layout:ly||(ly=new $r({visibility:new We(ge.layout_hillshade.visibility)})),paint:cy||(cy=new $r({"hillshade-illumination-direction":new We(ge.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new We(ge.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new We(ge.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new We(ge.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new We(ge.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new We(ge.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new We(ge.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends ys{constructor(r,e,i,s){super(r,{layout:Sy||(Sy=new $r({"fill-sort-key":new ct(ge.layout_fill["fill-sort-key"]),visibility:new We(ge.layout_fill.visibility),"fill-elevation-reference":new We(ge.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new ct(ge.layout_fill["fill-construct-bridge-guard-rail"])})),paint:Ey||(Ey=new $r({"fill-antialias":new We(ge.paint_fill["fill-antialias"]),"fill-opacity":new ct(ge.paint_fill["fill-opacity"]),"fill-color":new ct(ge.paint_fill["fill-color"]),"fill-outline-color":new ct(ge.paint_fill["fill-outline-color"]),"fill-translate":new We(ge.paint_fill["fill-translate"]),"fill-translate-anchor":new We(ge.paint_fill["fill-translate-anchor"]),"fill-pattern":new ct(ge.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new We(ge.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new We(ge.paint_fill["fill-emissive-strength"]),"fill-z-offset":new ct(ge.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new ct(ge.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new ct(ge.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new Yo(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new p_(r)}queryRadius(){return Hr(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,a,u){return!r.queryGeometry.isAboveHorizon&&Zr(Qs(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends ys{constructor(r,e,i,s){super(r,{layout:Yy||(Yy=new $r({visibility:new We(ge["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new We(ge["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Ky||(Ky=new $r({"fill-extrusion-opacity":new We(ge["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ct(ge["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new We(ge["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new We(ge["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ct(ge["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new We(ge["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new ct(ge["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ct(ge["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new We(ge["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new We(ge["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new We(ge["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new We(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new We(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new We(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new We(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new We(ge["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new We(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new We(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ct(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ct(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new We(ge["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new We(ge["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new We(ge["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new We(ge["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new ct(ge["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new ct(ge["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new We(ge["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Ip(r)}queryRadius(){return Hr(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,a,u,h,f,_){const g=Al(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),v=this.paint.get("fill-extrusion-height").evaluate(e,i),b=this.paint.get("fill-extrusion-base").evaluate(e,i),w=[0,0],I=f&&u.elevation,A=u.elevation?u.elevation.exaggeration():1,R=r.tile.getBucket(this);if(I&&R instanceof Ip){const q=R.centroidVertexArray,ie=_+1;ie<q.length&&(w[0]=q.geta_centroid_pos0(ie),w[1]=q.geta_centroid_pos1(ie))}if(w[0]===0&&w[1]===1)return!1;u.projection.name==="globe"&&(s=Xy([s],[new Be(0,0),new Be(it,it)],r.tileID.canonical).map((q=>q.polygon)).flat());const L=I?f:null,[k,U]=nx(u,s,b,v,g,h,L,w,A,u.center.lat,r.tileID.canonical),G=r.queryGeometry;return rx(k,U,G.isPointQuery()?G.screenBounds:G.screenGeometry)}},building:class extends ys{constructor(r,e,i,s){super(r,{layout:Cx||(Cx=new $r({visibility:new We(ge.layout_building.visibility),"building-facade":new ct(ge.layout_building["building-facade"]),"building-facade-floors":new ct(ge.layout_building["building-facade-floors"]),"building-facade-unit-width":new ct(ge.layout_building["building-facade-unit-width"]),"building-facade-window":new ct(ge.layout_building["building-facade-window"]),"building-roof-shape":new ct(ge.layout_building["building-roof-shape"]),"building-height":new ct(ge.layout_building["building-height"]),"building-base":new ct(ge.layout_building["building-base"]),"building-flood-light-wall-radius":new ct(ge.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new ct(ge.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new ct(ge.layout_building["building-flip-roof-orientation"])})),paint:Px||(Px=new $r({"building-opacity":new We(ge.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new We(ge.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new We(ge.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new We(ge.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new We(ge.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new We(ge.paint_building["building-vertical-scale"]),"building-cast-shadows":new We(ge.paint_building["building-cast-shadows"]),"building-color":new ct(ge.paint_building["building-color"]),"building-emissive-strength":new ct(ge.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new We(ge.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new We(ge.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new We(ge.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new We(ge.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new We(ge.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Mx(r)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}queryRadius(r){return 0}queryIntersectsFeature(r,e,i,s,a,u,h,f,_){let g=this.layout.get("building-height").evaluate(e,i);const v=this.layout.get("building-base").evaluate(e,i),b=r.tile.getBucket(this).getFootprint(e);if(b){if(b.hiddenFlags!==0)return!1;g=b.height}const[w,I]=nx(u,s,v,g,new Be(0,0),h,null,[0,0],1,u.center.lat,r.tileID.canonical),A=r.queryGeometry;return rx(w,I,A.isPointQuery()?A.screenBounds:A.screenGeometry)}},line:class extends ys{constructor(r,e,i,s){const a=Vx();super(r,a,e,i,s),a.layout&&(this.layout=new Oa(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof lc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Ud)return Ud;const i=Vx();return Ud=new cw(i.paint.properties["line-width"].specification),Ud.useIntegerZoom=!0,Ud})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new F_(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const s=Bx(this);return{config:new Yo(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){const e=r,i=Ux(Bn("line-width",this,e),Bn("line-gap-width",this,e)),s=Bn("line-offset",this,e);return i/2+Math.abs(s)+Hr(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,a,u){if(r.queryGeometry.isAboveHorizon)return!1;const h=Qs(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),u.angle,r.pixelToTileUnitsFactor),f=r.pixelToTileUnitsFactor/2*Ux(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),_=this.paint.get("line-offset").evaluate(e,i);return _&&(s=(function(g,v){const b=[],w=new Be(0,0);for(let I=0;I<g.length;I++){const A=g[I],R=[];for(let L=0;L<A.length;L++){const k=A[L],U=A[L+1],G=L===0?w:k.sub(A[L-1])._unit()._perp(),q=L===A.length-1?w:U.sub(k)._unit()._perp(),ie=G._add(q)._unit();ie._mult(1/(ie.x*q.x+ie.y*q.y)),R.push(ie._mult(v)._add(k))}b.push(R)}return b})(s,_*r.pixelToTileUnitsFactor)),(function(g,v,b){for(let w=0;w<v.length;w++){const I=v[w];if(g.length>=3){for(let A=0;A<I.length;A++)if(Fn(g,I[A]))return!0}if(Ds(g,I,b))return!0}return!1})(h,s,f)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:Kp,background:class extends ys{constructor(r,e,i,s){super(r,{layout:Pv||(Pv=new $r({visibility:new We(ge.layout_background.visibility)})),paint:Rv||(Rv=new $r({"background-pitch-alignment":new We(ge.paint_background["background-pitch-alignment"]),"background-color":new We(ge.paint_background["background-color"]),"background-pattern":new We(ge.paint_background["background-pattern"]),"background-opacity":new We(ge.paint_background["background-opacity"]),"background-emissive-strength":new We(ge.paint_background["background-emissive-strength"]),"background-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:kv,"raster-particle":jv,sky:class extends ys{constructor(r,e,i,s){super(r,{layout:Nv||(Nv=new $r({visibility:new We(ge.layout_sky.visibility)})),paint:Vv||(Vv=new $r({"sky-type":new We(ge.paint_sky["sky-type"]),"sky-atmosphere-sun":new We(ge.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new We(ge.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new We(ge.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new We(ge.paint_sky["sky-gradient-radius"]),"sky-gradient":new ml(ge.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new We(ge.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new We(ge.paint_sky["sky-atmosphere-color"]),"sky-opacity":new We(ge.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Sd({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){const s=this.paint.get("sky-atmosphere-sun"),a=!s,u=r.style.light,h=u.properties.get("position");return a&&u.properties.get("anchor")==="viewport"&&Mt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?ng(h.azimuthal,90-h.polar,e):ng(s[0],90-s[1],e)}const i=this.paint.get("sky-gradient-center");return ng(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends ys{constructor(r,e,i,s){super(r,{paint:Uv||(Uv=new $r({}))},e,null)}},model:class extends ys{constructor(r,e,i,s){super(r,{layout:$v||($v=new $r({visibility:new We(ge.layout_model.visibility),"model-id":new ct(ge.layout_model["model-id"])})),paint:Zv||(Zv=new $r({"model-opacity":new ct(ge.paint_model["model-opacity"]),"model-rotation":new ct(ge.paint_model["model-rotation"]),"model-scale":new ct(ge.paint_model["model-scale"]),"model-translation":new ct(ge.paint_model["model-translation"]),"model-color":new ct(ge.paint_model["model-color"]),"model-color-mix-intensity":new ct(ge.paint_model["model-color-mix-intensity"]),"model-type":new We(ge.paint_model["model-type"]),"model-cast-shadows":new We(ge.paint_model["model-cast-shadows"]),"model-receive-shadows":new We(ge.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new We(ge.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ct(ge.paint_model["model-emissive-strength"]),"model-roughness":new ct(ge.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ct(ge.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new We(ge.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new We(ge.paint_model["model-front-cutoff"]),"model-elevation-reference":new We(ge.paint_model["model-elevation-reference"]),"model-color-use-theme":new ct({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this.layer=r,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new og(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof tm?it-1:0}queryRenderedFeatures(r,e,i){const s=e.getSource();if(!(s&&s instanceof Lc))return{};const a=s,u={};u[this.id]=[];const h=u[this.id];let f=0;for(const _ of a.models){const g=e.getFeatureState(this.sourceLayer,_.id),v={type:"Unknown",id:_.id,properties:_.featureProperties},b=this.paint.get("model-rotation").evaluate(v,g),w=this.paint.get("model-scale").evaluate(v,g),I=this.paint.get("model-translation").evaluate(v,g),A=this.paint.get("model-elevation-reference");let R=[];Op(R,_,i,_.position,b,w,I,A==="ground",A==="ground",!1),i.projection.name==="globe"&&(R=Lp(R,i));const L=Xt([],i.projMatrix,R),k=R_(r.isPointQuery()?r.screenBounds:r.screenGeometry,i,L,_.aabb);if(k!=null){const U=new zc(void 0,0,0,0,_.id);U.layer=this.layer,U.properties=structuredClone(_.featureProperties),U.properties.layer=this.id,U.properties.uri=_.uri,U.properties.orientation=_.orientation,U.sourceLayer=this.sourceLayer,U.geometry={type:"Point",coordinates:[_.position.lng,_.position.lat]},U.state=g,U.source=this.source,h.push({featureIndex:f,feature:U,intersectionZ:k})}++f}return u}queryIntersectsFeature(r,e,i,s,a,u){if(!this.modelManager)return!1;const h=this.modelManager,f=r.tile.getBucket(this);if(!(f&&f instanceof og))return!1;for(const _ in f.instancesPerModel){const g=f.instancesPerModel[_],v=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(g.idToFeaturesIndex.hasOwnProperty(v)){const b=g.features[g.idToFeaturesIndex[v]],w=h.getModel(_,this.scope);if(!w)return!1;let I=[];const A=new M(0,0),R=f.canonical;let L=Number.MAX_VALUE;for(let k=0;k<b.instancedDataCount;++k){const U=16*(b.instancedDataOffset+k),G=g.instancedDataArray.float32,q=[G[U+4],G[U+5],G[U+6]];lg(R,A,Math.floor(G[U]),Math.floor(G[U+1])),Op(I,w,u,A,b.rotation,b.scale,q,!1,!1,!1),u.projection.name==="globe"&&(I=Lp(I,u));const ie=Xt([],u.projMatrix,I),J=r.queryGeometry,se=R_(J.isPointQuery()?J.screenBounds:J.screenGeometry,u,ie,w.aabb);se!=null&&(L=Math.min(se,L))}return L!==Number.MAX_VALUE&&L}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof ca}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ys{constructor(r,e,i,s){super(r,{layout:Iy||(Iy=new $r({"clip-layer-types":new We(ge.layout_clip["clip-layer-types"]),"clip-layer-scope":new We(ge.layout_clip["clip-layer-scope"])})),paint:Ay||(Ay=new $r({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new My(r)}is3D(r){return!0}}},cg=new Gi(0,0,0),ug={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},hg={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},im={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},pT={PAINT_ORDER_FILL_AND_STROKE:1},nf={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Jv={MASK_TYPE_LUMINANCE:1};function mT(r,e,i){r===1&&e.icons.push((function(s,a){return(function(u){if(u.usvg_tree.height||(u.usvg_tree.height=u.usvg_tree.width),!u.metadata)return u;const{metadata:h}=u;if(h.content_area){const{content_area:f}=h;f.left==null&&(f.left=0),f.top==null&&(f.top=f.left),f.width==null&&(f.width=u.usvg_tree.width),f.height==null&&(f.height=f.width)}if(h.text_placeholder){const{text_placeholder:f}=h;f.top==null&&(f.top=f.left),f.height==null&&(f.height=f.width)}return h.stretch_x&&h.stretch_x.length&&Qv(h,"x"),h.stretch_y&&h.stretch_y.length&&Qv(h,"y"),u})(s.readFields(_T,{name:void 0},a))})(i,i.readVarint()+i.pos))}function Qv(r,e){const i=[],s=r["stretch_".concat(e)];let a=null;for(let u=0;u<s.length;u++)a===null?a=i.length===0?s[0]:i[i.length-1][1]+s[u]:(i.push([a,a+s[u]]),a=null);r["stretch_".concat(e,"_areas")]=i}function _T(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=(function(s,a){return s.readFields(gT,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)})(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=(function(s,a){return s.readFields(vT,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)})(i,i.readVarint()+i.pos),e.data="usvg_tree")}function gT(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=e0(i,i.readVarint()+i.pos):r===4?e.variables.push((function(s,a){return s.readFields(xT,{name:void 0},a)})(i,i.readVarint()+i.pos)):r===5&&(e.text_placeholder=e0(i,i.readVarint()+i.pos))}function e0(r,e){return r.readFields(yT,{},e)}function yT(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function xT(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=sm(i.readVarint()),e.value="rgb_color")}function vT(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(rm(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push((function(s,a){return s.readFields(AT,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)})(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push((function(s,a){return s.readFields(CT,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)})(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push((function(s,a){return s.readFields(PT,{children:[]},a)})(i,i.readVarint()+i.pos)):r===8&&e.masks.push((function(s,a){const u=s.readFields(RT,{left:0,width:20,mask_type:Jv.MASK_TYPE_LUMINANCE,children:[]},a);return u.height==null&&(u.height=u.width),u.top==null&&(u.top=u.left),u})(i,i.readVarint()+i.pos))}function rm(r,e){return r.readFields(bT,{},e)}function bT(r,e,i){r===1?(e.group=(function(s,a){return s.readFields(wT,{opacity:255,children:[]},a)})(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=(function(s,a){return s.readFields(ST,{paint_order:1,commands:[],step:1,diffs:[],rule:ug.PATH_RULE_NON_ZERO},a)})(i,i.readVarint()+i.pos),e.node="path")}function wT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(rm(i,i.readVarint()+i.pos))}function nm(r,e){return r.readFields(TT,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function TT(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function ST(r,e,i){r===1?e.fill=(function(s,a){return s.readFields(ET,{rgb_color:cg,paint:"rgb_color",opacity:255},a)})(i,i.readVarint()+i.pos):r===2?e.stroke=(function(s,a){return s.readFields(IT,{rgb_color:cg,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)})(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function ET(r,e,i){r===1?(e.rgb_color=sm(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function sm(r){return new Gi((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function IT(r,e,i){r===1?(e.rgb_color=sm(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function AT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(t0(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function t0(r,e){return r.readFields(MT,{offset:0,opacity:255,rgb_color:cg},e)}function MT(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=sm(i.readVarint()))}function CT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(t0(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function PT(r,e,i){r===1?e.transform=nm(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(rm(i,i.readVarint()+i.pos))}function RT(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(rm(i,i.readVarint()+i.pos))}class DT{static calculate(e={},i=[]){const s=new Map,a=new Map;if(Object.keys(e).length===0)return s;i.forEach((u=>{a.set(u.name,u.rgb_color||new Gi(0,0,0))}));for(const[u,h]of Object.entries(e))a.has(u)?s.set(a.get(u).toString(),h):console.warn('Ignoring unknown image variable "'.concat(u,'"'));return s}}function Qu(r,e=255,i){const s=e/255,a=r.toString(),u=i.has(a)?i.get(a).clone():r.clone();return u.a*=s,u.toString()}function sf(r,e){if(!Ut()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function zT(r,e){const i=DT.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,a=s.width,u=s.height,h=e.transform?e.transform:new DOMMatrix,f=Math.max(1,Math.round(a*h.a)),_=Math.max(1,Math.round(u*h.d)),g=new DOMMatrix([f/a,0,0,_/u,0,0]),v=sf(f,_).getContext("2d");return dg(v,g,s,s,i),v.getImageData(0,0,f,_)}function dg(r,e,i,s,a){for(const u of s.children)i0(r,e,i,u,a)}function i0(r,e,i,s,a){s.group?(r.save(),(function(u,h,f,_,g){const v=_.mask_idx!=null?f.masks[_.mask_idx]:null,b=_.clip_path_idx!=null?f.clip_paths[_.clip_path_idx]:null;if(_.transform&&(h=eh(_.transform).preMultiplySelf(h)),!(function(A,R,L){return A.opacity!==255||R||L})(_,b!=null,v!=null))return void dg(u,h,f,_,g);const w=sf(u.canvas.width,u.canvas.height),I=w.getContext("2d");dg(I,h,f,_,g),b&&c0(I,h,f,b),v&&u0(I,h,f,v,g),u.globalAlpha=_.opacity/255,u.drawImage(w,0,0)})(r,e,i,s.group,a),r.restore()):s.path&&(r.save(),(function(u,h,f,_,g){u.setTransform(h),_.paint_order===pT.PAINT_ORDER_FILL_AND_STROKE?(r0(u,f,_,g),s0(u,f,_,g)):(s0(u,f,_,g),r0(u,f,_,g))})(r,e,i,s.path,a),r.restore())}function r0(r,e,i,s){const a=i.fill;if(!a)return;const u=a.opacity/255;switch(r.save(),r.beginPath(),h0(i,r),a.paint){case"rgb_color":r.fillStyle=Qu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":{const h=e.linear_gradients[a.linear_gradient_idx];h.transform&&r.setTransform(eh(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=o0(r,h,u,s);break}case"radial_gradient_idx":{const h=e.radial_gradients[a.radial_gradient_idx];h.transform&&r.setTransform(eh(h.transform).preMultiplySelf(r.getTransform())),r.fillStyle=a0(r,h,u,s)}}r.fill(n0(i)),r.restore()}function n0(r){return r.rule===ug.PATH_RULE_NON_ZERO?"nonzero":r.rule===ug.PATH_RULE_EVEN_ODD?"evenodd":void 0}function s0(r,e,i,s){const a=i.stroke;if(!a)return;const u=d0(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Qu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=o0(r,e.linear_gradients[a.linear_gradient_idx],h,s,!0);break;case"radial_gradient_idx":r.strokeStyle=a0(r,e.radial_gradients[a.radial_gradient_idx],h,s,!0)}switch(a.linejoin){case im.LINE_JOIN_MITER_CLIP:case im.LINE_JOIN_MITER:r.lineJoin="miter";break;case im.LINE_JOIN_ROUND:r.lineJoin="round";break;case im.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case hg.LINE_CAP_BUTT:r.lineCap="butt";break;case hg.LINE_CAP_ROUND:r.lineCap="round";break;case hg.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(u)}function o0(r,e,i,s,a=!1){if(e.stops.length===1){const w=e.stops[0];return Qu(w.rgb_color,w.opacity*i,s)}const{x1:u,y1:h,x2:f,y2:_}=e;let g=new DOMPoint(u,h),v=new DOMPoint(f,_);if(a){const w=eh(e.transform);g=w.transformPoint(g),v=w.transformPoint(v)}const b=r.createLinearGradient(g.x,g.y,v.x,v.y);for(const w of e.stops)b.addColorStop(w.offset,Qu(w.rgb_color,w.opacity*i,s));return b}function a0(r,e,i,s,a=!1){if(e.stops.length===1){const k=e.stops[0];return Qu(k.rgb_color,k.opacity*i,s)}const u=eh(e.transform),{fx:h,fy:f,fr:_,cx:g,cy:v,r:b}=e;let w=new DOMPoint(h,f),I=new DOMPoint(g,v),A=_,R=b;if(a){w=u.transformPoint(w),I=u.transformPoint(I);const k=(u.a+u.d)/2;A=_*k,R=e.r*k}const L=r.createRadialGradient(w.x,w.y,A,I.x,I.y,R);for(const k of e.stops)L.addColorStop(k.offset,Qu(k.rgb_color,k.opacity*i,s));return L}function l0(r,e,i,s){const a=s.transform?eh(s.transform).preMultiplySelf(e):e,u=sf(r.canvas.width,r.canvas.height),h=u.getContext("2d");for(const _ of s.children)if(_.group)l0(h,a,i,_.group);else if(_.path){const g=_.path,v=new Path2D;v.addPath(d0(g),a),h.fill(v,n0(g))}const f=s.clip_path_idx!=null?i.clip_paths[s.clip_path_idx]:null;f&&c0(h,a,i,f),r.globalCompositeOperation="source-over",r.drawImage(u,0,0)}function c0(r,e,i,s){const a=sf(r.canvas.width,r.canvas.height);l0(a.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function u0(r,e,i,s,a){if(s.children.length===0)return;const u=s.mask_idx!=null?i.masks[s.mask_idx]:null;u&&u0(r,e,i,u,a);const h=r.canvas.width,f=r.canvas.height,_=sf(h,f),g=_.getContext("2d"),v=s.width,b=s.height,w=s.left,I=s.top,A=new Path2D,R=new Path2D;R.rect(w,I,v,b),A.addPath(R,e),g.clip(A);for(const U of s.children)i0(g,e,i,U,a);const L=g.getImageData(0,0,h,f),k=L.data;if(s.mask_type===Jv.MASK_TYPE_LUMINANCE)for(let U=0;U<k.length;U+=4)k[U+3]=k[U+3]/255*(.2126*k[U]+.7152*k[U+1]+.0722*k[U+2]);g.putImageData(L,0,0),r.globalCompositeOperation="destination-in",r.drawImage(_,0,0)}function eh(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function h0(r,e){const i=r.step;let s=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(s,a);for(let u=0,h=2;u<r.commands.length;u++)switch(r.commands[u]){case nf.PATH_COMMAND_MOVE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.moveTo(s,a);break;case nf.PATH_COMMAND_LINE:s+=r.diffs[h++]*i,a+=r.diffs[h++]*i,e.lineTo(s,a);break;case nf.PATH_COMMAND_QUAD:{const f=s+r.diffs[h++]*i,_=a+r.diffs[h++]*i;s=f+r.diffs[h++]*i,a=_+r.diffs[h++]*i,e.quadraticCurveTo(f,_,s,a);break}case nf.PATH_COMMAND_CUBIC:{const f=s+r.diffs[h++]*i,_=a+r.diffs[h++]*i,g=f+r.diffs[h++]*i,v=_+r.diffs[h++]*i;s=g+r.diffs[h++]*i,a=v+r.diffs[h++]*i,e.bezierCurveTo(f,_,g,v,s,a);break}case nf.PATH_COMMAND_CLOSE:e.closePath()}return e}function d0(r){return h0(r,new Path2D)}class om{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}mt(om,"LRUCache");class fg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new us(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new om(150)),this.cacheMap.get(s).get(ka(e.toString(),i))}setInCache(e,i,s,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new om(150));const u=this.cacheDependenciesMap.get(a),h=ka(e.id.toString(),s);u.get(h)||u.set(h,new Set);const f=this.cacheMap.get(a),_=e.toString();u.get(h).add(_),f.put(ka(e.toString(),s),i)}removeImagesFromCacheByIds(e,i,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;const a=this.cacheMap.get(s),u=this.cacheDependenciesMap.get(s);for(const h of e){const f=ka(h.toString(),i);if(u.has(f)){for(const _ of u.get(f))a.delete(_);u.delete(f)}}}rasterize(e,i,s,a,u=zT){const h=this.getFromCache(e,s,a);if(h)return h.clone();const f=u(i.icon,e.options),_=fg._getImage(f);return this.setInCache(e,_,s,a),_.clone()}}class f0{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function p0(r,e,i,s){let a=0,u=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(s[h])<1e-15){if(i[h]<r[h]||i[h]>e[h])return null}else{const f=1/s[h];let _=(r[h]-i[h])*f,g=(e[h]-i[h])*f;if(_>g){const v=_;_=g,g=v}if(_>a&&(a=_),g<u&&(u=g),a>u)return null}return a}function m0(r,e,i,s,a,u,h,f,_,g,v){const b=s-r,w=a-e,I=u-i,A=h-r,R=f-e,L=_-i,k=v[1]*L-v[2]*R,U=v[2]*A-v[0]*L,G=v[0]*R-v[1]*A,q=b*k+w*U+I*G;if(Math.abs(q)<1e-15)return null;const ie=1/q,J=g[0]-r,se=g[1]-e,le=g[2]-i,he=(J*k+se*U+le*G)*ie;if(he<0||he>1)return null;const Ce=se*I-le*w,ye=le*b-J*I,Pe=J*w-se*b,ke=(v[0]*Ce+v[1]*ye+v[2]*Pe)*ie;return ke<0||he+ke>1?null:(A*Ce+R*ye+L*Pe)*ie}function _0(r,e,i){return(r-e)/(i-e)}function g0(r,e,i,s,a,u,h,f,_){const g=1<<i,v=u-s,b=h-a,w=(r+1)/g*v+s,I=(e+0)/g*b+a,A=(e+1)/g*b+a;f[0]=(r+0)/g*v+s,f[1]=I,_[0]=w,_[1]=A}class y0{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=(function(u){const h=Math.ceil(Math.log2(u.dim/8)),f=[];let _=Math.ceil(Math.pow(2,h));const g=1/_,v=(I,A,R,L,k)=>{const U=L?1:0,G=(I+1)*R-U,q=A*R,ie=(A+1)*R-U;k[0]=I*R,k[1]=q,k[2]=G,k[3]=ie};let b=new f0(_);const w=[];for(let I=0;I<_*_;I++){v(I%_,Math.floor(I/_),g,!1,w);const A=Ol(w[0],w[1],u),R=Ol(w[2],w[1],u),L=Ol(w[2],w[3],u),k=Ol(w[0],w[3],u);b.minimums.push(Math.min(A,R,L,k)),b.maximums.push(Math.max(A,R,L,k)),b.leaves.push(1)}for(f.push(b),_/=2;_>=1;_/=2){const I=f[f.length-1];b=new f0(_);for(let A=0;A<_*_;A++){v(A%_,Math.floor(A/_),2,!0,w);const R=I.getElevation(w[0],w[1]),L=I.getElevation(w[2],w[1]),k=I.getElevation(w[2],w[3]),U=I.getElevation(w[0],w[3]),G=I.isLeaf(w[0],w[1]),q=I.isLeaf(w[2],w[1]),ie=I.isLeaf(w[2],w[3]),J=I.isLeaf(w[0],w[3]),se=Math.min(R.min,L.min,k.min,U.min),le=Math.max(R.max,L.max,k.max,U.max),he=G&&q&&ie&&J;b.maximums.push(le),b.minimums.push(se),b.leaves.push(le-se<=5&&he?1:0)}f.push(b)}return f})(this.dem),s=i.length-1,a=i[s];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,a,u,h,f=1){return p0([e,i,-100],[s,a,this.maximums[0]*f],u,h)}raycast(e,i,s,a,u,h,f=1){if(!this.nodeCount)return null;const _=this.raycastRoot(e,i,s,a,u,h,f);if(_==null)return null;const g=[],v=[],b=[],w=[],I=[{idx:0,t:_,nodex:0,nodey:0,depth:0}];for(;I.length>0;){const{idx:A,t:R,nodex:L,nodey:k,depth:U}=I.pop();if(this.leaves[A]){g0(L,k,U,e,i,s,a,b,w);const q=1<<U,ie=(L+0)/q,J=(L+1)/q,se=(k+0)/q,le=(k+1)/q,he=Ol(ie,se,this.dem)*f,Ce=Ol(J,se,this.dem)*f,ye=Ol(J,le,this.dem)*f,Pe=Ol(ie,le,this.dem)*f,ke=m0(b[0],b[1],he,w[0],b[1],Ce,w[0],w[1],ye,u,h),Ve=m0(w[0],w[1],ye,b[0],w[1],Pe,b[0],b[1],he,u,h),Qe=Math.min(ke!==null?ke:Number.MAX_VALUE,Ve!==null?Ve:Number.MAX_VALUE);if(Qe!==Number.MAX_VALUE)return Qe;{const qe=ns([],u,h,R);if(x0(he,Ce,Pe,ye,_0(qe[0],b[0],w[0]),_0(qe[1],b[1],w[1]))>=qe[2])return R}continue}let G=0;for(let q=0;q<this._siblingOffset.length;q++){g0((L<<1)+this._siblingOffset[q][0],(k<<1)+this._siblingOffset[q][1],U+1,e,i,s,a,b,w),b[2]=-100,w[2]=this.maximums[this.childOffsets[A]+q]*f;const ie=p0(b,w,u,h);if(ie!=null){const J=ie;g[q]=J;let se=!1;for(let le=0;le<G&&!se;le++)J>=g[v[le]]&&(v.splice(le,0,q),se=!0);se||(v[G]=q),G++}}for(let q=0;q<G;q++){const ie=v[q];I.push({idx:this.childOffsets[A]+ie,t:g[ie],nodex:(L<<1)+this._siblingOffset[ie][0],nodey:(k<<1)+this._siblingOffset[ie][1],depth:U+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,a,u){if(e[a].isLeaf(i,s)===1)return;this.childOffsets[u]||(this.childOffsets[u]=this.nodeCount);const h=a-1,f=e[h];let _=0,g=0;for(let v=0;v<this._siblingOffset.length;v++){const b=2*i+this._siblingOffset[v][0],w=2*s+this._siblingOffset[v][1],I=f.getElevation(b,w),A=f.isLeaf(b,w),R=this._addNode(I.min,I.max,A);A&&(_|=1<<v),g||(g=R)}for(let v=0;v<this._siblingOffset.length;v++)_&1<<v||this._construct(e,2*i+this._siblingOffset[v][0],2*s+this._siblingOffset[v][1],h,g+v)}}function x0(r,e,i,s,a,u){return Vt(Vt(r,i,u),Vt(e,s,u),a)}function Ol(r,e,i){const s=i.dim,a=B(r*s-.5,0,s-1),u=B(e*s-.5,0,s-1),h=Math.floor(a),f=Math.floor(u),_=Math.min(h+1,s-1),g=Math.min(f+1,s-1);return x0(i.get(h,f),i.get(_,f),i.get(h,g),i.get(_,g),a-h,u-f)}const LT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function OT(r,e,i){return(256*r*256+256*e+i)/10-1e4}function kT(r,e,i){return 256*r+e+i/256-32768}class am{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void Mt('"'.concat(s,'" is not a valid encoding type. Valid types include "mapbox" and "terrarium".'));this.stride=i.height;const u=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let _=0;_<u;_++)h[this._idx(-1,_)]=h[this._idx(0,_)],h[this._idx(u,_)]=h[this._idx(u-1,_)],h[this._idx(_,-1)]=h[this._idx(_,0)],h[this._idx(_,u)]=h[this._idx(_,u-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(u,-1)]=h[this._idx(u-1,0)],h[this._idx(-1,u)]=h[this._idx(0,u-1)],h[this._idx(u,u)]=h[this._idx(u-1,u-1)]}const f=s==="terrarium"?kT:OT;for(let _=0;_<h.length;++_){const g=4*_;this.floatView[_]=f(this.pixels[g],this.pixels[g+1],this.pixels[g+2])}this._timestamp=Mi.now()}_buildQuadTree(){this._tree=new y0(this)}get(e,i,s=!1){s&&(e=B(e,-1,this.dim),i=B(i,-1,this.dim));const a=this._idx(e,i);return this.floatView[a]}set(e,i,s){const a=this._idx(e,i),u=this.floatView[a];return this.floatView[a]=s,s-u}static getUnpackVector(e){return LT[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const s=[0,0,0,0],a=am.getUnpackVector(i);let u=Math.floor((e+a[3])/a[2]);return s[2]=u%256,u=Math.floor(u/256),s[1]=u%256,u=Math.floor(u/256),s[0]=u,s}getPixels(){return new dy({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,u=i*this.dim+this.dim,h=s*this.dim,f=s*this.dim+this.dim;switch(i){case-1:a=u-1;break;case 1:u=a+1}switch(s){case-1:h=f-1;break;case 1:f=h+1}const _=-i*this.dim,g=-s*this.dim;for(let v=h;v<f;v++)for(let b=a;b<u;b++){const w=4*this._idx(b,v),I=4*this._idx(b+_,v+g);this.pixels[w+0]=e.pixels[I+0],this.pixels[w+1]=e.pixels[I+1],this.pixels[w+2]=e.pixels[I+2],this.pixels[w+3]=e.pixels[I+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function FT(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push((function(s,a){return s.readFields(jT,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)})(i,i.readVarint()+i.pos))}function BT(r,e,i){r===1?(e.delta_filter=(function(s,a){return s.readFields(NT,{blockSize:0},a)})(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function NT(r,e,i){r===1&&(e.blockSize=i.readVarint())}function VT(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function UT(r,e,i){let s=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push((function(u,h){return u.readFields(BT,{},h)})(i,i.readVarint()+i.pos)):r===4?e.codec=(function(u,h){return u.readFields(VT,{},h)})(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?s=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=s)}function jT(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push((function(s,a){return s.readFields(UT,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)})(i,i.readVarint()+i.pos))}function GT(r,e,i){if(r===2)(function(s,a,u){s.readFields(HT,u,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function HT(r,e,i){if(r===1){let s=0;const a=i.readVarint()+i.pos;for(;i.pos<a;)e[s++]=i.readVarint()}}function qT(r,e){if(e.length!==4)throw new Error("Expected data of dimension 4 but got ".concat(e.length,"."));let i=e[3];for(let s=2;s>=1;s--){const a=s===1?1:0,u=s===2?1:0;for(let h=0;h<e[0];h++){const f=e[1]*h;for(let _=a;_<e[1];_++){const g=e[2]*(_+f);for(let v=u;v<e[2];v++){const b=e[3]*(v+g);for(let w=0;w<e[3];w++){const I=b+w;r[I]+=r[I-i]}}}}i*=e[s]}return r}function $T(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function ZT(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const s=r[i],a=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&a)<<4|61440&a,r[i+1]=15&s|(3840&s)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const s=r[i],a=r[i+1],u=r[i+2],h=r[i+3];r[i+0]=(192&s)>>6|(192&a)>>4|(192&u)>>2|192&h,r[i+1]=(48&s)>>4|(48&a)>>2|48&u|(48&h)<<2,r[i+2]=(12&s)>>2|12&a|(12&u)<<2|(12&h)<<4,r[i+3]=3&s|(3&a)<<2|(3&u)<<4|(3&h)<<6}return r;default:throw new Error('Invalid pixel format, "'.concat(e,'"'))}}mt(am,"DEMData"),mt(y0,"DemMinMaxQuadTree",{omit:["dem"]});var Eo=Uint8Array,of=Uint16Array,WT=Int32Array,v0=new Eo([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),b0=new Eo([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),XT=new Eo([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),w0=function(r,e){for(var i=new of(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var a=new WT(i[30]);for(s=1;s<30;++s)for(var u=i[s];u<i[s+1];++u)a[u]=u-i[s]<<5|s;return{b:i,r:a}},T0=w0(v0,2),S0=T0.b,YT=T0.r;S0[28]=258,YT[258]=28;for(var KT=w0(b0,0).b,E0=new of(32768),Mn=0;Mn<32768;++Mn){var th=(43690&Mn)>>1|(21845&Mn)<<1;E0[Mn]=((65280&(th=(61680&(th=(52428&th)>>2|(13107&th)<<2))>>4|(3855&th)<<4))>>8|(255&th)<<8)>>1}var af=function(r,e,i){for(var s=r.length,a=0,u=new of(e);a<s;++a)r[a]&&++u[r[a]-1];var h,f=new of(e);for(a=1;a<e;++a)f[a]=f[a-1]+u[a-1]<<1;h=new of(1<<e);var _=15-e;for(a=0;a<s;++a)if(r[a])for(var g=a<<4|r[a],v=e-r[a],b=f[r[a]-1]++<<v,w=b|(1<<v)-1;b<=w;++b)h[E0[b]>>_]=g;return h},lf=new Eo(288);for(Mn=0;Mn<144;++Mn)lf[Mn]=8;for(Mn=144;Mn<256;++Mn)lf[Mn]=9;for(Mn=256;Mn<280;++Mn)lf[Mn]=7;for(Mn=280;Mn<288;++Mn)lf[Mn]=8;var I0=new Eo(32);for(Mn=0;Mn<32;++Mn)I0[Mn]=5;var JT=af(lf,9),QT=af(I0,5),pg=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},ta=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},mg=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},e2=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ia=function(r,e,i){var s=new Error(e||e2[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,ia),!i)throw s;return s},t2=new Eo(0),i2=typeof TextDecoder<"u"&&new TextDecoder;try{i2.decode(t2,{stream:!0})}catch(r){}const r2={gzip_data:"gzip"};class Bo extends Error{constructor(e){super(e),this.name="MRTError"}}const n2={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},A0={uint32:1,uint16:2,uint8:4},s2={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let _g;class lm{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new Bo("Layer '".concat(e,"' not found"));return i}getHeaderLength(e){const i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new Bo("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new Bo("Expected header with length >= ".concat(s," but got buffer of length ").concat(i.length));const a=new _g(i.subarray(0,s)).readFields(FT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new Bo("Invalid attempt to parse header ".concat(a.z,"/").concat(a.x,"/").concat(a.y," for tile ").concat(this.z,"/").concat(this.x,"/").concat(this.y));this.x=a.x,this.y=a.y,this.z=a.z;for(const u of a.layers)this.layers[u.name]=new M0(u,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],s=this.getLayer(e.layerName);for(let a of e.blockIndices){const u=s.dataIndex[a],h=u.firstByte-e.firstByte,f=u.lastByte-e.firstByte;if(s._blocksInProgress.has(a))continue;const _={layerName:s.name,firstByte:h,lastByte:f,pixelFormat:s.pixelFormat,blockIndex:a,blockShape:[u.bands.length].concat(s.bandShape),buffer:s.buffer,codec:u.codec.codec,filters:u.filters.map((g=>g.filter))};s._blocksInProgress.add(a),i.push(_)}return new C0(i,(()=>{i.forEach((a=>s._blocksInProgress.delete(a.blockIndex)))}),((a,u)=>{if(i.forEach((h=>s._blocksInProgress.delete(h.blockIndex))),a)throw a;u.forEach((h=>{this.getLayer(h.layerName).processDecodedData(h)}))}))}}class M0{constructor({version:e,name:i,units:s,tileSize:a,pixelFormat:u,buffer:h,dataIndex:f},_){if(this.version=e,this.version!==1)throw new Bo("Cannot parse raster layer encoded with MRT version ".concat(e));this.name=i,this.units=s,this.tileSize=a,this.buffer=h,this.pixelFormat=n2[u],this.dataIndex=f,this.bandShape=[a+2*h,a+2*h,A0[this.pixelFormat]],this._decodedBlocks=new om(_?_.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return A0[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[s,a]of this.dataIndex.entries()){for(const[u,h]of a.bands.entries())if(h===e)return{bandIndex:i+u,blockIndex:s,blockBandIndex:u};i+=a.bands.length}break;case"number":for(const[s,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new Bo("Invalid band `".concat(JSON.stringify(e),"`. Expected string or integer."))}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,s=-1/0;const a=[],u=new Set;for(const h of e){const{blockIndex:f}=this.getBlockForBand(h);if(f<0)throw new Bo("Invalid band: ".concat(JSON.stringify(h)));const _=this.dataIndex[f];a.includes(f)||a.push(f),u.add(f),i=Math.min(i,_.firstByte),s=Math.max(s,_.lastByte)}if(u.size>this.cacheSize)throw new Bo("Number of blocks to decode (".concat(u.size,") exceeds cache size (").concat(this.cacheSize,")."));return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:a}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e);if(i<0)throw new Bo("Band not found: ".concat(JSON.stringify(e)));const a=this._decodedBlocks.get(i.toString());if(!a)throw new Bo("Data for band ".concat(JSON.stringify(e),' of layer "').concat(this.name,'" not decoded.'));const u=this.dataIndex[i],h=this.bandShape.reduce(((g,v)=>g*v),1),f=s*h,_=a.subarray(f,f+h);return{data:_,bytes:new Uint8Array(_.buffer).subarray(_.byteOffset,_.byteOffset+_.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:u.offset,scale:u.scale}}}lm.setPbf=function(r){_g=r};class C0{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}lm.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map((s=>{const{layerName:a,firstByte:u,lastByte:h,pixelFormat:f,blockShape:_,blockIndex:g,filters:v,codec:b}=s,w=i.subarray(u,h+1),I=new Uint32Array(_[0]*_[1]*_[2]);let A;if(b!=="gzip_data")throw new Bo("Unhandled codec: ".concat(b));return A=(function(R,L){if(!globalThis.DecompressionStream&&L==="gzip_data")return Promise.resolve(((q=(function(se){se[0]==31&&se[1]==139&&se[2]==8||ia(6,"invalid gzip data");var le=se[3],he=10;4&le&&(he+=2+(se[10]|se[11]<<8));for(var Ce=(le>>3&1)+(le>>4&1);Ce>0;Ce-=!se[he++]);return he+(2&le)})(G=R))+8>G.length&&ia(6,"invalid gzip data"),(function(se,le,he,Ce){var ye=se.length;if(!ye||le.f&&!le.l)return he||new Eo(0);var Pe=!he,ke=Pe||le.i!=2,Ve=le.i;Pe&&(he=new Eo(3*ye));var Qe,qe,Fe=function(qr){var Ar=he.length;if(qr>Ar){var _r=new Eo(Math.max(2*Ar,qr));_r.set(he),he=_r}},He=le.f||0,Ae=le.p||0,Ee=le.b||0,Ge=le.l,Ye=le.d,Ne=le.m,pt=le.n,yt=8*ye;do{if(!Ge){He=ta(se,Ae,1);var ht=ta(se,Ae+1,3);if(Ae+=3,!ht){var st=se[(Q=4+((Ae+7)/8|0))-4]|se[Q-3]<<8,$t=Q+st;if($t>ye){Ve&&ia(0);break}ke&&Fe(Ee+st),he.set(se.subarray(Q,$t),Ee),le.b=Ee+=st,le.p=Ae=8*$t,le.f=He;continue}if(ht==1)Ge=JT,Ye=QT,Ne=9,pt=5;else if(ht==2){var at=ta(se,Ae,31)+257,Ct=ta(se,Ae+10,15)+4,Wt=at+ta(se,Ae+5,31)+1;Ae+=14;for(var oi=new Eo(Wt),Si=new Eo(19),Yt=0;Yt<Ct;++Yt)Si[XT[Yt]]=ta(se,Ae+3*Yt,7);Ae+=3*Ct;var zi=pg(Si),Li=(1<<zi)-1,kr=af(Si,zi);for(Yt=0;Yt<Wt;){var Q,Y=kr[ta(se,Ae,Li)];if(Ae+=15&Y,(Q=Y>>4)<16)oi[Yt++]=Q;else{var Re=0,nt=0;for(Q==16?(nt=3+ta(se,Ae,3),Ae+=2,Re=oi[Yt-1]):Q==17?(nt=3+ta(se,Ae,7),Ae+=3):Q==18&&(nt=11+ta(se,Ae,127),Ae+=7);nt--;)oi[Yt++]=Re}}var De=oi.subarray(0,at),ot=oi.subarray(at);Ne=pg(De),pt=pg(ot),Ge=af(De,Ne),Ye=af(ot,pt)}else ia(1);if(Ae>yt){Ve&&ia(0);break}}ke&&Fe(Ee+131072);for(var Et=(1<<Ne)-1,St=(1<<pt)-1,Kt=Ae;;Kt=Ae){var kt=(Re=Ge[mg(se,Ae)&Et])>>4;if((Ae+=15&Re)>yt){Ve&&ia(0);break}if(Re||ia(2),kt<256)he[Ee++]=kt;else{if(kt==256){Kt=Ae,Ge=null;break}var bt=kt-254;kt>264&&(bt=ta(se,Ae,(1<<(Nt=v0[Yt=kt-257]))-1)+S0[Yt],Ae+=Nt);var Ri=Ye[mg(se,Ae)&St],rr=Ri>>4;if(Ri||ia(3),Ae+=15&Ri,ot=KT[rr],rr>3){var Nt=b0[rr];ot+=mg(se,Ae)&(1<<Nt)-1,Ae+=Nt}if(Ae>yt){Ve&&ia(0);break}ke&&Fe(Ee+131072);var wi=Ee+bt;if(Ee<ot){var nr=0-ot,Hi=Math.min(ot,wi);for(nr+Ee<0&&ia(3);Ee<Hi;++Ee)he[Ee]=(void 0)[nr+Ee]}for(;Ee<wi;++Ee)he[Ee]=he[Ee-ot]}}le.l=Ge,le.p=Kt,le.b=Ee,le.f=He,Ge&&(He=1,le.m=Ne,le.d=Ye,le.n=pt)}while(!He);return Ee!=he.length&&Pe?(Qe=he,((qe=Ee)==null||qe>Qe.length)&&(qe=Qe.length),new Eo(Qe.subarray(0,qe))):he.subarray(0,Ee)})(G.subarray(q,-8),{i:2},new Eo(((k=G)[(U=k.length)-4]|k[U-3]<<8|k[U-2]<<16|k[U-1]<<24)>>>0))));var k,U,G,q;const ie=r2[L];if(!ie)throw new Error("Unhandled codec: ".concat(L));const J=new globalThis.DecompressionStream(ie);return new Response(new Blob([R]).stream().pipeThrough(J)).arrayBuffer().then((se=>new Uint8Array(se)))})(w,b).then((R=>((function(L,k){L.readFields(GT,k)})(new _g(R),I),new s2[f](I.buffer)))),A.then((R=>{for(let L=v.length-1;L>=0;L--)switch(v[L]){case"delta_filter":qT(R,_);break;case"zigzag_filter":$T(R);break;case"bitshuffle_filter":ZT(R,f);break;default:throw new Bo('Unhandled filter "'.concat(v[L],'"'))}return{layerName:a,blockIndex:g,data:R}})).catch((R=>{throw R}))})))},mt(C0,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),mt(lm,"MapboxRasterTile"),mt(M0,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class P0{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class R0{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new La(it,16,0),this.featureIndexArray=new op,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,a,u,h=0,f=0){const _=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,a,u,h);const g=this.grid;for(let v=0;v<i.length;v++){const b=i[v],w=[1/0,1/0,-1/0,-1/0];for(let I=0;I<b.length;I++){const A=b[I];w[0]=Math.min(w[0],A.x),w[1]=Math.min(w[1],A.y),w[2]=Math.max(w[2],A.x),w[3]=Math.max(w[3],A.y)}f!==0&&(w[0]-=f,w[1]-=f,w[2]+=f,w[3]+=f),w[0]<it&&w[1]<it&&w[2]>=0&&w[3]>=0&&g.insert(_,w[0],w[1],w[2],w[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new xt(new Bp(this.rawTileData)).layers,this.sourceLayerCoder=new P0(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:s,transform:a,tileTransform:u,pixelPosMatrix:h,availableImages:f,worldview:_}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const g=i.queryRadius?i.queryRadius:0,v=s.bufferedTilespaceBounds,b=this.grid.query(v.min.x,v.min.y,v.max.x,v.max.y,((R,L,k,U)=>Gr(s.bufferedTilespaceGeometry,R-g,L-g,k+g,U+g)));b.sort(o2);let w=null;a.elevation&&b.length>0&&(w=Ju.create(a.elevation,this.tileID));const I={};let A;for(let R=0;R<b.length;R++){const L=b[R];if(L===A)continue;A=L;const k=this.featureIndexArray.get(L);let U=null;this.is3DTile?this.loadMatchingModelFeature(I,k,e,s,a,_):this.loadMatchingFeature(I,k,e,f,_,((G,q,ie,J=0)=>(U||(U=Le(G,this.tileID.canonical,u)),q.queryIntersectsFeature(s,G,ie,U,this.z,a,h,w,J))))}return I}loadMatchingFeature(e,i,s,a,u,h){const{featureIndex:f,bucketIndex:_,sourceLayerIndex:g,layoutVertexArrayOffset:v}=i,b=this.bucketLayerIDs[_],w=s.layers,I=Object.keys(w);if(I.length&&!Bt(I,b))return;const A=s.sourceCache,R=this.sourceLayerCoder.decode(g),L=this.vtLayers[R].feature(f),k=this.getId(L,R);for(let U=0;U<b.length;U++){const G=b[U];if(!w[G])continue;const{styleLayer:q,targets:ie}=w[G];let J={};k!==void 0&&(J=A.getFeatureState(q.sourceLayer,k));const se=!h||h(L,q,J,v);if(!se)continue;const le=new zc(L,this.z,this.x,this.y,k);le.tile=this.tileID.canonical,le.state=J;let he=this.serializedLayersCache.get(G);he||(he=q.serialize(),he.id=G,this.serializedLayersCache.set(G,he)),le.source=he.source,le.sourceLayer=he["source-layer"],le.layer=Object.assign({},he),le.layer.paint=D0(he.paint,q.paint,L,J,a),le.layer.layout=D0(he.layout,q.layout,L,J,a);let Ce=!1;for(const ye of ie){this.updateFeatureProperties(le,ye);const{filter:Pe}=ye;if(Pe){if(L.properties=le.properties,Pe.needGeometry){const ke=Te(L,!0);if(!Pe.filter(new yr(this.tileID.overscaledZ,{worldview:u}),ke,this.tileID.canonical))continue}else if(!Pe.filter(new yr(this.tileID.overscaledZ,{worldview:u}),L))continue}Ce=!0,ye.targetId&&this.addFeatureVariant(le,ye)}Ce&&this.appendToResult(e,G,f,le,se)}}loadMatchingModelFeature(e,i,s,a,u,h){const{featureIndex:f,bucketIndex:_}=i,g=this.bucketLayerIDs[_],v=s.layers,b=Object.keys(v);if(!b.length||Bt(b,g))for(let w=0;w<g.length;w++){const I=g[w],{styleLayer:A,targets:R}=v[I];if(A.type!=="model")continue;const L=a.tile,k=L.getBucket(A);if(!(k&&k instanceof tm))continue;const U=dT(k,f,a,u);if(!U)continue;const{z:G,x:q,y:ie}=L.tileID.canonical,{feature:J,intersectionZ:se,position:le}=U;let he={};J.id!==void 0&&(he=s.sourceCache.getFeatureState(A.sourceLayer,J.id));const Ce=new zc({},G,q,ie,J.id);Ce.tile=this.tileID.canonical,Ce.state=he,Ce.properties=J.properties,Ce.geometry={type:"Point",coordinates:[le.lng,le.lat]};let ye=this.serializedLayersCache.get(I);ye||(ye=A.serialize(),ye.id=I,this.serializedLayersCache.set(I,ye)),Ce.source=ye.source,Ce.sourceLayer=ye["source-layer"],Ce.layer=Object.assign({},ye);let Pe=!1;for(const ke of R){this.updateFeatureProperties(Ce,ke);const{filter:Ve}=ke;if(Ve){if(J.properties=Ce.properties,Ve.needGeometry){if(!Ve.filter(new yr(this.tileID.overscaledZ,{worldview:h}),J,this.tileID.canonical))continue}else if(!Ve.filter(new yr(this.tileID.overscaledZ,{worldview:h}),J))continue}Pe=!0,ke.targetId&&this.addFeatureVariant(Ce,ke)}Pe&&this.appendToResult(e,I,f,Ce,se)}}updateFeatureProperties(e,i,s){if(i.properties){const a={};for(const u in i.properties){const h=i.properties[u].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);h!=null&&(a[u]=h)}e.properties=a}}addFeatureVariant(e,i,s){const a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,s,a,u){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:s,feature:a,intersectionZ:u})}lookupSymbolFeatures(e,i,s,a,u,h){const f={};this.loadVTLayers();for(const _ of e)this.loadMatchingFeature(f,{bucketIndex:i,sourceLayerIndex:s,featureIndex:_,layoutVertexArrayOffset:0},a,u,h);return f}loadFeature(e){const{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(s),u=this.vtFeatures[a];if(u[i])return u[i];const h=this.vtLayers[a].feature(i);return u[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){const a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){const u=Oo(a);if(u.result!=="success"){const h=u.value.map((f=>"".concat(f.key,": ").concat(f.message))).join(", ");return void Mt("Failed to create expression for promoteId: ".concat(h))}this.promoteIdExpression=u.value}s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[a];typeof s=="boolean"&&(s=Number(s))}return s}}function D0(r,e,i,s,a){return Ze(r,((u,h)=>{const f=e instanceof Oa?e.get(h):null;return f&&f.evaluate?f.evaluate(i,s,void 0,a):f}))}function o2(r,e){return e-r}mt(R0,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const z0=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class gg{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=s>>4;if(a!==1)throw new Error("Got v".concat(a," data when expected v1."));const u=z0[15&s];if(!u)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new gg(f,h,u,e)}constructor(e,i=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error("Unpexpected numItems value: ".concat(e,"."));this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const u=z0.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,_=(8-f%8)%8;if(u<0)throw new Error("Unexpected typed array class: ".concat(s,"."));a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+_,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+f+_),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+_,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+u]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error("Added ".concat(e," items when expected ").concat(this.numItems,"."));return yg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:h,nodeSize:f}=this,_=[0,u.length-1,0],g=[];for(;_.length;){const v=_.pop()||0,b=_.pop()||0,w=_.pop()||0;if(b-w<=f){for(let L=w;L<=b;L++){const k=h[2*L],U=h[2*L+1];k>=e&&k<=s&&U>=i&&U<=a&&g.push(u[L])}continue}const I=w+b>>1,A=h[2*I],R=h[2*I+1];A>=e&&A<=s&&R>=i&&R<=a&&g.push(u[I]),(v===0?e<=A:i<=R)&&(_.push(w),_.push(I-1),_.push(1-v)),(v===0?s>=A:a>=R)&&(_.push(I+1),_.push(b),_.push(1-v))}return g}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:h}=this,f=[0,a.length-1,0],_=[],g=s*s;for(;f.length;){const v=f.pop()||0,b=f.pop()||0,w=f.pop()||0;if(b-w<=h){for(let L=w;L<=b;L++)O0(u[2*L],u[2*L+1],e,i)<=g&&_.push(a[L]);continue}const I=w+b>>1,A=u[2*I],R=u[2*I+1];O0(A,R,e,i)<=g&&_.push(a[I]),(v===0?e-s<=A:i-s<=R)&&(f.push(w),f.push(I-1),f.push(1-v)),(v===0?e+s>=A:i+s>=R)&&(f.push(I+1),f.push(b),f.push(1-v))}return _}}function yg(r,e,i,s,a,u){if(a-s<=i)return;const h=s+a>>1;L0(r,e,h,s,a,u),yg(r,e,i,s,h-1,1-u),yg(r,e,i,h+1,a,1-u)}function L0(r,e,i,s,a,u){for(;a>s;){if(a-s>600){const g=a-s+1,v=i-s+1,b=Math.log(g),w=.5*Math.exp(2*b/3),I=.5*Math.sqrt(b*w*(g-w)/g)*(v-g/2<0?-1:1);L0(r,e,i,Math.max(s,Math.floor(i-v*w/g+I)),Math.min(a,Math.floor(i+(g-v)*w/g+I)),u)}const h=e[2*i+u];let f=s,_=a;for(cf(r,e,s,i),e[2*a+u]>h&&cf(r,e,s,a);f<_;){for(cf(r,e,f,_),f++,_--;e[2*f+u]<h;)f++;for(;e[2*_+u]>h;)_--}e[2*s+u]===h?cf(r,e,s,_):(_++,cf(r,e,_,a)),_<=i&&(s=_+1),i<=_&&(a=_-1)}}function cf(r,e,i,s){xg(r,i,s),xg(e,2*i,2*s),xg(e,2*i+1,2*s+1)}function xg(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function O0(r,e,i,s){const a=r-i,u=e-s;return a*a+u*u}o.$=Nc,o.A=jo,o.B=ka,o.C=2,o.D=Nu,o.E=Vo,o.F=Hd,o.G=av,o.H=Bc,o.I=An,o.J=td,o.K=Ja,o.L=tc,o.M=cu,o.N=lu,o.O=jh,o.P=Be,o.Q=fu,o.R=Ta,o.S=_l,o.T=C_,o.U=Oo,o.V=em,o.W=Hh,o.X=ol,o.Y=sl,o.Z=ac,o._=gs,o.a=function(r){return er.API_CDN_URL_REGEX.test(r)},o.a$=vl,o.a0=jt,o.a1=ph,o.a2=gl,o.a3=class extends em{},o.a4=uu,o.a5=Uh,o.a6=ge,o.a7=function(r){const e=r.value;return e?jt(e)?sg(e,!0)?[]:[new em(r.key,e,'invalid url "'.concat(e,'"'))]:[new em(r.key,e,'string expected, "'.concat(Ja(e),'" found'))]:[]},o.a8=Xf,o.a9=$r,o.aA=B,o.aB=Xt,o.aC=En,o.aD=Rs,o.aE=Fn,o.aF=V,o.aG=Me,o.aH=function(r,e){const i={};for(let s=0;s<e.length;s++){const a=e[s];a in r&&(i[a]=r[a])}return i},o.aI=E,o.aJ=N,o.aK=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){const a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){const[u,h]=a.result;return this.scheduler?this.scheduler.add((()=>{s(u,h)}),e):s(u,h),()=>{}}return a.callbacks.push(s),a.cancel||(a.cancel=i(((u,h)=>{a.result=[u,h];for(const f of a.callbacks)this.scheduler?this.scheduler.add((()=>{f(u,h)}),e):f(u,h);setTimeout((()=>delete this.entries[r]),3e3)}))),()=>{a.result||(a.callbacks=a.callbacks.filter((u=>u!==s)),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},o.aL=function(r,e,i){const s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},(a=>{const u=Za(r.request,((h,f,_)=>{h?a(h):f&&a(null,{vectorTile:i?void 0:new xt(new Bp(f)),rawData:f,responseHeaders:new Map(_.entries())})}));return()=>{u.cancel(),a()}}),e)},o.aM=function(r){return r?{cacheControl:r.get("Cache-Control"),expires:r.get("Expires")}:{cacheControl:void 0,expires:void 0}},o.aN=function(r){ba++,ba>jn&&(r.getActor().send("enforceCacheSizeLimit",sr),ba=0)},o.aO=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log2(r)))},o.aP=Rn,o.aQ=kv,o.aR=jv,o.aS=M,o.aT=Ov,o.aU=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){const a=document.createElement("source");Bi(r[s])||(i.crossOrigin="Anonymous"),a.src=r[s],i.appendChild(a)}return{cancel:()=>{}}},o.aV=Nd,o.aW=Lc,o.aX=be,o.aY=Wd,o.aZ=Z,o.a_=H,o.aa=We,o.ab=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return Fi(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Vt(r.x,e.x,i),y:Vt(r.y,e.y,i),z:Vt(r.z,e.z,i),azimuthal:Vt(r.azimuthal,e.azimuthal,i),polar:Vt(r.polar,e.polar,i)}}},o.ac=yr,o.ad=ca,o.ae=_e,o.af=dr,o.ag=ir,o.ah=X,o.ai=Oa,o.aj=Pl,o.ak=Vt,o.al=it,o.am=Xl,o.an=Qt,o.ao=Gi,o.ap=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return(function([i,s]){const a=Fi([1,i,s]);return{x:a.x,y:a.y,z:a.z}})(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Vt(r.x,e.x,i),y:Vt(r.y,e.y,i),z:Vt(r.z,e.z,i)}}},o.aq=function(r,e,i=0,s=!0){const a=new Be(i,i),u=r.sub(a),h=e.add(a),f=[u,new Be(h.x,u.y),h,new Be(u.x,h.y)];return s&&f.push(u.clone()),f},o.ar=function(r,e){const i=[];for(let s=0;s<r.length;s++){const a=ae(s-1,-1,r.length-1),u=ae(s+1,-1,r.length-1),h=r[s],f=r[u],_=r[a].sub(h).unit(),g=f.sub(h).unit(),v=g.angleWithSep(_.x,_.y),b=_.add(g).unit().mult(-1*e/Math.sin(v/2));i.push(h.add(b))}return i},o.as=vv,o.at=Gr,o.au=function(r,e,i=0){return qi(((e.x-i)*r.scale-r.x)*it,(e.y*r.scale-r.y)*it,te(e.z,e.y))},o.av=Rr,o.aw=Yi,o.ax=ti,o.ay=Lx,o.az=function(r){let e=1/0,i=1/0,s=-1/0,a=-1/0;for(const u of r)e=Math.min(e,u.x),i=Math.min(i,u.y),s=Math.max(s,u.x),a=Math.max(a,u.y);return{min:new Be(e,i),max:new Be(s,a)}},o.b=function(r){return er.API_FONTS_REGEX.test(r)},o.b$=g_,o.b0=zr,o.b1=Se,o.b2=rp,o.b3=Yp,o.b4=function(){Vs.isLoading()||Vs.isLoaded()||Jh()!=="deferred"||Qh()},o.b5=xu,o.b6=Te,o.b7=zc,o.b8=en,o.b9=F_,o.bA=yi,o.bB=ai,o.bC=function(r,e){const{x:i,y:s}=r.point,a=Qg(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Xt(a,a,n_(_a(e)))},o.bD=It,o.bE=Br,o.bF=Mo,o.bG=ns,o.bH=Fr,o.bI=Qi,o.bJ=Zu,o.bK=ro,o.bL=q_,o.bM=function(r,e,i,s,a){const u=5*e+2;r.float32[u+0]=i,r.float32[u+1]=s,r.float32[u+2]=a},o.bN=Ku,o.bO=Jr,o.bP=zn,o.bQ=Dn,o.bR=In,o.bS=ae,o.bT=function(r,e,i,s){var a=new $e(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=s,a},o.bU=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,s=1<<i,a=Math.floor(r.x),u=Math.floor((r.x-a)*s),h=Math.floor(r.y*s),f=this.findDEMTileFor(new Rn(i,a,i,u,h));return!(!f||!f.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const s=this._source();if(!s||r.y<0||r.y>1)return e;const a=s.getSource().maxzoom,u=1<<a,h=Math.floor(r.x),f=r.x-h,_=new Rn(a,h,a,Math.floor(f*u),Math.floor(r.y*u)),g=this.findDEMTileFor(_);if(!g||!g.dem)return e;const v=g.dem,b=1<<g.tileID.canonical.z,w=(f*b-g.tileID.canonical.x)*v.dim,I=(r.y*b-g.tileID.canonical.y)*v.dim,A=Math.floor(w),R=Math.floor(I);return(i?this.exaggeration():1)*Vt(Vt(v.get(A,R),v.get(A,R+1),I-R),Vt(v.get(A+1,R),v.get(A+1,R+1),I-R),w-A)}static getAtTileOffset(r,e,i,s){const a=1<<r.canonical.z;return s?s.pointElevation(e):i?i.getAtPointOrZero(new _e(r.wrap+(r.canonical.x+e.x/it)/a,(r.canonical.y+e.y/it)/a)):0}static getAtTileOffsetFunc(r,e,i,s){return(a,u,h)=>{const f=this.getAtTileOffset(r,a,u,h),_=s.upVector(r.canonical,a.x,a.y);return Xi(_,_,f*s.upVectorScale(r.canonical,e,i).metersToTile),_}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;const a=Ju.create(this,r,s);return!!a&&(e.forEach((u=>{u[2]=this.exaggeration()*a.getElevationAt(u[0],u[1],i)})),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,s=e.tileID,a=1<<r.canonical.z-s.canonical.z;let u=r.canonical.x/a-s.canonical.x,h=r.canonical.y/a-s.canonical.y,f=0;for(let _=0;_<r.canonical.z-s.canonical.z&&!i.leaves[f];_++){u*=2,h*=2;const g=2*Math.floor(h)+Math.floor(u);f=i.childOffsets[f]+g,u%=1,h%=1}return{min:this.exaggeration()*i.minimums[f],max:this.exaggeration()*i.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(const a of r){const u=this.getMinMaxForTile(a.tileID);u&&(i=Math.min(i,u.min),s=Math.max(s,u.max),e=!0)}return e?{min:i,max:s}:null}},o.bV=Ap,o.bW=tn,o.bX=Zn,o.bY=Py,o.bZ=Gv,o.b_=Ly,o.ba=p_,o.bb=Le,o.bc=Ps,o.bd=Au,o.be=Zg,o.bf=Vr,o.bg=Fu,o.bh=rg,o.bi=function(r,e){const i=Pl(e.zoom);if(i===0)return _a(r);const s=_p(r),a=r_(s),u=V(s.getWest())*e.worldSize,h=V(s.getEast())*e.worldSize,f=N(s.getNorth())*e.worldSize,_=N(s.getSouth())*e.worldSize,g=[u,f,0],v=[h,f,0],b=[u,_,0],w=[h,_,0],I=li([],e.globeMatrix);return dr(g,g,I),dr(v,v,I),dr(b,b,I),dr(w,w,I),a[0]=Ua(a[0],b,i),a[1]=Ua(a[1],w,i),a[2]=Ua(a[2],v,i),a[3]=Ua(a[3],g,i),si.fromPoints(a)},o.bj=yp,o.bk=li,o.bl=Td,o.bm=Ua,o.bn=Fa,o.bo=Rb,o.bp=Ii,o.bq=gi,o.br=lm,o.bs=Bp,o.bt=Za,o.bu=function(r,e){const i=[];for(const s in r)s in e||i.push(s);return i},o.bv=oe,o.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.bx=On,o.by=_t,o.bz=Ot,o.c=wn,o.c$=function(r){return r*r*r*r*r},o.c0=G_,o.c1=pv,o.c2=Y_,o.c3=gg,o.c4=Xi,o.c5=Un,o.c6=ms,o.c7=function(r,e,i){i*=.5;var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=s*_+a*f,r[1]=a*_-s*f,r[2]=u*_+h*f,r[3]=h*_-u*f,r},o.c8=Yn,o.c9=Er,o.cA=Ni,o.cB=yx,o.cC=eo,o.cD=Yg,o.cE=function(r,e,i,s,a,u,h,f,_){if(_.name==="globe")return Yg(r,e,new eo(i,s,a),!1);const g=Wd({z:i,x:s,y:a},_);return new si([(u+g.x/g.scale)*e,e*(g.y/g.scale),h],[(u+g.x2/g.scale)*e,e*(g.y2/g.scale),f])},o.cF=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},o.cG=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},o.cH=function(r){const e=Math.round((r+45+360)%360/90)%4;return ks[e]},o.cI=W,o.cJ=ps,o.cK=t,o.cL=function(r){const e=Ot(new Float64Array(16));Xt(e,r.pixelMatrix,r.globeMatrix);const i=[0,p,0],s=[0,m,0];return dr(i,i,e),dr(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!o_(r,new M(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!o_(r,new M(r.center.lat,-90))]},o.cM=function(r,e){const{scale:i}=r.tileTransform,s=i*it/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return(function(a,u,h){var f=u[1],_=u[2],g=u[3],v=h[0],b=h[1];return a[0]=u[0]*v,a[1]=f*v,a[2]=_*b,a[3]=g*b,a})(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},o.cN=Dp,o.cO=mi,o.cP=gx,o.cQ=function(r){const e=gx(r,!0);return It([],[e[0],e[1],e[4],e[5]])},o.cR=hi,o.cS=Zi,o.cT=Wi,o.cU=function(r){const{x:e,y:i}=r.point,{lng:s,lat:a}=r._center;return Qg(e,i,r.worldSize,s,a)},o.cV=Cn,o.cW=Qr,o.cX=to,o.cY=rn,o.cZ=l,o.c_=function(r,e,i){let s=0;for(let a=0;a<2;++a)r[a]>0&&(s+=(r[a]-0)*(r[a]-0)),e[a]<0&&(s+=(0-e[a])*(0-e[a]));return s},o.ca=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},o.cb=vr,o.cc=function(r,e,i,s,a){var u=1/Math.tan(e/2);if(r[0]=u/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0){var h=1/(s-a);r[10]=(a+s)*h,r[14]=2*a*s*h}else r[10]=-1,r[14]=-2*s;return r},o.cd=function(r,e,i,s,a,u,h){var f=1/(e-i),_=1/(s-a),g=1/(u-h);return r[0]=-2*f,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*_,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*g,r[11]=0,r[12]=(e+i)*f,r[13]=(a+s)*_,r[14]=(h+u)*g,r[15]=1,r},o.ce=j,o.cf=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},o.cg=zu,o.ch=Il,o.ci=un,o.cj=ko,o.ck=Sc,o.cl=Ev,o.cm=function(){var r=new $e(4);return $e!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},o.cn=function(r,e,i){var s=e[0],a=e[1],u=e[2],h=e[3],f=Math.sin(i),_=Math.cos(i);return r[0]=s*_+u*f,r[1]=a*_+h*f,r[2]=s*-f+u*_,r[3]=a*-f+h*_,r},o.co=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},o.cp=fs,o.cq=function(r){var e=r[0],i=r[1],s=r[2],a=r[3];return Math.sqrt(e*e+i*i+s*s+a*a)},o.cr=Hs,o.cs=Vn,o.ct=Fo,o.cu=3,o.cv=2,o.cw=7,o.cx=6,o.cy=Xn,o.cz=Pt,o.d=function(r){return er.API_TILEJSON_REGEX.test(r)},o.d$=iy,o.d0=O,o.d1=45,o.d2=Tc,o.d3=function(r,e,i){const s=Math.sqrt(r*r+e*e+i*i),a=s>0?Math.acos(i/s)*as:0;let u=r!==0||e!==0?Math.atan2(-e,-r)*as+90:0;return u<0&&(u+=360),[s,u,a]},o.d4=qi,o.d5=Fi,o.d6=ne,o.d7=ar,o.d8=si,o.d9=Wr,o.dA=xd,o.dB=class extends vo{constructor(r){super(r),this.current=Km}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},o.dC=xs,o.dD=function(r,e,i){const s=Pl(i.zoom),a=r.style.map._antialias,u=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!a&&!u},o.dE=function(r){const e=r.pixelsPerMeter,i=e/j(1,r.center.lat),s=Ot(new Float64Array(16));return gi(s,s,[r.point.x,r.point.y,0]),hi(s,s,[i,i,e]),Float32Array.from(s)},o.dF=_p,o.dG=function(r){const e=W-5;r=B(r,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(Qt(r))),3);return Math.round(i*(d.length-1))},o.dH=function(r,e,i,s){const a=e.getNorth(),u=e.getSouth(),h=e.getWest(),f=e.getEast(),_=1<<r.z,g=f-h,v=a-u,b=g/c,w=-v/d[i],I=[0,b,0,w,0,0,a,h,0];if(r.z>0){const A=180/s;Rt(I,I,[A/g+1,0,0,0,A/v+1,0,-.5*A/b,.5*A/w,1])}return I[2]=_,I[5]=r.x,I[8]=r.y,I},o.dI=_a,o.dJ=function(r,e,i){const s=Ot(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return ci(s,i.globeMatrix,a),Float32Array.from(s)},o.dK=dy,o.dL=mp,o.dM=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},o.dN=lt,o.dO=function(r,e){var i=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},o.dP=os,o.dQ=Jg,o.dR=lr,o.dS=pr,o.dT=256,o.dU=function(r,e){const i=[0,0,0];return dr(i,i,yp(_a(e.canonical))),dr(i,i,r),i},o.dV=r=>({u_matrix:new Sc(r),u_texsize:new ko(r),u_pixels_to_tile_units:new vd(r),u_device_pixel_ratio:new un(r),u_width_scale:new un(r),u_floor_width_scale:new un(r),u_image:new zu(r),u_units_to_pixels:new ko(r),u_tile_units_to_pixels:new un(r),u_alpha_discard_threshold:new un(r),u_trim_offset:new ko(r),u_trim_fade_range:new ko(r),u_trim_color:new Tc(r),u_emissive_strength:new un(r),u_zbias_factor:new un(r),u_tile_to_meter:new un(r),u_ground_shadow_factor:new Il(r),u_pattern_transition:new un(r)}),o.dW=r=>({u_matrix:new Sc(r),u_pixels_to_tile_units:new vd(r),u_device_pixel_ratio:new un(r),u_width_scale:new un(r),u_floor_width_scale:new un(r),u_units_to_pixels:new ko(r),u_dash_image:new zu(r),u_gradient_image:new zu(r),u_image_height:new un(r),u_texsize:new ko(r),u_tile_units_to_pixels:new un(r),u_alpha_discard_threshold:new un(r),u_trim_offset:new ko(r),u_trim_fade_range:new ko(r),u_trim_color:new Tc(r),u_emissive_strength:new un(r),u_zbias_factor:new un(r),u_tile_to_meter:new un(r),u_ground_shadow_factor:new Il(r)}),o.dX=r=>({u_camera_to_center_distance:new un(r),u_extrude_scale:new vd(r),u_device_pixel_ratio:new un(r),u_matrix:new Sc(r),u_inv_rot_matrix:new Sc(r),u_merc_center:new ko(r),u_tile_id:new Il(r),u_zoom_transition:new un(r),u_up_dir:new Il(r),u_emissive_strength:new un(r)}),o.dY=wl,o.dZ=yw,o.d_=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();const[a,u,h]=this.size,{gl:f}=r;f.bindTexture(f.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&f.texImage3D(f.TEXTURE_3D,0,this.format,a,u,h,0,A_(this.format),M_(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},o.da=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},o.db=_x,o.dc=O_,o.dd=bx,o.de=sg,o.df=function(r,e){return r.readFields(mT,{icons:[]},e)},o.dg=Mp,o.dh=Wu,o.di=Z_,o.dj=ch,o.dk=Wf,o.dl=mr,o.dm=$l,o.dn=vt,o.dp=function(r){const e=r.indexOf(gc);return e>=0?r.slice(0,e):r},o.dq=function(r){return r.indexOf(gc)>=0},o.dr=function(r){const e=r.lastIndexOf(gc);return e>=0?r.slice(e+1):""},o.ds=function(r){const e=[],i=r.id;return i===void 0&&e.push({message:"layers.".concat(i,': missing required property "id"')}),r.render===void 0&&e.push({message:"layers.".concat(i,': missing required method "render"')}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:"layers.".concat(i,': property "renderingMode" must be either "2d" or "3d"')}),e},o.dt=function(r,e,i,s){return r.type==="custom"?new lT(r,e):new fT[r.type](r,e,i,s)},o.du=Ue,o.dv=function(r){const e=r.indexOf(gc);return e>=0?r.slice(e+1):""},o.dw=class extends zc{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},o.dx=Kh,o.dy=Vl,o.dz=function(r){return r({pluginStatus:bs,pluginURL:da}),Kh.on("pluginStateChange",r),r},o.e=er,o.e$=function([r,e,i]){const s=Math.hypot(r,e,i),a=Math.atan2(r,i),u=.5*Math.PI-Math.acos(-e/s);return new M(Qr(a),Qr(u))},o.e0=(r,e,i,s,a,u)=>{const h=r.transform,f=h.projection.name==="globe";let _;if(u.paint.get("circle-pitch-alignment")==="map")if(f){const v=Jg(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;_=Float32Array.from([v,0,0,v])}else _=h.calculatePixelsToTileUnitsMatrix(i);else _=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const g={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(h.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,u.paint.get("circle-translate"),u.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Mi.devicePixelRatio,u_extrude_scale:_,u_inv_rot_matrix:kb,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:u.paint.get("circle-emissive-strength")};if(f){g.u_inv_rot_matrix=s,g.u_merc_center=a,g.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],g.u_zoom_transition=Pl(h.zoom);const v=a[0]*it,b=a[1]*it;g.u_up_dir=h.projection.upVector(new eo(0,0,0),v,b)}return g},o.e1=Bx,o.e2=Cs,o.e3=(r,e,i,s,a,u,h,f,_,g)=>{const v=r.transform,b=v.pitch<15?Ox(.07,.7,B((14-v.zoom)/5,0,1)):.07,w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:Fx(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:v.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:u,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:kx(e,v),u_units_to_pixels:[1/v.pixelsToGLUnits[0],1/v.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:f,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:b,u_tile_to_meter:ne(e.tileID.canonical,0),u_ground_shadow_factor:_,u_pattern_transition:g}},o.e4=(r,e,i,s,a,u,h,f,_,g)=>{const v=r.transform,b=v.calculatePixelsToTileUnitsMatrix(e),w=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",I=v.pitch<15?Ox(.07,.7,B((14-v.zoom)/5,0,1)):.07;return{u_matrix:Fx(r,e,i,s),u_pixels_to_tile_units:b,u_device_pixel_ratio:u,u_width_scale:h,u_floor_width_scale:f,u_units_to_pixels:[1/v.pixelsToGLUnits[0],1/v.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:Nx(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:kx(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(w?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:I,u_tile_to_meter:ne(e.tileID.canonical,0),u_ground_shadow_factor:g}},o.e5=me,o.e6=Sd,o.e7=te,o.e8=Va,o.e9=Ip,o.eA=lg,o.eB=Op,o.eC=Lp,o.eD=[1,1,1],o.eE=Ju,o.eF=nn,o.eG=function(r,e,i,s){var a=e[0],u=e[1],h=e[2],f=e[3];return r[0]=a+s*(i[0]-a),r[1]=u+s*(i[1]-u),r[2]=h+s*(i[2]-h),r[3]=f+s*(i[3]-f),r},o.eH=Gu,o.eI=xo,o.eJ=ma,o.eK=function(r,e,i,s,a,u,h,f,_,g,v,b,w,I,A,R){var L=new $e(16);return L[0]=r,L[1]=e,L[2]=i,L[3]=s,L[4]=a,L[5]=u,L[6]=h,L[7]=f,L[8]=_,L[9]=g,L[10]=v,L[11]=b,L[12]=w,L[13]=I,L[14]=A,L[15]=R,L},o.eL=T,o.eM=dd,o.eN=xc,o.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Be(1/0,1/0),max:new Be(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=Dy(new Be(0,0),new Be(it,it),r),s=[];if(e&&!m_(i,this._globalClipBounds))return s;for(const a of this._activeRegions){if(a.hiddenByOverlap||!m_(i,a))continue;const u=h1(a.min,a.max,r);s.push({min:u.min,max:u.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return s}setSources(r){this._setSources(r.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const s of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(s).buckets[e.layer];a&&a.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(r){const e=r.getFootprints();if(e.length===0)return;const i=r.getOrder(),s=r.getClipMask(),a=r.getClipScope();for(const u of e){if(!u.footprint)continue;const h=Dy(u.footprint.min,u.footprint.max,u.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:u.id,footprint:u.footprint,order:i,clipMask:s,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,i)=>e.priority-i.priority||Tp(e.min,i.min)||Tp(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||(function(s,a){const u=(h,f)=>h+f;return s.length-a.length||s.reduce(u,"").localeCompare(a.reduce(u,""))})(e.clipScope,i.clipScope)));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!Ry(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!On(i.clipScope,s.clipScope),this._activeRegions[e].hiddenByOverlap=s.hiddenByOverlap,++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==Pd&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const s=this._activeRegions;if(i>=s.length)return i;const a=s[i].priority;for(;i<s.length&&s[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let a=i;const u=i;for(;a!==s;){const h=this._activeRegions[a];h.hiddenByOverlap=!1;for(let f=0;f<u;f++){const _=this._activeRegions[f];if(!_.hiddenByOverlap&&h.order===Pd&&m_(h,_)&&(h.hiddenByOverlap=zy(h.footprint,h.tileId,_.footprint,_.tileId),h.hiddenByOverlap))break}++a}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},o.eP=Pd,o.eQ=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new Ps,s=new zr,a=[],u=r+1+2,h=e[0]+1,f=e[0]+1+(1+e.length),_=(g,v,b)=>{let w=g===u-1?g-2:g===0?g:g-1;return w+=b?24575:0,[w,v]};for(let g=0;g<u;++g)i.emplaceBack(..._(g,0,!0));for(let g=0;g<h;++g)for(let v=0;v<u;++v)i.emplaceBack(..._(v,g,(v===0||v===u-1)&&!0));for(let g=0;g<e.length;++g){const v=e[g];for(let b=0;b<u;++b)i.emplaceBack(..._(b,v,!0))}for(let g=0;g<e.length;++g){const v=s.length,b=e[g]+1+2,w=new zr;for(let R=0;R<b-1;R++){const L=R===b-2,k=L?u*(f-e.length+g-R):u;for(let U=0;U<u-1;U++){const G=R*u+U;R===0||L||U===0||U===u-2?(w.emplaceBack(G+1,G,G+k),w.emplaceBack(G+k,G+k+1,G+1)):(s.emplaceBack(G+1,G,G+k),s.emplaceBack(G+k,G+k+1,G+1))}}const I=Vr.simpleSegment(0,v,i.length,s.length-v);for(let R=0;R<w.uint16.length;R+=3)s.emplaceBack(w.uint16[R],w.uint16[R+1],w.uint16[R+2]);const A=Vr.simpleSegment(0,v,i.length,s.length-v);a.push({withoutSkirts:I,withSkirts:A})}return{vertices:i,indices:s,segments:a}}_createGrid(r){const e=this._fillGridMeshWithLods(c,d);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Zg.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new zr;for(let h=0;h<=c;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new Na,s=new Na,a=new Na,u=new Na;this._poleSegments=[];for(let h=0,f=0;h<l;h++){const _=360/(1<<h);i.emplaceBack(0,-Rs,0,.5,0),s.emplaceBack(0,-Rs,0,.5,1),a.emplaceBack(0,-Rs,0,.5,.5),u.emplaceBack(0,-Rs,0,.5,.5);for(let g=0;g<=c;g++){let v=g/c,b=0;const w=Vt(0,_,v),[I,A,R]=y(Lb,Ob,w,Rs);i.emplaceBack(I,A,R,v,b),s.emplaceBack(I,A,R,v,1-b);const L=Qt(w);v=.5+.5*Math.sin(L),b=.5+.5*Math.cos(L),a.emplaceBack(I,A,R,v,b),u.emplaceBack(I,A,R,v,1-b)}this._poleSegments.push(Vr.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,ku,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,ku,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,ku,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(u,ku,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},o.eR=Cy,o.eS=pe,o.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.eU=F,o.eV=K,o.eW=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},o.eX=co,o.eY=x,o.eZ=lo,o.e_=di,o.ea=Wy,o.eb=Dl,o.ec=By,o.ed=Fy,o.ee=ee,o.ef=function(r,e){if(r===e){var i=e[1],s=e[2],a=e[3],u=e[6],h=e[7],f=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=u,r[11]=e[14],r[12]=a,r[13]=h,r[14]=f}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},o.eg=aT,o.eh=fi,o.ei=pd,o.ej=256,o.ek=n_,o.el=Ys,o.em=ci,o.en=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},o.eo=Na,o.ep=hd,o.eq=Uf,o.er=function(r,e,i,s,a){return B((r-e)/(i-e)*(a-s)+s,s,a)},o.es=Kn,o.et=function(r,e){var i=e[0],s=e[1],a=e[2],u=e[3],h=e[4],f=e[5],_=e[6],g=e[7],v=e[8],b=v*h-f*g,w=-v*u+f*_,I=g*u-h*_,A=i*b+s*w+a*I;return A?(r[0]=b*(A=1/A),r[1]=(-v*s+a*g)*A,r[2]=(f*s-a*h)*A,r[3]=w*A,r[4]=(v*i-a*_)*A,r[5]=(-f*i+a*u)*A,r[6]=I*A,r[7]=(-g*i+s*_)*A,r[8]=(h*i-s*u)*A,r):null},o.eu=2,o.ev=ss,o.ew=zs,o.ex=Lr,o.ey=function(r,e){var i=new $e(3);Lr(i,e);var s=1/i[0],a=1/i[1],u=1/i[2],h=e[0]*s,f=e[1]*a,_=e[2]*u,g=e[4]*s,v=e[5]*a,b=e[6]*u,w=e[8]*s,I=e[9]*a,A=e[10]*u,R=h+v+A,L=0;return R>0?(L=2*Math.sqrt(R+1),r[3]=.25*L,r[0]=(b-I)/L,r[1]=(w-_)/L,r[2]=(f-g)/L):h>v&&h>A?(L=2*Math.sqrt(1+h-v-A),r[3]=(b-I)/L,r[0]=.25*L,r[1]=(f+g)/L,r[2]=(w+_)/L):v>A?(L=2*Math.sqrt(1+v-h-A),r[3]=(w-_)/L,r[0]=(f+g)/L,r[1]=.25*L,r[2]=(b+I)/L):(L=2*Math.sqrt(1+A-h-v),r[3]=(f-g)/L,r[0]=(w+_)/L,r[1]=(b+I)/L,r[2]=.25*L),r},o.ez=function(r,e){var i=2*Math.acos(e[3]),s=Math.sin(i/2);return s>Oe?(r[0]=e[0]/s,r[1]=e[1]/s,r[2]=e[2]/s):(r[0]=1,r[1]=0,r[2]=0),i},o.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,((e,i)=>String.fromCharCode(+("0x"+i)))))},o.f0=uo,o.f1=P_,o.f2=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!(function(i){if(Dr==null){const s=i.navigator?i.navigator.userAgent:null;Dr=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Dr})(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},o.f3=function(r,e){sr=r,jn=e},o.f4=o_,o.f5=ey,o.f6=function(r){const e=[0,0,0],i=Ot(new Float64Array(16));return Xt(i,r.pixelMatrix,r.globeMatrix),dr(e,e,i),new Be(e[0],e[1])},o.f7=function(){const r=kd;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(w_),kd=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.f8=function(){Mp().acquire(w_)},o.f9=Jh,o.fA=je,o.fB=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==hx){const i=new Uint32Array(r,0,7),[,,s,a,u,h]=i;e=i.byteLength+a+u+h+u,(s!==r.byteLength||e>=r.byteLength)&&Mt("Invalid b3dm header information.")}return mx(r,e)},o.fC=function(r,e){const i=O_(r);for(const s of i){for(const a of s.meshes)j1(a);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(G1(s.lights,e)))}return i},o.fD=tm,o.fE=Sr,o.fF=ox,o.fG=Vs,o.fH=Ns,o.fI=function(r){Po(),Gn!=null&&Gn.then((e=>{e.keys().then((i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s]).catch((a=>Mt(a.message)))})).catch((i=>Mt(i.message)))})).catch((e=>Mt(e.message)))},o.fa=function(r,e,i=!1){if(bs===Ns.deferred||bs===Ns.loading||bs===Ns.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");da=Mi.resolveURL(r),bs=Ns.deferred,Xh=e,Yh(),i||Qh()},o.fb=function(r){Vu=Mi.resolveURL(r),Uu||(Uu=new Nu(Mp(),new Vo)),Uu.broadcast("setMeshoptUrl",Vu)},o.fc=cx,o.fd=function(r){S_=Mi.resolveURL(r),Uu||(Uu=new Nu(Mp(),new Vo)),Uu.broadcast("setDracoUrl",S_)},o.fe=lx,o.ff=Od,o.fg=function(r){const e=ho();if(!e)return;const i=e.delete(hn);r&&i.then((()=>r())).catch(r)},o.fh=Mc,o.fi=mt,o.fj=Rl,o.fk=ea,o.fl=P0,o.fm=R0,o.fn=Rx,o.fo=ut,o.fp="hd_road_elevation",o.fq=qt,o.fr=Ze,o.fs=ja,o.ft=$_,o.fu=Rc,o.fv=function(r,e,i,s,a,u,h,f=1,_,g,v){r.createArrays(),r.tilePixelRatio=it/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const b=r.layers[0].layout,w=r.layers[0]._unevaluatedLayout._values,I={};I.scaleFactor=f,I.textSizeScaleRange=b.get("text-size-scale-range"),I.iconSizeScaleRange=b.get("icon-size-scale-range");const[A,R]=I.textSizeScaleRange,[L,k]=I.iconSizeScaleRange;I.textScaleFactor=B(I.scaleFactor,A,R),I.iconScaleFactor=B(I.scaleFactor,L,k);const U=w["text-size"],G=w["icon-size"];if(r.textSizeData.kind==="composite"){const{minZoom:he,maxZoom:Ce}=r.textSizeData;I.compositeTextSizes=[U.possiblyEvaluate(new yr(he,{worldview:v}),u),U.possiblyEvaluate(new yr(Ce,{worldview:v}),u)]}if(r.iconSizeData.kind==="composite"){const{minZoom:he,maxZoom:Ce}=r.iconSizeData;I.compositeIconSizes=[G.possiblyEvaluate(new yr(he,{worldview:v}),u),G.possiblyEvaluate(new yr(Ce,{worldview:v}),u)]}I.layoutTextSize=U.possiblyEvaluate(new yr(h+1,{worldview:v}),u),I.layoutIconSize=G.possiblyEvaluate(new yr(h+1,{worldview:v}),u),I.textMaxSize=U.possiblyEvaluate(new yr(18,{worldview:v}),u);const q=b.get("symbol-placement"),ie=b.get("text-rotation-alignment")==="map"&&q!=="point",J=b.get("text-size");let se=!1;const le=[];for(const he of r.features){const Ce=b.get("text-font").evaluate(he,{},u).join(","),ye=J.evaluate(he,{},u)*I.textScaleFactor,Pe=I.layoutTextSize.evaluate(he,{},u)*I.textScaleFactor,ke=I.layoutIconSize.evaluate(he,{},u)*I.iconScaleFactor,Ve={horizontal:{},vertical:void 0},Qe=he.text;let qe,Fe=[0,0];if(Qe){const oi=Qe.toString(),Si=b.get("text-letter-spacing").evaluate(he,{},u)*Zn,Yt=b.get("text-line-height").evaluate(he,{},u)*Zn,zi=$f(oi)?Si:0,Li=b.get("text-anchor").evaluate(he,{},u),kr=b.get("text-variable-anchor");if(!kr){const De=b.get("text-radial-offset").evaluate(he,{},u);if(De)Fe=pv(Li,[De*Zn,X_]);else{const ot=b.get("text-offset").evaluate(he,{},u);Fe=[ot[0]*Zn,ot[1]*Zn]}}let Q=ie?"center":b.get("text-justify").evaluate(he,{},u);const Y=q==="point",Re=Y?b.get("text-max-width").evaluate(he,{},u)*Zn:1/0,nt=De=>{r.allowVerticalPlacement&&$h(oi)&&(Ve.vertical=j_(Qe,e,i,a,Ce,Re,Yt,Li,De,zi,Fe,ro.vertical,!0,Pe,ye,_))};if(!ie&&kr){const De=Q==="auto"?kr.map((Et=>Y_(Et))):[Q];let ot=!1;for(let Et=0;Et<De.length;Et++){const St=De[Et];if(!Ve.horizontal[St])if(ot)Ve.horizontal[St]=Ve.horizontal[0];else{const Kt=j_(Qe,e,i,a,Ce,Re,Yt,"center",St,zi,Fe,ro.horizontal,!1,Pe,ye,_);Kt&&(Ve.horizontal[St]=Kt,ot=Kt.positionedLines.length===1)}}nt("left")}else{if(Q==="auto"&&(Q=Y_(Li)),Y||b.get("text-writing-mode").indexOf("horizontal")>=0||!$h(oi)){const De=j_(Qe,e,i,a,Ce,Re,Yt,Li,Q,zi,Fe,ro.horizontal,!1,Pe,ye,_);De&&(Ve.horizontal[Q]=De)}nt(Y?"left":Q)}}let He,Ae,Ee,Ge,Ye,Ne,pt=!1;const yt=b.get("icon-text-fit").evaluate(he,{},u);if(he.icon&&he.icon.hasPrimary()){const oi=$d(he.icon,r.iconSizeData,w["icon-size"],u,r.zoom,he,_,I.iconScaleFactor,v);He=oi.iconPrimary,Ee=oi.iconSecondary;const Si=He.toString();if(Ae=s.get(Si),Ae&&(Ye=b.get("icon-offset").evaluate(he,{},u),Ne=b.get("icon-anchor").evaluate(he,{},u),qe=Vp(a.get(Si),Ee?a.get(Ee.toString()):void 0,Ye,Ne),pt=Ae.sdf,r.sdfIcons===void 0?r.sdfIcons=Ae.sdf:r.sdfIcons!==Ae.sdf&&Mt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ae.pixelRatio!==r.pixelRatio||b.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Ee){const Yt=Ee.toString();Ge=s.get(Yt)}}se=se||!(!he.icon||!he.icon.hasSecondary());const ht=K_(Ve.horizontal)||Ve.vertical;r.iconsInText||(r.iconsInText=!!ht&&ht.iconsInText);const st=Pe*I.textScaleFactor/Zn,{defaultShapedIcon:$t,verticallyShapedIcon:at}=Zw(r,qe,b,he,u,Ve,st,Ye,yt);yt!=="none"&&qe&&(Qx(qe)||ev(qe))&&(qp(0,Ae,He,qe,$t,yt,g,s,a),qp(0,Ge,Ee,qe,$t,yt,g,s,a),at&&(qp(0,Ae,He,qe,at,yt,g,s,a),qp(0,Ge,Ee,qe,at,yt,g,s,a))),qe=$t;const{iconBBox:Ct,iconVerticalBBox:Wt}=Hw(r,qe,at,b,he,u,ke,Ye,I,a,Ne);le.push({feature:he,shapedTextOrientations:Ve,shapedText:ht,shapedIcon:qe,iconPrimary:He,iconSecondary:Ee,iconOffset:Ye,iconAnchor:Ne,verticallyShapedIcon:at,layoutTextSize:Pe,layoutIconSize:ke,textOffset:Fe,isSDFIcon:pt,iconTextFit:yt,iconCollisionBounds:Ct,iconVerticalCollisionBounds:Wt})}return{featureData:le,sizes:I,hasAnySecondaryIcon:se,textAlongLine:ie,symbolPlacement:q}},o.fw=lv,o.fx=function(r,e,i,s,a,u,h,f,_,g){r.iconAtlasPositions=g.iconPositions;const{featureData:v,hasAnySecondaryIcon:b,sizes:w,textAlongLine:I,symbolPlacement:A}=e;for(const R of v){const{shapedIcon:L,verticallyShapedIcon:k,feature:U,shapedTextOrientations:G,shapedText:q,layoutTextSize:ie,textOffset:J,isSDFIcon:se,iconPrimary:le,iconSecondary:he,iconTextFit:Ce,iconOffset:ye,iconCollisionBounds:Pe,iconVerticalCollisionBounds:ke}=R;_v(L,g.iconPositions,le,he),_v(k,g.iconPositions,le,he),$w(G,g.iconPositions),qw(le,he,g.iconPositions),(q||L)&&Ww(r,U,G,L,k,_,w,ie,0,J,se,s,a,h,f,b,Ce,ye,I,A,Pe,ke)}i&&r.generateCollisionDebugBuffers(u,r.collisionBoxArray,w.textScaleFactor)},o.fy=xt,o.fz=am,o.g=function(r,e){return Vl(Object.assign(r,{method:"GET"}),e)},o.h=function(r){return r.indexOf("mapbox:")===0},o.i=function(r){return er.API_STYLE_REGEX.test(r)&&!wn(r)},o.j=Yr,o.k=Ro,o.l=function(r){return decodeURIComponent(atob(r).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},o.m=function(r,e){return Vl(Object.assign(r,{type:"json"}),e)},o.n=hh,o.o=Mi,o.p=function(r,e){return Vl(Object.assign(r,{method:"POST"}),e)},o.q=us,o.r=Ut,o.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch(e){return!1}},o.t=function(){return T_||(T_=new Mc),T_},o.u=function(){return(function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)})()},o.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},o.w=Mt,o.x=fg,o.y=Zl,o.z=$s})),ve(["./shared"],(function(o){function Oe(pe){const F=pe?pe.url.toString():void 0;return F?performance.getEntriesByName(F):[]}function $e(pe){if(typeof pe=="number"||typeof pe=="boolean"||typeof pe=="string"||pe==null)return JSON.stringify(pe);if(Array.isArray(pe)){let B="[";for(const X of pe)B+="".concat($e(X),",");return"".concat(B,"]")}let F="{";for(const B of Object.keys(pe).sort())F+="".concat(B,":").concat($e(pe[B]),",");return"".concat(F,"}")}function It(pe){let F="";for(const B of o.bw)F+="/".concat($e(pe[B]));return F}class lt{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,B){this._layerConfigs={},this._layers={},this.update(F,[],B)}update(F,B,X){this._options=X;for(const oe of F)this._layerConfigs[oe.id]=oe,(this._layers[oe.id]=o.dt(oe,this.scope,null,this._options)).compileFilter(X),this.keyCache[oe.id]&&delete this.keyCache[oe.id];for(const oe of B)delete this.keyCache[oe],delete this._layerConfigs[oe],delete this._layers[oe];this.familiesBySource={};const ae=(function(oe,de){const Se={};for(let be=0;be<oe.length;be++){const Ze=oe[be];let Ue=de&&de[Ze.id];Ue||(Ze.type==="symbol"?Ue=Ze.id:(Ue=It(Ze),Ze.type==="line"&&Ze.paint&&(function Bt(Lt){return typeof Lt=="string"&&Lt==="line-progress"||(Array.isArray(Lt)?Lt.some(Bt):!(!Lt||typeof Lt!="object")&&Object.values(Lt).some(Bt))})(Ze.paint["line-width"])&&(Ue+="/".concat($e(Ze.paint["line-width"]))))),de&&(de[Ze.id]=Ue);let vt=Se[Ue];vt||(vt=Se[Ue]=[]),vt.push(Ze)}const me=[];for(const be in Se)me.push(Se[be]);return me})(Object.values(this._layerConfigs),this.keyCache);for(const oe of ae){const de=oe.map((vt=>this._layers[vt.id])),Se=de[0];if(Se.visibility==="none")continue;const me=Se.source||"";let be=this.familiesBySource[me];be||(be=this.familiesBySource[me]={});const Ze=Se.sourceLayer||"_geojsonTileLayer";let Ue=be[Ze];Ue||(Ue=be[Ze]=[]),Ue.push(de)}}}const Tt=1*o.fk;class Rt{constructor(F){const B={},X=[];for(const Se in F){const me=F[Se],be=B[Se]={};for(const Ze in me.glyphs){const Ue=me.glyphs[+Ze];if(!Ue||Ue.bitmap.width===0||Ue.bitmap.height===0)continue;const vt=Ue.metrics.localGlyph?Tt:1,Bt={x:0,y:0,w:Ue.bitmap.width+2*vt,h:Ue.bitmap.height+2*vt};X.push(Bt),be[Ze]=Bt}}const{w:ae,h:oe}=o.G(X),de=new o.fj({width:ae||1,height:oe||1});for(const Se in F){const me=F[Se];for(const be in me.glyphs){const Ze=me.glyphs[+be];if(!Ze||Ze.bitmap.width===0||Ze.bitmap.height===0)continue;const Ue=B[Se][be],vt=Ze.metrics.localGlyph?Tt:1;o.fj.copy(Ze.bitmap,de,{x:0,y:0},{x:Ue.x+vt,y:Ue.y+vt},Ze.bitmap)}}this.image=de,this.positions=B}}function ai(pe,F,B){pe[F]?B&&(pe[F].center=B):pe[F]={floorIds:new Set,center:B||[0,0],floors:{}}}function _t(pe,F,B,X){for(const ae of F)ai(pe,ae),pe[ae].floors[B]=X,pe[ae].floorIds.add(B)}function Ot(pe){return{id:pe.properties.id.toString(),center:pe.properties.center.toString().split(";").map(Number)}}function li(pe){return{id:pe.properties.id.toString(),isDefault:!!pe.properties.is_default&&pe.properties.is_default,connections:pe.properties.connected_floor_ids?new Set(pe.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:pe.properties.conflicted_floor_ids?new Set(pe.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:pe.properties.building_ids?new Set(pe.properties.building_ids.toString().split(";")):new Set,name:pe.properties.name.toString(),zIndex:pe.properties.z_index}}function Xt(pe,F){return F.every((B=>pe.properties&&pe.properties[B]!=null))}function gi(pe){return Xt(pe,["type","id","name"])&&pe.properties.type==="building"}function hi(pe){return Xt(pe,["type","id","name","z_index"])&&pe.properties.type==="floor"}o.fi(Rt,"GlyphAtlas");class Wi{constructor(F){this.tileID=new o.aP(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.lut=F.lut,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.scope=F.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=F.showCollisionBoxes,this.collectResourceTiming=!!F.request&&F.request.collectResourceTiming,this.promoteId=F.promoteId,this.isSymbolTile=F.isSymbolTile,this.tileTransform=o.aY(F.tileID.canonical,F.projection),this.projection=F.projection,this.worldview=F.worldview,this.localizableLayerIds=F.localizableLayerIds,this.brightness=F.brightness,this.extraShadowCaster=!!F.extraShadowCaster,this.tessellationStep=F.tessellationStep,this.scaleFactor=F.scaleFactor,this.worldview=F.worldview,this.indoor=F.indoor}parse(F,B,X,ae,oe,de){this.status="parsing",this.data=F,this.collisionBoxArray=new o.b2;const Se=new o.fl(Object.keys(F.layers).sort()),me=new o.fm(this.tileID,this.promoteId);me.bucketLayerIDs=[];const be={},Ze=new o.fn(256,256),Ue={featureIndex:me,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Ze,availableImages:X,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const Mt=this.indoor.indoorState.activeFloorsVisible,ei=(function(ri,Fi,Sr){const en=(function(Ai,ui){if(!Ai)return o.w("No source layers defined in indoor specification"),ui;if(Ai.size===0)return ui;const lr=Ai.difference(ui);for(const pr of lr)o.w("Missing source layer required in indoor specification: ".concat(pr));return ui.intersection(ui)})(Fi.sourceLayers,new Set(Object.keys(ri.layers))),Dr=Fi.indoorState,Er=(function(Ai,ui,lr,pr){const Di=new Set,er=new Set,Yr=new Set,wn=new Map,_s={},Co=pn=>{const Is=wn.get(pn)||new Set;for(const es of Di)if((wn.get(es)||new Set).has(pn)||Is.has(es))return!0;return!1};for(const pn of ui){const Is=Ai.layers[pn];if(Is)for(let es=0;es<Is.length;es++){const Ht=Is.feature(es);if(gi(Ht)){const{id:Ut,center:Mi}=Ot(Ht);ai(_s,Ut,Mi),Di.add(Ut)}else if(hi(Ht)){const{id:Ut,isDefault:Mi,connections:ji,conflicts:mr,buildings:hn,name:sr,zIndex:jn}=li(Ht);_t(_s,hn,Ut,{name:sr,zIndex:jn}),wn.set(Ut,mr),(Ut===pr||ji.has(pr))&&Di.add(Ut),er.add(Ut),Mi&&Yr.add(Ut)}}else o.w("indoor source layer not found: ".concat(pn))}if(lr)for(const pn of lr)er.has(pn)&&(Co(pn)||Di.add(pn));for(const pn of Yr)Di.has(pn)||Co(pn)||Di.add(pn);return{buildings:_s,activeFloors:Di}})(ri,en,Dr.lastActiveFloors,Dr.selectedFloorId);return Sr.send("setIndoorData",Er),Er})(F,this.indoor,oe);Ue.activeFloors=Mt?ei.activeFloors:void 0}const vt=[],Bt=B.familiesBySource[this.source];for(const Mt in Bt){const ei=F.layers[Mt];if(!ei)continue;let ri=!1,Fi=!1,Sr=!1;for(const Ai of Bt[Mt])Ai[0].type==="symbol"?ri=!0:Fi=!0,Ai[0].is3D()&&Ai[0].type!=="model"&&(Sr=!0);if(this.extraShadowCaster&&!Sr||this.isSymbolTile===!0&&!ri||this.isSymbolTile===!1&&!Fi)continue;ei.version===1&&o.w('Vector tile source "'.concat(this.source,'" layer "').concat(Mt,'" does not use vector tile spec v2 and therefore may have some rendering errors.'));const en=Se.encode(Mt),Dr=[];let Er=!1;for(let Ai=0,ui=0;Ai<ei.length;Ai++){const lr=ei.feature(Ai),pr=me.getId(lr,Mt);if(this.localizableLayerIds&&this.localizableLayerIds.has(Mt)){const Di=lr.properties?lr.properties.worldview:null;if(this.worldview&&typeof Di=="string")if(Di==="all")lr.properties.$localized=!0;else{if(!Di.split(",").includes(this.worldview))continue;lr.properties.$localized=!0,lr.properties.worldview=this.worldview}}!Er&&lr.properties&&lr.properties.hasOwnProperty(o.fo)&&(Er=!0),Dr.push({feature:lr,id:pr,index:ui,sourceLayerIndex:en}),ui++}Er&&!Ue.elevationFeatures&&F.layers.hasOwnProperty(o.fp)&&(Ue.elevationFeatures=o.fq.parseFrom(F.layers[o.fp],this.canonical));for(const Ai of Bt[Mt]){const ui=Ai[0];if(this.extraShadowCaster&&(!ui.is3D()||ui.type==="model")||this.isSymbolTile!==void 0&&ui.type==="symbol"!==this.isSymbolTile||ui.minzoom&&this.zoom<Math.floor(ui.minzoom)||ui.maxzoom&&this.zoom>=ui.maxzoom||ui.visibility==="none")continue;ci(Ai,this.zoom,Ue.brightness,X,this.worldview);const lr=be[ui.id]=ui.createBucket({index:me.bucketLayerIDs.length,layers:Ai,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:en,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:ae,worldview:this.worldview});me.bucketLayerIDs.push(Ai.map((Di=>o.B(Di.id,Di.scope))));let pr=lr.prepare?lr.prepare():null;pr!=null?(pr=pr.then((()=>lr.populate(Dr,Ue,this.tileID.canonical,this.tileTransform))),vt.push(pr)):lr.populate(Dr,Ue,this.tileID.canonical,this.tileTransform)}}const Lt=()=>{let Mt,ei,ri,Fi,Sr,en;Ze.trim();const Dr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Er=()=>{if(Mt)return this.status="done",de(Mt);if(this.extraShadowCaster)this.status="done",de(null,{buckets:Object.values(be).filter((ui=>!ui.isEmpty())),featureIndex:me,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Ue.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(ei&&ri&&Fi){const ui=new Rt(ei),lr=new Map;for(const[er,Yr]of ri.entries()){const{imagePosition:wn}=o.ft(er,Yr,o.fu);lr.set(er,wn)}const pr={};for(const er in be){const Yr=be[er];Yr instanceof o.b3&&(ci(Yr.layers,this.zoom,Ue.brightness,X,this.worldview),pr[er]=o.fv(Yr,ei,ui.positions,ri,lr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Sr,this.worldview))}const Di={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(oe,ri,Sr,(()=>{Di.iconsPending=!1,Ai(pr,ui,Di)})),this.rasterizeIfNeeded(oe,Fi,en,(()=>{Di.patternsPending=!1,Ai(pr,ui,Di)}))}},Ai=(ui,lr,pr,Di)=>{if(pr.iconsPending||pr.patternsPending)return;const er=new o.fw(ri,Fi,this.lut);for(const Yr in be){const wn=be[Yr];if(Yr in ui)o.fx(wn,ui[Yr],this.showCollisionBoxes,X,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,ri,er);else if(wn.hasPattern&&(wn instanceof o.b9||wn instanceof o.ba||wn instanceof o.e9)){ci(wn.layers,this.zoom,Ue.brightness,X,this.worldview);const _s=Object.fromEntries(er.patternPositions);wn.addFeatures(Ue,this.tileID.canonical,_s,X,this.tileTransform,this.brightness)}}this.status="done",de(null,{buckets:Object.values(be).filter((Yr=>!Yr.isEmpty())),featureIndex:me,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:lr.image,lineAtlas:Ze,imageAtlas:er,brightness:Ue.brightness})};if(!this.extraShadowCaster){const ui=o.fr(Ue.glyphDependencies,(Di=>Object.keys(Di).map(Number)));Object.keys(ui).length?oe.send("getGlyphs",{uid:this.uid,stacks:ui},((Di,er)=>{Mt||(Mt=Di,ei=er,Er())}),void 0,!1,Dr):ei={};const lr=Array.from(Ue.iconDependencies.keys()).map((Di=>o.I.parse(Di)));lr.length?oe.send("getImages",{images:lr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((Di,er)=>{Mt||(Mt=Di,ri=new Map,Sr=this.updateImageMapAndGetImageTaskQueue(ri,er,Ue.iconDependencies),Er())}),void 0,!1,Dr):(ri=new Map,Sr=new Map);const pr=Array.from(Ue.patternDependencies.keys()).map((Di=>o.I.parse(Di)));pr.length?oe.send("getImages",{images:pr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((Di,er)=>{Mt||(Mt=Di,Fi=new Map,en=this.updateImageMapAndGetImageTaskQueue(Fi,er,Ue.patternDependencies),Er())}),void 0,!1,Dr):(Fi=new Map,en=new Map)}if(Ue.elevationFeatures&&Ue.elevationFeatures.length>0){const ui=[];for(const pr of Object.values(be))if(pr instanceof o.ba){const Di=pr.getUnevaluatedPortalGraph();Di&&ui.push(Di)}const lr=o.fs.evaluate(ui);for(const pr of Object.values(be))if(pr instanceof o.ba){const Di=F.layers[Se.decode(pr.sourceLayerIndex)];pr.setEvaluatedPortalGraph(lr,Di,this.tileID.canonical,Ue.availableImages,Ue.brightness)}}Er()};vt.length>0?Promise.allSettled(vt).then(Lt).catch(de):Lt()}updateParameters(F){this.scaleFactor=F.scaleFactor,this.showCollisionBoxes=F.showCollisionBoxes,this.projection=F.projection,this.brightness=F.brightness,this.tileTransform=o.aY(F.tileID.canonical,F.projection),this.extraShadowCaster=F.extraShadowCaster,this.lut=F.lut,this.worldview=F.worldview,this.indoor=F.indoor}rasterizeIfNeeded(F,B,X,ae){Array.from(B.values()).some((oe=>oe.usvg))?this.rasterize(F,B,X,ae):ae()}updateImageMapAndGetImageTaskQueue(F,B,X){const ae=new Map;for(const oe of B.keys()){const de=X.get(oe)||[];for(const Se of de){const me=Se.toString(),be=B.get(Se.id.toString());be.usvg?ae.has(me)||(ae.set(me,Se),F.set(me,Object.assign({},be))):F.set(me,be)}}return ae}rasterize(F,B,X,ae){this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,tasks:X},((oe,de)=>{if(!oe)for(const[Se,me]of de.entries()){const be=Object.assign(B.get(Se),{data:me});B.set(Se,be)}ae()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function ci(pe,F,B,X,ae){const oe=new o.ac(F,{brightness:B,worldview:ae});for(const de of pe)de.recalculate(oe,X)}class yi extends o.E{constructor(F,B,X,ae,oe,de,Se){super(),this.actor=F,this.layerIndex=B,this.availableImages=X,this.availableModels=ae,this.loadVectorData=de||o.aL,this.loading={},this.loaded={},this.deduped=new o.aK(F.scheduler),this.isSpriteLoaded=oe,this.scheduler=F.scheduler,this.brightness=Se}loadTile(F,B){const X=F.uid,ae=F&&F.request,oe=ae&&ae.collectResourceTiming,de=this.loading[X]=new Wi(F);de.abort=this.loadVectorData(F,((Se,me)=>{const be=!this.loading[X];if(delete this.loading[X],de.cancelRasterize(),be||Se||!me)return de.status="done",be||(this.loaded[X]=de),B(Se);const Ze=me.rawData,Ue={},vt=o.aM(me.responseHeaders);vt&&vt.expires&&(Ue.expires=vt.expires),vt&&vt.cacheControl&&(Ue.cacheControl=vt.cacheControl),de.vectorTile=me.vectorTile||new o.fy(new o.bs(Ze));const Bt=()=>{de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((Lt,Mt)=>{if(Lt||!Mt)return B(Lt);const ei={};if(oe){const ri=Oe(ae);ri.length>0&&(ei.resourceTiming=JSON.parse(JSON.stringify(ri)))}B(null,Object.assign({rawTileData:Ze.slice(0),responseHeaders:me.responseHeaders},Mt,Ue,ei))}))};this.isSpriteLoaded?Bt():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(Bt,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom}):Bt()})),this.loaded=this.loaded||{},this.loaded[X]=de}))}reloadTile(F,B){const X=this.loaded,ae=F.uid;if(X&&X[ae]){const oe=X[ae];oe.updateParameters(F);const de=(Se,me)=>{const be=oe.reloadCallback;be&&(delete oe.reloadCallback,oe.parse(oe.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,be)),B(Se,me)};oe.status==="parsing"?oe.reloadCallback=de:oe.status==="done"&&(oe.vectorTile?oe.parse(oe.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,de):de())}else B(null,void 0)}abortTile(F,B){const X=F.uid,ae=this.loading[X];ae&&(ae.abort&&ae.abort(),delete this.loading[X]),B()}removeTile(F,B){const X=this.loaded,ae=F.uid;X&&X[ae]&&delete X[ae],B()}}class Ii{loadTile(F,B){const{uid:X,encoding:ae,rawImageData:oe,padding:de}=F,Se=ImageBitmap&&oe instanceof ImageBitmap?this.getImageData(oe,de):oe;B(null,new o.fz(X,Se,ae,de<1))}reloadTile(F,B){B(null,null)}abortTile(F,B){B()}removeTile(F,B){B()}getImageData(F,B){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const X=this.offscreenCanvasContext.getImageData(-B,-B,F.width+2*B,F.height+2*B);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),X}}o.br.setPbf(o.bs);class xr{constructor(F){this._mrt=new o.br(F.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=F.uid,this.tileID=F.tileID,this.source=F.source}parse(F,B){const X=this._mrt;this.status="parsing",this._entireBuffer=F;try{X.parseHeader(F),this._isHeaderLoaded=!0;const ae=[];for(const oe in X.layers){const de=X.getLayer(oe),Se=de.getDataRange(de.getBandList()),me=X.createDecodingTask(Se),be=F.slice(Se.firstByte,Se.lastByte+1),Ze=o.br.performDecoding(be,me).then((Ue=>me.complete(null,Ue))).catch((Ue=>me.complete(Ue,null)));ae.push(Ze)}Promise.allSettled(ae).then((()=>B(null,X))).catch((oe=>B(oe)))}catch(ae){B(ae)}}}class Lr{constructor(F){this.actor=F,this.loading={},this.loaded={}}loadTile(F,B){const X=F.uid,ae=F.request,oe=this.loading[X]=new xr(F),{cancel:de}=o.bt(ae,((Se,me,be)=>{const Ze=!this.loading[X];if(delete this.loading[X],Ze||Se||!me)return oe.status="done",Ze||(this.loaded[X]=oe),B(Se);oe.parse(me,((Ue,vt)=>{if(Ue||!vt)return B(Ue);B(null,vt,be)})),this.loaded[X]=oe}));oe.abort=de}reloadTile(F,B){B(null,void 0)}abortTile(F,B){const X=F.uid,ae=this.loading[X];ae&&(ae.abort&&ae.abort(),delete this.loading[X]),B()}removeTile(F,B){const X=F.uid;this.loaded[X]&&delete this.loaded[X],B()}decodeRasterArray(F,B){o.br.performDecoding(F.buffer,F.task).then((X=>B(null,X))).catch((X=>B(X)))}}const vr=o.fA.prototype.toGeoJSON;class mi{constructor(F){this._feature=F,this.extent=o.al,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(this._feature.type===1){const F=[];for(const B of this._feature.geometry)F.push([new o.P(B[0],B[1])]);return F}{const F=[];for(const B of this._feature.geometry){const X=[];for(const ae of B)X.push(new o.P(ae[0],ae[1]));F.push(X)}return F}}toGeoJSON(F,B,X){return vr.call(this,F,B,X)}}class Pt{constructor(F,B){this.name=F,this.extent=o.al,this.length=B.length,this._jsonFeatures=B}feature(F){return new mi(this._jsonFeatures[F])}}class wr{constructor(F){this.layers={},this.extent=o.al;for(const B of Object.keys(F))this.layers[B]=new Pt(B,F[B])}}const ir=64/4096,qi=128;class di{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],B){for(const X of F){const ae=X.id;if(ae==null)continue;let oe=this.features.get(ae);oe&&this.updateCache(oe,B),X.geometry?(oe=Wr(X),this.updateCache(oe,B),this.features.set(ae,oe)):this.features.delete(ae),this.updateCache(oe,B)}}updateCache(F,B){for(const{canonical:X,uid:ae}of Object.values(B)){const{z:oe,x:de,y:Se}=X;ar(F,Math.pow(2,oe),de,Se)&&delete B[ae]}}getTile(F,B,X){const ae=Math.pow(2,F),oe=[];for(const de of this.features.values())ar(de,ae,B,X)&&oe.push(Xi(de,ae,B,X));return{features:oe}}getFeatures(){return[...this.features.values()]}}function ar({minX:pe,minY:F,maxX:B,maxY:X},ae,oe,de){return pe<(oe+1+ir)/ae&&F<(de+1+ir)/ae&&B>(oe-ir)/ae&&X>(de-ir)/ae}function Wr(pe){const{id:F,geometry:B,properties:X}=pe;if(!B)return;if(B.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ae,coordinates:oe}=B,de={id:F,type:1,geometry:[],tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Se=de.geometry;if(ae==="Point")Cn(oe,Se,de);else if(ae==="MultiPoint")for(const me of oe)Cn(me,Se,de);else if(ae==="LineString")de.type=2,hr(oe,Se,de);else if(ae==="MultiLineString")de.type=2,dn(oe,Se,de);else if(ae==="Polygon")de.type=3,dn(oe,Se,de,!0);else{if(ae!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");de.type=3;for(const me of oe)dn(me,Se,de,!0)}return de}function Cn([pe,F],B,X){const ae=o.aF(pe);let oe=o.aJ(F);oe=oe<0?0:oe>1?1:oe,B.push(ae,oe),X.minX=Math.min(X.minX,ae),X.minY=Math.min(X.minY,oe),X.maxX=Math.max(X.maxX,ae),X.maxY=Math.max(X.maxY,oe)}function hr(pe,F,B,X=!1,ae=!1){const oe=[];for(const de of pe)Cn(de,oe,B);F.push(oe),X&&(function(de,Se){let me=0;for(let be=0,Ze=de.length,Ue=Ze-2;be<Ze;Ue=be,be+=2)me+=(de[be]-de[Ue])*(de[be+1]+de[Ue+1]);if(me>0===Se)for(let be=0,Ze=de.length;be<Ze/2;be+=2){const Ue=de[be],vt=de[be+1];de[be]=de[Ze-2-be],de[be+1]=de[Ze-1-be],de[Ze-2-be]=Ue,de[Ze-1-be]=vt}})(oe,ae)}function dn(pe,F,B,X=!1){for(let ae=0;ae<pe.length;ae++)hr(pe[ae],F,B,X,ae===0)}function Xi(pe,F,B,X){const{id:ae,type:oe,geometry:de,tags:Se}=pe,me=[];if(oe===1)(function(be,Ze,Ue,vt,Bt){for(let Lt=0;Lt<be.length;Lt+=2){const Mt=Math.round(o.al*(be[Lt+0]*Ze-Ue)),ei=Math.round(o.al*(be[Lt+1]*Ze-vt));Bt.push([Mt,ei])}})(de,F,B,X,me);else for(const be of de)ns(be,F,B,X,me);return{id:ae,type:oe,geometry:me,tags:Se}}function ns(pe,F,B,X,ae){const oe=-qi,de=o.al+qi;let Se;for(let me=0;me<pe.length-2;me+=2){let be=Math.round(o.al*(pe[me+0]*F-B)),Ze=Math.round(o.al*(pe[me+1]*F-X)),Ue=Math.round(o.al*(pe[me+2]*F-B)),vt=Math.round(o.al*(pe[me+3]*F-X));const Bt=Ue-be,Lt=vt-Ze;be<oe&&Ue<oe||(be<oe?(Ze+=Math.round(Lt*((oe-be)/Bt)),be=oe):Ue<oe&&(vt=Ze+Math.round(Lt*((oe-be)/Bt)),Ue=oe),Ze<oe&&vt<oe||(Ze<oe?(be+=Math.round(Bt*((oe-Ze)/Lt)),Ze=oe):vt<oe&&(Ue=be+Math.round(Bt*((oe-Ze)/Lt)),vt=oe),be>=de&&Ue>=de||(be>=de?(Ze+=Math.round(Lt*((de-be)/Bt)),be=de):Ue>=de&&(vt=Ze+Math.round(Lt*((de-be)/Bt)),Ue=de),Ze>=de&&vt>=de||(Ze>=de?(be+=Math.round(Bt*((de-Ze)/Lt)),Ze=de):vt>=de&&(Ue=be+Math.round(Bt*((de-Ze)/Lt)),vt=de),Se&&be===Se[Se.length-1][0]&&Ze===Se[Se.length-1][1]||(Se=[[be,Ze]],ae.push(Se)),Se.push([Ue,vt])))))}}function Mo({name:pe,features:F},B){B.writeStringField(1,pe),B.writeVarintField(5,o.al);const X=new Map,ae=new Map,oe={keys:X,values:ae,feature:null};for(const de of F)oe.feature=de,B.writeMessage(2,xn,oe);for(const de of X.keys())B.writeStringField(3,de);for(const de of ae.keys())B.writeMessage(4,Fr,de)}function xn(pe,F){const B=pe.feature;B.id!==void 0&&Number.isSafeInteger(+B.id)&&F.writeVarintField(1,+B.id),B.tags&&F.writeMessage(2,lo,pe),F.writeVarintField(3,B.type),F.writeMessage(4,Qi,B)}function lo({keys:pe,values:F,feature:B},X){for(const ae of Object.keys(B.tags)){let oe=B.tags[ae];if(oe===null)continue;let de=pe.get(ae);de===void 0&&(de=pe.size,pe.set(ae,de)),X.writeVarint(de);const Se=typeof oe;Se!=="string"&&Se!=="boolean"&&Se!=="number"&&(oe=JSON.stringify(oe));let me=F.get(oe);me===void 0&&(me=F.size,F.set(oe,me)),X.writeVarint(me)}}function ss(pe,F){return(F<<3)+(7&pe)}function Yi(pe){return pe<<1^pe>>31}function Qi(pe,F){const{geometry:B,type:X}=pe;let ae=0,oe=0;if(X===1){F.writeVarint(ss(1,B.length));for(const de of B){const Se=de[0]-ae,me=de[1]-oe;F.writeVarint(Yi(Se)),F.writeVarint(Yi(me)),ae+=Se,oe+=me}}else for(const de of B){F.writeVarint(ss(1,1));const Se=de.length-(X===3?1:0);for(let me=0;me<Se;me++){me===1&&F.writeVarint(ss(2,Se-1));const be=de[me][0]-ae,Ze=de[me][1]-oe;F.writeVarint(Yi(be)),F.writeVarint(Yi(Ze)),ae+=be,oe+=Ze}X===3&&F.writeVarint(ss(7,1))}}function Fr(pe,F){const B=typeof pe;B==="string"?F.writeStringField(1,pe):B==="boolean"?F.writeBooleanField(7,pe):B==="number"&&(pe%1!=0?F.writeDoubleField(3,pe):pe<0?F.writeSVarintField(6,pe):F.writeVarintField(5,pe))}const Xn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:pe=>pe},dr=Math.fround||(os=new Float32Array(1),pe=>(os[0]=+pe,os[0]));var os;const Vn=3,Br=5,fs=6;class Rr{constructor(F){this.options=Object.assign(Object.create(Xn),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:B,minZoom:X,maxZoom:ae}=this.options;B&&console.time("total time");const oe="prepare ".concat(F.length," points");B&&console.time(oe),this.points=F;const de=[];for(let me=0;me<F.length;me++){const be=F[me];if(!be.geometry)continue;const[Ze,Ue]=be.geometry.coordinates,vt=dr(nn(Ze)),Bt=dr(ps(Ue));de.push(vt,Bt,1/0,me,-1,1),this.options.reduce&&de.push(0)}let Se=this.trees[ae+1]=this._createTree(de);B&&console.timeEnd(oe);for(let me=ae;me>=X;me--){const be=+Date.now();Se=this.trees[me]=this._createTree(this._cluster(Se,me)),B&&console.log("z%d: %d clusters in %dms",me,Se.numItems,+Date.now()-be)}return B&&console.timeEnd("total time"),this}getClusters(F,B){let X=((F[0]+180)%360+360)%360-180;const ae=Math.max(-90,Math.min(90,F[1]));let oe=F[2]===180?180:((F[2]+180)%360+360)%360-180;const de=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)X=-180,oe=180;else if(X>oe){const Ue=this.getClusters([X,ae,180,de],B),vt=this.getClusters([-180,ae,oe,de],B);return Ue.concat(vt)}const Se=this.trees[this._limitZoom(B)],me=Se.range(nn(X),ps(de),nn(oe),ps(ae)),be=Se.data,Ze=[];for(const Ue of me){const vt=this.stride*Ue;Ze.push(be[vt+Br]>1?co(be,vt,this.clusterProps):this.points[be[vt+Vn]])}return Ze}getChildren(F){const B=this._getOriginId(F),X=this._getOriginZoom(F),ae="No cluster with the specified id.",oe=this.trees[X];if(!oe)throw new Error(ae);const de=oe.data;if(B*this.stride>=de.length)throw new Error(ae);const Se=this.options.radius/(this.options.extent*Math.pow(2,X-1)),me=oe.within(de[B*this.stride],de[B*this.stride+1],Se),be=[];for(const Ze of me){const Ue=Ze*this.stride;de[Ue+4]===F&&be.push(de[Ue+Br]>1?co(de,Ue,this.clusterProps):this.points[de[Ue+Vn]])}if(be.length===0)throw new Error(ae);return be}getLeaves(F,B,X){const ae=[];return this._appendLeaves(ae,F,B=B||10,X=X||0,0),ae}getTile(F,B,X){const ae=this.trees[this._limitZoom(F)],oe=Math.pow(2,F),{extent:de,radius:Se}=this.options,me=Se/de,be=(X-me)/oe,Ze=(X+1+me)/oe,Ue={features:[]};return this._addTileFeatures(ae.range((B-me)/oe,be,(B+1+me)/oe,Ze),ae.data,B,X,oe,Ue),B===0&&this._addTileFeatures(ae.range(1-me/oe,be,1,Ze),ae.data,oe,X,oe,Ue),B===oe-1&&this._addTileFeatures(ae.range(0,be,me/oe,Ze),ae.data,-1,X,oe,Ue),Ue.features.length?Ue:null}getClusterExpansionZoom(F){let B=this._getOriginZoom(F)-1;for(;B<=this.options.maxZoom;){const X=this.getChildren(F);if(B++,X.length!==1)break;F=X[0].properties.cluster_id}return B}_appendLeaves(F,B,X,ae,oe){const de=this.getChildren(B);for(const Se of de){const me=Se.properties;if(me&&me.cluster?oe+me.point_count<=ae?oe+=me.point_count:oe=this._appendLeaves(F,me.cluster_id,X,ae,oe):oe<ae?oe++:F.push(Se),F.length===X)break}return oe}_createTree(F){const B=new o.c3(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let X=0;X<F.length;X+=this.stride)B.add(F[X],F[X+1]);return B.finish(),B.data=F,B}_addTileFeatures(F,B,X,ae,oe,de){for(const Se of F){const me=Se*this.stride,be=B[me+Br]>1;let Ze,Ue,vt;if(be)Ze=Un(B,me,this.clusterProps),Ue=B[me],vt=B[me+1];else{const Mt=this.points[B[me+Vn]];Ze=Mt.properties;const[ei,ri]=Mt.geometry.coordinates;Ue=nn(ei),vt=ps(ri)}const Bt={type:1,geometry:[[Math.round(this.options.extent*(Ue*oe-X)),Math.round(this.options.extent*(vt*oe-ae))]],tags:Ze};let Lt;Lt=be||this.options.generateId?B[me+Vn]:this.points[B[me+Vn]].id,Lt!==void 0&&(Bt.id=Lt),de.features.push(Bt)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,B){const{radius:X,extent:ae,reduce:oe,minPoints:de}=this.options,Se=X/(ae*Math.pow(2,B)),me=F.data,be=[],Ze=this.stride;for(let Ue=0;Ue<me.length;Ue+=Ze){if(me[Ue+2]<=B)continue;me[Ue+2]=B;const vt=me[Ue],Bt=me[Ue+1],Lt=F.within(me[Ue],me[Ue+1],Se),Mt=me[Ue+Br];let ei=Mt;for(const ri of Lt){const Fi=ri*Ze;me[Fi+2]>B&&(ei+=me[Fi+Br])}if(ei>Mt&&ei>=de){let ri,Fi=vt*Mt,Sr=Bt*Mt,en=-1;const Dr=(Ue/Ze<<5)+(B+1)+this.points.length;for(const Er of Lt){const Ai=Er*Ze;if(me[Ai+2]<=B)continue;me[Ai+2]=B;const ui=me[Ai+Br];Fi+=me[Ai]*ui,Sr+=me[Ai+1]*ui,me[Ai+4]=Dr,oe&&(ri||(ri=this._map(me,Ue,!0),en=this.clusterProps.length,this.clusterProps.push(ri)),oe(ri,this._map(me,Ai)))}me[Ue+4]=Dr,be.push(Fi/ei,Sr/ei,1/0,Dr,-1,ei),oe&&be.push(en)}else{for(let ri=0;ri<Ze;ri++)be.push(me[Ue+ri]);if(ei>1)for(const ri of Lt){const Fi=ri*Ze;if(!(me[Fi+2]<=B)){me[Fi+2]=B;for(let Sr=0;Sr<Ze;Sr++)be.push(me[Fi+Sr])}}}}return be}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,B,X){if(F[B+Br]>1){const de=this.clusterProps[F[B+fs]];return X?Object.assign({},de):de}const ae=this.points[F[B+Vn]].properties,oe=this.options.map(ae);return X&&oe===ae?Object.assign({},oe):oe}}function co(pe,F,B){return{type:"Feature",id:pe[F+Vn],properties:Un(pe,F,B),geometry:{type:"Point",coordinates:[(X=pe[F],360*(X-.5)),uo(pe[F+1])]}};var X}function Un(pe,F,B){const X=pe[F+Br],ae=X>=1e4?"".concat(Math.round(X/1e3),"k"):X>=1e3?Math.round(X/100)/10+"k":X,oe=pe[F+fs],de=oe===-1?{}:Object.assign({},B[oe]);return Object.assign(de,{cluster:!0,cluster_id:pe[F+Vn],point_count:X,point_count_abbreviated:ae})}function nn(pe){return pe/360+.5}function ps(pe){const F=Math.sin(pe*Math.PI/180),B=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return B<0?0:B>1?1:B}function uo(pe){const F=(180-360*pe)*Math.PI/180;return 360*Math.atan(Math.exp(F))/Math.PI-90}function En(pe,F,B,X){let ae=X;const oe=F+(B-F>>1);let de,Se=B-F;const me=pe[F],be=pe[F+1],Ze=pe[B],Ue=pe[B+1];for(let vt=F+3;vt<B;vt+=3){const Bt=zs(pe[vt],pe[vt+1],me,be,Ze,Ue);if(Bt>ae)de=vt,ae=Bt;else if(Bt===ae){const Lt=Math.abs(vt-oe);Lt<Se&&(de=vt,Se=Lt)}}ae>X&&(de-F>3&&En(pe,F,de,X),pe[de+2]=ae,B-de>3&&En(pe,de,B,X))}function zs(pe,F,B,X,ae,oe){let de=ae-B,Se=oe-X;if(de!==0||Se!==0){const me=((pe-B)*de+(F-X)*Se)/(de*de+Se*Se);me>1?(B=ae,X=oe):me>0&&(B+=de*me,X+=Se*me)}return de=pe-B,Se=F-X,de*de+Se*Se}function ms(pe,F,B,X){const ae={id:pe!=null?pe:null,type:F,geometry:B,tags:X,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(F==="Point"||F==="MultiPoint"||F==="LineString")Yn(ae,B);else if(F==="Polygon")Yn(ae,B[0]);else if(F==="MultiLineString")for(const oe of B)Yn(ae,oe);else if(F==="MultiPolygon")for(const oe of B)Yn(ae,oe[0]);return ae}function Yn(pe,F){for(let B=0;B<F.length;B+=3)pe.minX=Math.min(pe.minX,F[B]),pe.minY=Math.min(pe.minY,F[B+1]),pe.maxX=Math.max(pe.maxX,F[B]),pe.maxY=Math.max(pe.maxY,F[B+1])}function Kn(pe,F,B,X){if(!F.geometry)return;const ae=F.geometry.coordinates;if(ae&&ae.length===0)return;const oe=F.geometry.type,de=Math.pow(B.tolerance/((1<<B.maxZoom)*B.extent),2);let Se=[],me=F.id;if(B.promoteId?me=F.properties[B.promoteId]:B.generateId&&(me=X||0),oe==="Point")vn(ae,Se);else if(oe==="MultiPoint")for(const be of ae)vn(be,Se);else if(oe==="LineString")Ls(ae,Se,de,!1);else if(oe==="MultiLineString"){if(B.lineMetrics){for(const be of ae)Se=[],Ls(be,Se,de,!1),pe.push(ms(me,"LineString",Se,F.properties));return}Tr(ae,Se,de,!1)}else if(oe==="Polygon")Tr(ae,Se,de,!0);else{if(oe!=="MultiPolygon"){if(oe==="GeometryCollection"){for(const be of F.geometry.geometries)Kn(pe,{id:me,geometry:be,properties:F.properties},B,X);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const be of ae){const Ze=[];Tr(be,Ze,de,!0),Se.push(Ze)}}pe.push(ms(me,oe,Se,F.properties))}function vn(pe,F){F.push(Hs(pe[0]),sn(pe[1]),0)}function Ls(pe,F,B,X){let ae,oe,de=0;for(let me=0;me<pe.length;me++){const be=Hs(pe[me][0]),Ze=sn(pe[me][1]);F.push(be,Ze,0),me>0&&(de+=X?(ae*Ze-be*oe)/2:Math.sqrt(Math.pow(be-ae,2)+Math.pow(Ze-oe,2))),ae=be,oe=Ze}const Se=F.length-3;F[2]=1,En(F,0,Se,B),F[Se+2]=1,F.size=Math.abs(de),F.start=0,F.end=F.size}function Tr(pe,F,B,X){for(let ae=0;ae<pe.length;ae++){const oe=[];Ls(pe[ae],oe,B,X),F.push(oe)}}function Hs(pe){return pe/360+.5}function sn(pe){const F=Math.sin(pe*Math.PI/180),B=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return B<0?0:B>1?1:B}function Ki(pe,F,B,X,ae,oe,de,Se){if(X/=F,oe>=(B/=F)&&de<X)return pe;if(de<B||oe>=X)return null;const me=[];for(const be of pe){const Ze=be.geometry;let Ue=be.type;const vt=ae===0?be.minX:be.minY,Bt=ae===0?be.maxX:be.maxY;if(vt>=B&&Bt<X){me.push(be);continue}if(Bt<B||vt>=X)continue;let Lt=[];if(Ue==="Point"||Ue==="MultiPoint")Jr(Ze,Lt,B,X,ae);else if(Ue==="LineString")Os(Ze,Lt,B,X,ae,!1,Se.lineMetrics);else if(Ue==="MultiLineString")Jn(Ze,Lt,B,X,ae,!1);else if(Ue==="Polygon")Jn(Ze,Lt,B,X,ae,!0);else if(Ue==="MultiPolygon")for(const Mt of Ze){const ei=[];Jn(Mt,ei,B,X,ae,!0),ei.length&&Lt.push(ei)}if(Lt.length){if(Se.lineMetrics&&Ue==="LineString"){for(const Mt of Lt)me.push(ms(be.id,Ue,Mt,be.tags));continue}Ue!=="LineString"&&Ue!=="MultiLineString"||(Lt.length===1?(Ue="LineString",Lt=Lt[0]):Ue="MultiLineString"),Ue!=="Point"&&Ue!=="MultiPoint"||(Ue=Lt.length===3?"Point":"MultiPoint"),me.push(ms(be.id,Ue,Lt,be.tags))}}return me.length?me:null}function Jr(pe,F,B,X,ae){for(let oe=0;oe<pe.length;oe+=3){const de=pe[oe+ae];de>=B&&de<=X&&zn(F,pe[oe],pe[oe+1],pe[oe+2])}}function Os(pe,F,B,X,ae,oe,de){let Se=Dn(pe);const me=ae===0?fr:fn;let be,Ze,Ue=pe.start;for(let ei=0;ei<pe.length-3;ei+=3){const ri=pe[ei],Fi=pe[ei+1],Sr=pe[ei+2],en=pe[ei+3],Dr=pe[ei+4],Er=ae===0?ri:Fi,Ai=ae===0?en:Dr;let ui=!1;de&&(be=Math.sqrt(Math.pow(ri-en,2)+Math.pow(Fi-Dr,2))),Er<B?Ai>B&&(Ze=me(Se,ri,Fi,en,Dr,B),de&&(Se.start=Ue+be*Ze)):Er>X?Ai<X&&(Ze=me(Se,ri,Fi,en,Dr,X),de&&(Se.start=Ue+be*Ze)):zn(Se,ri,Fi,Sr),Ai<B&&Er>=B&&(Ze=me(Se,ri,Fi,en,Dr,B),ui=!0),Ai>X&&Er<=X&&(Ze=me(Se,ri,Fi,en,Dr,X),ui=!0),!oe&&ui&&(de&&(Se.end=Ue+be*Ze),F.push(Se),Se=Dn(pe)),de&&(Ue+=be)}let vt=pe.length-3;const Bt=pe[vt],Lt=pe[vt+1],Mt=ae===0?Bt:Lt;Mt>=B&&Mt<=X&&zn(Se,Bt,Lt,pe[vt+2]),vt=Se.length-3,oe&&vt>=3&&(Se[vt]!==Se[0]||Se[vt+1]!==Se[1])&&zn(Se,Se[0],Se[1],Se[2]),Se.length&&F.push(Se)}function Dn(pe){const F=[];return F.size=pe.size,F.start=pe.start,F.end=pe.end,F}function Jn(pe,F,B,X,ae,oe){for(const de of pe)Os(de,F,B,X,ae,oe,!1)}function zn(pe,F,B,X){pe.push(F,B,X)}function fr(pe,F,B,X,ae,oe){const de=(oe-F)/(X-F);return zn(pe,oe,B+(ae-B)*de,1),de}function fn(pe,F,B,X,ae,oe){const de=(oe-B)/(ae-B);return zn(pe,F+(X-F)*de,oe,1),de}function Es(pe,F){const B=[];for(let X=0;X<pe.length;X++){const ae=pe[X],oe=ae.type;let de;if(oe==="Point"||oe==="MultiPoint"||oe==="LineString")de=Xr(ae.geometry,F);else if(oe==="MultiLineString"||oe==="Polygon"){de=[];for(const Se of ae.geometry)de.push(Xr(Se,F))}else if(oe==="MultiPolygon"){de=[];for(const Se of ae.geometry){const me=[];for(const be of Se)me.push(Xr(be,F));de.push(me)}}B.push(ms(ae.id,oe,de,ae.tags))}return B}function Xr(pe,F){const B=[];B.size=pe.size,pe.start!==void 0&&(B.start=pe.start,B.end=pe.end);for(let X=0;X<pe.length;X+=3)B.push(pe[X]+F,pe[X+1],pe[X+2]);return B}function jr(pe,F){if(pe.transformed)return pe;const B=1<<pe.z,X=pe.x,ae=pe.y;for(const oe of pe.features){const de=oe.geometry,Se=oe.type;if(oe.geometry=[],Se===1)for(let me=0;me<de.length;me+=2)oe.geometry.push(In(de[me],de[me+1],F,B,X,ae));else for(let me=0;me<de.length;me++){const be=[];for(let Ze=0;Ze<de[me].length;Ze+=2)be.push(In(de[me][Ze],de[me][Ze+1],F,B,X,ae));oe.geometry.push(be)}}return pe.transformed=!0,pe}function In(pe,F,B,X,ae,oe){return[Math.round(B*(pe*X-ae)),Math.round(B*(F*X-oe))]}function Qn(pe,F,B,X,ae){const oe=F===ae.maxZoom?0:ae.tolerance/((1<<F)*ae.extent),de={features:[],numPoints:0,numSimplified:0,numFeatures:pe.length,source:null,x:B,y:X,z:F,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Se of pe)Ln(de,Se,oe,ae);return de}function Ln(pe,F,B,X){const ae=F.geometry,oe=F.type,de=[];if(pe.minX=Math.min(pe.minX,F.minX),pe.minY=Math.min(pe.minY,F.minY),pe.maxX=Math.max(pe.maxX,F.maxX),pe.maxY=Math.max(pe.maxY,F.maxY),oe==="Point"||oe==="MultiPoint")for(let Se=0;Se<ae.length;Se+=3)de.push(ae[Se],ae[Se+1]),pe.numPoints++,pe.numSimplified++;else if(oe==="LineString")bn(de,ae,pe,B,!1,!1);else if(oe==="MultiLineString"||oe==="Polygon")for(let Se=0;Se<ae.length;Se++)bn(de,ae[Se],pe,B,oe==="Polygon",Se===0);else if(oe==="MultiPolygon")for(let Se=0;Se<ae.length;Se++){const me=ae[Se];for(let be=0;be<me.length;be++)bn(de,me[be],pe,B,!0,be===0)}if(de.length){let Se=F.tags||null;if(oe==="LineString"&&X.lineMetrics){Se={};for(const be in F.tags)Se[be]=F.tags[be];Se.mapbox_clip_start=ae.start/ae.size,Se.mapbox_clip_end=ae.end/ae.size}const me={geometry:de,type:oe==="Polygon"||oe==="MultiPolygon"?3:oe==="LineString"||oe==="MultiLineString"?2:1,tags:Se};F.id!==null&&(me.id=F.id),pe.features.push(me)}}function bn(pe,F,B,X,ae,oe){const de=X*X;if(X>0&&F.size<(ae?de:X))return void(B.numPoints+=F.length/3);const Se=[];for(let me=0;me<F.length;me+=3)(X===0||F[me+2]>de)&&(B.numSimplified++,Se.push(F[me],F[me+1])),B.numPoints++;ae&&(function(me,be){let Ze=0;for(let Ue=0,vt=me.length,Bt=vt-2;Ue<vt;Bt=Ue,Ue+=2)Ze+=(me[Ue]-me[Bt])*(me[Ue+1]+me[Bt+1]);if(Ze>0===be)for(let Ue=0,vt=me.length;Ue<vt/2;Ue+=2){const Bt=me[Ue],Lt=me[Ue+1];me[Ue]=me[vt-2-Ue],me[Ue+1]=me[vt-1-Ue],me[vt-2-Ue]=Bt,me[vt-1-Ue]=Lt}})(Se,oe),pe.push(Se)}const Be={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class On{constructor(F,B){const X=(B=this.options=(function(oe,de){for(const Se in de)oe[Se]=de[Se];return oe})(Object.create(Be),B)).debug;if(X&&console.time("preprocess data"),B.maxZoom<0||B.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(B.promoteId&&B.generateId)throw new Error("promoteId and generateId cannot be used together.");let ae=(function(oe,de){const Se=[];if(oe.type==="FeatureCollection")for(let me=0;me<oe.features.length;me++)Kn(Se,oe.features[me],de,me);else Kn(Se,oe.type==="Feature"?oe:{geometry:oe},de);return Se})(F,B);this.tiles={},this.tileCoords=[],X&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",B.indexMaxZoom,B.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ae=(function(oe,de){const Se=de.buffer/de.extent;let me=oe;const be=Ki(oe,1,-1-Se,Se,0,-1,2,de),Ze=Ki(oe,1,1-Se,2+Se,0,-1,2,de);return(be||Ze)&&(me=Ki(oe,1,-Se,1+Se,0,-1,2,de)||[],be&&(me=Es(be,1).concat(me)),Ze&&(me=me.concat(Es(Ze,-1)))),me})(ae,B),ae.length&&this.splitTile(ae,0,0,0),X&&(ae.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,B,X,ae,oe,de,Se){const me=[F,B,X,ae],be=this.options,Ze=be.debug;for(;me.length;){ae=me.pop(),X=me.pop(),B=me.pop(),F=me.pop();const Ue=1<<B,vt=cn(B,X,ae);let Bt=this.tiles[vt];if(!Bt&&(Ze>1&&console.time("creation"),Bt=this.tiles[vt]=Qn(F,B,X,ae,be),this.tileCoords.push({z:B,x:X,y:ae}),Ze)){Ze>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",B,X,ae,Bt.numFeatures,Bt.numPoints,Bt.numSimplified),console.timeEnd("creation"));const ui="z".concat(B);this.stats[ui]=(this.stats[ui]||0)+1,this.total++}if(Bt.source=F,oe==null){if(B===be.indexMaxZoom||Bt.numPoints<=be.indexMaxPoints)continue}else{if(B===be.maxZoom||B===oe)continue;if(oe!=null){const ui=oe-B;if(X!==de>>ui||ae!==Se>>ui)continue}}if(Bt.source=null,F.length===0)continue;Ze>1&&console.time("clipping");const Lt=.5*be.buffer/be.extent,Mt=.5-Lt,ei=.5+Lt,ri=1+Lt;let Fi=null,Sr=null,en=null,Dr=null,Er=Ki(F,Ue,X-Lt,X+ei,0,Bt.minX,Bt.maxX,be),Ai=Ki(F,Ue,X+Mt,X+ri,0,Bt.minX,Bt.maxX,be);F=null,Er&&(Fi=Ki(Er,Ue,ae-Lt,ae+ei,1,Bt.minY,Bt.maxY,be),Sr=Ki(Er,Ue,ae+Mt,ae+ri,1,Bt.minY,Bt.maxY,be),Er=null),Ai&&(en=Ki(Ai,Ue,ae-Lt,ae+ei,1,Bt.minY,Bt.maxY,be),Dr=Ki(Ai,Ue,ae+Mt,ae+ri,1,Bt.minY,Bt.maxY,be),Ai=null),Ze>1&&console.timeEnd("clipping"),me.push(Fi||[],B+1,2*X,2*ae),me.push(Sr||[],B+1,2*X,2*ae+1),me.push(en||[],B+1,2*X+1,2*ae),me.push(Dr||[],B+1,2*X+1,2*ae+1)}}getTile(F,B,X){F=+F,B=+B,X=+X;const ae=this.options,{extent:oe,debug:de}=ae;if(F<0||F>24)return null;const Se=1<<F,me=cn(F,B=B+Se&Se-1,X);if(this.tiles[me])return jr(this.tiles[me],oe);de>1&&console.log("drilling down to z%d-%d-%d",F,B,X);let be,Ze=F,Ue=B,vt=X;for(;!be&&Ze>0;)Ze--,Ue>>=1,vt>>=1,be=this.tiles[cn(Ze,Ue,vt)];return be&&be.source?(de>1&&(console.log("found parent tile z%d-%d-%d",Ze,Ue,vt),console.time("drilling down")),this.splitTile(be.source,Ze,Ue,vt,F,B,X),de>1&&console.timeEnd("drilling down"),this.tiles[me]?jr(this.tiles[me],oe):null):null}}function cn(pe,F,B){return 32*((1<<pe)*B+F)+pe}function as(pe,F){const B=pe.tileID.canonical;if(!this._geoJSONIndex)return void F(null,null);const X=this._geoJSONIndex.getTile(B.z,B.x,B.y);if(!X)return void F(null,null);const ae=be=>be.tags&&"3d_elevation_id"in be.tags&&"source"in be.tags&&be.tags.source==="elevation",oe=X.features.filter((be=>ae(be)));let de={_geojsonTileLayer:X.features};oe.length>0&&(de={_geojsonTileLayer:X.features.filter((be=>!ae(be))),hd_road_elevation:oe});const Se=new wr(de),me=(function(be){const Ze=new o.bs;for(const Ue of Object.keys(be))Ze.writeMessage(3,Mo,{name:Ue,features:be[Ue]});return Ze.finish()})(de).buffer;F(null,{vectorTile:Se,rawData:me})}class Qt extends yi{constructor(F,B,X,ae,oe,de,Se){super(F,B,X,ae,oe,as,Se),de&&(this.loadGeoJSON=de),this._dynamicIndex=new di}loadData(F,B){const X=F&&F.request,ae=X&&X.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(F,((oe,de)=>{if(oe||!de)return B(oe);if(typeof de!="object")return B(new Error("Input data given to '".concat(F.source,"' is not a valid GeoJSON object.")));{try{if(F.filter){const me=o.U(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(me.result==="error")throw new Error(me.value.map((be=>"".concat(be.key,": ").concat(be.message))).join(", "));de.features=de.features.filter((be=>me.value.evaluate({zoom:0},be)))}F.dynamic?(de.type==="Feature"&&(de={type:"FeatureCollection",features:[de]}),F.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(de.features,this.loaded),F.cluster&&(de.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=F.cluster?new Rr((function({superclusterOptions:me,clusterProperties:be}){if(!be||!me)return me;const Ze={},Ue={},vt={accumulated:null,zoom:0},Bt={properties:null},Lt=Object.keys(be);for(const Mt of Lt){const[ei,ri]=be[Mt],Fi=o.U(ri),Sr=o.U(typeof ei=="string"?[ei,["accumulated"],["get",Mt]]:ei);Ze[Mt]=Fi.value,Ue[Mt]=Sr.value}return me.map=Mt=>{Bt.properties=Mt;const ei={};for(const ri of Lt)ei[ri]=Ze[ri].evaluate(vt,Bt);return ei},me.reduce=(Mt,ei)=>{Bt.properties=ei;for(const ri of Lt)vt.accumulated=Mt[ri],Mt[ri]=Ue[ri].evaluate(vt,Bt)},me})(F)).load(de.features):F.dynamic?this._dynamicIndex:(function(me,be){return new On(me,be)})(de,F.geojsonVtOptions)}catch(me){return B(me)}const Se={};if(ae){const me=Oe(X);me&&(Se.resourceTiming={},Se.resourceTiming[F.source]=JSON.parse(JSON.stringify(me)))}B(null,Se)}}))}reloadTile(F,B){const X=this.loaded;return X&&X[F.uid]?F.partial?B(null,void 0):super.reloadTile(F,B):this.loadTile(F,B)}loadGeoJSON(F,B){if(F.request)o.m(F.request,B);else{if(typeof F.data!="string")return B(new Error("Input data given to '".concat(F.source,"' is not a valid GeoJSON object.")));setTimeout((()=>{try{return B(null,JSON.parse(F.data))}catch(X){return B(new Error("Input data given to '".concat(F.source,"' is not a valid GeoJSON object.")))}}),0)}}getClusterExpansionZoom(F,B){try{B(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(X){B(X)}}getClusterChildren(F,B){try{B(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(X){B(X)}}getClusterLeaves(F,B){try{B(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(X){B(X)}}}class Qr{constructor(F,B,X){this.tileID=new o.aP(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=B,this.worldview=X}parse(F,B,X,ae){this.status="parsing";const oe=new o.aP(X.tileID.overscaledZ,X.tileID.wrap,X.tileID.canonical.z,X.tileID.canonical.x,X.tileID.canonical.y),de=[],Se=B.familiesBySource[X.source],me=new o.fm(oe,X.promoteId);me.bucketLayerIDs=[],me.is3DTile=!0,o.fB(F).then((be=>{if(!be)return ae(new Error("Could not parse tile"));const Ze=be.json.extensionsUsed&&be.json.extensionsUsed.includes("MAPBOX_mesh_features")||be.json.asset.extras&&be.json.asset.extras.MAPBOX_mesh_features,Ue=be.json.extensionsUsed&&be.json.extensionsUsed.includes("EXT_meshopt_compression"),vt=new o.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const Bt in Se)for(const Lt of Se[Bt]){const Mt=Lt[0];me.bucketLayerIDs.push(Lt.map((Fi=>o.B(Fi.id,Fi.scope)))),Mt.recalculate(vt,[]);const ei=o.fC(be,1/o.d6(X.tileID.canonical)),ri=new o.fD(Lt,ei,oe,Ze,Ue,this.brightness,me,this.worldview);Ze||(ri.needsUpload=!0),de.push(ri),ri.evaluate(Mt)}this.status="done",ae(null,{buckets:de,featureIndex:me,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((be=>ae(new Error(be.message))))}}class ks{constructor(F,B,X,ae,oe,de,Se,me){this.actor=F,this.layerIndex=B,this.availableImages=X,this.availableModels=ae,this.brightness=Se,this.loading={},this.loaded={},this.worldview=me}loadTile(F,B){const X=F.uid,ae=this.loading[X]=new Qr(F,this.brightness,this.worldview);o.bt(F.request,((oe,de)=>{const Se=!this.loading[X];return delete this.loading[X],Se||oe?(ae.status="done",Se||(this.loaded[X]=ae),B(oe)):de&&de.byteLength!==0?void ae.parse(de,this.layerIndex,F,((me,be)=>{ae.status="done",this.loaded=this.loaded||{},this.loaded[X]=ae,me||!be?B(me):B(null,be)})):(ae.status="done",this.loaded[X]=ae,B())}))}reloadTile(F,B){const X=this.loaded,ae=F.uid;if(X&&X[ae]){const oe=X[ae];oe.projection=F.projection,oe.brightness=F.brightness;const de=(Se,me)=>{oe.reloadCallback&&(delete oe.reloadCallback,this.loadTile(F,B)),B(Se,me)};oe.status==="parsing"?oe.reloadCallback=de:oe.status==="done"&&this.loadTile(F,B)}}abortTile(F,B){const X=F.uid;this.loading[X]&&delete this.loading[X],B()}removeTile(F,B){const X=this.loaded,ae=F.uid;X&&X[ae]&&delete X[ae],B()}}class xs{constructor(F){this.self=F,this.actor=new o.fF(F,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new o.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=o.cl({name:"mercator"}),this.workerSourceTypes={vector:yi,geojson:Qt,"raster-dem":Ii,"raster-array":Lr,"batched-model":ks},this.workerSources={},this.self.registerWorkerSource=(B,X)=>{if(this.workerSourceTypes[B])throw new Error('Worker source with name "'.concat(B,'" already registered.'));this.workerSourceTypes[B]=X},this.self.registerRTLTextPlugin=B=>{if(o.fG.isParsed())throw new Error("RTL text plugin already registered.");o.fG.setState({pluginStatus:o.fH.parsed,pluginURL:o.fG.getPluginURL()}),o.fG.applyArabicShaping=B.applyArabicShaping,o.fG.processBidirectionalText=B.processBidirectionalText,o.fG.processStyledBidirectionalText=B.processStyledBidirectionalText;for(const X of this.rtlPluginParsingListeners)X(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(F,B,X){delete this.layerIndexes[F],delete this.availableImages[F],delete this.availableModels[F],delete this.workerSources[F],X()}checkIfReady(F,B,X){X()}setReferrer(F,B){this.referrer=B}spriteLoaded(F,B){this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={});const{scope:X,isLoaded:ae}=B;if(this.isSpriteLoaded[F][X]=ae,this.workerSources[F]&&this.workerSources[F][X])for(const oe in this.workerSources[F][X]){const de=this.workerSources[F][X][oe];for(const Se in de){const me=de[Se];me instanceof yi&&(me.isSpriteLoaded=ae,me.fire(new o.z("isSpriteLoaded")))}}}setImages(F,B,X){this.availableImages[F]||(this.availableImages[F]={});const{scope:ae,images:oe}=B;if(this.availableImages[F][ae]=oe,this.workerSources[F]&&this.workerSources[F][ae]){for(const de in this.workerSources[F][ae]){const Se=this.workerSources[F][ae][de];for(const me in Se)Se[me].availableImages=oe}X()}else X()}setModels(F,{scope:B,models:X},ae){if(this.availableModels[F]||(this.availableModels[F]={}),this.availableModels[F][B]=X,this.workerSources[F]&&this.workerSources[F][B]){for(const oe in this.workerSources[F][B]){const de=this.workerSources[F][B][oe];for(const Se in de)de[Se].availableModels=X}ae()}else ae()}setProjection(F,B){this.projections[F]=o.cl(B)}setBrightness(F,B,X){this.brightness=B,X()}setWorldview(F,B,X){this.worldview=B,X()}setLayers(F,B,X){this.getLayerIndex(F,B.scope).replace(B.layers,B.options),X()}updateLayers(F,B,X){this.getLayerIndex(F,B.scope).update(B.layers,B.removedIds,B.options),X()}loadTile(F,B,X){B.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,B.type,B.source,B.scope).loadTile(B,X)}decodeRasterArray(F,B,X){this.getWorkerSource(F,B.type,B.source,B.scope).decodeRasterArray(B,X)}reloadTile(F,B,X){B.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,B.type,B.source,B.scope).reloadTile(B,X)}abortTile(F,B,X){this.getWorkerSource(F,B.type,B.source,B.scope).abortTile(B,X)}removeTile(F,B,X){this.getWorkerSource(F,B.type,B.source,B.scope).removeTile(B,X)}removeSource(F,B,X){if(!(this.workerSources[F]&&this.workerSources[F][B.scope]&&this.workerSources[F][B.scope][B.type]&&this.workerSources[F][B.scope][B.type][B.source]))return;const ae=this.workerSources[F][B.scope][B.type][B.source];delete this.workerSources[F][B.scope][B.type][B.source],ae.removeSource!==void 0?ae.removeSource(B,X):X()}loadWorkerSource(F,B,X){try{this.self.importScripts(B.url),X()}catch(ae){X(ae.toString())}}syncRTLPluginState(F,B,X){if(o.fG.isParsed())X(null,!0);else if(o.fG.isParsing())this.rtlPluginParsingListeners.push(X);else try{o.fG.setState(B);const ae=o.fG.getPluginURL();!o.fG.isLoaded()||o.fG.isParsed()||o.fG.isParsing()||ae==null||(o.fG.setState({pluginStatus:o.fH.parsing,pluginURL:o.fG.getPluginURL()}),this.self.importScripts(ae),o.fG.isParsed()?X(null,!0):this.rtlPluginParsingListeners.push(X))}catch(ae){X(ae.toString())}}setDracoUrl(F,B){this.dracoUrl=B}getAvailableImages(F,B){this.availableImages[F]||(this.availableImages[F]={});let X=this.availableImages[F][B];return X||(X=[]),X}getAvailableModels(F,B){this.availableModels[F]||(this.availableModels[F]={});let X=this.availableModels[F][B];return X||(X={}),X}getLayerIndex(F,B){this.layerIndexes[F]||(this.layerIndexes[F]={});let X=this.layerIndexes[F][B];return X||(X=this.layerIndexes[F][B]=new lt,X.scope=B),X}getWorkerSource(F,B,X,ae){const oe=this.workerSources;return oe[F]||(oe[F]={}),oe[F][ae]||(oe[F][ae]={}),oe[F][ae][B]||(oe[F][ae][B]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),oe[F][ae][B][X]||(oe[F][ae][B][X]=new this.workerSourceTypes[B]({send:(de,Se,me,be,Ze,Ue)=>this.actor.send(de,Se,me,F,Ze,Ue),scheduler:this.actor.scheduler},this.getLayerIndex(F,ae),this.getAvailableImages(F,ae),this.getAvailableModels(F,ae),this.isSpriteLoaded[F][ae],void 0,this.brightness,this.worldview)),oe[F][ae][B][X]}rasterizeImagesWorker(F,B,X){const ae=new Map;for(const[oe,{image:de,imageVariant:Se}]of B.tasks.entries()){const me=this.imageRasterizer.rasterize(Se,de,B.scope,F);ae.set(oe,me)}X(void 0,ae)}removeRasterizedImages(F,B,X){this.imageRasterizer.removeImagesFromCacheByIds(B.imageIds,B.scope,F),X()}enforceCacheSizeLimit(F,B){o.fI(B)}getWorkerPerformanceMetrics(F,B,X){X(void 0,void 0)}}return o.fE(self)&&(self.worker=new xs(self)),xs})),ve(["./shared"],(function(o){var Oe="3.16.0";const $e={create:"create",load:"load",fullLoad:"fullLoad"},It={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function lt(l){const t=l.name.split("?")[0];return o.a(t)&&t.includes("mapbox-gl.js")?"javascript":o.a(t)&&t.includes("mapbox-gl.css")?"css":o.b(t)?"fontRange":o.c(t)?"sprite":o.i(t)?"style":o.d(t)?"tilejson":"other"}var Tt,Rt={},ai=(function(){if(Tt)return Rt;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":(function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,m,y=new Blob([""],{type:"text/javascript"}),x=URL.createObjectURL(y);try{m=new Worker(x),p=!0}catch(T){p=!1}return m&&m.terminate(),URL.revokeObjectURL(x),p})()?(function(){var p=document.createElement("canvas");p.width=p.height=1;var m=p.getContext("2d");if(!m)return!1;var y=m.getImageData(0,0,1,1);return y&&y.width===p.width})()?(n[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(n[d]=(function(p){var m,y=(function(x){var T=document.createElement("canvas"),S=Object.create(l.webGLContextAttributes);return S.failIfMajorPerformanceCaveat=x,T.getContext("webgl2",S)})(p);if(!y)return!1;try{m=y.createShader(y.VERTEX_SHADER)}catch(x){return!1}return!(!m||y.isContextLost())&&(y.shaderSource(m,"void main() {}"),y.compileShader(m),y.getShaderParameter(m,y.COMPILE_STATUS)===!0)})(d)),n[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}Tt=1,Rt.supported=l,Rt.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Rt})();function _t(l,t,n){const c=document.createElement(l);return t!=null&&(c.className=t),n&&n.appendChild(c),c}function Ot(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return n&&n.appendChild(c),c}const li=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Xt=li&&li.userSelect!==void 0?"userSelect":"WebkitUserSelect";let gi;function hi(){li&&Xt&&(gi=li[Xt],li[Xt]="none")}function Wi(){li&&Xt&&(li[Xt]=gi)}function ci(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",ci,!0)}function yi(){window.addEventListener("click",ci,!0),window.setTimeout((()=>{window.removeEventListener("click",ci,!0)}),0)}function Ii(l,t){const n=l.getBoundingClientRect();return vr(l,n,t)}function xr(l,t){const n=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(vr(l,n,t[d]));return c}function Lr(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function vr(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new o.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const mi="01",Pt="NO_ACCESS_TOKEN";class wr{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=(function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",mi,n].join(""),tokenExpiresAt:Date.now()+432e5}})();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!o.h(t))return t;const c=qi(t);return c.params.push("sdk=js-".concat(Oe)),c.path="/styles/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!o.h(t))return t;const c=qi(t);return c.path="/fonts/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!o.h(t))return t;const c=qi(t);return c.path="/models/v1".concat(c.path),this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,d){if(!o.h(t))return t;const p=qi(t);return p.path="/v4/".concat(p.authority,".json"),p.params.push("secure"),c&&p.params.push("language=".concat(c)),d&&p.params.push("worldview=".concat(d)),this._makeAPIURL(p,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=qi(t);return o.h(t)?(c.path="/styles/v1".concat(c.path,"/iconset.pbf"),this._makeAPIURL(c,this._customAccessToken||n)):di(c)}normalizeSpriteURL(t,n,c,d){const p=qi(t);return o.h(t)?(p.path="/styles/v1".concat(p.path,"/sprite").concat(n).concat(c),this._makeAPIURL(p,this._customAccessToken||d)):(p.path+="".concat(n).concat(c),di(p))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!o.h(t))return t;const d=qi(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,"".concat(n||c&&d.authority!=="raster"&&c===512?"@2x":"").concat(o.k.supported?".webp":"$1")),d.authority==="raster"?d.path="/".concat(o.e.RASTER_URL_PREFIX).concat(d.path):d.authority==="rasterarrays"?d.path="/".concat(o.e.RASTERARRAYS_URL_PREFIX).concat(d.path):d.authority==="3dtiles"?d.path="/".concat(o.e.TILES3D_URL_PREFIX).concat(d.path):(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path="/".concat(o.e.TILE_URL_VERSION).concat(d.path));const p=this._customAccessToken||(function(m){for(const y of m){const x=y.match(/^access_token=(.*)$/);if(x)return x[1]}return null})(d.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push("sku=".concat(this._skuToken)),this._makeAPIURL(d,p)}canonicalizeTileURL(t,n){const c=qi(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+="raster/".concat(c.path.replace("/".concat(o.e.RASTER_URL_PREFIX,"/"),"")):c.path.match(/^\/rasterarrays\/v1\//)?d+="rasterarrays/".concat(c.path.replace("/".concat(o.e.RASTERARRAYS_URL_PREFIX,"/"),"")):d+="tiles/".concat(c.path.replace("/".concat(o.e.TILE_URL_VERSION,"/"),""));let p=c.params;return n&&(p=p.filter((m=>!m.match(/^access_token=/)))),p.length&&(d+="?".concat(p.join("&"))),d}canonicalizeTileset(t,n){const c=!!n&&o.h(n),d=[];for(const p of t.tiles||[])o.j(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=qi(o.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path="".concat(d.path).concat(t.path)),!o.e.REQUIRE_ACCESS_TOKEN)return di(t);if(n=n||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error("An API access token is required to use Mapbox GL. ".concat(c));if(n[0]==="s")throw new Error("Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ".concat(c))}return t.params=t.params.filter((p=>p.indexOf("access_token")===-1)),t.params.push("access_token=".concat(n||"")),di(t)}}const ir=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function qi(l){const t=l.match(ir);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function di(l){const t=l.params.length?"?".concat(l.params.join("&")):"";return"".concat(l.protocol,"://").concat(l.authority).concat(l.path).concat(t)}const ar="mapbox.eventData";function Wr(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(o.l(t[1]))}catch(n){return null}}class Cn{constructor(t){this.type=t,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=Wr(o.e.ACCESS_TOKEN);let c="";return c=n&&n.u?o.f(n.u):o.e.ACCESS_TOKEN||"",t?"".concat(ar,".").concat(t,":").concat(c):"".concat(ar,":").concat(c)}fetchEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp");if(t)try{const p=localStorage.getItem(n);p&&(this.eventData=JSON.parse(p));const m=localStorage.getItem(c);m&&(this.anonId=m);const y=localStorage.getItem(d);y&&(this.anonIdTimestamp=Number(y));const x=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<x)&&this.refreshUUID()}catch(p){o.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=o.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.getStorageKey("uuidTimestamp"),p=this.anonId,m=this.anonIdTimestamp;if(t&&p)try{localStorage.setItem(c,p),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData)),m&&localStorage.setItem(d,m.toString())}catch(y){o.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,d){if(!o.e.EVENTS_URL)return;const p=qi(o.e.EVENTS_URL);p.params.push("access_token=".concat(d||o.e.ACCESS_TOKEN||""));const m={event:this.type,created:new Date(t).toISOString()},y=n?Object.assign(m,n):m,x={url:di(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([y])};this.pendingRequest=o.p(x,(T=>{this.pendingRequest=null,c(T),this.saveEventData(),this.processRequests(d)}))}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const hr=new class extends Cn{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some((n=>o.h(n)||o.j(n)))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Wr(o.e.ACCESS_TOKEN),n=t?t.u:o.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;o.v(this.anonId)||(this.refreshUUID(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const p=new Date(this.eventData.lastSuccess),m=new Date(d),y=(d-this.eventData.lastSuccess)/864e5;c=c||y>=1||y<-1||p.getDate()!==m.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Oe,skuId:mi,"enabled.telemetry":!1,userId:this.anonId},(p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=n)}),l):this.processRequests()}},dn=hr.postTurnstileEvent.bind(hr),Xi=new class extends Cn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.EVENTS_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Pt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID(),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Oe,skuId:mi,skuToken:this.skuToken,userId:this.anonId},(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l))}remove(){this.errorCb=null}},ns=Xi.postMapLoadEvent.bind(Xi),Mo=new class extends Cn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=o.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:d}=t;if(!o.e.EVENTS_URL||!l&&!o.e.ACCESS_TOKEN)return;const p=this.getMapInstanceId(n),m={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(m.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:m},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,(()=>{}),l)}},xn=Mo.postStyleLoadEvent.bind(Mo),lo=new class extends Cn{constructor(l){super("metrics"),l&&(this.data=l)}postMetricsEvent(l){if(!o.e.EVENTS_URL||!l&&!o.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),o.v(this.anonId)||this.refreshUUID();const t=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,(()=>{}),l)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),ss=lo.postMetricsEvent.bind(lo),Yi=new class extends Cn{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){o.e.EVENTS_URL&&(l||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=(function(d){const p=performance.getEntriesByType("resource"),m=performance.getEntriesByType("mark"),y=(function(P){const D={};if(P){for(const O in P)if(O!=="other")for(const V of P[O]){const N="".concat(O,"ResolveRangeMin"),j="".concat(O,"ResolveRangeMax"),Z="".concat(O,"RequestCount"),H="".concat(O,"RequestCachedCount");D[N]=Math.min(D[N]||1/0,V.startTime),D[j]=Math.max(D[j]||-1/0,V.responseEnd);const te=W=>{D[W]===void 0&&(D[W]=0),++D[W]};V.transferSize!==void 0&&V.transferSize===0&&te(H),te(Z)}}return D})((function(P,D){const O={};if(P)for(const V of P){const N=D(V);O[N]===void 0&&(O[N]=[]),O[N].push(V)}return O})(p,lt)),x=window.devicePixelRatio,T=navigator.connection||navigator.mozConnection||navigator.webkitConnection,S=T?T.effectiveType:void 0,M={counters:[],metadata:[],attributes:[]},E=(P,D,O)=>{O!=null&&P.push({name:D,value:O.toString()})};for(const P in y)E(M.counters,P,y[P]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(E(M.counters,"interactionRangeMin",d.interactionRange[0]),E(M.counters,"interactionRangeMax",d.interactionRange[1])),m)for(const P of Object.values($e)){const D=m.find((O=>O.name===P));D&&E(M.counters,P,D.startTime)}return E(M.counters,"visibilityHidden",d.visibilityHidden),E(M.attributes,"style",(function(P){if(P)for(const D of P){const O=D.name.split("?")[0];if(o.i(O)){const V=O.split("/").slice(-2);if(V.length===2)return"mapbox://styles/".concat(V[0],"/").concat(V[1])}}})(p)),E(M.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),E(M.attributes,"fogEnabled",d.fogEnabled?"true":"false"),E(M.attributes,"projection",d.projection),E(M.attributes,"zoom",d.zoom),E(M.metadata,"devicePixelRatio",x),E(M.metadata,"connectionEffectiveType",S),E(M.metadata,"navigatorUserAgent",navigator.userAgent),E(M.metadata,"screenWidth",window.screen.width),E(M.metadata,"screenHeight",window.screen.height),E(M.metadata,"windowWidth",window.innerWidth),E(M.metadata,"windowHeight",window.innerHeight),E(M.metadata,"mapWidth",d.width/x),E(M.metadata,"mapHeight",d.height/x),E(M.metadata,"webglRenderer",d.renderer),E(M.metadata,"webglVendor",d.vendor),E(M.metadata,"sdkVersion",Oe),E(M.metadata,"sdkIdentifier","mapbox-gl-js"),M})(n);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,(()=>{}),l)}},Qi=Yi.postPerformanceEvent.bind(Yi),Fr=new class extends Cn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const d=qi(o.e.API_URL+o.e.SESSION_PATH);d.params.push("sku=".concat(t||"")),d.params.push("access_token=".concat(c||o.e.ACCESS_TOKEN||""));const p={url:di(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(p,(m=>{this.pendingRequest=null,n(m),this.saveEventData(),this.processRequests(c)}))}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.SESSION_PATH&&o.e.API_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Pt)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l)}remove(){this.errorCb=null}},Xn=Fr.getSessionAPI.bind(Fr),dr=new Set;function os(l,t){t?dr.add(l):dr.delete(l)}class Vn{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,n){this._updatedImages[n]=this._updatedImages[n]||new Set,this._updatedImages[n].add(o.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Br(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class fs extends o.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&o.r()&&(this.imageRasterizerDispatcher=new o.D(o.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new o.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const n=this.atlasTexture.get(t);n&&(n.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,n){this.imageProviders.has(n)||this.imageProviders.set(n,new Map),this.imageProviders.get(n).set(t.id,t)}removeImageProvider(t,n){this.imageProviders.has(n)&&this.imageProviders.get(n).delete(t)}getPendingImageProviders(){const t=[];for(const n of this.imageProviders.values())for(const c of n.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.x),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,n){if(this.loaded.get(n)!==t&&(this.loaded.set(n,t),t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,n,d);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images.get(n).get(t.toString())}addImage(t,n,c){this._validate(t,c)&&this.images.get(n).set(t.toString(),c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new o.y(new Error('Image "'.concat(t.name,'" has invalid "stretchX" value')))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new o.y(new Error('Image "'.concat(t.name,'" has invalid "stretchY" value')))),c=!1),this._validateContent(n.content,n)||(this.fire(new o.y(new Error('Image "'.concat(t.name,'" has invalid "content" value')))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){return t?t.length!==4||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,n,c){const d=this.images.get(n).get(t.toString());c.version=d.version+1,this.images.get(n).set(t.toString(),c),this.updatedImages.get(n).add(t),this.removeFromImageRasterizerCache(t,n)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,n){this.spriteFormat!=="raster"&&(o.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images.get(n),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(n).delete(t.toString()),this.removeFromImageRasterizerCache(t,n),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((n=>o.I.from(n)))}getImages(t,n,c){const d=[],p=[],m=this.imageProviders.get(n);for(const S of t){if(!S.iconsetId){d.push(S);continue}const M=m.get(S.iconsetId);M&&(this.getImage(S,n)?p.push(S):M.addPendingRequest(S))}if(d.length===0)return void this._notify(p,n,c);let y=!0;const x=!!this.loaded.get(n),T=this.images.get(n);if(!x)for(const S of d)T.has(S.toString())||(y=!1);x||y?this._notify(d,n,c):this.requestors.push({ids:d,scope:n,callback:c})}rasterizeImages(t,n){const c=new Map,{tasks:d,scope:p}=t;for(const[m,y]of d.entries()){const x=this.getImage(y.id,p);x&&c.set(m,{image:x,imageVariant:y})}this._rasterizeImages(p,c,n)}_rasterizeImages(t,n,c){if(o.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:n,scope:t},c);else{const d=new Map;for(const[p,{image:m,imageVariant:y}]of n.entries())d.set(p,this.imageRasterizer.rasterize(y,m,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,n,c){const d=this.images.get(n),p=new Map;for(const m of t){if(!d.get(m.toString())){if(m.iconsetId)continue;this.fire(new o.z("styleimagemissing",{id:m.name}))}const y=d.get(m.toString());if(!y){o.w('Image "'.concat(m.name,'" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.'));continue}const x={data:y.usvg?null:y.data.clone(),pixelRatio:y.pixelRatio,sdf:y.sdf,usvg:y.usvg,version:y.version,stretchX:y.stretchX,stretchY:y.stretchY,content:y.content,hasRenderCallback:!!(y.userImage&&y.userImage.render)};y.usvg&&Object.assign(x,{width:y.icon.usvg_tree.width,height:y.icon.usvg_tree.height}),p.set(o.I.toString(m),x)}c(null,p)}getPixelSize(t){const{width:n,height:c}=this.atlasImage.get(t);return{width:n,height:c}}getPattern(t,n,c){const d=t.toString(),p=this.patterns.get(n),m=p.get(d),y=this.getImage(t,n);if(!y)return null;if(m){if(m.position.version===y.version)return m.position;m.position.version=y.version}else{if(y.usvg&&!y.data){const x=this.getPatternInFlightId(d,n);if(this.patternsInFlight.has(x))return null;this.patternsInFlight.add(x);const T=new o.A(t).scaleSelf(o.o.devicePixelRatio),S=new Map([[T.toString(),{image:y,imageVariant:T}]]);return this._rasterizeImages(n,S,((M,E)=>this.storePatternImage(T,n,y,c,E))),null}this.storePattern(t,n,y)}return this._updatePatternAtlas(n,c),p.get(d).position}getPatternInFlightId(t,n){return o.B(t,n)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,n,c,d,p){const m=t.toString(),y=p?p.get(m):void 0;y&&(c.data=y,this.storePattern(t.id,n,c),this._updatePatternAtlas(n,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),n)))}storePattern(t,n,c){const d={w:c.data.width+2*o.C,h:c.data.height+2*o.C,x:0,y:0},p=new o.F(d,c,o.C);this.patterns.get(n).set(t.toString(),{bin:d,position:p})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,n){const c=t.gl;let d=this.atlasTexture.get(n);d?this.dirty&&(d.update(this.atlasImage.get(n)),this.dirty=!1):(d=new o.T(t,this.atlasImage.get(n),c.RGBA8),this.atlasTexture.set(n,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=this.patterns.get(t),d=Array.from(c.values()).map((({bin:T})=>T)),{w:p,h:m}=o.G(d),y=this.atlasImage.get(t);y.resize({width:p||1,height:m||1});const x=this.images.get(t);for(const[T,{bin:S,position:M}]of c.entries()){let E=M.padding;const P=S.x+E,D=S.y+E,O=x.get(T).data,V=O.width,N=O.height;E=E>1?E-1:E,o.q.copy(O,y,{x:0,y:0},{x:P,y:D},{width:V,height:N},n),o.q.copy(O,y,{x:0,y:N-E},{x:P,y:D-E},{width:V,height:E},n),o.q.copy(O,y,{x:0,y:0},{x:P,y:D+N},{width:V,height:E},n),o.q.copy(O,y,{x:V-E,y:0},{x:P-E,y:D},{width:E,height:N},n),o.q.copy(O,y,{x:0,y:0},{x:P+V,y:D},{width:E,height:N},n),o.q.copy(O,y,{x:V-E,y:N-E},{x:P-E,y:D-E},{width:E,height:E},n),o.q.copy(O,y,{x:0,y:N-E},{x:P+V,y:D-E},{width:E,height:E},n),o.q.copy(O,y,{x:0,y:0},{x:P+V,y:D+N},{width:E,height:E},n),o.q.copy(O,y,{x:V-E,y:0},{x:P-E,y:D+N},{width:E,height:E},n)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,n){const c=this.images.get(n);for(const d of t){if(this.callbackDispatchedThisFrame.get(n).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(n).add(d.toString());const p=c.get(d.toString());Br(p)&&this.updateImage(d,n,p)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Rr(l){const t=l.value,n=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,m=l.arrayElementValidator||fr;if(!Array.isArray(t))return[new o.V(p,t,"array expected, ".concat(o.K(t)," found"))];if(n.length&&t.length!==n.length)return[new o.V(p,t,"array length ".concat(n.length," expected, length ").concat(t.length," found"))];if(n["min-length"]&&t.length<n["min-length"])return[new o.V(p,t,"array length at least ".concat(n["min-length"]," expected, length ").concat(t.length," found"))];let y={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};d.$version<7&&(y.function=n.function),o.H(n.value)&&(y=n.value);let x=[];for(let T=0;T<t.length;T++)x=x.concat(m({array:t,arrayIndex:T,value:t[T],valueSpec:y,style:c,styleSpec:d,key:"".concat(p,"[").concat(T,"]")},!0));return x}function co(l){const t=l.key,n=l.value,c=l.valueSpec;if(!o.L(n))return[new o.V(t,n,"number expected, ".concat(o.K(n)," found"))];if(n!=n)return[new o.V(t,n,"number expected, NaN found")];if("minimum"in c){let d=c.minimum;if(Array.isArray(c.minimum)&&(d=c.minimum[l.arrayIndex]),n<d)return[new o.V(t,n,"".concat(n," is less than the minimum value ").concat(d))]}if("maximum"in c){let d=c.maximum;if(Array.isArray(c.maximum)&&(d=c.maximum[l.arrayIndex]),n>d)return[new o.V(t,n,"".concat(n," is greater than the maximum value ").concat(d))]}return[]}function Un(l){const t=l.key,n=l.value;if(!o.H(n))return[new o.V(t,n,"object expected, ".concat(o.K(n)," found"))];const c=l.valueSpec,d=o.J(n.type);let p,m,y,x={};const T=d!=="categorical"&&n.property===void 0,S=!T,M=(function(O){const V=O.stops;return Array.isArray(V)&&Array.isArray(V[0])&&o.H(V[0][0])})(n),E=fn({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(O){if(d==="identity")return[new o.V(O.key,O.value,'identity function may not have a "stops" property')];let V=[];const N=O.value;return V=V.concat(Rr({key:O.key,value:N,valueSpec:O.valueSpec,style:O.style,styleSpec:O.styleSpec,arrayElementValidator:P})),Array.isArray(N)&&N.length===0&&V.push(new o.V(O.key,N,"array must have at least one stop")),V},default:function(O){return fr({key:O.key,value:O.value,valueSpec:c,style:O.style,styleSpec:O.styleSpec})}}});return d==="identity"&&T&&E.push(new o.V(l.key,l.value,'missing required property "property"')),d==="identity"||n.stops||E.push(new o.V(l.key,l.value,'missing required property "stops"')),d==="exponential"&&c.expression&&!o.M(c)&&E.push(new o.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(S&&!o.N(c)?E.push(new o.V(l.key,l.value,"property functions not supported")):T&&!o.O(c)&&E.push(new o.V(l.key,l.value,"zoom functions not supported"))),d!=="categorical"&&!M||n.property!==void 0||E.push(new o.V(l.key,l.value,'"property" property is required')),E;function P(O){let V=[];const N=O.value,j=O.key;if(!Array.isArray(N))return[new o.V(j,N,"array expected, ".concat(o.K(N)," found"))];if(N.length!==2)return[new o.V(j,N,"array length 2 expected, length ".concat(N.length," found"))];if(M){if(!o.H(N[0]))return[new o.V(j,N,"object expected, ".concat(o.K(N[0])," found"))];const Z=N[0];if(Z.zoom===void 0)return[new o.V(j,N,"object stop key must have zoom")];if(Z.value===void 0)return[new o.V(j,N,"object stop key must have value")];const H=o.J(Z.zoom);if(typeof H!="number")return[new o.V(j,Z.zoom,"stop zoom values must be numbers")];if(y&&y>H)return[new o.V(j,Z.zoom,"stop zoom values must appear in ascending order")];H!==y&&(y=H,m=void 0,x={}),V=V.concat(fn({key:"".concat(j,"[0]"),value:N[0],valueSpec:{zoom:{}},style:O.style,styleSpec:O.styleSpec,objectElementValidators:{zoom:co,value:D}}))}else V=V.concat(D({key:"".concat(j,"[0]"),value:N[0],style:O.style,styleSpec:O.styleSpec},N));return o.Q(o.S(N[1]))?V.concat([new o.V("".concat(j,"[1]"),N[1],"expressions are not allowed in function stops.")]):V.concat(fr({key:"".concat(j,"[1]"),value:N[1],valueSpec:c,style:O.style,styleSpec:O.styleSpec}))}function D(O,V){const N=o.K(O.value),j=o.J(O.value),Z=O.value!==null?O.value:V;if(p){if(N!==p)return[new o.V(O.key,Z,"".concat(N," stop domain type must match previous stop domain type ").concat(p))]}else p=N;if(N!=="number"&&N!=="string"&&N!=="boolean"&&typeof j!="number"&&typeof j!="string"&&typeof j!="boolean")return[new o.V(O.key,Z,"stop domain value must be a number, string, or boolean")];if(N!=="number"&&d!=="categorical"){let H="number expected, ".concat(N," found");return o.N(c)&&d===void 0&&(H+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(O.key,Z,H)]}return d!=="categorical"||N!=="number"||typeof j=="number"&&isFinite(j)&&Math.floor(j)===j?d!=="categorical"&&N==="number"&&typeof j=="number"&&typeof m=="number"&&m!==void 0&&j<m?[new o.V(O.key,Z,"stop domain values must appear in ascending order")]:(m=j,d==="categorical"&&j in x?[new o.V(O.key,Z,"stop domain values must be unique")]:(x[j]=!0,[])):[new o.V(O.key,Z,"integer expected, found ".concat(String(j)))]}}function nn(l){const t=(l.expressionContext==="property"?o.W:o.U)(o.S(l.value),l.valueSpec);if(t.result==="error")return t.value.map((c=>new o.V("".concat(l.key).concat(c.key),l.value,c.message)));const n=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!n.outputDefined())return[new o.V(l.key,l.value,'Invalid data expression for "'.concat(l.propertyKey,'". Output values must be contained as literals within the expression.'))];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!o.Z(n))return[new o.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return ps(n,l);if(l.expressionContext==="appearance")return uo(n,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!o.X(n,["zoom","feature-state"]))return[new o.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!o.Y(n))return[new o.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ps(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.delete(d);if(n.size===0)return[];const c=[];return l instanceof o._&&n.has(l.name)?[new o.V(t.key,t.value,'["'.concat(l.name,'"] expression is not supported in a filter for a ').concat(t.object.type," layer with id: ").concat(t.object.id))]:(l.eachChild((d=>{c.push(...ps(d,t))})),c)}function uo(l,t){const n=new Set;if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.add(d);if(n.size===0)return[];const c=[];return l instanceof o._&&!n.has(l.name)?[new o.V(t.key,t.value,'["'.concat(l.name,'"] is not an allowed parameter'))]:(l.eachChild((d=>{c.push(...uo(d,t))})),c)}function En(l){const t=l.key,n=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(o.J(n))===-1&&d.push(new o.V(t,n,"expected one of [".concat(c.values.join(", "),"], ").concat(JSON.stringify(n)," found"))):Object.keys(c.values).indexOf(o.J(n))===-1&&d.push(new o.V(t,n,"expected one of [".concat(Object.keys(c.values).join(", "),"], ").concat(JSON.stringify(n)," found"))),d}function zs(l){return o.a2(o.S(l.value))?nn(Object.assign({},l,{expressionContext:"filter",valueSpec:l.styleSpec["filter_".concat(l.layerType||"fill")]})):ms(l)}function ms(l){const t=l.value,n=l.key;if(!Array.isArray(t))return[new o.V(n,t,"array expected, ".concat(o.K(t)," found"))];if(t.length<1)return[new o.V(n,t,"filter array must have at least 1 element")];const c=l.styleSpec;let d=En({key:"".concat(n,"[0]"),value:t[0],valueSpec:c.filter_operator});switch(o.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&o.J(t[1])==="$type"&&d.push(new o.V(n,t,'"$type" cannot be use with operator "'.concat(t[0],'"')));case"==":case"!=":t.length!==3&&d.push(new o.V(n,t,'filter array for operator "'.concat(t[0],'" must have 3 elements')));case"in":case"!in":t.length>=2&&(o.a0(t[1])||d.push(new o.V("".concat(n,"[1]"),t[1],"string expected, ".concat(o.K(t[1])," found"))));for(let p=2;p<t.length;p++)o.J(t[1])==="$type"?d=d.concat(En({key:"".concat(n,"[").concat(p,"]"),value:t[p],valueSpec:c.geometry_type})):o.a0(t[p])||o.L(t[p])||o.$(t[p])||d.push(new o.V("".concat(n,"[").concat(p,"]"),t[p],"string, number, or boolean expected, ".concat(o.K(t[p])," found.")));break;case"any":case"all":case"none":for(let p=1;p<t.length;p++)d=d.concat(ms({key:"".concat(n,"[").concat(p,"]"),value:t[p],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":t.length!==2?d.push(new o.V(n,t,'filter array for "'.concat(t[0],'" operator must have 2 elements'))):o.a0(t[1])||d.push(new o.V("".concat(n,"[1]"),t[1],"string expected, ".concat(o.K(t[1])," found")))}return d}function Yn(l,t){const n=l.key,c=l.style,d=l.layer,p=l.styleSpec,m=l.value,y=l.objectKey,x=p["".concat(t,"_").concat(l.layerType)];if(!x)return[];const T=y.match(/^(.*)-use-theme$/);if(T&&x[T[1]])return o.Q(o.S(m))?[].concat(fr({key:n,value:m,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:y})):fr({key:n,value:m,valueSpec:{type:"string"},style:c,styleSpec:p});const S=y.match(/^(.*)-transition$/);if(t==="paint"&&S&&x[S[1]]&&x[S[1]].transition)return fr({key:n,value:m,valueSpec:p.transition,style:c,styleSpec:p});const M=l.valueSpec||x[y];if(!M)return[new o.a3(n,m,'unknown property "'.concat(y,'"'))];let E;if(o.a0(m)&&o.N(M)&&!M.tokens&&(E=/^{([^}]+)}$/.exec(m))){const D='`{ "type": "identity", "property": '.concat(E?JSON.stringify(E[1]):'"_"'," }`");return[new o.V(n,m,'"'.concat(y,'" does not support interpolation syntax\nUse an identity property function instead: ').concat(D,"."))]}const P=[];if(l.layerType==="symbol")y!=="text-field"||!c||c.glyphs||c.imports||P.push(new o.V(n,m,'use of "text-field" requires a style "glyphs" property')),y==="text-font"&&o.a4(o.S(m))&&o.J(m.type)==="identity"&&P.push(new o.V(n,m,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&o.N(M)&&(o.a5(M)||o.O(M))){const D=o.W(o.S(m),M).value,O="expression"in D&&D.expression||"_styleExpression"in D&&D._styleExpression&&D._styleExpression.expression;O&&!o.X(O,["measure-light"])&&(y==="model-emissive-strength"&&o.Y(O)&&o.Z(O)||P.push(new o.V(n,m,"".concat(y," does not support measure-light expressions when the model layer source is vector tile or GeoJSON."))))}return P.concat(fr({key:l.key,value:m,valueSpec:M,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:y}))}function Kn(l){return Yn(l,"paint")}function vn(l){return Yn(l,"layout")}function Ls(l){let t=[];const n=l.value,c=l.key,d=l.style,p=l.styleSpec;if(!o.H(n))return[new o.V(c,n,"object expected")];n.type||n.ref||t.push(new o.V(c,n,'either "type" or "ref" is required'));let m=o.J(n.type);const y=o.J(n.ref);if(n.id){const x=o.J(n.id);for(let T=0;T<l.arrayIndex;T++){const S=d.layers[T];o.J(S.id)===x&&t.push(new o.V(c,n.id,'duplicate layer id "'.concat(x,'", previously used at line ').concat(S.id.__line__)))}}if("ref"in n){let x;["type","source","source-layer","filter","layout"].forEach((T=>{T in n&&t.push(new o.V(c,n[T],'"'.concat(T,'" is prohibited for ref layers')))})),d.layers.forEach((T=>{o.J(T.id)===y&&(x=T)})),x?x.ref?t.push(new o.V(c,n.ref,"ref cannot reference another ref layer")):m=o.J(x.type):typeof y=="string"&&t.push(new o.V(c,n.ref,'ref layer "'.concat(y,'" not found')))}else if(m!=="background"&&m!=="sky"&&m!=="slot")if(n.source)if(o.a0(n.source)){const x=d.sources&&d.sources[n.source],T=x&&o.J(x.type);x?T==="vector"&&m==="raster"?t.push(new o.V(c,n.source,'layer "'.concat(n.id,'" requires a raster source'))):T==="raster"&&m!=="raster"?t.push(new o.V(c,n.source,'layer "'.concat(n.id,'" requires a vector source'))):T!=="vector"||n["source-layer"]?T==="raster-dem"&&m!=="hillshade"?t.push(new o.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):T!=="raster-array"||["raster","raster-particle"].includes(m)?m==="line"&&n.paint&&(n.paint["line-gradient"]||n.paint["line-trim-offset"])&&T==="geojson"&&!x.lineMetrics?t.push(new o.V(c,n,'layer "'.concat(n.id,'" specifies a line-gradient, which requires the GeoJSON source to have `lineMetrics` enabled.'))):m==="raster-particle"&&T!=="raster-array"&&t.push(new o.V(c,n.source,'layer "'.concat(n.id,"\" requires a 'raster-array' source."))):t.push(new o.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new o.V(c,n,'layer "'.concat(n.id,'" must specify a "source-layer"'))):t.push(new o.V(c,n.source,'source "'.concat(n.source,'" not found')))}else t.push(new o.V("".concat(c,".source"),n.source,'"source" must be a string'));else t.push(new o.V(c,n,'missing required property "source"'));return t=t.concat(fn({key:c,value:n,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>fr({key:"".concat(c,".type"),value:n.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:x=>zs(Object.assign({layerType:m},x)),layout:x=>fn({layer:n,key:x.key,value:x.value,valueSpec:{},style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":T=>vn(Object.assign({layerType:m},T))}}),paint:x=>fn({layer:n,key:x.key,value:x.value,valueSpec:{},style:x.style,styleSpec:x.styleSpec,objectElementValidators:{"*":T=>Kn(Object.assign({layerType:m,layer:n},T))}}),appearances(x){const T=Rr({key:x.key,value:x.value,valueSpec:x.valueSpec,style:x.style,styleSpec:x.styleSpec,arrayElementValidator:E=>(function(P){const{key:D,layer:O,layerType:V}=P,N=o.J(P.value),j=o.J(N.name),Z=o.J(N.condition),H=fn({key:D,value:N,valueSpec:P.styleSpec.appearance,style:P.style,styleSpec:P.styleSpec,objectElementValidators:{condition:te=>(function(W){const re=[];return re.push(...nn({key:W.key,value:W.object.condition,valueSpec:o.a6.appearance.condition,expressionContext:"appearance"})),re})(Object.assign({layer:O,layerType:V},te)),properties:te=>(function(W){const re=[],{styleSpec:ee,layer:K,layerType:ne}=W,_e=ee["paint_".concat(ne)],fe=ee["layout_".concat(ne)],Me=W.object[W.objectKey];for(const we in Me){const ze=we in _e?"paint":we in fe?"layout":void 0;if(!ze){re.push(new o.V(W.key,we,'unknown property "'.concat(we,'" for layer type "').concat(ne,'"')));continue}const Je=Object.assign({},W,{key:"".concat(W.key,".").concat(we),object:Me,objectKey:we,layer:K,layerType:ne,value:Me[we],valueSpec:ze==="paint"?_e[we]:fe[we]});re.push(...Yn(Je,ze))}return re})(Object.assign({layer:O,layerType:V},te))}});return j!=="hidden"&&Z===void 0&&H.push(new o.V(P.key,"name",'Appearance with name different than "hidden" must have a condition')),H})(Object.assign({layerType:m,layer:n},E))}),S=Array.isArray(x.value)?x.value:[],M=new Set;return S.forEach(((E,P)=>{const D=o.J(E.name);if(D)if(M.has(D)){const O=o.J(n.id);T.push(new o.V(x.key,D,'Duplicated appearance name "'.concat(D,'" for layer "').concat(O,'"')))}else M.add(D)})),T}}})),t}function Tr({key:l,value:t}){return o.a0(t)?[]:[new o.V(l,t,"string expected, ".concat(o.K(t)," found"))]}const Hs={promoteId:function l({key:t,value:n}){if(o.a0(n))return Tr({key:t,value:n});if(Array.isArray(n)){const d=[],p=o.S(n),m=o.U(p);return m.result==="error"&&m.value.forEach((y=>{d.push(new o.V("".concat(t).concat(y.key),null,"".concat(y.message)))})),o.X(m.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||d.push(new o.V("".concat(t),null,"promoteId expression should be only feature dependent")),d}if(!o.H(n))return[new o.V(t,n,'string, expression or object expected, "'.concat(o.K(n),'" found'))];const c=[];for(const d in n)c.push(...l({key:"".concat(t,".").concat(d),value:n[d]}));return c}};function sn(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!o.H(t))return[new o.V(n,t,"object expected, ".concat(o.K(t)," found"))];if(!("type"in t))return[new o.V(n,t,'"type" is required')];const p=o.J(t.type);let m=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&("url"in t||"tiles"in t||m.push(new o.a3(n,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return m=m.concat(fn({key:n,value:t,valueSpec:c["source_".concat(p.replace("-","_"))],style:l.style,styleSpec:c,objectElementValidators:Hs})),m;case"geojson":if(m=fn({key:n,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Hs}),"cluster"in t&&"clusterProperties"in t){if(!o.H(t.clusterProperties))return[new o.V("".concat(n,".clusterProperties"),t,"object expected, ".concat(o.K(t)," found"))];for(const y in t.clusterProperties){const x=t.clusterProperties[y];if(!Array.isArray(x))return[new o.V("".concat(n,".clusterProperties.").concat(y),x,"array expected")];const[T,S]=x,M=typeof T=="string"?[T,["accumulated"],["get",y]]:T;m.push(...nn({key:"".concat(n,".").concat(y,".map"),value:S,expressionContext:"cluster-map"})),m.push(...nn({key:"".concat(n,".").concat(y,".reduce"),value:M,expressionContext:"cluster-reduce"}))}}return m;case"video":return fn({key:n,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return fn({key:n,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new o.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return En({key:"".concat(n,".type"),value:t.type,valueSpec:{values:Ki(c)}})}}function Ki(l){return l.source.reduce(((t,n)=>{const c=l[n];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values||{}))),t}),[])}function Jr(l){const t=l.value,n=l.styleSpec,c=n.light,d=l.style;if(t===void 0)return[];if(!o.H(t))return[new o.V("light",t,"object expected, ".concat(o.K(t)," found"))];let p=[];for(const m in t){const y=m.match(/^(.*)-transition$/),x=m.match(/^(.*)-use-theme$/);p=p.concat(x&&c[x[1]]?fr({key:m,value:t[m],valueSpec:{type:"string"},style:d,styleSpec:n}):y&&c[y[1]]&&c[y[1]].transition?fr({key:m,value:t[m],valueSpec:n.transition,style:d,styleSpec:n}):c[m]?fr({key:m,value:t[m],valueSpec:c[m],style:d,styleSpec:n}):[new o.V(m,t[m],'unknown property "'.concat(m,'"'))])}return p}function Os(l){const t=l.value;if(!t)return[];const n=l.key;if(!o.H(t))return[new o.V(n,t,"object expected, ".concat(o.K(t)," found"))];let c=[];const d=l.styleSpec,p=d["light-3d"],m=l.style,y=l.style.lights;for(const S of["type","id"])if(!(S in t))return c=c.concat([new o.V(n,t,'missing property "'.concat(S,'"'))]),c;if(!o.a0(t.type))return c=c.concat([new o.V("".concat(n,".type"),t.type,"string expected")]),c;if(y)for(let S=0;S<l.arrayIndex;S++){const M=o.J(t.type),E=y[S];o.J(E.type)===M&&c.push(new o.V(n,t.id,'duplicate light type "'.concat(t.type,'", previously defined at line ').concat(E.id.__line__)))}const x="properties_light_".concat(t.type);if(!(x in d))return c=c.concat([new o.V("".concat(n,".type"),t,"Invalid light type ".concat(t.type))]),c;const T=d[x];for(const S in t)if(S==="properties"){const M=t[S];if(!o.H(M))return c=c.concat([new o.V("properties",M,"object expected, ".concat(o.K(M)," found"))]),c;for(const E in M){const P=E.match(/^(.*)-transition$/),D=E.match(/^(.*)-use-theme$/);c=c.concat(D&&T[D[1]]?fr({key:S,value:M[E],valueSpec:{type:"string"},style:m,styleSpec:d}):P&&T[P[1]]&&T[P[1]].transition?fr({key:S,value:t[S],valueSpec:d.transition,style:m,styleSpec:d}):T[E]?fr({key:E,value:M[E],valueSpec:T[E],style:m,styleSpec:d}):[new o.a3(l.key,M[E],'unknown property "'.concat(E,'"'))])}}else c=c.concat(p[S]?fr({key:S,value:t[S],valueSpec:p[S],style:m,styleSpec:d}):[new o.a3(S,t[S],'unknown property "'.concat(S,'"'))]);return c}function Dn(l){const t=l.value,n=l.key,c=l.style,d=l.styleSpec,p=d.terrain;if(t==null)return[];if(!o.H(t))return[new o.V("terrain",t,"object expected, ".concat(o.K(t)," found"))];let m=[];for(const y in t){const x=y.match(/^(.*)-transition$/),T=y.match(/^(.*)-use-theme$/);m=m.concat(T&&p[T[1]]?fr({key:y,value:t[y],valueSpec:{type:"string"},style:c,styleSpec:d}):x&&p[x[1]]&&p[x[1]].transition?fr({key:y,value:t[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?fr({key:y,value:t[y],valueSpec:p[y],style:c,styleSpec:d}):[new o.a3(y,t[y],'unknown property "'.concat(y,'"'))])}if(t.source)if(o.a0(t.source)){const y=c.sources&&c.sources[t.source],x=y&&o.J(y.type);y?x!=="raster-dem"&&m.push(new o.V("".concat(n,".source"),t.source,"terrain cannot be used with a source of type ".concat(x,', it only be used with a "raster-dem" source type'))):m.push(new o.V("".concat(n,".source"),t.source,'source "'.concat(t.source,'" not found')))}else m.push(new o.V("".concat(n,".source"),t.source,"source must be a string"));else m.push(new o.V(n,t,'terrain is missing required property "source"'));return m}function Jn(l){const t=l.value,n=l.style,c=l.styleSpec,d=c.fog;if(t===void 0)return[];if(!o.H(t))return[new o.V("fog",t,"object expected, ".concat(o.K(t)," found"))];let p=[];for(const m in t){const y=m.match(/^(.*)-transition$/),x=m.match(/^(.*)-use-theme$/);p=p.concat(x&&d[x[1]]?fr({key:m,value:t[m],valueSpec:{type:"string"},style:n,styleSpec:c}):y&&d[y[1]]&&d[y[1]].transition?fr({key:m,value:t[m],valueSpec:c.transition,style:n,styleSpec:c}):d[m]?fr({key:m,value:t[m],valueSpec:d[m],style:n,styleSpec:c}):[new o.a3(m,t[m],'unknown property "'.concat(m,'"'))])}return p}const zn={"*":()=>[],array:Rr,boolean:function(l){const t=l.value,n=l.key;return o.$(t)?[]:[new o.V(n,t,"boolean expected, ".concat(o.K(t)," found"))]},number:co,color:function({key:l,value:t}){return o.a0(t)?o.a1.parseCSSColor(t)===null?[new o.V(l,t,'color expected, "'.concat(t,'" found'))]:[]:[new o.V(l,t,"color expected, ".concat(o.K(t)," found"))]},enum:En,filter:zs,function:Un,layer:Ls,object:fn,source:sn,model:o.a7,light:Jr,"light-3d":Os,terrain:Dn,fog:Jn,string:Tr,formatted:function(l){return Tr(l).length===0?[]:nn(l)},resolvedImage:function(l){return Tr(l).length===0?[]:nn(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,d=l.style;if(o.H(t)){let p=[];for(const m in t)p=p.concat(fr({key:m,value:t[m],valueSpec:c[m],style:d,styleSpec:n}));return p}return o.a0(t)?[]:[new o.V("projection",t,"object or string expected, ".concat(o.K(t)," found"))]},import:function(l){const t=l.key,{value:n,styleSpec:c}=l;if(!o.H(n))return[new o.V(t,n,"import must be an object")];const y=n,{data:d}=y,p=uf(y,["data"]);Object.defineProperty(p,"__line__",{value:n.__line__,enumerable:!1});let m=fn(Object.assign({},l,{value:p,valueSpec:c.import}));return o.J(p.id)===""&&m.push(new o.V("".concat(l.key,".id"),p,"import id can't be an empty string")),d&&(m=m.concat(Xr(d,c,{key:"".concat(l.key,".data")}))),m},iconset:function(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!o.H(t))return[new o.V(n,t,"object expected")];if(!t.type)return[new o.V(n,t,'"type" is required')];const p=o.J(t.type);let m=[];if(m=m.concat(fn({key:n,value:t,valueSpec:c["iconset_".concat(p)],style:d,styleSpec:c})),(function(y,x){return!(y!=="source"||!x.source)})(p,t)){const y=d.sources&&d.sources[t.source],x=y&&o.J(y.type);y?x!=="raster-array"&&m.push(new o.V(n,t.source,"iconset cannot be used with a source of type ".concat(String(x),', it only be used with a "raster-array" source type'))):m.push(new o.V(n,t.source,'source "'.concat(t.source,'" not found')))}return m}};function fr(l,t=!1){const n=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression){if(o.a4(o.J(n)))return Un(l);if(o.Q(o.S(n)))return nn(l)}if(c.type&&zn[c.type]){const p=zn[c.type](l);return t===!0&&p.length>0&&Array.isArray(l.value)?nn(l):p}return fn(Object.assign({},l,{valueSpec:c.type?d[c.type]:c}))}function fn(l){const t=l.key,n=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,m=l.styleSpec;if(!o.H(n))return[new o.V(t,n,"object expected, ".concat(o.K(n)," found"))];let y=[];for(const x in n){const T=x.split(".")[0];let S;d[T]?S=d[T]:c[T]?S=fr:d["*"]?S=d["*"]:c["*"]&&(S=fr),S?y=y.concat(S({key:(t&&"".concat(t,"."))+x,value:n[x],valueSpec:c[T]||c["*"],style:p,styleSpec:m,object:n,objectKey:x},n)):y.push(new o.a3(t,n[x],'unknown property "'.concat(x,'"')))}for(const x in c){if(d[x])continue;const T=c[x];T.required&&T.default===void 0&&n[x]===void 0&&y.push(new o.V(t,n,'missing required property "'.concat(x,'"')))}return y}function Es({key:l,value:t}){const n=Tr({key:l,value:t});if(n.length)return n;const c=t;return c.indexOf("{fontstack}")===-1&&n.push(new o.V(l,t,'"glyphs" url must include a "{fontstack}" token')),c.indexOf("{range}")===-1&&n.push(new o.V(l,t,'"glyphs" url must include a "{range}" token')),n}function Xr(l,t=o.a6,n={}){return fn({key:n.key||"",value:l,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:l,objectElementValidators:{glyphs:Es}})}function jr(l,t=o.a6){return pe(Xr(l,t))}const In=l=>pe(sn(l)),Qn=l=>pe(Jr(l)),Ln=l=>pe(Os(l)),bn=l=>pe(Dn(l)),Be=l=>pe(Jn(l)),On=l=>pe((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.snow;if(n===void 0)return[];if(!o.H(n))return[new o.V("snow",n,"object expected, ".concat(o.K(n)," found"))];let m=[];for(const y in n){const x=y.match(/^(.*)-transition$/);m=m.concat(x&&p[x[1]]&&p[x[1]].transition?fr({key:y,value:n[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?fr({key:y,value:n[y],valueSpec:p[y],style:c,styleSpec:d}):[new o.a3(y,n[y],'unknown property "'.concat(y,'"'))])}return m})(l)),cn=l=>pe((function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.rain;if(n===void 0)return[];if(!o.H(n))return[new o.V("rain",n,"object expected, ".concat(o.K(n)," found"))];let m=[];for(const y in n){const x=y.match(/^(.*)-transition$/);m=m.concat(x&&p[x[1]]&&p[x[1]].transition?fr({key:y,value:n[y],valueSpec:d.transition,style:c,styleSpec:d}):p[y]?fr({key:y,value:n[y],valueSpec:p[y],style:c,styleSpec:d}):[new o.a3(y,n[y],'unknown property "'.concat(y,'"'))])}return m})(l)),as=l=>pe(Ls(l)),Qt=l=>pe(zs(l)),Qr=l=>pe(Kn(l)),ks=l=>pe(vn(l)),xs=l=>pe(o.a7(l));function pe(l){return l.slice().sort(((t,n)=>t.line&&n.line?t.line-n.line:0))}function F(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof o.a3?o.w(c.message):(l.fire(new o.y(new Error(c.message))),n=!0);return n}const B=o.a6.light;let X;class ae extends o.E{constructor(t,n="flat"){super(),this._transitionable=new o.a8(X||(X=new o.a9({anchor:new o.aa(B.anchor),position:new o.ab(B.position),color:new o.aa(B.color),intensity:new o.aa(B.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(Qn,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&F(this,t.call(jr,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}const oe=o.a6.terrain;let de=class extends o.E{constructor(l,t,n,c,d){super(),this.scope=n,this._transitionable=new o.a8(new o.a9({source:new o.aa(oe.source),exaggeration:new o.aa(oe.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new o.ac(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,d=1;for(const p of t.zoomStops)d=t.evaluate(new o.ac(p,{worldview:this.worldview})),d>.01?(n=p,c=-1):c=p;return d<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof o.ad}};const Se=45,me=65,be=.05;function Ze(l,t,n,c){const d=o.ah(Se,me,n),[p,m]=Ue(l,c);let y=1-Math.min(1,Math.exp((t-p)/(m-p)*-6));return y*=y*y,y=Math.min(1,1.00747*y),y*d*l.alpha}function Ue(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function vt(l,t,n,c,d){const p=o.af([],[t,n,c],d.mercatorFogMatrix);return Ze(l,o.ag(p),d.pitch,d._fov)}function Bt(l,t,n,c,d,p,m){const y=[[n,c,0],[d,c,0],[d,p,0],[n,p,0]];let x=Number.MAX_VALUE,T=-Number.MAX_VALUE;for(const S of y){const M=o.af([],S,t),E=o.ag(M);x=Math.min(x,E),T=Math.max(T,E)}return[Ze(l,x,m.pitch,m._fov),Ze(l,T,m.pitch,m._fov)]}const Lt=o.a6.fog;class Mt extends o.E{constructor(t,n,c,d){super();const p=new o.a9({range:new o.aa(Lt.range),color:new o.aa(Lt.color),"color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.aa(Lt["high-color"]),"high-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.aa(Lt["space-color"]),"space-color-use-theme":new o.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.aa(Lt["horizon-blend"]),"star-intensity":new o.aa(Lt["star-intensity"]),"vertical-range":new o.aa(Lt["vertical-range"])});this._transitionable=new o.a8(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new o.ai(p),this.scope=c}get state(){const t=this._transform,n=t.projection.name==="globe",c=o.aj(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:n?[o.ak(p[0],d[0],c),o.ak(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(Be,t,c))return;const d=Object.assign({},t);for(const p of Object.keys(Lt))d[p]===void 0&&(d[p]=Lt[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:o.ah(Se,me,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?(function(c,d,p){const m=o.ae.fromLngLat(d),y=p.elevation?p.elevation.getAtPointOrZero(m):0;return vt(c,m.x,m.y,y,p)})(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Bt(this.state,n,0,0,o.al,o.al,this._transform)}getOpacityForBounds(t,n,c,d,p){return this._transform.projection.supportsFog?Bt(this.state,t,n,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Ue(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const d=t.points[c];let p;if(d[2]>=0)p=d;else{const m=t.points[c-4];p=o.am(m,d,m[2]/(m[2]-d[2]))}if(vt(this.state,p[0],p[1],0,this._transform)>=be)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&F(this,t.call(jr,Object.assign({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}}let ei,ri,Fi,Sr,en=class extends o.E{constructor(l,t,n,c){super();const d=ei||(ei=new o.a9({density:new o.aa(o.a6.snow.density),intensity:new o.aa(o.a6.snow.intensity),color:new o.aa(o.a6.snow.color),opacity:new o.aa(o.a6.snow.opacity),vignette:new o.aa(o.a6.snow.vignette),"vignette-color":new o.aa(o.a6.snow["vignette-color"]),"center-thinning":new o.aa(o.a6.snow["center-thinning"]),direction:new o.aa(o.a6.snow.direction),"flake-size":new o.aa(o.a6.snow["flake-size"])}));this._transitionable=new o.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.an(n[0]),d=-Math.max(o.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette"),y=this.properties.get("vignette-color");return y.a=m,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:y}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(On,l,n))return;const c=Object.assign({},l),d=o.a6.snow;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&F(this,l.call(jr,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}},Dr=class extends o.E{constructor(l,t,n,c){super();const d=ri||(ri=new o.a9({density:new o.aa(o.a6.rain.density),intensity:new o.aa(o.a6.rain.intensity),color:new o.aa(o.a6.rain.color),opacity:new o.aa(o.a6.rain.opacity),vignette:new o.aa(o.a6.rain.vignette),"vignette-color":new o.aa(o.a6.rain["vignette-color"]),"center-thinning":new o.aa(o.a6.rain["center-thinning"]),direction:new o.aa(o.a6.rain.direction),"droplet-size":new o.aa(o.a6.rain["droplet-size"]),"distortion-strength":new o.aa(o.a6.rain["distortion-strength"])}));this._transitionable=new o.a8(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ai(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.an(n[0]),d=-Math.max(o.an(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],m=this.properties.get("vignette-color");return m.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.ao(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:m}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(cn,l,n))return;const c=Object.assign({},l),d=o.a6.rain;for(const p of Object.keys(d))c[p]===void 0&&(c[p]=d[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&F(this,l.call(jr,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a6})))}};class Er extends o.E{constructor(t,n,c,d){super(),this.scope=c,this._options=t,this.properties=new o.ai(n),this._transitionable=new o.a8(n,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Ai{constructor(t,n,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=n,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,n){let c,d;if(t instanceof o.P||typeof t[0]=="number"){const p=o.P.convert(t);c=[p],d=n.isPointAboveHorizon(p)}else{const p=o.P.convert(t[0]),m=o.P.convert(t[1]),y=p.add(m)._div(2);c=[p,m],d=o.aq(p,m).every((x=>n.isPointAboveHorizon(x)))&&n.isPointAboveHorizon(y)}return new Ai(c,d,n)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return o.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.aq(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(d[3]=this.cameraPoint)),o.ar(d,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],d=o.aq(n,c,t),p=this.cameraPoint.clone();switch(3*((p.y>n.y)+(p.y>c.y))+((p.x>n.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,n,c,d=0){const p=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/n._pixelsPerMercatorPixel+1,m=c?this._bufferedCameraMercator(p,n):this._bufferedScreenMercator(p,n);let y=t.tileID.wrap+(m.unwrapped?d:0);const x=m.polygon.map((V=>o.as(t.tileTransform,V,y)));if(!o.at(x,0,0,o.al,o.al))return;y=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const T=this.screenGeometryMercator.polygon.map((V=>o.au(t.tileTransform,V,y))),S=T.map((V=>new o.P(V[0],V[1]))),M=n.getFreeCameraOptions().position||new o.ae(0,0,0),E=o.au(t.tileTransform,M,y),P=T.map((V=>{const N=o.av(V,V,E);return o.aw(N,N),new o.ax(E,N)})),D=o.ay(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:S,tilespaceRays:P,bufferedTilespaceGeometry:x,bufferedTilespaceBounds:(O=o.az(x),O.min.x=o.aA(O.min.x,0,o.al),O.min.y=o.aA(O.min.y,0,o.al),O.max.x=o.aA(O.max.x,0,o.al),O.max.y=o.aA(O.max.y,0,o.al),O),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:D};var O}_bufferedScreenMercator(t,n){const c=pr(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,n){const c=pr(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map((p=>n.pointCoordinate3D(p))),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,n){const c=(function(p,m){const y=o.aB([],m.pixelMatrix,m.globeMatrix),x=[0,-o.aD,0,1],T=[0,o.aD,0,1],S=[0,0,0,1];o.aC(x,x,y),o.aC(T,T,y),o.aC(S,S,y);const M=new o.P(x[0]/x[3],x[1]/x[3]),E=new o.P(T[0]/T[3],T[1]/T[3]),P=o.aE(p,M)&&x[3]<S[3],D=o.aE(p,E)&&T[3]<S[3];if(!P&&!D)return null;const O=(function(re,ee,K){for(let ne=1;ne<re.length;ne++){const _e=lr(ee.pointCoordinate3D(re[ne-1]).x),fe=lr(ee.pointCoordinate3D(re[ne]).x);if(K<0){if(_e<fe)return{idx:ne,t:-_e/(fe-1-_e)}}else if(fe<_e)return{idx:ne,t:(1-_e)/(fe+1-_e)}}return null})(p,m,P?-1:1);if(!O)return null;const{idx:V,t:N}=O;let j=V>1?ui(p.slice(0,V),m):[],Z=V<p.length?ui(p.slice(V),m):[];j=j.map((re=>new o.P(lr(re.x),re.y))),Z=Z.map((re=>new o.P(lr(re.x),re.y)));const H=[...j];H.length===0&&H.push(Z[Z.length-1]);const te=o.ak(H[H.length-1].y,(Z.length===0?j[0]:Z[0]).y,N);let W;return W=P?[new o.P(0,te),new o.P(0,0),new o.P(1,0),new o.P(1,te)]:[new o.P(1,te),new o.P(1,1),new o.P(0,1),new o.P(0,te)],H.push(...W),Z.length===0?H.push(j[0]):H.push(...Z),{polygon:H.map((re=>new o.ae(re.x,re.y))),unwrapped:!1}})(t,n);if(c)return c;const d=(function(p,m){let y=!1,x=-1/0,T=0;for(let M=0;M<p.length-1;M++)p[M].x>x&&(x=p[M].x,T=M);for(let M=0;M<p.length-1;M++){const E=(T+M)%(p.length-1),P=p[E],D=p[E+1];Math.abs(P.x-D.x)>.5&&(P.x<D.x?(P.x+=1,E===0&&(p[p.length-1].x+=1)):(D.x+=1,E+1===p.length-1&&(p[0].x+=1)),y=!0)}const S=o.aF(m.center.lng);return y&&S<Math.abs(S-1)&&p.forEach((M=>{M.x-=1})),{polygon:p,unwrapped:y}})(ui(t,n).map((p=>new o.P(lr(p.x),p.y))),n);return{polygon:d.polygon.map((p=>new o.ae(p.x,p.y))),unwrapped:d.unwrapped}}}function ui(l,t){return o.aG(l,(n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y}),1/256)}function lr(l){return l<0?1+l%1:l%1}function pr(l){return 100*l|0}function Di(l,t,n,c,d){const p=function(y,x){if(y)return d(y);if(x){if(l.url&&x.tiles&&l.tiles&&delete l.tiles,x.variants){if(!Array.isArray(x.variants))return d(new Error("variants must be an array"));for(const S of x.variants){if(S==null||typeof S!="object"||S.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(S.capabilities))return d(new Error("capabilities must be an array"));if(S.capabilities.length===1&&S.capabilities[0]==="meshopt"){x=Object.assign(x,S);break}}}const T=o.aH(Object.assign({},x,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);T.tiles=t.canonicalizeTileset(T,l.url),d(null,T)}},m=(function(y,x,T){if(!y)return null;if(!x&&!T)return y;T=T||y.worldview_default;const S=Object.values(y.language||{});if(S.length===0)return null;const M=Object.values(y.worldview||{});if(M.length===0)return null;const E=S.every((D=>D===x)),P=M.every((D=>D===T));return E&&P?y:x in(y.language_options||{})||T in(y.worldview_options||{})?null:y.language_options&&y.worldview_options?y:null})(l.data,n,c);return m?o.o.frame((()=>p(null,m))):l.url?o.m(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),o.R.Source),p):o.o.frame((()=>{const T=l,{data:y}=T,x=uf(T,["data"]);p(null,x)}))}function er(l,t){const n=Math.pow(2,t.z),c=Math.floor(o.aF(l.getWest())*n),d=Math.floor(o.aJ(l.getNorth())*n),p=Math.ceil(o.aF(l.getEast())*n),m=Math.ceil(o.aJ(l.getSouth())*n);return t.x>=c&&t.x<p&&t.y>=d&&t.y<m}class Yr{constructor(t,n,c){this.bounds=t?o.aI.convert(this.validateBounds(t)):null,this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const n of t)this.extraBounds.push(o.aI.convert(this.validateBounds(n)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!er(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const n of this.extraBounds)if(er(n,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const n=new Yr(t.bounds,t.minzoom,t.maxzoom);return n.addExtraBounds(t.extra_bounds),n}}class wn extends o.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,o.aH(n,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new o.aK}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=Di(this._options,this.map._requestManager,n,c,((d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)n&&console.warn("Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ".concat(n)),c&&console.warn("Requested worldview strings must be a valid ISO alpha-2 code. Found: ".concat(c)),this.fire(new o.y(d));else if(p){if(Object.assign(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const m of p.vector_layers)this.vectorLayerIds.push(m.id),p.worldview&&p.worldview[m.source]&&this.localizableLayerIds.add(m.id)}this.tileBounds=Yr.fromTileJSON(p),dn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,o.R.Tile),m=this.map.style?this.map.style.getLut(this.scope):null,y=m?{image:m.image.clone()}:null,x={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:y,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&o.h(c)&&(x.localizableLayerIds=this.localizableLayerIds),x.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=n:t.request=t.actor.send("reloadTile",x,T.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",x,T.bind(this),void 0,!0);else{const S=o.aL.call({deduped:this._deduped},x,((M,E)=>{if(M||!E)T.call(this,M);else{const P=o.aM(E.responseHeaders);x.data={cacheControl:P.cacheControl,expires:P.expires,rawData:E.rawData.slice(0)},t.actor&&t.actor.send("loadTile",x,T.bind(this),void 0,!0)}}),!0);t.request={cancel:S}}function T(S,M){return delete t.request,t.aborted?n(null):S&&S.status!==404?n(S):(M&&M.resourceTiming&&(t.resourceTiming=M.resourceTiming),this.map._refreshExpiredTiles&&M&&t.setExpiryData(M),t.loadVectorData(M,this.map.painter),o.aN(this.dispatcher),n(null,M),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class _s extends o.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},n),Object.assign(this,o.aH(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const n=this.map.getWorldview();this._tileJSONRequest=Di(this._options,this.map._requestManager,null,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new o.y(c)):d&&(Object.assign(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map((p=>p.id))),this.tileBounds=Yr.fromTileJSON(d),dn(d.tiles),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=o.o.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=o.n(this.map._requestManager.transformRequest(d,o.R.Tile),((p,m,y)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(p)return t.state="errored",n(p);if(!m)return n(null);const x=o.aM(y);this.map._refreshExpiredTiles&&t.setExpiryData(x),t.setTexture(m,this.map.painter),t.state="loaded",o.aN(this.dispatcher),n(null)}))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof o.T?(t.destroy(!0),t.texture&&t.texture instanceof o.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Co([l,t],n,c,{scaled:d=!0}={}){const{tileSize:p,buffer:m}=c,{x:y,y:x,z:T}=n;if(!isFinite(y)||!isFinite(x)||!isFinite(T))throw new Error("Invalid MRT header");const S=2**T,M=S*o.aF(l),E=S*o.aJ(t);return(function([P,D],O,{scaled:V=!0}={}){if(!O)throw new Error("bandView is undefined");const{data:N,tileSize:j,buffer:Z,offset:H,scale:te,dimension:W}=O;if(P<-Z||P>j+Z||D<-Z||D>j+Z)throw new Error("Point (".concat(P,", ").concat(D,") out of bounds for tileSize=").concat(j,", buffer=").concat(Z));const re=(D+Z)*(j+2*Z)+(P+Z);if(new Uint32Array(N.buffer)[re]===4294967295)return null;let ee=[];ee=V?[]:new O.data.constructor(W);for(let K=0;K<W;K++)ee[K]=Math.round(1e12*(N[W*re+K]*te+H))/1e12;return ee})([Math.min(Math.max(-m,Math.floor((M-y)*p)),p-1+m),Math.min(Math.max(-m,Math.floor((E-x)*p)),p-1+m)],c,{scaled:d})}class pn extends _s{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,o.R.Tile),p={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());const m=(y,x,T)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(y)return y.name==="AbortError"?void 0:(t.state="errored",n(y));if(this.map._refreshExpiredTiles&&x){const S=o.aM(T);t.setExpiryData(S)}if(this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!x)return n(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=x}n(null)};t.request=this.partial?t.fetchHeader(void 0,m.bind(this)):t.actor.send("loadTile",p,m.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){const c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!0);for(const d of c.values())this.map.painter.saveTileTexture(d)}else t.destroy()}prepareTile(t,n,c,d){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(n,c,d,((p,m)=>{if(p)return t.state="errored",this.fire(new o.y(p)),void this.triggerRepaint(t);m&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,m,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find((({id:p})=>p===t)),c=n&&n.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const d=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;n instanceof o.aQ?p=n.paint.get("raster-array-band"):n instanceof o.aR&&(p=n.paint.get("raster-particle-array-band"));const m=p||this.getInitialBand(d);if(m==null)return;if(!t.textureDescriptorPerLayer.get(n.id))return void this.prepareTile(t,d,n.id,m);if(t.updateNeeded(n.id,m)&&!c)return;const y=t.textureDescriptorPerLayer.get(n.id);return Object.assign({},y,{texture:t.texturePerLayer.get(n.id)})}getImages(t,n){const c=new Map;for(const d of t)for(const p of n){const[m,y]=p.split("/"),x=d.getLayer(m);if(!x||!x.hasBand(y)||!x.hasDataForBand(y))continue;const{bytes:T,tileSize:S,buffer:M}=x.getBandView(y),E=S+2*M,P={data:new o.q({width:E,height:E},T),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(p,P)}return c}queryRasterArrayValueByBandId(t,n,c){const d=n._mrt;return new Promise((p=>{const m={},y=new Set;for(const[x,T]of Object.entries(d.layers)){if(c.layerName&&x!==c.layerName)continue;const S={};m[x]=S;for(const{bands:M}of T.dataIndex)for(const E of M)c.bands&&!c.bands.includes(E)||(y.add(o.B(x,E)),n.fetchBand(x,null,E,(P=>{o.o.frame((()=>{S[E]=P?null:Co([t.lng,t.lat],d,T.getBandView(E)),y.delete(o.B(x,E)),y.size===0&&p(m)}))}),!1))}y.size===0&&p(m)}))}_loadTileForQuery(t,n){if(this._loadTileLoaded[t.uid])return void n(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(n);this._loadTilePending[t.uid]=[n];const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,o.R.Tile);t.actor.send("loadTile",{request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},((p,m,y)=>{if(p)return this._loadTilePending[t.uid].forEach((x=>x(p,null))),void delete this._loadTilePending[t.uid];if(!m)return this._loadTilePending[t.uid].forEach((x=>x(null,null))),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&m){const x=o.aM(y);t.setExpiryData(x)}t._mrt=m,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach((x=>x(null,m))),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]}),void 0,!0)}queryRasterArrayValueByAllBands(t,n,c){return new Promise(((d,p)=>{this._loadTileForQuery(n,((m,y)=>{m?p(m):d(y?this.queryRasterArrayValueByBandId(t,n,c):null)}))}))}queryRasterArrayValue(t,n){const c=o.aS.convert(t),d=this.findLoadedParent(c);return d&&d._mrt?n.bands||!this.partial?this.queryRasterArrayValueByBandId(c,d,n):this.queryRasterArrayValueByAllBands(c,d,n):Promise.resolve(null)}findLoadedParent(t){const n=o.ae.fromLngLat(t,this.map.transform.tileSize),c=this.maxzoom+1,d=1<<c,p=Math.floor(n.x),m=Math.floor((n.x-p)*d),y=Math.floor(n.y*d),x=this.map.style.getSourceCache(this.id),T=new o.aP(c,p,c,m,y);return x.findLoadedParent(T,this.minzoom)}}const Is={vector:wn,raster:_s,"raster-dem":class extends _s{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=o.n(this.map._requestManager.transformRequest(n,o.R.Tile),function(d,p,m){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){const y=o.aM(m);this.map._refreshExpiredTiles&&l.setExpiryData(y);const x=ImageBitmap&&p instanceof ImageBitmap&&o.r(),T=1-(p.width-o.aO(p.width))/2;T<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const S=x?p:o.o.getImageData(p,T),M={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:S,encoding:this.encoding,padding:T};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",M,c.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+n)%n,m=t.x+1===n?l.wrap+1:l.wrap,y={};return y[new o.aP(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},y[new o.aP(l.overscaledZ,m,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(y[new o.aP(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},y[new o.aP(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},y[new o.aP(l.overscaledZ,m,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<n&&(y[new o.aP(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},y[new o.aP(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},y[new o.aP(l.overscaledZ,m,t.z,p,t.y+1).key]={backfilled:!1}),y}},"raster-array":pn,geojson:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=o.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:o.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:o.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new o.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new o.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=Object.assign({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;typeof n=="string"?(t.request=this.map._requestManager.transformRequest(o.o.resolveURL(n),o.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send("".concat(this.type,".loadData"),t,((c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new o.y(c));else{const p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new o.z("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const l=o.B(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,m={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:o.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:p,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};l.request=this.actor.send(n,m,((y,x)=>p&&!x?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):y?t(y):(l.loadVectorData(x,this.map.painter,n==="reloadTile"),t(null)))),void 0,n==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aT{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,o.R.Source).url);o.aU(this.urls,((t,n)=>{this._loaded=!0,t?this.fire(new o.y(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new o.y(new o.V("sources.".concat(this.id),null,"Playback for this video can be set only between the ".concat(t.start(0)," and ").concat(t.end(0),"-second mark.")))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aT,model:o.aW,"batched-model":class extends o.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=o.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(l)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=Di(this._options,this.map._requestManager,t,n,((c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn("Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ".concat(t)),n&&n.length!==2&&console.warn("Requested worldview strings must be a valid ISO alpha-2 code. Found: ".concat(n)),this.fire(new o.y(c))):d&&(Object.assign(this,d),d.bounds&&(this.tileBounds=new Yr(d.bounds,this.minzoom,this.maxzoom)),dn(d.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)}))}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,o.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:o.o.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const p=Object.values(l.buckets);for(const m of p)m.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,m){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&m&&l.setExpiryData(m),l.loadModelData(m,this.map.painter),l.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends o.aT{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some((d=>!Array.isArray(d)||d.length!==2||d.some((p=>typeof p!="number"))))||this.fire(new o.y(new o.V("sources.".concat(l),null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.y(new o.V("sources.".concat(l),null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new o.y(new o.V("sources.".concat(l),null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new o.y(new o.V("sources.".concat(l),null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.y(new o.V("sources.".concat(l),null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof o.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.y(new Error("Missing implementation for ".concat(this.id," custom source")))),this._implementation.loadTile||this.fire(new o.y(new Error("Missing loadTile implementation for ".concat(this.id," custom source")))),this._implementation.bounds&&(this.tileBounds=new Yr(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,o.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:d},{signal:p.signal})).then(function(m){return delete l.request,l.aborted?(l.state="unloaded",t(null)):m===void 0?(l.state="errored",t(null)):m===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):(function(y){return y instanceof ImageData||y instanceof HTMLCanvasElement||y instanceof ImageBitmap||y instanceof HTMLImageElement})(m)?(this.loadTileData(l,m),l.state="loaded",void t(null)):(l.state="errored",t(new Error("Can't infer data type for ".concat(this.id,", only raster data supported at the moment"))))}.bind(this)).catch((m=>{m.name!=="AbortError"&&(l.state="errored",t(m))})),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof o.T?(l.destroy(!0),l.texture&&l.texture instanceof o.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z})))}_clearTiles(){const l=o.B(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}}},es=function(l,t,n,c){const d=new Is[t.type](l,t,n,c);if(d.id!==l)throw new Error("Expected Source id to be ".concat(l," instead of ").concat(d.id));return o.aX(["load","abort","unload","serialize","prepare"],d),d};function Ht(l,t,n=""){return"".concat(n,":").concat(t.id||"",":").concat(t.layer.id,":").concat((function(c){if("layerId"in c)return"layer:".concat(c.layerId);{const{featuresetId:d,importId:p}=c;return"featureset:".concat(d).concat(p?":import:".concat(p):"")}})(l.target))}function Ut(l,t,n,c=""){if(l.uniqueFeatureID){const d=Ht(l,t,c);if(n.has(d))return!0;n.add(d)}return!1}function Mi(l,t,n,c,d=!1){const p=t.sourceCache.transform,m=t.sourceCache.tilesIn(l,t.has3DLayers,d);m.sort(hn);const y=[];for(const x of m){const T=x.tile.queryRenderedFeatures(t,x,n,c,p,d);Object.keys(T).length&&y.push({wrappedTileID:x.tile.tileID.wrapped().key,queryResults:T})}for(const x in t.layers){const T=t.layers[x];if(T.styleLayer){const S=T.styleLayer.queryRenderedFeatures(l,t.sourceCache,c);Object.keys(S).length&&y.push({wrappedTileID:0,queryResults:S})}}return y.length===0?{}:(function(x){const T={},S={};for(const M of x){const E=M.queryResults,P=M.wrappedTileID,D=S[P]=S[P]||{};for(const O in E){const V=E[O],N=D[O]=D[O]||{},j=T[O]=T[O]||[];for(const Z of V)N[Z.featureIndex]||(N[Z.featureIndex]=!0,j.push(Z))}}return T})(y)}function ji(l,t,n,c,d,p){const m={},y=c.queryRenderedSymbols(l),x=[];for(const T of Object.keys(y).map(Number))x.push(d[T]);x.sort(hn);for(const T of x){const S=T.featureIndex.lookupSymbolFeatures(y[T.bucketInstanceId],T.bucketIndex,T.sourceLayerIndex,t,n,p);for(const M in S){const E=m[M]=m[M]||[],P=S[M];P.sort(((D,O)=>{const V=T.featureSortOrder;if(V){const N=V.indexOf(D.featureIndex);return V.indexOf(O.featureIndex)-N}return O.featureIndex-D.featureIndex}));for(const D of P)E.push(D)}}return m}function mr(l,t){const n=l.getRenderableIds().map((p=>l.getTileByID(p))),c=[],d={};for(let p=0;p<n.length;p++){const m=n[p],y=m.tileID.canonical.key;d[y]||(d[y]=!0,m.querySourceFeatures(c,t))}return c}function hn(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function sr(l,t){const n={};if(!t)return n;for(const c of l){const d=c.layerIds.map((p=>t.getLayer(p))).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map((p=>d.filter((m=>m.id===p))[0])));for(const p of d)n[p.fqid]=c}}return n}const jn=32,As=33,Gn=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,d=0,p=0,m=0,y=0;for(1&t?d=p=m=jn:n=c=y=jn;(t>>=1)>1;){const T=n+d>>1,S=c+p>>1;1&t?(d=n,p=c,n=m,c=y):(n=d,c=p,d=m,p=y),m=T,y=S}const x=4*l;Gn[x+0]=n,Gn[x+1]=c,Gn[x+2]=d,Gn[x+3]=p}const vs=new Uint16Array(2178),ho=new Uint8Array(1089),Po=new Uint16Array(1089);function ba(l){return l===0?-.03125:l===32?.03125:0}const Ro={type:2,extent:o.al,loadGeometry:()=>[[new o.P(0,0),new o.P(o.al+1,0),new o.P(o.al+1,o.al+1),new o.P(0,o.al+1),new o.P(0,0)]]};class qs{constructor(t,n,c,d,p,m){this.tileID=t,this.uid=o.b1(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=m,this._hasAppearances=null}registerFadeDuration(t){const n=t+this.timeAdded;n<o.o.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=sr(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const p=this.buckets[d];if(p instanceof o.b3){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const p=this.buckets[d];if(p instanceof o.b3&&p.hasRTLText){this.hasRTLText=!0,o.b4();break}}this.queryPadding=0;for(const d in this.buckets){const p=this.buckets[d],m=n.style.getOwnLayer(d);if(!m)continue;const y=m.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,y)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new o.b2}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,sr(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t,n){for(const p in this.buckets){const m=this.buckets[p];if(m.uploadPending()){let y={},x=[],T={zoom:0,pitch:0,brightness:0,worldview:""};if(n){if(n.style){x=n.style.listImages();const S=m.layers[0],M=S.sourceLayer||"_geojsonTileLayer",E=n.style.getLayerSourceCache(S);E&&(y=E._state.getState(M,void 0))}T={zoom:n.transform.zoom||0,pitch:n.transform.pitch||0,brightness:n.style.getBrightness()||0,worldview:n.worldview||""}}m.upload(t,this.tileID.canonical,y,x,T)}}const c=t.gl,d=this.imageAtlas;d&&!d.uploaded&&(this.imageAtlasTexture=new o.T(t,d.image,c.RGBA8,{useMipmap:!!d.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(t,this.glyphAtlasImage,c.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(t,this.lineAtlas.image,c.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=n.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(n)),(this._lastUpdatedBrightness||d||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}evaluateQueryRenderedFeaturePadding(){let t=0;for(const n in this.buckets){const c=this.buckets[n];c.evaluateQueryRenderedFeaturePadding&&(t=Math.max(t,c.evaluateQueryRenderedFeaturePadding()))}return t}queryRenderedFeatures(t,n,c,d,p,m){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const y=this.evaluateQueryRenderedFeaturePadding(),x=(function(T,S){const M=o.bp([],[.5*T.width,.5*-T.height,1]);return o.bq(M,M,[1,-1,0]),o.aB(M,M,T.calculateProjMatrix(S.toUnwrapped())),Float32Array.from(M)})(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:x,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:y})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),p=n?n.sourceLayer:"",m=d._geojsonTileLayer||d[p];if(!m)return;const y=o.b5(n&&n.filter),{z:x,x:T,y:S}=this.tileID.canonical,M={z:x,x:T,y:S};for(let E=0;E<m.length;E++){const P=m.feature(E);if(y.needGeometry){const V=o.b6(P,!0);if(!y.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),V,this.tileID.canonical))continue}else if(!y.filter(new o.ac(this.tileID.overscaledZ,{worldview:this.worldview}),P))continue;const D=c.getId(P,p),O=new o.b7(P,x,T,S,D);O.tile=M,t.push(O)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=o.b8(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const p=this.expirationTime-n;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}hasAppearances(t){for(const n in this.buckets)if(t.style.hasLayer(n)&&this.buckets[n].layers.some((c=>c.appearances&&c.appearances.length>0)))return!0;return!1}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),p=t.style.getBrightness();for(const m in this.buckets){if(!t.style.hasLayer(m))continue;const y=this.buckets[m],x=y.layers[0],T=x.sourceLayer||"_geojsonTileLayer",S=c[T],M=t.style.getLayerSourceCache(x);let E={};M&&(E=M._state.getState(T,void 0));const P=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},D=Object.keys(E).length>0&&!n;if(y.hasAppearances=y.layers.some((V=>V.appearances&&V.appearances.length>0)),(D&&y.stateDependentLayers.length!==0||n)&&y.update(E,S,d,P,D?y.stateDependentLayers:y.layers,n,p),D&&y.stateDependentLayers.length!==0||n||y.hasAppearances){const V={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};y.updateAppearances(this.tileID.canonical,E,d,V)}(y instanceof o.b9||y instanceof o.ba)&&t._terrain&&t._terrain.enabled&&M&&y.uploadPending()&&t._terrain._clearRenderCacheForTile(M.id,this.tileID);const O=t&&t.style&&t.style.getOwnLayer(m);O&&(this.queryPadding=Math.max(this.queryPadding,O.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.o.now()+t}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t):(this.texture=new o.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const p of n)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const c=o.bb(Ro,this.tileID.canonical,this.tileTransform)[0],d=new o.bc,p=new o.bd;for(let m=0;m<c.length;m++){const{x:y,y:x}=c[m];d.emplaceBack(y,x),p.emplaceBack(m)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,o.be.members),this._tileDebugSegments=o.bf.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const c=o.bb(Ro,this.tileID.canonical,this.tileTransform)[0];let d,p;if(this.isRaster){const m=(function(y,x){const T=o.aY(y,x),S=Math.pow(2,y.z);for(let V=0;V<As;V++)for(let N=0;N<As;N++){const j=o.aZ((y.x+(N+ba(N))/jn)/S),Z=o.a_((y.y+(V+ba(V))/jn)/S),H=x.project(j,Z),te=V*As+N;vs[2*te+0]=Math.round((H.x*T.scale-T.x)*o.al),vs[2*te+1]=Math.round((H.y*T.scale-T.y)*o.al)}ho.fill(0),Po.fill(0);for(let V=2045;V>=0;V--){const N=4*V,j=Gn[N+0],Z=Gn[N+1],H=Gn[N+2],te=Gn[N+3],W=j+H>>1,re=Z+te>>1,ee=W+re-Z,K=re+j-W,ne=Z*As+j,_e=te*As+H,fe=re*As+W,Me=Math.hypot((vs[2*ne+0]+vs[2*_e+0])/2-vs[2*fe+0],(vs[2*ne+1]+vs[2*_e+1])/2-vs[2*fe+1])>=16;ho[fe]=ho[fe]||(Me?1:0),V<1022&&(ho[fe]=ho[fe]||ho[(Z+K>>1)*As+(j+ee>>1)]||ho[(te+K>>1)*As+(H+ee>>1)])}const M=new o.a$,E=new o.b0;let P=0;function D(V,N){const j=N*As+V;return Po[j]===0&&(M.emplaceBack(vs[2*j+0],vs[2*j+1],V*o.al/jn,N*o.al/jn),Po[j]=++P),Po[j]-1}function O(V,N,j,Z,H,te){const W=V+j>>1,re=N+Z>>1;if(Math.abs(V-H)+Math.abs(N-te)>1&&ho[re*As+W])O(H,te,V,N,W,re),O(j,Z,H,te,W,re);else{const ee=D(V,N),K=D(j,Z),ne=D(H,te);E.emplaceBack(ee,K,ne)}}return O(0,0,jn,jn,jn,0),O(jn,jn,0,0,0,jn),{vertices:M,indices:E}})(this.tileID.canonical,n);d=m.vertices,p=m.indices}else{d=new o.a$,p=new o.b0;for(const{x:y,y:x}of c)d.emplaceBack(y,x,0,0);const m=o.bg(d.int16.subarray(0,4*d.length),void 0,4);for(let y=0;y<m.length;y+=3)p.emplaceBack(m[y],m[y+1],m[y+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,o.bh.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=o.bf.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||c.name!=="globe"||n.freezeTileCoverage)return;const d=this.tileID.canonical,p=o.bi(d,n),m=o.bj(p),y=o.aj(n.zoom);let x;y>0&&(x=o.bk(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,n,m,x,y),this._makeGlobeTileDebugTextBuffer(t,d,n,m,x,y)}_globePoint(t,n,c,d,p,m,y){let x=o.bl(t,n,c);if(m){const T=1<<c.z,S=o.aF(d.center.lng),M=o.aJ(d.center.lat),E=(c.x+.5)/T-S;let P=0;E>.5?P=-1:E<-.5&&(P=1);let D=(t/o.al+c.x)/T+P,O=(n/o.al+c.y)/T;D=(D-S)*d._pixelsPerMercatorPixel+S,O=(O-M)*d._pixelsPerMercatorPixel+M;const V=[D*d.worldSize,O*d.worldSize,0];o.af(V,V,m),x=o.bm(x,V,y)}return o.af(x,x,p)}_makeGlobeTileDebugBorderBuffer(t,n,c,d,p,m){const y=new o.bc,x=new o.bd,T=new o.bn,S=(E,P,D,O,V)=>{const N=(D-E)/(V-1),j=(O-P)/(V-1),Z=y.length;for(let H=0;H<V;H++){const te=E+H*N,W=P+H*j;y.emplaceBack(te,W);const re=this._globePoint(te,W,n,c,d,p,m);T.emplaceBack(re[0],re[1],re[2]),x.emplaceBack(Z+H)}},M=o.al;S(0,0,M,0,16),S(M,0,M,M,16),S(M,M,0,M,16),S(0,M,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(x),this._tileDebugBuffer=t.createVertexBuffer(y,o.be.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(T,o.bo.members),this._tileDebugSegments=o.bf.simpleSegment(0,0,y.length,x.length)}_makeGlobeTileDebugTextBuffer(t,n,c,d,p,m){const y=o.al/4,x=new o.bc,T=new o.b0,S=new o.bn,M=25;T.reserve(32),x.reserve(M),S.reserve(M);const E=(P,D)=>M*P+D;for(let P=0;P<M;P++){const D=P*y;for(let O=0;O<M;O++){const V=O*y;x.emplaceBack(V,D);const N=this._globePoint(V,D,n,c,d,p,m);S.emplaceBack(N[0],N[1],N[2])}}for(let P=0;P<4;P++)for(let D=0;D<4;D++){const O=E(P,D),V=E(P,D+1),N=E(P+1,D),j=E(P+1,D+1);T.emplaceBack(O,V,N),T.emplaceBack(N,V,j)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(T),this._tileDebugTextBuffer=t.createVertexBuffer(x,o.be.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(S,o.bo.members),this._tileDebugTextSegments=o.bf.simpleSegment(0,0,M,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.br.setPbf(o.bs);class Ms extends qs{constructor(t,n,c,d,p){super(t,n,c,d,p),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,n,c){const d=c.context,p=d.gl;let m=this.texturePerLayer.get(t)||c.getTileTexture(n.width);m&&m instanceof o.T?m.update(n,{premultiply:!1}):m=new o.T(d,n,p.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,m)}flushQueues(t){const n=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const n=this._workQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const n=this._fetchQueuePerLayer.get(t)||[];for(;n.length;)n.pop()()}}fetchHeader(t=16384,n){const c=this._mrt=new o.br(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=o.bt(d,((p,m,y)=>{if(p)n(p);else try{const x=c.getHeaderLength(m);if(x>t)return void(this.request=this.fetchHeader(x,n));c.parseHeader(m),this._isHeaderLoaded=!0;let T=0;for(const S of Object.values(c.layers))T=Math.max(T,S.dataIndex[S.dataIndex.length-1].lastByte);m.byteLength>=T&&(this.entireBuffer=m),n(null,this.entireBuffer||m,y)}catch(x){n(x)}})),this.request}fetchBandForRender(t,n,c,d){this.fetchBand(t,n,c,(p=>{if(p)return void d(p);this.updateTextureDescriptor(t,n,c);const m=this.textureDescriptorPerLayer.get(n);d(null,m?m.img:null)}))}fetchBand(t,n,c,d,p=!0){const m=this._mrt;if(!this._isHeaderLoaded||!m)return void d(new Error("Tile header is not ready"));const y=this.actor;if(!y)return void d(new Error("Can't fetch tile band without an actor"));let x;const T=o.B(String(c),o.B(this.tileID.key,t));let S=this._taskQueue.get(T);S?S.add(d):(S=new Set,S.add(d),this._taskQueue.set(T,S));const M=(O,V)=>{x.complete(O,V),O?d(O):(S.values().forEach((N=>N(null,V))),this._taskQueue.delete(T))},E=(O,V)=>{if(O)return d(O);const N=y.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:V,task:x},M,void 0,!0);if(n!==null){const j=this._workQueuePerLayer.get(n)||[];j.push((()=>{N&&N.cancel(),x.cancel()})),this._workQueuePerLayer.has(n)||this._workQueuePerLayer.set(n,j)}};let P;try{P=m.getLayer(t)}catch(O){if(this.state==="reloading")return;throw O}if(!P)return void d(new Error('Unknown sourceLayer "'.concat(t,'"')));if(P.hasDataForBand(c))return S.values().forEach((O=>O(null,null))),void this._taskQueue.delete(T);const D=P.getDataRange([c]);if(x=m.createDecodingTask(D),!x||x.tasks.length)if(n!==null&&this.flushQueues(n),this.entireBuffer)E(null,this.entireBuffer.slice(D.firstByte,D.lastByte+1));else{const O=Object.assign({},this.requestParams,{headers:{Range:"bytes=".concat(D.firstByte,"-").concat(D.lastByte)}}),V=o.bt(O,E);if(n!==null){const N=this._fetchQueuePerLayer.get(n)||[];N.push((()=>{V.cancel(),x.cancel()})),this._fetchQueuePerLayer.has(n)||this._fetchQueuePerLayer.set(n,N)}}}updateNeeded(t,n){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==n||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,n,c){if(!this._mrt)return;const d=this._mrt.getLayer(t);if(!d||!d.hasBand(c)||!d.hasDataForBand(c))return;const{bytes:p,tileSize:m,buffer:y,offset:x,scale:T}=d.getBandView(c),S=m+2*y,M=new o.q({width:S,height:S},p),E=this.texturePerLayer.get(n);E&&E instanceof o.T&&E.update(M,{premultiply:!1}),this.textureDescriptorPerLayer.set(n,{layer:t,band:c,img:M,buffer:y,offset:x,tileSize:m,format:d.pixelFormat,mix:[T,256*T,65536*T,16777216*T]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const n of this.texturePerLayer.values())n&&n instanceof o.T&&n.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class $a{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const p={value:n,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout((()=>{this.remove(t,p)}),c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){const m=this._getAndRemoveByKey(this.order[0]);m&&this.onRemove(m)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class wa{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},Object.assign(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(const p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(n!==void 0){const y=String(n),x=Object.assign({},c[y],d[y]);if(p){const T=p[n];if(T===null)return{};for(const S in T)delete x[S]}return x}const m=Object.assign({},c,d);if(p)for(const y in p)delete m[y];return m}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const p={};for(const m in this.stateChanges[d])this.state[d][m]||(this.state[d][m]={}),Object.assign(this.state[d][m],this.stateChanges[d][m]),p[m]=this.state[d][m];c[d]=p}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const p={};if(this.deletedStates[d]===null)for(const m in this.state[d])p[m]={},this.state[d][m]={};else for(const m in this.deletedStates[d]){if(this.deletedStates[d][m]===null)this.state[d][m]={};else if(this.state[d][m])for(const y of Object.keys(this.deletedStates[d][m]))delete this.state[d][m][y];p[m]=this.state[d][m]}c[d]=c[d]||{},Object.assign(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(n)}}class Fs extends o.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",(d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))})),n.on("error",(()=>{this._sourceErrored=!0})),this._source=n,this._tiles={},this._cache=new $a(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new wa,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t,this.map?this.map.painter:void 0),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((t=>t.tileID)).sort(lh).map((t=>t.key))}getRenderableIds(t,n){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,n)&&c.push(this._tiles[d]);return t?c.sort(((d,p)=>{const m=d.tileID,y=p.tileID,x=new o.P(m.canonical.x,m.canonical.y)._rotate(this.transform.angle),T=new o.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle);return m.overscaledZ-y.overscaledZ||T.y-x.y||T.x-x.x})).map((d=>d.tileID.key)):c.map((d=>d.tileID)).sort(lh).map((d=>d.key))}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,d,p){if(d){if(t.state="errored",d.status!==404)this._source.fire(new o.y(d,{tile:t}));else{if(this._source.fire(new o.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const y=this.map.painter.terrain;this.update(this.transform,y.getScaledDemTileSize(),!0),y.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=o.o.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let m=new Map;p&&p.responseHeaders&&(m=p.responseHeaders),this._source.fire(new o.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:m}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const p=n[d];if(t.neighboringTiles&&t.neighboringTiles[p]){const m=this.getTileByID(p);c(t,m),c(m,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let m=p.tileID.canonical.x-d.tileID.canonical.x;const y=p.tileID.canonical.y-d.tileID.canonical.y,x=Math.pow(2,d.tileID.canonical.z),T=p.tileID.key;m===0&&y===0||Math.abs(y)>1||(Math.abs(m)>1&&(Math.abs(m+x)===1?m+=x:Math.abs(m-x)===1&&(m-=x)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,m,y),d.neighboringTiles&&d.neighboringTiles[T]&&(d.neighboringTiles[T].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const p in this._tiles){let m=this._tiles[p];if(d[p]||!m.hasData()||m.tileID.overscaledZ<=n||m.tileID.overscaledZ>c)continue;let y=m.tileID;for(;m&&m.tileID.overscaledZ>n+1;){const T=m.tileID.scaledTo(m.tileID.overscaledZ-1);m=this._tiles[T.key],m&&m.hasData()&&(y=T)}let x=y;for(;x.overscaledZ>n;)if(x=x.scaledTo(x.overscaledZ-1),t[x.key]){d[y.key]=y;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,d=Math.ceil(t.height/n)+1,p=Math.floor(c*d*5),m=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,m):m;this._cache.setMaxSize(y)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+n),c[p.tileID.key]=p}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,n,c,d,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const m=this._source.type==="batched-model";let y,x=this._source.maxzoom;const T=this.map&&this.map.painter?this.map.painter._terrain:null;if(T&&T.sourceCache===this&&T.attenuationRange()){const E=T.attenuationRange()[0],P=Math.floor(E)-Math.log2(T.getDemUpscale());x>P&&(x=P)}if(this.used||this.usedForTerrain){if(this._source.tileID)y=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((E=>new o.aP(E.canonical.z,E.wrap,E.canonical.z,E.canonical.x,E.canonical.y)));else if(this.tileCoverLift!==0){const E=t.clone();E.tileCoverLift=this.tileCoverLift,y=E.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:x,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.minzoom<=1&&t.projection.name==="globe"&&(y.push(new o.aP(1,0,1,0,0)),y.push(new o.aP(1,0,1,1,0)),y.push(new o.aP(1,0,1,0,1)),y.push(new o.aP(1,0,1,1,1)))}else if(y=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:x,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:m}),this._source.hasTile){const E=this._source.hasTile.bind(this._source);y=y.filter((P=>E(P)))}}else y=[];if(y.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Ta(this._source.type)){const E=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),P=Math.min(E,this._source.maxzoom);if(m){const D=t.extendTileCover(y,P);for(const O of D)y.push(O)}else if(p){const D=t.extendTileCoverToNearPlane(y,this.transform.getFrustum(P),P);for(const O of D)y.push(O)}else if(this.castsShadows&&d){const D=t.extendTileCover(y,P,d);for(const O of D)this._shadowCasterTiles[O.key]=!0,y.push(O)}}const S=this._updateRetainedTiles(y);if(Ta(this._source.type)&&y.length!==0){const E={},P={},D=Object.keys(S);for(const V of D){const N=S[V],j=this._tiles[V];if(!j||j.fadeEndTime&&j.fadeEndTime<=o.o.now())continue;const Z=this.findLoadedParent(N,Math.max(N.overscaledZ-Fs.maxOverzooming,this._source.minzoom));Z&&(this._addTile(Z.tileID),E[Z.tileID.key]=Z.tileID),P[V]=N}const O=y[y.length-1].overscaledZ;for(const V in this._tiles){const N=this._tiles[V];if(S[V]||!N.hasData())continue;let j=N.tileID;for(;j.overscaledZ>O;){j=j.scaledTo(j.overscaledZ-1);const Z=this._tiles[j.key];if(Z&&Z.hasData()&&P[j.key]){S[V]=N.tileID;break}}}for(const V in E)S[V]||(this._coveredTiles[V]=!0,S[V]=E[V])}for(const E in S)this._tiles[E].clearFadeHold();const M=o.bu(this._tiles,S);for(const E of M){const P=this._tiles[E];P.hasSymbolBuckets&&!P.holdingForFade()?P.setHoldDuration(this.map._fadeDuration):P.hasSymbolBuckets&&!P.symbolFadeFinished()||this._removeTile(+E)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(t.length===0)return n;const c={},d=t.reduce(((T,S)=>Math.min(T,S.overscaledZ)),1/0),p=t[0].overscaledZ,m=Math.max(p-Fs.maxOverzooming,this._source.minzoom),y=Math.max(p+Fs.maxUnderzooming,this._source.minzoom),x={};for(const T of t){const S=this._addTile(T);n[T.key]=T,S.hasData()||d<this._source.maxzoom&&(x[T.key]=T)}this._retainLoadedChildren(x,d,y,n);for(const T of t){let S=this._tiles[T.key];if(S.hasData())continue;if(T.canonical.z>=this._source.maxzoom){const E=T.children(this._source.maxzoom)[0],P=this.getTile(E);if(P&&P.hasData()){n[E.key]=E;continue}}else{const E=T.children(this._source.maxzoom);if(n[E[0].key]&&n[E[1].key]&&n[E[2].key]&&n[E[3].key])continue}let M=S.wasRequested();for(let E=T.overscaledZ-1;E>=m;--E){const P=T.scaledTo(E);if(c[P.key]||(c[P.key]=!0,S=this.getTile(P),!S&&M&&(S=this._addTile(P)),S&&(n[P.key]=P,M=S.wasRequested(),S.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(const p of n)this._loadedParentTiles[p]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();n=this._source.type==="raster-array"?new Ms(t,p,this.transform.tileZoom,d,this._isRaster):new qs(t,p,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n.uses++,this._tiles[t.key]=n,c||this._source.fire(new o.z("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const d=[],p=this.transform;if(!p)return d;const m=p.projection.name==="globe",y=o.aF(p.center.lng);for(const x in this._tiles){const T=this._tiles[x];if(c&&T.clearQueryDebugViz(),T.holdingForFade())continue;let S;if(m){const M=T.tileID.canonical;if(M.z===0){const E=[Math.abs(o.aA(y,...Sa(M,-1))-y),Math.abs(o.aA(y,...Sa(M,1))-y)];S=[0,2*E.indexOf(Math.min(...E))-1]}else{const E=[Math.abs(o.aA(y,...Sa(M,-1))-y),Math.abs(o.aA(y,...Sa(M,0))-y),Math.abs(o.aA(y,...Sa(M,1))-y)];S=[E.indexOf(Math.min(...E))-1]}}else S=[0];for(const M of S){const E=t.containsTile(T,p,n,M);E&&d.push(E)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map((p=>this._tiles[p].tileID)),d=this.transform.projection.name==="globe";for(const p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(const m of n){const y=1/(1<<m.canonical.z);p[m.key]=((m.canonical.x+.5)*y+m.wrap-c[0])*d[0]+((m.canonical.y+.5)*y-c[1])*d[1]-c[2]*d[2]}return n.sort(((m,y)=>p[m.key]-p[y.key])),n}hasTransition(){if(this._source.hasTransition())return!0;if(Ta(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=o.o.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter((c=>!c.hasDependency(t,n)))}_preloadTiles(t,n){if(!this._sourceLoaded){const x=()=>{this._sourceLoaded&&(this._source.off("data",x),this._preloadTiles(t,n))};return void this._source.on("data",x)}const c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,m=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(const x of d){const T=x.coveringTiles({tileSize:m,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const S of T)c.set(S.key,S);this.usedForTerrain&&x.updateElevation(!1)}const y=Array.from(c.values());o.bv(y,((x,T)=>{const S=new qs(x,this._source.tileSize*x.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(S,(M=>{this._source.type==="raster-dem"&&S.dem&&this._backfillDEM(S),T(M,S)}))}),n)}}function lh(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function Ta(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function Sa(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}Fs.maxOverzooming=10,Fs.maxUnderzooming=3;class ch{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:n});else if(d.type==="model"){const p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&n.visible,n.visible=d}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const d of this.layers){const p=d.layer,m=this.style.getLayerSourceCache(p);let y=1;p.type==="fill-extrusion"?y=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0:p.type==="building"&&(y=d.visible?p.paint.get("building-vertical-scale"):0);let x=m?m.getTile(n):null;if(!x&&m)for(const T in m._tiles){const S=m._tiles[T];if(n.canonical.isChildOf(S.tileID.canonical)){x=S;break}}this.currentBuildingBuckets.push({bucket:x?x.getBucket(p):null,tileID:x?x.tileID:n,verticalScale:y})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const p=t.symbolInstances.get(d),m=p.zOffset,y=this._getHeightAtTileOffset(n,p.tileAnchorX,p.tileAnchorY);p.zOffset=y!==Number.NEGATIVE_INFINITY?y:m,c||m===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,d){let p=n,m=c;if(t.canonical.z!==d.canonical.z){const y=d.canonical,x=1/(1<<t.canonical.z-y.z);p=(n+t.canonical.x*o.al)*x-y.x*o.al|0,m=(c+t.canonical.y*o.al)*x-y.y*o.al|0}return{tileX:p,tileY:m}}_getHeightAtTileOffset(t,n,c){let d,p;for(let m=0;m<this.layers.length;++m){const y=this.layers[m].layer;if(y.type!=="fill-extrusion"&&y.type!=="building")continue;const{bucket:x,tileID:T,verticalScale:S}=this.currentBuildingBuckets[m];if(!x)continue;const{tileX:M,tileY:E}=this._mapCoordToOverlappingTile(t,n,c,T),P=x.getHeightAtTileCoord(M,E);P&&P.height!==void 0&&(P.hidden?d=P.height:p=Math.max(P.height*S,p||0))}if(p!==void 0)return p;for(let m=0;m<this.layers.length;++m){const y=this.layers[m];if(y.layer.type!=="model"||!y.visible)continue;const{bucket:x,tileID:T}=this.currentBuildingBuckets[m];if(!x)continue;const{tileX:S,tileY:M}=this._mapCoordToOverlappingTile(t,n,c,T),E=x.getHeightAtTileCoord(S,M);if(E&&!E.hidden)return E.height===void 0&&d!==void 0?Math.min(E.maxHeight,d)*E.verticalScale:E.height?E.height*E.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Vl(l,t){const n={};for(const c in l)c!=="ref"&&(n[c]=l[c]);return o.bw.forEach((c=>{c in t&&(n[c]=t[c])})),n}function Za(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=Vl(l[n],t[l[n].ref]));return l}const Bi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function uh(l,t,n){n.push({command:Bi.addSource,args:[l,t[l]]})}function Ul(l,t,n){t.push({command:Bi.removeSource,args:[l]}),n[l]=!0}function jl(l,t,n,c){Ul(l,n,c),uh(l,t,n)}function hh(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&c!=="data"&&!o.bx(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&c!=="data"&&!o.bx(l[n][c],t[n][c]))return!1;return!0}function Gl(l,t,n,c,d,p){let m;for(m in t=t||{},l=l||{})l.hasOwnProperty(m)&&(o.bx(l[m],t[m])||n.push({command:p,args:[c,m,t[m],d]}));for(m in t)t.hasOwnProperty(m)&&!l.hasOwnProperty(m)&&(o.bx(l[m],t[m])||n.push({command:p,args:[c,m,t[m],d]}))}function Hl(l){return l.id}function ql(l,t){return l[t.id]=t,l}function Ea(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return o.aB(new Float32Array(16),l.projMatrix,c)}function vf(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),Ea(c,t.getProjection(),l)}function Oc(l,t,n){return t.name===n.projection.name?l.projMatrix:Ea(n,t,l)}class gm{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=o.aA(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const p=n-1,m=this._distances[p],y=c-m,x=y>0?(d-m)/y:0;return this.points[p].mult(1-x).add(this.points[n].mult(x))}}class $l{constructor(t,n,c){const d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let m=0;m<this.xCellCount*this.yCellCount;m++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,p){this._forEachCell(n,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,p,m){this.boxCells[p].push(m)}_insertCircleCell(t,n,c,d,p,m){this.circleCells[p].push(m)}_query(t,n,c,d,p,m){if(c<0||t>this.width||d<0||n>this.height)return!p&&[];const y=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let x=0;x<this.boxKeys.length;x++)y.push({key:this.boxKeys[x],x1:this.bboxes[4*x],y1:this.bboxes[4*x+1],x2:this.bboxes[4*x+2],y2:this.bboxes[4*x+3]});for(let x=0;x<this.circleKeys.length;x++){const T=this.circles[3*x],S=this.circles[3*x+1],M=this.circles[3*x+2];y.push({key:this.circleKeys[x],x1:T-M,y1:S-M,x2:T+M,y2:S+M})}return m?y.filter(m):y}return this._forEachCell(t,n,c,d,this._queryCell,y,{hitTest:p,seenUids:{box:{},circle:{}}},m),p?y.length>0:y}_queryCircle(t,n,c,d,p){const m=t-c,y=t+c,x=n-c,T=n+c;if(y<0||m>this.width||T<0||x>this.height)return!d&&[];const S=[];return this._forEachCell(m,x,y,T,this._queryCellCircle,S,{hitTest:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},p),d?S.length>0:S}query(t,n,c,d,p){return this._query(t,n,c,d,!1,p)}hitTest(t,n,c,d,p){return this._query(t,n,c,d,!0,p)}hitTestCircle(t,n,c,d){return this._queryCircle(t,n,c,!0,d)}_queryCell(t,n,c,d,p,m,y,x){const T=y.seenUids,S=this.boxCells[p];if(S!==null){const E=this.bboxes;for(const P of S)if(!T.box[P]){T.box[P]=!0;const D=4*P;if(t<=E[D+2]&&n<=E[D+3]&&c>=E[D+0]&&d>=E[D+1]&&(!x||x(this.boxKeys[P]))){if(y.hitTest)return m.push(!0),!0;m.push({key:this.boxKeys[P],x1:E[D],y1:E[D+1],x2:E[D+2],y2:E[D+3]})}}}const M=this.circleCells[p];if(M!==null){const E=this.circles;for(const P of M)if(!T.circle[P]){T.circle[P]=!0;const D=3*P;if(this._circleAndRectCollide(E[D],E[D+1],E[D+2],t,n,c,d)&&(!x||x(this.circleKeys[P]))){if(y.hitTest)return m.push(!0),!0;{const O=E[D],V=E[D+1],N=E[D+2];m.push({key:this.circleKeys[P],x1:O-N,y1:V-N,x2:O+N,y2:V+N})}}}}}_queryCellCircle(t,n,c,d,p,m,y,x){const T=y.circle,S=y.seenUids,M=this.boxCells[p];if(M!==null){const P=this.bboxes;for(const D of M)if(!S.box[D]){S.box[D]=!0;const O=4*D;if(this._circleAndRectCollide(T.x,T.y,T.radius,P[O+0],P[O+1],P[O+2],P[O+3])&&(!x||x(this.boxKeys[D])))return m.push(!0),!0}}const E=this.circleCells[p];if(E!==null){const P=this.circles;for(const D of E)if(!S.circle[D]){S.circle[D]=!0;const O=3*D;if(this._circlesCollide(P[O],P[O+1],P[O+2],T.x,T.y,T.radius)&&(!x||x(this.circleKeys[D])))return m.push(!0),!0}}}_forEachCell(t,n,c,d,p,m,y,x){const T=this._convertToXCellCoord(t),S=this._convertToYCellCoord(n),M=this._convertToXCellCoord(c),E=this._convertToYCellCoord(d);for(let P=T;P<=M;P++)for(let D=S;D<=E;D++)if(p.call(this,t,n,c,d,this.xCellCount*D+P,m,y,x))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,p,m){const y=d-t,x=p-n,T=c+m;return T*T>y*y+x*x}_circleAndRectCollide(t,n,c,d,p,m,y){const x=(m-d)/2,T=Math.abs(t-(d+x));if(T>x+c)return!1;const S=(y-p)/2,M=Math.abs(n-(p+S));if(M>S+c)return!1;if(T<=x||M<=S)return!0;const E=T-x,P=M-S;return E*E+P*P<=c*c}}const $s={unknown:0,flipRequired:1,flipNotRequired:2},Zl=Math.tan(85*Math.PI/180);function Wa(l,t,n,c,d,p,m){const y=o.bB();if(n)if(p.name==="globe"){const x=o.bC(d,t);o.aB(y,y,x)}else{const x=o.bD([],m);y[0]=x[0],y[1]=x[1],y[4]=x[2],y[5]=x[3],c||o.bA(y,y,d.angle)}else o.aB(y,d.labelPlaneMatrix,l);return y}function Wl(l,t,n,c,d,p,m){const y=Wa(l,t,n,c,d,p,m);return p.name==="globe"&&n||(y[2]=y[6]=y[10]=y[14]=0),y}function Vo(l,t,n,c,d,p,m){if(n){if(p.name==="globe"){const y=Wa(l,t,n,c,d,p,m);return o.bk(y,y),o.aB(y,l,y),y}{const y=o.by(l),x=o.bz([]);return x[0]=m[0],x[1]=m[1],x[4]=m[2],x[5]=m[3],o.aB(y,y,x),c||o.bA(y,y,-d.angle),y}}return d.glCoordMatrix}function An(l,t,n,c){const d=[l,t,n,1];n?o.aC(d,d,c):fo(d,d,c);const p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function dh(l,t){return Math.min(.5+l/t*.5,1.5)}function fh(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function ph(l,t,n,c,d,p,m,y,x,T,S=1){const M=n.transform,E=c?l.textSizeData:l.iconSizeData,P=o.bJ(E,n.transform.zoom,S),D=M.projection.name==="globe",O=[256/n.width*2+1,256/n.height*2+1],V=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;V.clear();let N=null;D&&(N=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const j=l.lineVertexArray,Z=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,H=n.transform.width/n.transform.height;let te,W=!1;for(let re=0;re<Z.length;re++){const ee=Z.get(re),{numGlyphs:K,writingMode:ne}=ee;if(ne!==o.bK.vertical||W||te===o.bK.horizontal||(W=!0),te=ne,(ee.hidden||ne===o.bK.vertical)&&!W){Uo(K,V);continue}W=!1;const _e=new o.P(ee.tileAnchorX,ee.tileAnchorY),fe=l.elevationType==="road",Me=!!M.elevation||fe;let{x:we,y:ze,z:Je}=M.projection.projectTilePoint(_e.x,_e.y,T.canonical),xe=null;if(Me){const ft=fe?l.getElevationFeatureForText(re):null;xe={getElevation:x,elevation:M.elevation,elevationFeature:ft};const[zt,pi,vi]=x(_e,M.elevation,ft);we+=zt,ze+=pi,Je+=vi}const ce=[we,ze,Je,1];if(o.aC(ce,ce,t),!fh(ce,O)){Uo(K,V);continue}const Le=ce[3],Te=dh(n.transform.getCameraToCenterDistance(M.projection),Le),je=o.bL(E,P,ee),rt=m?je/Te:je*Te,gt=An(we,ze,Je,d);if(gt[3]<=0){Uo(K,V);continue}let Xe={};const et=o.an(l.layers[0].layout.get("text-max-angle")),xt=Math.cos(et),dt=m?null:xe,ut=bf(ee,rt,!1,y,t,d,p,l.glyphOffsetArray,j,V,N,gt,_e,Xe,H,dt,M.projection,T,m,xt);W=ut.useVertical,dt&&ut.needsFlipping&&(Xe={}),(ut.notEnoughRoom||W||ut.needsFlipping&&bf(ee,rt,!0,y,t,d,p,l.glyphOffsetArray,j,V,N,gt,_e,Xe,H,dt,M.projection,T,m,xt).notEnoughRoom)&&Uo(K,V)}c?(l.text.dynamicLayoutVertexBuffer.updateData(V),N&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(N)):(l.icon.dynamicLayoutVertexBuffer.updateData(V),N&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(N))}function Gi(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V){const{lineStartIndex:N,glyphStartIndex:j,segment:Z}=y,H=j+y.numGlyphs,te=N+y.lineLength,W=t.getoffsetX(j),re=t.getoffsetX(H-1),ee=Xl(l*W,n,c,d,p,m,Z,N,te,x,T,S,M,E,!0,P,D,O,V);if(!ee)return null;const K=Xl(l*re,n,c,d,p,m,Z,N,te,x,T,S,M,E,!0,P,D,O,V);return K?{first:ee,last:K}:null}function mh(l,t,n,c){return l===o.bK.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===o.bK.vertical?c>0?{needsFlipping:!0}:null:t!==$s.unknown&&(function(d,p){return d===0||Math.abs(p/d)>Zl})(n,c)?t===$s.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function bf(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j,Z){const H=t/24,te=l.lineOffsetX*H,W=l.lineOffsetY*H,{lineStartIndex:re,glyphStartIndex:ee,numGlyphs:K,segment:ne,writingMode:_e,flipState:fe}=l,Me=re+l.lineLength,we=ze=>{if(S){const[Le,Te,je]=ze.up,rt=T.length;o.bM(S,rt+0,Le,Te,je),o.bM(S,rt+1,Le,Te,je),o.bM(S,rt+2,Le,Te,je),o.bM(S,rt+3,Le,Te,je)}const[Je,xe,ce]=ze.point;o.bN(T,Je,xe,ce,ze.angle)};if(K>1){const ze=Gi(H,y,te,W,n,M,E,l,x,p,P,O,!1,V,N,j,Z);if(!ze)return{notEnoughRoom:!0};if(c&&!n){let[Je,xe,ce]=ze.first.point,[Le,Te,je]=ze.last.point;[Je,xe]=An(Je,xe,ce,m),[Le,Te]=An(Le,Te,je,m);const rt=mh(_e,fe,(Le-Je)*D,Te-xe);if(l.flipState=rt&&rt.needsFlipping?$s.flipRequired:$s.flipNotRequired,rt)return rt}we(ze.first);for(let Je=ee+1;Je<ee+K-1;Je++){const xe=Xl(H*y.getoffsetX(Je),te,W,n,M,E,ne,re,Me,x,p,P,O,!1,!1,V,N,j,Z);if(!xe)return T.length-=4*(Je-ee),{notEnoughRoom:!0};we(xe)}we(ze.last)}else{if(c&&!n){const Je=An(E.x,E.y,0,d),xe=re+ne+1,ce=new o.P(x.getx(xe),x.gety(xe)),Le=An(ce.x,ce.y,0,d),Te=Le[3]>0?Le:Vt(E,ce,Je,1,d,void 0,V,N.canonical),je=mh(_e,fe,(Te[0]-Je[0])*D,Te[1]-Je[1]);if(l.flipState=je&&je.needsFlipping?$s.flipRequired:$s.flipNotRequired,je)return je}const ze=Xl(H*y.getoffsetX(ee),te,W,n,M,E,ne,re,Me,x,p,P,O,!1,!1,V,N,j,Z);if(!ze)return{notEnoughRoom:!0};we(ze)}return{}}function wf(l,t,n,c,d){const{x:p,y:m,z:y}=c.projectTilePoint(l.x,l.y,t);if(!d)return An(p,m,y,n);const[x,T,S]=d.getElevation(l,d.elevation,d.elevationFeature);return An(p+x,m+T,y+S,n)}function Vt(l,t,n,c,d,p,m,y){const x=wf(l.sub(t)._unit()._add(l),y,d,m,p);return o.av(x,n,x),o.aw(x,x),o.bG(x,n,x,c)}function Xl(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j){const Z=c?l-t:l+t;let H=Z>0?1:-1,te=0;c&&(H*=-1,te=Math.PI),H<0&&(te+=Math.PI);let W=y+m+(H>0?0:1)|0,re=d,ee=d,K=0,ne=0;const _e=Math.abs(Z),fe=[],Me=[];let we=p,ze=we,Je=o.bE([]);const xe=()=>Vt(ze,we,ee,_e-K+1,S,E,O,V.canonical);for(;K+ne<=_e;){if(W+=H,W<y||W>=x)return null;if(ee=re,ze=we,fe.push(ee),P&&Me.push(ze),we=new o.P(T.getx(W),T.gety(W)),re=M[W],!re){const dt=wf(we,V.canonical,S,O,E);re=dt[3]>0?M[W]=dt:xe()}K+=ne;const et=o.av([],re,ee),xt=o.bF(ee,re);if(n&&xt>0&&ne>0&&o.bI(Je,et)/(ne*xt)<j)return null;ne=xt,Je=et}D&&E&&(M[W]&&(re=xe(),ne=o.bF(ee,re),Je=o.av([],re,ee)),M[W]=re);const ce=(_e-K)/ne,Le=we.sub(ze)._mult(ce)._add(ze),Te=o.bG([],ee,Je,ce);let je=[0,0,1],rt=Je[0],gt=Je[1];if(N&&(je=O.upVector(V.canonical,Le.x,Le.y),je[0]!==0||je[1]!==0||je[2]!==1)){const et=[je[2],0,-je[0]],xt=o.bH([],je,et);o.aw(et,et),o.aw(xt,xt),rt=o.bI(Je,et),gt=o.bI(Je,xt)}if(n){const et=o.bH([],je,Je);o.aw(et,et),o.bG(Te,Te,et,n*H)}const Xe=te+Math.atan2(gt,rt);return fe.push(Te),P&&Me.push(Le),{point:Te,angle:Xe,path:fe,tilePath:Me,up:je}}function Uo(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function fo(l,t,n){const c=t[0],d=t[1];return l[0]=n[0]*c+n[4]*d+n[12],l[1]=n[1]*c+n[5]*d+n[13],l[3]=n[3]*c+n[7]*d+n[15],l}const po=100;class Xa{constructor(t,n,c=new $l(t.width+200,t.height+200,25),d=new $l(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+po,this.screenBottomBoundary=t.height+po,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,d,p,m,y,x,T,S,M){let E=c.projectedAnchorX,P=c.projectedAnchorY,D=c.projectedAnchorZ;const O=c.tileAnchorX,V=c.tileAnchorY,N=c.elevation,j=c.tileID,Z=t.getProjection();if(N&&j){const[Me,we,ze]=Z.upVector(j.canonical,c.tileAnchorX,c.tileAnchorY),Je=Z.upVectorScale(j.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;E+=Me*N*Je,P+=we*N*Je,D+=ze*N*Je}const H=t.projection.name==="globe",te=t.projection.name==="globe"?o.aj(this.transform.zoom):0;if(j&&H&&te<1&&!m){const Me=1<<j.canonical.z,we=o.bO(O,V);o.bP(we,we,1/o.al),o.bQ(we,we,o.bO(j.canonical.x,j.canonical.y)),o.bP(we,we,1/Me),o.bR(we,we,o.bO(d[0],d[1])),we[0]=o.bS(we[0],-.5,.5),o.bP(we,we,o.al);const ze=o.bT(we[0],we[1],o.al/(2*Math.PI),1);o.aC(ze,ze,p),E=o.ak(E,ze[0],te),P=o.ak(P,ze[1],te),D=o.ak(D,ze[2],te)}const W=this.projectAndGetPerspectiveRatio(S,E,P,D,c.tileID,Z.name==="globe"||!!N||this.transform.pitch>0,Z),re=T*W.perspectiveRatio,ee=(c.x1*n+y.x-c.padding)*re+W.point.x,K=(c.y1*n+y.y-c.padding)*re+W.point.y,ne=(c.x2*n+y.x+c.padding)*re+W.point.x,_e=(c.y2*n+y.y+c.padding)*re+W.point.y,fe=W.perspectiveRatio<=.55||W.occluded;return!this.isInsideGrid(ee,K,ne,_e)||!x&&this.grid.hitTest(ee,K,ne,_e,M)||fe?{box:[],offscreen:!1,occluded:W.occluded}:{box:[ee,K,ne,_e],offscreen:this.isOffscreen(ee,K,ne,_e),occluded:!1}}placeCollisionCircles(t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V){const N=[],j=this.transform.elevation,Z=t.getProjection(),H=t.elevationType==="road",te=!!j||H,W=o.bU.getAtTileOffsetFunc(V,this.transform.center.lat,this.transform.worldSize,Z),re=new o.P(c.tileAnchorX,c.tileAnchorY),ee=new o.P(c.tileAnchorX,c.tileAnchorY);let{x:K,y:ne,z:_e}=Z.projectTilePoint(ee.x,ee.y,V.canonical),fe=null;if(te){const xt=H?t.getElevationFeatureForText(d):null;fe={getElevation:W,elevation:j,elevationFeature:xt};const[dt,ut,ft]=W(re,j,xt);K+=dt,ne+=ut,_e+=ft}const Me=Z.name==="globe",we=this.projectAndGetPerspectiveRatio(x,K,ne,_e,V,Me||!!j||this.transform.pitch>0,Z),{perspectiveRatio:ze}=we,Je=(E?y/ze:y*ze)/o.bX,xe=An(K,ne,_e,T),ce=c.lineOffsetX*Je,Le=c.lineOffsetY*Je,Te=o.an(t.layers[0].layout.get("text-max-angle")),je=Math.cos(Te),rt=we.signedDistanceFromCamera>0?Gi(Je,m,ce,Le,H&&c.flipState===1,xe,ee,c,p,T,{},te&&!E?fe:null,E&&te,Z,V,E,je):null;let gt=!1,Xe=!1,et=!0;if(rt&&!we.occluded){const xt=.5*D*ze+O,dt=new o.P(-100,-100),ut=new o.P(this.screenRightBoundary,this.screenBottomBoundary),ft=new gm,{first:zt,last:pi}=rt,vi=zt.path.length;let tr=[];for(let ti=vi-1;ti>=1;ti--)tr.push(zt.path[ti]);for(let ti=1;ti<pi.path.length;ti++)tr.push(pi.path[ti]);const Gt=2.5*xt;S&&(tr=tr.map((([ti,Zi,bi],cr)=>(te&&!Me&&(bi=W(cr<vi-1?zt.tilePath[vi-1-cr]:pi.tilePath[cr-vi+2],j,fe.elevationFeature)[2]),An(ti,Zi,bi,S)))),tr.some((ti=>ti[3]<=0))&&(tr=[]));let xi=[];if(tr.length>0){let ti=1/0,Zi=-1/0,bi=1/0,cr=-1/0;for(const Pi of tr)ti=Math.min(ti,Pi[0]),bi=Math.min(bi,Pi[1]),Zi=Math.max(Zi,Pi[0]),cr=Math.max(cr,Pi[1]);Zi>=dt.x&&ti<=ut.x&&cr>=dt.y&&bi<=ut.y&&(xi=[tr.map((Pi=>new o.P(Pi[0],Pi[1])))],(ti<dt.x||Zi>ut.x||bi<dt.y||cr>ut.y)&&(xi=o.bV(xi,dt.x,dt.y,ut.x,ut.y)))}for(const ti of xi){ft.reset(ti,.25*xt);let Zi=0;Zi=ft.length<=.5*xt?1:Math.ceil(ft.paddedLength/Gt)+1;for(let bi=0;bi<Zi;bi++){const cr=bi/Math.max(Zi-1,1),Pi=ft.lerp(cr),ii=Pi.x+po,Ni=Pi.y+po;N.push(ii,Ni,xt,0);const si=ii-xt,br=Ni-xt,Ui=ii+xt,qt=Ni+xt;if(et=et&&this.isOffscreen(si,br,Ui,qt),Xe=Xe||this.isInsideGrid(si,br,Ui,qt),!n&&this.grid.hitTestCircle(ii,Ni,xt,P)&&(gt=!0,!M))return{circles:[],offscreen:!1,collisionDetected:gt,occluded:!1}}}}return{circles:!M&&gt||!Xe?[]:N,offscreen:et,collisionDetected:gt,occluded:we.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,p=-1/0,m=-1/0;for(const S of t){const M=new o.P(S.x+po,S.y+po);c=Math.min(c,M.x),d=Math.min(d,M.y),p=Math.max(p,M.x),m=Math.max(m,M.y),n.push(M)}const y=this.grid.query(c,d,p,m).concat(this.ignoredGrid.query(c,d,p,m)),x={},T={};for(const S of y){const M=S.key;if(x[M.bucketInstanceId]===void 0&&(x[M.bucketInstanceId]={}),x[M.bucketInstanceId][M.featureIndex])continue;const E=[new o.P(S.x1,S.y1),new o.P(S.x2,S.y1),new o.P(S.x2,S.y2),new o.P(S.x1,S.y2)];o.bW(n,E)&&(x[M.bucketInstanceId][M.featureIndex]=!0,T[M.bucketInstanceId]===void 0&&(T[M.bucketInstanceId]=[]),T[M.bucketInstanceId].push(M.featureIndex))}return T}insertCollisionBox(t,n,c,d,p){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,p){const m=n?this.ignoredGrid:this.grid,y={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let x=0;x<t.length;x+=4)m.insertCircle(y,t[x],t[x+1],t[x+2])}projectAndGetPerspectiveRatio(t,n,c,d,p,m,y){const x=[n,c,d,1];let T=!1;d||this.transform.pitch>0?(o.aC(x,x,t),this.fogState&&p&&y.name!=="globe"&&(T=(function(E,P,D,O,V,N){const j=N.calculateFogTileMatrix(V),Z=[P,D,O];return o.af(Z,Z,j),Ze(E,o.ag(Z),N.pitch,N._fov)})(this.fogState,n,c,d,p.toUnwrapped(),this.transform)>.9)):fo(x,x,t);const S=x[3];return{point:new o.P((x[0]/S+1)/2*this.transform.width+po,(-x[1]/S+1)/2*this.transform.height+po),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(y)/S*.5,1.5),signedDistanceFromCamera:S,occluded:m&&x[2]>S||T}}isOffscreen(t,n,c,d){return c<po||t>=this.screenRightBoundary||d<po||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=o.bz([]);return o.bq(t,t,[-100,-100,0]),t}}class At{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Ci{constructor(t,n,c,d,p,m=!1){this.text=new At(t?t.text:null,n,c,p),this.icon=new At(t?t.icon:null,n,d,p),this.clipped=m}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Vi{constructor(t,n,c,d=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=d}}class Bs{constructor(){this.invProjMatrix=o.bB(),this.viewportMatrix=o.bB(),this.circles=[]}}class Ya{constructor(t,n,c,d,p){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class $i{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function Yl(l,t,n,c,d){const{horizontalAlign:p,verticalAlign:m}=o.c0(l),y=-(p-.5)*t,x=-(m-.5)*n,T=o.c1(l,c);return new o.P(y+T[0]*d,x+T[1]*d)}function Ia(l,t,n,c,d){const p=new o.P(l,t);return n&&p._rotate(c?d:-d),p}class Kl{constructor(t,n,c,d,p,m){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Xa(this.transform,p),this.buildingIndex=m,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new $i(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,d,p=1){const m=c.getBucket(n),y=c.latestFeatureIndex;if(!m||!y||n.fqid!==m.layerIds[0])return;const x=m.layers[0].layout,T=m.layers[0].paint,S=c.collisionBoxArray,M=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),E=c.tileSize/o.al,P=c.tileID.toUnwrapped();this.transform.setProjection(m.projection);const D=(O=c.tileID,V=m.getProjection(),N=this.transform,V.name===this.projection?N.calculateProjMatrix(O.toUnwrapped()):Ea(N,V,O));var O,V,N;const j=x.get("text-pitch-alignment")==="map",Z=x.get("text-rotation-alignment")==="map";n.compileFilter(n.options);const H=n.dynamicFilter(),te=n.dynamicFilterNeedsFeature(),W=this.transform.calculatePixelsToTileUnitsMatrix(c),re=Wl(D,c.tileID.canonical,j,Z,this.transform,m.getProjection(),W);let ee=null;const K=m.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(j){const ce=Vo(D,c.tileID.canonical,j,Z,this.transform,m.getProjection(),W);ee=o.aB([],this.transform.labelPlaneMatrix,ce)}let ne=null;H&&c.latestFeatureIndex&&(ne={unwrappedTileID:P,dynamicFilter:H,dynamicFilterNeedsFeature:te}),this.retainedQueryData[m.bucketInstanceId]=new Ya(m.bucketInstanceId,y,m.sourceLayerIndex,m.index,c.tileID);const[_e,fe]=m.layers[0].layout.get("text-size-scale-range"),Me=o.aA(p,_e,fe),[we,ze]=x.get("icon-size-scale-range"),Je=o.aA(p,we,ze),xe={bucket:m,layout:x,paint:T,posMatrix:D,invMatrix:K,mercatorCenter:[o.aF(this.transform.center.lng),o.aJ(this.transform.center.lat)],textLabelPlaneMatrix:re,labelToScreenMatrix:ee,clippingData:ne,scale:M,textPixelRatio:E,holdingForFade:c.holdingForFade(),collisionBoxArray:S,partiallyEvaluatedTextSize:o.bJ(m.textSizeData,this.transform.zoom,Me),partiallyEvaluatedIconSize:o.bJ(m.iconSizeData,this.transform.zoom,Je),collisionGroup:this.collisionGroups.get(m.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const ce of m.sortKeyRanges){const{sortKey:Le,symbolInstanceStart:Te,symbolInstanceEnd:je}=ce;t.push({sortKey:Le,symbolInstanceStart:Te,symbolInstanceEnd:je,parameters:xe})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:m.symbolInstances.length,parameters:xe})}attemptAnchorPlacement(t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j,Z,H,te){const{textOffset0:W,textOffset1:re,crossTileID:ee}=O,K=[W,re],ne=Yl(t,m,y,K,x),_e=this.collisionIndex.placeCollisionBox(N,x,n,c,d,p,Ia(ne.x,ne.y,T,S,this.transform.angle),D,M,E,P.predicate);if(Z){const fe=N.getSymbolInstanceIconSize(te,this.transform.zoom,O.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(N,fe,Z,c,d,p,Ia(ne.x,ne.y,T,S,this.transform.angle),D,M,E,P.predicate).box.length===0)return}if(_e.box.length>0){let fe;return this.prevPlacement&&this.prevPlacement.variableOffsets[ee]&&this.prevPlacement.placements[ee]&&this.prevPlacement.placements[ee].text&&(fe=this.prevPlacement.variableOffsets[ee].anchor),this.variableOffsets[ee]={textOffset:K,width:m,height:y,anchor:t,textScale:x,prevAnchor:fe},this.markUsedJustification(N,t,O,j),N.allowVerticalPlacement&&(this.markUsedOrientation(N,j,O),this.placedOrientations[ee]=j),{shift:ne,placedGlyphBoxes:_e}}}placeLayerBucketPart(t,n,c,d,p=1){const{bucket:m,layout:y,paint:x,posMatrix:T,textLabelPlaneMatrix:S,labelToScreenMatrix:M,clippingData:E,textPixelRatio:P,mercatorCenter:D,invMatrix:O,holdingForFade:V,collisionBoxArray:N,partiallyEvaluatedTextSize:j,partiallyEvaluatedIconSize:Z,collisionGroup:H,latestFeatureIndex:te}=t.parameters,W=y.get("text-optional"),re=y.get("icon-optional"),ee=y.get("text-allow-overlap"),K=y.get("icon-allow-overlap"),ne=y.get("text-rotation-alignment")==="map",_e=y.get("icon-rotation-alignment")==="map",fe=y.get("text-pitch-alignment")==="map",Me=x.get("symbol-z-offset"),we=y.get("symbol-elevation-reference")==="sea",ze=y.get("symbol-placement"),[Je,xe]=y.get("text-size-scale-range"),[ce,Le]=y.get("icon-size-scale-range"),Te=o.aA(p,Je,xe),je=o.aA(p,ce,Le),rt=y.get("text-variable-anchor"),gt=ne&&ze!=="point",Xe=_e&&ze!=="point",et=rt&&m.hasTextData(),xt=m.hasIconTextFit()&&et&&m.hasIconData();this.transform.setProjection(m.projection);const dt=et||gt,ut=Xe||xt;let ft=ee&&(K||!m.hasIconData()||re),zt=K&&(ee||!m.hasTextData()||W);const pi=!Me.isConstant();!m.collisionArrays&&N&&m.deserializeCollisionBoxes(N),c&&d&&m.updateCollisionDebugBuffers(this.transform.zoom,N,Te,je);const vi=(Gt,xi,ti)=>{const{crossTileID:Zi,numVerticalGlyphVertices:bi}=Gt;let cr=null;if(E&&E.dynamicFilterNeedsFeature||pi){const Gr=this.retainedQueryData[m.bucketInstanceId];cr=te.loadFeature({featureIndex:Gt.featureIndex,bucketIndex:Gr.bucketIndex,sourceLayerIndex:Gr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(E&&!(0,E.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:m.worldview},cr,this.retainedQueryData[m.bucketInstanceId].tileID.canonical,new o.P(Gt.tileAnchorX,Gt.tileAnchorY),this.transform.calculateDistanceTileData(E.unwrappedTileID)))return this.placements[Zi]=new Vi(!1,!1,!1,!0),void n.add(Zi);const Pi=Me.evaluate(cr,{});if(n.has(Zi))return;if(V)return void(this.placements[Zi]=new Vi(!1,!1,!1));let ii=!1,Ni=!1,si=!0,br=!1,Ui=!1,qt=null,Ti={box:null,offscreen:null,occluded:null},Or={box:null},tn=null,Ur=null,Zr=null,Ds=0,ws=0,ts=0;ti.textFeatureIndex?Ds=ti.textFeatureIndex:Gt.useRuntimeCollisionCircles&&(Ds=Gt.featureIndex),ti.verticalTextFeatureIndex&&(ws=ti.verticalTextFeatureIndex);const cs=m.elevationFeatures?m.elevationFeatures[Gt.elevationFeatureIndex]:void 0,Ks=Gr=>{Gr.tileID=this.retainedQueryData[m.bucketInstanceId].tileID;const rn=this.transform.elevation;Gr.elevation=we?Pi:Pi+o.bU.getAtTileOffset(Gr.tileID,new o.P(Gr.tileAnchorX,Gr.tileAnchorY),rn,cs),Gr.elevation+=Gt.zOffset},is=ti.textBox;if(is){Ks(is);const Gr=or=>{let an=o.bK.horizontal;if(m.allowVerticalPlacement&&!or&&this.prevPlacement){const Bn=this.prevPlacement.placedOrientations[Zi];Bn&&(this.placedOrientations[Zi]=Bn,an=Bn,this.markUsedOrientation(m,an,Gt))}return an},rn=(or,an)=>{if(m.allowVerticalPlacement&&bi>0&&ti.verticalTextBox){for(const Bn of m.writingModes)if(Bn===o.bK.vertical?(Ti=an(),Or=Ti):Ti=or(),Ti&&Ti.box&&Ti.box.length)break}else Ti=or()};if(rt){let or=rt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Zi]){const Hr=this.prevPlacement.variableOffsets[Zi];or.indexOf(Hr.anchor)>0&&(or=or.filter((Qs=>Qs!==Hr.anchor)),or.unshift(Hr.anchor))}const an=(Hr,Qs,Al)=>{const Ko=m.getSymbolInstanceTextSize(j,Gt,this.transform.zoom,xi),Ml=(Hr.x2-Hr.x1)*Ko+2*Hr.padding,Cl=(Hr.y2-Hr.y1)*Ko+2*Hr.padding,eo=Gt.hasIconTextFit&&!K?Qs:null;eo&&Ks(eo);let Fo={box:[],offscreen:!1,occluded:!1};const Rn=ee?2*or.length:or.length;for(let to=0;to<Rn;++to){const Va=this.attemptAnchorPlacement(or[to%or.length],Hr,D,O,dt,Ml,Cl,Ko,ne,fe,P,T,H,to>=or.length,Gt,xi,m,Al,eo,j,Z);if(Va&&(Fo=Va.placedGlyphBoxes,Fo&&Fo.box&&Fo.box.length)){ii=!0,qt=Va.shift;break}}return Fo};rn((()=>an(is,ti.iconBox,o.bK.horizontal)),(()=>{const Hr=ti.verticalTextBox;return Hr&&Ks(Hr),m.allowVerticalPlacement&&!(Ti&&Ti.box&&Ti.box.length)&&bi>0&&Hr?an(Hr,ti.verticalIconBox,o.bK.vertical):{box:null,offscreen:null,occluded:null}})),Ti&&(ii=Ti.box,si=Ti.offscreen,br=Ti.occluded);const Bn=Gr(!(!Ti||!Ti.box));if(!ii&&this.prevPlacement){const Hr=this.prevPlacement.variableOffsets[Zi];Hr&&(this.variableOffsets[Zi]=Hr,this.markUsedJustification(m,Hr.anchor,Gt,Bn))}}else{const or=(an,Bn)=>{const Hr=m.getSymbolInstanceTextSize(j,Gt,this.transform.zoom,xi),Qs=this.collisionIndex.placeCollisionBox(m,Hr,an,D,O,dt,new o.P(0,0),ee,P,T,H.predicate);return Qs&&Qs.box&&Qs.box.length&&(this.markUsedOrientation(m,Bn,Gt),this.placedOrientations[Zi]=Bn),Qs};rn((()=>or(is,o.bK.horizontal)),(()=>{const an=ti.verticalTextBox;return m.allowVerticalPlacement&&bi>0&&an?(Ks(an),or(an,o.bK.vertical)):{box:null,offscreen:null,occluded:null}})),Gr(!!(Ti&&Ti.box&&Ti.box.length))}}if(tn=Ti,ii=tn&&tn.box&&tn.box.length>0,si=tn&&tn.offscreen,br=tn&&tn.occluded,Gt.useRuntimeCollisionCircles){const Gr=Gt.centerJustifiedTextSymbolIndex>=0?Gt.centerJustifiedTextSymbolIndex:Gt.verticalPlacedTextSymbolIndex,rn=m.text.placedSymbolArray.get(Gr),or=o.bL(m.textSizeData,j,rn),an=y.get("text-padding");Ur=this.collisionIndex.placeCollisionCircles(m,ee,rn,Gr,m.lineVertexArray,m.glyphOffsetArray,or,T,S,M,c,fe,H.predicate,Gt.collisionCircleDiameter*or/o.bX,an,this.retainedQueryData[m.bucketInstanceId].tileID),ii=ee||Ur.circles.length>0&&!Ur.collisionDetected,si=si&&Ur.offscreen,br=Ur.occluded}if(ti.iconFeatureIndex&&(ts=ti.iconFeatureIndex),ti.iconBox){const Gr=rn=>{Ks(rn);const or=Gt.hasIconTextFit&&qt?Ia(qt.x,qt.y,ne,fe,this.transform.angle):new o.P(0,0),an=m.getSymbolInstanceIconSize(Z,this.transform.zoom,Gt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(m,an,rn,D,O,ut,or,K,P,T,H.predicate)};Or&&Or.box&&Or.box.length&&ti.verticalIconBox?(Zr=Gr(ti.verticalIconBox),Ni=Zr.box.length>0):(Zr=Gr(ti.iconBox),Ni=Zr.box.length>0),si=si&&Zr.offscreen,Ui=Zr.occluded}const Js=W||Gt.numHorizontalGlyphVertices===0&&bi===0,bo=re||Gt.numIconVertices===0;if(Js||bo?bo?Js||(Ni=Ni&&ii):ii=Ni&&ii:Ni=ii=Ni&&ii,ii&&tn&&tn.box&&this.collisionIndex.insertCollisionBox(tn.box,y.get("text-ignore-placement"),m.bucketInstanceId,Or&&Or.box&&ws?ws:Ds,H.ID),Ni&&Zr&&this.collisionIndex.insertCollisionBox(Zr.box,y.get("icon-ignore-placement"),m.bucketInstanceId,ts,H.ID),Ur&&(ii&&this.collisionIndex.insertCollisionCircles(Ur.circles,y.get("text-ignore-placement"),m.bucketInstanceId,Ds,H.ID),c)){const Gr=m.bucketInstanceId;let rn=this.collisionCircleArrays[Gr];rn===void 0&&(rn=this.collisionCircleArrays[Gr]=new Bs);for(let or=0;or<Ur.circles.length;or+=4)rn.circles.push(Ur.circles[or+0]),rn.circles.push(Ur.circles[or+1]),rn.circles.push(Ur.circles[or+2]),rn.circles.push(Ur.collisionDetected?1:0)}const Fn=m.projection.name!=="globe";ft=ft&&(Fn||!br),zt=zt&&(Fn||!Ui),this.placements[Zi]=new Vi(ii||ft,Ni||zt,si||m.justReloaded),n.add(Zi)},tr=this.retainedQueryData[m.bucketInstanceId].tileID;if(m.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(m,tr),m.elevationType==="road"&&m.updateRoadElevation(tr.canonical),m.updateZOffset(),m.sortFeaturesByY){const Gt=m.getSortedSymbolIndexes(this.transform.angle);for(let xi=Gt.length-1;xi>=0;--xi){const ti=Gt[xi];vi(m.symbolInstances.get(ti),ti,m.collisionArrays[ti])}m.hasAnyZOffset&&o.w("".concat(m.layerIds[0]," layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y"))}else if(m.hasAnyZOffset){const Gt=m.getSortedIndexesByZOffset();for(let xi=0;xi<Gt.length;++xi){const ti=Gt[xi];vi(m.symbolInstances.get(ti),ti,m.collisionArrays[ti])}}else for(let Gt=t.symbolInstanceStart;Gt<t.symbolInstanceEnd;Gt++)vi(m.symbolInstances.get(Gt),Gt,m.collisionArrays[Gt]);if(c&&m.bucketInstanceId in this.collisionCircleArrays){const Gt=this.collisionCircleArrays[m.bucketInstanceId];o.bk(Gt.invProjMatrix,T),Gt.viewportMatrix=this.collisionIndex.getViewportMatrix()}m.justReloaded=!1}markUsedJustification(t,n,c,d){const{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:m,rightJustifiedTextSymbolIndex:y,verticalPlacedTextSymbolIndex:x,crossTileID:T}=c,S=o.c2(n),M=d===o.bK.vertical?x:S==="left"?p:S==="center"?m:S==="right"?y:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=M>=0&&p!==M?0:T),m>=0&&(t.text.placedSymbolArray.get(m).crossTileID=M>=0&&m!==M?0:T),y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=M>=0&&y!==M?0:T),x>=0&&(t.text.placedSymbolArray.get(x).crossTileID=M>=0&&x!==M?0:T)}markUsedOrientation(t,n,c){const d=n===o.bK.horizontal||n===o.bK.horizontalOnly?n:0,p=n===o.bK.vertical?n:0,{leftJustifiedTextSymbolIndex:m,centerJustifiedTextSymbolIndex:y,rightJustifiedTextSymbolIndex:x,verticalPlacedTextSymbolIndex:T}=c,S=t.text.placedSymbolArray;m>=0&&(S.get(m).placedOrientation=d),y>=0&&(S.get(y).placedOrientation=d),x>=0&&(S.get(x).placedOrientation=d),T>=0&&(S.get(T).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,p=n?n.opacities:{},m=n?n.variableOffsets:{},y=n?n.placedOrientations:{};for(const x in this.placements){const T=this.placements[x],S=p[x];S?(this.opacities[x]=new Ci(S,d,T.text,T.icon,null,T.clipped),c=c||T.text!==S.text.placed||T.icon!==S.icon.placed):(this.opacities[x]=new Ci(null,d,T.text,T.icon,T.skipFade,T.clipped),c=c||T.text||T.icon)}for(const x in p){const T=p[x];if(!this.opacities[x]){const S=new Ci(T,d,!1,!1);S.isHidden()||(this.opacities[x]=S,c=c||T.text.placed||T.icon.placed)}}for(const x in m)this.variableOffsets[x]||!this.opacities[x]||this.opacities[x].isHidden()||(this.variableOffsets[x]=m[x]);for(const x in y)this.placedOrientations[x]||!this.opacities[x]||this.opacities[x].isHidden()||(this.placedOrientations[x]=y[x]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,d){const p=new Set;for(const m of n){const y=m.getBucket(t);y&&m.latestFeatureIndex&&t.fqid===y.layerIds[0]&&(this.updateBucketOpacities(y,p,m,m.collisionBoxArray,c,d,m.tileID,t.scope),y.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(y,m.tileID),y.elevationType==="road"&&y.updateRoadElevation(m.tileID.canonical),y.updateZOffset())}}updateBucketOpacities(t,n,c,d,p,m,y,x){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const T=t.layers[0].layout,S=t.layers[0].paint,M=!!t.layers[0].dynamicFilter(),E=new Ci(null,0,!1,!1,!0),P=T.get("text-allow-overlap"),D=T.get("icon-allow-overlap"),O=T.get("text-variable-anchor"),V=T.get("text-rotation-alignment")==="map",N=T.get("text-pitch-alignment")==="map",j=S.get("symbol-z-offset"),Z=T.get("symbol-elevation-reference")==="sea",H=!j.isConstant(),te=new Ci(null,0,P&&(D||!t.hasIconData()||T.get("icon-optional")),D&&(P||!t.hasTextData()||T.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const W=(ee,K,ne)=>{for(let _e=0;_e<K/4;_e++)ee.opacityVertexArray.emplaceBack(ne)};let re=0;m&&t.updateReplacement(y,m);for(let ee=0;ee<t.symbolInstances.length;ee++){const K=t.symbolInstances.get(ee),{numHorizontalGlyphVertices:ne,numVerticalGlyphVertices:_e,crossTileID:fe,numIconVertices:Me,tileAnchorX:we,tileAnchorY:ze}=K;let Je=null;const xe=this.retainedQueryData[t.bucketInstanceId];H&&K&&xe&&(Je=c.latestFeatureIndex.loadFeature({featureIndex:K.featureIndex,bucketIndex:xe.bucketIndex,sourceLayerIndex:xe.sourceLayerIndex,layoutVertexArrayOffset:0}));const ce=j.evaluate(Je,{}),Le=n.has(fe);let Te=this.opacities[fe];Le?Te=E:Te||(Te=te,this.opacities[fe]=Te),n.add(fe);const je=ne>0||_e>0,rt=Me>0,gt=this.placedOrientations[fe],Xe=gt===o.bK.vertical,et=gt===o.bK.horizontal||gt===o.bK.horizontalOnly;!je&&!rt||Te.isHidden()||re++;let xt=!1;if((je||rt)&&m)for(const dt of t.activeReplacements){if(o.bY(dt,p,o.bZ.Symbol,x)||dt.min.x>we||we>dt.max.x||dt.min.y>ze||ze>dt.max.y)continue;const ut=o.b_(we,ze,y.canonical,dt.footprintTileId.canonical);if(xt=o.b$(ut,dt.footprint),xt)break}if(je){const dt=xt?kn:ec(Te.text);W(t.text,ne,Xe?kn:dt),W(t.text,_e,et?kn:dt);const ut=Te.text.isHidden(),{leftJustifiedTextSymbolIndex:ft,centerJustifiedTextSymbolIndex:zt,rightJustifiedTextSymbolIndex:pi,verticalPlacedTextSymbolIndex:vi}=K,tr=t.text.placedSymbolArray,Gt=ut||Xe?1:0;ft>=0&&(tr.get(ft).hidden=Gt),zt>=0&&(tr.get(zt).hidden=Gt),pi>=0&&(tr.get(pi).hidden=Gt),vi>=0&&(tr.get(vi).hidden=ut||et?1:0);const xi=this.variableOffsets[fe];xi&&this.markUsedJustification(t,xi.anchor,K,gt);const ti=this.placedOrientations[fe];ti&&(this.markUsedJustification(t,"left",K,ti),this.markUsedOrientation(t,ti,K))}if(rt){const dt=xt?kn:ec(Te.icon),{placedIconSymbolIndex:ut,verticalPlacedIconSymbolIndex:ft}=K,zt=t.icon.placedSymbolArray,pi=Te.icon.isHidden()?1:0;ut>=0&&(W(t.icon,Me,Xe?kn:dt),zt.get(ut).hidden=pi),ft>=0&&(W(t.icon,K.numVerticalIconVertices,et?kn:dt),zt.get(ft).hidden=pi)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const dt=t.collisionArrays[ee];if(dt){let ut=new o.P(0,0),ft=!0;if(dt.textBox||dt.verticalTextBox){if(O){const pi=this.variableOffsets[fe];pi?(ut=Yl(pi.anchor,pi.width,pi.height,pi.textOffset,pi.textScale),V&&ut._rotate(N?this.transform.angle:-this.transform.angle)):ft=!1}M&&(ft=!Te.clipped),dt.textBox&&Hn(t.textCollisionBox.collisionVertexArray,Te.text.placed,!ft||Xe,ce,Z,ut.x,ut.y),dt.verticalTextBox&&Hn(t.textCollisionBox.collisionVertexArray,Te.text.placed,!ft||et,ce,Z,ut.x,ut.y)}const zt=ft&&!!(!et&&dt.verticalIconBox);dt.iconBox&&Hn(t.iconCollisionBox.collisionVertexArray,Te.icon.placed,zt,ce,Z,K.hasIconTextFit?ut.x:0,K.hasIconTextFit?ut.y:0),dt.verticalIconBox&&Hn(t.iconCollisionBox.collisionVertexArray,Te.icon.placed,!zt,ce,Z,K.hasIconTextFit?ut.x:0,K.hasIconTextFit?ut.y:0)}}}if(t.fullyClipped=re===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const ee=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ee.invProjMatrix,t.placementViewportMatrix=ee.viewportMatrix,t.collisionCircleArray=ee.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Hn(l,t,n,c,d,p,m){l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,m||0,c,d?1:0)}const Tn=Math.pow(2,25),ym=Math.pow(2,24),Jl=Math.pow(2,17),_h=Math.pow(2,16),Ql=Math.pow(2,9),kc=Math.pow(2,8),gh=Math.pow(2,1);function ec(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*Tn+t*ym+n*Jl+t*_h+n*Ql+t*kc+n*gh+t}const kn=0;class jo{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,d,p,m){const y=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(y,d,t[this._currentTileIndex],this._sortAcrossTiles,m),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,y.sort(((x,T)=>x.sortKey-T.sortKey)));this._currentPartIndex<y.length;){const x=y[this._currentPartIndex];if(n.placeLayerBucketPart(x,this._seenCrossTileIDs,c,x.symbolInstanceStart===0,m),this._currentPartIndex++,p())return!0}return!1}}class Cs{constructor(t,n,c,d,p,m,y,x,T){this.placement=new Kl(t,p,m,y,x,T),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,d,p){const m=o.o.now(),y=()=>{const x=o.o.now()-m;return!this._forceFullPlacement&&x>2};for(;this._currentPlacementIndex>=0;){const x=n[t[this._currentPlacementIndex]],T=this.placement.collisionIndex.transform.zoom;if(x.type==="symbol"&&(!x.minzoom||x.minzoom<=T)&&(!x.maxzoom||x.maxzoom>T)){const S=x,M=S.layout.get("symbol-z-elevate"),E=S.layout.get("symbol-sort-key").constantOr(1)!==void 0,P=S.layout.get("symbol-z-order"),D=P==="viewport-y"||P==="auto"&&!(P!=="viewport-y"&&E),O=S.layout.get("text-allow-overlap")||S.layout.get("icon-allow-overlap")||S.layout.get("text-ignore-placement")||S.layout.get("icon-ignore-placement"),V=D&&O,N=this._inProgressLayer=this._inProgressLayer||new jo(S),j=o.B(x.source,x.scope);if(N.continuePlacement(M||V?d[j]:c[j],this.placement,this._showCollisionBoxes,x,y,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Fc=512/o.al/2;class Ka{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new o.c3(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*o.al,p=t.canonical.y*o.al;for(let m=0;m<n.length;m++){const{key:y,crossTileID:x,tileAnchorX:T,tileAnchorY:S}=n.get(m),M=Math.floor((d+T)*Fc),E=Math.floor((p+S)*Fc);this.index.add(M,E),this.keys.push(y),this.crossTileIDs.push(x)}this.index.finish()}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),p=Fc/Math.pow(2,n.canonical.z-this.tileID.canonical.z),m=n.canonical.x*o.al,y=n.canonical.y*o.al;for(let x=0;x<t.length;x++){const T=t.get(x);if(T.crossTileID)continue;const{key:S,tileAnchorX:M,tileAnchorY:E}=T,P=Math.floor((m+M)*p),D=Math.floor((y+E)*p),O=this.index.range(P-d,D-d,P+d,D+d).sort(((V,N)=>V-N));for(const V of O){const N=this.crossTileIDs[V];if(this.keys[V]===S&&!c.has(N)){c.add(N),T.crossTileID=N;break}}}}}class Pn{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Do{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],p={};for(const m in d){const y=d[m];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),p[y.tileID.key]=y}this.indexes[c]=p}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<n.symbolInstances.length;p++)n.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const p in this.indexes){const m=this.indexes[p];if(Number(p)>t.overscaledZ)for(const y in m){const x=m[y];x.tileID.isChildOf(t)&&x.findMatches(n.symbolInstances,t,d)}else{const y=m[t.scaledTo(Number(p)).key];y&&y.findMatches(n.symbolInstances,t,d)}}for(let p=0;p<n.symbolInstances.length;p++){const m=n.symbolInstances.get(p);m.crossTileID||(m.crossTileID=c.generate(),d.add(m.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Ka(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],n=!0)}return n}}class Go{constructor(){this.layerIndexes={},this.crossTileIDs=new Pn,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new Do);let m=!1;const y={};d.name!=="globe"&&p.handleWrapJump(c);for(const x of n){const T=x.getBucket(t);T&&t.fqid===T.layerIds[0]&&(T.bucketInstanceId||(T.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(x.tileID,T,this.crossTileIDs)&&(m=!0),y[T.bucketInstanceId]=!0)}return p.removeStaleBuckets(y)&&(m=!0),m}pruneUnusedLayers(t){const n={};t.forEach((c=>{n[c]=!0}));for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const on=771;class ni{constructor(t,n,c,d){this.blendFunction=t,this.blendColor=n.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}ni.Replace=[1,0,1,0],ni.disabled=new ni(ni.Replace,o.ao.transparent,[!1,!1,!1,!1]),ni.unblended=new ni(ni.Replace,o.ao.transparent,[!0,!0,!0,!0]),ni.alphaBlended=new ni([1,on,1,on],o.ao.transparent,[!0,!0,!0,!0]),ni.alphaBlendedNonPremultiplied=new ni([770,on,770,on],o.ao.transparent,[!0,!0,!0,!0]),ni.multiply=new ni([774,0,774,0],o.ao.transparent,[!0,!0,!0,!0]),ni.additive=new ni([1,1,1,1],o.ao.transparent,[!0,!0,!0,!0]);class wt{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}wt.ReadOnly=!1,wt.ReadWrite=!0,wt.disabled=new wt(519,wt.ReadOnly,[0,1]);const Aa=7680;class Zt{constructor(t,n,c,d,p,m){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=p,this.pass=m}}Zt.disabled=new Zt({func:519,mask:0},0,0,Aa,Aa,Aa);const Ja=1029,Bc=2305;class jt{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function tc(l,t){const n=o.c9(l,3);o.cb(l,t),o.cf(l,3,n)}function Nc(l,t){const n=o.c6([]);return o.c7(n,n,-t),o.c8(n,n,-l),n}function Tf(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(o.ag(n)>=1e-15){const m=o.aw([],n);o.c4(c,m,o.bI(c,m)),t[0]=c[0],t[1]=c[1]}const d=o.bH([],t,l);if(o.c5(d)<1e-15)return null;const p=Math.atan2(-d[1],d[0]);return Nc(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}jt.disabled=new jt(!1,Ja,Bc),jt.backCCW=new jt(!0,Ja,Bc),jt.backCW=new jt(!0,Ja,2304),jt.frontCW=new jt(!0,1028,2304),jt.frontCCW=new jt(!0,1028,Bc);class zo{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof o.ae?t:new o.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=o.bS(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n,c){if(this.orientation=null,!this.position)return;const d=this.position,p=c||(this._elevation?this._elevation.getAtPointOrZero(o.ae.fromLngLat(t)):0),m=o.ae.fromLngLat(t,p),y=[m.x-d.x,m.y-d.y,m.z-d.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=Tf(y,n)}setPitchBearing(t,n){this.orientation=Nc(o.an(t),o.an(-n))}}class Vc{constructor(t,n){this._transform=o.bz([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new o.ae(t[0],t[1],t[2])}get position(){const t=o.c9(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&o.cf(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||o.c6([]),t&&tc(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=Nc(t,n),tc(this._transform,this._orientation)}forward(){const t=o.c9(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=o.c9(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=o.c9(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return o.bk(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const d=this.position;o.c4(d,d,-t);const p=new Float64Array(16);return o.bp(p,[c,c,c]),o.bq(p,p,d),p[10]*=n,p}getWorldToCamera(t,n){const c=new Float64Array(16),d=new Float64Array(4),p=this.position;return o.ca(d,this._orientation),o.c4(p,p,-t),o.cb(c,d),o.bq(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,d){const p=new Float64Array(16);return o.cc(p,t,n,c,d),p}getCameraToClipOrthographic(t,n,c,d,p,m){const y=new Float64Array(16);return o.cd(y,t,n,c,d,p,m),y}getDistanceToElevation(t,n=!1){const c=t===0?0:o.ce(t,n?o.a_(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Vc([...this.position],[...this.orientation])}}const qn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class gs{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=o.ak(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=o.ak(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=o.ak(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=o.ak(t.right,n.right,c)),this}getCenter(t,n){const c=o.aA((this.left+t-this.right)/2,0,t),d=o.aA((this.top+n-this.bottom)/2,0,n);return new o.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new gs(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Ma=15;class Qa{constructor(t,n,c,d,p,m,y){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c!=null?c:0,this._maxPitch=d!=null?d:60,this.setProjection(m),this.setMaxBounds(y),this.width=0,this.height=0,this._center=new o.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new gs,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Vc,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new Qa(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Ma}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return o.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=o.cl(this.projectionOptions);const c=this.getProjection(),d=!o.bx(n,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.cl({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bS(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=o.cm(),o.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=o.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=o.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,p=0;for(let m=0;m<n.length;m++){const y=new o.P(n[m][0]*this.width,c+n[m][1]*(this.height-c)),x=t.pointCoordinate(y);if(!x)continue;const T=1/Math.hypot(x[0]-this._camera.position[0],x[1]-this._camera.position[1]);d+=x[3]*T,p+=T}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),m=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(m))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const d=o.ag(o.av([],this._camera.position,c));return o.aA(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!o.co(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];o.cp(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new zo;return n.position=new o.ae(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!o.cq(t))return!1;o.cr(t,t);const n=o.cs([],[0,0,-1],t),c=o.cs([],[0,-1,0],t);if(c[2]<0)return!1;const d=Tf(n,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=o.aA(t[2],d/c,d/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new o.ct(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new o.P(0,0)),d=this.pointCoordinate(new o.P(this.width,0)),p=this.pointCoordinate(new o.P(this.width,this.height)),m=this.pointCoordinate(new o.P(0,this.height)),y=Math.floor(Math.min(c.x,d.x,p.x,m.x)),x=Math.floor(Math.max(c.x,d.x,p.x,m.x)),T=1;for(let S=y-T;S<=x+T;S++)S!==0&&n.push(new o.ct(S,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c){let d=[];const p=c!=null,m=!p;if(m&&this.zoom<n||p&&c[0]===0&&c[1]===0)return d;const y=new Set,x=(S,M,E,P,D)=>{const O=o.cX(M,S,E,P,D);y.has(O)||(d.push(new o.aP(S,M,E,P,D)),y.add(O))};for(let S=0;S<t.length;S++){const M=t[S];if(m&&M.canonical.z!==n)continue;const E=M.canonical,P=M.overscaledZ,D=M.wrap,O=1<<E.z,V=E.x+1<O,N=E.x>0,j=E.y+1<O,Z=E.y>0,H=M.wrap-(N?0:1),te=M.wrap+(V?0:1),W=N?E.x-1:O-1,re=V?E.x+1:0;if(p)c[0]<0?(x(P,te,E.z,re,E.y),c[1]<0&&j&&(x(P,D,E.z,E.x,E.y+1),x(P,te,E.z,re,E.y+1)),c[1]>0&&Z&&(x(P,D,E.z,E.x,E.y-1),x(P,te,E.z,re,E.y-1))):c[0]>0?(x(P,H,E.z,W,E.y),c[1]<0&&j&&(x(P,D,E.z,E.x,E.y+1),x(P,H,E.z,W,E.y+1)),c[1]>0&&Z&&(x(P,D,E.z,E.x,E.y-1),x(P,H,E.z,W,E.y-1))):c[1]<0&&j?x(P,D,E.z,E.x,E.y+1):Z&&x(P,D,E.z,E.x,E.y-1);else{const ee=M.visibleQuadrants;1&ee&&(x(P,H,E.z,W,E.y),Z&&(x(P,D,E.z,E.x,E.y-1),x(P,H,E.z,W,E.y-1))),2&ee&&(x(P,te,E.z,re,E.y),Z&&(x(P,D,E.z,E.x,E.y-1),x(P,te,E.z,re,E.y-1))),4&ee&&(x(P,H,E.z,W,E.y),j&&(x(P,D,E.z,E.x,E.y+1),x(P,H,E.z,W,E.y+1))),8&ee&&(x(P,te,E.z,re,E.y),j&&(x(P,D,E.z,E.x,E.y+1),x(P,te,E.z,re,E.y+1)))}}const T=[];for(const S of d)d.some((M=>S.isChildOf(M)))||T.push(S);if(d=T.filter((S=>!t.some((M=>!!(S.overscaledZ<n&&M.isChildOf(S))||S.equals(M)||S.isChildOf(M))))),m){const S=1<<n,M=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),E=[S*M.x,S*M.y],P=4,D=P*P;d=d.filter((O=>{const V=O.canonical.x+.5-E[0],N=O.canonical.y+.5-E[1];return V*V+N*N<D}))}return d}extendTileCoverToNearPlane(t,n,c){const d=[],p=new Set;for(const j of t)p.add(j.key);const m=(j,Z,H,te,W)=>{const re=o.cX(Z,j,H,te,W);p.has(re)||(d.push(new o.aP(j,Z,H,te,W)),p.add(re))},y=t.reduce(((j,Z)=>Math.max(j,Z.overscaledZ)),c),x=1<<c,T=[new o.P(0,0),new o.P(o.al,0),new o.P(o.al,o.al),new o.P(0,o.al)],S=new o.P(0,0),M=new o.P(0,0),E=(j,Z)=>{const H=Math.floor(j[0]),te=Math.floor(j[1]),W=(j[0]-H)*o.al,re=(j[1]-te)*o.al,ee=Math.floor(Z[0]),K=Math.floor(Z[1]),ne=(Z[0]-ee)*o.al,_e=(Z[1]-K)*o.al;for(let fe=-1;fe<=1;fe++){const Me=H+fe;if(!(Me<0||Me>=x)){S.x=W-fe*o.al,M.x=ne-(Me-ee)*o.al;for(let we=-1;we<=1;we++){const ze=te+we;S.y=re-we*o.al,M.y=_e-(ze-K)*o.al,o.cY(S,M,T)&&m(y,0,c,Me,ze)}}}},P=n.points,D=P[o.cu],O=P[o.cv],V=this._projectToGround(D,P[o.cw]),N=this._projectToGround(O,P[o.cx]);return E(D,V),E(O,N),d}_projectToGround(t,n){return o.cy(o.cz(),t,n,t[2]/(t[2]-n[2]))}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,m=this.projection.name==="mercator";if(t.minzoom!==void 0&&n<t.minzoom)return[];t.maxzoom!==void 0&&n>t.maxzoom&&(n=t.maxzoom);const y=this.locationCoordinate(this.center),x=this.center.lat,T=1<<n,S=[T*y.x,T*y.y,0],M=this.projection.name==="globe",E=!M,P=o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,E),D=M?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),O=T*o.ce(1,this.center.lat),V=this._camera.position[2]/o.ce(1,this.center.lat),N=[T*D.x,T*D.y,V*(E?1:O)],j=M||d,Z=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),H=this.isLODDisabled(!0)?n:0;let te;if(this._elevation&&t.isTerrainDEM)te=1e4*this._elevation.exaggeration();else if(this._elevation){const ce=this._elevation.getMinMaxForVisibleTiles();te=ce?ce.max:this._centerAltitude}else te=this._centerAltitude;const W=t.isTerrainDEM?-te:this._elevation?this._elevation.getMinElevationBelowMSL():0,re=this.projection.isReprojectedInTileSpace?o.cB(this):1,ee=ce=>{const Te=new o.ae(ce.x+25e-6,ce.y,ce.z),je=new o.ae(ce.x,ce.y+25e-6,ce.z),rt=ce.toLngLat(),gt=Te.toLngLat(),Xe=je.toLngLat(),et=this.locationCoordinate(rt),xt=this.locationCoordinate(gt),dt=this.locationCoordinate(Xe),ut=Math.hypot(xt.x-et.x,xt.y-et.y),ft=Math.hypot(dt.x-et.x,dt.y-et.y);return Math.sqrt(ut*ft)*re/25e-6},K=ce=>{const Le=te,Te=W;return{aabb:o.cE(this,T,0,0,0,ce,Te,Le,this.projection),zoom:0,x:0,y:0,minZ:Te,maxZ:Le,wrap:ce,fullyVisible:!1}},ne=[];let _e=[];const fe=n,Me=t.reparseOverscaled?c:n,we=(V-this._centerAltitude)*O,ze=ce=>{if(!this._elevation||!ce.tileID||!m)return;const Le=this._elevation.getMinMaxForTile(ce.tileID),Te=ce.aabb;Le?(Te.min[2]=Le.min,Te.max[2]=Le.max,Te.center[2]=(Te.min[2]+Te.max[2])/2):(ce.shouldSplit=xe(ce),ce.shouldSplit||(Te.min[2]=Te.max[2]=Te.center[2]=this._centerAltitude))},Je=(ce,Le)=>{if(.707*Le<ce)return 1;const Te=Le/ce;return Te/(1.4144271570014144+(Math.pow(1.1,Te-1.4144271570014144+1)-1)/(1.1-1)-1)},xe=ce=>{if(ce.zoom<H)return!0;if(ce.zoom===fe)return!1;if(ce.shouldSplit!=null)return ce.shouldSplit;const Le=ce.aabb.distanceX(N),Te=ce.aabb.distanceY(N);let je=we,rt=1;if(M){je=ce.aabb.distanceZ(N);const ft=Math.pow(2,ce.zoom),zt=o.a_((ce.y+1)/ft),pi=o.a_(ce.y/ft),vi=Math.min(Math.max(x,zt),pi),tr=o.d0(vi)/o.d0(x);if(rt=vi===x?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,tr/this._mercatorScaleRatio),this.zoom<=o.cZ&&ce.zoom===fe-1&&tr>=.9)return!0}else if(p&&(je=ce.aabb.distanceZ(N)*O),this.projection.isReprojectedInTileSpace&&c<=5){const ft=Math.pow(2,ce.zoom),zt=ee(new o.ae((ce.x+.5)/ft,(ce.y+.5)/ft));rt=zt>.85?1:zt}if(!m&&!M){const ft=Math.sqrt(Le*Le+Te*Te+je*je);let zt=(1<<fe-ce.zoom)*Z*rt;return zt*=Je(Math.max(je,we),ft),ft<zt}let gt=Number.MAX_VALUE,Xe=0;const et=ce.aabb.getCorners(),xt=[];for(const ft of et){o.av(xt,ft,N),M||(p?xt[2]*=O:xt[2]=we);const zt=o.bI(xt,this._camera.forward());zt<gt&&(gt=zt,Xe=Math.abs(xt[2]))}let dt=(1<<fe-ce.zoom)*Z*rt;if(dt*=Je(Math.max(Xe,we),gt),gt<dt)return!0;const ut=ce.aabb.closestPoint(S);return ut[0]===S[0]&&ut[1]===S[1]};if(this.renderWorldCopies)for(let ce=1;ce<=3;ce++)ne.push(K(-ce)),ne.push(K(ce));for(ne.push(K(0));ne.length>0;){const ce=ne.pop(),Le=ce.x,Te=ce.y;let je=ce.fullyVisible;const rt=()=>this.projection.name==="globe"&&(ce.y===0||ce.y===(1<<ce.zoom)-1);if(!je){let gt=j?ce.aabb.intersects(P):ce.aabb.intersectsFlat(P);if(gt===0&&rt()){const Xe=new o.cC(ce.zoom,Le,Te);gt=o.cD(this,T,Xe,!0).intersects(P)}if(gt===0)continue;je=gt===2}if(ce.zoom!==fe&&xe(ce))for(let gt=0;gt<4;gt++){const Xe=(Le<<1)+gt%2,et=(Te<<1)+(gt>>1),xt={aabb:m?ce.aabb.quadrant(gt):o.cE(this,T,ce.zoom+1,Xe,et,ce.wrap,ce.minZ,ce.maxZ,this.projection),zoom:ce.zoom+1,x:Xe,y:et,wrap:ce.wrap,fullyVisible:je,tileID:void 0,shouldSplit:void 0,minZ:ce.minZ,maxZ:ce.maxZ};p&&!M&&(xt.tileID=new o.aP(ce.zoom+1===fe?Me:ce.zoom+1,ce.wrap,ce.zoom+1,Xe,et),ze(xt)),ne.push(xt)}else{const gt=ce.zoom===fe?Me:ce.zoom;if(t.minzoom&&t.minzoom>gt)continue;let Xe=0;if(!je){let ut=j?ce.aabb.intersectsPrecise(P):ce.aabb.intersectsPreciseFlat(P);if(ut===0&&rt()){const ft=new o.cC(ce.zoom,Le,Te);ut=o.cD(this,T,ft,!0).intersectsPrecise(P)}if(ut===0)continue;if(t.calculateQuadrantVisibility)if(P.containsPoint(ce.aabb.center))Xe=15;else for(let ft=0;ft<4;ft++)ce.aabb.quadrant(ft).intersects(P)!==0&&(Xe|=1<<ft)}const et=S[0]-(.5+Le+(ce.wrap<<ce.zoom))*(1<<n-ce.zoom),xt=S[1]-.5-Te,dt=ce.tileID?ce.tileID:new o.aP(gt,ce.wrap,ce.zoom,Le,Te);t.calculateQuadrantVisibility&&(dt.visibleQuadrants=Xe),_e.push({tileID:dt,distanceSq:et*et+xt*xt})}}if(this.fogCullDistSq){const ce=this.fogCullDistSq,Le=this.horizonLineFromTop();_e=_e.filter((Te=>{const je=[0,0,0,1],rt=[o.al,o.al,0,1],gt=this.calculateFogTileMatrix(Te.tileID.toUnwrapped());o.aC(je,je,gt),o.aC(rt,rt,gt);const Xe=o.cF([],je,rt),et=o.cG([],je,rt),xt=o.c_(Xe,et);if(xt===0)return!0;let dt=!1;const ut=this._elevation;if(ut&&xt>ce&&Le!==0){const ft=this.calculateProjMatrix(Te.tileID.toUnwrapped());let zt;t.isTerrainDEM||(zt=ut.getMinMaxForTile(Te.tileID)),zt||(zt={min:W,max:te});const pi=o.cH(this.rotation),vi=[pi[0]*o.al,pi[1]*o.al,zt.max];o.af(vi,vi,ft),dt=(1-vi[1])*this.height*.5<Le}return xt<ce||dt}))}return _e.sort(((ce,Le)=>ce.distanceSq-Le.distanceSq)).map((ce=>ce.tileID))}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){const n=o.aA(t.lat,-o.cI,o.cI),c=this.projection.project(t.lng,n);return new o.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,d;const p=this.centerPoint;if(this.projection.name==="globe"){const y=this.worldSize;c=(n.x-p.x)/y,d=(n.y-p.y)/y}else{const y=this.pointCoordinate(n),x=this.pointCoordinate(p);c=y.x-x.x,d=y.y-x.y}const m=this.locationCoordinate(t);this.setLocation(new o.ae(m.x-c,m.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,n){return this.projection.locationPoint(this,t,n)}locationPoint3D(t,n){return this.projection.locationPoint(this,t,n,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,n){return this.coordinateLocation(this.pointCoordinate3D(t,n))}locationCoordinate(t,n){const c=n?o.ce(n,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new o.ae(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n!=null?n:this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];o.aC(d,d,this.pixelMatrixInverse),o.aC(p,p,this.pixelMatrixInverse);const m=p[3];o.cJ(d,d,1/d[3]),o.cJ(p,p,1/m);const y=d[2],x=p[2];return{p0:d,p1:p,t:y===x?0:(c-y)/(x-y)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return o.aC(n,n,this.pixelMatrixInverse),o.aC(c,c,this.pixelMatrixInverse),o.cJ(n,n,1/n[3]),o.cJ(c,c,1/c[3]),n[2]=o.ce(n[2],this._center.lat)*this.worldSize,c[2]=o.ce(c[2],this._center.lat)*this.worldSize,o.cJ(n,n,1/this.worldSize),o.cJ(c,c,1/this.worldSize),new o.ax([n[0],n[1],n[2]],o.aw([],o.av([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:d}=t,p=o.ce(n[2],this._center.lat),m=o.ce(c[2],this._center.lat);return new o.ae(o.ak(n[0],c[0],d)/this.worldSize,o.ak(n[1],c[1],d)/this.worldSize,o.ak(p,m,d))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t,n){if(!this.elevation)return this.pointCoordinate(t,n);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new o.ae(c[0],c[1],c[2]);let d=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t,n);const m=.02*p,y=t.clone();for(let x=0;x<10&&p-d>m;x++){y.y=o.ak(d,p,.66);const T=this.projection.pointCoordinate3D(this,y.x,y.y);T?(p=y.y,c=T):d=y.y}return c?new o.ae(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=o.cK)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return o.aC(d,d,this.pixelMatrix),d[3]>0?new o.P(d[0]/d[3],d[1]/d[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new o.P(n,t)),m=this.pointLocation3D(new o.P(d,t)),y=this.pointLocation3D(new o.P(d,c)),x=this.pointLocation3D(new o.P(n,c));let T=Math.min(p.lng,m.lng,y.lng,x.lng),S=Math.max(p.lng,m.lng,y.lng,x.lng),M=Math.min(p.lat,m.lat,y.lat,x.lat),E=Math.max(p.lat,m.lat,y.lat,x.lat);const P=Math.pow(2,-this.zoom)/16*270,D=this.projection.name==="globe"?1:4,O=(V,N,j,Z,H)=>{const te=(V+j)/2,W=(N+Z)/2,re=new o.P(te,W),{lng:ee,lat:K}=this.pointLocation3D(re),ne=Math.max(0,T-ee,M-K,ee-S,K-E);T=Math.min(T,ee),S=Math.max(S,ee),M=Math.min(M,K),E=Math.max(E,K),(H<D||ne>P)&&(O(V,N,te,W,H+1),O(te,W,j,Z,H+1))};if(O(n,t,d,t,1),O(d,t,d,c,1),O(d,c,n,c,1),O(n,c,n,t,1),this.projection.name==="globe"){const[V,N]=o.cL(this);V?(E=90,S=180,T=-180):N&&(M=-90,S=180,T=-180)}return new o.aI(new o.aS(T,M),new o.aS(S,E))}_getBoundsRectangular(t,n){const{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,m=this.width-this._edgeInsets.right,y=new o.P(d,c),x=new o.P(m,c),T=new o.P(m,p),S=new o.P(d,p);let M=this.pointCoordinate(y,t),E=this.pointCoordinate(x,t);const P=this.pointCoordinate(T,n),D=this.pointCoordinate(S,n),O=(V,N)=>(N.y-V.y)/(N.x-V.x);return M.y>1&&E.y>=0?M=new o.ae((1-D.y)/O(D,M)+D.x,1):M.y<0&&E.y<=1&&(M=new o.ae(-D.y/O(D,M)+D.x,0)),E.y>1&&M.y>=0?E=new o.ae((1-P.y)/O(P,E)+P.x,1):E.y<0&&M.y<=1&&(E=new o.ae(-P.y/O(P,E)+P.x,0)),new o.aI().extend(this.coordinateLocation(M)).extend(this.coordinateLocation(E)).extend(this.coordinateLocation(D)).extend(this.coordinateLocation(P))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce(((c,d)=>{if(d.dem){const p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-o.cI,this.maxLat=o.cI,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.aF(this.minLng)*this.tileSize,this.worldMaxX=o.aF(this.maxLng)*this.tileSize,this.worldMinY=o.aJ(this.maxLat)*this.tileSize,this.worldMaxY=o.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const d=t.canonical,p=1/this.height,m=this.cameraWorldSize,y=m/this.zoomScale(d.z),x=(d.x+Math.pow(2,d.z)*t.wrap)*y,T=d.y*y,S=this.point;S.x*=m/this.worldSize,S.y*=m/this.worldSize;const M=this.angle,E=Math.sin(-M),P=-Math.cos(-M);return c[n]={bearing:[E,P],center:[(S.x-x)*p,(S.y-T)*p],scale:y/o.al*p},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return o.aB(d,this.worldToFogMatrix,d),c[n]=new Float32Array(d),c[n]}calculateProjMatrix(t,n=!1,c=!1){const d=t.key;let p;if(p=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];const m=this.calculatePosMatrix(t,this.worldSize);let y;return y=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,o.aB(m,y,m),p[d]=new Float32Array(m),p[d]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const d=o.cM(t,this);return c[n]=d,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,n=o.bp([],[t,t,t]);return o.aB(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const n=o.ce(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),d=this._camera.forward(),p=o.ce(1,this._center.lat);c[2]/=p,d[2]/=p,o.aw(d,d);const m=t.raycast(c,d,t.exaggeration());if(m){const y=o.bG([],c,d,m),x=new o.ae(y[0],y[1],o.ce(y[2],o.a_(y[1]))),T=(x.z+o.ag([x.x-c[0],x.y-c[1],x.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(T),this._centerAltitude=x.toAltitude(),this._center=this.coordinateLocation(x),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=o.ce(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=n.getAtPointOrZero(new o.ae(...d)),m=this.pixelsPerMeter/this.worldSize*p,y=this._minimumHeightOverTerrain(),x=d[2]-m;if(x<=y)if(x<0||t){const T=this.locationCoordinate(this._center,this._centerAltitude),S=[d[0],d[1],T.z-d[2]],M=o.ag(S);S[2]-=(y-x)/this._pixelsPerMercatorPixel;const E=o.ag(S);if(E===0)return;o.c4(S,S,M/E*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],T.z*this._pixelsPerMercatorPixel-S[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const E=this.center;return E.lat=o.aA(E.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(E.lng=o.aA(E.lng,this.minLng,this.maxLng)),this.center=E,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:d}=this.point;let p=0,m=c,y=d;const x=this.width/2,T=this.height/2,S=this.worldMinY*this.scale,M=this.worldMaxY*this.scale;if(d-T<S&&(y=S+T),d+T>M&&(y=M-T),M-S<this.height&&(p=Math.max(p,this.height/(M-S)),y=(M+S)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const E=this.worldMinX*this.scale,P=this.worldMaxX*this.scale,D=this.worldSize/2-(E+P)/2;m=(c+D+this.worldSize)%this.worldSize-D,m-x<E&&(m=E+x),m+x>P&&(m=P-x),P-E<this.width&&(p=Math.max(p,this.width/(P-E)),m=(P+E)/2)}m===c&&y===d||this._allowWorldUnderZoom||(this.center=this.unproject(new o.P(m,y))),p&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=o.ce(1,this.center.lat)/o.ce(1,o.d1));const d=o.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const p=this.projection.zAxisUnit==="meters"?c:1,m=this._camera.getWorldToCamera(this.worldSize,p);let y;const x=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(x[8]=2*-t.x/this.width,x[9]=2*t.y/this.height,this.isOrthographic){let K=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ne=K*this.aspect,_e=-ne,fe=-K;ne-=t.x,_e-=t.x,K+=t.y,fe+=t.y,y=this._camera.getCameraToClipOrthographic(_e,ne,fe,K,this._nearZ,this._farZ),((Me,we,ze,Je)=>{for(let xe=0;xe<16;xe++)Me[xe]=o.ak(we[xe],ze[xe],Je)})(y,y,x,o.c$(this.pitch>=Ma?1:this.pitch/Ma))}else y=x;const T=o.cO([],x,m);let S=o.cO([],y,m);if(this.projection.isReprojectedInTileSpace){const K=this.locationCoordinate(this.center),ne=o.bz([]);o.bq(ne,ne,[K.x*this.worldSize,K.y*this.worldSize,0]),o.aB(ne,ne,o.cP(this)),o.bq(ne,ne,[-K.x*this.worldSize,-K.y*this.worldSize,0]),o.aB(S,S,ne),o.aB(T,T,ne),this.inverseAdjustmentMatrix=o.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.cR([],S,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=S,this.invProjMatrix=o.bk(new Float64Array(16),this.projMatrix),n){const K=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);K[8]=2*-t.x/this.width,K[9]=2*t.y/this.height,this.expandedFarZProjMatrix=o.cO([],K,m)}else this.expandedFarZProjMatrix=this.projMatrix;const M=o.bk([],y);this.frustumCorners=o.cS.fromInvProjectionMatrix(M,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const E=new Float32Array(16);o.bz(E),o.cR(E,E,[1,-1,1]),o.cT(E,E,this._pitch),o.bA(E,E,this.angle);const P=o.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.by(P);const D=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;P[8]=2*-t.x/this.width,P[9]=2*(t.y+D)/this.height,this.skyboxMatrix=o.aB(E,P,E);const O=this.point,V=O.x,N=O.y,j=this.width%2/2,Z=this.height%2/2,H=Math.cos(this.angle),te=Math.sin(this.angle),W=V-Math.round(V)+H*j+te*Z,re=N-Math.round(N)+H*Z+te*j,ee=new Float64Array(S);if(o.bq(ee,ee,[W>.5?W-1:W,re>.5?re-1:re,0]),this.alignedProjMatrix=ee,S=o.bB(),o.cR(S,S,[this.width/2,-this.height/2,1]),o.bq(S,S,[1,-1,0]),this.labelPlaneMatrix=S,S=o.bB(),o.cR(S,S,[1,-1,1]),o.bq(S,S,[-1,-1,0]),o.cR(S,S,[2/this.width,2/this.height,1]),this.glCoordMatrix=S,this.pixelMatrix=o.aB(new Float64Array(16),this.labelPlaneMatrix,T),this._calcFogMatrices(),this._distanceTileDataCache={},S=o.bk(new Float64Array(16),this.pixelMatrix),!S)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=S,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=o.cU(this);const K=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.af(K,K,m),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=S;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,n];o.c4(p,p,d),o.c4(c,c,-1),o.cV(c,c,p);const m=o.bB();o.bq(m,m,c),o.cR(m,m,p),this.mercatorFogMatrix=m,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,d)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((n-c)/d,1)),this._camera.position=o.bG([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=o.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,m=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.an(this._maxPitch)),y=Math.max((t[2]-p)/Math.cos(c),m),x=this._zoomFromMercatorZ(y);o.bG(t,t,n,y),this._pitch=o.aA(c,o.an(this.minPitch),o.an(this.maxPitch)),this.angle=o.bS(d,-Math.PI,Math.PI),this._setZoom(o.aA(x,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=o.cK,d=0,p=1/0;for(;c-n>1e-6&&c>n;){const m=n+.5*(c-n),y=this.tileSize*Math.pow(2,m),x=this.getCameraToCenterDistance(this.projection,m,y),T=this.scaleZoom(x/(Math.max(0,t)*this.tileSize)),S=Math.abs(m-T);S<p&&(p=S,d=m),m<T?n=m:c=m}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),d=Math.max(t.x,n.x),p=Math.min(t.y,n.y),m=Math.max(t.y,n.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const y=[new o.P(c,p),new o.P(d,m),new o.P(c,m),new o.P(d,p)],x=this.renderWorldCopies?-3:0,T=this.renderWorldCopies?4:1;for(const S of y){const M=this.pointRayIntersection(S);if(M.t<0)return!0;const E=this.rayIntersectionCoordinate(M);if(E.x<x||E.y<0||E.x>T||E.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=o.ag(o.av([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=(function([n,c,d],p){const m=[n,c,d,1];o.aC(m,m,p);const y=m[3]=Math.max(m[3],1e-6);return m[0]/=y,m[1]/=y,m[2]/=y,m})([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const d=o.cN(t,n,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d);let m=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(m=o.ak(1,m,o.c$(this.pitch>=Ma?1:this.pitch/Ma))),m}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&o.aB(t,t,this.globeMatrix),t}getFrustum(t){return o.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const Ho=(l,t)=>{if(t>0&&l.terrain&&o.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),d=n.isLODDisabled(!1)?o.ah(60,45,n.pitch):o.ah(30,15,n.pitch),p=n._farZ-n._nearZ,m=t*n.height,y=((1-(x=d))*n.cameraToCenterDistance+x*(n._farZ+m))*c;var x;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(y-n._nearZ)/p,(y-m-n._nearZ)/p]}}},$n={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class xm{constructor(t,n){this.aabb=t,this.lastCascade=n}}class vm{add(t,n){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new xm(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const d=o.d8.fromPoints(t.points);let p=0;for(const m in this.receivers){const y=this.receivers[m];if(!y||!d.intersectsAabb(y.aabb))continue;y.aabb.min=d.closestPoint(y.aabb.min),y.aabb.max=d.closestPoint(y.aabb.max);const x=y.aabb.getCorners();for(let T=0;T<c.length;T++){let S=!0;for(const M of x){const E=[M[0]*n,M[1]*n,M[2]];if(o.af(E,E,c[T].matrix),E[0]<-1||E[0]>1||E[1]<-1||E[1]>1){S=!1;break}}if(y.lastCascade=T,p=Math.max(p,T),S)break}}return p+1}}class ic{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new vm,this._depthMode=new wt(t.context.gl.LEQUAL,wt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),t.tp.registerParameter($n,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter($n,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter($n,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const d=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce(((D,O)=>{const V=c.style._mergedLayers[O];return D+(V.hasShadowPass()&&!V.isHidden(t.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const p=c.context,m=$n.shadowMapResolution,y=$n.shadowMapResolution;if(this._cascades.length===0||$n.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let D=0;D<$n.cascadeCount;++D){const O=c._shadowMapDebug,V=p.gl,N=p.createFramebuffer(m,y,O,"texture"),j=new o.T(p,{width:m,height:y,data:null},V.DEPTH_COMPONENT16);if(N.depthAttachment.set(j.texture),O){const Z=new o.T(p,{width:m,height:y,data:null},V.RGBA8);N.colorAttachment.set(Z.texture)}this._cascades.push({framebuffer:N,texture:j,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.cA,scale:0})}}this.shadowDirection=Sf(n);let x=0;if(t.elevation){const D=t.elevation,O=[1e4,-1e4];D.visibleDemTiles.filter((V=>V.dem)).forEach((V=>{const N=V.dem.tree;O[0]=Math.min(O[0],N.minimums[0]),O[1]=Math.max(O[1],N.maximums[0])})),O[0]!==1e4&&(x=(O[1]-O[0])*D.exaggeration())}const T=1.5*t.cameraToCenterDistance,S=3*T,M=new Float64Array(16);for(let D=0;D<this._cascades.length;++D){const O=this._cascades[D];let V=t.height/50,N=1;$n.cascadeCount===1?N=S:D===0?N=T:(V=T,N=S);const[j,Z]=Ef(t,this.shadowDirection,V,N,$n.shadowMapResolution,x);O.scale=t.scale,O.matrix=j,O.boundingSphereRadius=Z,o.bk(M,O.matrix),O.frustum=o.cA.fromInvProjectionMatrix(M,1,0,!0),O.far=N}const E=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[E].far,this._cascades[E].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/$n.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=$n.shadowMapResolution,this._uniformValues.u_shadowmap_0=qn.ShadowMap0,this._uniformValues.u_shadowmap_1=qn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const P=c.transform.elevation;for(const D of this._groundShadowTiles){let O={min:0,max:0};if(P){const V=P.getMinMaxForTile(D);V&&(O=V)}this.addShadowReceiver(D.toUnwrapped(),O.min,O.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,$n.shadowMapResolution,$n.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:o.ao.white,depth:1});for(const m of t.order){const y=t._mergedLayers[m];if(!y.hasShadowPass()||y.isHidden(c.transform.zoom))continue;const x=t.getLayerSourceCache(y),T=x?n[x.id]:void 0;(y.type==="model"||T&&T.length)&&c.renderLayer(c,x,y,T)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,d=c.gl,p=n.directionalLight,m=n.ambientLight;if(!p||!m)return;const y=[],x=Ho(t,t.longestCutoffRange);x.shouldRenderCutoff&&y.push("RENDER_CUTOFF"),y.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&y.push("NORMAL_OFFSET");const T=mo(n,p,m),S=new wt(d.LEQUAL,wt.ReadOnly,t.depthRangeFor3D),M=new Zt({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(const E of this._groundShadowTiles){const P=E.toUnwrapped(),D=t.isTileAffectedByFog(E),O=t.getOrCreateProgram("groundShadow",{defines:y,overrideFog:D});this.setupShadows(P,O),t.uploadCommonUniforms(c,O,P,null,x);const V={u_matrix:t.transform.calculateProjMatrix(P),u_ground_shadow_factor:T};O.draw(t,d.TRIANGLES,S,M,ni.multiply,jt.disabled,V,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ni.unblended:ni.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return o.aB(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){const n=o.by(t);return o.aB(n,this._cascades[this.painter.currentShadowCascade].matrix,t),n}setupShadows(t,n,c){if(!this.enabled)return;const d=this.painter.transform,p=this.painter.context,m=p.gl,y=this._uniformValues,x=new Float64Array(16),T=d.calculatePosMatrix(t,d.worldSize);for(let S=0;S<this._cascades.length;S++)o.aB(x,this._cascades[S].matrix,T),y[S===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(x),p.activeTexture.set(m.TEXTURE0+qn.ShadowMap0+S),this._cascades[S].texture.bindExtraParam(m.LINEAR,m.LINEAR,m.CLAMP_TO_EDGE,m.CLAMP_TO_EDGE,m.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){const S=o.d6(t.canonical),M=2/d.tileSize*o.al/$n.shadowMapResolution,E=M*this._cascades[0].boundingSphereRadius,P=M*this._cascades[this._cascades.length-1].boundingSphereRadius,D=(c==="vector-tile"?1:3)*(function(O,V,N,j,Z){const H=o.aA((O-22)/-22,0,1);return .125*(1-H)+4*H})(d.zoom);y.u_shadow_normal_offset=[S,E*D,P*D],y.u_shadow_bias=[1e-4,.0012,.012]}else y.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(p,y)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const d=this.painter.context,p=d.gl,m=this._uniformValues,y=new Float64Array(16);for(let x=0;x<$n.cascadeCount;x++)o.aB(y,this._cascades[x].matrix,t),m[x===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(y),d.activeTexture.set(p.TEXTURE0+qn.ShadowMap0+x),this._cascades[x].texture.bindExtraParam(p.LINEAR,p.LINEAR,p.CLAMP_TO_EDGE,p.CLAMP_TO_EDGE,p.GREATER);if(this.useNormalOffset=c,c){const x=$n.normalOffset;m.u_shadow_normal_offset=[1,x,x],m.u_shadow_bias=[6e-5,.0012,.012]}else m.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(d,m)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,d){if(d[2]>=0)return{};const p=(function(x,T,S){const M=S/(1<<x.canonical.z);return new o.d8([x.canonical.x*M+x.wrap*S,x.canonical.y*M+x.wrap*S,0],[(x.canonical.x+1)*M+x.wrap*S,(x.canonical.y+1)*M+x.wrap*S,T])})(t,n,c).getCorners(),m=n/-d[2];d[0]<0?(o.d7(p[0],p[0],[d[0]*m,0,0]),o.d7(p[3],p[3],[d[0]*m,0,0])):d[0]>0&&(o.d7(p[1],p[1],[d[0]*m,0,0]),o.d7(p[2],p[2],[d[0]*m,0,0])),d[1]<0?(o.d7(p[0],p[0],[0,d[1]*m,0]),o.d7(p[1],p[1],[0,d[1]*m,0])):d[1]>0&&(o.d7(p[2],p[2],[0,d[1]*m,0]),o.d7(p[3],p[3],[0,d[1]*m,0]));const y={};return y.vertices=p,y.planes=[na(p[1],p[0],p[4]),na(p[2],p[1],p[5]),na(p[3],p[2],p[6]),na(p[0],p[3],p[7])],y}addShadowReceiver(t,n,c){this._receivers.add(t,o.d8.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function na(l,t,n){const c=o.av([],n,t),d=o.av([],l,t),p=o.bH([],c,d),m=o.ag(p);return m===0?[0,0,1,0]:(o.c4(p,p,1/m),[p[0],p[1],p[2],-o.bI(p,t)])}function Sf(l){const t=l.properties.get("direction"),n=o.d3(t.x,t.y,t.z);n[2]=o.aA(n[2],0,75);const c=o.d5([n[0],n[1],n[2]]);return o.d4(c.x,c.y,c.z)}function mo(l,t,n){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),m=t.properties.get("direction"),y=[m.x,m.y,m.z],x=n.properties.get("color-use-theme")==="none",T=n.properties.get("color"),S=n.properties.get("intensity"),M=Math.max(o.bI([0,0,1],y),0),E=[0,0,0];o.c4(E,T.toPremultipliedRenderColor(x?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),S);const P=[0,0,0];return o.c4(P,d.toPremultipliedRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),M*p),o.da([E[0]>0?E[0]/(E[0]+P[0]):0,E[1]>0?E[1]/(E[1]+P[1]):0,E[2]>0?E[2]/(E[2]+P[2]):0])}function Ef(l,t,n,c,d,p){const m=l.zoom,y=l.scale,x=l.worldSize,T=1/x,S=l.aspect,M=Math.sqrt(1+S*S)*Math.tan(.5*l.fovX),E=M*M,P=c-n,D=c+n;let O,V;E>P/D?(O=c,V=c*M):(O=.5*D*(1+E),V=.5*Math.sqrt(P*P+2*(c*c+n*n)*E+D*D*E*E));const N=l.projection.pixelsPerMeter(l.center.lat,x),j=l._camera.getCameraToWorldMercator(),Z=[0,0,-O*T];o.af(Z,Z,j);let H=V*T;const te=l._edgeInsets;if(!(te.left===0&&te.top===0&&te.right===0&&te.bottom===0||te.left===te.right&&te.top===te.bottom)){const je=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?N:1),rt=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);rt[8]=2*-l.centerOffset.x/l.width,rt[9]=2*l.centerOffset.y/l.height;const gt=new Float64Array(16);o.cO(gt,rt,je);const Xe=new Float64Array(16);o.bk(Xe,gt);const et=o.cA.fromInvProjectionMatrix(Xe,x,m,!0);for(const xt of et.points){const dt=((W=xt)[0]/=y,W[1]/=y,W[2]=o.ce(W[2],l._center.lat),W);H=Math.max(H,o.c5(o.d9([],Z,dt)))}}var W;H*=d/(d-1);const re=Math.acos(t[2]),ee=Math.atan2(-t[0],-t[1]),K=new Vc;K.position=Z,K.setPitchBearing(re,ee);const ne=K.getWorldToCamera(x,N),_e=H*x,fe=Math.min(l._mercatorZfromZoom(17)*x*-2,-2*_e),Me=K.getCameraToClipOrthographic(-_e,_e,-_e,_e,fe,(_e+p*N)/t[2]),we=new Float64Array(16);o.aB(we,Me,ne);const ze=o.d4(Math.floor(1e6*Z[0])/1e6*x,Math.floor(1e6*Z[1])/1e6*x,0),Je=.5*d,xe=[0,0,0];o.af(xe,ze,we),o.c4(xe,xe,Je);const ce=[Math.floor(xe[0]),Math.floor(xe[1]),Math.floor(xe[2])],Le=[0,0,0];o.av(Le,xe,ce),o.c4(Le,Le,-1/Je);const Te=new Float64Array(16);return o.bz(Te),o.bq(Te,Te,Le),o.aB(we,Te,we),[we,_e]}class Uc extends o.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,n){return o.db(this.requestManager.transformRequest(n,o.R.Model).url).then((c=>{if(!c)return;const d=o.dc(c),p=new o.dd(t,n,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p})).catch((c=>{if(c&&c.status===404)return null;this.fire(new o.y(new Error("Could not load model ".concat(t," from ").concat(n,": ").concat(c.message))))}))}load(t,n,c={forceReload:!1}){this.models[n]||(this.models[n]={});const d=Object.keys(t),p=[],m=[];for(const y of d){const x=t[y];this.hasURLBeenRequested(x)&&!c.forceReload||(this.modelByURL[x]={modelId:y,scope:n},p.push(this.loadModel(y,x)),m.push(y)),this.models[n][y]||(this.models[n][y]={model:null,numReferences:1})}this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+m.length,Promise.allSettled(p).then((y=>{for(let x=0;x<y.length;x++){const{status:T}=y[x];if(T==="rejected")continue;const{value:S}=y[x];this.models[n][m[x]]||(this.models[n][m[x]]={model:null,numReferences:1}),this.models[n][m[x]].model=S}this.numModelsLoading[n]-=m.length,this.fire(new o.z("data",{dataType:"style"}))})).catch((y=>{this.fire(new o.y(new Error("Could not load models: ".concat(y.message))))}))}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,n):this.getModelByURL(this.modelUris[n][t]))}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}getModelByURL(t){if(!t)return null;const n=this.modelByURL[t];return n?this.models[n.scope][n.modelId].model:null}hasModelBeenAdded(t,n){return this.models[n]&&this.models[n][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const d=this.requestManager.normalizeModelURL(n);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){const{scope:p,modelId:m}=this.modelByURL[d];this.models[p][m].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const d of t)this.hasModel(d,n,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[n][d].numReferences++:this.modelUris[n][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[n][d]:!this.hasURLBeenRequested(d)&&o.de(d,!1)&&(this.modelUris[n][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[n][d]);this.load(c,n)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,n,c=!1,d=!1){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,this.models[n][t].numReferences===0||d)){const p=this.modelUris[n][t];c||delete this.modelUris[n][t],delete this.modelByURL[p];const m=this.models[n][t].model;if(!m)return;delete this.models[n][t],m.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const n of Object.keys(this.models[t])){const c=this.models[t][n].model;delete this.models[t][n],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const rc=o.a6.colorTheme,sa=new o.a9({data:new o.aa(rc.data)});function bm(l){if(!l.metadata||!l.metadata.content_area)return;const t=o.o.devicePixelRatio,{left:n,top:c,width:d,height:p}=l.metadata.content_area,m=n*t,y=c*t;return[m,y,m+d*t,y+p*t]}function If(l){if(l)return l.map((([t,n])=>[t*o.o.devicePixelRatio,n*o.o.devicePixelRatio]))}class wm{constructor(t,n,c){this.id=t,this.scope=n,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const n=this.sourceCache.getVisibleCoordinates();if(n.length===0)return t;const c=this.sourceCache.getSource();if(!(c instanceof pn))return t;const d=n.map((m=>this.sourceCache.getTile(m))),p=c.getImages(d,Array.from(this.pendingRequests));for(const[m,y]of p)t.set(o.I.from({name:m,iconsetId:this.id}),y),this.pendingRequests.delete(m);for(const m of this.pendingRequests)this.missingRequests.add(m);return this.pendingRequests.clear(),t}}const oa=(l,t)=>F(l,t&&t.filter((n=>n.identifier!=="source.canvas"))),Tm=o.aH(Bi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),yh=o.aH(Bi,["setCenter","setZoom","setBearing","setPitch"]),jc=new Set(["background","sky","slot","custom"]),xh={version:8,layers:[],sources:{}},vh={duration:300,delay:0};class _o extends o.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=Object.assign({},vh),this._buildingIndex=new ch(this),this.crossTileSymbolIndex=new Go,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=n.styleChanges||new Vn,this.dispatcher=n.dispatcher?n.dispatcher:new o.D(o.dg(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new fs(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new o.dh(t._requestManager,n.localFontFamily?o.di.all:n.localIdeographFontFamily?o.di.ideographs:o.di.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new Uc(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._indoorDependentLayers=n.indoorDependentLayers?n.indoorDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",o.dj());const c=this;this._rtlTextPluginCallback=_o.registerForPluginStateChange((d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},((p,m)=>{if(o.dk(p),m&&m.every((y=>y)))for(const y in c._sourceCaches){const x=c._sourceCaches[y],T=x.getSource().type;T!=="vector"&&T!=="geojson"||x.reload()}}))})),this.on("data",(d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(const m in this._layers){const y=this._layers[m];y.source===p.id&&this._validateLayer(y)}}))}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(o.h(t))return t;const n=o.dl(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch(c){return n}return n}return"json://".concat(o.dm(JSON.stringify(t)))}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const d=(p,m)=>{try{m(null,this.setState(p,c))}catch(y){m(y,!1)}};if(typeof t=="string"){const p=this.map._requestManager.normalizeStyleURL(t),m=this.map._requestManager.transformRequest(p,o.R.Style);o.m(m,((y,x)=>{y?this.fire(new o.y(y)):x&&d(x,n)}))}else typeof t=="object"&&d(t,n)}loadURL(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"}));const c=typeof n.validate=="boolean"?n.validate:!o.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const p=this.map._requestManager.transformRequest(t,o.R.Style);this._request=o.m(p,((m,y)=>{if(this._request=null,m)this.fire(new o.y(m));else if(y)return this.importsCache.set(t,y),this._load(y,c)}))}loadJSON(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=o.o.frame((()=>{this._request=null,this._load(t,n.validate!==!1)}))}loadEmpty(){this.fire(new o.z("dataloading",{dataType:"style"})),this._load(xh,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const p of t){const m=this._createFragmentStyle(p),y=new Promise((S=>{m.once("style.import.load",S),m.once("error",S)})).then((()=>this.mergeAll()));if(d.push(y),this.resolvedImports.has(p.url)){m.loadEmpty();continue}const x=p.data||this.importsCache.get(p.url);x?(m.loadJSON(x,{validate:n}),this._isInternalStyle(x)&&(m.globalId=null)):p.url?m.loadURL(p.url,{validate:n}):m.loadEmpty();const T={style:m,id:p.id,config:p.config};if(c){const S=this.fragments.findIndex((({id:M})=>M===c));this.fragments=this.fragments.slice(0,S).concat(T).concat(this.fragments.slice(S))}else this.fragments.push(T)}return Promise.allSettled(d)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?o.B(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[n];(t.config||d)&&(c=Object.assign({},t.config,d));const p=new _o(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,n){if(this._isInternalStyle(t)){const p=Object.assign({},xh,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(p,n)}if(this.updateConfig(this._config,t.schema),n&&oa(this,jr(t)))return;this._loaded=!0,this.stylesheet=o.dn(t);const c=()=>{for(const x in t.sources)this.addSource(x,t.sources[x],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const x in t.iconsets)this.addIconset(x,t.iconsets[x]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const p=Za(this.stylesheet.layers);if(this._order=p.map((x=>x.id)),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const x=this.stylesheet.lights[0];this.light=new ae(x.properties,x.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ae(this.stylesheet.light)),this._layers={};for(const x of p){const T=o.dt(x,this.scope,this._styleColorTheme.lut,this.options);T.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(T.fqid),T.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(T.fqid),this._hasAppearances=this._hasAppearances||T.getAppearances().length!==0,T.setEventedParent(this,{layer:{id:T.id}}),this._layers[T.id]=T;const S=this.getOwnLayerSourceCache(T),M=!!this.directionalLight&&this.directionalLight.shadowsEnabled();S&&T.canCastShadows()&&M&&(S.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const m=this.stylesheet.terrain;m&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(m,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.z("data",{dataType:"style"}));const y=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then((()=>{this._reloadImports(),this.fire(new o.z(y?"style.load":"style.import.load"))})).catch((x=>{this.fire(new o.y(new Error("Failed to load imports",x))),this.fire(new o.z(y?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new o.z(y?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const d=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(d){const p=this._evaluateColorThemeData(d);this._loadColorTheme(p).then((()=>{c()})).catch((m=>{o.w("Couldn't load color theme from the stylesheet: ".concat(m)),c()}))}else this._styleColorTheme.lut=null,c()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances}mergeAll(){let t,n,c,d,p,m,y,x,T,S;const M={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((E=>{if(E.stylesheet){if(E.light!=null&&(t=E.light),E.stylesheet.lights)for(const P of E.stylesheet.lights)P.type==="ambient"&&E.ambientLight!=null&&(n=E.ambientLight),P.type==="directional"&&E.directionalLight!=null&&(c=E.directionalLight);d=this._prioritizeTerrain(d,E.terrain,E.stylesheet.terrain),E.stylesheet.fog&&E.fog!=null&&(p=E.fog),E.stylesheet.snow&&E.snow!=null&&(m=E.snow),E.stylesheet.rain&&E.rain!=null&&(y=E.rain),E.stylesheet.camera!=null&&(S=E.stylesheet.camera),E.stylesheet.projection!=null&&(x=E.stylesheet.projection),E.stylesheet.transition!=null&&(T=E.stylesheet.transition),M[E.scope]=E._styleColorTheme}})),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=p,this.snow=m,this.rain=y,this._styleColorThemeForScope=M,d===null?delete this.terrain:this.terrain=d,this.camera=S||{"camera-projection":"perspective"},this.projection=x||{name:"mercator"},this.transition=Object.assign({},vh,T),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(t){const n=c=>{for(const d of c.fragments)n(d.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const d=t&&t.drapeRenderMode===0;return c===null?n&&n.drapeRenderMode===0?n:d?t:null:n!=null&&(!t||d||n&&n.drapeRenderMode===1)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)})),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle((n=>{n.stylesheet.projection!=null&&(t=n.stylesheet.projection)})),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle((d=>{for(const p in d._sourceCaches){const m=o.B(p,d.scope);t[m]=d._sourceCaches[p]}for(const p in d._otherSourceCaches){const m=o.B(p,d.scope);n[m]=d._otherSourceCaches[p]}for(const p in d._symbolSourceCaches){const m=o.B(p,d.scope);c[m]=d._symbolSourceCaches[p]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeIndoor(){this.forEachFragmentStyle((t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const n of Object.values(t.stylesheet.indoor)){const c=n,d=o.B(c.sourceId,t.scope);this._mergedIndoor[d]=new Set(c.sourceLayers||[])}}))}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((m=>{for(const y of m._order){const x=m._layers[y];if(x.type==="slot"){const T=o.dp(y);if(t[T])continue;t[T]=[]}x.slot&&t[x.slot]?t[x.slot].push(x):n.push(x)}})),this._mergedOrder=[];let d=-1;const p=(m=[])=>{for(const y of m)if(y.type==="slot"){const x=o.dp(y.id);t[x]&&p(t[x]),this._mergedSlots.push(x)}else{const x=o.B(y.id,y.scope);this._mergedOrder.push(x),c[x]=y,y.is3D(!!this.terrain)&&(this._has3DLayers=!0,d=this._mergedOrder.length-1),y.type==="circle"&&(this._hasCircleLayers=!0),y.type==="symbol"&&(this._hasSymbolLayers=!0),y.type==="clip"&&(this._clipLayerPresent=!0)}};if(p(n),this._has3DLayers){const m={};for(let y=0;y<this._mergedOrder.length;++y){const x=this._mergedOrder[y];m[x]=y===d?1:y<d?c[x].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort(((y,x)=>m[y]-m[x]))}this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?(function(n,c,d,p){const m=Object.assign({},c);for(const x of Object.keys(rc))m[x]===void 0&&(m[x]=rc[x].default);const y=new o.a8(sa,n,new Map(d));return y.setTransitionOrValue(m,d),y.untransitioned().possiblyEvaluate(new o.ac(0,{worldview:void 0}))})(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((c,d)=>{const p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let m=t;m.startsWith(p)||(m=p+m);const y=o.I.from("mapbox-reserved-lut"),x=new Image;x.src=m,x.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},x.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:T,height:S,data:M}=o.o.getImageData(x);if(S>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(T!==S*S)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(y)&&this.removeImage(y),this.addImage(y,{data:new o.q({width:T,height:S},M),pixelRatio:1,sdf:!1,usvg:!1,version:0});const E=this.imageManager.getImage(y,this.scope);E?(this._styleColorTheme.lut={image:E.data,data:t},c()):d(new Error("Missing LUT image."))}}))}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=(function(n,c,d){let p,m,y;const x=o.o.devicePixelRatio>1?"@2x":"";let T=o.m(c.transformRequest(c.normalizeSpriteURL(n,x,".json"),o.R.SpriteJSON),((E,P)=>{T=null,y||(y=E,p=P,M())})),S=o.n(c.transformRequest(c.normalizeSpriteURL(n,x,".png"),o.R.SpriteImage),((E,P)=>{S=null,y||(y=E,m=P,M())}));function M(){if(y)d(y);else if(p&&m){const E=o.o.getImageData(m),P={};for(const D in p){const{width:O,height:V,x:N,y:j,sdf:Z,pixelRatio:H,stretchX:te,stretchY:W,content:re}=p[D],ee=new o.q({width:O,height:V});o.q.copy(E,ee,{x:N,y:j},{x:0,y:0},{width:O,height:V},null),P[D]={data:ee,pixelRatio:H!==void 0?H:1,sdf:Z!==void 0&&Z,stretchX:te,stretchY:W,content:re,usvg:!1,version:0}}d(null,P)}}return{cancel(){T&&(T.cancel(),T=null),S&&(S.cancel(),S=null)}}})(t,this.map._requestManager,((n,c)=>{if(this._spriteRequest=null,n)this.fire(new o.y(n));else if(c){const d=new Map;for(const p in c)d.set(o.I.from(p),c[p]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))}))}addIconset(t,n){if(n.type==="sprite")return void this._loadSprite(n.url);const c=this.getOwnSourceCache(n.source);if(!c)return void this.fire(new o.y(new Error('Source "'.concat(n.source,'" as specified by iconset "').concat(t,'" does not exist and cannot be used as an iconset source'))));const d=c.getSource();if(d.type!=="raster-array")return void this.fire(new o.y(new Error('Source "'.concat(n.source,'" as specified by iconset "').concat(t,'" is not a "raster-array" source and cannot be used as an iconset source'))));d.partial=!1;const p=new wm(t,this.scope,c);this.imageManager.addImageProvider(p,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!o.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const n=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,m)=>{if(this._spriteRequest=null,p)n?this._loadSprite(t):this.fire(new o.y(p));else if(m){const y=new Map;for(const x in m)y.set(o.I.from(x),m[x]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))},o.bt((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),o.R.Iconset),((p,m)=>{if(p)return void d(p);const y={},x=o.df(new o.bs(m));for(const T of x.icons){const S={version:1,pixelRatio:o.o.devicePixelRatio,content:bm(T),stretchX:T.metadata?If(T.metadata.stretch_x_areas):void 0,stretchY:T.metadata?If(T.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:T};y[T.name]=S}d(null,y)})))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&(n.type==="geojson"||n.vectorLayerIds&&n.vectorLayerIds.indexOf(c)===-1)&&this.fire(new o.y(new Error('Source layer "'.concat(c,'" does not exist on source "').concat(n.id,'" as specified by style layer "').concat(t.id,'"'))))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t}))}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&n.push(d.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new o.y(new Error("The layer '".concat(t,"' does not exist in the map's style."))))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new o.y(new Error("The source '".concat(t,"' does not exist in the map's style."))))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const p=t.getProgramIds();if(p)for(const m of p){const y=t.getDefaultProgramParams(m,n.zoom,this._styleColorTheme.lut);y&&(c.style=this,this.fog&&(c._fogVisible=!0,y.overrideFog=!0,c.getOrCreateProgram(m,y)),c._fogVisible=!1,y.overrideFog=!1,c.getOrCreateProgram(m,y),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(y.overrideRtt=!0,c.getOrCreateProgram(m,y)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const y=this._changes.getLayerUpdatesByScope();for(const x in y){const{updatedIds:T,removedIds:S}=y[x];(T||S)&&(this._updateWorkerLayers(x,T,S),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const p={};for(const y in this._mergedSourceCaches){const x=this._mergedSourceCaches[y];p[y]=x.used,x.used=!1,x.tileCoverLift=0}for(const y of this._mergedOrder){const x=this._mergedLayers[y];if(x.recalculate(t,this._availableImages),!x.isHidden(t.zoom)){const T=this.getLayerSourceCache(x);T&&(T.used=!0,T.tileCoverLift=Math.max(T.tileCoverLift,x.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(x,t)})):this.precompilePrograms(x,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();const m=this.imageManager.getPendingImageProviders();for(const y of m)y.sourceCache.used=!0;for(const y in p){const x=this._mergedSourceCaches[y];p[y]!==x.used&&x.getSource().fire(new o.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:x.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new o.z("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const n of t){const c=n.resolvePendingRequests(),d=this.getFragmentStyle(n.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){const t={};for(const n in this._mergedSourceCaches){const c=this._mergedSourceCaches[n].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t[c])}for(const n in t)this._changes.resetUpdatedImages(n)}_updateWorkerLayers(t,n,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:n?d._serializeLayers(n):[],scope:t,removedIds:c||[],options:d.options})}setState(t,n){if(this._checkLoaded(),oa(this,jr(t)))return!1;(t=o.dn(t)).layers=Za(t.layers);const c=(function(m,y){if(!m)return[{command:Bi.setStyle,args:[y]}];let x=[];try{if(!o.bx(m.version,y.version))return[{command:Bi.setStyle,args:[y]}];if(o.bx(m.center,y.center)||x.push({command:Bi.setCenter,args:[y.center]}),o.bx(m.zoom,y.zoom)||x.push({command:Bi.setZoom,args:[y.zoom]}),o.bx(m.bearing,y.bearing)||x.push({command:Bi.setBearing,args:[y.bearing]}),o.bx(m.pitch,y.pitch)||x.push({command:Bi.setPitch,args:[y.pitch]}),o.bx(m.sprite,y.sprite)||x.push({command:Bi.setSprite,args:[y.sprite]}),o.bx(m.glyphs,y.glyphs)||x.push({command:Bi.setGlyphs,args:[y.glyphs]}),o.bx(m.imports,y.imports)||(function(P=[],D=[],O){D=D||[];const V=(P=P||[]).map(Hl),N=D.map(Hl),j=P.reduce(ql,{}),Z=D.reduce(ql,{}),H=V.slice();let te,W,re,ee;for(te=0,W=0;te<V.length;te++)re=V[te],Z.hasOwnProperty(re)?W++:(O.push({command:Bi.removeImport,args:[re]}),H.splice(H.indexOf(re,W),1));for(te=0,W=0;te<N.length;te++)re=N[N.length-1-te],H[H.length-1-te]!==re&&(j.hasOwnProperty(re)?(O.push({command:Bi.removeImport,args:[re]}),H.splice(H.lastIndexOf(re,H.length-W),1)):W++,ee=H[H.length-te],O.push({command:Bi.addImport,args:[Z[re],ee]}),H.splice(H.length-te,0,re));for(const K of D){const ne=j[K.id];ne&&(delete ne.data,o.bx(ne,K)||O.push({command:Bi.updateImport,args:[K.id,K]}))}})(m.imports,y.imports,x),o.bx(m.transition,y.transition)||x.push({command:Bi.setTransition,args:[y.transition]}),o.bx(m.light,y.light)||x.push({command:Bi.setLight,args:[y.light]}),o.bx(m.fog,y.fog)||x.push({command:Bi.setFog,args:[y.fog]}),o.bx(m.snow,y.snow)||x.push({command:Bi.setSnow,args:[y.snow]}),o.bx(m.rain,y.rain)||x.push({command:Bi.setRain,args:[y.rain]}),o.bx(m.projection,y.projection)||x.push({command:Bi.setProjection,args:[y.projection]}),o.bx(m.lights,y.lights)||x.push({command:Bi.setLights,args:[y.lights]}),o.bx(m.camera,y.camera)||x.push({command:Bi.setCamera,args:[y.camera]}),o.bx(m.iconsets,y.iconsets)||(function(P,D,O){let V;for(V in D=D||{},P=P||{})P.hasOwnProperty(V)&&(D.hasOwnProperty(V)||O.push({command:Bi.removeIconset,args:[V]}));for(V in D){if(!D.hasOwnProperty(V))continue;const N=D[V];P.hasOwnProperty(V)?o.bx(P[V],N)||(O.push({command:Bi.removeIconset,args:[V]}),O.push({command:Bi.addIconset,args:[V,N]})):O.push({command:Bi.addIconset,args:[V,N]})}})(m.iconsets,y.iconsets,x),!o.bx(m["color-theme"],y["color-theme"]))return[{command:Bi.setStyle,args:[y]}];const T={},S=[];(function(P,D,O,V){let N;for(N in D=D||{},P=P||{})P.hasOwnProperty(N)&&(D.hasOwnProperty(N)||Ul(N,O,V));for(N in D){if(!D.hasOwnProperty(N))continue;const j=D[N];P.hasOwnProperty(N)?o.bx(P[N],j)||(P[N].type==="geojson"&&j.type==="geojson"&&hh(P,D,N)?O.push({command:Bi.setGeoJSONSourceData,args:[N,j.data]}):jl(N,D,O,V)):uh(N,D,O)}})(m.sources,y.sources,S,T);const M=[];m.layers&&m.layers.forEach((P=>{P.source&&T[P.source]?x.push({command:Bi.removeLayer,args:[P.id]}):M.push(P)}));let E=m.terrain;E&&T[E.source]&&(x.push({command:Bi.setTerrain,args:[void 0]}),E=void 0),x=x.concat(S),o.bx(E,y.terrain)||x.push({command:Bi.setTerrain,args:[y.terrain]}),(function(P,D,O){D=D||[];const V=(P=P||[]).map(Hl),N=D.map(Hl),j=P.reduce(ql,{}),Z=D.reduce(ql,{}),H=V.slice(),te=Object.create(null);let W,re,ee,K,ne,_e,fe;for(W=0,re=0;W<V.length;W++)ee=V[W],Z.hasOwnProperty(ee)?re++:(O.push({command:Bi.removeLayer,args:[ee]}),H.splice(H.indexOf(ee,re),1));for(W=0,re=0;W<N.length;W++)ee=N[N.length-1-W],H[H.length-1-W]!==ee&&(j.hasOwnProperty(ee)?(O.push({command:Bi.removeLayer,args:[ee]}),H.splice(H.lastIndexOf(ee,H.length-re),1)):re++,_e=H[H.length-W],O.push({command:Bi.addLayer,args:[Z[ee],_e]}),H.splice(H.length-W,0,ee),te[ee]=!0);for(W=0;W<N.length;W++)if(ee=N[W],K=j[ee],ne=Z[ee],!te[ee]&&!o.bx(K,ne))if(o.bx(K.source,ne.source)&&o.bx(K["source-layer"],ne["source-layer"])&&o.bx(K.type,ne.type)){for(fe in Gl(K.layout,ne.layout,O,ee,null,Bi.setLayoutProperty),Gl(K.paint,ne.paint,O,ee,null,Bi.setPaintProperty),o.bx(K.slot,ne.slot)||O.push({command:Bi.setSlot,args:[ee,ne.slot]}),o.bx(K.filter,ne.filter)||O.push({command:Bi.setFilter,args:[ee,ne.filter]}),o.bx(K.minzoom,ne.minzoom)&&o.bx(K.maxzoom,ne.maxzoom)||O.push({command:Bi.setLayerZoomRange,args:[ee,ne.minzoom,ne.maxzoom]}),K)K.hasOwnProperty(fe)&&fe!=="layout"&&fe!=="paint"&&fe!=="filter"&&fe!=="metadata"&&fe!=="minzoom"&&fe!=="maxzoom"&&fe!=="slot"&&(fe.indexOf("paint.")===0?Gl(K[fe],ne[fe],O,ee,fe.slice(6),Bi.setPaintProperty):o.bx(K[fe],ne[fe])||O.push({command:Bi.setLayerProperty,args:[ee,fe,ne[fe]]}));for(fe in ne)ne.hasOwnProperty(fe)&&!K.hasOwnProperty(fe)&&fe!=="layout"&&fe!=="paint"&&fe!=="filter"&&fe!=="metadata"&&fe!=="minzoom"&&fe!=="maxzoom"&&fe!=="slot"&&(fe.indexOf("paint.")===0?Gl(K[fe],ne[fe],O,ee,fe.slice(6),Bi.setPaintProperty):o.bx(K[fe],ne[fe])||O.push({command:Bi.setLayerProperty,args:[ee,fe,ne[fe]]}))}else O.push({command:Bi.removeLayer,args:[ee]}),_e=H[H.lastIndexOf(ee)+1],O.push({command:Bi.addLayer,args:[ne,_e]})})(M,y.layers,x)}catch(T){console.warn("Unable to compute style diff:",T),x=[{command:Bi.setStyle,args:[y]}]}return x})(this.serialize(),t).filter((m=>!(m.command in yh)));if(c.length===0)return!1;const d=c.filter((m=>!(m.command in Tm)));if(d.length>0)throw new Error("Unimplemented: ".concat(d.map((m=>m.command)).join(", "),"."));const p=[];return c.forEach((m=>{p.push(this[m.command](...m.args))})),n&&Promise.all(p).then(n).catch(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[n,c]of t.entries()){if(this.getImage(n))return this.fire(new o.y(new Error('An image with the name "'.concat(n.name,'" already exists.'))));this.imageManager.addImage(n,this.scope,c),this._changes.updateImage(n,this.scope)}return this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this}addImage(t,n){return this.getImage(t)?this.fire(new o.y(new Error('An image with the name "'.concat(t.name,'" already exists.')))):(this.imageManager.addImage(t,this.scope,n),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new o.z("data",{dataType:"style"})),this}addModel(t,n,c={}){return this._checkLoaded(),this._validate(xs,"models.".concat(t),n,null,c)||(this.modelManager.addModel(t,n,this.scope),this.fire(new o.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new o.z("data",{dataType:"style"})),this):this.fire(new o.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error('There is already a source with ID "'.concat(t,'".'));if(!n.type)throw new Error("The type property must be defined, but only the following properties were given: ".concat(Object.keys(n).join(", "),"."));if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(In,"sources.".concat(t),n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=es(t,n,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id})));const p=m=>{const y=(m?"symbol:":"other:")+d.id,x=o.B(y,this.scope),T=this._sourceCaches[y]=new Fs(x,d,m);(m?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=T,T.onAdd(this.map)};p(!1),n.type!=="vector"&&n.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new o.y(new Error('Source "'.concat(t,'" cannot be removed while layer "').concat(d,'" is using it.'))));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new o.y(new Error('Source "'.concat(t,'" cannot be removed while terrain is using it.'))));if(this.stylesheet.iconsets){const d=Object.entries(this.stylesheet.iconsets).find((([p,m])=>m.type==="source"&&m.source===t));if(d)return this.fire(new o.y(new Error('Source "'.concat(t,'" cannot be removed while iconset "').concat(d[0],'" is using it.'))))}const c=this.getOwnSourceCaches(t);for(const d of c){const p=o.dp(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new o.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const d in c){const p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const p of t){if(this._validate(Ln,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){const m=this.ambientLight;m.set(p),m.updateTransitions(n)}else this.ambientLight=new Er(p,Fi||(Fi=new o.a9({color:new o.aa(o.a6.properties_light_ambient.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const m=this.directionalLight;m.set(p),m.updateTransitions(n)}else this.directionalLight=new Er(p,Sr||(Sr=new o.a9({direction:new o.ap(o.a6.properties_light_directional.direction),color:new o.aa(o.a6.properties_light_directional.color),"color-use-theme":new o.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.aa(o.a6.properties_light_directional.intensity),"cast-shadows":new o.aa(o.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new o.aa(o.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.aa(o.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=Object.assign(n,{worldview:this.map.getWorldview()}),d=new o.ac(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=E=>.2126*(E[0]<=.03928?E[0]/12.92:Math.pow((E[0]+.055)/1.055,2.4))+.7152*(E[1]<=.03928?E[1]/12.92:Math.pow((E[1]+.055)/1.055,2.4))+.0722*(E[2]<=.03928?E[2]/12.92:Math.pow((E[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=t.properties.get("intensity"),m=t.properties.get("direction"),y=1-o.d3(m.x,m.y,m.z)[2]/90,x=c(d)*p*y,T=n.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),S=n.properties.get("intensity"),M=c(T)*S;return Number(((x+M)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(o.dq(t)){const n=o.dr(t),c=this.fragments.find((({id:p})=>p===n));if(!c)return;const d=o.dp(t);return c.style.getFragmentStyle(d)}{const n=this.fragments.find((({id:c})=>c===t));return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(d,p="")=>"".concat(d,"::").concat(p);this._featuresetSelectors={};for(const d in t){const p=this._featuresetSelectors[d]=[];for(const m of t[d].selectors){if(m.featureNamespace){const x=this.getOwnLayer(m.layer);if(!x){o.w("Layer is undefined for selector: ".concat(m.layer));continue}const T=c(x.source,x.sourceLayer);if(T in n&&n[T]!==m.featureNamespace){o.w('"featureNamespace '.concat(m.featureNamespace," of featureset ").concat(d,"'s selector is not associated to the same source, skip this selector"));continue}n[T]=m.featureNamespace}let y;if(m.properties)for(const x in m.properties){const T=o.U(m.properties[x]);T.result==="success"&&(y=y||{},y[x]=T.value)}p.push({layerId:m.layer,namespace:m.featureNamespace,properties:y,uniqueFeatureID:m._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const d in n.stylesheet.featuresets)c.push({featuresetId:d,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new o.y(new Error("The featureset '".concat(t,"' does not exist in the map's style and cannot be queried.")))),[];const p=[];for(const m of d[t].selectors){const y=c.getOwnLayer(m.layer);y&&p.push(y)}return p}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const d=o.B(n,c.scope),p=c.options.get(d),m=p?p.value||p.default:null;return m?m.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,n){const c=o.B(t,n);return this._mergedIndoor[c]}setIndoorData(t,n){this.map.indoor.setIndoorData(n)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,n,c){const d=this.getFragmentStyle(t);if(!d)return;const p=d.stylesheet.schema;if(!p||!p[n])return;const m=o.U(c);if(m.result!=="success")return void oa(this,m.value);const y=m.value.expression,x=o.B(n,d.scope),T=d.options.get(x);if(!T)return;let S;const{minValue:M,maxValue:E,stepValue:P,type:D,values:O}=p[n],V=o.U(p[n].default);V.result==="success"&&(S=V.value.expression),S?(this.options.set(x,Object.assign({},T,{value:y,default:S,minValue:M,maxValue:E,stepValue:P,type:D,values:O})),this.updateConfigDependencies(n)):this.fire(new o.y(new Error('No schema defined for the config option "'.concat(n,'" in the "').concat(t,'" fragment.'))))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const d={};for(const p in c){const m=o.B(p,n.scope),y=n.options.get(m),x=y?y.value||y.default:null;d[p]=x?x.serialize():null}return d}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let d,p;const m=o.U(n[c].default);if(m.result==="success"&&(d=m.value.expression),t&&t[c]!==void 0){const E=o.U(t[c]);E.result==="success"&&(p=E.value.expression)}const{minValue:y,maxValue:x,stepValue:T,type:S,values:M}=n[c];if(d){const E=o.B(c,this.scope);this.options.set(E,{default:d,value:p,minValue:y,maxValue:x,stepValue:T,type:S,values:M})}else this.fire(new o.y(new Error('No schema defined for config option "'.concat(c,'".'))))}else this.fire(new o.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(t,n=(()=>!0)){for(const c of t){const d=this.getLayer(c);d&&n(d)&&(d.possiblyEvaluateVisibility(),this._updateLayer(d),this._changes.setDirty())}}updateConfigDependencies(t){this._updateLayers(this._configDependentLayers,(n=>!t||n.expressionDependencies.configDependencies.has(t))),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const d=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&d!==""||n._styleColorTheme.lut&&d!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}})),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new o.y(new Error('Layer with id "'.concat(d,'" already exists on this map'))));let p;if(t.type==="custom"){if(oa(this,o.ds(t)))return;p=o.dt(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=o.dn(t),t=Object.assign(t,{source:d})),this._validate(as,"layers.".concat(d),t,{arrayIndex:-1},c))return;p=o.dt(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}const m=o.B(p.source,p.scope);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(m),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(m);let y=this._order.length;if(n){const M=this._order.indexOf(n);if(M===-1)return void this.fire(new o.y(new Error('Layer with id "'.concat(n,'" does not exist on this map.'))));p.slot===this._layers[n].slot?y=M:o.w('Layer with id "'.concat(n,'" has a different slot. Layers can only be rearranged within the same slot.'))}this._order.splice(y,0,d),this._layerOrderChanged=!0,this._layers[d]=p;const x=this.getOwnLayerSourceCache(p),T=!!this.directionalLight&&this.directionalLight.shadowsEnabled();x&&p.canCastShadows()&&T&&(x.castsShadows=!0);const S=this._changes.getRemovedLayer(p);if(S&&p.source&&x&&p.type!=="custom"){this._changes.discardLayerRemoval(p);const M=o.B(p.source,p.scope);S.type!==p.type?this._changes.updateSourceCache(M,"clear"):(this._changes.updateSourceCache(M,"reload"),x.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(n){const m=this._order.indexOf(n);if(m===-1)return void this.fire(new o.y(new Error('Layer with id "'.concat(n,'" does not exist on this map.'))));c.slot===this._layers[n].slot?p=m:o.w('Layer with id "'.concat(n,'" has a different slot. Layers can only be rearranged within the same slot.'))}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._indoorDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const d=this.getOwnLayerSourceCache(n);if(d&&d.castsShadows){let p=!1;for(const m in this._layers)if(this._layers[m].source===n.source&&this._layers[m].canCastShadows()){p=!0;break}d.castsShadows=p}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!o.bx(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Qt,"layers.".concat(d.id,".filter"),n,{layerType:d.type},c)||(d.filter=o.dn(n),this._updateLayer(d)))}getFilter(t){const n=this._checkLayer(t);if(n)return o.dn(n.filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!o.bx(p.getLayoutProperty(n),c)){if(c!=null&&(!d||d.validate!==!1)&&oa(p,ks.call(jr,{key:"layers.".concat(t,".layout.").concat(n),layerType:p.type,objectKey:n,value:c,styleSpec:o.a6,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(n,c),p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),this._updateLayer(p)}}setLayerProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);p&&(n==="appearances"?(p.setAppearances(c),this._changes.setDirty()):p.isPaintProperty(n)?this.setPaintProperty(t,n,c,d):this.setLayoutProperty(t,n,c,d))}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(!p||o.bx(p.getPaintProperty(n),c)||c!=null&&(!d||d.validate!==!1)&&oa(p,Qr.call(jr,{key:"layers.".concat(t,".paint.").concat(n),layerType:p.type,objectKey:n,value:c,styleSpec:o.a6})))return;const m=p.setPaintProperty(n,c);p.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),p.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(p.fqid),m&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:x,importId:T}=t.target,S=this.getFragmentStyle(T),M=S.getFeaturesetLayers(x);for(const{source:E,sourceLayer:P}of M)S.setFeatureState({id:t.id,source:E,sourceLayer:P},n)}else if("layerId"in t.target){const{layerId:x}=t.target,T=this.getLayer(x);this.setFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;const m=p.type;if(m==="geojson"&&d)return void this.fire(new o.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(m==="vector"&&!d)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided.")));const y=this.getOwnSourceCaches(c);for(const x of y)x.setFeatureState(d,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:x,importId:T}=t.target,S=this.getFragmentStyle(T),M=S.getFeaturesetLayers(x);for(const{source:E,sourceLayer:P}of M)S.removeFeatureState({id:t.id,source:E,sourceLayer:P},n)}else if("layerId"in t.target){const{layerId:x}=t.target,T=this.getLayer(x);this.removeFeatureState({id:t.id,source:T.source,sourceLayer:T.sourceLayer},n)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const p=d.type,m=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!m)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new o.y(new Error("A feature id is required to remove its specific state property.")));const y=this.getOwnSourceCaches(c);for(const x of y)x.removeFeatureState(m,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){const{featuresetId:m,importId:y}=t.target,x=this.getFragmentStyle(y),T=x.getFeaturesetLayers(m);for(const{source:S,sourceLayer:M}of T){const E=x.getFeatureState({id:t.id,source:S,sourceLayer:M});if(E&&!p)p=E;else if(!o.bx(p,E))return void this.fire(new o.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:m}=t.target,y=this.getLayer(m);p=this.getFeatureState({id:t.id,source:y.source,sourceLayer:y.sourceLayer})}return p}const n=t.source,c=t.sourceLayer,d=this._checkSource(n);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new o.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return o.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(c=>c!==void 0))}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=o.B(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&n&&n.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=y=>this._mergedLayers[y].is3D(!!this.terrain),c=this.order,d={},p=[];for(let y=c.length-1;y>=0;y--){const x=c[y];if(n(x)){d[x]=y;for(const T of t){const S=T[x];if(S)for(const M of S)p.push(M)}}}p.sort(((y,x)=>x.intersectionZ-y.intersectionZ));const m=[];for(let y=c.length-1;y>=0;y--){const x=c[y];if(n(x))for(let T=p.length-1;T>=0;T--){const S=p[T].feature;if(S.layer&&d[S.layer.id]<y)break;m.push(S),p.pop()}else for(const T of t){const S=T[x];if(S)for(const M of S)m.push(M.feature)}}return m}queryRasterValue(t,n,c){const d=this.getOwnSource(t);return d?d.type!=="raster-array"?(this.fire(new o.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):d.queryRasterArrayValue(n,c):(this.fire(new o.y(new Error('Source with id "'.concat(t,'" does not exist in the style.')))),Promise.resolve(null))}queryRenderedFeatures(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Qt,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b5(n.filter));const p={},m=S=>{if(jc.has(S.type))return;const M=this.getOwnLayerSourceCache(S),E=p[M.id]=p[M.id]||{sourceCache:M,layers:{},has3DLayers:!1};S.is3D(!!this.terrain)&&(E.has3DLayers=!0),E.layers[S.fqid]=E.layers[S.fqid]||{styleLayer:S,targets:[]},E.layers[S.fqid].targets.push({filter:d})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new o.y(new Error("parameters.layers must be an Array."))),[];for(const S of n.layers){const M=this._layers[S];if(!M)return this.fire(new o.y(new Error("The layer '".concat(S,"' does not exist in the map's style and cannot be queried for features.")))),[];m(M)}}else for(const S in this._layers)m(this._layers[S]);const y=this._queryRenderedFeatures(t,p,c),x=this._flattenAndSortRenderedFeatures(y),T=[];for(const S of x)o.dv(S.layer.id)===this.scope&&T.push(S);return T}queryRenderedFeatureset(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Qt,"queryRenderedFeatures.filter",n.filter,null,n),d=o.b5(n.filter));const p="mock",m=[];if(n&&n.target)m.push(Object.assign({},n,{targetId:p,filter:d}));else{const S=this.getFeaturesetDescriptors();for(const M of S)m.push({targetId:p,filter:d,target:M});for(const{style:M}of this.fragments){const E=M.getFeaturesetDescriptors();for(const P of E)m.push({targetId:p,filter:d,target:P})}}const y=this.queryRenderedTargets(t,m,c),x=[],T=new Set;for(const S of y)for(const M of S.variants[p])Ut(M,S,T)||x.push(new o.dw(S,M));return x}queryRenderedTargets(t,n,c){const d={},p=(y,x,T,S)=>{const M=d[x.id]=d[x.id]||{sourceCache:x,layers:{},has3DLayers:!1};if(M.layers[y.fqid]=M.layers[y.fqid]||{styleLayer:y,targets:[]},y.is3D(!!this.terrain)&&(M.has3DLayers=!0),!S)return T.uniqueFeatureID=!1,void M.layers[y.fqid].targets.push(T);M.layers[y.fqid].targets.push(Object.assign({},T,{namespace:S.namespace,properties:S.properties,uniqueFeatureID:S.uniqueFeatureID}))};for(const y of n)if("featuresetId"in y.target){const{featuresetId:x,importId:T}=y.target,S=this.getFragmentStyle(T);if(!S||!S._featuresetSelectors)continue;const M=S._featuresetSelectors[x];if(!M){this.fire(new o.y(new Error("The featureset '".concat(x,"' does not exist in the map's style and cannot be queried for features."))));continue}for(const E of M){const P=S.getOwnLayer(E.layerId);P&&!jc.has(P.type)&&p(P,S.getOwnLayerSourceCache(P),y,E)}}else if("layerId"in y.target){const{layerId:x}=y.target,T=this.getLayer(x);if(!T||jc.has(T.type))continue;p(T,this.getLayerSourceCache(T),y)}const m=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(m)}_queryRenderedFeatures(t,n,c){const d=[],p=!!this.map._showQueryGeometry,m=Ai.createFromScreenPoints(t,c);for(const y in n){const x=Mi(m,n[y],this._availableImages,c,p);Object.keys(x).length&&d.push(x)}if(this.placement)for(const y in n){if(!n[y].sourceCache._onlySymbols)continue;const x=ji(m.screenGeometry,n[y],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(x).length&&d.push(x)}return d}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(Qt,"querySourceFeatures.filter",c,null,n);let d=[];const p=this.getOwnSourceCaches(t);for(const m of p)d=d.concat(mr(m,n));return d}addSourceType(t,n,c){return _o.getSourceType(t)?c(new Error('A source type called "'.concat(t,'" already exists.'))):(_o.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const d=this.light.getLight();let p=!1;for(const y in t)if(!o.bx(t[y],d[y])){p=!0;break}if(!p)return;const m=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(m)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=o.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),n===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=t.source==null;if(n===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const y="terrain-dem-src";this.addSource(y,c.source),c=o.dn(c),c=Object.assign(c,{source:y})}const p=Object.assign({},c),m={};if(this.terrain&&d){p.source=this.terrain.get().source;const y=this.terrain?this.getFragmentStyle(this.terrain.scope):null;y&&(m.style=y.serialize())}if(this._validate(bn,"terrain",p,m))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new o.z("data",{dataType:"style"}))}else{const p=this.terrain,m=p.get();for(const y of Object.keys(o.a6.terrain))!c.hasOwnProperty(y)&&o.a6.terrain[y].default&&(c[y]=o.a6.terrain[y].default);for(const y in t)if(!o.bx(t[y],m[y])){p.set(t,this.options),this.stylesheet.terrain=t;const x=this._getTransitionParameters({duration:0});p.updateTransitions(x),this.fire(new o.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Mt(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new en(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new Dr(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask((()=>{for(const t of this.map._markers)t._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!o.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!o.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!o.bx(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then((()=>{this.fire(new o.z("colorthemeset")),t()})).catch((d=>{o.w("Couldn't set color theme: ".concat(d))}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:o.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new de(t,n,this.scope,this.options,this.map.getWorldview());n===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="fill-extrusion"&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="symbol"&&this._updateLayer(n)}}_validate(t,n,c,d,p={}){if(p&&p.validate===!1)return!1;const m=Object.assign({},this.serialize());return oa(this,t.call(jr,Object.assign({key:n,style:m,value:c,styleSpec:o.a6},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const n=this._mergedLayers[t];n._clear&&n._clear()}}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((t=>{t.modelManager.reloadModels(t.scope)}))}updateSources(t){let n;this.directionalLight&&(n=Sf(this.directionalLight));const c=new Set;for(const d in this._mergedLayers){const p=this._mergedLayers[d];p.hasElevation()&&!c.has(p.source)&&c.add(p.source)}for(const d in this._mergedSourceCaches){const p=this._mergedSourceCaches[d],m=c.has(p._source.id);p.update(t,void 0,void 0,n,m)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,d,p,m,y=!1){let x=!1,T=!1;const S={},M={};for(const E of this._mergedOrder){const P=this._mergedLayers[E];if(P.type!=="symbol")continue;const D=o.B(P.source,P.scope);let O=S[D];if(!O){const N=this.getLayerSourceCache(P);if(!N)continue;const j=N.getRenderableIds(!0).map((Z=>N.getTileByID(Z)));M[D]=j.slice(),O=S[D]=j.sort(((Z,H)=>H.tileID.overscaledZ-Z.tileID.overscaledZ||(Z.tileID.isLessThan(H.tileID)?-1:1)))}const V=this.crossTileSymbolIndex.addLayer(P,O,n.center.lng,n.projection);x=x||V}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),y=y||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new o.z("neworder")),(y||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.o.now(),n.zoom))&&(this.pauseablePlacement=new Cs(n,this._mergedOrder,y,c,d,p,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,S,M,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.o.now()),T=!0),x&&this.pauseablePlacement.placement.setStale()),T||x){this._buildingIndex.onNewFrame(n.zoom);for(let E=0;E<this._mergedOrder.length;E++){const P=this._mergedLayers[this._mergedOrder[E]];if(P.type!=="symbol")continue;const D=this.isLayerClipped(P);this.placement.updateLayerOpacities(P,S[o.B(P.source,P.scope)],E,D?m:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.o.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex((({id:p})=>p===t.id))!==-1)return void this.fire(new o.y(new Error("Import with id '".concat(t.id,"' already exists in the map's style."))));if(!n)return c.push(t),this._loadImports([t],!0);const d=c.findIndex((({id:p})=>p===n));return d===-1&&this.fire(new o.y(new Error('Import with id "'.concat(n,'" does not exist on this map.')))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof n=="string"?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[d].url&&this.setImportUrl(t,n.url),o.bx(n.config,c[d].config)||this.setImportConfig(t,n.config,n.data.schema),o.bx(n.data,c[d].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const p=this.getImportIndex(n);if(p===-1)return this;const m=c[d],y=this.fragments[d];return c=c.filter((({id:x})=>x!==t)),this.fragments=this.fragments.filter((({id:x})=>x!==t)),this.stylesheet.imports=c.slice(0,p).concat(m).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(y).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=n;const p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",(()=>this.mergeAll())),p.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,n,c){this._checkLoaded();const d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;n?p[d].config=n:delete p[d].config;const m=this.fragments[d];c&&m.style.stylesheet&&(m.style.stylesheet.schema=c);const y=m.style.stylesheet&&m.style.stylesheet.schema;return m.config=n,m.style.updateConfig(n,y),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex((c=>c.id===t));return n===-1&&this.fire(new o.y(new Error("Import '".concat(t,"' does not exist in the map's style and cannot be updated.")))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=o.B(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=o.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];c==="reload"?this.reloadSource(n):c==="clear"&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,n,c){this.imageManager.getImages(n.images,n.scope,c),this._updateTilesForChangedImages();const d=m=>{if(m){const y=n.images.map((x=>o.I.toString(x)));m.setDependencies(n.tileID.key,n.type,y)}},p=o.B(n.source,n.scope);d(this._mergedOtherSourceCaches[p]),d(this._mergedSymbolSourceCaches[p]),n.images.some((m=>m.iconsetId))&&this.fire(new o.z("data",{dataType:"style"}))}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,c)}getResource(t,n,c){return o.dy(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return n.length===0?(this.fire(new o.y(new Error("There is no source with ID '".concat(t,"'")))),!1):n.every((c=>c.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||n&&n.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((t=>{t.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}_o.getSourceType=function(l){return Is[l]},_o.setSourceType=function(l,t){Is[l]=t},_o.registerForPluginStateChange=o.dz;class Ca extends o.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},o.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(t){t===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=t,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(t){this._activeFloorsVisible=t,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(t){for(const[n,c]of Object.entries(t.buildings))if(this._buildings[n])for(const d of c.floorIds)this._buildings[n].floors[d]||(this._buildings[n].floors[d]=c.floors[d]);else this._buildings[n]=c;for(const n of t.activeFloors)this._activeFloors.add(n);this._updateIndoorSelector()}getIndoorTileOptions(t,n){const c=this._style.getIndoorSourceLayers(t,n);return c&&this._indoorState?{sourceLayers:c,indoorState:this._indoorState}:null}_updateUI(t,n,c){const d=(function(p,m,y,x){let T=null,S=Number.MAX_SAFE_INTEGER;if(x<16)return null;for(const[M,E]of Object.entries(p)){const P=E.center;if(P){const D=m.distanceTo(o.aS.convert(P));D<S&&y.contains(P)&&(S=D,T=M)}}return T})(this._buildings,n,c,t);d!==this._closestBuildingId&&(this._closestBuildingId=d,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,n=this._closestBuildingId,c=n&&t?t[n]:void 0;if(!c)return void this.fire(new o.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let d=null;for(const m of c.floorIds)if(this._activeFloors&&this._activeFloors.has(m)){d=m;break}const p=Array.from(c.floorIds).map((m=>({id:m,name:c.floors[m].name,zIndex:c.floors[m].zIndex}))).sort(((m,y)=>y.zIndex-m.zIndex));this.fire(new o.z("selector-update",{selectedFloorId:d,activeFloorsVisible:this._activeFloorsVisible,floors:p}))}_updateActiveFloors(){const t=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:t,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var nc="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",bh="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",wh="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib\n#define DECLARE_MATERIAL_TABLE_INFO\n#endif",el="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",tl="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nint NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nhighp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Th="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Gc="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",Zs="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Hc="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",it="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",Sh="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const il=[];go(nc,il),go(wh,il),go(bh,il);const rl={"_prelude_fog.vertex.glsl":Th,"_prelude_terrain.vertex.glsl":tl,"_prelude_shadow.vertex.glsl":it,"_prelude_material_table.vertex.glsl":"#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define MATERIAL_TABLE_DEBUG 0\nuniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;\n#if MATERIAL_TABLE_DEBUG\nvec4 colorDebug;\n#endif\n};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { \nif (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; \n}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { \niRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;\n#if MATERIAL_TABLE_DEBUG\nconst vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;\n#endif\nuint offset=0u;\n#if MATERIAL_TABLE_DEBUG\nbool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}\n#endif\noffset++;\n#if MATERIAL_TABLE_DEBUG\nuint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}\n#endif\noffset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}\n#endif\nuint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding)\n{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}\n#endif\noffset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}\n#endif\ninfo.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)\n{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)\n#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));\n#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;\n#endif","_prelude_fog.fragment.glsl":Gc,"_prelude_shadow.fragment.glsl":Sh,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":Zs,"_prelude_raster_particle.glsl":Hc},sc={};_i("",tl),_i(Gc,Th),_i(Sh,it),_i(Zs,""),_i(Hc,"");const oc=_i(bh,wh),Lo=nc;var qc={background:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nin highp float v_flood_radius;in float v_has_flood_light;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nshadowed_lighting_factor=dot(normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);\n#ifdef FLOOD_LIGHT\nfloat flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);\n#endif\ncolor.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nout highp float v_flood_radius;out float v_has_flood_light;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\n#ifdef FLOOD_LIGHT\nv_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);\n#endif\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}'),buildingBloom:_i("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);}"),buildingDepth:_i("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:_i("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:_i('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:_i("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:_i("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:_i("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:_i("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:_i("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:_i("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#else\n#ifdef FEATURE_CUTOUT\napply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);\n#endif\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:_i("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:_i('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:_i("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:_i("precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:_i("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:_i("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:_i('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:_i('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#define APPEARANCE_ICON 1.0\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\n#ifdef Z_TEST_OCCLUSION\nout_fade_opacity*=occlusion_opacity;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:_i("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:_i('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',el),skyboxGradient:_i('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',el),skyboxCapture:_i("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:_i('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:_i('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef FLIP_Y\ncoord.y=1.0-coord.y;\n#endif\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#ifdef CLIP_ZERO_TO_ONE\nv_depth=-1.0+2.0*v_depth; \n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:_i("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:_i("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:_i("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:_i("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:_i("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:_i("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function go(l,t){const n=l.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let c of n)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=c.split(" ");for(const p of d)t.includes(p)||t.push(p)}}function _i(l,t){const n=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,d={},p=[],m=[];if(l=l.replace(n,((x,T)=>(m.push(T),""))),(t=t.replace(n,((x,T)=>(p.push(T),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let y=[...il];go(l,y),go(t,y);for(const x of[...p,...m])rl[x]||console.error("Undefined include: ".concat(x)),sc[x]||(sc[x]=[],go(rl[x],sc[x])),y=[...y,...sc[x]];return{fragmentSource:l=l.replace(c,((x,T,S,M,E)=>(d[E]=!0,T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nin ").concat(S," ").concat(M," ").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize"?"\n#ifdef HAS_UNIFORM_u_".concat(E,"\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):T==="define-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    in ").concat(S," ").concat(M," ").concat(E,";\n#endif\n"):T==="initialize-attribute"?"":void 0))),vertexSource:t=t.replace(c,((x,T,S,M,E)=>{const P="MATERIAL_ATTRIBUTE_OFFSET_".concat(E),D=M==="float"?"vec2":M,O="GET_ATTRIBUTE_".concat(D,"(a_").concat(E,", materialInfo, ").concat(P,")"),V=E.match(/color/)?"color":D;return T==="define-attribute-vertex-shader-only"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\nin ").concat(S," ").concat(M," a_").concat(E,";\n#endif\n"):d[E]?T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nuniform lowp float u_").concat(E,"_t;\n    #if !defined(").concat(P,")\n        in ").concat(S," ").concat(D," a_").concat(E,";\n    #endif\nout ").concat(S," ").concat(M," ").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize"?V==="vec4"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    ").concat(E," = a_").concat(E,";\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):"\n#if !defined(HAS_UNIFORM_u_".concat(E,") \n    #ifdef ").concat(P,"\n        ").concat(E," = unpack_mix_").concat(V,"(").concat(O,", u_").concat(E,"_t);\n    #else\n        ").concat(E," = unpack_mix_").concat(V,"(a_").concat(E,", u_").concat(E,"_t);\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):T==="define-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    in ").concat(S," ").concat(M," a_").concat(E,";\n    out ").concat(S," ").concat(M," ").concat(E,";\n#endif\n"):T==="initialize-attribute"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    ").concat(E," = a_").concat(E,";\n#endif\n"):void 0:T==="define"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\nuniform lowp float u_").concat(E,"_t;\n    #if !defined(").concat(P,")\n        in ").concat(S," ").concat(D," a_").concat(E,";\n    #endif  \n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="define-instanced"?V==="mat4"?"\n#ifdef INSTANCED_ARRAYS\nin vec4 a_".concat(E,"0;\nin vec4 a_").concat(E,"1;\nin vec4 a_").concat(E,"2;\nin vec4 a_").concat(E,"3;\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):"\n#ifdef INSTANCED_ARRAYS\nin ".concat(S," ").concat(D," a_").concat(E,";\n#else\nuniform ").concat(S," ").concat(M," u_").concat(E,";\n#endif\n"):T==="initialize-attribute-custom"?"\n#ifdef HAS_ATTRIBUTE_a_".concat(E,"\n    ").concat(S," ").concat(M," ").concat(E," = a_").concat(E,";\n#endif\n"):V==="vec4"?"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    #ifdef ").concat(P,"\n        ").concat(S," ").concat(M," ").concat(E," = ").concat(O,";\n    #else\n        ").concat(S," ").concat(M," ").concat(E," = a_").concat(E,";\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n"):"\n#ifndef HAS_UNIFORM_u_".concat(E,"\n    #ifdef ").concat(P,"\n        ").concat(S," ").concat(M," ").concat(E," = unpack_mix_").concat(V,"(").concat(O,", u_").concat(E,"_t);\n    #else\n        ").concat(S," ").concat(M," ").concat(E," = unpack_mix_").concat(V,"(a_").concat(E,", u_").concat(E,"_t);\n    #endif\n#else\n    ").concat(S," ").concat(M," ").concat(E," = u_").concat(E,";\n#endif\n")})),usedDefines:y,vertexIncludes:p,fragmentIncludes:m}}class nl{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,d,p,m,y,x){this.context=t;let T=this.boundPaintVertexBuffers.length!==d.length;for(let M=0;!T&&M<d.length;M++)this.boundPaintVertexBuffers[M]!==d[M]&&(T=!0);let S=this.boundDynamicVertexBuffers.length!==y.length;for(let M=0;!S&&M<y.length;M++)this.boundDynamicVertexBuffers[M]!==y[M]&&(S=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||T||S||this.boundIndexBuffer!==p||this.boundVertexOffset!==m)this.freshBind(n,c,d,p,m,y,x);else{t.bindVertexArrayOES.set(this.vao);for(const M of y)M&&(M.bind(),x&&M.instanceCount&&M.setVertexAttribDivisor(t.gl,n,x));p&&p.dynamicDraw&&p.bind()}}freshBind(t,n,c,d,p,m,y){const x=this.context,T=x.gl;this.vao&&this.destroy(),this.vao=x.gl.createVertexArray(),x.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=m,n.enableAttributes(T,t),n.bind(),n.setVertexAttribPointers(T,t,p);for(const S of c)S.enableAttributes(T,t),S.bind(),S.setVertexAttribPointers(T,t,p);for(const S of m)S&&(S.enableAttributes(T,t),S.bind(),S.setVertexAttribPointers(T,t,p),y&&S.instanceCount&&S.setVertexAttribDivisor(T,t,y));d&&d.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Sm(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new o.ae(0,c/n).toLngLat().lat,new o.ae(0,(c+1)/n).toLngLat().lat]}function Em(l,t,n,c,d,p,m){const y=l.context,x=y.gl,T=n.hillshadeFBO;if(!T)return;l.prepareDrawTile();const S=l.isTileAffectedByFog(t),M=l.getOrCreateProgram("hillshade",{overrideFog:S});y.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,T.colorAttachment.get());const E=((V,N,j,Z)=>{const H=j.paint.get("hillshade-shadow-color"),te=j.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",W=j.paint.get("hillshade-highlight-color"),re=j.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",ee=j.paint.get("hillshade-accent-color"),K=j.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",ne=j.paint.get("hillshade-emissive-strength");let _e=o.an(j.paint.get("hillshade-illumination-direction"));if(j.paint.get("hillshade-illumination-anchor")==="viewport")_e-=V.transform.angle;else if(V.style&&V.style.enable3dLights()&&V.style.directionalLight){const Me=V.style.directionalLight.properties.get("direction"),we=o.d3(Me.x,Me.y,Me.z);_e=o.an(we[1])}const fe=!V.options.moving;return{u_matrix:Z||V.transform.calculateProjMatrix(N.tileID.toUnwrapped(),fe),u_image:0,u_latrange:Sm(0,N.tileID),u_light:[j.paint.get("hillshade-exaggeration"),_e],u_shadow:H.toPremultipliedRenderColor(te?null:j.lut),u_highlight:W.toPremultipliedRenderColor(re?null:j.lut),u_emissive_strength:ne,u_accent:ee.toPremultipliedRenderColor(K?null:j.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(y,M,t.toUnwrapped());const{tileBoundsBuffer:P,tileBoundsIndexBuffer:D,tileBoundsSegments:O}=l.getTileBoundsBuffers(n);M.draw(l,x.TRIANGLES,d,p,m,jt.disabled,E,c.id,P,D,O)}function $c(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const p=n.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new o.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Im(l,t,n){const c=l.context,d=c.gl;if(!t.dem)return;const p=t.dem;if(c.activeTexture.set(d.TEXTURE1),$c(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const m=p.dim;c.activeTexture.set(d.TEXTURE0);let y=t.hillshadeFBO;if(!y){const E=new o.T(c,{width:m,height:m,data:null},d.RGBA8);E.bind(d.LINEAR,d.CLAMP_TO_EDGE),y=t.hillshadeFBO=c.createFramebuffer(m,m,!0,"renderbuffer"),y.colorAttachment.set(E.texture)}c.bindFramebuffer.set(y.framebuffer),c.viewport.set([0,0,m,m]);const{tileBoundsBuffer:x,tileBoundsIndexBuffer:T,tileBoundsSegments:S}=l.getMercatorTileBoundsBuffers(),M=[];l.linearFloatFilteringSupported()&&M.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:M}).draw(l,d.TRIANGLES,wt.disabled,Zt.disabled,ni.unblended,jt.disabled,((E,P)=>{const D=P.stride,O=o.bB();return o.cd(O,0,o.al,-o.al,0,0,1),o.bq(O,O,[0,-o.al,0]),{u_matrix:O,u_image:1,u_dimension:[D,D],u_zoom:E.overscaledZ}})(t.tileID,p),n.id,x,T,S),t.needsHillshadePrepare=!1}class Nr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Af extends Nr{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Eh extends Nr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Am extends Nr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Mm extends Nr{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Cm extends Nr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Pm extends Nr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Mf extends Nr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Rm extends Nr{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Zc extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Dm extends Nr{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Cf extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Ih extends Nr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Wc extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Ah extends Nr{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Pa extends Nr{getDefault(){return o.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class sl extends Nr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class ac extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class ol extends Nr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Pf extends Nr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Mh=class extends Nr{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class Rf extends Nr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class al extends Nr{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Xc extends Nr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Yc extends Nr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Ch extends Nr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Kc extends Nr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class lc extends Nr{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Df extends Nr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class zf extends Nr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Lf extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class ll extends Nr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Jc extends Nr{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class zm extends Jc{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Of extends Jc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Lm extends Jc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Ph extends Of{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Rh=(l,t,n)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),Qc=(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:m,u_frustum_tr:y,u_frustum_br:x,u_frustum_bl:T,u_globe_pos:S,u_globe_radius:M,u_viewport:E,u_grid_matrix:O?Float32Array.from(O):new Float32Array(9),u_skirt_height:P,u_far_z_cutoff:D});function eu(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const Ra=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,d){if(l in this.operations){const p=this.operations[l];p.to.tileID.key!==n.tileID.key&&(p.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},Dh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function kf(l,t,n){if(t===0)return 0;const c=t<1&&n===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function cc(l,t){const n=1<<l.z;return!t&&(l.x===0||l.x===n-1)||l.y===0||l.y===n-1}const Da=l=>({u_matrix:l});function tu(l,t,n,c,d){if(d>0){const p=o.o.now(),m=(p-l.timeAdded)/d,y=t?(p-t.timeAdded)/d:-1,x=n.getSource(),T=c.coveringZoomLevel({tileSize:x.tileSize,roundZoom:x.roundZoom}),S=!t||Math.abs(t.tileID.overscaledZ-T)>Math.abs(l.tileID.overscaledZ-T),M=S&&l.refreshedUponExpiration?1:o.aA(S?m:1-y,0,1);return t?{opacity:1,mix:1-M,isFading:m<1}:{opacity:M,mix:0,isFading:m<1}}return{opacity:1,mix:0,isFading:!1}}class Ws extends Fs{constructor(t){const n=es("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",n,!1),n.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class zh extends Fs{constructor(t){const n=es("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((p,m)=>{if(p[m.key]="",!this._tiles[m.key]){const y=new qs(m,this._source.tileSize*m.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);y.state="loaded",this._tiles[m.key]=y}return p}),{});for(const p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){const n=this.proxyCachedFBO[t];if(n!==void 0){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach((t=>t.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class uc extends o.aP{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class hc extends o.bU{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,p]=(function(x){const T=new o.bc,S=new o.b0,M=131;T.reserve(17161),S.reserve(33800);const E=o.al/128,P=o.al+E/2,D=P+E;for(let V=-E;V<D;V+=E)for(let N=-E;N<D;N+=E){const j=N<0||N>P||V<0||V>P?24575:0,Z=o.aA(Math.round(N),0,o.al),H=o.aA(Math.round(V),0,o.al);T.emplaceBack(Z+j,H)}const O=(V,N)=>{const j=N*M+V;S.emplaceBack(j+1,j,j+M),S.emplaceBack(j+M,j+M+1,j+1)};for(let V=1;V<129;V++)for(let N=1;N<129;N++)O(N,V);return[0,129].forEach((V=>{for(let N=0;N<130;N++)O(N,V),O(V,N)})),[T,S,32768]})(),m=t.context;this.gridBuffer=m.createVertexBuffer(c,o.be.members),this.gridIndexBuffer=m.createIndexBuffer(d),this.gridSegments=o.bf.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=o.bf.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new zh(n.map),this.orthoMatrix=o.bB(),o.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,o.al,0,o.al,0,1);const y=m.gl;this._overlapStencilMode=new Zt({func:y.GEQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Ws(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,m=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.o.now();const y=t.terrain&&t.terrain.scope,x=d.get("source"),T=p?this._mockSourceCache:t.getSourceCache(x,y);if(!T)return void o.w("Couldn't find terrain source \"".concat(x,'".'));if(this.sourceCache=T,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=m?this.calculateExaggeration(n):d.get("exaggeration"),!n.projection.requiresDraping&&m&&this._exaggeration===0)return void this._disable();this.enabled=!0;const S=()=>{this.sourceCache.used&&o.w("Raster DEM source '".concat(this.sourceCache.id,"' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source."));const M=this.getScaledDemTileSize();this.sourceCache.update(n,M,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,S(),this._initializing=!0),S(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=n!=null?c-n:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const p=t.zoom,m=this._style.terrain;if(!this._previousUpdateTimestamp)return m.getExaggeration(p);let y=p-this._previousZoom;const x=this._previousUpdateTimestamp;let T=p;this._evaluationZoom!=null&&(T=this._evaluationZoom,Math.abs(p-T)>.5&&(y=.5*(p-T+y)),y*d<0&&(T+=y)),this._evaluationZoom=T;const S=m.getExaggeration(T),M=S===m.getExaggeration(Math.max(0,T-.1));if(M&&Math.abs(S-this._exaggeration)<.01)return S;let E=Math.min(.1,.00375*(this._updateTimestamp-x));return(M||S<.1||Math.abs(y)<1e-4)&&(E=Math.min(.2,4*E)),o.ak(this._exaggeration,S,E)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((t=>t.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(o.ae.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=n.getIds().map((x=>{const T=n.getTileByID(x).tileID;return T.projMatrix=c.calculateProjMatrix(T.toUnwrapped()),T}));(function(x,T){const S=T.transform.pointCoordinate(T.transform.getCameraPoint()),M=new o.P(S.x,S.y);x.sort(((E,P)=>{if(P.overscaledZ-E.overscaledZ)return P.overscaledZ-E.overscaledZ;const D=new o.P(E.canonical.x+(1<<E.canonical.z)*E.wrap,E.canonical.y),O=new o.P(P.canonical.x+(1<<P.canonical.z)*P.wrap,P.canonical.y),V=M.mult(1<<E.canonical.z);return V.x-=.5,V.y-=.5,V.distSqr(D)-V.distSqr(O)}))})(d,this.painter);const p=this.proxyToSource||{};this.proxyToSource={},d.forEach((x=>{this.proxyToSource[x.key]={}})),this.terrainTileForTile={};const m=this._style._mergedSourceCaches;for(const x in m){const T=m[x];if(!T.used||(T!==this.sourceCache&&this.resetTileLookupCache(T.id),this._setupProxiedCoordsForOrtho(T,t[x],p),T.usedForTerrain))continue;const S=t[x];T.getSource().reparseOverscaled&&this._assignTerrainTiles(S)}this.proxiedCoords[n.id]=d.map((x=>new uc(x,x.key,this.orthoMatrix))),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;const y={};this._visibleDemTiles=[];for(const x of this.proxyCoords){const T=this.terrainTileForTile[x.key];if(!T)continue;const S=T.tileID.key;S in y||(this._visibleDemTiles.push(T),y[S]=S)}}_assignTerrainTiles(t){this._initializing||t.forEach((n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)}))}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),$c(this.painter,d,p))}}_prepareDemTileUniforms(t,n,c,d){if(!n||n.demTexture==null)return!1;const p=t.tileID.canonical,m=Math.pow(2,n.tileID.canonical.z-p.z),y=d||"";return c["u_dem_tl".concat(y)]=[p.x*m%1,p.y*m%1],c["u_dem_scale".concat(y)]=m,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce(((c,d)=>{if(!d.dem)return c;const p=d.dem.tree.minimums[0];return p>0&&t++,c+p}),0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new o.dK({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new o.T(t,d,n.R32F,{premultiply:!1}),p}setupElevationDraw(t,n,c){const d=this.painter.context,p=d.gl,m={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};m.u_exaggeration=this.exaggeration();let y=null,x=null,T=1;if(c&&c.morphing&&this._useVertexMorphing){const P=c.morphing.srcDemTile,D=c.morphing.dstDemTile;T=c.morphing.phase,P&&D&&(this._prepareDemTileUniforms(t,P,m,"_prev")&&(x=P),this._prepareDemTileUniforms(t,D,m)&&(y=D))}const S=P=>P&&P.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST;let M=null;var E;if(this.enabled?x&&y?(M=y.demTexture,d.activeTexture.set(p.TEXTURE4),x.demTexture.bind(S(x),p.CLAMP_TO_EDGE),m.u_dem_lerp=T):(y=this.terrainTileForTile[t.tileID.key],M=this._prepareDemTileUniforms(t,y,m)?y.demTexture:this.emptyDEMTexture):M=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),M&&(m.u_dem_size=(E=M).size[0]===1?1:E.size[0]-2,M.bind(S(y),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,m),c&&c.useMeterToDem&&y){const P=(1<<y.tileID.canonical.z)*o.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;m.u_meter_to_dem=P}if(c&&c.labelPlaneMatrixInv&&(m.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(d,m),this.painter.transform.projection.name==="globe"){const P=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(d,P)}}globeUniformValues(t,n,c){const d=t.projection;return{u_tile_tl_up:d.upVector(n,0,0),u_tile_tr_up:d.upVector(n,o.al,0),u_tile_br_up:d.upVector(n,o.al,o.al),u_tile_bl_up:d.upVector(n,0,o.al),u_tile_up_scale:c?o.dL(1):d.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,(function(d,p,m,y,x){if(d.transform.projection.name==="globe")(function(T,S,M,E,P){const D=T.context,O=D.gl;let V,N;const j=T.transform,Z=o.dD(T,D,j),H=(Me,we)=>{if(N===we)return;const ze=[Dh[we],"PROJECTION_GLOBE_VIEW"];Z&&ze.push("CUSTOM_ANTIALIASING");const Je=T.isTileAffectedByFog(Me);V=T.getOrCreateProgram("globeRaster",{defines:ze,overrideFog:Je}),N=we},te=T.colorModeForRenderPass(),W=new wt(O.LEQUAL,wt.ReadWrite,T.depthRangeFor3D);Ra.update(P);const re=o.dE(j),ee=[o.aF(j.center.lng),o.aJ(j.center.lat)],K=T.globeSharedBuffers,ne=[j.width*o.o.devicePixelRatio,j.height*o.o.devicePixelRatio],_e=Float32Array.from(j.globeMatrix),fe={useDenormalizedUpVectorScale:!0};{const Me=T.transform,we=kf(Me.zoom,S.exaggeration(),S.sourceCache._source.tileSize);N=-1;const ze=O.TRIANGLES;for(const Je of E){const xe=M.getTile(Je),ce=Zt.disabled,Le=S.prevTerrainTileForTile[Je.key],Te=S.terrainTileForTile[Je.key];eu(Le,Te)&&Ra.newMorphing(Je.key,Le,Te,P,250),D.activeTexture.set(O.TEXTURE0),xe.texture&&xe.texture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const je=Ra.getMorphValuesForProxy(Je.key),rt=je?1:0;je&&Object.assign(fe,{morphing:{srcDemTile:je.from,dstDemTile:je.to,phase:o.dC(je.phase)}});const gt=o.dF(Je.canonical),Xe=o.dG(gt.getCenter().lat),et=o.dH(Je.canonical,gt,Xe,Me.worldSize/Me._pixelsPerMercatorPixel),xt=o.bj(o.dI(Je.canonical)),dt=Qc(Me.expandedFarZProjMatrix,_e,re,xt,o.aj(Me.zoom),ee,Me.frustumCorners.TL,Me.frustumCorners.TR,Me.frustumCorners.BR,Me.frustumCorners.BL,Me.globeCenterInViewSpace,Me.globeRadius,ne,we,Me._farZ,et);if(H(Je,rt),V&&(S.setupElevationDraw(xe,V,fe),T.uploadCommonUniforms(D,V,Je.toUnwrapped()),K)){const[ut,ft,zt]=K.getGridBuffers(Xe,we!==0);V.draw(T,ze,W,ce,te,jt.backCCW,dt,"globe_raster",ut,ft,zt)}}}if(K&&(T.renderDefaultNorthPole||T.renderDefaultSouthPole)){const Me=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Z&&Me.push("CUSTOM_ANTIALIASING"),V=T.getOrCreateProgram("globeRaster",{defines:Me});for(const we of E){const{x:ze,y:Je,z:xe}=we.canonical,ce=Je===0,Le=Je===(1<<xe)-1,[Te,je,rt,gt]=K.getPoleBuffers(xe,!1);if(gt&&(ce||Le)){const Xe=M.getTile(we);D.activeTexture.set(O.TEXTURE0),Xe.texture&&Xe.texture.bind(O.LINEAR,O.CLAMP_TO_EDGE);let et=o.dJ(xe,ze,j);const xt=o.bj(o.dI(we.canonical)),dt=(ut,ft)=>ut.draw(T,O.TRIANGLES,W,Zt.disabled,te,jt.disabled,Qc(j.expandedFarZProjMatrix,et,et,xt,0,ee,j.frustumCorners.TL,j.frustumCorners.TR,j.frustumCorners.BR,j.frustumCorners.BL,j.globeCenterInViewSpace,j.globeRadius,ne,0,j._farZ),"globe_pole_raster",ft,rt,gt);S.setupElevationDraw(Xe,V,fe),T.uploadCommonUniforms(D,V,we.toUnwrapped()),ce&&T.renderDefaultNorthPole&&dt(V,Te),Le&&T.renderDefaultSouthPole&&(et=o.cR(o.bB(),et,[1,-1,1]),dt(V,je))}}}})(d,p,m,y,x);else{const T=d.context,S=T.gl;let M,E;const P=d.shadowRenderer,D=Ho(d,d.longestCutoffRange),O=te=>{if(E===te)return;const W=[];W.push(Dh[te]),D.shouldRenderCutoff&&W.push("RENDER_CUTOFF"),P&&(W.push("RENDER_SHADOWS","DEPTH_TEXTURE"),P.useNormalOffset&&W.push("NORMAL_OFFSET")),M=d.getOrCreateProgram("terrainRaster",{defines:W}),E=te},V=d.colorModeForRenderPass(),N=new wt(S.LEQUAL,wt.ReadWrite,d.depthRangeFor3D);Ra.update(x);const j=d.transform,Z=kf(j.zoom,p.exaggeration(),p.sourceCache._source.tileSize);let H=[0,0,0];if(P){const te=d.style.directionalLight,W=d.style.ambientLight;te&&W&&(H=mo(d.style,te,W))}{E=-1;const te=S.TRIANGLES,[W,re]=[p.gridIndexBuffer,p.gridSegments];for(const ee of y){const K=m.getTile(ee),ne=Zt.disabled,_e=p.prevTerrainTileForTile[ee.key],fe=p.terrainTileForTile[ee.key];eu(_e,fe)&&Ra.newMorphing(ee.key,_e,fe,x,250),T.activeTexture.set(S.TEXTURE0),K.texture&&K.texture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const Me=Ra.getMorphValuesForProxy(ee.key),we=Me?1:0;let ze;Me&&(ze={morphing:{srcDemTile:Me.from,dstDemTile:Me.to,phase:o.dC(Me.phase)}});const Je=Rh(ee.projMatrix,cc(ee.canonical,j.renderWorldCopies)?Z/10:Z,H);if(O(we),!M)continue;p.setupElevationDraw(K,M,ze);const xe=ee.toUnwrapped();P&&P.setupShadows(xe,M),d.uploadCommonUniforms(T,M,xe,null,D),M.draw(d,te,N,ne,V,jt.backCCW,Je,"terrain_raster",p.gridBuffer,W,re)}}}})(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],m=this._drapedRenderBatches.shift(),y=n.style.order,x=[];let T=0;for(const S of p){const M=d.getTileByID(S.proxyTileKey),E=d.proxyCachedFBO[S.key]?d.proxyCachedFBO[S.key][t]:void 0,P=E!==void 0?d.renderCache[E]:this.pool[T++],D=E!==void 0;if(M.texture=P.tex,D&&!P.dirty){x.push(M.tileID);continue}let O;c.bindFramebuffer.set(P.fb.framebuffer),this.renderedToTile=!1,P.dirty&&(c.clear({color:o.ao.transparent,stencil:0}),P.dirty=!1);for(let V=m.start;V<=m.end;++V){const N=n.style._mergedLayers[y[V]];if(N.isHidden(n.transform.zoom))continue;const j=n.style.getLayerSourceCache(N),Z=j?this.proxyToSource[S.key][j.id]:[S];if(!Z)continue;const H=Z;c.viewport.set([0,0,P.fb.width,P.fb.height]),O!==(j?j.id:null)&&(this._setupStencil(P,Z,N,j),O=j?j.id:null),n.renderLayer(n,j,N,H)}if(this._drapedRenderBatches.length===0)for(const V of this._pendingGroundEffectLayers){const N=n.style._mergedLayers[y[V]];if(N.isHidden(n.transform.zoom))continue;const j=n.style.getLayerSourceCache(N),Z=j?this.proxyToSource[S.key][j.id]:[S];if(!Z)continue;const H=Z;c.viewport.set([0,0,P.fb.width,P.fb.height]),O!==(j?j.id:null)&&(this._setupStencil(P,Z,N,j),O=j?j.id:null),n.renderLayer(n,j,N,H)}this.renderedToTile?(P.dirty=!0,x.push(M.tileID)):D||--T,T===5&&(T=0,this.renderToBackBuffer(x))}return this.renderToBackBuffer(x),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),m.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,d=n;for(let p=0;p<n;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter((n=>n.dem)).forEach((n=>{t=Math.min(t,n.dem.tree.minimums[0])})),t===0?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter((p=>p.dem)).map((p=>{const m=p.tileID,y=1<<m.overscaledZ,{x,y:T}=m.canonical,S=x/y,M=(x+1)/y,E=T/y,P=(T+1)/y;return{minx:S,miny:E,maxx:M,maxy:P,t:p.dem.tree.raycastRoot(S,E,M,P,t,n,c),tile:p}}));d.sort(((p,m)=>(p.t!==null?p.t:Number.MAX_VALUE)-(m.t!==null?m.t:Number.MAX_VALUE)));for(const p of d){if(p.t==null)return null;const m=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,n,c);if(m!=null)return m}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const d=new o.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);d.bind(n.LINEAR,n.CLAMP_TO_EDGE);const p=t.createFramebuffer(c[0],c[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new Ph(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some((t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return n.type==="hillshade"||n.type==="custom"?!c&&n.shouldRedrape():!c&&n.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof wn){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(p&&!n[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof o.ad){n[p.id]=!0;for(const m of this.proxyCoords){const y=this.proxyToSource[m.key][p.id];if(y)for(const x of y)this._clearRenderCacheForTile(p.id,x)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof _s){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||n[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const m=d.paint.get("raster-fade-duration");for(const y of this.proxyCoords){const x=this.proxyToSource[y.key][p.id];if(x)for(const T of x){const S=tu(p.getTile(T),p.findLoadedParent(T,0),p,this.painter.transform,m);(S.opacity!==1||S.mix!==0)&&this._clearRenderCacheForTile(p.id,T)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(n===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,p=0,m=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(m)&&m.isHidden(this.painter.transform.zoom)&&++p<n;)m=this._style._mergedLayers[t[p]];for(;p<n;++p){const y=this._style._mergedLayers[t[p]];y.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(y)?d===void 0&&(d=p):(y.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){const y=c[c.length-1];this._pendingGroundEffectLayers.every((x=>x>y.end))||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const m=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let y=0;y<m.length;++y){const x=Object.values(m[y]);n.renderCachePool.push(...x)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let m=c.length-1;m>=0;m--){const y=c[m];if(n.getTileByID(y.key),n.proxyCachedFBO[y.key]!==void 0){const x=t[y.key],T=this.proxyToSource[y.key];let S=0;for(const M in T){const E=T[M],P=x[M];if(!P||P.length!==E.length||E.some(((D,O)=>D!==P[O]||d[M]&&d[M].hasOwnProperty(D.key)))){S=-1;break}++S}for(const M in n.proxyCachedFBO[y.key])n.renderCache[n.proxyCachedFBO[y.key][M]].dirty=S<0||S!==Object.values(x).length}}const p=[...this._drapedRenderBatches];p.sort(((m,y)=>y.end-y.start-(m.end-m.start)));for(const m of p)for(const y of c){if(n.proxyCachedFBO[y.key])continue;let x=n.renderCachePool.pop();x===void 0&&n.renderCache.length<50&&(x=n.renderCache.length,n.renderCache.push(this._createFBO())),x!==void 0&&(n.proxyCachedFBO[y.key]={},n.proxyCachedFBO[y.key][m.start]=x,n.renderCache[x].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const p=this.painter.context,m=p.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let y;if(c.isTileClipped())y=n.length,this._overlapStencilMode.test={func:m.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);y=1,this._overlapStencilMode.test={func:m.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+y>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=y,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Zt.disabled}_renderTileClippingMasks(t,n){const c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(ni.disabled),d.setDepthMode(wt.disabled);const m=c.getOrCreateProgram("clippingMask");for(const y of t){const x=c._tileClippingMaskIDs[y.key]=--n;m.draw(c,p.TRIANGLES,wt.disabled,new Zt({func:p.ALWAYS,mask:0},x,255,p.KEEP,p.KEEP,p.REPLACE),ni.disabled,jt.disabled,Da(y.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];o.aC(c,c,n.pixelMatrixInverse),o.cJ(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const d=n._camera.position,p=o.ce(1,n.center.lat),m=[d[0],d[1],d[2]/p,0],y=o.d9([],c.slice(0,3),m);o.aw(y,y);const x=this.raycast(m,y,this._exaggeration);return x!==null&&x?(o.bG(m,m,y,x),m[3]=m[2],m[2]*=p,m):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof o.aT)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let x=0;x<p.length;x++){const T=p[x],S=this._findTileCoveringTileID(T,t);if(S){const M=this._createProxiedId(T,S,c[T.key]&&c[T.key][t.id]);d.push(M),this.proxyToSource[T.key][t.id]=[M]}}let m=!1;const y=new Set;for(let x=0;x<n.length;x++){const T=t.getTile(n[x]);if(!T||!T.hasData())continue;const S=this._findTileCoveringTileID(T.tileID,this.proxySourceCache);if(S&&S.tileID.canonical.z!==T.tileID.canonical.z){const M=this.proxyToSource[S.tileID.key][t.id],E=this._createProxiedId(S.tileID,T,c[S.tileID.key]&&c[S.tileID.key][t.id]);M?M.splice(M.length-1,0,E):this.proxyToSource[S.tileID.key][t.id]=[E];const P=this.proxyToSource[S.tileID.key][t.id];y.has(P)||y.add(P),d.push(E),m=!0}}if(this._sourceTilesOverlap[t.id]=m,m&&this._debugParams.sortTilesHiZFirst)for(const x of y)x.sort(((T,S)=>S.overscaledZ-T.overscaledZ))}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,m=t.getSource(),y=m.tileID;if(!y)return;const x=new o.P(y.x,y.y)._div(1<<y.z),T=m.coordinates.map(o.ae.fromLngLat).reduce(((M,E)=>(M.min.x=Math.min(M.min.x,E.x-x.x),M.min.y=Math.min(M.min.y,E.y-x.y),M.max.x=Math.max(M.max.x,E.x-x.x),M.max.y=Math.max(M.max.y,E.y-x.y),M)),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),S=(M,E)=>{const P=M.wrap+M.canonical.x/(1<<M.canonical.z),D=M.canonical.y/(1<<M.canonical.z),O=o.al/(1<<M.canonical.z),V=E.wrap+E.canonical.x/(1<<E.canonical.z),N=E.canonical.y/(1<<E.canonical.z);return P+O<V+T.min.x||P>V+T.max.x||D+O<N+T.min.y||D>N+T.max.y};for(let M=0;M<p.length;M++){const E=p[M];for(let P=0;P<n.length;P++){const D=t.getTile(n[P]);if(!D||!D.hasData()||S(E,D.tileID))continue;const O=this._createProxiedId(E,D,c[E.key]&&c[E.key][t.id]),V=this.proxyToSource[E.key][t.id];V?V.push(O):this.proxyToSource[E.key][t.id]=[O],d.push(O)}}}_createProxiedId(t,n,c){let d=this.orthoMatrix;if(c){const p=c.find((m=>m.key===n.tileID.key));if(p)return p}if(n.tileID.key!==t.key){const p=t.canonical.z-n.tileID.canonical.z;let m,y,x;d=o.bB();const T=n.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(m=o.al>>p,y=m*((n.tileID.canonical.x<<p)-t.canonical.x+T),x=m*((n.tileID.canonical.y<<p)-t.canonical.y)):(m=o.al<<-p,y=o.al*(n.tileID.canonical.x-(t.canonical.x+T<<-p)),x=o.al*(n.tileID.canonical.y-(t.canonical.y<<-p))),o.cd(d,0,m,0,m,0,1),o.bq(d,d,[y,x,0])}return new uc(n.tileID,t.key,d)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[n.id],p=d[t.key];if(c=p?n.getTileByID(p):null,c&&c.hasData()||p===null)return c;let m=c?c.tileID:t,y=m.overscaledZ;const x=n.getSource().minzoom,T=[];if(!p){const M=n.getSource().maxzoom;if(t.canonical.z>=M){const E=t.canonical.z-M;n.getSource().reparseOverscaled?(y=Math.max(t.canonical.z+2,n.transform.tileZoom),m=new o.aP(y,t.wrap,M,t.canonical.x>>E,t.canonical.y>>E)):E!==0&&(y=M,m=new o.aP(y,t.wrap,M,t.canonical.x>>E,t.canonical.y>>E))}m.key!==t.key&&(T.push(m.key),c=n.getTile(m))}const S=M=>{T.forEach((E=>{d[E]=M})),T.length=0};for(y-=1;y>=x&&(!c||!c.hasData());y--){c&&S(c.tileID.key);const M=m.calculateScaledKey(y);if(c=n.getTileByID(M),c&&c.hasData())break;const E=d[M];if(E===null)break;E===void 0?T.push(M):c=n.getTileByID(E)}return S(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function Lh(l,t,n){const c=(function(y,x,T){const S=o.bI(x,y),M=o.bI(T,[.2126,.7152,.0722]),E=(D,O,V)=>(1-V)*D+V*O,P=E(1-.3*Math.min(M,1),1,Math.min(S+1,1));return E(.92,1,Math.asin(o.aA(x[2],-1,1))/Math.PI+.5)*P})(l,[0,0,1],t),d=[0,0,0];o.c4(d,n.slice(0,3),c);const p=[0,0,0];o.c4(p,t.slice(0,3),l[2]);const m=[0,0,0];return o.d7(m,d,p),o.da(m)}const Oh=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],kh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class dc{static cacheKey(t,n,c,d){let p="".concat(n).concat(d?d.cacheKey:"");for(const m of c)t.usedDefines.includes(m)&&(p+="/".concat(m));return p}constructor(t,n,c,d,p,m){const y=t.gl;this.program=y.createProgram(),this.configuration=d,this.name=n,this.fixedDefines=[...m];let x=d?d.defines():[];x=x.concat(m.map((D=>"#define ".concat(D))));const T="#version 300 es\n";let S=T+x.concat("precision mediump float;",Lo,oc.fragmentSource).join("\n");for(const D of c.fragmentIncludes)S+="\n".concat(rl[D]);S+="\n".concat(c.fragmentSource);let M=T+x.concat("precision highp float;",Lo,oc.vertexSource).join("\n");for(const D of c.vertexIncludes)M+="\n".concat(rl[D]);this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(M+="\nuniform int u_instanceID;\n"),M+="\n".concat(c.vertexSource),this.forceManualRenderingForInstanceIDShaders&&(M=M.replaceAll("gl_InstanceID","u_instanceID"));const E=y.createShader(y.FRAGMENT_SHADER);if(y.isContextLost())return void(this.failedToCreate=!0);y.shaderSource(E,S),y.compileShader(E),y.attachShader(this.program,E);const P=y.createShader(y.VERTEX_SHADER);y.isContextLost()?this.failedToCreate=!0:(y.shaderSource(P,M),y.compileShader(P),y.attachShader(this.program,P),this.attributes={},y.linkProgram(this.program),y.deleteShader(P),y.deleteShader(E),this.fixedUniforms=p(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(D=>({u_instanceID:new o.cg(D)}))(t)),(m.includes("TERRAIN")||n.indexOf("symbol")!==-1||n.indexOf("circle")!==-1)&&(this.terrainUniforms=(D=>({u_dem:new o.cg(D),u_dem_prev:new o.cg(D),u_dem_tl:new o.cj(D),u_dem_scale:new o.ci(D),u_dem_tl_prev:new o.cj(D),u_dem_scale_prev:new o.ci(D),u_dem_size:new o.ci(D),u_dem_lerp:new o.ci(D),u_exaggeration:new o.ci(D),u_depth:new o.cg(D),u_depth_size_inv:new o.cj(D),u_depth_range_unpack:new o.cj(D),u_occluder_half_size:new o.ci(D),u_occlusion_depth_offset:new o.ci(D),u_meter_to_dem:new o.ci(D),u_label_plane_matrix_inv:new o.ck(D)}))(t)),m.includes("GLOBE")&&(this.globeUniforms=(D=>({u_tile_tl_up:new o.ch(D),u_tile_tr_up:new o.ch(D),u_tile_br_up:new o.ch(D),u_tile_bl_up:new o.ch(D),u_tile_up_scale:new o.ci(D)}))(t)),m.includes("FOG")&&(this.fogUniforms=(D=>({u_fog_matrix:new o.ck(D),u_fog_range:new o.cj(D),u_fog_color:new o.d2(D),u_fog_horizon_blend:new o.ci(D),u_fog_vertical_limit:new o.cj(D),u_fog_temporal_offset:new o.ci(D),u_frustum_tl:new o.ch(D),u_frustum_tr:new o.ch(D),u_frustum_br:new o.ch(D),u_frustum_bl:new o.ch(D),u_globe_pos:new o.ch(D),u_globe_radius:new o.ci(D),u_globe_transition:new o.ci(D),u_is_globe:new o.cg(D),u_viewport:new o.cj(D)}))(t)),m.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(D=>({u_cutoff_params:new o.d2(D)}))(t)),m.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(D=>({u_lighting_ambient_color:new o.ch(D),u_lighting_directional_dir:new o.ch(D),u_lighting_directional_color:new o.ch(D),u_ground_radiance:new o.ch(D)}))(t)),m.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(D=>({u_light_matrix_0:new o.ck(D),u_light_matrix_1:new o.ck(D),u_fade_range:new o.cj(D),u_shadow_normal_offset:new o.ch(D),u_shadow_intensity:new o.ci(D),u_shadow_texel_size:new o.ci(D),u_shadow_map_resolution:new o.ci(D),u_shadow_direction:new o.ch(D),u_shadow_bias:new o.ch(D),u_shadowmap_0:new o.cg(D),u_shadowmap_1:new o.cg(D)}))(t)))}getAttributeLocation(t,n){let c=this.attributes[n];return c===void 0&&(c=this.attributes[n]=t.getAttribLocation(this.program,n)),c}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}_drawDebugWireframe(t,n,c,d,p,m,y,x,T,S){const M=t.options.wireframe;if(M.terrain===!1&&M.layers2D===!1&&M.layers3D===!1)return;const E=t.context;if(!(!(!M.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!M.layers2D||t._terrain&&t._terrain.renderingToTexture||!Oh.includes(this.name))||!(!M.layers3D||!kh.includes(this.name))))return;const P=E.gl,D=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,E);if(!D)return;const O=[...this.fixedDefines];O.push("DEBUG_WIREFRAME");const V=t.getOrCreateProgram(this.name,{config:this.configuration,defines:O});E.program.set(V.program);const N=(H,te,W)=>{if(te[H]&&W[H])for(const re in te[H])W[H][re]&&W[H][re].set(W.program,re,te[H][re].current)};T&&T.setUniforms(V.program,E,V.binderUniforms,y,{zoom:x}),N("fixedUniforms",this,V),N("terrainUniforms",this,V),N("globeUniforms",this,V),N("fogUniforms",this,V),N("lightsUniforms",this,V),N("shadowUniforms",this,V),D.bind(),E.setColorMode(new ni([P.ONE,P.ONE_MINUS_SRC_ALPHA,P.ZERO,P.ONE],o.ao.transparent,[!0,!0,!0,!1])),E.setDepthMode(new wt(n.func===P.LESS?P.LEQUAL:n.func,wt.ReadOnly,n.range)),E.setStencilMode(Zt.disabled);const j=3*m.primitiveLength*2,Z=3*m.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const H=S||1;for(let te=0;te<H;++te)V.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",te),P.drawElements(P.LINES,j,P.UNSIGNED_SHORT,Z)}else S&&S>1?P.drawElementsInstanced(P.LINES,j,P.UNSIGNED_SHORT,Z,S):P.drawElements(P.LINES,j,P.UNSIGNED_SHORT,Z);p.bind(),E.program.set(this.program),E.setDepthMode(n),E.setStencilMode(c),E.setColorMode(d)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error("Program '".concat(this.name,"', from draw '").concat(t,"': uniform ").concat(d," not set but required by ").concat(n," being defined"))}}draw(t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V){const N=t.context,j=N.gl;if(this.failedToCreate)return;N.program.set(this.program),N.setDepthMode(c),N.setStencilMode(d),N.setColorMode(p),N.setCullFace(m);for(const te of Object.keys(this.fixedUniforms))this.fixedUniforms[te].set(this.program,te,y[te]);D&&D.setUniforms(this.program,N,this.binderUniforms,E,{zoom:P});const Z={[j.POINTS]:1,[j.LINES]:2,[j.TRIANGLES]:3,[j.LINE_STRIP]:1}[n];this.checkUniforms(x,"RENDER_SHADOWS",this.shadowUniforms);const H=V&&V>0?1:void 0;for(const te of M.get()){const W=te.vaos||(te.vaos={});if((W[x]||(W[x]=new nl)).bind(N,this,T,D?D.getPaintVertexBuffers():[],S,te.vertexOffset,O||[],H),this.forceManualRenderingForInstanceIDShaders){const re=V||1;for(let ee=0;ee<re;++ee)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ee),S?j.drawElements(n,te.primitiveLength*Z,j.UNSIGNED_SHORT,te.primitiveOffset*Z*2):j.drawArrays(n,te.vertexOffset,te.vertexLength)}else V&&V>1?j.drawElementsInstanced(n,te.primitiveLength*Z,j.UNSIGNED_SHORT,te.primitiveOffset*Z*2,V):S?j.drawElements(n,te.primitiveLength*Z,j.UNSIGNED_SHORT,te.primitiveOffset*Z*2):j.drawArrays(n,te.vertexOffset,te.vertexLength);n===j.TRIANGLES&&S&&this._drawDebugWireframe(t,c,d,p,S,te,E,P,D,V)}}}function iu(l,t,n=0){const c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,p=d*(t.tileID.canonical.x+t.tileID.wrap*c),m=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.ay(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,m>>16],u_pixel_coord_lower:[65535&p,65535&m],u_pattern_transition:n}}const cl={terrain:0,flat:1},ru=o.bB(),nu=(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N)=>{const j=t.style.light,Z=j.properties.get("position"),H=[Z.x,Z.y,Z.z],te=o.dN();j.properties.get("anchor")==="viewport"&&(o.dO(te,-t.transform.angle),o.dP(H,H,te));const W=j.properties.get("color").toPremultipliedRenderColor(null),re=t.transform,ee={u_matrix:l,u_lightpos:H,u_lightintensity:j.properties.get("intensity"),u_lightcolor:[W.r,W.g,W.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ru,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:cl[T],u_base_type:cl[S],u_ao:d,u_edge_radius:p,u_width_scale:m,u_flood_light_color:D,u_vertical_scale:O,u_flood_light_intensity:V,u_ground_shadow_factor:N};return re.projection.name==="globe"&&(ee.u_tile_id=[y.canonical.x,y.canonical.y,1<<y.canonical.z],ee.u_zoom_transition=M,ee.u_inv_rot_matrix=P,ee.u_merc_center=E,ee.u_up_dir=re.projection.upVector(new o.cC(0,0,0),E[0]*o.al,E[1]*o.al),ee.u_height_lift=x),ee},Ff=(l,t,n,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:cl[d],u_base_type:cl[p]}),Bf=(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N)=>{const j=nu(l,t,n,c,d,p,m,y,T,S,M,E,P,D,O,V,1,[0,0,0]),Z={u_height_factor:-Math.pow(2,y.overscaledZ)/x.tileSize/8};return Object.assign(j,iu(t,x,N),Z)},ul=(l,t,n,c,d,p,m,y,x,T,S)=>({u_matrix:t,u_opacity:n,u_ao_pass:c?1:0,u_meter_to_tile:d,u_ao:p,u_flood_light_intensity:m,u_flood_light_color:y,u_attenuation:x,u_edge_radius:T,u_fb:0,u_fb_size:S,u_dynamic_offset:1}),Nf=(l,t,n)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:n}),Vf=(l,t,n,c,d,p=0)=>Object.assign(Nf(l,t,d),iu(n,c,p)),Om=(l,t,n,c)=>({u_matrix:l,u_world:n,u_emissive_strength:t,u_ground_shadow_factor:c}),km=(l,t,n,c,d,p,m=0)=>Object.assign(Vf(l,t,n,c,p,m),{u_world:d}),Fm=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),su=(l,t,n,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:n,u_height_scale:c,u_reset_depth:d}),Fh=(l,t,n,c,d,p,m,y,x)=>({u_matrix:l,u_normal_matrix:t,u_opacity:n,u_faux_facade_ao_intensity:c,u_camera_pos:d,u_tile_to_meter:p,u_facade_emissive_chance:m,u_flood_light_color:y,u_flood_light_intensity:x}),Bh=l=>({u_matrix:l}),Uf=l=>({u_matrix:l}),hl=(l,t,n,c,d,p,m,y)=>{const x=o.al/p.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:n.getCameraToCenterDistance(y),u_extrude_scale:[n.pixelsToGLUnits[0]/x,n.pixelsToGLUnits[1]/x],u_zoom_transition:c,u_tile_id:m,u_merc_center:d}},Nh=(l,t,n=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:n}),jf=o.bB(),Gf=(l,t,n,c,d,p,m)=>{const y=l.transform,x=y.projection.name==="globe",T=x?o.dQ(y.zoom,t.canonical)*y._pixelsPerMercatorPixel:o.ay(n,1,p),S={u_matrix:t.projMatrix,u_extrude_scale:T,u_intensity:m,u_inv_rot_matrix:jf,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(x){S.u_inv_rot_matrix=c,S.u_merc_center=d,S.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],S.u_zoom_transition=o.aj(y.zoom);const M=d[0]*o.al,E=d[1]*o.al;S.u_up_dir=y.projection.upVector(new o.cC(0,0,0),M,E)}return S};function ou(l,[t,n,c,d],[p,m]){if(p===m)return[0,0,0,0];const y=255*(l-1)/(l*(m-p));return[t*y,n*y,c*y,d*y]}function qo(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const fc=(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j,Z,H)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity*M.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:M.paint.get("raster-brightness-min"),u_brightness_high:M.paint.get("raster-brightness-max"),u_saturation_factor:o.dS(M.paint.get("raster-saturation")),u_contrast_factor:o.dR(M.paint.get("raster-contrast")),u_spin_weights:au(M.paint.get("raster-hue-rotate")),u_perspective_transform:E,u_raster_elevation:P,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:x,u_colorization_mix:ou(o.dT,O,N),u_colorization_offset:qo(o.dT,V,N),u_color_ramp:D,u_texture_offset:[Z/(j+2*Z),j/(j+2*Z)],u_texture_res:[j+2*Z,j+2*Z],u_emissive_strength:H});function au(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const za=.05,aa=(l,t,n,c,d,p,m,y,x,T,S,M)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:T,u_fade_t:S.mix,u_opacity:S.opacity,u_image0:0,u_image1:1,u_raster_elevation:M,u_zoom_transition:m,u_merc_center:y,u_cutoff_params:x}),Vh=(l,t,n,c,d,p,m,y,x,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:m,u_uv_offset:y,u_data_scale:[255*x[0],255*x[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[za,za]}),lu=(l,t,n,c,d,p,m,y,x,T)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:m,u_rand_seed:Math.random(),u_uv_offset:y,u_data_scale:[255*x[0],255*x[1]],u_data_offset:T,u_particle_pos_scale:1.1,u_particle_pos_offset:[za,za]}),Uh=o.bB(),jh=(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j,Z,H,te,W,re)=>{const ee=d.transform,K={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:ee.getCameraToCenterDistance(j),u_rotate_symbol:+n,u_aspect_ratio:ee.width/ee.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:m,u_coord_matrix:y,u_is_text:+T,u_elevation_from_sea:x?1:0,u_pitch_with_map:+c,u_texsize:S,u_texsize_icon:M,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Uh,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Uh,u_up_vector:[0,-1,0],u_color_adj_mat:te,u_icon_transition:W||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(j)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:o.o.devicePixelRatio,u_is_halo:1,u_scale_factor:re||1,u_ground_shadow_factor:Z,u_inv_matrix:o.bk(o.bB(),m),u_normal_scale:H,u_lutTexture:qn.LUT};return j.name==="globe"&&(K.u_tile_id=[P.canonical.x,P.canonical.y,1<<P.canonical.z],K.u_zoom_transition=D,K.u_inv_rot_matrix=V,K.u_merc_center=O,K.u_camera_forward=ee._camera.forward(),K.u_ecef_origin=o.dU(ee.globeMatrix,P.toUnwrapped()),K.u_tile_matrix=Float32Array.from(ee.globeMatrix),K.u_up_vector=N),K},cu=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),uu=(l,t,n,c,d,p,m,y,x)=>Object.assign((function(T,S,M,E,P,D){const{width:O,height:V}=E.imageManager.getPixelSize(S),N=Math.pow(2,D.tileID.overscaledZ),j=D.tileSize*Math.pow(2,E.transform.tileZoom)/N,Z=j*(D.tileID.canonical.x+D.tileID.wrap*N),H=j*D.tileID.canonical.y;return{u_image:0,u_pattern_tl:M.tl,u_pattern_br:M.br,u_texsize:[O,V],u_pattern_size:M.displaySize,u_pattern_units_to_pixels:P?[E.transform.width,-1*E.transform.height]:[1/o.ay(D,1,E.transform.tileZoom),1/o.ay(D,1,E.transform.tileZoom)],u_pixel_coord_upper:[Z>>16,H>>16],u_pixel_coord_lower:[65535&Z,65535&H]}})(0,p,m,c,y,x),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),Gh=new Float32Array(o.bz([])),hu=(l,t,n,c,d,p,m,y,x,T,S,M,E,P=[0,0,0],D,O,V)=>{const N=d.style.light,j=N.properties.get("position"),Z=[-j.x,-j.y,j.z],H=o.dN();N.properties.get("anchor")==="viewport"&&(o.dO(H,-d.transform.angle),o.dP(Z,Z,H));const te=S.alphaMode==="MASK",W=N.properties.get("color").toNonPremultipliedRenderColor(null),re=E.paint.get("model-ambient-occlusion-intensity"),ee=E.paint.get("model-color").constantOr(o.ao.white).toNonPremultipliedRenderColor(null);return ee.a=E.paint.get("model-color-mix-intensity").constantOr(0),V&&(ee.r=V[0],ee.g=V[1],ee.b=V[2],ee.a=V[3]),O&&(ee.r=O.color.r,ee.g=O.color.g,ee.b=O.color.b,ee.a=O.colorMix,M=O.emissionStrength,p=O.opacity),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||Gh,u_lightpos:Z,u_lightintensity:N.properties.get("intensity"),u_lightcolor:[W.r,W.g,W.b],u_camera_pos:P,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+te,u_alphaCutoff:S.alphaCutoff,u_baseColorFactor:m.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:y.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:x,u_roughnessFactor:T,u_baseColorTexture:qn.BaseColor,u_metallicRoughnessTexture:qn.MetallicRoughness,u_normalTexture:qn.Normal,u_occlusionTexture:qn.Occlusion,u_emissionTexture:qn.Emission,u_lutTexture:qn.LUT,u_color_mix:ee.toArray01(),u_aoIntensity:re,u_emissive_strength:M,u_occlusionTextureTransform:D||[0,0,0,0]}},dl=(l,t=Gh,n=Gh)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),Bm={fillExtrusion:l=>({u_matrix:new o.ck(l),u_lightpos:new o.ch(l),u_lightintensity:new o.ci(l),u_lightcolor:new o.ch(l),u_vertical_gradient:new o.ci(l),u_opacity:new o.ci(l),u_edge_radius:new o.ci(l),u_width_scale:new o.ci(l),u_ao:new o.cj(l),u_height_type:new o.cg(l),u_base_type:new o.cg(l),u_tile_id:new o.ch(l),u_zoom_transition:new o.ci(l),u_inv_rot_matrix:new o.ck(l),u_merc_center:new o.cj(l),u_up_dir:new o.ch(l),u_height_lift:new o.ci(l),u_flood_light_color:new o.ch(l),u_vertical_scale:new o.ci(l),u_flood_light_intensity:new o.ci(l),u_ground_shadow_factor:new o.ch(l)}),fillExtrusionDepth:l=>({u_matrix:new o.ck(l),u_edge_radius:new o.ci(l),u_width_scale:new o.ci(l),u_vertical_scale:new o.ci(l),u_height_type:new o.cg(l),u_base_type:new o.cg(l)}),fillExtrusionPattern:l=>({u_matrix:new o.ck(l),u_lightpos:new o.ch(l),u_lightintensity:new o.ci(l),u_lightcolor:new o.ch(l),u_vertical_gradient:new o.ci(l),u_height_factor:new o.ci(l),u_edge_radius:new o.ci(l),u_width_scale:new o.ci(l),u_ao:new o.cj(l),u_height_type:new o.cg(l),u_base_type:new o.cg(l),u_tile_id:new o.ch(l),u_zoom_transition:new o.ci(l),u_inv_rot_matrix:new o.ck(l),u_merc_center:new o.cj(l),u_up_dir:new o.ch(l),u_height_lift:new o.ci(l),u_image:new o.cg(l),u_texsize:new o.cj(l),u_pixel_coord_upper:new o.cj(l),u_pixel_coord_lower:new o.cj(l),u_tile_units_to_pixels:new o.ci(l),u_opacity:new o.ci(l),u_pattern_transition:new o.ci(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new o.ck(l),u_opacity:new o.ci(l),u_ao_pass:new o.ci(l),u_meter_to_tile:new o.ci(l),u_ao:new o.cj(l),u_flood_light_intensity:new o.ci(l),u_flood_light_color:new o.ch(l),u_attenuation:new o.ci(l),u_edge_radius:new o.ci(l),u_fb:new o.cg(l),u_fb_size:new o.ci(l),u_dynamic_offset:new o.ci(l)}),fill:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_ground_shadow_factor:new o.ch(l)}),fillPattern:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_image:new o.cg(l),u_texsize:new o.cj(l),u_pixel_coord_upper:new o.cj(l),u_pixel_coord_lower:new o.cj(l),u_tile_units_to_pixels:new o.ci(l),u_ground_shadow_factor:new o.ch(l),u_pattern_transition:new o.ci(l)}),fillOutline:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_world:new o.cj(l),u_ground_shadow_factor:new o.ch(l)}),fillOutlinePattern:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_world:new o.cj(l),u_image:new o.cg(l),u_texsize:new o.cj(l),u_pixel_coord_upper:new o.cj(l),u_pixel_coord_lower:new o.cj(l),u_tile_units_to_pixels:new o.ci(l),u_ground_shadow_factor:new o.ch(l),u_pattern_transition:new o.ci(l)}),building:l=>({u_matrix:new o.ck(l),u_normal_matrix:new o.ck(l),u_opacity:new o.ci(l),u_faux_facade_ao_intensity:new o.ci(l),u_camera_pos:new o.ch(l),u_tile_to_meter:new o.ci(l),u_facade_emissive_chance:new o.ci(l),u_flood_light_color:new o.ch(l),u_flood_light_intensity:new o.ci(l)}),buildingBloom:l=>({u_matrix:new o.ck(l)}),buildingDepth:l=>({u_matrix:new o.ck(l)}),elevatedStructuresDepth:l=>({u_matrix:new o.ck(l),u_depth_bias:new o.ci(l)}),elevatedStructures:l=>({u_matrix:new o.ck(l),u_ground_shadow_factor:new o.ch(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new o.ck(l),u_camera_pos:new o.ch(l),u_depth_bias:new o.ci(l),u_height_scale:new o.ci(l),u_reset_depth:new o.ci(l)}),circle:o.dX,collisionBox:l=>({u_matrix:new o.ck(l),u_inv_rot_matrix:new o.ck(l),u_camera_to_center_distance:new o.ci(l),u_extrude_scale:new o.cj(l),u_zoom_transition:new o.ci(l),u_merc_center:new o.cj(l),u_tile_id:new o.ch(l)}),collisionCircle:l=>({u_matrix:new o.ck(l),u_inv_matrix:new o.ck(l),u_camera_to_center_distance:new o.ci(l),u_viewport_size:new o.cj(l)}),debug:l=>({u_color:new o.dA(l),u_matrix:new o.ck(l),u_overlay:new o.cg(l),u_overlay_scale:new o.ci(l)}),clippingMask:l=>({u_matrix:new o.ck(l)}),heatmap:l=>({u_extrude_scale:new o.ci(l),u_intensity:new o.ci(l),u_matrix:new o.ck(l),u_inv_rot_matrix:new o.ck(l),u_merc_center:new o.cj(l),u_tile_id:new o.ch(l),u_zoom_transition:new o.ci(l),u_up_dir:new o.ch(l)}),heatmapTexture:l=>({u_image:new o.cg(l),u_color_ramp:new o.cg(l),u_opacity:new o.ci(l)}),hillshade:l=>({u_matrix:new o.ck(l),u_image:new o.cg(l),u_latrange:new o.cj(l),u_light:new o.cj(l),u_shadow:new o.dA(l),u_highlight:new o.dA(l),u_emissive_strength:new o.ci(l),u_accent:new o.dA(l)}),hillshadePrepare:l=>({u_matrix:new o.ck(l),u_image:new o.cg(l),u_dimension:new o.cj(l),u_zoom:new o.ci(l)}),line:o.dW,linePattern:o.dV,raster:l=>({u_matrix:new o.ck(l),u_normalize_matrix:new o.ck(l),u_globe_matrix:new o.ck(l),u_merc_matrix:new o.ck(l),u_grid_matrix:new o.dB(l),u_tl_parent:new o.cj(l),u_scale_parent:new o.ci(l),u_fade_t:new o.ci(l),u_opacity:new o.ci(l),u_image0:new o.cg(l),u_image1:new o.cg(l),u_brightness_low:new o.ci(l),u_brightness_high:new o.ci(l),u_saturation_factor:new o.ci(l),u_contrast_factor:new o.ci(l),u_spin_weights:new o.ch(l),u_perspective_transform:new o.cj(l),u_raster_elevation:new o.ci(l),u_zoom_transition:new o.ci(l),u_merc_center:new o.cj(l),u_cutoff_params:new o.d2(l),u_colorization_mix:new o.d2(l),u_colorization_offset:new o.ci(l),u_color_ramp:new o.cg(l),u_texture_offset:new o.cj(l),u_texture_res:new o.cj(l),u_emissive_strength:new o.ci(l)}),rasterParticle:l=>({u_matrix:new o.ck(l),u_normalize_matrix:new o.ck(l),u_globe_matrix:new o.ck(l),u_merc_matrix:new o.ck(l),u_grid_matrix:new o.dB(l),u_tl_parent:new o.cj(l),u_scale_parent:new o.ci(l),u_fade_t:new o.ci(l),u_opacity:new o.ci(l),u_image0:new o.cg(l),u_image1:new o.cg(l),u_raster_elevation:new o.ci(l),u_zoom_transition:new o.ci(l),u_merc_center:new o.cj(l),u_cutoff_params:new o.d2(l)}),rasterParticleTexture:l=>({u_texture:new o.cg(l),u_opacity:new o.ci(l)}),rasterParticleDraw:l=>({u_particle_texture:new o.cg(l),u_particle_texture_side_len:new o.ci(l),u_tile_offset:new o.cj(l),u_velocity:new o.cg(l),u_color_ramp:new o.cg(l),u_velocity_res:new o.cj(l),u_max_speed:new o.ci(l),u_uv_offset:new o.cj(l),u_data_scale:new o.cj(l),u_data_offset:new o.ci(l),u_particle_pos_scale:new o.ci(l),u_particle_pos_offset:new o.cj(l)}),rasterParticleUpdate:l=>({u_particle_texture:new o.cg(l),u_particle_texture_side_len:new o.ci(l),u_velocity:new o.cg(l),u_velocity_res:new o.cj(l),u_max_speed:new o.ci(l),u_speed_factor:new o.ci(l),u_reset_rate:new o.ci(l),u_rand_seed:new o.ci(l),u_uv_offset:new o.cj(l),u_data_scale:new o.cj(l),u_data_offset:new o.ci(l),u_particle_pos_scale:new o.ci(l),u_particle_pos_offset:new o.cj(l)}),symbol:l=>({u_is_size_zoom_constant:new o.cg(l),u_is_size_feature_constant:new o.cg(l),u_size_t:new o.ci(l),u_size:new o.ci(l),u_camera_to_center_distance:new o.ci(l),u_rotate_symbol:new o.cg(l),u_aspect_ratio:new o.ci(l),u_fade_change:new o.ci(l),u_matrix:new o.ck(l),u_label_plane_matrix:new o.ck(l),u_coord_matrix:new o.ck(l),u_is_text:new o.cg(l),u_elevation_from_sea:new o.cg(l),u_pitch_with_map:new o.cg(l),u_texsize:new o.cj(l),u_texsize_icon:new o.cj(l),u_texture:new o.cg(l),u_texture_icon:new o.cg(l),u_gamma_scale:new o.ci(l),u_device_pixel_ratio:new o.ci(l),u_tile_id:new o.ch(l),u_zoom_transition:new o.ci(l),u_inv_rot_matrix:new o.ck(l),u_merc_center:new o.cj(l),u_camera_forward:new o.ch(l),u_tile_matrix:new o.ck(l),u_up_vector:new o.ch(l),u_ecef_origin:new o.ch(l),u_is_halo:new o.cg(l),u_icon_transition:new o.ci(l),u_color_adj_mat:new o.ck(l),u_scale_factor:new o.ci(l),u_ground_shadow_factor:new o.ch(l),u_inv_matrix:new o.ck(l),u_normal_scale:new o.ci(l),u_lutTexture:new o.cg(l)}),background:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_opacity:new o.ci(l),u_color:new o.dA(l)}),backgroundPattern:l=>({u_matrix:new o.ck(l),u_emissive_strength:new o.ci(l),u_opacity:new o.ci(l),u_image:new o.cg(l),u_pattern_tl:new o.cj(l),u_pattern_br:new o.cj(l),u_texsize:new o.cj(l),u_pattern_size:new o.cj(l),u_pixel_coord_upper:new o.cj(l),u_pixel_coord_lower:new o.cj(l),u_pattern_units_to_pixels:new o.cj(l)}),terrainRaster:l=>({u_matrix:new o.ck(l),u_image0:new o.cg(l),u_skirt_height:new o.ci(l),u_ground_shadow_factor:new o.ch(l)}),skybox:l=>({u_matrix:new o.ck(l),u_sun_direction:new o.ch(l),u_cubemap:new o.cg(l),u_opacity:new o.ci(l),u_temporal_offset:new o.ci(l)}),skyboxGradient:l=>({u_matrix:new o.ck(l),u_color_ramp:new o.cg(l),u_center_direction:new o.ch(l),u_radius:new o.ci(l),u_opacity:new o.ci(l),u_temporal_offset:new o.ci(l)}),skyboxCapture:l=>({u_matrix_3f:new o.dB(l),u_sun_direction:new o.ch(l),u_sun_intensity:new o.ci(l),u_color_tint_r:new o.d2(l),u_color_tint_m:new o.d2(l),u_luminance:new o.ci(l)}),globeRaster:l=>({u_proj_matrix:new o.ck(l),u_globe_matrix:new o.ck(l),u_normalize_matrix:new o.ck(l),u_merc_matrix:new o.ck(l),u_zoom_transition:new o.ci(l),u_merc_center:new o.cj(l),u_image0:new o.cg(l),u_grid_matrix:new o.dB(l),u_skirt_height:new o.ci(l),u_far_z_cutoff:new o.ci(l),u_frustum_tl:new o.ch(l),u_frustum_tr:new o.ch(l),u_frustum_br:new o.ch(l),u_frustum_bl:new o.ch(l),u_globe_pos:new o.ch(l),u_globe_radius:new o.ci(l),u_viewport:new o.cj(l)}),globeAtmosphere:l=>({u_frustum_tl:new o.ch(l),u_frustum_tr:new o.ch(l),u_frustum_br:new o.ch(l),u_frustum_bl:new o.ch(l),u_horizon:new o.ci(l),u_transition:new o.ci(l),u_fadeout_range:new o.ci(l),u_atmosphere_fog_color:new o.d2(l),u_high_color:new o.d2(l),u_space_color:new o.d2(l),u_temporal_offset:new o.ci(l),u_horizon_angle:new o.ci(l)}),model:l=>({u_matrix:new o.ck(l),u_lighting_matrix:new o.ck(l),u_normal_matrix:new o.ck(l),u_node_matrix:new o.ck(l),u_lightpos:new o.ch(l),u_lightintensity:new o.ci(l),u_lightcolor:new o.ch(l),u_camera_pos:new o.ch(l),u_opacity:new o.ci(l),u_baseColorFactor:new o.d2(l),u_emissiveFactor:new o.d2(l),u_metallicFactor:new o.ci(l),u_roughnessFactor:new o.ci(l),u_baseTextureIsAlpha:new o.cg(l),u_alphaMask:new o.cg(l),u_alphaCutoff:new o.ci(l),u_baseColorTexture:new o.cg(l),u_metallicRoughnessTexture:new o.cg(l),u_normalTexture:new o.cg(l),u_occlusionTexture:new o.cg(l),u_emissionTexture:new o.cg(l),u_lutTexture:new o.cg(l),u_color_mix:new o.d2(l),u_aoIntensity:new o.ci(l),u_emissive_strength:new o.ci(l),u_occlusionTextureTransform:new o.d2(l)}),modelDepth:l=>({u_matrix:new o.ck(l),u_instance:new o.ck(l),u_node_matrix:new o.ck(l)}),groundShadow:l=>({u_matrix:new o.ck(l),u_ground_shadow_factor:new o.ch(l)}),stars:l=>({u_matrix:new o.ck(l),u_up:new o.ch(l),u_right:new o.ch(l),u_intensity_multiplier:new o.ci(l)}),snowParticle:l=>({u_modelview:new o.ck(l),u_projection:new o.ck(l),u_time:new o.ci(l),u_cam_pos:new o.ch(l),u_velocityConeAperture:new o.ci(l),u_velocity:new o.ci(l),u_horizontalOscillationRadius:new o.ci(l),u_horizontalOscillationRate:new o.ci(l),u_boxSize:new o.ci(l),u_billboardSize:new o.ci(l),u_simpleShapeParameters:new o.cj(l),u_screenSize:new o.cj(l),u_thinningCenterPos:new o.cj(l),u_thinningShape:new o.ch(l),u_thinningAffectedRatio:new o.ci(l),u_thinningParticleOffset:new o.ci(l),u_particleColor:new o.d2(l),u_direction:new o.ch(l)}),rainParticle:l=>({u_modelview:new o.ck(l),u_projection:new o.ck(l),u_time:new o.ci(l),u_cam_pos:new o.ch(l),u_texScreen:new o.cg(l),u_velocityConeAperture:new o.ci(l),u_velocity:new o.ci(l),u_boxSize:new o.ci(l),u_rainDropletSize:new o.cj(l),u_distortionStrength:new o.ci(l),u_rainDirection:new o.ch(l),u_color:new o.d2(l),u_screenSize:new o.cj(l),u_thinningCenterPos:new o.cj(l),u_thinningShape:new o.ch(l),u_thinningAffectedRatio:new o.ci(l),u_thinningParticleOffset:new o.ci(l),u_shapeDirectionalPower:new o.ci(l),u_shapeNormalPower:new o.ci(l),u_mode:new o.ci(l)}),vignette:l=>({u_vignetteShape:new o.ch(l),u_vignetteColor:new o.d2(l)}),occlusion:l=>({u_matrix:new o.ck(l),u_anchorPos:new o.ch(l),u_screenSizePx:new o.cj(l),u_occluderSizePx:new o.cj(l),u_color:new o.d2(l)})};class la{constructor(t,n,c,d){this.id=la.uniqueIdxCounter,la.uniqueIdxCounter++,this.context=t;const p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=la.uniqueIdxCounter,la.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}la.uniqueIdxCounter=0;const Hf={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Nm{constructor(t,n,c,d,p,m){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.instanceCount=m,this.context=t;const y=t.gl;this.buffer=y.createBuffer(),t.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||p||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.getAttributeLocation(t,this.attributes[c].name);d!==-1&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=this.attributes[d],m=n.getAttributeLocation(t,p.name);m!==-1&&t.vertexAttribPointer(m,p.components,t[Hf[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=n.getAttributeLocation(t,this.attributes[d].name);p!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class du{constructor(t,n,c,d,p){this.context=t,this.width=n,this.height=c;const m=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new zm(t,m)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new Of(t,m):new Lm(t,m))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class fu{constructor(t,n){this.gl=t,this.clearColor=new Af(this),this.clearDepth=new Eh(this),this.clearStencil=new Am(this),this.colorMask=new Mm(this),this.depthMask=new Cm(this),this.stencilMask=new Pm(this),this.stencilFunc=new Mf(this),this.stencilOp=new Rm(this),this.stencilTest=new Zc(this),this.depthRange=new Dm(this),this.depthTest=new Cf(this),this.depthFunc=new Ih(this),this.blend=new Wc(this),this.blendFunc=new Ah(this),this.blendColor=new Pa(this),this.blendEquation=new sl(this),this.cullFace=new ac(this),this.cullFaceSide=new ol(this),this.frontFace=new Pf(this),this.program=new Mh(this),this.activeTexture=new Rf(this),this.viewport=new al(this),this.bindFramebuffer=new Xc(this),this.bindRenderbuffer=new Yc(this),this.bindTexture=new Ch(this),this.bindVertexBuffer=new Kc(this),this.bindElementBuffer=new lc(this),this.bindVertexArrayOES=new Df(this),this.pixelStoreUnpack=new zf(this),this.pixelStoreUnpackPremultiplyAlpha=new Lf(this),this.pixelStoreUnpackFlipY=new ll(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new la(this,t,n,c)}createVertexBuffer(t,n,c,d,p){return new Nm(this,t,n,c,d,p)}createRenderbuffer(t,n,c){const d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,n,c,d){return new du(this,t,n,c,d)}clear({color:t,depth:n,stencil:c,colorMask:d}){const p=this.gl;let m=0;t&&(m|=p.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),n!==void 0&&(m|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(m|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(m)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){o.bx(t.blendFunction,ni.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Oo;function pc(l,t,n,c,d,p,m){const y=l.context,x=y.gl,T=l.transform,S=[o.aF(T.center.lng),o.aJ(T.center.lat)],M=n.layout.get("symbol-placement"),E=n.layout.get("text-variable-anchor"),P=n.layout.get("icon-rotation-alignment")==="map",D=n.layout.get("text-rotation-alignment")==="map",O=M!=="point",V=[];let N=0,j=0;for(let K=0;K<c.length;K++){const ne=c[K],_e=t.getTile(ne),fe=_e.getBucket(n);if(!fe)continue;const Me=fe.getProjection().createInversionMatrix(T,ne.canonical),we=[],ze=vf(ne,fe,T),Je=!m&&P&&O,xe=m&&D&&O,ce=E&&fe.hasTextData(),Le=fe.hasIconTextFit()&&ce&&fe.hasIconData(),Te=Je||xe||m&&ce||Le,je=fe.projection.name==="globe",rt=je?o.aj(T.zoom):0;je&&(we.push("PROJECTION_GLOBE_VIEW"),Te&&we.push("PROJECTED_POS_ON_VIEWPORT"));const gt=l.getOrCreateProgram("collisionBox",{defines:we});let Xe=ze;d[0]===0&&d[1]===0||(Xe=l.translatePosMatrix(ze,_e,d,p));const et=m?fe.textCollisionBox:fe.iconCollisionBox,xt=fe.collisionCircleArray;if(xt.length>0){const ut=o.bB(),ft=Xe;o.cO(ut,fe.placementInvProjMatrix,T.glCoordMatrix),o.cO(ut,ut,fe.placementViewportMatrix),V.push({circleArray:xt,circleOffset:j,transform:ft,invTransform:ut,projection:fe.getProjection()}),N+=xt.length/4,j=N}if(!et)continue;l.terrain&&l.terrain.setupElevationDraw(_e,gt);const dt=je?[ne.canonical.x,ne.canonical.y,1<<ne.canonical.z]:[0,0,0];gt.draw(l,x.LINES,wt.disabled,Zt.disabled,l.colorModeForRenderPass(),jt.disabled,hl(Xe,Me,T,rt,S,_e,dt,fe.getProjection()),n.id,et.layoutVertexBuffer,et.indexBuffer,et.segments,null,T.zoom,null,[et.collisionVertexBuffer,et.collisionVertexBufferExt])}if(!m||!V.length)return;const Z=l.getOrCreateProgram("collisionCircle"),H=new o.dY;H.resize(4*N),H._trim();let te=0;for(const K of V)for(let ne=0;ne<K.circleArray.length/4;ne++){const _e=4*ne,fe=K.circleArray[_e+0],Me=K.circleArray[_e+1],we=K.circleArray[_e+2],ze=K.circleArray[_e+3];H.emplace(te++,fe,Me,we,ze,0),H.emplace(te++,fe,Me,we,ze,1),H.emplace(te++,fe,Me,we,ze,2),H.emplace(te++,fe,Me,we,ze,3)}(!Oo||Oo.length<2*N)&&(Oo=(function(K){const ne=2*K,_e=new o.b0;_e.resize(ne),_e._trim();for(let fe=0;fe<ne;fe++){const Me=6*fe;_e.uint16[Me+0]=4*fe+0,_e.uint16[Me+1]=4*fe+1,_e.uint16[Me+2]=4*fe+2,_e.uint16[Me+3]=4*fe+2,_e.uint16[Me+4]=4*fe+3,_e.uint16[Me+5]=4*fe+0}return _e})(N));const W=y.createIndexBuffer(Oo,!0),re=y.createVertexBuffer(H,o.dZ.members,!0);for(const K of V){const ne={u_matrix:K.transform,u_inv_matrix:K.invTransform,u_camera_to_center_distance:(ee=T).getCameraToCenterDistance(K.projection),u_viewport_size:[ee.width,ee.height]};Z.draw(l,x.TRIANGLES,wt.disabled,Zt.disabled,l.colorModeForRenderPass(),jt.disabled,ne,n.id,re,W,o.bf.simpleSegment(0,2*K.circleOffset,K.circleArray.length,K.circleArray.length/2),null,T.zoom)}var ee;re.destroy(),W.destroy()}const ca=o.bB();function Hh(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=o.aB([],t,l.globeMatrix);o.bk(n,n);const c=[0,0,0],d=[0,1,0,0];return o.aC(d,d,n),c[0]=d[0],c[1]=d[1],c[2]=d[2],o.aw(c,c),c}function pu({width:l,height:t,anchor:n,textOffset:c,textScale:d},p){const{horizontalAlign:m,verticalAlign:y}=o.c0(n),x=-(m-.5)*l,T=-(y-.5)*t,S=o.c1(n,c);return new o.P((x/d+S[0])*p,(T/d+S[1])*p)}function mu(l,t,n,c,d,p,m,y,x,T){const S=l.text.placedSymbolArray,M=l.text.dynamicLayoutVertexArray,E=l.icon.dynamicLayoutVertexArray,P={},D=l.getProjection(),O=Oc(m,D,d),V=d.elevation,N=D.upVectorScale(m.canonical,d.center.lat,d.worldSize).metersToTile;M.clear();for(let j=0;j<S.length;j++){const Z=S.get(j),{tileAnchorX:H,tileAnchorY:te,numGlyphs:W}=Z,re=Z.hidden||!Z.crossTileID||l.allowVerticalPlacement&&!Z.placedOrientation?null:c[Z.crossTileID];if(re){let ee=0,K=0,ne=0;const _e=l.elevationType==="road";if(V||_e){const Te=_e?l.getElevationFeatureForText(j):null,je=o.bU.getAtTileOffset(m,new o.P(H,te),V,Te),[rt,gt,Xe]=D.upVector(m.canonical,H,te);ee=je*rt*N,K=je*gt*N,ne=je*Xe*N}let[fe,Me,we,ze]=An(Z.projectedAnchorX+ee,Z.projectedAnchorY+K,Z.projectedAnchorZ+ne,n?O:p);const Je=dh(d.getCameraToCenterDistance(D),ze);let xe=o.bL(l.textSizeData,x,Z)*Je/o.bX;n&&(xe*=l.tilePixelRatio/y);const ce=pu(re,xe);n?({x:fe,y:Me,z:we}=D.projectTilePoint(H+ce.x,te+ce.y,m.canonical),[fe,Me,we]=An(fe+ee,Me+K,we+ne,p)):(t&&ce._rotate(-d.angle),fe+=ce.x,Me+=ce.y,we=0);const Le=l.allowVerticalPlacement&&Z.placedOrientation===o.bK.vertical?Math.PI/2:0;for(let Te=0;Te<W;Te++)o.bN(M,fe,Me,we,Le);T&&Z.associatedIconIndex>=0&&(P[Z.associatedIconIndex]={x:fe,y:Me,z:we,angle:Le})}else Uo(W,M)}if(T){E.clear();const j=l.icon.placedSymbolArray;for(let Z=0;Z<j.length;Z++){const H=j.get(Z),{numGlyphs:te}=H,W=P[Z];if(H.hidden||!W)Uo(te,E);else{const{x:re,y:ee,z:K,angle:ne}=W;for(let _e=0;_e<te;_e++)o.bN(E,re,ee,K,ne)}}l.icon.dynamicLayoutVertexBuffer.updateData(E)}l.text.dynamicLayoutVertexBuffer.updateData(M)}function mc(l,t,n,c,d,p,m={}){const y=n.paint.get("icon-translate"),x=n.paint.get("text-translate"),T=n.paint.get("icon-translate-anchor"),S=n.paint.get("text-translate-anchor"),M=n.layout.get("icon-rotation-alignment"),E=n.layout.get("text-rotation-alignment"),P=n.layout.get("icon-pitch-alignment"),D=n.layout.get("text-pitch-alignment"),O=n.layout.get("icon-keep-upright"),V=n.layout.get("text-keep-upright"),N=n.paint.get("icon-color-saturation"),j=n.paint.get("icon-color-contrast"),Z=n.paint.get("icon-color-brightness-min"),H=n.paint.get("icon-color-brightness-max"),te=n.layout.get("symbol-elevation-reference")==="sea",W=n.layout.get("icon-image-use-theme")==="none",re=l.context,ee=re.gl,K=l.transform,ne=M==="map",_e=E==="map",fe=P==="map",Me=D==="map",we=n.layout.get("symbol-sort-key").constantOr(1)!==void 0;let ze=!1;const Je=l.depthModeForSublayer(0,wt.ReadOnly),xe=new wt(l.context.gl.LEQUAL,wt.ReadOnly,l.depthRangeFor3D),ce=[o.aF(K.center.lng),o.aJ(K.center.lat)],Le=n.layout.get("text-variable-anchor"),Te=K.projection.name==="globe",je=[],rt=[0,-1,0];for(const gt of c){const Xe=t.getTile(gt),et=Xe.getBucket(n);if(!et||et.projection.name==="mercator"&&Te||et.fullyClipped)continue;const xt=et.projection.name==="globe",dt=xt?o.aj(K.zoom):0,ut=Oc(gt,et.getProjection(),K),ft=K.calculatePixelsToTileUnitsMatrix(Xe),zt=Le&&et.hasTextData(),pi=et.hasIconTextFit()&&zt&&et.hasIconData(),vi=et.getProjection().createInversionMatrix(K,gt.canonical),tr=(1<<Xe.tileID.canonical.z)*o.al/l.transform.worldSize,Gt=Ui=>{let qt=[0,0,0];if(Ui){const Ti=l.style.directionalLight,Or=l.style.ambientLight;Ti&&Or&&(qt=mo(l.style,Ti,Or))}return qt},xi=Ui=>{K.depthOcclusionForSymbolsAndCircles&&(n.hasOcclusionOpacityProperties||l.terrain)&&(Ui.push("DEPTH_D24"),Ui.push("DEPTH_OCCLUSION"))},ti=Ui=>{n.lut&&!W&&(n.lut.texture||(n.lut.texture=new o.d_(l.context,n.lut.image,[n.lut.image.height,n.lut.image.height,n.lut.image.height],re.gl.RGBA8)),re.activeTexture.set(re.gl.TEXTURE0+qn.LUT),n.lut.texture&&n.lut.texture.bind(re.gl.LINEAR,re.gl.CLAMP_TO_EDGE),Ui.push("APPLY_LUT_ON_GPU"))},Zi=()=>{const Ui=ne&&n.layout.get("symbol-placement")!=="point",qt=[];xi(qt),ti(qt);const Ti=Ui||pi,Or=et.elevationType==="road",tn=l.shadowRenderer,Ur=Or&&fe&&!!tn&&tn.enabled,Zr=Gt(Ur),Ds=Or&&fe&&!l.terrain?xe:Je,ws=n.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&fe&&qt.push("PITCH_WITH_MAP_TERRAIN"),xt&&(qt.push("PROJECTION_GLOBE_VIEW"),Ti&&qt.push("PROJECTED_POS_ON_VIEWPORT")),ws>0&&et.hasAnySecondaryIcon&&qt.push("ICON_TRANSITION"),!et.icon.zOffsetVertexBuffer||Or&&l.terrain||qt.push("Z_OFFSET"),N===0&&j===0&&Z===0&&H===1||qt.push("COLOR_ADJUSTMENT"),et.sdfIcons&&qt.push("RENDER_SDF"),Ur&&qt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Or&&fe&&!l.terrain&&et.icon.orientationVertexBuffer&&qt.push("ELEVATED_ROADS");const ts=et.icon.programConfigurations.get(n.id),cs=l.getOrCreateProgram("symbol",{config:ts,defines:qt}),Ks=Xe.imageAtlasTexture?Xe.imageAtlasTexture.size:[0,0],is=et.iconSizeData,Js=o.bJ(is,K.zoom),bo=fe||!K.isOrthographic,Fn=Wa(ut,Xe.tileID.canonical,fe,ne,K,et.getProjection(),ft),Gr=Vo(ut,Xe.tileID.canonical,fe,ne,K,et.getProjection(),ft),rn=l.translatePosMatrix(Gr,Xe,y,T,!0),or=l.translatePosMatrix(ut,Xe,y,T),an=Ti?ca:Fn,Bn=ne&&!fe&&!Ui;let Hr=rt;!Te&&!K.mercatorFromTransition||ne||(Hr=Hh(K));const Qs=xt?Hr:rt,Al=n.getColorAdjustmentMatrix(N,j,Z,H),Ko=jh(is.kind,Js,Bn,fe,l,or,an,rn,te,!1,Ks,[0,0],0,gt,dt,ce,vi,Qs,et.getProjection(),Zr,tr,Al,ws,null),Ml=Xe.imageAtlasTexture?Xe.imageAtlasTexture:null,Cl=n.layout.get("icon-size").constantOr(0)!==1||et.iconsNeedLinear,eo=et.sdfIcons||l.options.rotating||l.options.zooming||Cl||bo?ee.LINEAR:ee.NEAREST,Fo=et.sdfIcons&&n.paint.get("icon-halo-width").constantOr(1)!==0,Rn=l.terrain&&fe&&Ui?o.bk(o.bB(),Fn):ca;if(Ui&&et.icon){const to=o.bU.getAtTileOffsetFunc(gt,K.center.lat,K.worldSize,et.getProjection()),Va=Wl(ut,Xe.tileID.canonical,fe,ne,K,et.getProjection(),ft),pp=n.layout.get("icon-size-scale-range"),ku=o.aA(l.scaleFactor,pp[0],pp[1]);ph(et,ut,l,!1,Va,Gr,fe,O,to,gt,ku)}return{program:cs,buffers:et.icon,uniformValues:Ko,atlasTexture:Ml,atlasTextureIcon:null,atlasInterpolation:eo,atlasInterpolationIcon:null,isSDF:et.sdfIcons,hasHalo:Fo,depthMode:Ds,tile:Xe,renderWithShadows:Ur,labelPlaneMatrixInv:Rn}},bi=()=>{const Ui=_e&&n.layout.get("symbol-placement")!=="point",qt=[],Ti=Ui||Le||pi,Or=et.elevationType==="road",tn=l.shadowRenderer,Ur=Or&&Me&&!!tn&&tn.enabled,Zr=Gt(Ur),Ds=Or&&Me&&!l.terrain?xe:Je;l.terrainRenderModeElevated()&&Me&&qt.push("PITCH_WITH_MAP_TERRAIN"),xt&&(qt.push("PROJECTION_GLOBE_VIEW"),Ti&&qt.push("PROJECTED_POS_ON_VIEWPORT")),!et.text.zOffsetVertexBuffer||Or&&l.terrain||qt.push("Z_OFFSET"),et.iconsInText&&qt.push("RENDER_TEXT_AND_SYMBOL"),qt.push("RENDER_SDF"),Ur&&qt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Or&&Me&&!l.terrain&&et.text.orientationVertexBuffer&&qt.push("ELEVATED_ROADS"),xi(qt);const ws=et.text.programConfigurations.get(n.id),ts=l.getOrCreateProgram("symbol",{config:ws,defines:qt});let cs,Ks=[0,0],is=null;const Js=et.textSizeData;et.iconsInText&&(Ks=Xe.imageAtlasTexture?Xe.imageAtlasTexture.size:[0,0],is=Xe.imageAtlasTexture?Xe.imageAtlasTexture:null,cs=Me||!K.isOrthographic||l.options.rotating||l.options.zooming||Js.kind==="composite"||Js.kind==="camera"?ee.LINEAR:ee.NEAREST);const bo=Xe.glyphAtlasTexture?Xe.glyphAtlasTexture.size:[0,0],Fn=n.layout.get("text-size-scale-range"),Gr=o.aA(l.scaleFactor,Fn[0],Fn[1]),rn=o.bJ(Js,K.zoom,Gr),or=Wa(ut,Xe.tileID.canonical,Me,_e,K,et.getProjection(),ft),an=Vo(ut,Xe.tileID.canonical,Me,_e,K,et.getProjection(),ft),Bn=l.translatePosMatrix(an,Xe,x,S,!0),Hr=l.translatePosMatrix(ut,Xe,x,S),Qs=Ti?ca:or,Al=_e&&!Me&&!Ui;let Ko=rt;!Te&&!K.mercatorFromTransition||_e||(Ko=Hh(K));const Ml=jh(Js.kind,rn,Al,Me,l,Hr,Qs,Bn,te,!0,bo,Ks,0,gt,dt,ce,vi,xt?Ko:rt,et.getProjection(),Zr,tr,null,null,Gr),Cl=Xe.glyphAtlasTexture?Xe.glyphAtlasTexture:null,eo=ee.LINEAR,Fo=n.paint.get("text-halo-width").constantOr(1)!==0,Rn=l.terrain&&Me&&Ui?o.bk(o.bB(),or):ca;if(Ui&&et.text){const to=o.bU.getAtTileOffsetFunc(gt,K.center.lat,K.worldSize,et.getProjection()),Va=Wl(ut,Xe.tileID.canonical,Me,_e,K,et.getProjection(),ft);ph(et,ut,l,!0,Va,an,Me,V,to,gt,Gr)}return{program:ts,buffers:et.text,uniformValues:Ml,atlasTexture:Cl,atlasTextureIcon:is,atlasInterpolation:eo,atlasInterpolationIcon:cs,isSDF:!0,hasHalo:Fo,depthMode:Ds,tile:Xe,renderWithShadows:Ur,labelPlaneMatrixInv:Rn}},cr=et.icon.segments.get().length,Pi=et.text.segments.get().length,ii=cr&&!m.onlyText?Zi():null,Ni=Pi&&!m.onlyIcons?bi():null,si=n.paint.get("icon-opacity").constantOr(1),br=n.paint.get("text-opacity").constantOr(1);if(we&&et.canOverlap){ze=!0;const Ui=si&&!m.onlyText?et.icon.segments.get():[],qt=br&&!m.onlyIcons?et.text.segments.get():[];for(const Ti of Ui)je.push({segments:new o.bf([Ti]),sortKey:Ti.sortKey,state:ii});for(const Ti of qt)je.push({segments:new o.bf([Ti]),sortKey:Ti.sortKey,state:Ni})}else m.onlyText||je.push({segments:si?et.icon.segments:new o.bf([]),sortKey:0,state:ii}),m.onlyIcons||je.push({segments:br?et.text.segments:new o.bf([]),sortKey:0,state:Ni})}ze&&je.sort(((gt,Xe)=>gt.sortKey-Xe.sortKey));for(const gt of je){const Xe=gt.state;if(Xe)if(l.terrain?l.terrain.setupElevationDraw(Xe.tile,Xe.program,{useDepthForOcclusion:K.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Xe.labelPlaneMatrixInv}):l.setupDepthForOcclusion(K.depthOcclusionForSymbolsAndCircles,Xe.program),re.activeTexture.set(ee.TEXTURE0),Xe.atlasTexture&&Xe.atlasTexture.bind(Xe.atlasInterpolation,ee.CLAMP_TO_EDGE,!0),Xe.atlasTextureIcon&&(re.activeTexture.set(ee.TEXTURE1),Xe.atlasTextureIcon&&Xe.atlasTextureIcon.bind(Xe.atlasInterpolationIcon,ee.CLAMP_TO_EDGE,!0)),Xe.renderWithShadows&&l.shadowRenderer.setupShadows(Xe.tile.tileID.toUnwrapped(),Xe.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,Xe.program),Xe.hasHalo){const et=Xe.uniformValues;et.u_is_halo=1,_u(Xe.buffers,gt.segments,n,l,Xe.program,Xe.depthMode,d,p,et,2),et.u_is_halo=0}else{if(Xe.isSDF){const et=Xe.uniformValues;Xe.hasHalo&&(et.u_is_halo=1,_u(Xe.buffers,gt.segments,n,l,Xe.program,Xe.depthMode,d,p,et,1)),et.u_is_halo=0}_u(Xe.buffers,gt.segments,n,l,Xe.program,Xe.depthMode,d,p,Xe.uniformValues,1)}}}function _u(l,t,n,c,d,p,m,y,x,T){const S=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,m,y,jt.disabled,x,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),S,T)}function qf(l,t){const n=1<<l.canonical.z,c=(t.x*n-l.canonical.x-l.wrap*n)*o.al,d=(t.y*n-l.canonical.y)*o.al,p=o.e7(t.z,t.y);return o.d4(c,d,p)}function La(l,t,n,c,d){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const p=l.context.gl,m=new wt(l.context.gl.LEQUAL,wt.ReadWrite,l.depthRangeFor3D),y=new wt(l.context.gl.GREATER,wt.ReadWrite,l.depthRangeFor3D),x=(function(P){let D=.01;return P.isOrthographic&&(D=o.ak(1e-4,D,o.c$(P.pitch>=Ma?1:P.pitch/Ma))),2*D})(l.transform),T=l.transform.getFreeCameraOptions().position,S="elevatedStructuresDepthReconstruct",M=l.getOrCreateProgram(S,{defines:["DEPTH_RECONSTRUCTION"]}),E=l.getOrCreateProgram(S);for(const P of c){const D=t.getTile(P),O=D.getBucket(n);if(!O)continue;const V=O.elevatedStructures;if(!V)continue;const N=O.elevationBufferData.heightRange,j=qf(P.toUnwrapped(),T),Z=l.translatePosMatrix(P.projMatrix,D,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));let H,te,W,re;if(d==="initialize"){if(!N||N.min>=1||V.depthSegments.segments[0].primitiveLength===0)continue;H=su(Z,j,x,1,0),te=m,W=V.depthSegments,re=M}else if(d==="reset"){if(!N||N.min>=0||V.maskSegments.segments[0].primitiveLength===0)continue;H=su(Z,j,0,0,1),te=y,W=V.maskSegments,re=M}else if(d==="geometry"){if(V.depthSegments.segments[0].primitiveLength===0)continue;H=su(Z,j,x,1,0),te=m,W=V.depthSegments,re=E}re.draw(l,p.TRIANGLES,te,Zt.disabled,ni.disabled,jt.disabled,H,n.id,V.vertexBuffer,V.indexBuffer,W,n.paint,l.transform.zoom)}}function fl(l,t,n){const{painter:c,sourceCache:d,layer:p,coords:m,colorMode:y,elevationType:x,terrainEnabled:T,pass:S}=l,M=c.context.gl,E=p.paint.get("fill-pattern"),P=p.paint.get("fill-pattern-cross-fade"),D=E.constantOr(null);let O=x;x!=="road"||t&&!T||(O="none");const V=O==="road",N=l.painter.shadowRenderer,j=V&&!!N&&N.enabled,Z=new wt(c.context.gl.LEQUAL,wt.ReadOnly,c.depthRangeFor3D);let H=[0,0,0];if(j){const re=c.style.directionalLight,ee=c.style.ambientLight;re&&ee&&(H=mo(c.style,re,ee))}const te=E&&E.constantOr(1),W=(re,ee)=>{let K,ne,_e,fe,Me;ee?(K=te&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",_e=M.LINES):(K=te?"fillPattern":"fill",_e=M.TRIANGLES);for(const we of m){const ze=d.getTile(we);if(te&&!ze.patternsLoaded())continue;const Je=ze.getBucket(p);if(!Je)continue;const xe=t?Je.elevationBufferData:Je.bufferData;if(xe.isEmpty())continue;c.prepareDrawTile();const ce=xe.programConfigurations.get(p.id),Le=c.isTileAffectedByFog(we),Te=[],je=[];V&&(Te.push("ELEVATED_ROADS"),je.push(xe.elevatedLayoutVertexBuffer)),j&&Te.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),te&&(c.context.activeTexture.set(M.TEXTURE0),ze.imageAtlasTexture&&ze.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ce.updatePaintBuffers());let rt=!1;if(D&&ze.imageAtlas){const dt=ze.imageAtlas,ut=o.e2.from(D),ft=ut.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),zt=ut.getSecondary(),pi=dt.patternPositions.get(ft),vi=zt?dt.patternPositions.get(zt.scaleSelf(o.o.devicePixelRatio).toString()):null;rt=!!pi&&!!vi,pi&&ce.setConstantPatternPositions(pi,vi)}P>0&&(rt||ce.getPatternTransitionVertexBuffer("fill-pattern"))&&Te.push("FILL_PATTERN_TRANSITION");const gt=c.getOrCreateProgram(K,{config:ce,overrideFog:Le,defines:Te}),Xe=c.translatePosMatrix(we.projMatrix,ze,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));j&&N.setupShadows(ze.tileID.toUnwrapped(),gt,"vector-tile");const et=p.paint.get("fill-emissive-strength");if(ee){fe=xe.lineIndexBuffer,Me=xe.lineSegments;const dt=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[M.drawingBufferWidth,M.drawingBufferHeight];ne=K==="fillOutlinePattern"&&te?km(Xe,et,c,ze,dt,H,P):Om(Xe,et,dt,H)}else fe=xe.indexBuffer,Me=xe.triangleSegments,ne=te?Vf(Xe,et,c,ze,H,P):Nf(Xe,et,H);c.uploadCommonUniforms(c.context,gt,we.toUnwrapped());let xt=re;(x==="road"&&!T||x==="offset")&&(xt=Z),gt.draw(c,_e,xt,n||c.stencilModeForClipping(we),y,jt.disabled,ne,p.id,xe.layoutVertexBuffer,fe,Me,p.paint,c.transform.zoom,ce,je)}};c.renderPass===S&&W(c.depthModeForSublayer(1,c.renderPass==="opaque"?wt.ReadWrite:wt.ReadOnly),!1),O==="none"&&c.renderPass==="translucent"&&p.paint.get("fill-antialias")&&W(c.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,wt.ReadOnly),!0)}function mt(l,t,n,c,d,p,m,y){n.resetLayerRenderingStats(l);const x=l.context,T=x.gl,S=l.transform,M=n.paint.get("fill-extrusion-pattern"),E=n.paint.get("fill-extrusion-pattern-cross-fade"),P=M.constantOr(null),D=M.constantOr(1),O=n.paint.get("fill-extrusion-opacity"),V=l.style.enable3dLights(),N=n.paint.get(V&&!D?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),j=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),N],Z=n.layout.get("fill-extrusion-edge-radius"),H=Z>0&&!n.paint.get("fill-extrusion-rounded-roof"),te=H?0:Z,W=S.projection.name==="globe"?o.ea():0,re=S.projection.name==="globe",ee=re?o.aj(S.zoom):0,K=[o.aF(S.center.lng),o.aJ(S.center.lat)],ne=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",_e=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ne?null:n.lut).toArray01().slice(0,3),fe=n.paint.get("fill-extrusion-flood-light-intensity"),Me=n.paint.get("fill-extrusion-vertical-scale"),we=n.paint.get("fill-extrusion-line-width").constantOr(1)!==0,ze=n.paint.get("fill-extrusion-height-alignment"),Je=n.paint.get("fill-extrusion-base-alignment"),xe=Ho(l,n.paint.get("fill-extrusion-cutoff-fade-range")),ce=[];let Le;re&&ce.push("PROJECTION_GLOBE_VIEW"),j[0]>0&&ce.push("FAUX_AO"),H&&ce.push("ZERO_ROOF_RADIUS"),y&&ce.push("HAS_CENTROID"),fe>0&&ce.push("FLOOD_LIGHT"),xe.shouldRenderCutoff&&ce.push("RENDER_CUTOFF"),we&&ce.push("RENDER_WALL_MODE");const Te=l.renderPass==="shadow",je=l.shadowRenderer,rt=Te&&!!je,gt=Te?jt.disabled:jt.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let Xe=[0,0,0];if(je){const dt=l.style.directionalLight,ut=l.style.ambientLight;dt&&ut&&(Xe=mo(l.style,dt,ut)),Te||(ce.push("RENDER_SHADOWS","DEPTH_TEXTURE"),je.useNormalOffset&&ce.push("NORMAL_OFFSET")),Le=ce.concat(["SHADOWS_SINGLE_CASCADE"])}const et=rt?"fillExtrusionDepth":D?"fillExtrusionPattern":"fillExtrusion",xt=n.getLayerRenderingStats();for(const dt of c){const ut=t.getTile(dt),ft=ut.getBucket(n);if(!ft||ft.projection.name!==S.projection.name)continue;let zt=!1;je&&(zt=je.getMaxCascadeForTile(dt.toUnwrapped())===0);const pi=l.isTileAffectedByFog(dt),vi=ft.programConfigurations.get(n.id);let tr=!1;if(P&&ut.imageAtlas){const Pi=ut.imageAtlas,ii=o.e2.from(P),Ni=ii.getPrimary().scaleSelf(o.o.devicePixelRatio).toString(),si=ii.getSecondary(),br=Pi.patternPositions.get(Ni),Ui=si?Pi.patternPositions.get(si.scaleSelf(o.o.devicePixelRatio).toString()):null;tr=!!br&&!!Ui,br&&vi.setConstantPatternPositions(br,Ui)}E>0&&(tr||vi.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&ce.push("FILL_EXTRUSION_PATTERN_TRANSITION");const Gt=l.getOrCreateProgram(et,{config:vi,defines:zt?Le:ce,overrideFog:pi});if(l.terrain&&l.terrain.setupElevationDraw(ut,Gt,{useMeterToDem:!0}),!ft.centroidVertexBuffer){const Pi=Gt.getAttributeLocation(T,"a_centroid_pos");Pi!==-1&&T.vertexAttrib2f(Pi,0,0)}!Te&&je&&je.setupShadows(ut.tileID.toUnwrapped(),Gt,"vector-tile"),D&&(l.context.activeTexture.set(T.TEXTURE0),ut.imageAtlasTexture&&ut.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),vi.updatePaintBuffers());const xi=n.paint.get("fill-extrusion-vertical-gradient"),ti=1/ft.tileToMeter;let Zi;if(Te&&je){if($f(ut.tileID,ft.maxHeight,l))continue;const Pi=je.calculateShadowPassMatrixFromTile(ut.tileID.toUnwrapped());Zi=Ff(Pi,te,ti,Me,ze,Je)}else{const Pi=l.translatePosMatrix(dt.expandedProjMatrix,ut,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),ii=S.projection.createInversionMatrix(S,dt.canonical);Zi=D?Bf(Pi,l,xi,O,j,te,ti,dt,ut,W,ze,Je,ee,K,ii,_e,Me,E):nu(Pi,l,xi,O,j,te,ti,dt,W,ze,Je,ee,K,ii,_e,Me,fe,Xe)}l.uploadCommonUniforms(x,Gt,dt.toUnwrapped(),null,xe);let bi=ft.segments;if(S.projection.name==="mercator"&&!Te&&(bi=ft.getVisibleSegments(ut.tileID,l.terrain,l.transform.getFrustum(0)),!bi.get().length))continue;if(xt)if(Te)for(const Pi of bi.get())xt.numRenderedVerticesInShadowPass+=Pi.primitiveLength;else for(const Pi of bi.get())xt.numRenderedVerticesInTransparentPass+=Pi.primitiveLength;const cr=[];(l.terrain||y)&&cr.push(ft.centroidVertexBuffer),re&&cr.push(ft.layoutVertexExtBuffer),we&&cr.push(ft.wallVertexBuffer),Gt.draw(l,x.gl.TRIANGLES,d,p,m,gt,Zi,n.id,ft.layoutVertexBuffer,ft.indexBuffer,bi,n.paint,l.transform.zoom,vi,cr)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class qh{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function $o(l,t,n,c,d,p,m,y,x,T,S,M,E,P,D,O,V,N,j,Z){const H=t.context,te=H.gl,W=t.transform,re=t.transform.zoom,ee=[],K=l.translate,ne=l.translateAnchor,_e=l.edgeRadius,fe=Ho(t,l.cutoffFadeRange);S==="clear"?(ee.push("CLEAR_SUBPASS"),Z&&(ee.push("CLEAR_FROM_TEXTURE"),H.activeTexture.set(te.TEXTURE0),Z.bind(te.LINEAR,te.CLAMP_TO_EDGE))):S==="sdf"&&ee.push("SDF_SUBPASS"),N&&ee.push("HAS_CENTROID"),fe.shouldRenderCutoff&&ee.push("RENDER_CUTOFF");const Me=(we,ze,Je,xe,ce)=>{let Le=ee;ze.groundRadiusBuffer!=null&&(Le=ee.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const Te=ze.programConfigurations.get(c.id),je=t.isTileAffectedByFog(we),rt=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Te,defines:Le,overrideFog:je}),gt=ul(t,xe,M,T,ce,[E,P*ce],D,O,V,re>=17?0:_e*ce,Z?Z.size[0]:0),Xe=[];N&&Xe.push(ze.hiddenByLandmarkVertexBuffer),ze.groundRadiusBuffer!=null&&Xe.push(ze.groundRadiusBuffer),t.uploadCommonUniforms(H,rt,we.toUnwrapped(),null,fe),rt.draw(t,H.gl.TRIANGLES,p,m,y,x,gt,c.id,ze.vertexBuffer,ze.indexBuffer,Je,c.paint,re,Te,Xe)};for(const we of d){const ze=n.getTile(we),Je=ze.getBucket(c);if(!Je||Je.projection.name!==W.projection.name||!Je.groundEffect||Je.groundEffect&&!Je.groundEffect.hasData())continue;const xe=Je.groundEffect,ce=1/Je.tileToMeter;{const Le=t.translatePosMatrix(we.projMatrix,ze,K,ne),Te=xe.getDefaultSegment();Me(we,xe,Te,Le,ce)}if(j)for(let Le=0;Le<4;Le++){const Te=o.e8[Le](we),je=n.getTile(Te);if(!je)continue;const rt=je.getBucket(c);if(!rt||rt.projection.name!==W.projection.name||!rt.groundEffect||rt.groundEffect&&!rt.groundEffect.hasData())continue;const gt=rt.groundEffect;let Xe,et;Le===0?(Xe=[-o.al,0,0],et=1):Le===1?(Xe=[o.al,0,0],et=0):Le===2?(Xe=[0,-o.al,0],et=3):(Xe=[0,o.al,0],et=2);const xt=gt.regionSegments[et];if(!xt)continue;const dt=new Float32Array(16);o.bq(dt,we.projMatrix,Xe),Me(we,gt,xt,t.translatePosMatrix(dt,ze,K,ne),ce)}}}function ua(l,t,n,c,d,p,m){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const y=p?p.findDEMTileFor(n):null;if(!(y&&y.dem||m))return;p&&y&&y.dem&&c.selfDEMTileTimestamp!==y.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=y.dem._timestamp);const x=N=>new o.P(Math.ceil((N+o.ec)*o.ed),0),T=N=>{const j=t.getSource().minzoom,Z=te=>{const W=t.getTileByID(te);if(W&&W.hasData())return W.getBucket(d)},H=[0,-1,1];for(const te of H){if(N.overscaledZ+te<j)continue;const W=Z(N.calculateScaledKey(N.overscaledZ+te));if(W)return W}},S=[0,0,0],M=(N,j)=>(S[0]=Math.min(N.min.y,j.min.y),S[1]=Math.max(N.max.y,j.max.y),S[2]=o.al-j.min.x>N.max.x?j.min.x-o.al:N.max.x,S),E=(N,j)=>(S[0]=Math.min(N.min.x,j.min.x),S[1]=Math.max(N.max.x,j.max.x),S[2]=o.al-j.min.y>N.max.y?j.min.y-o.al:N.max.y,S),P=[(N,j)=>M(N,j),(N,j)=>M(j,N),(N,j)=>E(N,j),(N,j)=>E(j,N)],D=(N,j,Z,H,te,W,re)=>{if(!p)return 0;const ee=[[W?Z:N,W?N:Z,0],[W?Z:j,W?j:Z,0]],K=re<0?o.al+re:re,ne=[W?K:(N+j)/2,W?(N+j)/2:K,0];return Z===0&&re<0||Z!==0&&re>0?p.getForTilePoints(te,[ne],!0,H):ee.push(ne),p.getForTilePoints(n,ee,!0,y),Math.max(ee[0][2],ee[1][2],ne[2])/p.exaggeration()};for(let N=0;N<4;N++){const j=c.borderFeatureIndices[N];if(j.length===0)continue;const Z=o.e8[N](n),H=T(Z);if(!(H&&H instanceof o.e9))continue;const te=p?p.findDEMTileFor(Z):null;if(!(te&&te.dem||m)||(p&&te&&te.dem&&c.borderDEMTileTimestamp[N]!==te.dem._timestamp&&(c.borderDoneWithNeighborZ[N]=-1,c.borderDEMTileTimestamp[N]=te.dem._timestamp),c.borderDoneWithNeighborZ[N]===H.canonical.z))continue;H.centroidVertexArray.length===0&&H.createCentroidsBuffer();const W=(N<2?1:5)-N,re=H.borderDoneWithNeighborZ[W]!==c.canonical.z,ee=H.borderFeatureIndices[W];let K=0;if(c.canonical.z!==H.canonical.z){for(const ne of j)c.showCentroid(c.featuresOnBorder[ne]);if(re)for(const ne of ee)H.showCentroid(H.featuresOnBorder[ne]);c.borderDoneWithNeighborZ[N]=H.canonical.z,H.borderDoneWithNeighborZ[W]=c.canonical.z}for(const ne of j){const _e=c.featuresOnBorder[ne],fe=c.centroidData[_e.centroidDataIndex],Me=_e.borders[N];let we;for(;K<ee.length;){we=H.featuresOnBorder[ee[K]];const ze=we.borders[W];if(ze[1]>Me[0]+3||ze[0]>Me[0]-3)break;H.showCentroid(we),K++}if(we&&K<ee.length){const ze=K;let Je=0;for(;!(we.borders[W][0]>Me[1]-3)&&(Je++,++K!==ee.length);)we=H.featuresOnBorder[ee[K]];we=H.featuresOnBorder[ee[ze]];let xe=!1;if(Je>=1){const Te=we.borders[W];Math.abs(Me[0]-Te[0])<3&&Math.abs(Me[1]-Te[1])<3&&(Je=1,xe=!0,K=ze+1)}else if(Je===0){c.showCentroid(_e);continue}const ce=H.centroidData[we.centroidDataIndex];m&&xe&&(((O=fe).flags|(V=ce).flags)&o.eb?(O.flags|=o.eb,V.flags|=o.eb):(O.flags&=~o.eb,V.flags&=~o.eb));const Le=_e.intersectsCount()>1||we.intersectsCount()>1;if(Je>1)K=ze,fe.centroidXY=ce.centroidXY=new o.P(0,0);else if(te&&te.dem&&!Le){const Te=P[N](fe,ce),je=N%2?o.al-1:0,rt=D(Te[0],Math.min(o.al-1,Te[1]),je,te,Z,N<2,Te[2]);fe.centroidXY=ce.centroidXY=x(rt)}else Le?fe.centroidXY=ce.centroidXY=new o.P(0,0):(fe.centroidXY=c.encodeBorderCentroid(_e),ce.centroidXY=H.encodeBorderCentroid(we));c.writeCentroidToBuffer(fe),H.writeCentroidToBuffer(ce)}else c.showCentroid(_e)}c.borderDoneWithNeighborZ[N]=H.canonical.z,H.borderDoneWithNeighborZ[W]=c.canonical.z}var O,V;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const ha=[1,0,0],Dt=[0,1,0],$h=[0,0,1];function $f(l,t,n){const c=n.transform,d=n.shadowRenderer;if(!d)return!0;const p=l.toUnwrapped(),m=c.tileSize*d._cascades[n.currentShadowCascade].scale;let y=t;if(c.elevation){const O=c.elevation.getMinMaxForTile(l);O&&(y+=O.max)}const x=[...d.shadowDirection];x[2]=-x[2];const T=d.computeSimplifiedTileShadowVolume(p,y,m,x);if(!T)return!1;const S=[ha,Dt,$h,x,[x[0],0,x[2]],[0,x[1],x[2]]],M=c.projection.name==="globe",E=c.scaleZoom(m),P=o.cA.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,E,!M),D=d.getCurrentCascadeFrustum();return P.intersectsPrecise(T.vertices,T.planes,S)===0||D.intersectsPrecise(T.vertices,T.planes,S)===0}function gu(l){const{painter:t,source:n,layer:c,coords:d}=l;let p=l.defines;const m=t.context,y=t.renderPass==="shadow",x=t.renderPass==="light-beam",T=t.shadowRenderer,S=o.ee(t.transform.center.lat,t.transform.zoom),M=Ho(t,c.paint.get("building-cutoff-fade-range"));M.shouldRenderCutoff&&(p=p.concat("RENDER_CUTOFF")),l.floodLightIntensity>0&&(p=p.concat("FLOOD_LIGHT"));for(const E of d){const P=n.getTile(E),D=P.getBucket(c);if(!D)continue;T&&T.getMaxCascadeForTile(E.toUnwrapped())===0&&(p=p.concat("SHADOWS_SINGLE_CASCADE"));const O=D.programConfigurations.get(c.id);let V,N,j,Z=t.translatePosMatrix(E.expandedProjMatrix,P,[0,0],"map");if(Z=o.cR(o.bB(),Z,[1,1,l.verticalScale]),y&&T){if($f(P.tileID,D.maxHeight*S,t))continue;let te=T.calculateShadowPassMatrixFromTile(P.tileID.toUnwrapped());te=o.cR(o.bB(),te,[1,1,l.verticalScale]),j=Uf(te),V=N=t.getOrCreateProgram("buildingDepth",{config:O,defines:p,overrideFog:!1})}else if(x)V=N=t.getOrCreateProgram("buildingBloom",{config:O,defines:p,overrideFog:!1}),j=Bh(Z);else{const te=t.transform.calculatePosMatrix(E.toUnwrapped(),t.transform.worldSize);o.cR(te,te,[1,1,l.verticalScale]);const W=o.bB();o.cR(W,te,[1,-1,1/S]),o.bk(W,W),o.ef(W,W);const re=t.transform.getFreeCameraOptions().position,ee=1<<E.canonical.z;if(j=Fh(Z,W,l.opacity,l.facadeAOIntensity,[((re.x-E.wrap)*ee-E.canonical.x)*o.al,(re.y*ee-E.canonical.y)*o.al,re.z*ee*o.al],D.tileToMeter,l.facadeEmissiveChance,l.floodLightColor,l.floodLightIntensity),N=t.getOrCreateProgram("building",{config:O,defines:p,overrideFog:!1}),l.depthOnly===!0)V=N;else{const K=p.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);V=t.getOrCreateProgram("building",{config:O,defines:K,overrideFog:!1})}T&&(T.setupShadowsFromMatrix(te,N,!0),V!==N&&T.setupShadowsFromMatrix(te,V,!0))}const H=(te,W)=>{if(x){const re=te.entranceBloom;W.draw(t,m.gl.TRIANGLES,l.depthMode,Zt.disabled,l.blendMode,jt.disabled,j,c.id,re.layoutVertexBuffer,re.indexBuffer,re.segmentsBucket,c.paint,t.transform.zoom,O,[re.layoutAttenuationBuffer,re.layoutColorBuffer])}else{const re=te.segmentsBucket;let ee=[te.layoutNormalBuffer,te.layoutCentroidBuffer,te.layoutColorBuffer,te.layoutFloodLightDataBuffer];te.layoutFacadePaintBuffer&&(ee=ee.concat([te.layoutFacadeDataBuffer,te.layoutFacadeVerticalRangeBuffer,te.layoutFacadePaintBuffer])),W.draw(t,m.gl.TRIANGLES,l.depthMode,Zt.disabled,l.blendMode,y?jt.disabled:jt.backCW,j,c.id,te.layoutVertexBuffer,te.indexBuffer,re,c.paint,t.transform.zoom,O,ee)}};t.uploadCommonUniforms(m,N,E.toUnwrapped(),null,M),D.buildingWithoutFacade&&H(D.buildingWithoutFacade,N),D.buildingWithFacade&&(V!==N&&t.uploadCommonUniforms(m,V,E.toUnwrapped(),null,M),H(D.buildingWithFacade,V))}}function yu(l,t,n,c,d,p,m,y,x,T,S,M,E){const P=l.context.gl,D=l.depthModeForSublayer(1,wt.ReadOnly,P.LEQUAL,!0),O=.1*(1-(V=S))+3*V;var V;const N=l._showOverdrawInspector,j=M,Z=new qh;N||$o(Z,l,t,n,c,D,new Zt({func:P.ALWAYS,mask:255},255,255,P.KEEP,P.KEEP,P.REPLACE),new ni([P.ONE,P.ONE,P.ONE,P.ONE],o.ao.transparent,[!1,!1,!1,!0],P.MIN),jt.disabled,d,"sdf",p,m,y,x,T,O,j,!1);{const H=N?Zt.disabled:new Zt({func:P.EQUAL,mask:255},255,255,P.KEEP,P.DECR,P.DECR),te=N?l.colorModeForRenderPass():new ni([P.ONE_MINUS_DST_ALPHA,P.DST_ALPHA,P.ONE,P.ONE],o.ao.transparent,[!0,!0,!0,!0]);$o(Z,l,t,n,c,D,H,te,jt.disabled,d,"color",p,m,y,x,T,O,j,!1)}}function Zh(l){return[l[0]*o.eg,l[1]*o.eg,l[2]*o.eg,0]}function Wh(l,t,n,c,d,p,m,y,x){const T=c.getSource(),S=n.globeSharedBuffers;if(!S)return;let M,E,P;if(t&&(M=c.getTile(t)),T instanceof o.aT?(E=T.texture,P=o.dJ(0,0,n.transform)):M&&t&&(E=M.texture,P=o.dJ(t.canonical.z,t.canonical.x,n.transform)),!E||!P)return;l||(P=o.cR(o.bB(),P,[1,-1,1]));const D=n.context,O=D.gl,V=d.paint.get("raster-resampling")==="nearest"?O.NEAREST:O.LINEAR,N=n.colorModeForDrapableLayerRenderPass(p),j=m.defines;j.push("GLOBE_POLES");const Z=new wt(O.LEQUAL,wt.ReadWrite,n.depthRangeFor3D),H=Float32Array.from(n.transform.expandedFarZProjMatrix),te=Float32Array.from(o.bj(o.dI(new o.cC(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),D.activeTexture.set(O.TEXTURE0),E.bind(V,O.CLAMP_TO_EDGE),D.activeTexture.set(O.TEXTURE1),E.bind(V,O.CLAMP_TO_EDGE),"useMipmap"in E&&D.extTextureFilterAnisotropic&&n.transform.pitch>20&&O.texParameterf(O.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const[W,re,ee,K]=t?S.getPoleBuffers(t.canonical.z,!1):S.getPoleBuffers(0,!0),ne=d.paint.get("raster-elevation");let _e;l?(_e=W,n.renderDefaultNorthPole=ne!==0):(_e=re,n.renderDefaultSouthPole=ne!==0);const fe=Zh(m.mix),Me=((ze,Je,xe,ce,Le,Te,je,rt,gt,Xe,et,xt,dt)=>fc(ze,Je,xe,new Float32Array(16),new Float32Array(9),[0,0],ce,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Te,[0,0],rt,2,Xe,et,xt,1,0,dt))(H,te,P,o.aj(n.transform.zoom),0,d,0,ne,0,fe,m.offset,m.range,p),we=n.getOrCreateProgram("raster",{defines:j});n.uploadCommonUniforms(D,we,null),we.draw(n,O.TRIANGLES,Z,x,N,y,Me,d.id,_e,ee,K)}function Zf(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}function Vm(l,t,n,c){if(l)return t instanceof pn&&l instanceof Ms?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:Zh(c.mix),offset:c.offset,buffer:0,tileSize:1}}var Um=o.eh([{name:"a_index",type:"Int16",components:1}]);class Ns{constructor(t,n,c,d){const p={width:c[0],height:c[1],data:null},m=t.gl;this.targetColorTexture=new o.T(t,p,m.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(t,p,m.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,d),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=n.width*n.height;this.particleTexture0=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const p=new o.ei;p.reserve(d);for(let m=0;m<d;m++)p.emplaceBack(m);this.particleIndexBuffer=this.context.createVertexBuffer(p,Um.members,!0),this.particleSegment=o.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=o.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Xh(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:d,mix:p,offset:m,tileSize:y,buffer:x,format:T}=c;if(!d||!T)return null;let S=!1;return T==="uint32"&&(S=!0,p[3]=0,p=ou(o.ej,p,[0,n.paint.get("raster-particle-max-speed")]),m=qo(o.ej,m,[0,n.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[x/(y+2*x),y/(y+2*x)],tileSize:y,scalarData:S,scale:p,offset:m,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[T]]}}function bs(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}const da=new o.ao(1,0,0,1),Wf=new o.ao(0,1,0,1),Yh=new o.ao(0,0,1,1),Kh=new o.ao(1,0,1,1),Jh=new o.ao(0,1,1,1);function Qh(l,t,n,c,d,p){for(let m=0;m<n.length;m++)if(d){const T=new o.ao(c.r*.8,c.g*.8,c.b*.8,1);Vs(l,t,n[m],c,-1,-1,p),Vs(l,t,n[m],c,-1,1,p),Vs(l,t,n[m],c,1,1,p),Vs(l,t,n[m],c,1,-1,p),Vs(l,t,n[m],T,0,0,p)}else Vs(l,t,n[m],c,0,0,p)}function Vs(l,t,n,c,d,p,m){const y=l.context,x=l.transform,T=y.gl,S=x.projection.name==="globe",M=S?["PROJECTION_GLOBE_VIEW"]:[];let E=o.by(n.projMatrix);if(S&&o.aj(x.zoom)>0){const fe=o.bi(n.canonical,x),Me=o.ek(fe);E=o.aB(new Float32Array(16),x.globeMatrix,Me),o.aB(E,x.projMatrix,E)}const P=o.bB();P[12]+=2*d/(o.o.devicePixelRatio*x.width),P[13]+=2*p/(o.o.devicePixelRatio*x.height),o.aB(E,P,E);const D=l.getOrCreateProgram("debug",{defines:M}),O=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(O,D);const V=wt.disabled,N=Zt.disabled,j=l.colorModeForRenderPass(),Z="$debug";y.activeTexture.set(T.TEXTURE0),l.emptyTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),S?O._makeGlobeTileDebugBuffers(l.context,x):O._makeDebugTileBoundsBuffers(l.context,x.projection);const H=O._tileDebugBuffer||l.debugBuffer,te=O._tileDebugIndexBuffer||l.debugIndexBuffer,W=O._tileDebugSegments||l.debugSegments;if(D.draw(l,T.LINE_STRIP,V,N,j,jt.disabled,Nh(E,c.toPremultipliedRenderColor(null)),Z,H,te,W,null,null,null,[O._globeTileDebugBorderBuffer]),m){const fe=O.latestRawTileData,Me=Math.floor((fe&&fe.byteLength||0)/1024);let we=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(we+=" => ".concat(n.overscaledZ)),we+=" ".concat(O.state),we+=" ".concat(Me,"kb"),(function(ze,Je){ze.initDebugOverlayCanvas();const xe=ze.debugOverlayCanvas,ce=ze.context.gl,Le=ze.debugOverlayCanvas.getContext("2d");Le.clearRect(0,0,xe.width,xe.height),Le.shadowColor="white",Le.shadowBlur=2,Le.lineWidth=1.5,Le.strokeStyle="white",Le.textBaseline="top",Le.font="bold 36px Open Sans, sans-serif",Le.fillText(Je,5,5),Le.strokeText(Je,5,5),ze.debugOverlayTexture.update(xe),ze.debugOverlayTexture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)})(l,we)}const re=t.getTile(n).tileSize,ee=512/Math.min(re,512)*(n.overscaledZ/x.zoom)*.5,K=O._tileDebugTextBuffer||l.debugBuffer,ne=O._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,_e=O._tileDebugTextSegments||l.debugSegments;D.draw(l,T.TRIANGLES,V,N,ni.alphaBlended,jt.disabled,Nh(E,o.ao.transparent.toPremultipliedRenderColor(null),ee),Z,K,ne,_e,null,null,null,[O._globeTileDebugTextBuffer])}function yr(l,t,n,c){pl(l,0,t+n/2,l.transform.width,n,c)}function _c(l,t,n,c){pl(l,t-n/2,0,n,l.transform.height,c)}function pl(l,t,n,c,d,p){const m=l.context,y=m.gl;y.enable(y.SCISSOR_TEST),y.scissor(t*o.o.devicePixelRatio,n*o.o.devicePixelRatio,c*o.o.devicePixelRatio,d*o.o.devicePixelRatio),m.clear({color:p}),y.disable(y.SCISSOR_TEST)}const Xf=o.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Yf}=Xf;function Zo(l,t,n,c){l.emplaceBack(t,n,c)}class ed{constructor(t){this.vertexArray=new o.el,this.indices=new o.b0,Zo(this.vertexArray,-1,-1,1),Zo(this.vertexArray,1,-1,1),Zo(this.vertexArray,-1,1,1),Zo(this.vertexArray,1,1,1),Zo(this.vertexArray,-1,-1,-1),Zo(this.vertexArray,1,-1,-1),Zo(this.vertexArray,-1,1,-1),Zo(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Yf),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=o.bf.simpleSegment(0,0,36,12)}}function yo(l,t,n,c,d,p){const m=l.context.gl,y=t.paint.get("sky-atmosphere-color"),x=t.paint.get("sky-atmosphere-halo-color"),T=t.paint.get("sky-atmosphere-sun-intensity"),S=((M,E,P,D,O)=>({u_matrix_3f:M,u_sun_direction:E,u_sun_intensity:P,u_color_tint_r:[D.r,D.g,D.b,D.a],u_color_tint_m:[O.r,O.g,O.b,O.a],u_luminance:5e-5}))(o.en(o.dN(),c),d,T,y.toPremultipliedRenderColor(null),x.toPremultipliedRenderColor(null));m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),n.draw(l,m.TRIANGLES,wt.disabled,Zt.disabled,ni.unblended,jt.frontCW,S,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Oa=o.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class We{constructor(t){const n=new o.eo;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new o.b0;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,Oa.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=o.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const ct=o.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class ml{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class $r{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ni([1,on,1,on],o.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ni([1,0,1,0],o.ao.transparent,[!1,!1,!1,!0]),this.params=new ml,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new We(n);const c=this.params.sizeRange,d=this.params.intensityRange,p=(function(S){const M=o.eq(30),E=[];for(let P=0;P<S;++P){const D=2*Math.PI*M(),O=Math.acos(1-2*M())-.5*Math.PI;E.push(o.d4(Math.cos(O)*Math.cos(D),Math.cos(O)*Math.sin(D),Math.sin(O)))}return E})(this.params.starsCount),m=o.eq(300),y=new o.ep,x=new o.b0;let T=0;for(let S=0;S<p.length;++S){const M=o.c4([],p[S],200),E=Math.max(0,1+.01*c*(1*m()-.5)),P=Math.max(0,1+.01*d*(1*m()-.5));y.emplaceBack(M[0],M[1],M[2],-1,-1,E,P),y.emplaceBack(M[0],M[1],M[2],1,-1,E,P),y.emplaceBack(M[0],M[1],M[2],1,1,E,P),y.emplaceBack(M[0],M[1],M[2],-1,1,E,P),x.emplaceBack(T+0,T+1,T+2),x.emplaceBack(T+0,T+2,T+3),T+=4}this.starsVx=n.createVertexBuffer(y,ct.members),this.starsIdx=n.createIndexBuffer(x),this.starsSegments=o.bf.simpleSegment(0,0,y.length,x.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,d=c.gl,p=t.transform,m=new wt(d.LEQUAL,wt.ReadOnly,[0,1]),y=o.aj(p.zoom),x=t.style.getLut(n.scope),T=n.properties.get("color-use-theme")==="none",S=n.properties.get("color").toNonPremultipliedRenderColor(T?null:x),M=n.properties.get("high-color-use-theme")==="none",E=n.properties.get("high-color").toNonPremultipliedRenderColor(M?null:x),P=n.properties.get("space-color-use-theme")==="none",D=n.properties.get("space-color").toNonPremultipliedRenderColor(P?null:x),O=5e-4,V=o.er(n.properties.get("horizon-blend"),0,1,O,.25),N=o.dD(t,c,p)&&V===O?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,j=t.frameCounter/1e3%1,Z=o.ag(p.globeCenterInViewSpace),H=Math.sqrt(Math.pow(Z,2)-Math.pow(N,2)),te=Math.acos(H/Z),W=re=>{const ee=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];re&&ee.push("ALPHA_PASS");const K=t.getOrCreateProgram("globeAtmosphere",{defines:ee}),ne=((fe,Me,we,ze,Je,xe,ce,Le,Te,je,rt,gt)=>({u_frustum_tl:fe,u_frustum_tr:Me,u_frustum_br:we,u_frustum_bl:ze,u_horizon:Je,u_transition:xe,u_fadeout_range:ce,u_atmosphere_fog_color:Le.toArray01(),u_high_color:Te.toArray01(),u_space_color:je.toArray01(),u_temporal_offset:rt,u_horizon_angle:gt}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,y,V,S,E,D,j,te);t.uploadCommonUniforms(c,K);const _e=this.atmosphereBuffer;_e&&K.draw(t,d.TRIANGLES,m,Zt.disabled,re?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,jt.backCW,ne,re?"atmosphere_glow_alpha":"atmosphere_glow",_e.vertexBuffer,_e.indexBuffer,_e.segments)};W(!1),W(!0)}drawStars(t,n){const c=o.aA(n.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,p=d.gl,m=t.transform,y=t.getOrCreateProgram("stars"),x=o.c6([]);o.c8(x,x,-m._pitch),o.c7(x,x,-m.angle),o.c8(x,x,o.an(m._center.lat)),o.es(x,x,-o.an(m._center.lng));const T=o.cb(new Float32Array(16),x),S=o.aB([],m.starsProjMatrix,T),M=o.en([],T),E=o.et([],M),P=[0,1,0];o.dP(P,P,E),o.c4(P,P,this.params.sizeMultiplier);const D=[1,0,0];o.dP(D,D,E),o.c4(D,D,this.params.sizeMultiplier);const O=(V=P,N=D,j=c,{u_matrix:Float32Array.from(S),u_up:V,u_right:N,u_intensity_multiplier:j});var V,N,j;t.uploadCommonUniforms(d,y),this.starsVx&&this.starsIdx&&y.draw(t,p.TRIANGLES,wt.disabled,Zt.disabled,this.colorModeAlphaBlendedWriteRGB,jt.disabled,O,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ge{constructor(){this.visibleTiles=[]}updateBorders(t,n){const c=[],d=[],p=t._getRenderableCoordinates(!1,!0);for(const x of p){const T=t.getTile(x);if(!T.hasData())continue;const S=T.getBucket(n);S&&(S.isEmpty()||(c.push(x.key),d.push({bucket:S,tileID:x.canonical})))}let m=c.length!==this.visibleTiles.length;if(!m){c.sort();for(let x=0;x<c.length;x++)if(c[x]!==this.visibleTiles[x]){m=!0;break}}if(!m)return;const y=new Set;this.visibleTiles=c,d.sort(((x,T)=>x.tileID.z-T.tileID.z||x.tileID.x-T.tileID.x||x.tileID.y-T.tileID.y));for(const x of d){const T=new Array,S=new Array,M=x.bucket;for(const E of M.featuresOnBorder)y.has(E.featureId)?S.push(E.footprintIndex):(y.add(E.featureId),T.push(E.footprintIndex));M.updateFootprintHiddenFlags(T,o.eu,!1),M.updateFootprintHiddenFlags(S,o.eu,!0)}}}function td(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=o.bz([]);return o.cR(d,d,[c,c,1]),o.aB(n,d,n),o.aB(n,t.worldToFogMatrix,n),n}function _l(l,t,n,c,d){const p=n.material,m=c.context,{baseColorTexture:y,metallicRoughnessTexture:x}=p.pbrMetallicRoughness,{normalTexture:T,occlusionTexture:S,emissionTexture:M}=p;function E(D,O,V){if(D&&(l.push(O),m.activeTexture.set(m.gl.TEXTURE0+V),D.gfxTexture)){const{minFilter:N,magFilter:j,wrapS:Z,wrapT:H}=D.sampler;D.gfxTexture.bindExtraParam(N,j,Z,H)}}E(y,"HAS_TEXTURE_u_baseColorTexture",qn.BaseColor),E(x,"HAS_TEXTURE_u_metallicRoughnessTexture",qn.MetallicRoughness),E(T,"HAS_TEXTURE_u_normalTexture",qn.Normal),E(S,"HAS_TEXTURE_u_occlusionTexture",qn.Occlusion),E(M,"HAS_TEXTURE_u_emissionTexture",qn.Emission),d&&(d.texture||(d.texture=new o.d_(c.context,d.image,[d.image.height,d.image.height,d.image.height],m.gl.RGBA8)),m.activeTexture.set(m.gl.TEXTURE0+qn.LUT),d.texture&&d.texture.bind(m.gl.LINEAR,m.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(n.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");const P=c.shadowRenderer;P&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),P.useNormalOffset&&l.push("NORMAL_OFFSET"))}function gl(l,t,n,c,d,p){const m=n.paint.get("model-opacity").constantOr(1),y=t.context,x=new wt(t.context.gl.LEQUAL,l.isLightMesh?wt.ReadOnly:wt.ReadWrite,t.depthRangeFor3D),T=t.transform,S=l.mesh,M=S.material,E=M.pbrMetallicRoughness,P=t.style.fog;let D;D=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:o.aB([],c.zScaleMatrix,l.nodeModelMatrix),o.aB(D,c.negCameraPosMatrix,D);const O=o.bk([],D);o.ef(O,O);const V=n.paint.get("model-color-use-theme").constantOr("default")==="none",N=n.paint.get("model-emissive-strength").constantOr(0),j=hu(new Float32Array(l.worldViewProjection),new Float32Array(D),new Float32Array(O),null,t,m,E.baseColorFactor,M.emissiveFactor,E.metallicFactor,E.roughnessFactor,M,N,n,void 0,void 0,l.materialOverride,l.modelColor),Z={defines:[]},H=[],te=t.shadowRenderer;te&&(te.useNormalOffset=!1),_l(Z.defines,H,S,t,V?null:n.lut);let W=null;if(P){const K=td(l.nodeModelMatrix,t.transform);if(W=new Float32Array(K),T.projection.name!=="globe"){const ne=S.aabb.min,_e=S.aabb.max,[fe,Me]=P.getOpacityForBounds(K,ne[0],ne[1],_e[0],_e[1]);Z.overrideFog=fe>=be||Me>=be}}const re=Ho(t,n.paint.get("model-cutoff-fade-range"));re.shouldRenderCutoff&&Z.defines.push("RENDER_CUTOFF");const ee=t.getOrCreateProgram("model",Z);t.uploadCommonUniforms(y,ee,null,W,re),t.renderPass!=="shadow"&&te&&te.setupShadowsFromMatrix(l.nodeModelMatrix,ee),ee.draw(t,y.gl.TRIANGLES,x,d,p,S.material.doubleSided?jt.disabled:jt.backCCW,j,n.id,S.vertexBuffer,S.indexBuffer,S.segments,n.paint,t.transform.zoom,void 0,H)}function xu(l,t,n){return l.type==="vector"?t.scope:n?"basemap":""}function vu(l,t,n,c,d,p,m,y,x){const T=l.transform,S=!!t.isGeometryBloom&&t.isGeometryBloom;if(S&&l.renderPass==="shadow")return;const M=T.projection.name==="globe"?o.eC(n,T):[...n];o.aB(M,M,t.globalMatrix);const E=o.aB([],c,M);if(t.meshes)for(const P of t.meshes){const D=y.get(P.material.name);if(D&&D.opacity<=0)continue;if(P.material.alphaMode!=="BLEND"){m.push({mesh:P,depth:0,modelIndex:d,worldViewProjection:E,nodeModelMatrix:M,isLightMesh:S,materialOverride:D,modelColor:x});continue}const O=o.af([],P.centroid,E);!T.isOrthographic&&O[2]<=0||p.push({mesh:P,depth:O[2],modelIndex:d,worldViewProjection:E,nodeModelMatrix:M,isLightMesh:S,materialOverride:D,modelColor:x})}if(t.children)for(const P of t.children)vu(l,P,n,c,d,p,m,y,x)}function yl(l,t,n,c){const d=n.shadowRenderer;if(!d)return;const p=d.getShadowPassDepthMode(),m=d.getShadowPassColorMode(),y=d.calculateShadowPassMatrixFromMatrix(t),x=dl(y);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,p,Zt.disabled,m,jt.disabled,x,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function xl(l,t,n,c,d,p){for(const m of d){const y=Object.assign({},c);y.part=m;const x={type:"Unknown",id:t,properties:y},T={orientation:l.paint.get("model-rotation").evaluate(x,n)};p.set(m,T)}}function jm(l,t,n,c,d,p){for(const m of d){const y=Object.assign({},c);y.part=m;const x={type:"Unknown",id:t,properties:y},T={color:l.paint.get("model-color").evaluate(x,n),colorMix:l.paint.get("model-color-mix-intensity").evaluate(x,n),opacity:l.paint.get("model-opacity").evaluate(x,n),emissionStrength:l.paint.get("model-emissive-strength").evaluate(x,n)};p.set(m,T)}}function Kf(l,t,n,c,d,p){if(n===1)for(const y of d)gl(y,l,t,p[y.modelIndex],Zt.disabled,l.colorModeForRenderPass());else{for(const y of d)gl(y,l,t,p[y.modelIndex],Zt.disabled,ni.disabled);for(const y of d)gl(y,l,t,p[y.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}const m=ni.additive;for(const y of c)gl(y,l,t,p[y.modelIndex],Zt.disabled,y.isLightMesh?m:l.colorModeForRenderPass())}function Jf(l,t,n){const c=t.updateZoomBasedPaintProperties(),d=(function(p,m,y){let x,T,S,M=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&M>0){const E=p.terrain,P=E.findDEMTileFor(y);P&&P.dem?x=o.eE.create(E,y,P):M=0}if(M===0&&(m.terrainElevationMin=0,m.terrainElevationMax=0),M===m.validForExaggeration&&(M===0||x&&x._demTile&&x._demTile.tileID===m.validForDEMTile.id&&x._dem._timestamp===m.validForDEMTile.timestamp))return!1;for(const E in m.instancesPerModel){const P=m.instancesPerModel[E];for(let D=0;D<P.instancedDataArray.length;++D){const O=(x?M*x.getElevationAt(0|P.instancedDataArray.float32[16*D],0|P.instancedDataArray.float32[16*D+1],!0,!0):0)+P.instancesEvaluatedElevation[D];P.instancedDataArray.float32[16*D+6]=O,T=T?Math.min(m.terrainElevationMin,O):O,S=S?Math.max(m.terrainElevationMax,O):O}}return m.terrainElevationMin=T||0,m.terrainElevationMax=S||0,m.validForExaggeration=M,m.validForDEMTile=x&&x._demTile?{id:x._demTile.tileID,timestamp:x._dem._timestamp}:{id:void 0,timestamp:0},!0})(l,t,n);(c||d)&&(t.uploaded=!1,t.upload(l.context))}const Xs={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.d8([0,0,0],[o.al,o.al,0])};function id(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/n,m=(l.canonical.x+1)/n,y=l.canonical.y/n,x=(l.canonical.y+1)/n;let T=t._centerAltitude;if(d){const P=d.getMinMaxForTile(l);P&&P.max>T&&(T=P.max)}const S=o.aA(c.x,p,m)-c.x,M=o.aA(c.y,y,x)-c.y,E=o.ce(T,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(S*S+M*M+E*E))}function rd(l,t,n,c,d,p,m){const y=l.context,x=l.renderPass==="shadow",T=l.shadowRenderer,S=x&&T?T.getShadowPassDepthMode():new wt(y.gl.LEQUAL,wt.ReadWrite,l.depthRangeFor3D),M=l.isTileAffectedByFog(p),E=l.transform.projection.name==="globe";if(n.meshes)for(const P of n.meshes){const D=E?[]:["MODEL_POSITION_ON_GPU"],O=[];let V,N,j;const Z=!E&&c.instancedDataArray.length>20;Z&&D.push("INSTANCED_ARRAYS");const H=Ho(l,t.paint.get("model-cutoff-fade-range"));if(H.shouldRenderCutoff&&D.push("RENDER_CUTOFF"),x&&T)V=l.getOrCreateProgram("modelDepth",{defines:D}),N=dl(m.shadowTileMatrix,m.shadowTileMatrix,Float32Array.from(n.globalMatrix)),j=T.getShadowPassColorMode();else{_l(D,O,P,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),V=l.getOrCreateProgram("model",{defines:D,overrideFog:M});const W=P.material,re=W.pbrMetallicRoughness,ee=t.paint.get("model-opacity").constantOr(1),K=t.paint.get("model-emissive-strength").constantOr(0);N=hu(p.expandedProjMatrix,Float32Array.from(n.globalMatrix),new Float32Array(16),null,l,ee,re.baseColorFactor,W.emissiveFactor,re.metallicFactor,re.roughnessFactor,W,K,t,d),T&&(m.shadowUniformsInitialized?V.setShadowUniformValues(y,T.getShadowUniformValues()):(T.setupShadows(p.toUnwrapped(),V,"model-tile"),m.shadowUniformsInitialized=!0)),j=H.shouldRenderCutoff||ee<1||W.alphaMode!=="OPAQUE"?ni.alphaBlended:ni.unblended}l.uploadCommonUniforms(y,V,p.toUnwrapped(),null,H);const te=P.material.doubleSided?jt.disabled:jt.backCCW;if(Z)O.push(c.instancedDataBuffer),V.draw(l,y.gl.TRIANGLES,S,Zt.disabled,j,te,N,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,O,c.instancedDataArray.length);else{const W=x?"u_instance":"u_normal_matrix";for(let re=0;re<c.instancedDataArray.length;++re)N[W]=new Float32Array(c.instancedDataArray.arrayBuffer,64*re,16),V.draw(l,y.gl.TRIANGLES,S,Zt.disabled,j,te,N,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,O)}}if(n.children)for(const P of n.children)rd(l,t,P,c,d,p,m)}const Qf=[1,-1,1];function bu(l,t,n,c){if(!n.modelManager)return!0;const d=n.modelManager;if(!n.shadowRenderer)return!0;const p=n.shadowRenderer,m=t.aabb;let y=!0,x=l.maxHeight;if(x===0){let S=0;for(const M in l.instancesPerModel){const E=d.getModel(M,c);E?S=Math.max(S,Math.max(Math.max(E.aabb.max[0],E.aabb.max[1]),E.aabb.max[2])):y=!1}x=l.maxScale*S*1.41+l.maxVerticalOffset,y&&(l.maxHeight=x)}m.max[2]=x,m.min[2]+=l.terrainElevationMin,m.max[2]+=l.terrainElevationMax,o.af(m.min,m.min,t.tileMatrix),o.af(m.max,m.max,t.tileMatrix);const T=m.intersects(p.getCurrentCascadeFrustum());return n.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=T===2),T===0}function gc(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===n||p===d?1:o.aA(((t-n)/(c-n)-d)/(p-d),0,1)}function ka(l,t,n,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();o.aB(d,d,l);const p=o.bT(n.min[0],n.min[1],n.min[2],1);let m=o.aC(o.eF(),p,d),y=m,x=m;p[1]=n.max[1],m=o.aC(o.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x,p[0]=n.max[0],m=o.aC(o.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x,p[1]=n.min[1],m=o.aC(o.eF(),p,d),y=m[1]<y[1]?m:y,x=m[1]>x[1]?m:x;const T=o.aA(c[0],0,1),S=100*t.pixelsPerMeter*o.aA(c[1],0,1),M=o.aA(c[2],0,1),E=o.eG(o.eF(),y,x,T),P=Math.tan(.5*t.fovX),D=-E[2]*P;if(S===0)return E[1]<-Math.abs(D)?M:1;const O=(-Math.abs(D)-E[1])/S,V=(j,Z,H)=>(1-H)*j+H*Z,N=o.aA(V(1,M,O),M,1);return V(1,N,o.aA((t.pitch-20)/20,0,1))}class ep{}class tp{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const M=this._storage.get(n.id);if(M)return M.lastUsedFrameIdx=t,M.buf}const d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),m=new ArrayBuffer(p),y=new Int16Array(m);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(m));const x=new o.eI;for(let M=0;M<p/2;M+=3){const E=y[M],P=y[M+1],D=y[M+2];x.emplaceBack(E,P),x.emplaceBack(P,D),x.emplaceBack(D,E)}const T=c.bindVertexArrayOES.current,S=new ep;return S.buf=new la(c,x),S.lastUsedFrameIdx=t,this._storage.set(n.id,S),c.bindVertexArrayOES.set(T),S.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class Gm{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const ip=o.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Hm{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class ys{constructor(t,n){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...n,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...n,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const qm=o.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class yc{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const m=new o.eJ,y=new o.b0;m.emplaceBack(-1,-1),m.emplaceBack(1,-1),m.emplaceBack(1,1),m.emplaceBack(-1,1),y.emplaceBack(0,1,2),y.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(m,qm.members),this.vignetteIdx=t.context.createIndexBuffer(y)}const d=o.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const m={u_vignetteShape:(p={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,wt.disabled,Zt.disabled,ni.alphaBlended,jt.disabled,m,"vignette",this.vignetteVx,this.vignetteIdx,d)}var p}}class Ir{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),m=o.an(p.lng),y=o.an(p.lat),x=t.pixelsPerMeter/n,T=m*o.eL,S=o.eL*Math.log(Math.tan(Math.PI/4+y/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const M=-this._offsetYPrev+S,E=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+T)*x,this._accumulatedOffsetY+=M*x,this._accumulatedElevation+=E*x,this._offsetXPrev=T,this._offsetYPrev=S,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function fi(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function nd(l){const t=o.eq(1323123451230),n=[];for(let c=0;c<l;++c){const d=2*t()-1,p=2*t()-1,m=2*t()-1;n.push(o.d4(d,p,m))}return n}function Ps(l,t,n,c,d){const p=o.aA((d-n)/(c-n),0,1);return(1-p)*l+p*t}class Fa{constructor(t){this._movement=new Ir,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new yc,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,p=o.c6([]);o.c8(p,p,o.an(90)-c._pitch),o.c7(p,p,-c.angle);const m=o.cb(new Float32Array(16),p),y=o.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),x=o.ef([],y),T=o.aB([],x,m),S=Date.now()/1e3;return this._accumulatedTimeFromStart+=(S-this._prevTime)*n,this._prevTime=S,{projectionMatrix:d,modelviewMatrix:T}}}class vl extends Fa{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new ys(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=nd(this.particlesCount),d=new o.eM,p=new o.b0;let m=0;const y=o.eq(1323123451230);for(let x=0;x<c.length;++x){const T=c[x],S=[2*y()-1,y(),y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,-1,...S),d.emplaceBack(T[0],T[1],T[2],1,1,...S),d.emplaceBack(T[0],T[1],T[2],-1,1,...S),p.emplaceBack(m+0,m+1,m+2),p.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,ip.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const d=Ps(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const p=structuredClone(this._params);let m=[-p.direction.x,p.direction.y,-100];o.aw(m,m);const y=structuredClone(this._vignetteParams);y.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),m=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,y.strength=1,y.color=structuredClone(t.style.rain.state.vignetteColor));const x=this.updateOnRender(t,p.timeFactor),T=t.context,S=T.gl,M=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new o.T(T,{width:t.width,height:t.height,data:null},S.RGBA8)),p.distortionStrength>0&&(T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexSubImage2D(S.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const E=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(T,E),T.activeTexture.set(S.TEXTURE0),this.screenTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE);const P=[p.color.r,p.color.g,p.color.b,p.color.a],D=(O,V)=>{const N=fi(this._movement.getPosition(),O),j=p.dropletSizeX,Z=p.dropletSizeX*p.dropletSizeYScale,H=t.width/2,te=t.height/2,W=Ps(0,p.screenThinning.start,0,1,p.screenThinning.intensity),re=Ps(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),ee=Ps(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),K=(ne={modelview:x.modelviewMatrix,projection:x.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:N,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:O,rainDropletSize:[j,Z],distortionStrength:p.distortionStrength,rainDirection:m,color:P,screenSize:[M.width,M.height],thinningCenterPos:[H,te],thinningShape:[W,re,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:ee,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:V?0:1},{u_modelview:Float32Array.from(ne.modelview),u_projection:Float32Array.from(ne.projection),u_time:ne.time,u_cam_pos:ne.camPos,u_texScreen:0,u_velocityConeAperture:ne.velocityConeAperture,u_velocity:ne.velocity,u_boxSize:ne.boxSize,u_rainDropletSize:ne.rainDropletSize,u_distortionStrength:ne.distortionStrength,u_rainDirection:ne.rainDirection,u_color:ne.color,u_screenSize:ne.screenSize,u_thinningCenterPos:ne.thinningCenterPos,u_thinningShape:ne.thinningShape,u_thinningAffectedRatio:ne.thinningAffectedRatio,u_thinningParticleOffset:ne.thinningParticleOffset,u_shapeDirectionalPower:ne.shapeDirectionalPower,u_shapeNormalPower:ne.shapeNormalPower,u_mode:ne.mode});var ne;const _e=Math.round(p.intensity*this.particlesCount),fe=o.bf.simpleSegment(0,0,4*_e,2*_e);E.draw(t,S.TRIANGLES,wt.disabled,Zt.disabled,ni.alphaBlended,jt.disabled,K,"rain_particles",this.particlesVx,this.particlesIdx,fe)};p.distortionStrength>0&&D(p.boxSize,!0),D(p.boxSize,!1),this._vignette.draw(t,y)}}const Wo=o.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class sd extends Fa{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new ys(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=nd(this.particlesCount),d=new o.eN,p=new o.b0;let m=0;const y=o.eq(1323123451230);for(let x=0;x<c.length;++x){const T=c[x],S=y(),M=y(),E=y(),P=[x/c.length,S,M,E],D=[y(),y()];d.emplaceBack(T[0],T[1],T[2],-1,-1,...P,...D),d.emplaceBack(T[0],T[1],T[2],1,-1,...P,...D),d.emplaceBack(T[0],T[1],T[2],1,1,...P,...D),d.emplaceBack(T[0],T[1],T[2],-1,1,...P,...D),p.emplaceBack(m+0,m+1,m+2),p.emplaceBack(m+0,m+2,m+3),m+=4}this.particlesVx=n.createVertexBuffer(d,Wo.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];o.aw(c,c);const d=structuredClone(this._vignetteParams),p=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},m=t.transform.zoom;if(p.revealStart>m)return;const y=Ps(0,1,p.revealStart,p.revealStart+p.revealRange,m);d.strength*=y,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const x=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const T=t.context,S=T.gl,M=t.transform,E=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(T,E),((P,D,O)=>{const V=fi(this._movement.getPosition(),P),N=M.width/2,j=M.height/2,Z=Ps(0,O.screenThinning.start,0,1,O.screenThinning.intensity),H=Ps(.001,O.screenThinning.range,0,1,O.screenThinning.intensity),te=Ps(0,O.screenThinning.particleOffset,0,1,O.screenThinning.intensity),W=(re={modelview:x.modelviewMatrix,projection:x.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:V,velocityConeAperture:O.velocityConeAperture,velocity:O.velocity,horizontalOscillationRadius:O.horizontalOscillationRadius,horizontalOscillationRate:O.horizontalOscillationRate,boxSize:P,billboardSize:1*O.billboardSize,simpleShapeParameters:[O.shapeFadeStart,O.shapeFadePower],screenSize:[M.width,M.height],thinningCenterPos:[N,j],thinningShape:[Z,H,Math.pow(10,O.screenThinning.fadePower)],thinningAffectedRatio:O.screenThinning.affectedRatio,thinningParticleOffset:te,color:[O.color.r,O.color.g,O.color.b,O.color.a],direction:c},{u_modelview:Float32Array.from(re.modelview),u_projection:Float32Array.from(re.projection),u_time:re.time,u_cam_pos:re.camPos,u_velocityConeAperture:re.velocityConeAperture,u_velocity:re.velocity,u_horizontalOscillationRadius:re.horizontalOscillationRadius,u_horizontalOscillationRate:re.horizontalOscillationRate,u_boxSize:re.boxSize,u_billboardSize:re.billboardSize,u_simpleShapeParameters:re.simpleShapeParameters,u_screenSize:re.screenSize,u_thinningCenterPos:re.thinningCenterPos,u_thinningShape:re.thinningShape,u_thinningAffectedRatio:re.thinningAffectedRatio,u_thinningParticleOffset:re.thinningParticleOffset,u_particleColor:re.color,u_direction:re.direction});var re;const ee=Math.round(O.intensity*this.particlesCount),K=o.bf.simpleSegment(0,0,4*ee,2*ee);this.particlesVx&&this.particlesIdx&&E.draw(t,S.TRIANGLES,wt.disabled,Zt.disabled,ni.alphaBlended,jt.disabled,W,"snow_particles",this.particlesVx,this.particlesIdx,K)})(n.boxSize,0,n),this._vignette.draw(t,d)}}const od={symbol:function(l,t,n,c,d){if(l.renderPass!=="translucent")return;const p=Zt.disabled,m=l.colorModeForRenderPass(),y=n.layout.get("text-variable-anchor"),x=n.layout.get("text-size-scale-range"),T=o.aA(l.scaleFactor,x[0],x[1]);y&&(function(E,P,D,O,V,N,j,Z){const H=P.transform,te=V==="map",W=N==="map";for(const re of E){const ee=O.getTile(re),K=ee.getBucket(D);if(!K||!K.text||!K.text.segments.get().length)continue;const ne=o.bJ(K.textSizeData,H.zoom,Z),_e=Oc(re,K.getProjection(),H),fe=H.calculatePixelsToTileUnitsMatrix(ee),Me=Wa(_e,ee.tileID.canonical,W,te,H,K.getProjection(),fe),we=K.hasIconTextFit()&&K.hasIconData();ne&&mu(K,te,W,j,H,Me,re,Math.pow(2,H.zoom-ee.tileID.overscaledZ),ne,we)}})(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),d,T);const S=n.paint.get("icon-opacity").constantOr(1)!==0,M=n.paint.get("text-opacity").constantOr(1)!==0;n.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(S||M)?mc(l,t,n,c,p,m):(S&&mc(l,t,n,c,p,m,{onlyIcons:!0}),M&&mc(l,t,n,c,p,m,{onlyText:!0})),t.map.showCollisionBoxes&&(pc(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),pc(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("circle-opacity"),p=n.paint.get("circle-stroke-width"),m=n.paint.get("circle-stroke-opacity"),y=n.layout.get("circle-sort-key").constantOr(1)!==void 0,x=n.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||m.constantOr(1)===0))return;const T=l.context,S=T.gl,M=l.transform,E=!(!l.terrain||!l.terrain.enabled),P=n.layout.get("circle-elevation-reference"),D=l.depthModeForSublayer(0,wt.ReadOnly),O=new wt(l.context.gl.LEQUAL,wt.ReadOnly,l.depthRangeFor3D),V=P==="none"||E?D:O,N=Zt.disabled,j=l.colorModeForDrapableLayerRenderPass(x),Z=M.projection.name==="globe",H=[o.aF(M.center.lng),o.aJ(M.center.lat)],te=[];for(let re=0;re<c.length;re++){const ee=c[re],K=t.getTile(ee),ne=K.getBucket(n);if(!ne||ne.projection.name!==M.projection.name)continue;const _e=ne.programConfigurations.get(n.id),fe=ne.layoutVertexBuffer,Me=ne.globeExtVertexBuffer,we=ne.indexBuffer,ze=o.d$(n),Je=[Me],xe=l.isTileAffectedByFog(ee);Z&&ze.push("PROJECTION_GLOBE_VIEW"),ze.push("DEPTH_D24"),l.terrain&&M.depthOcclusionForSymbolsAndCircles&&ze.push("DEPTH_OCCLUSION"),ne.hasElevation&&!l.terrain&&(ze.push("ELEVATED_ROADS"),Je.push(ne.elevatedLayoutVertexBuffer));const ce=l.getOrCreateProgram("circle",{config:_e,defines:ze,overrideFog:xe}),Le=M.projection.createInversionMatrix(M,ee.canonical),Te={programConfiguration:_e,program:ce,layoutVertexBuffer:fe,dynamicBuffers:Je,indexBuffer:we,uniformValues:o.e0(l,ee,K,Le,H,n),tile:K};if(y){const je=ne.segments.get();for(const rt of je)te.push({segments:new o.bf([rt]),sortKey:rt.sortKey,state:Te})}else te.push({segments:ne.segments,sortKey:0,state:Te})}y&&te.sort(((re,ee)=>re.sortKey-ee.sortKey));const W={useDepthForOcclusion:M.depthOcclusionForSymbolsAndCircles};for(const re of te){const{programConfiguration:ee,program:K,layoutVertexBuffer:ne,dynamicBuffers:_e,indexBuffer:fe,uniformValues:Me,tile:we}=re.state,ze=re.segments;l.terrain&&l.terrain.setupElevationDraw(we,K,W),l.uploadCommonUniforms(T,K,we.tileID.toUnwrapped()),K.draw(l,S.TRIANGLES,V,N,j,jt.disabled,Me,n.id,ne,fe,ze,n.paint,M.zoom,ee,_e)}},heatmap:function(l,t,n,c){if(n.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const d=l.context,p=d.gl,m=Zt.disabled,y=new ni([p.ONE,p.ONE,p.ONE,p.ONE],o.ao.transparent,[!0,!0,!0,!0]);(function(P,D,O,V){const N=P.gl,j=D.width*V,Z=D.height*V;P.activeTexture.set(N.TEXTURE1),P.viewport.set([0,0,j,Z]);let H=O.heatmapFbo;if(!H||H&&(H.width!==j||H.height!==Z)){H&&H.destroy();const te=N.createTexture();N.bindTexture(N.TEXTURE_2D,te),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_MIN_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_MAG_FILTER,N.LINEAR),H=O.heatmapFbo=P.createFramebuffer(j,Z,!0,null),(function(W,re,ee,K,ne,_e){const fe=W.gl;fe.texImage2D(fe.TEXTURE_2D,0,W.extRenderToTextureHalfFloat?fe.RGBA16F:fe.RGBA,ne,_e,0,fe.RGBA,W.extRenderToTextureHalfFloat?fe.HALF_FLOAT:fe.UNSIGNED_BYTE,null),K.colorAttachment.set(ee)})(P,0,te,H,j,Z)}else N.bindTexture(N.TEXTURE_2D,H.colorAttachment.get()),P.bindFramebuffer.set(H.framebuffer)})(d,l,n,l.transform.projection.name==="globe"?.5:.25),d.clear({color:o.ao.transparent});const x=l.transform,T=x.projection.name==="globe",S=T?["PROJECTION_GLOBE_VIEW"]:[],M=T?jt.frontCCW:jt.disabled,E=[o.aF(x.center.lng),o.aJ(x.center.lat)];for(let P=0;P<c.length;P++){const D=c[P];if(t.hasRenderableParent(D))continue;const O=t.getTile(D),V=O.getBucket(n);if(!V||V.projection.name!==x.projection.name)continue;const N=l.isTileAffectedByFog(D),j=V.programConfigurations.get(n.id),Z=l.getOrCreateProgram("heatmap",{config:j,defines:S,overrideFog:N}),{zoom:H}=l.transform;l.terrain&&l.terrain.setupElevationDraw(O,Z),l.uploadCommonUniforms(d,Z,D.toUnwrapped());const te=x.projection.createInversionMatrix(x,D.canonical);Z.draw(l,p.TRIANGLES,wt.disabled,m,y,M,Gf(l,D,O,te,E,H,n.paint.get("heatmap-intensity")),n.id,V.layoutVertexBuffer,V.indexBuffer,V.segments,n.paint,l.transform.zoom,j,T?[V.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),(function(d,p){const m=d.context,y=m.gl,x=p.heatmapFbo;if(!x)return;m.activeTexture.set(y.TEXTURE0),y.bindTexture(y.TEXTURE_2D,x.colorAttachment.get()),m.activeTexture.set(y.TEXTURE1);let T=p.colorRampTexture;T||(T=p.colorRampTexture=new o.T(m,p.colorRamp,y.RGBA8)),T.bind(y.LINEAR,y.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,y.TRIANGLES,wt.disabled,Zt.disabled,d.colorModeForRenderPass(),jt.disabled,((S,M,E,P)=>({u_image:0,u_color_ramp:1,u_opacity:M.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)})(l,n))},line:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("line-opacity"),p=n.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;const m=n.paint.get("line-emissive-strength"),y=n.paint.get("line-occlusion-opacity"),x=n.layout.get("line-elevation-reference"),T=n.layout.get("line-width-unit")==="meters",S=x==="sea",M=!(!l.terrain||!l.terrain.enabled),E=l.context,P=E.gl;if(n.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const D=n.layout.get("line-cross-slope"),O=D!==void 0,V=D<1,N=l.colorModeForDrapableLayerRenderPass(m),j=l.terrain&&l.terrain.renderingToTexture,Z=j?1:o.o.devicePixelRatio,H=n.paint.get("line-dasharray"),te=H.constantOr(1),W=n.layout.get("line-cap"),re=H.constantOr(null),ee=W.constantOr(null),K=n.paint.get("line-pattern"),ne=K.constantOr(1),_e=n.paint.get("line-pattern-cross-fade"),fe=K.constantOr(null),Me=n.paint.get("line-opacity").constantOr(1);let we=!ne&&Me!==1||l.depthOcclusion&&y>0&&y<1;const ze=n.paint.get("line-gradient"),Je=ne?"linePattern":"line",xe=o.e1(n);let ce;if(j&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(we=!1),y!==0&&l.depthOcclusion){const rt=n.paint._values["line-opacity"];rt&&rt.value&&rt.value.kind==="constant"?ce=rt.value:o.w("Occlusion opacity for layer ".concat(n.id," is supported only when line-opacity isn't data-driven."))}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&xe.push("VARIABLE_LINE_WIDTH");const Le=(rt,gt,Xe,et,xt,dt)=>{for(const ut of rt){const ft=t.getTile(ut);if(ne&&!ft.patternsLoaded())continue;const zt=ft.getBucket(n);if(!zt||zt.elevationType!=="none"&&!xt||zt.elevationType==="none"&&xt)continue;l.prepareDrawTile();const pi=[...gt],vi=l.shadowRenderer,tr=zt.elevationType==="road"&&!!vi&&vi.enabled;let Gt=[0,0,0];if(tr){const qt=l.style.directionalLight,Ti=l.style.ambientLight;qt&&Ti&&(Gt=mo(l.style,qt,Ti)),pi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const xi=zt.programConfigurations.get(n.id);let ti=!1;if(fe&&ft.imageAtlas){const qt=o.e2.from(fe),Ti=qt.getPrimary().scaleSelf(Z).toString(),Or=ft.imageAtlas.patternPositions.get(Ti),tn=qt.getSecondary(),Ur=tn?ft.imageAtlas.patternPositions.get(tn.scaleSelf(Z).toString()):null;ti=!!Or&&!!Ur,Or&&xi.setConstantPatternPositions(Or,Ur)}_e>0&&(ti||xi.getPatternTransitionVertexBuffer("line-pattern"))&&pi.push("LINE_PATTERN_TRANSITION");const Zi=l.isTileAffectedByFog(ut),bi=l.getOrCreateProgram(Je,{config:xi,defines:pi,overrideFog:Zi});if(!ne&&re&&ee&&ft.lineAtlas){const qt=ft.lineAtlas.getDash(re,ee);qt&&xi.setConstantPatternPositions(qt)}tr&&vi.setupShadows(ft.tileID.toUnwrapped(),bi,"vector-tile");let[cr,Pi]=n.paint.get("line-trim-offset");(ee==="round"||ee==="square")&&cr!==Pi&&(cr===0&&(cr-=1),Pi===1&&(Pi+=1));const ii=j?ut.projMatrix:null,Ni=T?1/zt.tileToMeter/o.ay(ft,1,l.transform.zoom):1,si=T?1/zt.tileToMeter/o.ay(ft,1,Math.floor(l.transform.zoom)):1,br=ne?o.e3(l,ft,n,ii,Z,Ni,si,[cr,Pi],Gt,_e):o.e4(l,ft,n,ii,zt.lineClipsArray.length,Z,Ni,si,[cr,Pi],Gt);if(ze){const qt=zt.gradients[n.id];let Ti=qt.texture;if(n.gradientVersion!==qt.version){let Or=256;if(n.stepInterpolant){const tn=t.getSource().maxzoom,Ur=ut.canonical.z===tn?Math.ceil(1<<l.transform.maxZoom-ut.canonical.z):1;Or=o.aA(o.e5(zt.maxLineLength/o.al*1024*Ur),256,E.maxTextureSize)}qt.gradient=o.e6({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:Or,image:qt.gradient||void 0,clips:zt.lineClipsArray}),qt.texture?qt.texture.update(qt.gradient):qt.texture=new o.T(E,qt.gradient,P.RGBA8),qt.version=n.gradientVersion,Ti=qt.texture}E.activeTexture.set(P.TEXTURE1),Ti.bind(n.stepInterpolant?P.NEAREST:P.LINEAR,P.CLAMP_TO_EDGE)}te&&(E.activeTexture.set(P.TEXTURE0),ft.lineAtlasTexture&&ft.lineAtlasTexture.bind(P.LINEAR,P.REPEAT),xi.updatePaintBuffers()),ne&&(E.activeTexture.set(P.TEXTURE0),ft.imageAtlasTexture&&ft.imageAtlasTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),xi.updatePaintBuffers()),xt&&!S&&l.terrain.setupElevationDraw(ft,bi),l.uploadCommonUniforms(E,bi,ut.toUnwrapped());const Ui=qt=>{ce!=null&&(ce.value=Me*y),bi.draw(l,P.TRIANGLES,Xe,qt,N,jt.disabled,br,n.id,zt.layoutVertexBuffer,zt.indexBuffer,zt.segments,n.paint,l.transform.zoom,xi,[zt.layoutVertexBuffer2,zt.patternVertexBuffer,zt.zOffsetVertexBuffer]),ce!=null&&(ce.value=Me)};if(we&&!xt){const qt=l.stencilModeForClipping(ut).ref;qt===0&&j&&E.clear({stencil:0});const Ti={func:P.EQUAL,mask:255};br.u_alpha_discard_threshold=.8,Ui(new Zt(Ti,qt,255,P.KEEP,P.KEEP,P.INVERT)),br.u_alpha_discard_threshold=0,Ui(new Zt(Ti,qt,255,P.KEEP,P.KEEP,P.KEEP))}else br.u_alpha_discard_threshold=we&&xt&&dt?.8:0,Ui(xt?et:l.stencilModeForClipping(ut))}};let Te=l.depthModeForSublayer(0,wt.ReadOnly);const je=new wt(l.depthOcclusion?P.GREATER:P.LEQUAL,wt.ReadOnly,l.depthRangeFor3D);if(n.hasNonElevatedBuckets){const rt=!j&&l.terrain;y!==0&&rt?o.w("Occlusion opacity for layer ".concat(n.id," is supported on terrain only if the layer has line-z-offset enabled.")):rt?o.w("Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ".concat(n.id,".")):Le(c,xe,Te,Zt.disabled,!1,!0)}if(n.hasElevatedBuckets){x==="hd-road-markup"?M||(Te=je,xe.push("ELEVATED_ROADS")):(xe.push("ELEVATED"),Te=je,O&&xe.push(V?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),S&&xe.push("ELEVATION_REFERENCE_SEA"));const rt=we?l.stencilModeFor3D():Zt.disabled;l.forceTerrainMode=!0,Le(c,xe,Te,rt,!0,!0),we&&Le(c,xe,Te,rt,!0,!1),l.forceTerrainMode=!1}we&&(l.resetStencilClippingMasks(),j&&E.clear({stencil:0})),y===0||l.depthOcclusion||j||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const d=n.paint.get("fill-color"),p=n.paint.get("fill-opacity");if(p.constantOr(1)===0)return;const m=n.paint.get("fill-emissive-strength"),y=l.colorModeForDrapableLayerRenderPass(m),x=n.paint.get("fill-pattern"),T=l.opaquePassEnabledForLayer()&&!x.constantOr(1)&&d.constantOr(o.ao.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";let S="none";n.layout.get("fill-elevation-reference")!=="none"?S="road":n.paint.get("fill-z-offset").constantOr(1)!==0&&(S="offset");const M=!(!l.terrain||!l.terrain.enabled),E={painter:l,sourceCache:t,layer:n,coords:c,colorMode:y,elevationType:S,terrainEnabled:M,pass:T};if(l.renderPass!=="shadow")if(S!=="offset"){if(fl(E,!1),S==="road"){const P=!M&&l.renderPass==="translucent";P&&La(l,t,n,c,"geometry"),fl(E,!0,Zt.disabled),P&&(function(D){const{painter:O,sourceCache:V,layer:N,coords:j,colorMode:Z}=D,H=O.context.gl,te=D.painter.shadowRenderer,W=!!te&&te.enabled,re=new wt(O.context.gl.LEQUAL,wt.ReadOnly,O.depthRangeFor3D);let ee=[0,0,0];if(W){const ne=O.style.directionalLight,_e=O.style.ambientLight;ne&&_e&&(ee=mo(O.style,ne,_e))}const K=ne=>{for(const _e of j){const fe=V.getTile(_e),Me=fe.getBucket(N);if(!Me)continue;const we=Me.elevatedStructures;if(!we)continue;let ze,Je;if(ne?(ze=we.renderableBridgeSegments,Je=we.bridgeProgramConfigurations.get(N.id)):(ze=we.renderableTunnelSegments,Je=we.tunnelProgramConfigurations.get(N.id)),!ze||ze.segments[0].primitiveLength===0)continue;Je.updatePaintBuffers(),O.prepareDrawTile();const xe=O.isTileAffectedByFog(_e),ce=[];W&&ce.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Le=O.getOrCreateProgram("elevatedStructures",{config:Je,overrideFog:xe,defines:ce}),Te=O.translatePosMatrix(_e.projMatrix,fe,N.paint.get("fill-translate"),N.paint.get("fill-translate-anchor"));W&&te.setupShadows(fe.tileID.toUnwrapped(),Le,"vector-tile");const je=Fm(Te,ee);O.uploadCommonUniforms(O.context,Le,_e.toUnwrapped()),Le.draw(O,H.TRIANGLES,re,Zt.disabled,Z,jt.backCCW,je,N.id,we.vertexBuffer,we.indexBuffer,ze,N.paint,O.transform.zoom,Je,[we.vertexBufferNormal])}};K(!0),K(!1)})(E)}}else fl(E,!1,l.stencilModeFor3D());else l.shadowRenderer&&S==="road"&&!M&&(function(P){const{painter:D,sourceCache:O,layer:V,coords:N}=P,j=D.context.gl,Z=P.painter.shadowRenderer;for(const H of N){const te=O.getTile(H),W=te.getBucket(V);if(!W)continue;const re=W.elevatedStructures;if(!re||!re.shadowCasterSegments||re.shadowCasterSegments.segments[0].primitiveLength===0)continue;D.prepareDrawTile();const ee=W.bufferData.programConfigurations.get(V.id),K=D.isTileAffectedByFog(H),ne=D.getOrCreateProgram("elevatedStructuresDepth",{config:ee,overrideFog:K}),_e=Z.calculateShadowPassMatrixFromTile(te.tileID.toUnwrapped());D.uploadCommonUniforms(D.context,ne,H.toUnwrapped());const fe={u_matrix:_e,u_depth_bias:0};ne.draw(D,j.TRIANGLES,Z.getShadowPassDepthMode(),Zt.disabled,Z.getShadowPassColorMode(),jt.disabled,fe,V.id,re.vertexBuffer,re.indexBuffer,re.shadowCasterSegments,V.paint,D.transform.zoom,ee)}})(E)},"fill-extrusion":function(l,t,n,c){const d=n.paint.get("fill-extrusion-opacity"),p=l.context,m=p.gl,y=l.terrain,x=y&&y.renderingToTexture;if(d===0)return;const T=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),S=l.style.order.indexOf(n.fqid);if(T&&(function(M,E,P,D,O){for(const V of D){const N=E.getTile(V).getBucket(P);N&&(N.updateReplacement(V,M.replacementSource,O),N.uploadCentroid(M.context))}})(l,t,n,c,S),y||T)for(const M of c){const E=t.getTile(M).getBucket(n);E&&ua(l.context,t,M,E,n,y,T)}if(l.renderPass==="shadow"&&l.shadowRenderer){const M=l.shadowRenderer;if(y&&d<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.ad)return;const E=M.getShadowPassDepthMode(),P=M.getShadowPassColorMode();mt(l,t,n,c,E,Zt.disabled,P,T)}else if(l.renderPass==="translucent"){const M=!n.paint.get("fill-extrusion-pattern").constantOr(1),E=n.paint.get("fill-extrusion-color").constantOr(o.ao.white);if(!x&&E.a!==0){const P=new wt(l.context.gl.LEQUAL,wt.ReadWrite,l.depthRangeFor3D);d===1&&M?mt(l,t,n,c,P,Zt.disabled,ni.unblended,T):(mt(l,t,n,c,P,Zt.disabled,ni.disabled,T),mt(l,t,n,c,P,l.stencilModeFor3D(),l.colorModeForRenderPass(),T),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&M&&(!y&&l.transform.projection.name!=="globe"||x)){const P=n.paint.get("fill-extrusion-opacity"),D=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),O=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),V=n.paint.get("fill-extrusion-flood-light-intensity"),N=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",j=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(N?null:n.lut).toArray01().slice(0,3),Z=D>0&&O>0,H=V>0,te=(ee,K,ne)=>(1-ne)*ee+ne*K,W=new qh;W.translate=n.paint.get("fill-extrusion-translate"),W.translateAnchor=n.paint.get("fill-extrusion-translate-anchor"),W.edgeRadius=n.layout.get("fill-extrusion-edge-radius"),W.cutoffFadeRange=n.paint.get("fill-extrusion-cutoff-fade-range");const re=ee=>{const K=l.depthModeForSublayer(1,wt.ReadOnly,m.LEQUAL,!0),ne=n.paint.get(ee?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),_e=te(.1,3,ne),fe=l._showOverdrawInspector;if(!fe){const Me=new Zt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),we=new ni([m.ONE,m.ONE,m.ONE,m.ONE],o.ao.transparent,[!1,!1,!1,!0],m.MIN);$o(W,l,t,n,c,K,Me,we,jt.disabled,ee,"sdf",P,D,O,V,j,_e,T,!1)}{const Me=fe?Zt.disabled:new Zt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),we=fe?l.colorModeForRenderPass():new ni([m.ONE_MINUS_DST_ALPHA,m.DST_ALPHA,m.ONE,m.ONE],o.ao.transparent,[!0,!0,!0,!0]);$o(W,l,t,n,c,K,Me,we,jt.disabled,ee,"color",P,D,O,V,j,_e,T,!1)}};if(x){const ee=(K,ne,_e)=>{const fe=l.depthModeForSublayer(1,wt.ReadOnly,m.LEQUAL,!1),Me=n.paint.get(K?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),we=te(.1,3,Me);{const ze=new ni([m.ONE,m.ONE,m.ONE,m.ONE],o.ao.transparent,[!1,!1,!1,!0]);$o(W,l,t,n,c,fe,Zt.disabled,ze,jt.disabled,K,"clear",P,D,O,V,j,we,T,ne)}{const ze=new Zt({func:m.ALWAYS,mask:255},255,255,m.KEEP,m.KEEP,m.REPLACE),Je=new ni([m.ONE,m.ONE,m.ONE,m.ONE],o.ao.transparent,[!1,!1,!1,!0],m.MIN);$o(W,l,t,n,c,fe,ze,Je,jt.disabled,K,"sdf",P,D,O,V,j,we,T,ne)}{const ze=K?m.ZERO:m.ONE_MINUS_DST_ALPHA,Je=new Zt({func:m.EQUAL,mask:255},255,255,m.KEEP,m.DECR,m.DECR),xe=new ni([ze,m.DST_ALPHA,m.ONE_MINUS_DST_ALPHA,m.ZERO],o.ao.transparent,[!0,!0,!0,!0]);$o(W,l,t,n,c,fe,Je,xe,jt.disabled,K,"color",P,D,O,V,j,we,T,ne)}{const ze=new ni([m.ONE,m.ONE,m.ONE,K?m.ZERO:m.ONE],o.ao.transparent,[!1,!1,!1,!0],K?m.FUNC_ADD:m.MAX);$o(W,l,t,n,c,fe,Zt.disabled,ze,jt.disabled,K,"clear",P,D,O,V,j,we,T,ne,_e)}};if(Z||H){let K;if(l.prepareDrawTile(),y){const ne=y.drapeBufferSize[0],_e=y.drapeBufferSize[1];K=y.framebufferCopyTexture,K&&(!K||K.size[0]===ne&&K.size[1]===_e)||(K&&K.destroy(),K=y.framebufferCopyTexture=new o.T(p,new o.q({width:ne,height:_e}),m.RGBA8)),K.bind(m.LINEAR,m.CLAMP_TO_EDGE),m.copyTexSubImage2D(m.TEXTURE_2D,0,0,0,0,0,ne,_e)}Z&&ee(!0,!1,K),H&&ee(!1,!0,K)}}else Z&&re(!0),H&&re(!1),(Z||H)&&l.resetStencilClippingMasks()}}},building:function(l,t,n,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);const d=n.paint.get("building-ambient-occlusion-ground-intensity"),p=n.paint.get("building-ambient-occlusion-ground-radius"),m=n.paint.get("building-ambient-occlusion-ground-attenuation"),y=n.paint.get("building-opacity");if(y<=0)return;let x=d>0&&p>0,T=!0;const S=n.paint.get("building-vertical-scale");if(S<=0)return;(!l.shadowRenderer||S<1)&&(T=!1);const M=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),E=l.style.order.indexOf(n.fqid);if((function(P,D,O,V,N,j){for(const Z of j){const H=D.getTile(Z).getBucket(O);H&&(N&&H.updateReplacement(Z,P.replacementSource,V),H.uploadUpdatedIndexBuffer(P.context))}})(l,t,n,E,M,c),(function(P,D,O,V){for(const N of V){const j=D.getTile(N).getBucket(O);j&&j.needsEvaluation()&&j.uploadUpdatedColorBuffer(P.context)}})(l,t,n,c),n.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){const P=l.shadowRenderer,D=[],O=P.getShadowPassDepthMode();gu({painter:l,source:t,layer:n,coords:c,defines:D,blendMode:P.getShadowPassColorMode(),depthMode:O,opacity:y,verticalScale:S,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(l.renderPass==="translucent"){let P=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];T&&(P=P.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer&&l.shadowRenderer.useNormalOffset&&(P=P.concat("NORMAL_OFFSET"));const D=n.paint.get("building-facade-emissive-chance"),O=n.paint.get("building-ambient-occlusion-intensity"),V=n.paint.get("building-flood-light-intensity"),N=n.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",j=n.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(N?null:n.lut).toArray01().slice(0,3),Z=n.paint.get("building-flood-light-ground-attenuation"),H=V>0,te=new wt(l.context.gl.LEQUAL,wt.ReadWrite,l.depthRangeFor3D);y<1&&gu({painter:l,source:t,layer:n,coords:c,defines:P,blendMode:ni.disabled,depthMode:te,opacity:y,verticalScale:S,facadeEmissiveChance:D,facadeAOIntensity:O,floodLightIntensity:V,floodLightColor:j,depthOnly:!0});const W=l.colorModeForRenderPass();gu({painter:l,source:t,layer:n,coords:c,defines:P,blendMode:W,depthMode:te,opacity:y,verticalScale:S,facadeEmissiveChance:D,facadeAOIntensity:O,floodLightIntensity:V,floodLightColor:j}),x&&yu(l,t,n,c,!0,y,d,p,V,j,m,M),H&&yu(l,t,n,c,!1,y,d,p,V,j,Z,M)}else if(l.renderPass==="light-beam"){const P=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],D=new wt(l.context.gl.LEQUAL,wt.ReadOnly,l.depthRangeFor3D);gu({painter:l,source:t,layer:n,coords:c,defines:P,blendMode:ni.alphaBlended,depthMode:D,opacity:y,verticalScale:S,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,n,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[m,y]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(const x of y){const T=t.getTile(x);if(T.needsHillshadePrepare&&l.renderPass==="offscreen")Im(l,T,n);else if(l.renderPass==="translucent"){const S=l.depthModeForSublayer(0,wt.ReadOnly),M=n.paint.get("hillshade-emissive-strength"),E=l.colorModeForDrapableLayerRenderPass(M),P=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(x):m[x.overscaledZ];Em(l,x,T,n,S,P,E)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,d,p){if(l.renderPass!=="translucent"||n.paint.get("raster-opacity")===0)return;const m=l.transform.projection.name==="globe",y=n.paint.get("raster-elevation")!==0,x=y&&m;if(l.renderElevatedRasterBackface&&!x)return;const T=l.context,S=T.gl,M=t.getSource(),E=(function(W,re,ee,K){const ne=re.paint.get("raster-color"),_e=W.type==="raster-array",fe=[],Me=re.paint.get("raster-resampling"),we=re.paint.get("raster-color-mix");let ze=re.paint.get("raster-color-range");const Je=[we[0],we[1],we[2],0],xe=we[3];let ce=Me==="nearest"?K.NEAREST:K.LINEAR;if(_e&&(fe.push("RASTER_ARRAY"),ne||fe.push("RASTER_COLOR"),Me==="linear"&&fe.push("RASTER_ARRAY_LINEAR"),ce=K.NEAREST,!ze&&W.rasterLayers)){const Le=W.rasterLayers.find((({id:Te})=>Te===re.sourceLayer));Le&&Le.fields&&Le.fields.range&&(ze=Le.fields.range)}if(ze=ze||[0,1],ne){fe.push("RASTER_COLOR"),ee.activeTexture.set(K.TEXTURE2),re.updateColorRamp(ze);let Le=re.colorRampTexture;Le||(Le=re.colorRampTexture=new o.T(ee,re.colorRamp,K.RGBA8)),Le.bind(K.LINEAR,K.CLAMP_TO_EDGE)}return{mix:Je,range:ze,offset:xe,defines:fe,resampling:ce}})(M,n,T,S);if(M instanceof o.aT&&!c.length&&!m)return;const P=n.paint.get("raster-emissive-strength"),D=l.colorModeForDrapableLayerRenderPass(P),O=l.terrain&&l.terrain.renderingToTexture,V=!l.options.moving,N=n.paint.get("raster-resampling")==="nearest"?S.NEAREST:S.LINEAR;if(M instanceof o.aT&&!c.length&&(M.onNorthPole||M.onSouthPole)){const W=y?l.stencilModeFor3D():Zt.disabled;return void Wh(!!M.onNorthPole,null,l,t,n,P,E,jt.disabled,W)}if(!c.length)return;const[j,Z]=M instanceof o.aT||O?[{},c]:l.stencilConfigForOverlap(c),H=Z[Z.length-1].overscaledZ;x&&E.defines.push("PROJECTION_GLOBE_VIEW"),y&&E.defines.push("RENDER_CUTOFF");const te=(W,re,ee)=>{for(const K of W){const ne=K.toUnwrapped(),_e=t.getTile(K);if(O&&(!_e||!_e.hasData()))continue;T.activeTexture.set(S.TEXTURE0);const fe=Vm(_e,M,n,E);if(!fe||!fe.texture)continue;const{texture:Me,mix:we,offset:ze,tileSize:Je,buffer:xe}=fe;let ce,Le;O?(ce=wt.disabled,Le=K.projMatrix):y?(ce=new wt(S.LEQUAL,wt.ReadWrite,l.depthRangeFor3D),Le=m?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(ne,V)):(ce=l.depthModeForSublayer(K.overscaledZ-H,n.paint.get("raster-opacity")===1?wt.ReadWrite:wt.ReadOnly,S.LESS),Le=l.transform.calculateProjMatrix(ne,V));const Te=l.terrain&&O?l.terrain.stencilModeForRTTOverlap(K):j[K.overscaledZ],je=p?0:n.paint.get("raster-fade-duration");_e.registerFadeDuration(je);const rt=t.findLoadedParent(K,0),gt=tu(_e,rt,t,l.transform,je);let Xe,et;!gt.isFading&&_e.refreshedUponExpiration&&(_e.refreshedUponExpiration=!1),l.terrain&&l.terrain.prepareDrawTile(),T.activeTexture.set(S.TEXTURE0),Me.bind(N,S.CLAMP_TO_EDGE),T.activeTexture.set(S.TEXTURE1),rt?(rt.texture&&rt.texture.bind(N,S.CLAMP_TO_EDGE),Xe=Math.pow(2,rt.tileID.overscaledZ-_e.tileID.overscaledZ),et=[_e.tileID.canonical.x*Xe%1,_e.tileID.canonical.y*Xe%1]):Me.bind(N,S.CLAMP_TO_EDGE),"useMipmap"in Me&&T.extTextureFilterAnisotropic&&l.transform.pitch>20&&S.texParameterf(S.TEXTURE_2D,T.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,T.extTextureFilterAnisotropicMax);const xt=l.transform;let dt;const ut=y?Zf(xt):[0,0,0,0];let ft,zt,pi,vi,tr,Gt=0;if(x&&M instanceof o.aT&&M.coordinates.length>3)ft=Float32Array.from(o.bj(o.dI(new o.cC(0,0,0)))),zt=Float32Array.from(xt.globeMatrix),pi=Float32Array.from(o.dE(xt)),vi=[o.aF(xt.center.lng),o.aJ(xt.center.lat)],dt=M.elevatedGlobePerspectiveTransform,tr=M.elevatedGlobeGridMatrix||new Float32Array(9);else if(x){const bi=o.dF(K.canonical);Gt=o.dG(bi.getCenter().lat),ft=Float32Array.from(o.bj(o.dI(K.canonical))),zt=Float32Array.from(xt.globeMatrix),pi=Float32Array.from(o.dE(xt)),vi=[o.aF(xt.center.lng),o.aJ(xt.center.lat)],dt=[0,0],tr=Float32Array.from(o.dH(K.canonical,bi,Gt,xt.worldSize/xt._pixelsPerMercatorPixel))}else dt=M instanceof o.aT?M.perspectiveTransform:[0,0],ft=new Float32Array(16),zt=new Float32Array(9),pi=new Float32Array(16),vi=[0,0],tr=new Float32Array(9);const xi=fc(Le,ft,zt,pi,tr,et||[0,0],o.aj(l.transform.zoom),vi,ut,Xe||1,gt,n,dt,y?n.paint.get("raster-elevation"):0,2,we,ze,E.range,Je,xe,P),ti=l.isTileAffectedByFog(K),Zi=l.getOrCreateProgram("raster",{defines:E.defines,overrideFog:ti});if(l.uploadCommonUniforms(T,Zi,ne),M instanceof o.aT){const bi=M.elevatedGlobeVertexBuffer,cr=M.elevatedGlobeIndexBuffer;if(O||!m)M.boundsBuffer&&M.boundsSegments&&Zi.draw(l,S.TRIANGLES,ce,Zt.disabled,D,jt.disabled,xi,n.id,M.boundsBuffer,l.quadTriangleIndexBuffer,M.boundsSegments);else if(bi&&cr){const Pi=xt.zoom<=o.cZ?M.elevatedGlobeSegments:M.getSegmentsForLongitude(xt.center.lng);Pi&&Zi.draw(l,S.TRIANGLES,ce,Zt.disabled,D,re,xi,n.id,bi,cr,Pi)}}else if(x){ce=new wt(S.LEQUAL,wt.ReadOnly,l.depthRangeFor3D);const bi=l.globeSharedBuffers;if(bi){const[cr,Pi,ii]=bi.getGridBuffers(Gt,!1);Zi.draw(l,S.TRIANGLES,ce,ee||Te,l.colorModeForRenderPass(),re,xi,n.id,cr,Pi,ii)}}else{const{tileBoundsBuffer:bi,tileBoundsIndexBuffer:cr,tileBoundsSegments:Pi}=l.getTileBoundsBuffers(_e);Zi.draw(l,S.TRIANGLES,ce,Te,D,jt.disabled,xi,n.id,bi,cr,Pi)}}if(!(M instanceof o.aT)&&x)for(const K of W){const ne=K.canonical.y===(1<<K.canonical.z)-1;K.canonical.y===0&&Wh(!0,K,l,t,n,P,E,re,ee||Zt.disabled),ne&&Wh(!1,K,l,t,n,P,E,re===jt.frontCW?jt.backCW:jt.frontCW,ee||Zt.disabled)}};x?te(Z,l.renderElevatedRasterBackface?jt.backCW:jt.frontCW,l.stencilModeFor3D()):te(Z,jt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,d,p){l.renderPass==="offscreen"&&(function(m,y,x,T){if(!T.length)return;const S=m.context,M=S.gl,E=y.getSource();if(!(E instanceof pn))return;const P=Math.ceil(Math.sqrt(x.paint.get("raster-particle-count")));let D=x.particlePositionRGBAImage;if(!D||D.width!==P){const Z=(function(H){const te=H*H,W=new Uint8Array(4*te),re=function(K){return K|=0,K=Math.imul(2747636419^K,2654435769),K=Math.imul(K^K>>>16,2654435769),((K=Math.imul(K^K>>>16,2654435769))>>>0)/4294967296},ee=1/1.1;for(let K=0;K<te;K++){const ne=ee*(re(2*K+0)+za),_e=ee*(re(2*K+1)+za),fe=255*ne%1,Me=255*_e%1,we=fe,ze=_e-Me/255,Je=Me;W[4*K+0]=255*(ne-fe/255),W[4*K+1]=255*we,W[4*K+2]=255*ze,W[4*K+3]=255*Je}return W})(P);D=x.particlePositionRGBAImage=new o.q({width:P,height:P},Z)}let O=x.particleFramebuffer;O?O.width!==P&&(O.destroy(),O=x.particleFramebuffer=S.createFramebuffer(P,P,!0,null)):O=x.particleFramebuffer=S.createFramebuffer(P,P,!0,null);const V=[];for(const Z of T){const H=y.getTile(Z);if(!(H instanceof Ms))continue;const te=Xh(H,E,x);if(!te)continue;const W=[H.tileSize,H.tileSize];let re=x.tileFramebuffer;re||(re=x.tileFramebuffer=S.createFramebuffer(W[0],W[1],!0,null));let ee=H.rasterParticleState;ee||(ee=H.rasterParticleState=new Ns(S,Z,W,D));const K=ee.update(x.lastInvalidatedAt);ee.particleTextureDimension!==P&&ee.updateParticleTexture(Z,D);const ne=ee.targetColorTexture;ee.targetColorTexture=ee.backgroundColorTexture,ee.backgroundColorTexture=ne;const _e=ee.particleTexture0;ee.particleTexture0=ee.particleTexture1,ee.particleTexture1=_e,V.push([Z,te,ee,K])}if(V.length===0)return;const N=o.o.now(),j=x.previousDrawTimestamp?.001*(N-x.previousDrawTimestamp):.0167;if(x.previousDrawTimestamp=N,x.hasColorMap()){S.activeTexture.set(M.TEXTURE0+2);let Z=x.colorRampTexture;Z||(Z=x.colorRampTexture=new o.T(S,x.colorRamp,M.RGBA8)),Z.bind(M.LINEAR,M.CLAMP_TO_EDGE)}S.bindFramebuffer.set(x.tileFramebuffer.framebuffer),(function(Z,H,te){const W=Z.context,re=W.gl,ee=H.tileFramebuffer;W.activeTexture.set(re.TEXTURE0);const K={u_texture:0,u_opacity:1.05*(_e=H.paint.get("raster-particle-fade-opacity-factor"))/(_e+.05)},ne=Z.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var _e;for(const fe of te){const[,,Me,we]=fe;ee.colorAttachment.set(Me.targetColorTexture.texture),W.viewport.set([0,0,ee.width,ee.height]),W.clear({color:o.ao.transparent}),we&&(Me.backgroundColorTexture.bind(re.NEAREST,re.CLAMP_TO_EDGE),ne.draw(Z,re.TRIANGLES,wt.disabled,Zt.disabled,ni.alphaBlended,jt.disabled,K,H.id,Z.viewportBuffer,Z.quadTriangleIndexBuffer,Z.viewportSegments))}})(m,x,V),(function(Z,H,te,W){const re=Z.context,ee=re.gl,K=te.tileFramebuffer,ne=Z.transform.projection.name==="globe",_e=te.paint.get("raster-particle-max-speed");for(const fe of W){const[Me,we,ze]=fe;re.activeTexture.set(ee.TEXTURE0+0),we.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),K.colorAttachment.set(ze.targetColorTexture.texture);const Je=Z.getOrCreateProgram("rasterParticleDraw",{defines:we.defines,overrideFog:!1});re.activeTexture.set(ee.TEXTURE0+1);const xe=we.scalarData?[]:[0,1,2,3].map((Te=>o.e8[Te](Me)));xe.push(Me);const ce=Me.canonical.x,Le=Me.canonical.y;for(const Te of xe){const je=H.getTile(ne?Te.wrapped():Te);if(!je)continue;const rt=je.rasterParticleState;if(!rt)continue;const gt=Te.canonical.x+(1<<Te.canonical.z)*(Te.wrap-Me.wrap),Xe=Te.canonical.y;rt.particleTexture0.bind(ee.NEAREST,ee.CLAMP_TO_EDGE);const et=Vh(1,rt.particleTexture0.size[0],[gt-ce,Xe-Le],0,we.texture.size,2,_e,we.textureOffset,we.scale,we.offset);Je.draw(Z,ee.POINTS,wt.disabled,Zt.disabled,ni.alphaBlended,jt.disabled,et,te.id,rt.particleIndexBuffer,void 0,rt.particleSegment)}}})(m,y,x,V),S.bindFramebuffer.set(x.particleFramebuffer.framebuffer),(function(Z,H,te,W){const re=Z.context,ee=re.gl,K=H.paint.get("raster-particle-max-speed"),ne=W*H.paint.get("raster-particle-speed-factor")*.15,_e=(function(Me){return Math.pow(Me,6)})(.01+1*H.paint.get("raster-particle-reset-rate-factor")),fe=H.particleFramebuffer;re.viewport.set([0,0,fe.width,fe.height]);for(const Me of te){const[,we,ze]=Me;re.activeTexture.set(ee.TEXTURE0+0),we.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),re.activeTexture.set(ee.TEXTURE0+1);const Je=ze.particleTexture0;Je.bind(ee.NEAREST,ee.CLAMP_TO_EDGE);const xe=lu(1,Je.size[0],0,we.texture.size,K,ne,_e,we.textureOffset,we.scale,we.offset);fe.colorAttachment.set(ze.particleTexture1.texture),re.clear({color:o.ao.transparent}),Z.getOrCreateProgram("rasterParticleUpdate",{defines:we.defines}).draw(Z,ee.TRIANGLES,wt.disabled,Zt.disabled,ni.unblended,jt.disabled,xe,H.id,Z.viewportBuffer,Z.quadTriangleIndexBuffer,Z.viewportSegments)}})(m,x,V,j)})(l,t,n,c),l.renderPass==="translucent"&&((function(m,y,x,T,S){const M=m.context,E=M.gl,P=y.getSource().tileSize,D=5*(1-o.ah(o.cK,o.cK+1,m.transform.zoom))*P+x.paint.get("raster-particle-elevation"),O=!m.options.moving,V=m.transform.projection.name==="globe";if(!T.length)return;const[N,j]=m.stencilConfigForOverlap(T),Z=[];V&&Z.push("PROJECTION_GLOBE_VIEW");const H=m.stencilModeFor3D();for(const te of j){const W=te.toUnwrapped(),re=y.getTile(te);if(!re.rasterParticleState)continue;const ee=re.rasterParticleState,K=100;re.registerFadeDuration(K);const ne=y.findLoadedParent(te,0),_e=tu(re,ne,y,m.transform,K);let fe,Me;m.terrain&&m.terrain.prepareDrawTile(),M.activeTexture.set(E.TEXTURE0),ee.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),M.activeTexture.set(E.TEXTURE1),ne&&ne.rasterParticleState?(ne.rasterParticleState.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),fe=Math.pow(2,ne.tileID.overscaledZ-re.tileID.overscaledZ),Me=[re.tileID.canonical.x*fe%1,re.tileID.canonical.y*fe%1]):ee.targetColorTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE);const we=V?Float32Array.from(m.transform.expandedFarZProjMatrix):m.transform.calculateProjMatrix(W,O),ze=m.transform,Je=bs(ze),xe=o.dF(te.canonical),ce=o.dG(xe.getCenter().lat);let Le,Te,je,rt,gt;V?(Le=Float32Array.from(o.bj(o.dI(te.canonical))),Te=Float32Array.from(ze.globeMatrix),je=Float32Array.from(o.dE(ze)),rt=[o.aF(ze.center.lng),o.aJ(ze.center.lat)],gt=Float32Array.from(o.dH(te.canonical,xe,ce,ze.worldSize/ze._pixelsPerMercatorPixel))):(Le=new Float32Array(16),Te=new Float32Array(9),je=new Float32Array(16),rt=[0,0],gt=new Float32Array(9));const Xe=aa(we,Le,Te,je,gt,Me||[0,0],o.aj(m.transform.zoom),rt,Je,fe||1,_e,D),et=m.isTileAffectedByFog(te),xt=m.getOrCreateProgram("rasterParticle",{defines:Z,overrideFog:et});if(m.uploadCommonUniforms(M,xt,W),V){const dt=new wt(E.LEQUAL,wt.ReadOnly,m.depthRangeFor3D),ut=0,ft=m.globeSharedBuffers;if(ft){const[zt,pi,vi]=ft.getGridBuffers(ce,ut!==0);xt.draw(m,E.TRIANGLES,dt,H,ni.alphaBlended,m.renderElevatedRasterBackface?jt.frontCCW:jt.backCCW,Xe,x.id,zt,pi,vi)}}else{const dt=m.depthModeForSublayer(0,wt.ReadOnly),ut=N[te.overscaledZ],{tileBoundsBuffer:ft,tileBoundsIndexBuffer:zt,tileBoundsSegments:pi}=m.getTileBoundsBuffers(re);xt.draw(m,E.TRIANGLES,dt,ut,ni.alphaBlended,jt.disabled,Xe,x.id,ft,zt,pi)}}m.resetStencilClippingMasks()})(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const d=n.paint.get("background-color"),p=n.paint.get("background-color-use-theme").constantOr("default")==="none",m=n.paint.get("background-opacity"),y=n.paint.get("background-emissive-strength"),x=n.paint.get("background-pitch-alignment")==="viewport";if(m===0)return;const T=l.context,S=T.gl,M=l.transform,E=M.tileSize,P=n.paint.get("background-pattern");let D;if(P!==void 0&&(P===null||(D=l.imageManager.getPattern(o.I.from(P.toString()),n.scope,l.style.getLut(n.scope)),!D)))return;const O=!P&&d.a===1&&m===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==O)return;const V=Zt.disabled,N=l.depthModeForSublayer(0,O==="opaque"?wt.ReadWrite:wt.ReadOnly),j=l.colorModeForDrapableLayerRenderPass(y),Z=P?"backgroundPattern":"background";let H,te=c;if(te||(H=l.getBackgroundTiles(),te=Object.values(H).map((W=>W.tileID))),P&&(T.activeTexture.set(S.TEXTURE0),l.imageManager.bind(l.context,n.scope)),x){const W=l.getOrCreateProgram(Z,{overrideFog:!1,overrideRtt:!0}),re=new Float32Array(o.bz([])),ee=new o.aP(0,0,0,0,0),K=P?uu(re,y,m,l,0,n.scope,D,x,{tileID:ee,tileSize:E}):cu(re,y,m,d.toPremultipliedRenderColor(p?null:n.lut));W.draw(l,S.TRIANGLES,N,V,j,jt.disabled,K,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const W of te){const re=l.isTileAffectedByFog(W),ee=l.getOrCreateProgram(Z,{overrideFog:re}),K=W.toUnwrapped(),ne=c?W.projMatrix:l.transform.calculateProjMatrix(K);l.prepareDrawTile();const _e=t?t.getTile(W):H?H[W.key]:new qs(W,E,M.zoom,l),fe=P?uu(ne,y,m,l,0,n.scope,D,x,{tileID:W,tileSize:E}):cu(ne,y,m,d.toPremultipliedRenderColor(p?null:n.lut));l.uploadCommonUniforms(T,ee,K);const{tileBoundsBuffer:Me,tileBoundsIndexBuffer:we,tileBoundsSegments:ze}=l.getTileBoundsBuffers(_e);ee.draw(l,S.TRIANGLES,N,V,j,jt.disabled,fe,n.id,Me,we,ze)}},sky:function(l,t,n){const c=l._atmosphere?o.aj(l.transform.zoom):1,d=n.paint.get("sky-opacity")*c;if(d===0)return;const p=l.context,m=n.paint.get("sky-type"),y=new wt(p.gl.LEQUAL,wt.ReadOnly,[0,1]),x=l.frameCounter/1e3%1;m==="atmosphere"?l.renderPass==="offscreen"?n.needsSkyboxCapture(l)&&((function(T,S,M,E){const P=T.context,D=P.gl;let O=S.skyboxFbo;if(!O){O=S.skyboxFbo=P.createFramebuffer(32,32,!0,null),S.skyboxGeometry=new ed(P),S.skyboxTexture=P.gl.createTexture(),D.bindTexture(D.TEXTURE_CUBE_MAP,S.skyboxTexture),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_CUBE_MAP,D.TEXTURE_MAG_FILTER,D.LINEAR);for(let Z=0;Z<6;++Z)D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+Z,0,D.RGBA,32,32,0,D.RGBA,D.UNSIGNED_BYTE,null)}P.bindFramebuffer.set(O.framebuffer),P.viewport.set([0,0,32,32]);const V=S.getCenter(T,!0),N=T.getOrCreateProgram("skyboxCapture"),j=new Float64Array(16);o.bz(j),o.em(j,j,.5*-Math.PI),yo(T,S,N,j,V,0),o.bz(j),o.em(j,j,.5*Math.PI),yo(T,S,N,j,V,1),o.bz(j),o.cT(j,j,.5*-Math.PI),yo(T,S,N,j,V,2),o.bz(j),o.cT(j,j,.5*Math.PI),yo(T,S,N,j,V,3),o.bz(j),yo(T,S,N,j,V,4),o.bz(j),o.em(j,j,Math.PI),yo(T,S,N,j,V,5),P.viewport.set([0,0,T.width,T.height])})(l,n),n.markSkyboxValid(l)):l.renderPass==="sky"&&(function(T,S,M,E,P){const D=T.context,O=D.gl,V=T.transform,N=T.getOrCreateProgram("skybox");D.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_CUBE_MAP,S.skyboxTexture);const j=((Z,H,te,W,re)=>({u_matrix:Z,u_sun_direction:H,u_cubemap:0,u_opacity:W,u_temporal_offset:re}))(V.skyboxMatrix,S.getCenter(T,!1),0,E,P);T.uploadCommonUniforms(D,N),N.draw(T,O.TRIANGLES,M,Zt.disabled,T.colorModeForRenderPass(),jt.backCW,j,"skybox",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)})(l,n,y,d,x):m==="gradient"&&l.renderPass==="sky"&&(function(T,S,M,E,P){const D=T.context,O=D.gl,V=T.transform,N=T.getOrCreateProgram("skyboxGradient");S.skyboxGeometry||(S.skyboxGeometry=new ed(D)),D.activeTexture.set(O.TEXTURE0);let j=S.colorRampTexture;j||(j=S.colorRampTexture=new o.T(D,S.colorRamp,O.RGBA8)),j.bind(O.LINEAR,O.CLAMP_TO_EDGE);const Z=((H,te,W,re,ee)=>({u_matrix:H,u_color_ramp:0,u_center_direction:te,u_radius:o.an(W),u_opacity:re,u_temporal_offset:ee}))(V.skyboxMatrix,S.getCenter(T,!1),S.paint.get("sky-gradient-radius"),E,P);T.uploadCommonUniforms(D,N),N.draw(T,O.TRIANGLES,M,Zt.disabled,T.colorModeForRenderPass(),jt.backCW,Z,"skyboxGradient",S.skyboxGeometry.vertexBuffer,S.skyboxGeometry.indexBuffer,S.skyboxGeometry.segment)})(l,n,y,d,x)},custom:function(l,t,n,c){const d=l.context,p=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&n.isDraped(t)){if(l.renderPass==="offscreen"){const m=p.prerender;if(m){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;m.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.aj(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else m.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const y=p.renderToTile;if(y){const x=c[0].canonical,T={x:x.x+c[0].wrap*(p.wrapTileId?0:1<<x.z),y:x.y,z:x.z};d.setDepthMode(wt.disabled),d.setStencilMode(Zt.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),y.call(p,d.gl,T),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Zt.disabled);const m=p.renderingMode==="3d"?new wt(l.context.gl.LEQUAL,wt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,wt.ReadOnly);if(d.setDepthMode(m),l.transform.projection.name==="globe"){const y=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.aj(l.transform.zoom),[y.x,y.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if(l.renderPass==="opaque")return;const d=n.paint.get("model-opacity").constantOr(1),p=n.paint.get("model-elevation-reference"),m=p==="ground",y=p==="ground";if(d===0)return;const x=n.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!x||l.terrain&&d<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof o.ad))return;const T=l.shadowRenderer,S=n.paint.get("model-receive-shadows");T&&(T.useNormalOffset=!0,S||(T.enabled=!1));const M=()=>{T&&(T.useNormalOffset=!0,S||(T.enabled=!0))},E=t.getSource();if(l.renderPass==="light-beam"&&E.type!=="batched-model")return;if(E.type==="vector"||E.type==="geojson")return(function(H,te,W,re,ee){const K=H.transform,ne=K.projection.name==="globe",_e=K.getFreeCameraOptions().position;if(!H.modelManager)return;const fe=H.modelManager;W.modelManager=fe;const Me=H.shadowRenderer;if(!W._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const we=W._unevaluatedLayout._values["model-id"],ze=Object.assign({},W.layout.get("model-id").parameters),Je=H.style.order.indexOf(W.fqid);for(const xe of re){const ce=te.getTile(xe).getBucket(W);if(!ce||ce.projection.name!==K.projection.name)continue;const Le=ce.getModelUris();if(Le&&!ce.modelsRequested&&(fe.addModelsFromBucket(Le,ee),ce.modelsRequested=!0),ne)ze.zoom=xe.overscaledZ;else{const dt=id(xe,K);ze.zoom=dt}const Te=we.possiblyEvaluate(ze);if(Jf(H,ce,xe),Xs.shadowUniformsInitialized=!1,Xs.useSingleShadowCascade=!!Me&&Me.getMaxCascadeForTile(xe.toUnwrapped())===0,H.renderPass==="shadow"&&Me){if(H.currentShadowCascade===1&&ce.isInsideFirstShadowMapFrustum)continue;const dt=K.calculatePosMatrix(xe.toUnwrapped(),K.worldSize);if(Xs.tileMatrix.set(dt),Xs.shadowTileMatrix=Float32Array.from(Me.calculateShadowPassMatrixFromMatrix(dt)),Xs.aabb.min=[0,0,0],Xs.aabb.max[0]=Xs.aabb.max[1]=o.al,Xs.aabb.max[2]=0,bu(ce,Xs,H,W.scope))continue}const je=1<<xe.canonical.z,rt=[((_e.x-xe.wrap)*je-xe.canonical.x)*o.al,(_e.y*je-xe.canonical.y)*o.al,_e.z*je*o.al];H.conflationActive&&Object.keys(ce.instancesPerModel).length>0&&H.style.isLayerClipped(W,te.getSource())&&ce.updateReplacement(xe,H.replacementSource,Je,ee)&&(ce.uploaded=!1,ce.upload(H.context));let gt=0;const Xe=new Array,et=new Array,xt=new Array;for(let dt in ce.instancesPerModel){const ut=ce.instancesPerModel[dt];ut.features.length>0&&!ne&&(dt=Te.evaluate(ut.features[0].feature,{}));const ft=fe.getModel(dt,ee);if(ft||fe.hasURLBeenRequested(dt)||ce.modelUris.includes(dt)||(ce.modelUris.push(dt),ce.modelsRequested=!1),ft&&ft.uploaded)if(ne){const zt=o.c4([],[_e.x,_e.y,_e.z],H.transform.worldSize);o.ev(zt,zt);for(let pi=0;pi<ut.instancedDataArray.length;++pi){const vi=[0,0,0],tr=[1,1,1],Gt=o.ew(),xi=ut.tileCoordinatesForInstance(pi),ti=ut.transformForInstance(pi);o.ex(tr,ti),o.ey(Gt,ti),o.ez(vi,Gt);const Zi=ut.translationForInstance(pi),bi=new o.aS(0,0);o.eA(ce.canonical,bi,xi.x,xi.y);const cr=o.bB();o.eB(cr,ft,H.transform,bi,vi,tr,Zi,!0,!1,!1);const Pi=ut.colorForInstance(pi),ii=o.bz([]),Ni=o.ee(bi.lat,H.transform.zoom),si=o.bp([],[1,1,1/Ni]);o.bq(ii,ii,zt),xt.push({zScaleMatrix:si,negCameraPosMatrix:ii});for(const br of ft.nodes)vu(H,br,cr,H.transform.expandedFarZProjMatrix,gt,Xe,et,ft.materialOverrides,Pi);++gt}}else for(const zt of ft.nodes)rd(H,W,zt,ut,rt,xe,Xs)}if(ne)if(H.renderPass==="shadow"){for(const dt of et)yl(dt.mesh,dt.nodeModelMatrix,H,W);for(const dt of Xe)yl(dt.mesh,dt.nodeModelMatrix,H,W)}else Kf(H,W,1,Xe,et,xt)}})(l,t,n,c,xu(E,n,l.style._importedAsBasemap)),void M();if(!E.loaded())return;if(E.type==="batched-model")return(function(H,te,W,re){W.resetLayerRenderingStats(H);const ee=H.context,K=H.transform,ne=H.style.fog,_e=H.shadowRenderer;if(K.projection.name!=="mercator")return void o.w("Drawing 3D landmark models for ".concat(K.projection.name," projection is not yet implemented"));const fe=H.transform.getFreeCameraOptions().position,Me=o.c4([],[fe.x,fe.y,fe.z],H.transform.worldSize),we=o.ev([],Me),ze=o.bz([]),Je=o.ee(K.center.lat,K.zoom),xe=o.bp([],[1,1,1/Je]);o.bq(ze,ze,we);const ce=W.paint.get("model-opacity").constantOr(1),Le=new wt(ee.gl.LEQUAL,wt.ReadWrite,H.depthRangeFor3D),Te=new wt(ee.gl.LEQUAL,wt.ReadOnly,H.depthRangeFor3D),je=new o.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),rt=H.renderPass==="shadow",gt=rt&&_e?_e.getCurrentCascadeFrustum():K.getFrustum(K.scaleZoom(K.worldSize)),Xe=W.paint.get("model-front-cutoff"),et=Xe[2]<1,xt=Ho(H,W.paint.get("model-cutoff-fade-range")),dt=W.getLayerRenderingStats();(function(ut,ft,zt,pi){const vi=ut.terrain?ut.terrain.exaggeration():0,tr=ut.transform.zoom;for(const Gt of pi){const xi=ft.getTile(Gt).getBucket(zt);xi&&(xi.setFilter(zt.filter),ut.conflationActive&&xi.updateReplacement(Gt,ut.replacementSource),xi.evaluateTransform(ut,zt),ut.terrain&&vi>0&&xi.elevationUpdate(ut.terrain,vi,Gt,zt.source),xi.needsReEvaluation(ut,tr,zt)&&xi.evaluate(zt))}})(H,te,W,re),(function(){let ut,ft,zt;et?(ut=re.length-1,ft=-1,zt=-1):(ut=0,ft=re.length,zt=1);const pi=new Float64Array(16),vi=o.cz(),tr=new o.P(0,0);for(let Gt=ut;Gt!==ft;Gt+=zt){const xi=re[Gt],ti=te.getTile(xi).getBucket(W);if(!ti||!ti.uploaded)continue;let Zi=!1;_e&&(Zi=_e.getMaxCascadeForTile(xi.toUnwrapped())===0);const bi=K.calculatePosMatrix(xi.toUnwrapped(),K.worldSize),cr=ti.modelTraits;!rt&&et&&(o.bk(pi,bi),o.af(vi,Me,pi),tr.x=vi[0],tr.y=vi[1]);const Pi=[];ti.setFilter(W.filter);for(const ii of ti.getNodesInfo()){if(ii.hiddenByReplacement||!ii.node.meshes)continue;const Ni=ii.node;let si=0;H.terrain&&Ni.elevation&&(si=Ni.elevation*H.terrain.exaggeration());const br=(()=>{const cs=ii.aabb;return je.min=[...cs.min],je.max=[...cs.max],je.min[2]+=si,je.max[2]+=si,o.af(je.min,je.min,bi),o.af(je.max,je.max,bi),je})(),Ui=ii.evaluatedScale;if(Ui[0]<=1&&Ui[1]<=1&&Ui[2]<=1&&br.intersects(gt)===0)continue;if(!rt&&et){const cs=.16666666666666666;ii.cameraCollisionOpacity=Me[0]>br.min[0]&&Me[0]<br.max[0]&&Me[1]>br.min[1]&&Me[1]<br.max[1]&&Me[2]*Je<br.max[2]&&Ni.footprint&&o.b$(tr,Ni.footprint)?Math.max(ii.cameraCollisionOpacity-cs,0):Math.min(1,ii.cameraCollisionOpacity+cs)}const qt=[...bi],Ti=1/o.d6(xi.canonical),Or=Ni.anchor?Ni.anchor[0]:0,tn=Ni.anchor?Ni.anchor[1]:0;o.bq(qt,qt,[Or*(Ui[0]-1)+ii.evaluatedTranslation[0]*Ti,tn*(Ui[1]-1)+ii.evaluatedTranslation[1]*Ti,si+ii.evaluatedTranslation[2]]),o.cp(Ui,o.eD)||o.cR(qt,qt,Ui);const Ur=o.aB([],qt,Ni.globalMatrix),Zr=o.aB([],K.expandedFarZProjMatrix,Ur),Ds=o.aB([],K.expandedFarZProjMatrix,qt),ws=o.aC([],[Or,tn,si,1],Zr)[2];Ni.hidden=!1;let ts=ce;rt||(et&&(ts*=ii.cameraCollisionOpacity,ts*=ka(qt,K,ii.aabb,Xe)),ts*=gc(xt,ws)),ts!==0?Pi.push({nodeInfo:ii,depth:ws,opacity:ts,wvpForNode:Zr,wvpForTile:Ds,nodeModelMatrix:Ur,tileModelMatrix:qt}):Ni.hidden=!0}rt||Pi.sort(((ii,Ni)=>!et||ii.opacity===1&&Ni.opacity===1?ii.depth<Ni.depth?-1:1:ii.opacity===1?-1:Ni.opacity===1?1:ii.depth>Ni.depth?-1:1));for(const ii of Pi){const Ni=ii.nodeInfo,si=Ni.node;let br=o.aB([],xe,ii.tileModelMatrix);o.aB(br,ze,br);const Ui=o.bk([],br);o.ef(Ui,Ui),o.cR(Ui,Ui,Qf),br=o.aB(br,br,si.globalMatrix);const qt=H.renderPass==="light-beam",Ti=W.paint.get("model-color-use-theme").constantOr("default")==="none",Or=cr&o.eH.HasMapboxMeshFeatures,tn=Or?0:Ni.evaluatedRMEA[0][2];for(let Ur=0;Ur<si.meshes.length;++Ur){const Zr=si.meshes[Ur],Ds=Ur===si.lightMeshIndex;let ws=ii.wvpForNode;if(Ds){if(!qt&&!H.terrain&&H.shadowRenderer){H.currentLayer<H.firstLightBeamLayer&&(H.firstLightBeamLayer=H.currentLayer);continue}ws=ii.wvpForTile}else if(qt)continue;const ts={defines:[]},cs=[];if(!rt&&_e&&(_e.useNormalOffset=!!Zr.normalBuffer),_l(ts.defines,cs,Zr,H,Ti?null:W.lut),Or||ts.defines.push("DIFFUSE_SHADED"),Zi&&ts.defines.push("SHADOWS_SINGLE_CASCADE"),dt&&(rt?dt.numRenderedVerticesInShadowPass+=Zr.vertexArray.length:dt.numRenderedVerticesInTransparentPass+=Zr.vertexArray.length),rt){yl(Zr,ii.nodeModelMatrix,H,W);continue}let Ks=null;if(ne){const rn=td(ii.nodeModelMatrix,H.transform);if(Ks=new Float32Array(rn),K.projection.name!=="globe"){const or=Zr.aabb.min,an=Zr.aabb.max,[Bn,Hr]=ne.getOpacityForBounds(rn,or[0],or[1],an[0],an[1]);ts.overrideFog=Bn>=be||Hr>=be}}const is=Zr.material;let Js;is.occlusionTexture&&is.occlusionTexture.offsetScale&&(Js=is.occlusionTexture.offsetScale,ts.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const bo=H.getOrCreateProgram("model",ts);!rt&&_e&&_e.setupShadowsFromMatrix(ii.tileModelMatrix,bo,_e.useNormalOffset),H.uploadCommonUniforms(ee,bo,null,Ks);const Fn=is.pbrMetallicRoughness;Fn.metallicFactor=.9,Fn.roughnessFactor=.5;const Gr=hu(new Float32Array(ws),new Float32Array(br),new Float32Array(Ui),new Float32Array(si.globalMatrix),H,ii.opacity,Fn.baseColorFactor,is.emissiveFactor,Fn.metallicFactor,Fn.roughnessFactor,is,tn,W,[0,0,0],Js);!Ds&&(Ni.hasTranslucentParts||ii.opacity<1)&&bo.draw(H,ee.gl.TRIANGLES,Le,Zt.disabled,ni.disabled,jt.backCCW,Gr,W.id,Zr.vertexBuffer,Zr.indexBuffer,Zr.segments,W.paint,H.transform.zoom,void 0,cs),bo.draw(H,ee.gl.TRIANGLES,Ds?Te:Le,Zt.disabled,Ds||ii.opacity<1||Ni.hasTranslucentParts?ni.alphaBlended:ni.unblended,jt.backCCW,Gr,W.id,Zr.vertexBuffer,Zr.indexBuffer,Zr.segments,W.paint,H.transform.zoom,void 0,cs)}}}})()})(l,t,n,c),void M();if(E.type!=="model")return;const P=E.getModels(),D=[],O=l.transform.getFreeCameraOptions().position,V=o.c4([],[O.x,O.y,O.z],l.transform.worldSize);o.ev(V,V);const N=[],j=[];let Z=0;for(const H of P){const te=t.getFeatureState("",H.id),W={type:"Unknown",id:H.id,properties:H.featureProperties},re=n.paint.get("model-rotation").evaluate(W,te),ee=n.paint.get("model-scale").evaluate(W,te),K=n.paint.get("model-translation").evaluate(W,te);xl(n,H.id,te,H.featureProperties,H.nodeOverrideNames,H.nodeOverrides),jm(n,H.id,te,H.featureProperties,H.materialOverrideNames,H.materialOverrides),H.nodeOverrides.size>0&&H.computeBoundsAndApplyParent(),H.computeModelMatrix(l,re,ee,K,y,m,!1);const ne=o.bz([]),_e=o.ee(H.position.lat,l.transform.zoom),fe=o.bp([],[1,1,1/_e]);o.bq(ne,ne,V),D.push({zScaleMatrix:fe,negCameraPosMatrix:ne});for(const Me of H.nodes)vu(l,Me,H.matrix,l.transform.expandedFarZProjMatrix,Z,N,j,H.materialOverrides);Z++}if(N.sort(((H,te)=>te.depth-H.depth)),l.renderPass!=="shadow")Kf(l,n,d,N,j,D),M();else{for(const H of j)yl(H.mesh,H.nodeModelMatrix,l,n);for(const H of N)yl(H.mesh,H.nodeModelMatrix,l,n);M()}}},wu={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const p=t.getTile(d).getBucket(l);if(p&&(p.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson"){const p=xu(c,l,n.style._importedAsBasemap);return void(n.modelManager&&n.modelManager.upload(n,p))}if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const p of d)p.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof pn&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;const m=t.getIds().map((y=>t.getTileByID(y)));for(const y of m)y.updateNeeded(l.id,p)&&c.prepareTile(y,d,l.id,p)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof pn&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;const m=t.getIds().map((y=>t.getTileByID(y)));for(const y of m)y.updateNeeded(l.id,p)&&c.prepareTile(y,d,l.id,p)}},Tu={fill:La},Ys={fill:function(l,t,n,c){if(!n.layout||n.layout.get("fill-elevation-reference")==="none"||n.paint.get("fill-opacity").constantOr(1)===0)return;const d=l.context.gl,p=new wt(d.LEQUAL,wt.ReadOnly,l.depthRangeFor3D),m=new Zt({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),y=l.transform.getFreeCameraOptions().position,x=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const T of c){const S=t.getTile(T),M=S.getBucket(n);if(!M)continue;const E=M.elevatedStructures;if(!E||E.depthSegments.segments[0].primitiveLength===0)continue;const P=qf(T.toUnwrapped(),y),D=l.translatePosMatrix(T.projMatrix,S,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),O=su(D,P,0,1,0);x.draw(l,d.TRIANGLES,p,m,ni.disabled,jt.disabled,O,n.id,E.vertexBuffer,E.indexBuffer,E.depthSegments,n.paint,l.transform.zoom)}}};class fa{constructor(t,n,c,d,p,m){this.context=new fu(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=p,this._timeStamp=o.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const y=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const T of y)this._debugParams.enabledLayers[T]=!0;p.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),p.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),p.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),p.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const T of y)p.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],T);this.occlusionParams=new Gm(p),this.setup(),this.numSublayers=Fs.maxUnderzooming+Fs.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new ic(this),this._wireframeDebugCache=new tp,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const x=new o.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,x,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=m}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new hc(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,n),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||this.transform.projection.name==="globe"||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=n.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new hc(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*o.o.devicePixelRatio,this.height=n*o.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new o.bc;n.emplaceBack(0,0),n.emplaceBack(o.al,0),n.emplaceBack(0,o.al),n.emplaceBack(o.al,o.al),this.tileExtentBuffer=t.createVertexBuffer(n,o.be.members),this.tileExtentSegments=o.bf.simpleSegment(0,0,4,2);const c=new o.bc;c.emplaceBack(0,0),c.emplaceBack(o.al,0),c.emplaceBack(0,o.al),c.emplaceBack(o.al,o.al),this.debugBuffer=t.createVertexBuffer(c,o.be.members),this.debugSegments=o.bf.simpleSegment(0,0,4,5);const d=new o.bc;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,o.be.members),this.viewportSegments=o.bf.simpleSegment(0,0,4,2);const p=new o.a$;p.emplaceBack(0,0,0,0),p.emplaceBack(o.al,0,o.al,0),p.emplaceBack(0,o.al,0,o.al),p.emplaceBack(o.al,o.al,o.al,o.al),this.mercatorBoundsBuffer=t.createVertexBuffer(p,o.bh.members),this.mercatorBoundsSegments=o.bf.simpleSegment(0,0,4,2);const m=new o.b0;m.emplaceBack(0,1,2),m.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(m);const y=new o.bd;for(const T of[0,1,3,2,0])y.emplaceBack(T);this.debugIndexBuffer=t.createIndexBuffer(y),this.emptyTexture=new o.T(t,new o.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=o.bB();const x=this.context.gl;this.stencilClearMode=new Zt({func:x.ALWAYS,mask:0},0,255,x.ZERO,x.ZERO,x.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,wt.disabled,this.stencilClearMode,ni.disabled,jt.disabled,Da(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let y=!1;for(const x of c)if(this._tileClippingMaskIDs[x.key]===void 0){y=!0;break}if(!y)return}this.currentStencilSource=n.id;const d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(ni.disabled),d.setDepthMode(wt.disabled);const m=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const y of c){const x=n.getTile(y),T=this._tileClippingMaskIDs[y.key]=this.nextStencilID++,{tileBoundsBuffer:S,tileBoundsIndexBuffer:M,tileBoundsSegments:E}=this.getTileBoundsBuffers(x);m.draw(this,p.TRIANGLES,wt.disabled,new Zt({func:p.ALWAYS,mask:0},T,255,p.KEEP,p.KEEP,p.REPLACE),ni.disabled,jt.disabled,Da(y.projMatrix),"$clipping",S,M,E)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Zt({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new Zt({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort(((m,y)=>y.overscaledZ-m.overscaledZ)),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();const m={};for(let y=0;y<p;y++)m[y+d]=new Zt({func:n.GEQUAL,mask:255},y+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=p,[m,c]}return[{[d]:Zt.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new ni([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new o.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ni.unblended:ni.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ni([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new o.ao(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,d=!1){if(this.depthOcclusion)return new wt(this.context.gl.GREATER,wt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return wt.disabled;const p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new wt(c||this.context.gl.LEQUAL,n,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),n!==0&&c!==0&&(this.depthFBO=new du(this.context,n,c,!1,"texture"),this.depthTexture=new o.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((t,n)=>t+n/this._fpsHistory.length),0))}render(t,n){const c=o.o.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),m=()=>this.style._getOrder(p).filter((xe=>{const ce=d[xe];return!(ce.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ce.type]}));let y=m(),x=!1,T=!1,S=null;for(const xe of y){const ce=d[xe];ce.type==="circle"?x=!0:ce.type==="building"?S=ce:ce.type==="symbol"&&(ce.hasOcclusionOpacityProperties?T=!0:x=!0)}let M=y.map((xe=>d[xe]));const E=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.o.now()),this.imageManager.beginFrame();let P=0,D=!1;for(const xe in E){const ce=E[xe];ce.used&&(ce.prepare(this.context),ce.getSource().usedInConflation&&++P)}let O=!1;for(const xe of M)xe.isHidden(this.transform.zoom)||(xe.type==="clip"&&(O=!0),this.prepareLayer(xe));const V={},N={},j={},Z={},H={};for(const xe in E){const ce=E[xe];V[xe]=ce.getVisibleCoordinates(),N[xe]=V[xe].slice().reverse(),j[xe]=ce.getVisibleCoordinates(!0).reverse(),Z[xe]=ce.getShadowCasterCoordinates(),H[xe]=ce.sortCoordinatesByDistance(V[xe])}const te=xe=>{const ce=this.style.getLayerSourceCache(xe);return ce&&ce.used?ce.getSource():null};if(P||O||this._clippingActiveLastFrame){const xe=[],ce=[];let Le=0;for(const Te of M)this.isSourceForClippingOrConflation(Te,te(Te))&&(xe.push(Te),ce.push(Le)),Le++;if(xe&&(O||xe.length>1)||this._clippingActiveLastFrame){O=!1;const Te=[];for(let je=0;je<xe.length;je++){const rt=xe[je],gt=ce[je],Xe=this.style.getLayerSourceCache(rt);if(!Xe||!Xe.used||!Xe.getSource().usedInConflation&&rt.type!=="clip"&&rt.type!=="building")continue;let et=o.eP,xt=o.bZ.None;const dt=[];let ut=!0;if(rt.type==="building")et=o.eR;else if(rt.type==="clip"){et=gt;for(const ft of rt.layout.get("clip-layer-types"))xt|=ft==="model"?o.bZ.Model:ft==="symbol"?o.bZ.Symbol:o.bZ.FillExtrusion;for(const ft of rt.layout.get("clip-layer-scope"))dt.push(ft);rt.isHidden(this.transform.zoom)?ut=!1:O=!0}ut&&Te.push({layer:rt.fqid,cache:Xe,order:et,clipMask:xt,clipScope:dt})}this.replacementSource.setSources(Te),D=!0}}this._clippingActiveLastFrame=O,D||this.replacementSource.clear(),this.conflationActive=D,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let xe=0;xe<M.length;xe++){const ce=M[xe],Le=ce.cutoffRange();if(this.longestCutoffRange=Math.max(Le,this.longestCutoffRange),Le>0){const Te=te(ce);Te&&(this.minCutoffZoom=Math.max(Te.minzoom,this.minCutoffZoom)),ce.minzoom&&(this.minCutoffZoom=Math.max(ce.minzoom,this.minCutoffZoom))}ce.is3D(p)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=xe),this._lastOcclusionLayer=xe)}const W=this.style&&this.style.fog;W?(this._fogVisible=W.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=W.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(j),this.opaquePassCutoff=0,y=m(),M=y.map((xe=>d[xe])));const re=this._shadowRenderer;if(re){re.updateShadowParameters(this.transform,this.style.directionalLight);for(const xe in E)for(const ce of V[xe]){let Le={min:0,max:0};this.terrain&&(Le=this.terrain.getMinMaxForTile(ce)||Le),re.addShadowReceiver(ce.toUnwrapped(),Le.min,Le.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new o.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new $r(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const ee=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),K=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(ee&&!this._snow&&(this._snow=new sd(this)),!ee&&this._snow&&(this._snow.destroy(),delete this._snow),K&&!this._rain&&(this._rain=new vl(this)),!K&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),S){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ge);const xe=this.style.getLayerSourceCache(S);this.buildingTileBorderManager.updateBorders(xe,S)}if(!dr.has(this.context.gl))return;this.renderPass="offscreen";for(const xe of M){const ce=t.getLayerSourceCache(xe);if(!xe.hasOffscreenPass()||xe.isHidden(this.transform.zoom))continue;const Le=ce?N[ce.id]:void 0;(xe.type==="custom"||xe.type==="raster"||xe.type==="raster-particle"||xe.isSky()||Le&&Le.length)&&this.renderLayer(this,ce,xe,Le)}this.depthRangeFor3D=[0,1-(M.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Z)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ne=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),_e=(()=>{if(n.showOverdrawInspector)return o.ao.black;const xe=this.style.fog;if(xe&&this.transform.projection.supportsFog){const ce=this.style.getLut(xe.scope);if(!ne){const Le=xe.properties.get("color-use-theme")==="none",Te=xe.properties.get("color").toNonPremultipliedRenderColor(Le?null:ce).toArray01();return new o.ao(...Te)}if(ne){const Le=xe.properties.get("space-color-use-theme")==="none",Te=xe.properties.get("space-color").toNonPremultipliedRenderColor(Le?null:ce).toArray01();return new o.ao(...Te)}}return o.ao.transparent})();if(this.context.clear({color:_e,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ne&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=y.length-1;this.currentLayer>=0;this.currentLayer--){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);if(xe.isSky())continue;const Le=ce?(xe.is3D(p)?H:N)[ce.id]:void 0;this._renderTileClippingMasks(xe,ce,Le),this.renderLayer(this,ce,xe,Le)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ne&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<y.length;this.currentLayer++){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);xe.isSky()&&this.renderLayer(this,ce,xe,ce?N[ce.id]:void 0)}function fe(xe,ce){let Le;return ce&&(Le=(xe.type==="symbol"?j:xe.is3D(p)?H:N)[ce.id]),Le}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<y.length;){const xe=M[this.currentLayer];if(xe.type==="raster"||xe.type==="raster-particle"){const ce=t.getLayerSourceCache(xe);this.renderLayer(this,ce,xe,fe(xe,ce))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Me=0;re&&(Me=re.getShadowCastingLayerCount());let we=!1,ze=-1;for(let xe=0;xe<y.length;++xe){const ce=M[xe];ce.isHidden(this.transform.zoom)||ce.is3D(p)&&(ze=xe)}T&&ze===-1&&(x=!0);let Je=!1;for(;this.currentLayer<y.length;){const xe=M[this.currentLayer],ce=t.getLayerSourceCache(xe);if(xe.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(xe)){if(xe.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Je&&xe.is3D(p)&&!p){const Le=this.currentLayer,Te=je=>{for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const rt=M[this.currentLayer];if(Tu[rt.type]){const gt=this.style.getLayerSourceCache(rt);Tu[rt.type](this,gt,rt,fe(rt,gt),je)}}};Te("initialize"),Te("reset"),this.currentLayer=Le,Je=!0}if(x&&!we&&this.terrain&&!this.transform.isOrthographic&&(we=!0,this.blitDepth()),T&&ze!==-1&&this.currentLayer===ze+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(xe,ce,ce?V[ce.id]:void 0),this.renderLayer(this,ce,xe,fe(xe,ce)),!this.terrain&&re&&Me>0&&xe.hasShadowPass()&&--Me==0){{this.clearStencil(),this.resetStencilClippingMasks();const Le=this.currentLayer;for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const Te=M[this.currentLayer];if(Ys[Te.type]){const je=this.style.getLayerSourceCache(Te);Ys[Te.type](this,je,Te,fe(Te,je))}}this.currentLayer=Le}if(re.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Le=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Le;this.currentLayer++){const Te=M[this.currentLayer];if(!Te.hasLightBeamPass())continue;const je=t.getLayerSourceCache(Te);this.renderLayer(this,je,Te,je?N[je.id]:void 0)}this.currentLayer=Le,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Le=this.currentLayer;this.depthOcclusion=!0;for(const Te of this.layersWithOcclusionOpacity){this.currentLayer=Te;const je=M[this.currentLayer],rt=t.getLayerSourceCache(je),gt=rt?N[rt.id]:void 0;this.terrain||this._renderTileClippingMasks(je,rt,rt?V[rt.id]:void 0),this.renderLayer(this,rt,je,gt)}this.depthOcclusion=!1,this.currentLayer=Le,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let xe=null;M.forEach((ce=>{const Le=t.getLayerSourceCache(ce);Le&&!ce.isHidden(this.transform.zoom)&&Le.getVisibleCoordinates().length&&(!xe||xe.getSource().maxzoom<Le.getSource().maxzoom)&&(xe=Le)})),xe&&this.options.showTileBoundaries&&Qh(this,xe,xe.getVisibleCoordinates(),o.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Qh(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&(function(xe){const ce=xe.transform.padding;yr(xe,xe.transform.height-(ce.top||0),3,da),yr(xe,ce.bottom||0,3,Wf),_c(xe,ce.left||0,3,Yh),_c(xe,xe.transform.width-(ce.right||0),3,Kh);const Le=xe.transform.centerPoint;(function(Te,je,rt,gt){pl(Te,je-1,rt-10,2,20,gt),pl(Te,je-10,rt-1,20,2,gt)})(xe,Le.x,xe.transform.height-Le.y,Jh)})(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),D||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(wu[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);wu[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,n,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||od[c.type](t,n,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const d=t[c],p=this.context.extTimerQuery,m=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),n[c]=m}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const d of t)c+=n.getQueryParameter(d,n.QUERY_RESULT)/1e6,n.deleteQuery(d);return c}translatePosMatrix(t,n,c,d,p){if(!c[0]&&!c[1])return t;const m=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(m){const T=Math.sin(m),S=Math.cos(m);c=[c[0]*S-c[1]*T,c[0]*T+c[1]*S]}const y=[p?c[0]:o.ay(n,c[0],this.transform.zoom),p?c[1]:o.ay(n,c[1],this.transform.zoom),0],x=new Float32Array(16);return o.bq(x,t,y),x}saveTileTexture(t){if(t.context!==this.context)return;const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,n,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||n!==void 0&&!n||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],d=n&&n.config,p=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),m=dc.cacheKey(qc[t],t,p,d);return this.cache[m]||(this.cache[m]=new dc(this.context,t,qc[t],d,Bm[t],p)),this.cache[m]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const p=((m,y,x)=>{const T=m.properties.get("direction"),S=m.properties.get("color-use-theme")==="none",M=m.properties.get("color").toNonPremultipliedRenderColor(S?null:x.getLut(m.scope)).toArray01(),E=m.properties.get("intensity"),P=y.properties.get("color-use-theme")==="none",D=y.properties.get("color").toNonPremultipliedRenderColor(P?null:x.getLut(y.scope)).toArray01(),O=y.properties.get("intensity"),V=[T.x,T.y,T.z],N=o.dM(D,O),j=o.dM(M,E);return{u_lighting_ambient_color:N,u_lighting_directional_dir:V,u_lighting_directional_color:j,u_ground_radiance:Lh(V,j,N)}})(c,d,this.style);n.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,n,c,d,p){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const m=this.style.fog;if(m){const y=m.getOpacity(this.transform.pitch),x=((T,S,M,E,P,D,O,V,N,j,Z,H)=>{const te=T.transform,W=S.properties.get("color-use-theme")==="none",re=S.properties.get("color").toNonPremultipliedRenderColor(W?null:T.style.getLut(S.scope)).toArray01();re[3]=E;const ee=T.frameCounter/1e3%1,[K,ne]=S.properties.get("vertical-range");return{u_fog_matrix:M?te.calculateFogTileMatrix(M):H||T.identityMat,u_fog_range:S.getFovAdjustedRange(te._fov),u_fog_color:re,u_fog_horizon_blend:S.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(K,ne),ne],u_fog_temporal_offset:ee,u_frustum_tl:P,u_frustum_tr:D,u_frustum_br:O,u_frustum_bl:V,u_globe_pos:N,u_globe_radius:j,u_viewport:Z,u_globe_transition:o.aj(te.zoom),u_is_globe:+(te.projection.name==="globe")}})(this,m,c,y,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.o.devicePixelRatio,this.transform.height*o.o.devicePixelRatio],d);n.setFogUniformValues(t,x)}p&&n.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)n[d.key]=t[d.key]||new qs(d,512,this.transform.tileZoom,this,void 0,this.worldview);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!n||n.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=be||n[1]>=be}setupDepthForOcclusion(t,n,c){const d=this.context,p=d.gl,m=!!c;var y;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((y=this.depthRangeFor3D)[1]-y[0]),-1-2*y[0]/(y[1]-y[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),m||n.setTerrainUniformValues(d,c)}}function Ba(l,t){let n=!1,c=null;const d=()=>{c=null,n&&(l(),c=setTimeout(d,t),n=!1)};return()=>(n=!0,c||d(),c)}class Su{constructor(t){this._hashName=t&&encodeURIComponent(t),o.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ba(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=Eu(t);if(this._hashName){const c=this._hashName;let d=!1;const p=location.hash.slice(1).split("&").map((m=>{const y=m.split("=")[0];return y===c?(d=!0,"".concat(y,"=").concat(n)):m})).filter((m=>m));return d||p.push("".concat(c,"=").concat(n)),"#".concat(p.join("&"))}return"#".concat(n)}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map((c=>c.split("="))).forEach((c=>{c[0]===this._hashName&&(n=c)})),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some((c=>isNaN(Number(c))))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Eu(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),m=Math.round(n.lng*p)/p,y=Math.round(n.lat*p)/p,x=l.getBearing(),T=l.getPitch();let S=t?"/".concat(m,"/").concat(y,"/").concat(c):"".concat(c,"/").concat(y,"/").concat(m);return(x||T)&&(S+="/"+Math.round(10*x)/10),T&&(S+="/".concat(Math.round(T))),S}const bl={linearity:.3,easing:o.eS(0,0,.3,1)},pa=Object.assign({deceleration:2500,maxSpeed:1400},bl),ad=Object.assign({deceleration:20,maxSpeed:1400},bl),xo=Object.assign({deceleration:1e3,maxSpeed:360},bl),ld=Object.assign({deceleration:1e3,maxSpeed:90},bl);class Iu{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=o.o.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:p}of this._inertiaBuffer)n.zoom+=p.zoomDelta||0,n.bearing+=p.bearingDelta||0,n.pitch+=p.pitchDelta||0,p.panDelta&&n.pan._add(p.panDelta),p.around&&(n.around=p.around),p.pinchAround&&(n.pinchAround=p.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const p=Tl(n.pan.mag(),c,Object.assign({},pa,t||{}));d.offset=n.pan.mult(p.amount/n.pan.mag()),d.center=this._map.transform.center,wl(d,p)}if(n.zoom){const p=Tl(n.zoom,c,ad);d.zoom=this._map.transform.zoom+p.amount,wl(d,p)}if(n.bearing){const p=Tl(n.bearing,c,xo);d.bearing=this._map.transform.bearing+o.aA(p.amount,-179,179),wl(d,p)}if(n.pitch){const p=Tl(n.pitch,c,ld);d.pitch=this._map.transform.pitch+p.amount,wl(d,p)}if(d.zoom||d.bearing){const p=n.pinchAround===void 0?n.around:n.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function wl(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Tl(l,t,n){const{maxSpeed:c,linearity:d,deceleration:p}=n,m=o.aA(l*d/(t/1e3),-c,c),y=Math.abs(m)/(p*d);return{easing:n.easing,duration:1e3*y,amount:m*(y/2)}}class zr extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const p=Ii(n.getCanvasContainer(),c),m=n.unproject(p);super(t,Object.assign({point:p,lngLat:m,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class Sl extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,p=xr(n.getCanvasContainer(),d),m=p.map((x=>n.unproject(x))),y=p.reduce(((x,T,S,M)=>x.add(T.div(M.length))),new o.P(0,0));super(t,{points:p,point:y,lngLats:m,lngLat:n.unproject(y),originalEvent:c}),this._defaultPrevented=!1}}class cd extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class ud{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new cd(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new zr(t.type,this._map,t))}mouseup(t){this._map.fire(new zr(t.type,this._map,t))}preclick(t){const n=new MouseEvent("preclick",t);this._map.fire(new zr(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new zr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new zr(t.type,this._map,t))}mouseover(t){this._map.fire(new zr(t.type,this._map,t))}mouseout(t){this._map.fire(new zr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Sl(t.type,this._map,t))}touchmove(t){this._map.fire(new Sl(t.type,this._map,t))}touchend(t){this._map.fire(new Sl(t.type,this._map,t))}touchcancel(t){this._map.fire(new Sl(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Na{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new zr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new zr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new zr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class hd{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(hi(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=_t("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const m=Math.min(d.x,c.x),y=Math.max(d.x,c.x),x=Math.min(d.y,c.y),T=Math.max(d.y,c.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform="translate(".concat(m,"px,").concat(x,"px)"),this._box.style.width=y-m+"px",this._box.style.height=T-x+"px")}))}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,d=n;if(c&&t.button===0){if(this.reset(),yi(),c.x!==d.x||c.y!==d.y)return this._map.fire(new o.z("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Wi(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new o.z(t,{originalEvent:n}))}}function xc(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class dd{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=(function(d){const p=new o.P(0,0);for(const m of d)p._add(m);return p.div(d.length)})(n),this.touches=xc(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=xc(c,n);for(const p in this.touches){const m=d[p];(!m||m.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class ma{constructor(t){this.singleTap=new dd(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const p=t.timeStamp-this.lastTime<500,m=!this.lastTap||this.lastTap.dist(d)<30;if(p&&m||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class fd{constructor(){this._zoomIn=new ma({numTouches:1,numTaps:2}),this._zoomOut=new ma({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),p=this._zoomOut.touchend(t,n,c);return d?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()+1,around:m.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:m=>m.easeTo({duration:300,zoom:m.getZoom()-1,around:m.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Au={0:1,2:2},Mu={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class El{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=Lr(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&(function(d,p){const m=Au[p];return d.buttons===void 0||(d.buttons&m)!==m})(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}}mouseupWindow(t){this._lastPoint&&Lr(t)===this._eventButton&&(this._moved&&yi(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class pd extends El{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return n===0&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class Cu extends El{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Mu[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class md extends El{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?Mu[t.pitchRotateKey]:void 0}_correctButton(t,n){return this._pitchRotateKey?n===0&&t[this._pitchRotateKey]:n===0&&t.ctrlKey||n===2}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class rp{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),o.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!o.eT())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=xc(c,n),p=new o.P(0,0),m=new o.P(0,0);let y=0;for(const T in d){const S=d[T],M=this._touches[T];M&&(p._add(S),m._add(S.sub(M)),y++,d[T]=S)}if(this._touches=d,y<this._minTouches||!m.mag())return;const x=m.div(y);return this._sum._add(x),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(y),panDelta:x}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_t("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize="".concat(Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth))),"px"))}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class Pu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[p,m]=d,y=vc(c,n,p),x=vc(c,n,m);if(!y||!x)return;const T=this._aroundCenter?null:y.add(x).div(2);return this._move([y,x],T,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,p]=this._firstTwoTouches,m=vc(c,n,d),y=vc(c,n,p);m&&y||(this._active&&yi(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function vc(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function _d(l,t){return Math.log2(l/t)}class np extends Pu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(_d(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:_d(this._distance,c),pinchAround:n}}}function gd(l,t){return 180*l.angleWith(t)/Math.PI}class sp extends Pu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:gd(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=gd(t,c);return Math.abs(d)<n}}function Ru(l){return Math.abs(l.y)>Math.abs(l.x)}class op extends Pu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Ru(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const d=this._lastPoints;if(!d)return;const p=t[0].sub(d[0]),m=t[1].sub(d[1]);return this._map._cooperativeGestures&&!o.eT()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,m,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+m.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,p=n.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const m=t.y>0==n.y>0;return Ru(t)&&Ru(n)&&m}}const ap={panStep:100,bearingStep:15,pitchStep:10};class lp{constructor(){const t=ap;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,p=0,m=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),m=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),m=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:y=>{const x=y.getZoom();y.easeTo({duration:300,easeId:"keyboardHandler",easing:cp,zoom:n?Math.round(x)+n*(t.shiftKey?2:1):x,bearing:y.getBearing()+c*this._bearingStep,pitch:y.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-m*this._panStep],center:y.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function cp(l){return l*(2-l)}const up=4.000244140625,$m=1/450;class Zm{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=$m,o.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||o.eT()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=o.o.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%up==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Ii(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const T=this._type==="wheel"&&Math.abs(this._delta)>up?this._wheelZoomRate:this._defaultZoomRate;let S=2/(1+Math.exp(-Math.abs(this._delta*T)));this._delta<0&&S!==0&&(S=1/S);const M=n(),E=Math.pow(2,M),P=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):E;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(P*S))),this._type==="wheel"&&(this._startZoom=M,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:n(),d=this._startZoom,p=this._easing;let m,y=!1;if(this._type==="wheel"&&d&&p){const T=Math.min((o.o.now()-this._lastWheelEventTime)/200,1),S=p(T);m=o.ak(d,c,S),T<1?this._frameId||(this._frameId=!0):y=!0}else m=c,y=!0;this._active=!0,y&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let x=m-n();return x*this._lastDelta<0&&(x=0),{noInertia:!0,needsRenderFrame:!y,zoomDelta:x,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=o.eU;if(this._prevEase){const c=this._prevEase,d=(o.o.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),m=.27/Math.sqrt(p*p+1e-4)*.01,y=Math.sqrt(.0729-m*m);n=o.eS(m,y,.25,1)}return this._prevEase={start:o.o.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_t("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize="".concat(Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth))),"px"))}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class Vr{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class hp{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wm{constructor(){this._tap=new ma({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Xm{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ym{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class bc{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const wc=l=>l.zoom||l.drag||l.pitch||l.rotate;class yd extends o.z{}class Du{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=o.av([],n,t);this.radius=o.ag(c[2]<0?o.eW([],c,this.constants):[c[0],c[1],0])}projectRay(t){o.eW(t,t,this.constants),o.aw(t,t),o.eX(t,t,this.constants);const n=o.c4([],t,this.radius);if(n[2]>0){const c=o.c4([],[0,0,1],o.bI(n,[0,0,1])),d=o.c4([],o.aw([],[n[0],n[1],0]),this.radius),p=o.d7([],n,o.c4([],o.av([],o.d7([],d,c),n),2));n[0]=p[0],n[1]=p[1]}return n}}function vo(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class zu{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Iu(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Du,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),o.aX(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,p,m]of this._listeners){const y=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,y,m)}}destroy(){for(const[t,n,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,d,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new ud(n,t));const d=n.boxZoom=new hd(n,t);this._add("boxZoom",d);const p=new fd,m=new hp;n.doubleClickZoom=new Vr(m,p),this._add("tapZoom",p),this._add("clickZoom",m);const y=new Wm;this._add("tapDragZoom",y);const x=n.touchPitch=new op(n);this._add("touchPitch",x);const T=new Cu(t),S=new md(t);n.dragRotate=new Ym(t,T,S),this._add("mouseRotate",T,["mousePitch"]),this._add("mousePitch",S,["mouseRotate"]);const M=new pd(t),E=new rp(n,t);n.dragPan=new Xm(c,M,E),this._add("mousePan",M),this._add("touchPan",E,["touchZoom","touchRotate"]);const P=new sp,D=new np;n.touchZoomRotate=new bc(c,D,P,y),this._add("touchRotate",P,["touchPan","touchZoom"]),this._add("touchZoom",D,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Na(n));const O=n.scrollZoom=new Zm(n,this);this._add("scrollZoom",O,["mousePan"]);const V=n.keyboard=new lp;this._add("keyboard",V);for(const N of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[N]&&n[N].enable(t[N])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!wc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,"".concat(t.type,"Window"))}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},m={},y={},x=t.touches?this._getMapTouches(t.touches):void 0,T=x?xr(this._el,x):c?void 0:Ii(this._el,t);for(const{handlerName:E,handler:P,allowed:D}of this._handlers){if(!P.isEnabled())continue;let O;this._blockedByActive(y,D,E)?P.reset():P[n||t.type]&&(O=P[n||t.type](t,T,x),this.mergeHandlerResult(p,m,O,E,d),O&&O.needsRenderFrame&&this._triggerRenderFrame()),(O||P.isActive())&&(y[E]=P)}const S={};for(const E in this._previousActiveHandlers)y[E]||(S[E]=d);this._previousActiveHandlers=y,(Object.keys(S).length||vo(p))&&(this._changes.push([p,m,S]),this._triggerRenderFrame()),(Object.keys(y).length||vo(p))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:M}=p;M&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],M(this._map))}mergeHandlerResult(t,n,c,d,p){if(!c)return;Object.assign(t,c);const m={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(n.zoom=m),c.panDelta!==void 0&&(n.drag=m),c.pitchDelta!==void 0&&(n.pitch=m),c.bearingDelta!==void 0&&(n.rotate=m)}_applyChanges(){const t={},n={},c={};for(const[d,p,m]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new o.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),Object.assign(n,p),Object.assign(c,m);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,p=d.transform,m=j=>[j.x,j.y,j.z];if((j=>{const Z=this._eventsInProgress.drag;return Z&&!this._handlersById[Z.handlerName].isActive()})()&&!vo(t)){const j=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),j!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!vo(t))return void this._fireEvents(n,c,!0);let{panDelta:y,zoomDelta:x,bearingDelta:T,pitchDelta:S,around:M,aroundCoord:E,pinchAround:P}=t;p._isCameraConstrained&&(x>0&&(x=0),p._isCameraConstrained=!1),P!==void 0&&(M=P),(x||(j=>n[j]&&!this._eventsInProgress[j])("drag"))&&M&&(this._dragOrigin=m(p.pointCoordinate3D(M)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),M=M||d.transform.centerPoint,T&&(p.bearing+=T),S&&(p.pitch+=S),p._updateCameraState();const D=[0,0,0];if(y)if(p.projection.name==="mercator"){const j=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(M).dir),Z=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(M.sub(y)).dir);D[0]=Z[0]-j[0],D[1]=Z[1]-j[1]}else{const j=p.pointCoordinate(M);if(p.projection.name==="globe"){y=y.rotate(-p.angle);const Z=p._pixelsPerMercatorPixel/p.worldSize;D[0]=-y.x*o.eV(o.a_(j.y))*Z,D[1]=-y.y*o.eV(p.center.lat)*Z}else{const Z=p.pointCoordinate(M.sub(y));j&&Z&&(D[0]=Z.x-j.x,D[1]=Z.y-j.y)}}const O=p.zoom,V=[0,0,0];if(x){const j=m(E||p.pointCoordinate3D(M)),Z={dir:o.aw([],o.av([],j,p._camera.position))};if(Z.dir[2]<0){const H=p.zoomDeltaToMovement(j,x);o.c4(V,Z.dir,H)}}const N=o.d7(D,D,V);p._translateCameraConstrained(N),x&&Math.abs(p.zoom-O)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=wc(this._eventsInProgress),p=wc(t),m={};for(const S in t){const{originalEvent:M}=t[S];this._eventsInProgress[S]||(m["".concat(S,"start")]=M),this._eventsInProgress[S]=t[S]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(const S in m)this._fireEvent(S,m[S]);p&&this._fireEvent("move",p.originalEvent);for(const S in t){const{originalEvent:M}=t[S];this._fireEvent(S,M)}const y={};let x;for(const S in this._eventsInProgress){const{handlerName:M,originalEvent:E}=this._eventsInProgress[S];this._handlersById[M].isActive()||(delete this._eventsInProgress[S],x=n[M]||E,y["".concat(S,"end")]=x)}for(const S in y)this._fireEvent(S,y[S]);const T=wc(this._eventsInProgress);if(c&&(d||p)&&!T){this._updatingCamera=!0;const S=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),M=E=>E!==0&&-this._bearingSnap<E&&E<this._bearingSnap;S?(M(S.bearing||this._map.getBearing())&&(S.bearing=0),this._map.easeTo(S,{originalEvent:x})):(this._map.fire(new o.z("moveend",{originalEvent:x})),M(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new o.z(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{this._frameId=void 0,this.handleEvent(new yd("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const un="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class ko extends o.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=n.respectPrefersReducedMotion!==!1,o.aX(["_renderFrameCallback"],this)}getCenter(){return new o.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=o.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},n),c)}panTo(t,n,c){return this.easeTo(Object.assign({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(Object.assign({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(Object.assign({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,Object.assign({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=o.aI.convert(t);const c=n&&n.bearing||0,d=n&&n.pitch||0,p=t.getNorthWest(),m=t.getSouthEast();return this._cameraForBounds(this.transform,p,m,c,d,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},n,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},n,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,d,p,m){const y=t.clone(),x=this._extendCameraOptions(m);y.bearing=d,y.pitch=p;const T=o.aS.convert(n),S=o.aS.convert(c),M=.5*(T.lat+S.lat),E=.5*(T.lng+S.lng),P=o.eY(M,E),D=o.aw([],P),O=o.aw([],o.bH([],D,[0,1,0])),V=o.bH([],O,D),N=[O[0],O[1],O[2],0,V[0],V[1],V[2],0,D[0],D[1],D[2],0,0,0,0,1],j=[P,o.eY(T.lat,T.lng),o.eY(S.lat,T.lng),o.eY(S.lat,S.lng),o.eY(T.lat,S.lng),o.eY(M,T.lng),o.eY(M,S.lng),o.eY(T.lat,E),o.eY(S.lat,E)];let Z=o.d8.fromPoints(j.map((Te=>[o.bI(O,Te),o.bI(V,Te),o.bI(D,Te)])));const H=o.af([],Z.center,N);o.eZ(H)===0&&o.e_(H,0,0,1),o.aw(H,H),o.c4(H,H,o.aD),y.center=o.e$(H);const te=y.getWorldToCameraMatrix(),W=o.bk(new Float64Array(16),te);Z=o.d8.applyTransform(Z,o.aB([],te,N));const re=this._extendAABB(Z,y,x,d);if(!re)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Z=re,o.af(H,H,te);const ee=.5*(Z.max[2]-Z.min[2]),K=this._minimumAABBFrustumDistance(y,Z),ne=o.c4([],[0,0,1],ee),_e=o.d7(ne,H,ne),fe=K+(y.pitch===0?0:o.bF(H,_e)),Me=y.globeCenterInViewSpace,we=o.av([],H,[Me[0],Me[1],Me[2]]);o.aw(we,we),o.c4(we,we,fe);const ze=o.d7([],H,we);o.af(ze,ze,W);const Je=o.eL/o.aD,xe=o.ag(ze),ce=o.ce(Math.max(xe*Je-o.eL,Number.EPSILON),0),Le=Math.min(y.zoomFromMercatorZAdjusted(ce),x.maxZoom);return Le>.5*(o.cZ+o.cK)?(y.setProjection({name:"mercator"}),y.zoom=Le,this._cameraForBounds(y,n,c,d,p,m)):{center:y.center,zoom:Le,bearing:d,pitch:p}}_extendAABB(t,n,c,d){const p=.5*((c.padding.left||0)+(c.padding.right||0)),m=.5*((c.padding.top||0)+(c.padding.bottom||0)),y=m,x=p,T=p,S=m,M=n.width-(x+T),E=n.height-(y+S),P=o.av([],t.max,t.min),D=Math.min(M/P[0],E/P[1]),O=Math.min(n.scaleZoom(n.scale*D),c.maxZoom);if(isNaN(O))return null;const V=n.scale/n.zoomScale(O),N=new o.d8([t.min[0]-x*V,t.min[1]-S*V,t.min[2]],[t.max[0]+T*V,t.max[1]+y*V,t.max[2]]),j=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new o.P(c.offset.x,c.offset.y):o.P.convert(c.offset)).rotate(-o.an(d));return N.center[0]-=j.x*V,N.center[1]+=j.y*V,N}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=Object.assign({},{exaggerated:!0},n),c.getAtPoint(o.ae.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,d,p,m){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,n,c,d,p,m);const y=t.clone(),x=this._extendCameraOptions(m);y.bearing=d,y.pitch=p;const T=o.aS.convert(n),S=o.aS.convert(c),M=new o.aS(T.lng,S.lat),E=new o.aS(S.lng,T.lat),P=y.project(T),D=y.project(S),O=this.queryTerrainElevation(T),V=this.queryTerrainElevation(S),N=this.queryTerrainElevation(M),j=this.queryTerrainElevation(E),Z=[[P.x,P.y,Math.min(O||0,V||0,N||0,j||0)],[D.x,D.y,Math.max(O||0,V||0,N||0,j||0)]];let H=o.d8.fromPoints(Z);const te=y.getWorldToCameraMatrix(),W=o.bk(new Float64Array(16),te);H=o.d8.applyTransform(H,te);const re=this._extendAABB(H,y,x,d);if(!re)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");H=re;const ee=.5*o.av([],H.max,H.min)[2],K=this._minimumAABBFrustumDistance(y,H),ne=[0,0,1,0];o.aC(ne,ne,te),o.f0(ne,ne);const _e=o.c4([],ne,K+ee),fe=o.d7([],H.center,_e);o.af(H.center,H.center,W),o.af(fe,fe,W);const Me=y.unproject(new o.P(H.center[0],H.center[1])),we=o.f1(y.projection,Me),ze=Math.pow(2,we),Je=Math.min(y._zoomFromMercatorZ(fe[2]*y.pixelsPerMeter*ze/y.worldSize),x.maxZoom);return y.mercatorFromTransition&&Je<.5*(o.cZ+o.cK)?(y.setProjection({name:"globe"}),y.zoom=Je,this._cameraForBounds(y,n,c,d,p,m)):{center:Me,zoom:Je,bearing:d,pitch:p}}fitBounds(t,n,c){const d=this.cameraForBounds(t,n);return this._fitInternal(d,n,c)}fitScreenCoordinates(t,n,c,d,p){const m=o.P.convert(t),y=o.P.convert(n),x=new o.P(Math.min(m.x,y.x),Math.min(m.y,y.y)),T=new o.P(Math.max(m.x,y.x),Math.max(m.y,y.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(m,y))return this;const S=this.transform.pointLocation3D(x),M=this.transform.pointLocation3D(T),E=this.transform.pointLocation3D(new o.P(x.x,T.y)),P=this.transform.pointLocation3D(new o.P(T.x,x.y)),D=[Math.min(S.lng,M.lng,E.lng,P.lng),Math.min(S.lat,M.lat,E.lat,P.lat)],O=[Math.max(S.lng,M.lng,E.lng,P.lng),Math.max(S.lat,M.lat,E.lat,P.lat)],V=d&&d.pitch?d.pitch:this.getPitch(),N=this._cameraForBounds(this.transform,D,O,c,V,d);return this._fitInternal(N,d,p)}_fitInternal(t,n,c){return t?(n=Object.assign(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,p=!1,m=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=o.aS.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(m=!0,c.pitch=+t.pitch);const y=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(y))if(t.retainPadding===!1){const x=c.clone();x.padding=y,c.setLocationAtPoint(c.center,x.centerPoint)}else c.padding=y;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),d&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),p&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),m&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(un),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return o.w(un),this;this.stop();const d=c.zoom,p=c.pitch,m=c.bearing;c.setFreeCameraOptions(t);const y=d!==c.zoom,x=p!==c.pitch,T=m!==c.bearing;return this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),y&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),T&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),x&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:o.eU},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),p=this.getBearing(),m=this.getPitch(),y=this.getPadding(),x="zoom"in t?+t.zoom:d,T="bearing"in t?this._normalizeBearing(t.bearing,p):p,S="pitch"in t?+t.pitch:m,M=this._extendPadding(t.padding),E=o.P.convert(t.offset);let P,D,O;if(c.projection.name==="globe"){const ne=o.ae.fromLngLat(c.center),_e=E.rotate(-c.angle);ne.x+=_e.x/c.worldSize,ne.y+=_e.y/c.worldSize;const fe=ne.toLngLat(),Me=o.aS.convert(t.center||fe);this._normalizeCenter(Me),P=c.centerPoint.add(_e),D=new o.P(ne.x,ne.y).mult(c.worldSize),O=new o.P(o.aF(Me.lng),o.aJ(Me.lat)).mult(c.worldSize).sub(D)}else{P=c.centerPoint.add(E);const ne=c.pointLocation(P),_e=o.aS.convert(t.center||ne);this._normalizeCenter(_e),D=c.project(ne),O=c.project(_e).sub(D)}const V=c.zoomScale(x-d);let N,j;t.around&&(N=o.aS.convert(t.around),j=c.locationPoint(N));const Z=this._zooming||x!==d,H=this._rotating||p!==T,te=this._pitching||S!==m,W=!c.isPaddingEqual(M),re=t.retainPadding===!1?c.clone():c,ee=ne=>_e=>{if(Z&&(ne.zoom=o.ak(d,x,_e)),H&&(ne.bearing=o.ak(p,T,_e)),te&&(ne.pitch=o.ak(m,S,_e)),W&&(re.interpolatePadding(y,M,_e),P=re.centerPoint.add(E)),N)ne.setLocationAtPoint(N,j);else{const fe=ne.zoomScale(ne.zoom-d),Me=x>d?Math.min(2,V):Math.max(.5,V),we=Math.pow(Me,1-_e),ze=ne.unproject(D.add(O.mult(_e*we)).mult(fe));ne.setLocationAtPoint(ne.renderWorldCopies?ze.wrap():ze,P)}return t.preloadOnly||this._fireMoveEvents(n),ne};if(t.preloadOnly){const ne=this._emulate(ee,t.duration,c);return this._preloadTiles(ne),this}const K={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Z,this._rotating=H,this._pitching=te,this._padding=W,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,K),this._ease(ee(c),(ne=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(n,ne)}),t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new o.z("movestart",t)),this._zooming&&!c.zooming&&this.fire(new o.z("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new o.z("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new o.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new o.z("move",t)),this._zooming&&this.fire(new o.z("zoom",t)),this._rotating&&this.fire(new o.z("rotate",t)),this._pitching&&this.fire(new o.z("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new o.z("zoomend",t)),d&&this.fire(new o.z("rotateend",t)),p&&this.fire(new o.z("pitchend",t)),this.fire(new o.z("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const Te=o.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Te,n)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:o.eU},t);const c=this.transform,d=this.getZoom(),p=this.getBearing(),m=this.getPitch(),y=this.getPadding(),x="zoom"in t?o.aA(+t.zoom,c.minZoom,c.maxZoom):d,T="bearing"in t?this._normalizeBearing(t.bearing,p):p,S="pitch"in t?+t.pitch:m,M=this._extendPadding(t.padding),E=c.zoomScale(x-d),P=o.P.convert(t.offset);let D=c.centerPoint.add(P);const O=c.pointLocation(D),V=o.aS.convert(t.center||O);this._normalizeCenter(V);const N=c.project(O),j=c.project(V).sub(N);let Z=t.curve;const H=Math.max(c.width,c.height),te=H/E,W=j.mag();if("minZoom"in t){const Te=o.aA(Math.min(t.minZoom,d,x),c.minZoom,c.maxZoom),je=H/c.zoomScale(Te-d);Z=Math.sqrt(je/W*2)}const re=Z*Z;function ee(Te){const je=(te*te-H*H+(Te?-1:1)*re*re*W*W)/(2*(Te?te:H)*re*W);return Math.log(Math.sqrt(je*je+1)-je)}function K(Te){return(Math.exp(Te)-Math.exp(-Te))/2}function ne(Te){return(Math.exp(Te)+Math.exp(-Te))/2}const _e=ee(0);let fe=function(Te){return ne(_e)/ne(_e+Z*Te)},Me=function(Te){return H*((ne(_e)*(K(je=_e+Z*Te)/ne(je))-K(_e))/re)/W;var je},we=(ee(1)-_e)/Z;if(Math.abs(W)<1e-6||!isFinite(we)){if(Math.abs(H-te)<1e-6)return this.easeTo(t,n);const Te=te<H?-1:1;we=Math.abs(Math.log(te/H))/Z,Me=function(){return 0},fe=function(je){return Math.exp(Te*Z*je)}}t.duration="duration"in t?+t.duration:1e3*we/("screenSpeed"in t?+t.screenSpeed/Z:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const ze=p!==T,Je=S!==m,xe=!c.isPaddingEqual(M),ce=t.retainPadding===!1?c.clone():c,Le=Te=>je=>{const rt=je*we,gt=1/fe(rt);Te.zoom=je===1?x:d+Te.scaleZoom(gt),ze&&(Te.bearing=o.ak(p,T,je)),Je&&(Te.pitch=o.ak(m,S,je)),xe&&(ce.interpolatePadding(y,M,je),D=ce.centerPoint.add(P));const Xe=je===1?V:Te.unproject(N.add(j.mult(Me(rt))).mult(gt));return Te.setLocationAtPoint(Te.renderWorldCopies?Xe.wrap():Xe,D),Te._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),Te};if(t.preloadOnly){const Te=this._emulate(Le,t.duration,c);return this._preloadTiles(Te),this}return this._zooming=!0,this._rotating=ze,this._pitching=Je,this._padding=xe,this._prepareEase(n,!1),this._ease(Le(c),(()=>this._afterEase(n)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=o.o.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((o.o.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=o.bS(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||n.projection.name!=="globe"&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&o.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const d=Math.ceil(15*n/1e3),p=[],m=t(c.clone());for(let y=0;y<=d;y++){const x=m(y/d);p.push(x.clone())}return p}_preloadTiles(t,n){}}class Il{constructor(t={}){this.options=t,o.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=_t("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=_t("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=_t("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=_t("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),n===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(t){const c=n.reduce(((d,p,m)=>(p.value&&(d+="".concat(p.key,"=").concat(p.value).concat(m<n.length-1?"&":"")),d)),"?");t.href="".concat(o.e.FEEDBACK_URL,"/").concat(c,"#").concat(Eu(this._map,!0)),t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style._mergedSourceCaches;for(const d in n){const p=n[d];if(p.used){const m=p.getSource();m.attribution&&t.indexOf(m.attribution)<0&&t.push(m.attribution)}}t.sort(((d,p)=>d.length-p.length)),t=t.filter(((d,p)=>{for(let m=p+1;m<t.length;m++)if(t[m].indexOf(d)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Tc{constructor(){o.aX(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=_t("div","mapboxgl-ctrl");const n=_t("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class xd{constructor(){o.aX(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=_t("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",(n=>this._onIndoorUpdate(n))),this._container}_createButton(t,n){const c=_t("button",t,this._container);return c.type="button",c.addEventListener("click",n),c}_createSeparator(){return _t("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,n){this._map&&(t.setAttribute("aria-label",n),t.textContent=n)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return this._model=t,void(this._container.style.display="none");const n=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px",n&&Array.from(this._container.children).forEach((c=>c.remove())),t.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(t.floors,t.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const t=this._createButton("mapboxgl-ctrl-buildings-toggle",(()=>{const n=this._map;this._model&&n&&n._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)}));_t("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden","true"),t.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&t.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(t),this._createSeparator()}_updateBuildingsButtonState(){const t=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");t&&this._model&&(this._model.activeFloorsVisible?t.classList.remove("mapboxgl-ctrl-level-button-selected"):t.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(t,n){for(let c=0;c<t.length;c++){const d=t[c],p=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(d.id)}));this._setButtonTitle(p,d.zIndex.toString()),this._model&&d.id===this._model.selectedFloorId&&n&&p.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(p),c<t.length-1&&this._createSeparator()}}}class dp{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Sc{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=o.dC((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const Km={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class fp extends o.z{constructor(t,n,c,d){const{point:p,lngLat:m,originalEvent:y,target:x}=t;super(t.type,{point:p,lngLat:m,originalEvent:y,target:x}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=d}}class vd{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error('Interaction id "'.concat(t,'" already exists.'));const c=n.filter;let d=n.type;c&&this.filters.set(t,o.b5(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,n),this.typeById.set(t,d)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),n==="mouseenter"||n==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[d,p]of n)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map((({feature:c})=>c));n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void o.w("mouseenter interaction required for mouseleave to work.");const d=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!n;n=n||this.queryTargets(t.point,d);let m=!1;const y=new Set;for(const x of n){for(const[T,S]of d){if(!S.target)continue;const M=x.variants?x.variants[T]:null;if(M){for(const E of M){if(Ut(E,x,y,T))continue;const P=new o.dw(x,E),D=Ht(E,x,T);p&&P.id!==void 0&&(P.state=this.map.getFeatureState(P));const O=c?this.prevHoveredFeatures.get(D):null,V=new fp(t,T,S,P),N=O?O.stop:S.handler(V);if(c&&this.hoveredFeatures.set(D,{feature:x,stop:N}),N!==!1){m=!0;break}}if(m)break}}if(m)break}if(!m)for(const[x,T]of d){const{handler:S,target:M}=T;if(!M&&S(new fp(t,x,T,null))!==!1)break}}}function bd(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every((d=>c.has(d)))}return o.bx(l,t)}const Lu={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Ou={showCompass:!0,showZoom:!0,visualizePitch:!1};class Ec{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new Cu({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new md({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),o.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),hi()}move(t,n){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,n),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){const m=this.mousePitch.mousemoveWindow(t,n),y=m&&m.pitchDelta;y&&c.setPitch(c.getPitch()+y)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Wi(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Ii(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Ii(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=xr(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=xr(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Xo(l,t,n){if(l=new o.aS(l.lng,l.lat),t){const c=new o.aS(l.lng-360,l.lat),d=new o.aS(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),m=n.locationPoint3D(l).distSqr(t),y=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint3D(c).distSqr(t)<m&&(y||Math.abs(c.lng-n.center.lng)<p)?l=c:n.locationPoint3D(d).distSqr(t)<m&&(y||Math.abs(d.lng-n.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const To={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},ls={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Yo extends o.E{constructor(t,n){super(),(t instanceof HTMLElement||n)&&(t=Object.assign({element:t},n)),o.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:c="center",color:d="#3FB1CE",scale:p=1,draggable:m=!1,clickTolerance:y=0,rotation:x=ls.rotation,rotationAlignment:T=ls.rotationAlignment,pitchAlignment:S=ls.pitchAlignment,occludedOpacity:M=ls.occludedOpacity,altitude:E=ls.altitude}=t||{};this._anchor=c,this._color=d,this._scale=p,this._draggable=m,this._clickTolerance=y,this._rotation=x,this._rotationAlignment=T,this._pitchAlignment=S,this._occludedOpacity=M,this._altitude=E,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=o.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=o.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(O=>{O.preventDefault()})),this._element.addEventListener("mousedown",(O=>{O.preventDefault()}));const P=this._element.classList;for(const O in To)P.remove("mapboxgl-marker-anchor-".concat(O));P.add("mapboxgl-marker-anchor-".concat(this._anchor));const D=t&&t.className?t.className.trim().split(/\s+/):[];P.add(...D),this._popup=null}_createDefaultMarker(){const t=_t("div"),n=Ot("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=Ot("radialGradient",{id:"shadowGradient"},Ot("defs",{},n));Ot("stop",{offset:"10%","stop-opacity":.4},c),Ot("stop",{offset:"100%","stop-opacity":.05},c),Ot("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},n)}return Ot("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},n),Ot("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},n),Ot("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},n),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=o.aS.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||ls.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;n!=="Space"&&n!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;const p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n,this._altitude);let d;t._showingGlobe()&&o.f4(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity="".concat(d),this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform="\n            translate(".concat(t.x,"px,").concat(t.y,"px)\n            ").concat(To[this._anchor],"\n            ").concat(this._calculateXYTransform()," ").concat(this._calculateZTransform(),"\n            translate(").concat(n.x,"px,").concat(n.y,"px)\n        ")}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||c!=="map")return"";if(!n._showingGlobe()){const x=n.getPitch();return x?"rotateX(".concat(x,"deg)"):""}const d=o.cW(o.f5(n.transform,this._lngLat)),p=t.sub(o.f6(n.transform)),m=Math.abs(p.x)+Math.abs(p.y);if(m===0)return"";const y=d/m;return"rotateX(".concat(-p.y*y,"deg) rotateY(").concat(p.x*y,"deg)")}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(n._showingGlobe()){const p=n.project(new o.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),m=n.project(new o.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(p);c=o.cW(Math.atan2(m.y,m.x))-90}else c=-n.getBearing();else if(d==="horizon"){const p=o.ah(4,6,n.getZoom()),m=o.f6(n.transform);m.y+=p*n.transform.height;const y=t.sub(m),x=o.cW(Math.atan2(y.y,y.x));c=(x>90?x-270:x+90)*(1-p)}return c+=this._rotation,c?"rotateZ(".concat(c,"deg)"):""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=Xo(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),n._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=o.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const p=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=n.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new o.z("dragstart"))),this.fire(new o.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new o.z("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||ls.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||ls.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||ls.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||ls.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const So={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Jm={maxWidth:100,unit:"metric"},Qm={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},e_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},t_=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function wd(l=new o.P(0,0),t="bottom"){if(typeof l=="number"){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new o.P(0,l);case"top-left":return new o.P(n,n);case"top-right":return new o.P(-n,n);case"bottom":return new o.P(0,-l);case"bottom-left":return new o.P(n,-n);case"bottom-right":return new o.P(-n,-n);case"left":return new o.P(l,0);case"right":return new o.P(-l,0)}return new o.P(0,0)}return l instanceof o.P||Array.isArray(l)?o.P.convert(l):o.P.convert(l[t]||[0,0])}return{version:Oe,supported:ai.supported,setRTLTextPlugin:o.fa,getRTLTextPluginStatus:o.f9,Map:class extends ko{constructor(l){It.mark($e.create);const t=l;if((l=Object.assign({},Lu,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&o.f2(window)&&(l.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Qa(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new dp,this._domRenderTaskQueue=new dp,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.b1(),this._locale=Object.assign({},Km,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Sc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new wr(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const n=document.getElementById(l.container);if(!n)throw new Error("Container '".concat(l.container.toString(),"' not found."));this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,o.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Hm),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new zu(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||o.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),l.hash&&(this._hash=new Su(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,Object.assign({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Il({customAttribution:l.customAttribution})),this._logoControl=new Tc,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()})),this.on("data",(n=>{this._update(n.dataType==="style"),this.fire(new o.z("".concat(n.dataType,"data"),n))})),this.on("dataloading",(n=>{this.fire(new o.z("".concat(n.dataType,"dataloading"),n))})),this._interactions=new vd(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new o.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new o.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new o.z("movestart",l)).fire(new o.z("move",l)),this.fire(new o.z("resize",l)),t&&this.fire(new o.z("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(o.aI.convert(l)),this._update()}setMinZoom(l){if((l=l!=null?l:-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l!=null?l:22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l!=null?l:0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l!=null?l:85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((t=>t.type==="symbol")),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map((t=>t==="auto"?navigator.language:t)):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let n;t==="globe"&&l.zoom>=o.cK?(l.setMercatorFromTransition(),n=!0):t==="mercator"&&l.zoom<o.cK&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;const n=this.transform.mercatorFromTransition;t=l.name==="globe"&&this.transform.zoom>=o.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate();const c=this.transform.getProjection().name==="mercator"&&n!==this.transform.mercatorFromTransition;return(t||c)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(o.aS.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(o.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=d=>{let p=[];if(Array.isArray(t)){const m=t.filter((y=>this.getLayer(y)));p=m.length?this.queryRenderedFeatures(d,{layers:m}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:m=>{const y=c(m.point);y.length?d||(d=!0,n.call(this,new zr(l,this,m.originalEvent,{features:y}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:y=>{c(y.point).length?d=!0:d&&(d=!1,n.call(this,new zr(l,this,y.originalEvent)))},mouseout:y=>{d&&(d=!1,n.call(this,new zr(l,this,y.originalEvent)))}}}}{const d=p=>{const m=c(p.point);m.length&&(p.features=m,n.call(this,p),delete p.features)};return{listener:n,targets:t,delegates:{[l]:d}}}}on(l,t,n){if(typeof t=="function"||n===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,n){if(typeof t=="function"||n===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,n){if(typeof t=="function"||n===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){const m=d[p];if(m.listener===n&&bd(m.targets,t)){for(const y in m.delegates)this.off(y,m.delegates[y]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof o.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const p=this.style.queryRenderedFeatures(l,void 0,this.transform),m=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(m)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}queryRasterValue(l,t,n){return this._isValidId(l)?this.style.queryRasterValue(l,t,n):Promise.resolve(null)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&o.w("".concat(t," projection does not support isPointOnSurface, this API may behave unexpectedly.")),this.transform.isPointOnSurface(o.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,((n,c)=>{if(n){const d=typeof n=="string"?n:n instanceof Error?n.message:n.error;o.w("Unable to perform style diff: ".concat(d,". Rebuilding the style from scratch.")),this._updateStyle(l,t)}else c&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error("Missing UI string '".concat(l,"'"));return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=Object.assign({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new _o(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new _o(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new o.y(new Error("IDs can't be empty."))),!1):!o.dq(l)||(this.fire(new o.y(new Error("IDs can't contain special symbols: \"".concat(l,'".')))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:d,stretchY:p,content:m}={}){this._lazyInitEmptyStyle();const y=o.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:x,height:T,data:S}=o.o.getImageData(t);this.style.addImage(y,{data:new o.q({width:x,height:T},S),pixelRatio:n,stretchX:d,stretchY:p,content:m,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new o.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:x,height:T}=t,S=t;this.style.addImage(y,{data:new o.q({width:x,height:T},new Uint8Array(S.data)),pixelRatio:n,stretchX:d,stretchY:p,content:m,sdf:c,usvg:!1,version:0,userImage:S}),S.onAdd&&S.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=o.I.from(l),c=this.style.getImage(n);if(!c)return void this.fire(new o.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?o.o.getImageData(t):t,{width:p,height:m,data:y}=d;if(p===void 0||m===void 0)return void this.fire(new o.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||m!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new o.y(new Error("The width and height of the updated image (".concat(p,", ").concat(m,")\n                must be that same as the previous version of the image\n                (").concat(c.data.width,", ").concat(c.data.height,")"))));const x=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let T=!1;c.usvg?(c.data=new o.q({width:p,height:m},new Uint8Array(y)),c.usvg=!1,c.icon=void 0,T=!0):c.data.replace(y,x),this.style.updateImage(n,c,T)}hasImage(l){return l?!!this.style&&!!this.style.getImage(o.I.from(l)):(this.fire(new o.y(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(o.I.from(l))}loadImage(l,t){o.n(this._requestManager.transformRequest(l,o.R.Image),((n,c)=>{t(n,c instanceof HTMLImageElement?o.o.getImageData(c):c)}))}listImages(){return this.style.listImages().map((l=>l.name))}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new o.y(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch((n=>this.fire(new o.y(new Error("Failed to add import",n))))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}setLayerProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayerProperty(l,t,n,c),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.aS.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_setIndoorActiveFloorsVisibility(l){this.indoor.setActiveFloorsVisibility(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new xd),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,d,p=this._container;for(;p&&(!c||!d);){const m=window.getComputedStyle(p).transform;m&&m!=="none"&&(n=m.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&n[0]!=="0"&&n[0]!=="1"&&(c=n[0]),n[3]&&n[3]!=="0"&&n[3]!=="1"&&(d=n[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new Ca(this.style),this.on("load",(()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})),this.on("idle",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}))})))}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=_t("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=_t("div","mapboxgl-canvas-container",l);this._canvas=_t("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=_t("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((d=>{c[d]=_t("div","mapboxgl-ctrl-".concat(d),n)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=o.o.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width="".concat(l,"px"),this._canvas.style.height="".concat(t,"px")}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=Object.assign({},ai.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(os(t,!0),this.painter=new fa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",(n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)})),o.k.testSupport(t)):this.fire(new o.y(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.z("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new o.z("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new o.z("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=o.o.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const T=this.transform.zoom,S=this.transform.pitch,M=o.o.now(),E=new o.ac(T,{now:M,fadeDuration:p,pitch:S,transition:this.style.transition,worldview:this._worldview});this.style.update(E)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let m=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),m=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):m=this._updateAverageElevation(c);const y=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),y&&(this._placementDirty=y.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,It.mark($e.load),this.fire(new o.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const T=o.o.now()-c;d.endQuery(n.TIME_ELAPSED_EXT),setTimeout((()=>{const S=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new o.z("gpu-timing-frame",{cpuTime:T,gpuTime:S}))}),50)}if(this.listens("gpu-timing-layer")){const T=this.painter.collectGpuTimers();setTimeout((()=>{const S=this.painter.queryGpuTimers(T);this.fire(new o.z("gpu-timing-layer",{layerTimes:S}))}),50)}if(this.listens("gpu-timing-deferred-render")){const T=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const S=this.painter.queryGpuTimeDeferredRender(T);this.fire(new o.z("gpu-timing-deferred-render",{gpuTime:S}))}),50)}const x=this._sourcesDirty||this._styleDirty||this._placementDirty||m;if(x||this._repaint)this.triggerRepaint();else{const T=this.idle();if(T&&(m=this._updateAverageElevation(c,!0)),m)this.triggerRepaint();else if(this._triggerFrame(!1),T&&(this.fire(new o.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const S=this._calculateSpeedIndex();this.fire(new o.z("speedindexcompleted",{speedIndex:S})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||x||(this._fullyLoaded=!0,It.mark($e.fullLoad),this._performanceMetricsCollection&&Qi(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const d=this.transform.averageElevation;let p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;const m=Math.abs(d-p);if(m>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),n(p);this._averageElevation.easeTo(p,l,300)}else if(m>1e-4)return this._averageElevation.jumpTo(p),n(p)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){Xn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(l=>{if(l&&(l.message===Pt||l.status===401)){const t=this.painter.context.gl;os(t,!1),this._logoControl instanceof Tc&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),ns(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&xn(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&ss(this._requestManager._customAccessToken)}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function d(p){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,p,0);const m=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,m),m}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const d=l.length/4;for(let p=0;p<t.length;p++){const m=t[p];let y=0;for(let x=0;x<m.length;x+=4)m[x]===l[x]&&m[x+1]===l[x+1]&&m[x+2]===l[x+2]&&m[x+3]===l[x+3]&&(y+=1);c+=(n[p+2]-n[p+1])*(1-y/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),dr.delete(this.painter.context.gl),Fr.remove(),Xi.remove(),this._removed=!0,this.fire(new o.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=o.o.frame((t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)})))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return o.bv(t,((n,c)=>n._preloadTiles(l,c)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){o.f3(l,t)}get version(){return Oe}},NavigationControl:class{constructor(l={}){this.options=Object.assign({},Ou,l),this._container=_t("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(o.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(t=>{this._map&&this._map.zoomIn({},{originalEvent:t})})),_t("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(t=>{this._map&&this._map.zoomOut({},{originalEvent:t})})),_t("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))})),this._compassIcon=_t("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?"scale(".concat(1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5),") rotateX(").concat(l.transform.pitch,"deg) rotateZ(").concat(l.transform.angle*(180/Math.PI),"deg)"):"rotate(".concat(l.transform.angle*(180/Math.PI),"deg)");l._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ec(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=_t("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString("NavigationControl.".concat(t));l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends o.E{constructor(l={}){super();const t=navigator.geolocation;this.options=Object.assign({geolocation:t},So,l),o.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ba(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=_t("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then((n=>t(n.state!=="denied"))).catch((()=>t())):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new o.z("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("geolocate",Object.assign({coords:l.coords,timestamp:l.timestamp},l.toJSON?{toJSON:l.toJSON.bind(l)}:{}))),this._finish()}}_updateCamera(l){const t=new o.aS(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),d=Object.assign({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),d,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new o.aS(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=o.ce(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width="".concat(n,"px"),this._circleElement.style.height="".concat(n,"px")}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=_t("button","mapboxgl-ctrl-geolocate",this._container),_t("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=_t("div","mapboxgl-user-location"),this._dotElement.appendChild(_t("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(_t("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Yo({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=_t("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Yo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.z("trackuserlocationend")))}))}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then((t=>{t==="granted"&&l()})).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Il,ScaleControl:class{constructor(l={}){this.options=Object.assign({},Jm,l),this._isNumberFormatSupported=(function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(t){return!1}})(),o.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,n]),p=t.unproject([c+l,n]),m=d.distanceTo(p);if(this.options.unit==="imperial"){const y=3.2808*m;y>5280?this._setScale(l,y/5280,"mile"):this._setScale(l,y,"foot")}else this.options.unit==="nautical"?this._setScale(l,m/1852,"nautical-mile"):m>=1e3?this._setScale(l,m/1e3,"kilometer"):this._setScale(l,m,"meter")}_setScale(l,t,n){this._map._requestDomTask((()=>{const c=(function(p){const m=Math.pow(10,"".concat(Math.floor(p)).length-1);let y=p/m;return y=y>=10?10:y>=5?5:y>=3?3:y>=2?2:y>=1?1:(function(x){const T=Math.pow(10,Math.ceil(-Math.log(x)/Math.LN10));return Math.round(x*T)/T})(y),m*y})(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&n!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):"".concat(c,"&nbsp;").concat(Qm[n]),this._container.style.width=l*d+"px"}))}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=_t("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:o.w("Full screen control 'container' must be a DOM element.")),o.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=_t("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=_t("button","mapboxgl-ctrl-fullscreen",this._controlContainer);_t("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:xd,Popup:class extends o.E{constructor(l){super(),this.options=Object.assign(Object.create(e_),l),this._altitude=this.options.altitude,o.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new o.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new o.z("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=o.aS.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=_t("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=_t("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const d=n.offsetWidth,p=n.offsetHeight,m=c.x<d/2,y=c.x>t.transform.width-d/2;if(c.y+l<p)return m?"top-left":y?"top-right":"top";if(c.y>t.transform.height-p){if(m)return"bottom-left";if(y)return"bottom-right"}return m?"left":y?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push("mapboxgl-popup-anchor-".concat(this._anchor)),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=_t("div","mapboxgl-popup",t.getContainer()),this._tip=_t("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Xo(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const d=this._pos=this._trackPointer&&l instanceof o.P?l:t.project(this._lngLat,this._altitude),p=wd(this.options.offset),m=this._anchor=this._getAnchor(p.y),y=wd(this.options.offset,m),x=d.add(y).round();t._requestDomTask((()=>{this._container&&m&&(this._container.style.transform="".concat(To[m]," translate(").concat(x.x,"px,").concat(x.y,"px)"))}))}if(!this._marker&&t._showingGlobe()){const d=o.f4(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(t_);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity="".concat(l)),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:Yo,Style:_o,LngLat:o.aS,LngLatBounds:o.aI,Point:o.P,MercatorCoordinate:o.ae,FreeCameraOptions:zo,Evented:o.E,config:o.e,prewarm:o.f8,clearPrewarmedResources:o.f7,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(l){o.e.ACCESS_TOKEN=l},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(l){o.e.API_URL=l},get workerCount(){return o.fh.workerCount},set workerCount(l){o.fh.workerCount=l},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){o.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){o.fg(l)},get workerUrl(){return o.ff.workerUrl},set workerUrl(l){o.ff.workerUrl=l},get workerClass(){return o.ff.workerClass},set workerClass(l){o.ff.workerClass=l},get workerParams(){return o.ff.workerParams},set workerParams(l){o.ff.workerParams=l},get dracoUrl(){return o.fe()},set dracoUrl(l){o.fd(l)},get meshoptUrl(){return o.fc()},set meshoptUrl(l){o.fb(l)},setNow:o.o.setNow,restoreNow:o.o.restoreNow}}));var tt=Ie;return tt}))})(hm)),hm.exports}nS();const _m=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";function oh(z){const C=Object.prototype.toString.call(z);return C==="[object Window]"||C==="[object global]"}function kg(z){return"nodeType"in z}function wo(z){var C,$;return z?oh(z)?z:kg(z)&&(C=($=z.ownerDocument)==null?void 0:$.defaultView)!=null?C:window:window}function Fg(z){const{Document:C}=wo(z);return z instanceof C}function gf(z){return oh(z)?!1:z instanceof wo(z).HTMLElement}function mb(z){return z instanceof wo(z).SVGElement}function ah(z){return z?oh(z)?z.document:kg(z)?Fg(z)?z:gf(z)||mb(z)?z.ownerDocument:document:document:document}const Nl=_m?Ke.useLayoutEffect:Ke.useEffect;function Bg(z){const C=Ke.useRef(z);return Nl(()=>{C.current=z}),Ke.useCallback(function(){for(var $=arguments.length,ue=new Array($),Ie=0;Ie<$;Ie++)ue[Ie]=arguments[Ie];return C.current==null?void 0:C.current(...ue)},[])}function sS(){const z=Ke.useRef(null),C=Ke.useCallback((ue,Ie)=>{z.current=setInterval(ue,Ie)},[]),$=Ke.useCallback(()=>{z.current!==null&&(clearInterval(z.current),z.current=null)},[]);return[C,$]}function Ng(z,C){C===void 0&&(C=[z]);const $=Ke.useRef(z);return Nl(()=>{$.current!==z&&($.current=z)},C),$}function yf(z,C){const $=Ke.useRef();return Ke.useMemo(()=>{const ue=z($.current);return $.current=ue,ue},[...C])}function Mg(z){const C=Bg(z),$=Ke.useRef(null),ue=Ke.useCallback(Ie=>{Ie!==$.current&&(C==null||C(Ie,$.current)),$.current=Ie},[]);return[$,ue]}function Cg(z){const C=Ke.useRef();return Ke.useEffect(()=>{C.current=z},[z]),C.current}let Sg={};function Vg(z,C){return Ke.useMemo(()=>{if(C)return C;const $=Sg[z]==null?0:Sg[z]+1;return Sg[z]=$,z+"-"+$},[z,C])}function _b(z){return function(C){for(var $=arguments.length,ue=new Array($>1?$-1:0),Ie=1;Ie<$;Ie++)ue[Ie-1]=arguments[Ie];return ue.reduce((ve,tt)=>{const o=Object.entries(tt);for(const[Oe,$e]of o){const It=ve[Oe];It!=null&&(ve[Oe]=It+z*$e)}return ve},Pr({},C))}}const sh=_b(1),fm=_b(-1);function oS(z){return"clientX"in z&&"clientY"in z}function gb(z){if(!z)return!1;const{KeyboardEvent:C}=wo(z.target);return C&&z instanceof C}function aS(z){if(!z)return!1;const{TouchEvent:C}=wo(z.target);return C&&z instanceof C}function Pg(z){if(aS(z)){if(z.touches&&z.touches.length){const{clientX:C,clientY:$}=z.touches[0];return{x:C,y:$}}else if(z.changedTouches&&z.changedTouches.length){const{clientX:C,clientY:$}=z.changedTouches[0];return{x:C,y:$}}}return oS(z)?{x:z.clientX,y:z.clientY}:null}const K0="a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";function lS(z){return z.matches(K0)?z:z.querySelector(K0)}const cS={display:"none"};function uS(z){let{id:C,value:$}=z;return ao.createElement("div",{id:C,style:cS},$)}function hS(z){let{id:C,announcement:$,ariaLiveType:ue="assertive"}=z;const Ie={position:"fixed",top:0,left:0,width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0 0 0 0)",clipPath:"inset(100%)",whiteSpace:"nowrap"};return ao.createElement("div",{id:C,style:Ie,role:"status","aria-live":ue,"aria-atomic":!0},$)}function dS(){const[z,C]=Ke.useState("");return{announce:Ke.useCallback(ue=>{ue!=null&&C(ue)},[]),announcement:z}}const yb=Ke.createContext(null);function fS(z){const C=Ke.useContext(yb);Ke.useEffect(()=>{if(!C)throw new Error("useDndMonitor must be used within a children of <DndContext>");return C(z)},[z,C])}function pS(){const[z]=Ke.useState(()=>new Set),C=Ke.useCallback(ue=>(z.add(ue),()=>z.delete(ue)),[z]);return[Ke.useCallback(ue=>{let{type:Ie,event:ve}=ue;z.forEach(tt=>{var o;return(o=tt[Ie])==null?void 0:o.call(tt,ve)})},[z]),C]}const mS={draggable:"\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  "},_S={onDragStart(z){let{active:C}=z;return"Picked up draggable item "+C.id+"."},onDragOver(z){let{active:C,over:$}=z;return $?"Draggable item "+C.id+" was moved over droppable area "+$.id+".":"Draggable item "+C.id+" is no longer over a droppable area."},onDragEnd(z){let{active:C,over:$}=z;return $?"Draggable item "+C.id+" was dropped over droppable area "+$.id:"Draggable item "+C.id+" was dropped."},onDragCancel(z){let{active:C}=z;return"Dragging was cancelled. Draggable item "+C.id+" was dropped."}};function gS(z){let{announcements:C=_S,container:$,hiddenTextDescribedById:ue,screenReaderInstructions:Ie=mS}=z;const{announce:ve,announcement:tt}=dS(),o=Vg("DndLiveRegion"),[Oe,$e]=Ke.useState(!1);if(Ke.useEffect(()=>{$e(!0)},[]),fS(Ke.useMemo(()=>({onDragStart(lt){let{active:Tt}=lt;ve(C.onDragStart({active:Tt}))},onDragMove(lt){let{active:Tt,over:Rt}=lt;C.onDragMove&&ve(C.onDragMove({active:Tt,over:Rt}))},onDragOver(lt){let{active:Tt,over:Rt}=lt;ve(C.onDragOver({active:Tt,over:Rt}))},onDragEnd(lt){let{active:Tt,over:Rt}=lt;ve(C.onDragEnd({active:Tt,over:Rt}))},onDragCancel(lt){let{active:Tt,over:Rt}=lt;ve(C.onDragCancel({active:Tt,over:Rt}))}}),[ve,C])),!Oe)return null;const It=ao.createElement(ao.Fragment,null,ao.createElement(uS,{id:ue,value:Ie.draggable}),ao.createElement(hS,{id:o,announcement:tt}));return $?hf.createPortal(It,$):It}var Gs;(function(z){z.DragStart="dragStart",z.DragMove="dragMove",z.DragEnd="dragEnd",z.DragCancel="dragCancel",z.DragOver="dragOver",z.RegisterDroppable="registerDroppable",z.SetDroppableDisabled="setDroppableDisabled",z.UnregisterDroppable="unregisterDroppable"})(Gs||(Gs={}));function pm(){}function yS(z,C){return Ke.useMemo(()=>({sensor:z,options:C!=null?C:{}}),[z,C])}function xS(){for(var z=arguments.length,C=new Array(z),$=0;$<z;$++)C[$]=arguments[$];return Ke.useMemo(()=>[...C].filter(ue=>ue!=null),[...C])}const ra=Object.freeze({x:0,y:0});function vS(z,C){let{data:{value:$}}=z,{data:{value:ue}}=C;return ue-$}function bS(z,C){if(!z||z.length===0)return null;const[$]=z;return $[C]}function wS(z,C){const $=Math.max(C.top,z.top),ue=Math.max(C.left,z.left),Ie=Math.min(C.left+C.width,z.left+z.width),ve=Math.min(C.top+C.height,z.top+z.height),tt=Ie-ue,o=ve-$;if(ue<Ie&&$<ve){const Oe=C.width*C.height,$e=z.width*z.height,It=tt*o,lt=It/(Oe+$e-It);return Number(lt.toFixed(4))}return 0}const TS=z=>{let{collisionRect:C,droppableRects:$,droppableContainers:ue}=z;const Ie=[];for(const ve of ue){const{id:tt}=ve,o=$.get(tt);if(o){const Oe=wS(o,C);Oe>0&&Ie.push({id:tt,data:{droppableContainer:ve,value:Oe}})}}return Ie.sort(vS)};function SS(z,C,$){return gn(Pr({},z),{scaleX:C&&$?C.width/$.width:1,scaleY:C&&$?C.height/$.height:1})}function xb(z,C){return z&&C?{x:z.left-C.left,y:z.top-C.top}:ra}function ES(z){return function($){for(var ue=arguments.length,Ie=new Array(ue>1?ue-1:0),ve=1;ve<ue;ve++)Ie[ve-1]=arguments[ve];return Ie.reduce((tt,o)=>gn(Pr({},tt),{top:tt.top+z*o.y,bottom:tt.bottom+z*o.y,left:tt.left+z*o.x,right:tt.right+z*o.x}),Pr({},$))}}const IS=ES(1);function AS(z){if(z.startsWith("matrix3d(")){const C=z.slice(9,-1).split(/, /);return{x:+C[12],y:+C[13],scaleX:+C[0],scaleY:+C[5]}}else if(z.startsWith("matrix(")){const C=z.slice(7,-1).split(/, /);return{x:+C[4],y:+C[5],scaleX:+C[0],scaleY:+C[3]}}return null}function MS(z,C,$){const ue=AS(C);if(!ue)return z;const{scaleX:Ie,scaleY:ve,x:tt,y:o}=ue,Oe=z.left-tt-(1-Ie)*parseFloat($),$e=z.top-o-(1-ve)*parseFloat($.slice($.indexOf(" ")+1)),It=Ie?z.width/Ie:z.width,lt=ve?z.height/ve:z.height;return{width:It,height:lt,top:$e,right:Oe+It,bottom:$e+lt,left:Oe}}const CS={ignoreTransform:!1};function xf(z,C){C===void 0&&(C=CS);let $=z.getBoundingClientRect();if(C.ignoreTransform){const{transform:$e,transformOrigin:It}=wo(z).getComputedStyle(z);$e&&($=MS($,$e,It))}const{top:ue,left:Ie,width:ve,height:tt,bottom:o,right:Oe}=$;return{top:ue,left:Ie,width:ve,height:tt,bottom:o,right:Oe}}function J0(z){return xf(z,{ignoreTransform:!0})}function PS(z){const C=z.innerWidth,$=z.innerHeight;return{top:0,left:0,right:C,bottom:$,width:C,height:$}}function RS(z,C){return C===void 0&&(C=wo(z).getComputedStyle(z)),C.position==="fixed"}function DS(z,C){C===void 0&&(C=wo(z).getComputedStyle(z));const $=/(auto|scroll|overlay)/;return["overflow","overflowX","overflowY"].some(Ie=>{const ve=C[Ie];return typeof ve=="string"?$.test(ve):!1})}function Ug(z,C){const $=[];function ue(Ie){if(C!=null&&$.length>=C||!Ie)return $;if(Fg(Ie)&&Ie.scrollingElement!=null&&!$.includes(Ie.scrollingElement))return $.push(Ie.scrollingElement),$;if(!gf(Ie)||mb(Ie)||$.includes(Ie))return $;const ve=wo(z).getComputedStyle(Ie);return Ie!==z&&DS(Ie,ve)&&$.push(Ie),RS(Ie,ve)?$:ue(Ie.parentNode)}return z?ue(z):$}function vb(z){const[C]=Ug(z,1);return C!=null?C:null}function Eg(z){return!_m||!z?null:oh(z)?z:kg(z)?Fg(z)||z===ah(z).scrollingElement?window:gf(z)?z:null:null}function bb(z){return oh(z)?z.scrollX:z.scrollLeft}function wb(z){return oh(z)?z.scrollY:z.scrollTop}function Rg(z){return{x:bb(z),y:wb(z)}}var Ss;(function(z){z[z.Forward=1]="Forward",z[z.Backward=-1]="Backward"})(Ss||(Ss={}));function Tb(z){return!_m||!z?!1:z===document.scrollingElement}function Sb(z){const C={x:0,y:0},$=Tb(z)?{height:window.innerHeight,width:window.innerWidth}:{height:z.clientHeight,width:z.clientWidth},ue={x:z.scrollWidth-$.width,y:z.scrollHeight-$.height},Ie=z.scrollTop<=C.y,ve=z.scrollLeft<=C.x,tt=z.scrollTop>=ue.y,o=z.scrollLeft>=ue.x;return{isTop:Ie,isLeft:ve,isBottom:tt,isRight:o,maxScroll:ue,minScroll:C}}const zS={x:.2,y:.2};function LS(z,C,$,ue,Ie){let{top:ve,left:tt,right:o,bottom:Oe}=$;ue===void 0&&(ue=10),Ie===void 0&&(Ie=zS);const{isTop:$e,isBottom:It,isLeft:lt,isRight:Tt}=Sb(z),Rt={x:0,y:0},ai={x:0,y:0},_t={height:C.height*Ie.y,width:C.width*Ie.x};return!$e&&ve<=C.top+_t.height?(Rt.y=Ss.Backward,ai.y=ue*Math.abs((C.top+_t.height-ve)/_t.height)):!It&&Oe>=C.bottom-_t.height&&(Rt.y=Ss.Forward,ai.y=ue*Math.abs((C.bottom-_t.height-Oe)/_t.height)),!Tt&&o>=C.right-_t.width?(Rt.x=Ss.Forward,ai.x=ue*Math.abs((C.right-_t.width-o)/_t.width)):!lt&&tt<=C.left+_t.width&&(Rt.x=Ss.Backward,ai.x=ue*Math.abs((C.left+_t.width-tt)/_t.width)),{direction:Rt,speed:ai}}function OS(z){if(z===document.scrollingElement){const{innerWidth:ve,innerHeight:tt}=window;return{top:0,left:0,right:ve,bottom:tt,width:ve,height:tt}}const{top:C,left:$,right:ue,bottom:Ie}=z.getBoundingClientRect();return{top:C,left:$,right:ue,bottom:Ie,width:z.clientWidth,height:z.clientHeight}}function Eb(z){return z.reduce((C,$)=>sh(C,Rg($)),ra)}function kS(z){return z.reduce((C,$)=>C+bb($),0)}function FS(z){return z.reduce((C,$)=>C+wb($),0)}function BS(z,C){if(C===void 0&&(C=xf),!z)return;const{top:$,left:ue,bottom:Ie,right:ve}=C(z);vb(z)&&(Ie<=0||ve<=0||$>=window.innerHeight||ue>=window.innerWidth)&&z.scrollIntoView({block:"center",inline:"center"})}const NS=[["x",["left","right"],kS],["y",["top","bottom"],FS]];class jg{constructor(C,$){this.rect=void 0,this.width=void 0,this.height=void 0,this.top=void 0,this.bottom=void 0,this.right=void 0,this.left=void 0;const ue=Ug($),Ie=Eb(ue);this.rect=Pr({},C),this.width=C.width,this.height=C.height;for(const[ve,tt,o]of NS)for(const Oe of tt)Object.defineProperty(this,Oe,{get:()=>{const $e=o(ue),It=Ie[ve]-$e;return this.rect[Oe]+It},enumerable:!0});Object.defineProperty(this,"rect",{enumerable:!1})}}class df{constructor(C){this.target=void 0,this.listeners=[],this.removeAll=()=>{this.listeners.forEach($=>{var ue;return(ue=this.target)==null?void 0:ue.removeEventListener(...$)})},this.target=C}add(C,$,ue){var Ie;(Ie=this.target)==null||Ie.addEventListener(C,$,ue),this.listeners.push([C,$,ue])}}function VS(z){const{EventTarget:C}=wo(z);return z instanceof C?z:ah(z)}function Ig(z,C){const $=Math.abs(z.x),ue=Math.abs(z.y);return typeof C=="number"?Math.sqrt($**2+ue**2)>C:"x"in C&&"y"in C?$>C.x&&ue>C.y:"x"in C?$>C.x:"y"in C?ue>C.y:!1}var No;(function(z){z.Click="click",z.DragStart="dragstart",z.Keydown="keydown",z.ContextMenu="contextmenu",z.Resize="resize",z.SelectionChange="selectionchange",z.VisibilityChange="visibilitychange"})(No||(No={}));function Q0(z){z.preventDefault()}function US(z){z.stopPropagation()}var yn;(function(z){z.Space="Space",z.Down="ArrowDown",z.Right="ArrowRight",z.Left="ArrowLeft",z.Up="ArrowUp",z.Esc="Escape",z.Enter="Enter",z.Tab="Tab"})(yn||(yn={}));const Ib={start:[yn.Space,yn.Enter],cancel:[yn.Esc],end:[yn.Space,yn.Enter,yn.Tab]},jS=(z,C)=>{let{currentCoordinates:$}=C;switch(z.code){case yn.Right:return gn(Pr({},$),{x:$.x+25});case yn.Left:return gn(Pr({},$),{x:$.x-25});case yn.Down:return gn(Pr({},$),{y:$.y+25});case yn.Up:return gn(Pr({},$),{y:$.y-25})}};class Ab{constructor(C){this.props=void 0,this.autoScrollEnabled=!1,this.referenceCoordinates=void 0,this.listeners=void 0,this.windowListeners=void 0,this.props=C;const{event:{target:$}}=C;this.props=C,this.listeners=new df(ah($)),this.windowListeners=new df(wo($)),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleCancel=this.handleCancel.bind(this),this.attach()}attach(){this.handleStart(),this.windowListeners.add(No.Resize,this.handleCancel),this.windowListeners.add(No.VisibilityChange,this.handleCancel),setTimeout(()=>this.listeners.add(No.Keydown,this.handleKeyDown))}handleStart(){const{activeNode:C,onStart:$}=this.props,ue=C.node.current;ue&&BS(ue),$(ra)}handleKeyDown(C){if(gb(C)){const{active:$,context:ue,options:Ie}=this.props,{keyboardCodes:ve=Ib,coordinateGetter:tt=jS,scrollBehavior:o="smooth"}=Ie,{code:Oe}=C;if(ve.end.includes(Oe)){this.handleEnd(C);return}if(ve.cancel.includes(Oe)){this.handleCancel(C);return}const{collisionRect:$e}=ue.current,It=$e?{x:$e.left,y:$e.top}:ra;this.referenceCoordinates||(this.referenceCoordinates=It);const lt=tt(C,{active:$,context:ue.current,currentCoordinates:It});if(lt){const Tt=fm(lt,It),Rt={x:0,y:0},{scrollableAncestors:ai}=ue.current;for(const _t of ai){const Ot=C.code,{isTop:li,isRight:Xt,isLeft:gi,isBottom:hi,maxScroll:Wi,minScroll:ci}=Sb(_t),yi=OS(_t),Ii={x:Math.min(Ot===yn.Right?yi.right-yi.width/2:yi.right,Math.max(Ot===yn.Right?yi.left:yi.left+yi.width/2,lt.x)),y:Math.min(Ot===yn.Down?yi.bottom-yi.height/2:yi.bottom,Math.max(Ot===yn.Down?yi.top:yi.top+yi.height/2,lt.y))},xr=Ot===yn.Right&&!Xt||Ot===yn.Left&&!gi,Lr=Ot===yn.Down&&!hi||Ot===yn.Up&&!li;if(xr&&Ii.x!==lt.x){const vr=_t.scrollLeft+Tt.x,mi=Ot===yn.Right&&vr<=Wi.x||Ot===yn.Left&&vr>=ci.x;if(mi&&!Tt.y){_t.scrollTo({left:vr,behavior:o});return}mi?Rt.x=_t.scrollLeft-vr:Rt.x=Ot===yn.Right?_t.scrollLeft-Wi.x:_t.scrollLeft-ci.x,Rt.x&&_t.scrollBy({left:-Rt.x,behavior:o});break}else if(Lr&&Ii.y!==lt.y){const vr=_t.scrollTop+Tt.y,mi=Ot===yn.Down&&vr<=Wi.y||Ot===yn.Up&&vr>=ci.y;if(mi&&!Tt.x){_t.scrollTo({top:vr,behavior:o});return}mi?Rt.y=_t.scrollTop-vr:Rt.y=Ot===yn.Down?_t.scrollTop-Wi.y:_t.scrollTop-ci.y,Rt.y&&_t.scrollBy({top:-Rt.y,behavior:o});break}}this.handleMove(C,sh(fm(lt,this.referenceCoordinates),Rt))}}}handleMove(C,$){const{onMove:ue}=this.props;C.preventDefault(),ue($)}handleEnd(C){const{onEnd:$}=this.props;C.preventDefault(),this.detach(),$()}handleCancel(C){const{onCancel:$}=this.props;C.preventDefault(),this.detach(),$()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll()}}Ab.activators=[{eventName:"onKeyDown",handler:(z,C,$)=>{let{keyboardCodes:ue=Ib,onActivation:Ie}=C,{active:ve}=$;const{code:tt}=z.nativeEvent;if(ue.start.includes(tt)){const o=ve.activatorNode.current;return o&&z.target!==o?!1:(z.preventDefault(),Ie==null||Ie({event:z.nativeEvent}),!0)}return!1}}];function eb(z){return!!(z&&"distance"in z)}function tb(z){return!!(z&&"delay"in z)}class Gg{constructor(C,$,ue){var Ie;ue===void 0&&(ue=VS(C.event.target)),this.props=void 0,this.events=void 0,this.autoScrollEnabled=!0,this.document=void 0,this.activated=!1,this.initialCoordinates=void 0,this.timeoutId=null,this.listeners=void 0,this.documentListeners=void 0,this.windowListeners=void 0,this.props=C,this.events=$;const{event:ve}=C,{target:tt}=ve;this.props=C,this.events=$,this.document=ah(tt),this.documentListeners=new df(this.document),this.listeners=new df(ue),this.windowListeners=new df(wo(tt)),this.initialCoordinates=(Ie=Pg(ve))!=null?Ie:ra,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.removeTextSelection=this.removeTextSelection.bind(this),this.attach()}attach(){const{events:C,props:{options:{activationConstraint:$,bypassActivationConstraint:ue}}}=this;if(this.listeners.add(C.move.name,this.handleMove,{passive:!1}),this.listeners.add(C.end.name,this.handleEnd),C.cancel&&this.listeners.add(C.cancel.name,this.handleCancel),this.windowListeners.add(No.Resize,this.handleCancel),this.windowListeners.add(No.DragStart,Q0),this.windowListeners.add(No.VisibilityChange,this.handleCancel),this.windowListeners.add(No.ContextMenu,Q0),this.documentListeners.add(No.Keydown,this.handleKeydown),$){if(ue!=null&&ue({event:this.props.event,activeNode:this.props.activeNode,options:this.props.options}))return this.handleStart();if(tb($)){this.timeoutId=setTimeout(this.handleStart,$.delay),this.handlePending($);return}if(eb($)){this.handlePending($);return}}this.handleStart()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll(),setTimeout(this.documentListeners.removeAll,50),this.timeoutId!==null&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handlePending(C,$){const{active:ue,onPending:Ie}=this.props;Ie(ue,C,this.initialCoordinates,$)}handleStart(){const{initialCoordinates:C}=this,{onStart:$}=this.props;C&&(this.activated=!0,this.documentListeners.add(No.Click,US,{capture:!0}),this.removeTextSelection(),this.documentListeners.add(No.SelectionChange,this.removeTextSelection),$(C))}handleMove(C){var $;const{activated:ue,initialCoordinates:Ie,props:ve}=this,{onMove:tt,options:{activationConstraint:o}}=ve;if(!Ie)return;const Oe=($=Pg(C))!=null?$:ra,$e=fm(Ie,Oe);if(!ue&&o){if(eb(o)){if(o.tolerance!=null&&Ig($e,o.tolerance))return this.handleCancel();if(Ig($e,o.distance))return this.handleStart()}if(tb(o)&&Ig($e,o.tolerance))return this.handleCancel();this.handlePending(o,$e);return}C.cancelable&&C.preventDefault(),tt(Oe)}handleEnd(){const{onAbort:C,onEnd:$}=this.props;this.detach(),this.activated||C(this.props.active),$()}handleCancel(){const{onAbort:C,onCancel:$}=this.props;this.detach(),this.activated||C(this.props.active),$()}handleKeydown(C){C.code===yn.Esc&&this.handleCancel()}removeTextSelection(){var C;(C=this.document.getSelection())==null||C.removeAllRanges()}}const GS={cancel:{name:"pointercancel"},move:{name:"pointermove"},end:{name:"pointerup"}};class Hg extends Gg{constructor(C){const{event:$}=C,ue=ah($.target);super(C,GS,ue)}}Hg.activators=[{eventName:"onPointerDown",handler:(z,C)=>{let{nativeEvent:$}=z,{onActivation:ue}=C;return!$.isPrimary||$.button!==0?!1:(ue==null||ue({event:$}),!0)}}];const HS={move:{name:"mousemove"},end:{name:"mouseup"}};var Dg;(function(z){z[z.RightClick=2]="RightClick"})(Dg||(Dg={}));class qS extends Gg{constructor(C){super(C,HS,ah(C.event.target))}}qS.activators=[{eventName:"onMouseDown",handler:(z,C)=>{let{nativeEvent:$}=z,{onActivation:ue}=C;return $.button===Dg.RightClick?!1:(ue==null||ue({event:$}),!0)}}];const Ag={cancel:{name:"touchcancel"},move:{name:"touchmove"},end:{name:"touchend"}};class $S extends Gg{constructor(C){super(C,Ag)}static setup(){return window.addEventListener(Ag.move.name,C,{capture:!1,passive:!1}),function(){window.removeEventListener(Ag.move.name,C)};function C(){}}}$S.activators=[{eventName:"onTouchStart",handler:(z,C)=>{let{nativeEvent:$}=z,{onActivation:ue}=C;const{touches:Ie}=$;return Ie.length>1?!1:(ue==null||ue({event:$}),!0)}}];var ff;(function(z){z[z.Pointer=0]="Pointer",z[z.DraggableRect=1]="DraggableRect"})(ff||(ff={}));var mm;(function(z){z[z.TreeOrder=0]="TreeOrder",z[z.ReversedTreeOrder=1]="ReversedTreeOrder"})(mm||(mm={}));function ZS(z){let{acceleration:C,activator:$=ff.Pointer,canScroll:ue,draggingRect:Ie,enabled:ve,interval:tt=5,order:o=mm.TreeOrder,pointerCoordinates:Oe,scrollableAncestors:$e,scrollableAncestorRects:It,delta:lt,threshold:Tt}=z;const Rt=XS({delta:lt,disabled:!ve}),[ai,_t]=sS(),Ot=Ke.useRef({x:0,y:0}),li=Ke.useRef({x:0,y:0}),Xt=Ke.useMemo(()=>{switch($){case ff.Pointer:return Oe?{top:Oe.y,bottom:Oe.y,left:Oe.x,right:Oe.x}:null;case ff.DraggableRect:return Ie}},[$,Ie,Oe]),gi=Ke.useRef(null),hi=Ke.useCallback(()=>{const ci=gi.current;if(!ci)return;const yi=Ot.current.x*li.current.x,Ii=Ot.current.y*li.current.y;ci.scrollBy(yi,Ii)},[]),Wi=Ke.useMemo(()=>o===mm.TreeOrder?[...$e].reverse():$e,[o,$e]);Ke.useEffect(()=>{if(!ve||!$e.length||!Xt){_t();return}for(const ci of Wi){if((ue==null?void 0:ue(ci))===!1)continue;const yi=$e.indexOf(ci),Ii=It[yi];if(!Ii)continue;const{direction:xr,speed:Lr}=LS(ci,Ii,Xt,C,Tt);for(const vr of["x","y"])Rt[vr][xr[vr]]||(Lr[vr]=0,xr[vr]=0);if(Lr.x>0||Lr.y>0){_t(),gi.current=ci,ai(hi,tt),Ot.current=Lr,li.current=xr;return}}Ot.current={x:0,y:0},li.current={x:0,y:0},_t()},[C,hi,ue,_t,ve,tt,JSON.stringify(Xt),JSON.stringify(Rt),ai,$e,Wi,It,JSON.stringify(Tt)])}const WS={x:{[Ss.Backward]:!1,[Ss.Forward]:!1},y:{[Ss.Backward]:!1,[Ss.Forward]:!1}};function XS(z){let{delta:C,disabled:$}=z;const ue=Cg(C);return yf(Ie=>{if($||!ue||!Ie)return WS;const ve={x:Math.sign(C.x-ue.x),y:Math.sign(C.y-ue.y)};return{x:{[Ss.Backward]:Ie.x[Ss.Backward]||ve.x===-1,[Ss.Forward]:Ie.x[Ss.Forward]||ve.x===1},y:{[Ss.Backward]:Ie.y[Ss.Backward]||ve.y===-1,[Ss.Forward]:Ie.y[Ss.Forward]||ve.y===1}}},[$,C,ue])}function YS(z,C){const $=C!=null?z.get(C):void 0,ue=$?$.node.current:null;return yf(Ie=>{var ve;return C==null?null:(ve=ue!=null?ue:Ie)!=null?ve:null},[ue,C])}function KS(z,C){return Ke.useMemo(()=>z.reduce(($,ue)=>{const{sensor:Ie}=ue,ve=Ie.activators.map(tt=>({eventName:tt.eventName,handler:C(tt.handler,ue)}));return[...$,...ve]},[]),[z,C])}var _f;(function(z){z[z.Always=0]="Always",z[z.BeforeDragging=1]="BeforeDragging",z[z.WhileDragging=2]="WhileDragging"})(_f||(_f={}));var zg;(function(z){z.Optimized="optimized"})(zg||(zg={}));const ib=new Map;function JS(z,C){let{dragging:$,dependencies:ue,config:Ie}=C;const[ve,tt]=Ke.useState(null),{frequency:o,measure:Oe,strategy:$e}=Ie,It=Ke.useRef(z),lt=Ot(),Tt=Ng(lt),Rt=Ke.useCallback(function(li){li===void 0&&(li=[]),!Tt.current&&tt(Xt=>Xt===null?li:Xt.concat(li.filter(gi=>!Xt.includes(gi))))},[Tt]),ai=Ke.useRef(null),_t=yf(li=>{if(lt&&!$)return ib;if(!li||li===ib||It.current!==z||ve!=null){const Xt=new Map;for(let gi of z){if(!gi)continue;if(ve&&ve.length>0&&!ve.includes(gi.id)&&gi.rect.current){Xt.set(gi.id,gi.rect.current);continue}const hi=gi.node.current,Wi=hi?new jg(Oe(hi),hi):null;gi.rect.current=Wi,Wi&&Xt.set(gi.id,Wi)}return Xt}return li},[z,ve,$,lt,Oe]);return Ke.useEffect(()=>{It.current=z},[z]),Ke.useEffect(()=>{lt||Rt()},[$,lt]),Ke.useEffect(()=>{ve&&ve.length>0&&tt(null)},[JSON.stringify(ve)]),Ke.useEffect(()=>{lt||typeof o!="number"||ai.current!==null||(ai.current=setTimeout(()=>{Rt(),ai.current=null},o))},[o,lt,Rt,...ue]),{droppableRects:_t,measureDroppableContainers:Rt,measuringScheduled:ve!=null};function Ot(){switch($e){case _f.Always:return!1;case _f.BeforeDragging:return $;default:return!$}}}function Mb(z,C){return yf($=>z?$||(typeof C=="function"?C(z):z):null,[C,z])}function QS(z,C){return Mb(z,C)}function eE(z){let{callback:C,disabled:$}=z;const ue=Bg(C),Ie=Ke.useMemo(()=>{if($||typeof window>"u"||typeof window.MutationObserver>"u")return;const{MutationObserver:ve}=window;return new ve(ue)},[ue,$]);return Ke.useEffect(()=>()=>Ie==null?void 0:Ie.disconnect(),[Ie]),Ie}function qg(z){let{callback:C,disabled:$}=z;const ue=Bg(C),Ie=Ke.useMemo(()=>{if($||typeof window>"u"||typeof window.ResizeObserver>"u")return;const{ResizeObserver:ve}=window;return new ve(ue)},[$]);return Ke.useEffect(()=>()=>Ie==null?void 0:Ie.disconnect(),[Ie]),Ie}function tE(z){return new jg(xf(z),z)}function rb(z,C,$){C===void 0&&(C=tE);const[ue,Ie]=Ke.useState(null);function ve(){Ie(Oe=>{if(!z)return null;if(z.isConnected===!1){var $e;return($e=Oe!=null?Oe:$)!=null?$e:null}const It=C(z);return JSON.stringify(Oe)===JSON.stringify(It)?Oe:It})}const tt=eE({callback(Oe){if(z)for(const $e of Oe){const{type:It,target:lt}=$e;if(It==="childList"&&lt instanceof HTMLElement&&lt.contains(z)){ve();break}}}}),o=qg({callback:ve});return Nl(()=>{ve(),z?(o==null||o.observe(z),tt==null||tt.observe(document.body,{childList:!0,subtree:!0})):(o==null||o.disconnect(),tt==null||tt.disconnect())},[z]),ue}function iE(z){const C=Mb(z);return xb(z,C)}const nb=[];function rE(z){const C=Ke.useRef(z),$=yf(ue=>z?ue&&ue!==nb&&z&&C.current&&z.parentNode===C.current.parentNode?ue:Ug(z):nb,[z]);return Ke.useEffect(()=>{C.current=z},[z]),$}function nE(z){const[C,$]=Ke.useState(null),ue=Ke.useRef(z),Ie=Ke.useCallback(ve=>{const tt=Eg(ve.target);tt&&$(o=>o?(o.set(tt,Rg(tt)),new Map(o)):null)},[]);return Ke.useEffect(()=>{const ve=ue.current;if(z!==ve){tt(ve);const o=z.map(Oe=>{const $e=Eg(Oe);return $e?($e.addEventListener("scroll",Ie,{passive:!0}),[$e,Rg($e)]):null}).filter(Oe=>Oe!=null);$(o.length?new Map(o):null),ue.current=z}return()=>{tt(z),tt(ve)};function tt(o){o.forEach(Oe=>{const $e=Eg(Oe);$e==null||$e.removeEventListener("scroll",Ie)})}},[Ie,z]),Ke.useMemo(()=>z.length?C?Array.from(C.values()).reduce((ve,tt)=>sh(ve,tt),ra):Eb(z):ra,[z,C])}function sb(z,C){C===void 0&&(C=[]);const $=Ke.useRef(null);return Ke.useEffect(()=>{$.current=null},C),Ke.useEffect(()=>{const ue=z!==ra;ue&&!$.current&&($.current=z),!ue&&$.current&&($.current=null)},[z]),$.current?fm(z,$.current):ra}function sE(z){Ke.useEffect(()=>{if(!_m)return;const C=z.map($=>{let{sensor:ue}=$;return ue.setup==null?void 0:ue.setup()});return()=>{for(const $ of C)$==null||$()}},z.map(C=>{let{sensor:$}=C;return $}))}function oE(z,C){return Ke.useMemo(()=>z.reduce(($,ue)=>{let{eventName:Ie,handler:ve}=ue;return $[Ie]=tt=>{ve(tt,C)},$},{}),[z,C])}function Cb(z){return Ke.useMemo(()=>z?PS(z):null,[z])}const ob=[];function aE(z,C){C===void 0&&(C=xf);const[$]=z,ue=Cb($?wo($):null),[Ie,ve]=Ke.useState(ob);function tt(){ve(()=>z.length?z.map(Oe=>Tb(Oe)?ue:new jg(C(Oe),Oe)):ob)}const o=qg({callback:tt});return Nl(()=>{o==null||o.disconnect(),tt(),z.forEach(Oe=>o==null?void 0:o.observe(Oe))},[z]),Ie}function lE(z){if(!z)return null;if(z.children.length>1)return z;const C=z.children[0];return gf(C)?C:z}function cE(z){let{measure:C}=z;const[$,ue]=Ke.useState(null),Ie=Ke.useCallback($e=>{for(const{target:It}of $e)if(gf(It)){ue(lt=>{const Tt=C(It);return lt?gn(Pr({},lt),{width:Tt.width,height:Tt.height}):Tt});break}},[C]),ve=qg({callback:Ie}),tt=Ke.useCallback($e=>{const It=lE($e);ve==null||ve.disconnect(),It&&(ve==null||ve.observe(It)),ue(It?C(It):null)},[C,ve]),[o,Oe]=Mg(tt);return Ke.useMemo(()=>({nodeRef:o,rect:$,setRef:Oe}),[$,o,Oe])}const uE=[{sensor:Hg,options:{}},{sensor:Ab,options:{}}],hE={current:{}},dm={draggable:{measure:J0},droppable:{measure:J0,strategy:_f.WhileDragging,frequency:zg.Optimized},dragOverlay:{measure:xf}};class pf extends Map{get(C){var $;return C!=null&&($=super.get(C))!=null?$:void 0}toArray(){return Array.from(this.values())}getEnabled(){return this.toArray().filter(C=>{let{disabled:$}=C;return!$})}getNodeFor(C){var $,ue;return($=(ue=this.get(C))==null?void 0:ue.node.current)!=null?$:void 0}}const dE={activatorEvent:null,active:null,activeNode:null,activeNodeRect:null,collisions:null,containerNodeRect:null,draggableNodes:new Map,droppableRects:new Map,droppableContainers:new pf,over:null,dragOverlay:{nodeRef:{current:null},rect:null,setRef:pm},scrollableAncestors:[],scrollableAncestorRects:[],measuringConfiguration:dm,measureDroppableContainers:pm,windowRect:null,measuringScheduled:!1},fE={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:pm,draggableNodes:new Map,over:null,measureDroppableContainers:pm},$g=Ke.createContext(fE),pE=Ke.createContext(dE);function mE(){return{draggable:{active:null,initialCoordinates:{x:0,y:0},nodes:new Map,translate:{x:0,y:0}},droppable:{containers:new pf}}}function _E(z,C){switch(C.type){case Gs.DragStart:return gn(Pr({},z),{draggable:gn(Pr({},z.draggable),{initialCoordinates:C.initialCoordinates,active:C.active})});case Gs.DragMove:return z.draggable.active==null?z:gn(Pr({},z),{draggable:gn(Pr({},z.draggable),{translate:{x:C.coordinates.x-z.draggable.initialCoordinates.x,y:C.coordinates.y-z.draggable.initialCoordinates.y}})});case Gs.DragEnd:case Gs.DragCancel:return gn(Pr({},z),{draggable:gn(Pr({},z.draggable),{active:null,initialCoordinates:{x:0,y:0},translate:{x:0,y:0}})});case Gs.RegisterDroppable:{const{element:$}=C,{id:ue}=$,Ie=new pf(z.droppable.containers);return Ie.set(ue,$),gn(Pr({},z),{droppable:gn(Pr({},z.droppable),{containers:Ie})})}case Gs.SetDroppableDisabled:{const{id:$,key:ue,disabled:Ie}=C,ve=z.droppable.containers.get($);if(!ve||ue!==ve.key)return z;const tt=new pf(z.droppable.containers);return tt.set($,gn(Pr({},ve),{disabled:Ie})),gn(Pr({},z),{droppable:gn(Pr({},z.droppable),{containers:tt})})}case Gs.UnregisterDroppable:{const{id:$,key:ue}=C,Ie=z.droppable.containers.get($);if(!Ie||ue!==Ie.key)return z;const ve=new pf(z.droppable.containers);return ve.delete($),gn(Pr({},z),{droppable:gn(Pr({},z.droppable),{containers:ve})})}default:return z}}function gE(z){let{disabled:C}=z;const{active:$,activatorEvent:ue,draggableNodes:Ie}=Ke.useContext($g),ve=Cg(ue),tt=Cg($==null?void 0:$.id);return Ke.useEffect(()=>{if(!C&&!ue&&ve&&tt!=null){if(!gb(ve)||document.activeElement===ve.target)return;const o=Ie.get(tt);if(!o)return;const{activatorNode:Oe,node:$e}=o;if(!Oe.current&&!$e.current)return;requestAnimationFrame(()=>{for(const It of[Oe.current,$e.current]){if(!It)continue;const lt=lS(It);if(lt){lt.focus();break}}})}},[ue,C,Ie,tt,ve]),null}function yE(z,C){let Ie=C,{transform:$}=Ie,ue=uf(Ie,["transform"]);return z!=null&&z.length?z.reduce((ve,tt)=>tt(Pr({transform:ve},ue)),$):$}function xE(z){return Ke.useMemo(()=>({draggable:Pr(Pr({},dm.draggable),z==null?void 0:z.draggable),droppable:Pr(Pr({},dm.droppable),z==null?void 0:z.droppable),dragOverlay:Pr(Pr({},dm.dragOverlay),z==null?void 0:z.dragOverlay)}),[z==null?void 0:z.draggable,z==null?void 0:z.droppable,z==null?void 0:z.dragOverlay])}function vE(z){let{activeNode:C,measure:$,initialRect:ue,config:Ie=!0}=z;const ve=Ke.useRef(!1),{x:tt,y:o}=typeof Ie=="boolean"?{x:Ie,y:Ie}:Ie;Nl(()=>{if(!tt&&!o||!C){ve.current=!1;return}if(ve.current||!ue)return;const $e=C==null?void 0:C.node.current;if(!$e||$e.isConnected===!1)return;const It=$($e),lt=xb(It,ue);if(tt||(lt.x=0),o||(lt.y=0),ve.current=!0,Math.abs(lt.x)>0||Math.abs(lt.y)>0){const Tt=vb($e);Tt&&Tt.scrollBy({top:lt.y,left:lt.x})}},[C,tt,o,ue,$])}const Pb=Ke.createContext(gn(Pr({},ra),{scaleX:1,scaleY:1}));var Bl;(function(z){z[z.Uninitialized=0]="Uninitialized",z[z.Initializing=1]="Initializing",z[z.Initialized=2]="Initialized"})(Bl||(Bl={}));const bE=Ke.memo(function(C){var $,ue,Ie,ve;let Es=C,{id:tt,accessibility:o,autoScroll:Oe=!0,children:$e,sensors:It=uE,collisionDetection:lt=TS,measuring:Tt,modifiers:Rt}=Es,ai=uf(Es,["id","accessibility","autoScroll","children","sensors","collisionDetection","measuring","modifiers"]);const _t=Ke.useReducer(_E,void 0,mE),[Ot,li]=_t,[Xt,gi]=pS(),[hi,Wi]=Ke.useState(Bl.Uninitialized),ci=hi===Bl.Initialized,{draggable:{active:yi,nodes:Ii,translate:xr},droppable:{containers:Lr}}=Ot,vr=yi!=null?Ii.get(yi):null,mi=Ke.useRef({initial:null,translated:null}),Pt=Ke.useMemo(()=>{var Xr;return yi!=null?{id:yi,data:(Xr=vr==null?void 0:vr.data)!=null?Xr:hE,rect:mi}:null},[yi,vr]),wr=Ke.useRef(null),[ir,qi]=Ke.useState(null),[di,ar]=Ke.useState(null),Wr=Ng(ai,Object.values(ai)),Cn=Vg("DndDescribedBy",tt),hr=Ke.useMemo(()=>Lr.getEnabled(),[Lr]),dn=xE(Tt),{droppableRects:Xi,measureDroppableContainers:ns,measuringScheduled:Mo}=JS(hr,{dragging:ci,dependencies:[xr.x,xr.y],config:dn.droppable}),xn=YS(Ii,yi),lo=Ke.useMemo(()=>di?Pg(di):null,[di]),ss=fn(),Yi=QS(xn,dn.draggable.measure);vE({activeNode:yi!=null?Ii.get(yi):null,config:ss.layoutShiftCompensation,initialRect:Yi,measure:dn.draggable.measure});const Qi=rb(xn,dn.draggable.measure,Yi),Fr=rb(xn?xn.parentElement:null),Xn=Ke.useRef({activatorEvent:null,active:null,activeNode:xn,collisionRect:null,collisions:null,droppableRects:Xi,draggableNodes:Ii,draggingNode:null,draggingNodeRect:null,droppableContainers:Lr,over:null,scrollableAncestors:[],scrollAdjustedTranslate:null}),dr=Lr.getNodeFor(($=Xn.current.over)==null?void 0:$.id),os=cE({measure:dn.dragOverlay.measure}),Vn=(ue=os.nodeRef.current)!=null?ue:xn,Br=ci?(Ie=os.rect)!=null?Ie:Qi:null,fs=!!(os.nodeRef.current&&os.rect),Rr=iE(fs?null:Qi),co=Cb(Vn?wo(Vn):null),Un=rE(ci?dr!=null?dr:xn:null),nn=aE(Un),ps=yE(Rt,{transform:{x:xr.x-Rr.x,y:xr.y-Rr.y,scaleX:1,scaleY:1},activatorEvent:di,active:Pt,activeNodeRect:Qi,containerNodeRect:Fr,draggingNodeRect:Br,over:Xn.current.over,overlayNodeRect:os.rect,scrollableAncestors:Un,scrollableAncestorRects:nn,windowRect:co}),uo=lo?sh(lo,xr):null,En=nE(Un),zs=sb(En),ms=sb(En,[Qi]),Yn=sh(ps,zs),Kn=Br?IS(Br,ps):null,vn=Pt&&Kn?lt({active:Pt,collisionRect:Kn,droppableRects:Xi,droppableContainers:hr,pointerCoordinates:uo}):null,Ls=bS(vn,"id"),[Tr,Hs]=Ke.useState(null),sn=fs?ps:sh(ps,ms),Ki=SS(sn,(ve=Tr==null?void 0:Tr.rect)!=null?ve:null,Qi),Jr=Ke.useRef(null),Os=Ke.useCallback((Xr,jr)=>{let{sensor:In,options:Qn}=jr;if(wr.current==null)return;const Ln=Ii.get(wr.current);if(!Ln)return;const bn=Xr.nativeEvent,Be=new In({active:wr.current,activeNode:Ln,event:bn,options:Qn,context:Xn,onAbort(cn){if(!Ii.get(cn))return;const{onDragAbort:Qt}=Wr.current,Qr={id:cn};Qt==null||Qt(Qr),Xt({type:"onDragAbort",event:Qr})},onPending(cn,as,Qt,Qr){if(!Ii.get(cn))return;const{onDragPending:xs}=Wr.current,pe={id:cn,constraint:as,initialCoordinates:Qt,offset:Qr};xs==null||xs(pe),Xt({type:"onDragPending",event:pe})},onStart(cn){const as=wr.current;if(as==null)return;const Qt=Ii.get(as);if(!Qt)return;const{onDragStart:Qr}=Wr.current,ks={activatorEvent:bn,active:{id:as,data:Qt.data,rect:mi}};hf.unstable_batchedUpdates(()=>{Qr==null||Qr(ks),Wi(Bl.Initializing),li({type:Gs.DragStart,initialCoordinates:cn,active:as}),Xt({type:"onDragStart",event:ks}),qi(Jr.current),ar(bn)})},onMove(cn){li({type:Gs.DragMove,coordinates:cn})},onEnd:On(Gs.DragEnd),onCancel:On(Gs.DragCancel)});Jr.current=Be;function On(cn){return async function(){const{active:Qt,collisions:Qr,over:ks,scrollAdjustedTranslate:xs}=Xn.current;let pe=null;if(Qt&&xs){const{cancelDrop:F}=Wr.current;pe={activatorEvent:bn,active:Qt,collisions:Qr,delta:xs,over:ks},cn===Gs.DragEnd&&typeof F=="function"&&await Promise.resolve(F(pe))&&(cn=Gs.DragCancel)}wr.current=null,hf.unstable_batchedUpdates(()=>{li({type:cn}),Wi(Bl.Uninitialized),Hs(null),qi(null),ar(null),Jr.current=null;const F=cn===Gs.DragEnd?"onDragEnd":"onDragCancel";if(pe){const B=Wr.current[F];B==null||B(pe),Xt({type:F,event:pe})}})}}},[Ii]),Dn=Ke.useCallback((Xr,jr)=>(In,Qn)=>{const Ln=In.nativeEvent,bn=Ii.get(Qn);if(wr.current!==null||!bn||Ln.dndKit||Ln.defaultPrevented)return;const Be={active:bn};Xr(In,jr.options,Be)===!0&&(Ln.dndKit={capturedBy:jr.sensor},wr.current=Qn,Os(In,jr))},[Ii,Os]),Jn=KS(It,Dn);sE(It),Nl(()=>{Qi&&hi===Bl.Initializing&&Wi(Bl.Initialized)},[Qi,hi]),Ke.useEffect(()=>{const{onDragMove:Xr}=Wr.current,{active:jr,activatorEvent:In,collisions:Qn,over:Ln}=Xn.current;if(!jr||!In)return;const bn={active:jr,activatorEvent:In,collisions:Qn,delta:{x:Yn.x,y:Yn.y},over:Ln};hf.unstable_batchedUpdates(()=>{Xr==null||Xr(bn),Xt({type:"onDragMove",event:bn})})},[Yn.x,Yn.y]),Ke.useEffect(()=>{const{active:Xr,activatorEvent:jr,collisions:In,droppableContainers:Qn,scrollAdjustedTranslate:Ln}=Xn.current;if(!Xr||wr.current==null||!jr||!Ln)return;const{onDragOver:bn}=Wr.current,Be=Qn.get(Ls),On=Be&&Be.rect.current?{id:Be.id,rect:Be.rect.current,data:Be.data,disabled:Be.disabled}:null,cn={active:Xr,activatorEvent:jr,collisions:In,delta:{x:Ln.x,y:Ln.y},over:On};hf.unstable_batchedUpdates(()=>{Hs(On),bn==null||bn(cn),Xt({type:"onDragOver",event:cn})})},[Ls]),Nl(()=>{Xn.current={activatorEvent:di,active:Pt,activeNode:xn,collisionRect:Kn,collisions:vn,droppableRects:Xi,draggableNodes:Ii,draggingNode:Vn,draggingNodeRect:Br,droppableContainers:Lr,over:Tr,scrollableAncestors:Un,scrollAdjustedTranslate:Yn},mi.current={initial:Br,translated:Kn}},[Pt,xn,vn,Kn,Ii,Vn,Br,Xi,Lr,Tr,Un,Yn]),ZS(gn(Pr({},ss),{delta:xr,draggingRect:Kn,pointerCoordinates:uo,scrollableAncestors:Un,scrollableAncestorRects:nn}));const zn=Ke.useMemo(()=>({active:Pt,activeNode:xn,activeNodeRect:Qi,activatorEvent:di,collisions:vn,containerNodeRect:Fr,dragOverlay:os,draggableNodes:Ii,droppableContainers:Lr,droppableRects:Xi,over:Tr,measureDroppableContainers:ns,scrollableAncestors:Un,scrollableAncestorRects:nn,measuringConfiguration:dn,measuringScheduled:Mo,windowRect:co}),[Pt,xn,Qi,di,vn,Fr,os,Ii,Lr,Xi,Tr,ns,Un,nn,dn,Mo,co]),fr=Ke.useMemo(()=>({activatorEvent:di,activators:Jn,active:Pt,activeNodeRect:Qi,ariaDescribedById:{draggable:Cn},dispatch:li,draggableNodes:Ii,over:Tr,measureDroppableContainers:ns}),[di,Jn,Pt,Qi,li,Cn,Ii,Tr,ns]);return ao.createElement(yb.Provider,{value:gi},ao.createElement($g.Provider,{value:fr},ao.createElement(pE.Provider,{value:zn},ao.createElement(Pb.Provider,{value:Ki},$e)),ao.createElement(gE,{disabled:(o==null?void 0:o.restoreFocus)===!1})),ao.createElement(gS,gn(Pr({},o),{hiddenTextDescribedById:Cn})));function fn(){const Xr=(ir==null?void 0:ir.autoScrollEnabled)===!1,jr=typeof Oe=="object"?Oe.enabled===!1:Oe===!1,In=ci&&!Xr&&!jr;return typeof Oe=="object"?gn(Pr({},Oe),{enabled:In}):{enabled:In}}}),wE=Ke.createContext(null),ab="button",TE="Draggable";function SE(z){let{id:C,data:$,disabled:ue=!1,attributes:Ie}=z;const ve=Vg(TE),{activators:tt,activatorEvent:o,active:Oe,activeNodeRect:$e,ariaDescribedById:It,draggableNodes:lt,over:Tt}=Ke.useContext($g),{role:Rt=ab,roleDescription:ai="draggable",tabIndex:_t=0}=Ie!=null?Ie:{},Ot=(Oe==null?void 0:Oe.id)===C,li=Ke.useContext(Ot?Pb:wE),[Xt,gi]=Mg(),[hi,Wi]=Mg(),ci=oE(tt,C),yi=Ng($);Nl(()=>(lt.set(C,{id:C,key:ve,node:Xt,activatorNode:hi,data:yi}),()=>{const xr=lt.get(C);xr&&xr.key===ve&&lt.delete(C)}),[lt,C]);const Ii=Ke.useMemo(()=>({role:Rt,tabIndex:_t,"aria-disabled":ue,"aria-pressed":Ot&&Rt===ab?!0:void 0,"aria-roledescription":ai,"aria-describedby":It.draggable}),[ue,Rt,_t,Ot,ai,It.draggable]);return{active:Oe,activatorEvent:o,activeNodeRect:$e,attributes:Ii,isDragging:Ot,listeners:ue?void 0:ci,node:Xt,over:Tt,setNodeRef:gi,setActivatorNodeRef:Wi,transform:li}}const EE=40,lb=20;function IE({setNotesHeight:z,notesHeight:C,minHeight:$=80}){const ue=xS(yS(Hg,{activationConstraint:{distance:2}})),Ie=ao.useRef(C),ve=ao.useRef(C),tt=()=>{ve.current=Ie.current},o=({delta:Oe})=>{if(typeof(Oe==null?void 0:Oe.y)!="number")return;if(ve.current===0){if(-Oe.y>=lb){const lt=Math.max($,lb);z(lt),Ie.current=lt}return}const $e=ve.current-Oe.y;if($e<EE){z(0),Ie.current=0;return}const It=Math.max($,$e);z(It),Ie.current=It};return ur.jsx(bE,{sensors:ue,onDragStart:tt,onDragMove:o,children:ur.jsx(AE,{notesHeight:C})})}function AE({notesHeight:z}){const{attributes:C,listeners:$,setNodeRef:ue}=SE({id:"speaker-notes-resize-handle"});return ur.jsx(E2,{label:ur.jsx(Lg,{id:"eTM8rh",defaultMessage:"Drag up to open speaker notes"}),side:"top",disabled:z!==0,children:ur.jsx("div",gn(Pr(Pr({ref:ue},$),C),{className:"mx-auto h-2 w-9 cursor-row-resize select-none",children:ur.jsx("div",{className:"h-[3px] w-full rounded bg-gray-300"})}))})}const ME=({slide:z})=>{const C=Ke.useMemo(()=>{var ue;return(ue=z.notesSlide)==null?void 0:ue.elements.map(Ie=>Ie.paragraphs.map(ve=>ve.runs.map(tt=>tt.text).join("")).join("\n")).join("\n").trim()},[z]),$=Ke.useMemo(()=>C&&C.length>0,[C]);return ur.jsx("div",{className:"bg-token-bg-primary h-full w-full overflow-y-auto rounded-md p-4 text-sm",children:$?ur.jsx("div",{className:"text-token-text-secondary",children:C}):ur.jsx("div",{className:"text-token-text-tertiary",children:ur.jsx(Lg,{id:"walnut.speaker-notes",defaultMessage:"There are no speaker notes for this slide."})})})},CE=z=>z==="mouse"||z==="touch"||z==="pen"?z:"mouse",PE=z=>z===0||z===1||z===2||z===3||z===4?z:0;function RE({canvasRef:z,getInputController:C}){const $=Ke.useRef(new Set),ue=Ke.useCallback(lt=>{$.current.forEach(Tt=>{Tt(lt)})},[]),Ie=Ke.useCallback(lt=>($.current.add(lt),()=>{$.current.delete(lt)}),[]),ve=Ke.useCallback((lt,Tt)=>{const Rt=z.current,ai=C();if(!Rt||!ai)return;const _t=Rt.getBoundingClientRect(),Ot={x:Tt.clientX-_t.left,y:Tt.clientY-_t.top},li={type:lt,pointerId:Tt.pointerId,pointerType:CE(Tt.pointerType),button:PE(Tt.button),screen:{x:Tt.clientX,y:Tt.clientY},world:Ot,time:performance.now(),modifiers:{alt:Tt.altKey,ctrl:Tt.ctrlKey,meta:Tt.metaKey,shift:Tt.shiftKey}};ai.handlePointerEvent(li),ue(li)},[z,C,ue]),tt=Ke.useCallback(lt=>{if(lt.pointerType!=="mouse")try{lt.currentTarget.setPointerCapture(lt.pointerId)}catch(Tt){}ve("pointerDown",lt)},[ve]),o=Ke.useCallback(lt=>{ve("pointerMove",lt)},[ve]),Oe=Ke.useCallback(lt=>{var Tt,Rt;if((Rt=(Tt=lt.currentTarget).hasPointerCapture)!=null&&Rt.call(Tt,lt.pointerId))try{lt.currentTarget.releasePointerCapture(lt.pointerId)}catch(ai){}ve("pointerUp",lt)},[ve]),$e=Ke.useCallback(lt=>{var Tt,Rt;if((Rt=(Tt=lt.currentTarget).hasPointerCapture)!=null&&Rt.call(Tt,lt.pointerId))try{lt.currentTarget.releasePointerCapture(lt.pointerId)}catch(ai){}ve("pointerLeave",lt)},[ve]),It=Ke.useCallback(lt=>{var Tt,Rt;if((Rt=(Tt=lt.currentTarget).hasPointerCapture)!=null&&Rt.call(Tt,lt.pointerId))try{lt.currentTarget.releasePointerCapture(lt.pointerId)}catch(ai){}ve("pointerLeave",lt)},[ve]);return{handlePointerDown:tt,handlePointerMove:o,handlePointerUp:Oe,handlePointerLeave:$e,handlePointerCancel:It,subscribeToPointerEvents:Ie}}function DE(z,C,$,ue){Ke.useEffect(()=>{if(!z)return;const Ie=ve=>{if(ve.key!=="ArrowUp"&&ve.key!=="ArrowDown")return;const tt=z.slides,o=C?tt.indexOf(C):-1;if(o===-1)return;let Oe=o;if(ve.key==="ArrowUp"&&o>0&&(Oe=o-1),ve.key==="ArrowDown"&&o<tt.length-1&&(Oe=o+1),Oe!==o){$(Oe);const $e=ue.current[Oe];$e==null||$e.scrollIntoView({block:"nearest"}),$e==null||$e.focus()}ve.preventDefault()};return window.addEventListener("keydown",Ie),()=>window.removeEventListener("keydown",Ie)},[z,C,$,ue])}const zE=100;function nI(z){"use forget";var Co,pn,Is,es;const C=y2.c(163),{presentation:$,selectedSlideIdx:ue,setSelectedSlideIdx:Ie,isEditing:ve,setIsEditing:tt}=z,o=$.slides[ue];let Oe;C[0]!==$.slides.length?(Oe=()=>new Array($.slides.length).fill(null),C[0]=$.slides.length,C[1]=Oe):Oe=C[1];const[$e,It]=Ke.useState(Oe);let lt;C[2]!==$.slides.length?(lt=()=>{It(new Array($.slides.length).fill(null))},C[2]=$.slides.length,C[3]=lt):lt=C[3];let Tt;C[4]!==$?(Tt=[$],C[4]=$,C[5]=Tt):Tt=C[5],Ke.useEffect(lt,Tt);const[Rt,ai]=Ke.useState(null),[_t,Ot]=Ke.useState(null),[li,Xt]=Ke.useState(null);let gi;C[6]===Symbol.for("react.memo_cache_sentinel")?(gi=[],C[6]=gi):gi=C[6];const hi=Ke.useRef(gi),Wi=Ke.useRef(null),ci=Ke.useRef(null),yi=Ke.useRef(null),Ii=Ke.useRef(null),xr=Ke.useRef(null);let Lr;C[7]===Symbol.for("react.memo_cache_sentinel")?(Lr=[],C[7]=Lr):Lr=C[7];const vr=Ke.useRef(Lr),mi=Ke.useRef(null);if(mi.current==null){let Ht;if(C[8]===Symbol.for("react.memo_cache_sentinel")){const Ut=new F2,Mi=new L2(HE),ji=new V2({events:Ut,hitTester:Mi}),mr=new U2(Ut);Ht={events:Ut,hitTester:Mi,input:ji,selection:mr},C[8]=Ht}else Ht=C[8];mi.current=Ht}let Pt,wr;C[9]===Symbol.for("react.memo_cache_sentinel")?(Pt=()=>()=>{var Ht;(Ht=mi.current)==null||Ht.selection.dispose()},wr=[],C[9]=Pt,C[10]=wr):(Pt=C[9],wr=C[10]),Ke.useEffect(Pt,wr);const ir=Ke.useRef(null);let qi;C[11]===Symbol.for("react.memo_cache_sentinel")?(qi=[],C[11]=qi):qi=C[11];const[di,ar]=Ke.useState(qi),[Wr,Cn]=Ke.useState(null),[hr,dn]=Ke.useState(null);let Xi;C[12]===Symbol.for("react.memo_cache_sentinel")?(Xi={ctx:null,version:0},C[12]=Xi):Xi=C[12];const[ns,Mo]=Ke.useState(Xi),{ctx:xn,version:lo}=ns;let ss;C[13]===Symbol.for("react.memo_cache_sentinel")?(ss={width:0,height:0},C[13]=ss):ss=C[13];const[Yi,Qi]=Ke.useState(ss),[Fr,Xn]=Ke.useState(null);let dr;C[14]===Symbol.for("react.memo_cache_sentinel")?(dr={ctx:null,version:0},C[14]=dr):dr=C[14];const[os,Vn]=Ke.useState(dr),{ctx:Br,version:fs}=os;let Rr;C[15]===Symbol.for("react.memo_cache_sentinel")?(Rr={width:0,height:0},C[15]=Rr):Rr=C[15];const[co,Un]=Ke.useState(Rr),[nn,ps]=Ke.useState(null),uo=Ke.useRef(1);let En;C[16]===Symbol.for("react.memo_cache_sentinel")?(En=Ht=>{Mo(Ut=>Ut.ctx===Ht?Ht==null?Ut:{ctx:Ht,version:Ut.version+1}:{ctx:Ht,version:Ut.version+1})},C[16]=En):En=C[16];let zs;C[17]===Symbol.for("react.memo_cache_sentinel")?(zs=Ht=>{Vn(Ut=>Ut.ctx===Ht?Ut:{ctx:Ht,version:Ut.version+1})},C[17]=zs):zs=C[17];let ms;C[18]===Symbol.for("react.memo_cache_sentinel")?(ms=Ht=>{const Ut=uo.current;if(!Number.isFinite(Ut)||Ut<=0)return;const Mi=Math.max(0,Math.round(Ht.plotDims.width*Ut)),ji=Math.max(0,Math.round(Ht.plotDims.height*Ut)),mr=Math.round(Ht.plotDims.x*Ut),hn=Math.round(Ht.plotDims.y*Ut);if(Mi===0||ji===0){Xn(GE),Qi(jE);return}Xn(sr=>sr&&sr.left===mr&&sr.top===hn&&sr.width===Mi&&sr.height===ji?sr:{left:mr,top:hn,width:Mi,height:ji}),Qi(sr=>sr.width===Mi&&sr.height===ji?sr:{width:Mi,height:ji})},C[18]=ms):ms=C[18];const Yn=ms;let Kn;C[19]===Symbol.for("react.memo_cache_sentinel")?(Kn=Ht=>{const Ut=uo.current;if(!Number.isFinite(Ut)||Ut<=0)return;const Mi=Math.max(0,Math.round(Ht.plotDims.width*Ut)),ji=Math.max(0,Math.round(Ht.plotDims.height*Ut)),mr=Math.round(Ht.plotDims.x*Ut),hn=Math.round(Ht.plotDims.y*Ut);if(Mi===0||ji===0){ps(UE),Un(VE);return}ps(sr=>sr&&sr.left===mr&&sr.top===hn&&sr.width===Mi&&sr.height===ji?sr:{left:mr,top:hn,width:Mi,height:ji}),Un(sr=>sr.width===Mi&&sr.height===ji?sr:{width:Mi,height:ji})},C[19]=Kn):Kn=C[19];const vn=Kn;let Ls;e:{if(!o){Ls=!1;break e}let Ht;if(C[20]!==$.charts||C[21]!==o.elements){let Ut;C[23]!==$.charts?(Ut=Mi=>{var hn;if(Mi.type!==W0.ELEMENT_TYPE_CHART_REFERENCE)return!1;const ji=(hn=Mi.chartReference)==null?void 0:hn.id;if(!ji)return!1;const mr=$.charts.find(sr=>sr.id===ji);return(mr==null?void 0:mr.type)===bg.CHART_TYPE_BAR_3D||(mr==null?void 0:mr.type)===bg.CHART_TYPE_PIE_3D},C[23]=$.charts,C[24]=Ut):Ut=C[24],Ht=o.elements.some(Ut),C[20]=$.charts,C[21]=o.elements,C[22]=Ht}else Ht=C[22];Ls=Ht}const Tr=Ls;let Hs;e:{if(!o){Hs=!1;break e}let Ht;if(C[25]!==$.charts||C[26]!==o.elements){let Ut;C[28]!==$.charts?(Ut=Mi=>{var hn;if(Mi.type!==W0.ELEMENT_TYPE_CHART_REFERENCE)return!1;const ji=(hn=Mi.chartReference)==null?void 0:hn.id;if(!ji)return!1;const mr=$.charts.find(sr=>sr.id===ji);return(mr==null?void 0:mr.type)===bg.CHART_TYPE_MAP},C[28]=$.charts,C[29]=Ut):Ut=C[29],Ht=o.elements.some(Ut),C[25]=$.charts,C[26]=o.elements,C[27]=Ht}else Ht=C[27];Hs=Ht}const sn=Hs,{width:Ki,height:Jr}=J2(yi,100);let Os;C[30]!==$||C[31]!==$e?(Os=async Ht=>{if($e[Ht]==null)try{const Ut=$.slides[Ht];if(!Ut)return;const Mi=await R2(Ut,$);It(ji=>{if(ji.length!==$.slides.length||ji[Ht]===Mi)return ji;const mr=[...ji];return mr[Ht]=Mi,mr})}catch(Ut){const Mi=Ut;A2.addError(Mi)}},C[30]=$,C[31]=$e,C[32]=Os):Os=C[32];const Dn=Os;let Jn;C[33]!==Dn||C[34]!==$.slides.length?(Jn=Ht=>{const Ut=Ht+1;Ut<$.slides.length&&Dn(Ut)},C[33]=Dn,C[34]=$.slides.length,C[35]=Jn):Jn=C[35];const zn=Jn;let fr;C[36]!==Dn||C[37]!==zn?(fr=()=>(ir.current&&ir.current.disconnect(),ir.current=new IntersectionObserver(Ht=>{Ht.forEach(Ut=>{var hn;const Mi=Ut.target,ji=Mi.getAttribute("data-index");if(!ji)return;const mr=Number(ji);Ut.isIntersecting&&(Dn(mr).then(()=>{zn(mr)}),(hn=ir.current)==null||hn.unobserve(Mi))})},{root:xr.current,rootMargin:"200px 0px",threshold:.05}),hi.current.forEach(Ht=>{var Ut;Ht&&((Ut=ir.current)==null||Ut.observe(Ht))}),()=>{var Ht;return(Ht=ir.current)==null?void 0:Ht.disconnect()}),C[36]=Dn,C[37]=zn,C[38]=fr):fr=C[38];let fn;C[39]!==Dn||C[40]!==zn||C[41]!==$?(fn=[$,Dn,zn],C[39]=Dn,C[40]=zn,C[41]=$,C[42]=fn):fn=C[42],Ke.useEffect(fr,fn);let Es;C[43]===Symbol.for("react.memo_cache_sentinel")?(Es=()=>{Cn(null),dn(null)},C[43]=Es):Es=C[43];let Xr;C[44]!==Jr||C[45]!==Ki?(Xr=[Ki,Jr],C[44]=Jr,C[45]=Ki,C[46]=Xr):Xr=C[46],Ke.useEffect(Es,Xr);let jr,In;C[47]===Symbol.for("react.memo_cache_sentinel")?(jr=()=>{const Ht=()=>{Cn(null),dn(null)};return window.addEventListener("click",Ht),()=>window.removeEventListener("click",Ht)},In=[],C[47]=jr,C[48]=In):(jr=C[47],In=C[48]),Ke.useEffect(jr,In);let Qn;C[49]!==li||C[50]!==sn||C[51]!==Tr||C[52]!==Rt||C[53]!==ve||C[54]!==Br||C[55]!==nn||C[56]!==$||C[57]!==_t||C[58]!==o||C[59]!==Jr||C[60]!==Ki||C[61]!==xn||C[62]!==Fr?(Qn=()=>{const Ht=Wi.current,Ut=yi.current;if(!Ht||!o||Ki===0||Jr===0||!Ut){vr.current=[];return}const Mi=o.widthEmu*rs,ji=o.heightEmu*rs,mr=Ut.clientWidth,hn=Ut.clientHeight,sr=Math.min(mr/Mi,hn/ji),jn=Math.round(window.devicePixelRatio)||1,As=Math.round(Mi*sr),Gn=Math.round(ji*sr),vs=Math.round(As*jn),ho=Math.round(Gn*jn);Ht.width!==vs&&(Ht.width=vs),Ht.height!==ho&&(Ht.height=ho);const Po=Ht.getBoundingClientRect(),ba=Math.min(Po.width/Mi,Po.height/ji);uo.current=Number.isFinite(ba)?ba:sr;const Ro=Ht.getContext("2d");if(!Ro){vr.current=[];return}Tr||Qi(Ms=>Ms.width===As&&Ms.height===Gn?Ms:{width:As,height:Gn}),Ro.resetTransform(),Ro.scale(jn*sr,jn*sr);let qs=!1;return(async()=>{const Ms=[],$a=[],wa=Tr&&Fr&&xn?xn:null,Fs=sn&&nn&&Br&&vg?Br:null;wa&&(wa.renderer.setScissorTest(!1),wa.clear()),await M2(o,$,Ro,Ms,wa,Tr?Yn:void 0,Fs,sn&&vg?vn:void 0,$a),!qs&&(ar(Ms),vr.current=$a,ve&&z2(Ro,$,Rt,_t,li!=null,o))})(),()=>{qs=!0}},C[49]=li,C[50]=sn,C[51]=Tr,C[52]=Rt,C[53]=ve,C[54]=Br,C[55]=nn,C[56]=$,C[57]=_t,C[58]=o,C[59]=Jr,C[60]=Ki,C[61]=xn,C[62]=Fr,C[63]=Qn):Qn=C[63];let Ln;C[64]!==li||C[65]!==sn||C[66]!==Tr||C[67]!==Rt||C[68]!==ve||C[69]!==Br||C[70]!==fs||C[71]!==nn||C[72]!==$||C[73]!==_t||C[74]!==o||C[75]!==Jr||C[76]!==Ki||C[77]!==xn||C[78]!==lo||C[79]!==Fr?(Ln=[o,$,Rt,_t,li,Ki,Jr,ve,xn,lo,Tr,Fr,Yn,Br,fs,sn,nn,vn,vg],C[64]=li,C[65]=sn,C[66]=Tr,C[67]=Rt,C[68]=ve,C[69]=Br,C[70]=fs,C[71]=nn,C[72]=$,C[73]=_t,C[74]=o,C[75]=Jr,C[76]=Ki,C[77]=xn,C[78]=lo,C[79]=Fr,C[80]=Ln):Ln=C[80],Ke.useEffect(Qn,Ln),DE($,o!=null?o:null,Ie,hi);const bn=Q2($,o,ci,Wi,Cn,di,Ie),Be=tS($,o,Wi,li,Xt,_t,ai,di);let On;C[81]!==li?(On=()=>{li||ai(null)},C[81]=li,C[82]=On):On=C[82];const cn=On,as=eS($,o,ci,Wi,ve,_t,Ot,ai,Xt);let Qt;C[83]===Symbol.for("react.memo_cache_sentinel")?(Qt=()=>Xt(null),C[83]=Qt):Qt=C[83];const Qr=Qt;let ks;C[84]===Symbol.for("react.memo_cache_sentinel")?(ks=()=>{Ot(null),ai(null)},C[84]=ks):ks=C[84];let xs;C[85]!==o?(xs=[o],C[85]=o,C[86]=xs):xs=C[86],Ke.useEffect(ks,xs),iS(ci,o,$);const[pe,F]=Ke.useState(zE),B=Ki>0&&Jr>0;let X;C[87]===Symbol.for("react.memo_cache_sentinel")?(X=()=>{var Ht,Ut;return(Ut=(Ht=mi.current)==null?void 0:Ht.input)!=null?Ut:null},C[87]=X):X=C[87];const ae=X;let oe;C[88]===Symbol.for("react.memo_cache_sentinel")?(oe={canvasRef:Wi,getInputController:ae},C[88]=oe):oe=C[88];const{handlePointerDown:de,handlePointerMove:Se,handlePointerUp:me,handlePointerLeave:be,handlePointerCancel:Ze,subscribeToPointerEvents:Ue}=RE(oe);let vt;C[89]!==Tr?(vt=()=>{if(!Tr){Xn(NE),Qi(BE);return}Xn(FE),Qi(kE)},C[89]=Tr,C[90]=vt):vt=C[90];let Bt;C[91]!==Tr||C[92]!==ue||C[93]!==Jr||C[94]!==Ki?(Bt=[Tr,ue,Ki,Jr],C[91]=Tr,C[92]=ue,C[93]=Jr,C[94]=Ki,C[95]=Bt):Bt=C[95],Ke.useEffect(vt,Bt);let Lt,Mt;C[96]!==sn||C[97]!==Jr||C[98]!==Ki?(Lt=()=>{(!sn||Ki===0||Jr===0)&&(ps(OE),Un(LE))},Mt=[sn,Ki,Jr],C[96]=sn,C[97]=Jr,C[98]=Ki,C[99]=Lt,C[100]=Mt):(Lt=C[99],Mt=C[100]),Ke.useEffect(Lt,Mt);let ei;C[101]!==sn||C[102]!==Br?(ei=()=>{!sn||!Br||Br.clear()},C[101]=sn,C[102]=Br,C[103]=ei):ei=C[103];let ri;C[104]!==sn||C[105]!==Br||C[106]!==ue?(ri=[sn,Br,ue],C[104]=sn,C[105]=Br,C[106]=ue,C[107]=ri):ri=C[107],Ke.useEffect(ei,ri);let Fi,Sr;C[108]!==Wr?(Fi=()=>{if(!Wr||!Ii.current||!ci.current)return;const{x:Ht,y:Ut,placement:Mi}=Wr,ji=Ii.current.getBoundingClientRect(),mr=ci.current.getBoundingClientRect();let hn=Ht+(Mi==="right"?0:-ji.width),sr=Ut-ji.height;hn=Math.max(0,Math.min(hn,mr.width-ji.width)),sr=Math.max(0,Math.min(sr,mr.height-ji.height)),dn({left:hn,top:sr})},Sr=[Wr],C[108]=Wr,C[109]=Fi,C[110]=Sr):(Fi=C[109],Sr=C[110]),I2(Fi,Sr);const en=(o==null?void 0:o.widthEmu)*rs/((o==null?void 0:o.heightEmu)*rs);let Dr;C[111]!==$.slides||C[112]!==o||C[113]!==Ie||C[114]!==en||C[115]!==$e?(Dr=$.slides.map((Ht,Ut)=>{const Mi=$.slides[Ut]===o,ji=$e[Ut];return ur.jsxs("button",{ref:mr=>{hi.current[Ut]=mr,mr&&ir.current&&ji==null&&ir.current.observe(mr)},"data-index":Ut,type:"button",onClick:()=>Ie(Ut),className:"flex w-full gap-3 rounded-md p-2 ".concat(Mi?"ring-2 ring-blue-500/60":""),children:[ur.jsx("div",{className:"text-token-text-primary text-sm font-semibold",children:Ut+1}),ur.jsx("div",{className:"bg-token-bg-secondary border-token-border-light relative w-full overflow-hidden rounded-md border",children:ji?ur.jsx("img",{src:ji,alt:"",className:"block w-full",draggable:!1}):ur.jsx("div",{className:"w-full animate-pulse bg-gray-200",style:{aspectRatio:en}})})]},Ut)}),C[111]=$.slides,C[112]=o,C[113]=Ie,C[114]=en,C[115]=$e,C[116]=Dr):Dr=C[116];let Er;C[117]!==Dr?(Er=ur.jsx("div",{ref:xr,className:"border-token-border-light flex h-full w-full shrink-0 flex-col gap-4 overflow-y-auto border-e p-2 sm:w-[240px]",children:Dr}),C[117]=Dr,C[118]=Er):Er=C[118];let Ai;C[119]!==Ze||C[120]!==de||C[121]!==be||C[122]!==Se||C[123]!==me||C[124]!==bn||C[125]!==as||C[126]!==cn||C[127]!==Be||C[128]!==sn||C[129]!==Tr||C[130]!==B||C[131]!==co||C[132]!==nn||C[133]!==o||C[134]!==Ue||C[135]!==Yi||C[136]!==Fr||C[137]!==Wr||C[138]!==(hr==null?void 0:hr.left)||C[139]!==(hr==null?void 0:hr.top)?(Ai=o?ur.jsx("div",{className:"flex w-full flex-1 flex-col items-center justify-center overflow-hidden p-6",ref:yi,children:ur.jsxs("div",{ref:ci,className:"border-token-border-light relative flex items-center justify-center overflow-hidden rounded-md border shadow-md ".concat(B?"visible":"invisible"),children:[ur.jsx("canvas",{ref:Wi,onMouseMove:Be,onMouseLeave:cn,onMouseDown:as,onMouseUp:Qr,onClick:bn,onPointerDown:de,onPointerMove:Se,onPointerUp:me,onPointerLeave:be,onPointerCancel:Ze,className:"max-h-full max-w-full select-none"}),!1,!1,ur.jsx(cb,{children:Wr&&ur.jsx(ub.div,{ref:Ii,initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.15,ease:"easeOut"},className:"absolute z-50 max-w-[300px] px-1 py-2 text-xs",style:{left:(Co=hr==null?void 0:hr.left)!=null?Co:0,top:(pn=hr==null?void 0:hr.top)!=null?pn:0},onClick:()=>{Cn(null),dn(null)},children:ur.jsx("div",{className:"bg-token-bg-primary text-token-text-primary truncate rounded-md px-1 py-2 shadow-md",children:Wr.url})})}),ur.jsx(q2,{canvasRef:Wi,stageRef:ci,chartTargetsRef:vr,slideW:((Is=o==null?void 0:o.widthEmu)!=null?Is:0)*rs,slideH:((es=o==null?void 0:o.heightEmu)!=null?es:0)*rs,subscribeToPointerEvents:Ue})]})}):ur.jsx("span",{className:"text-gray-400",children:ur.jsx(Lg,{id:"load-deck-to-begin",defaultMessage:"Load a slide to begin"})}),C[119]=Ze,C[120]=de,C[121]=be,C[122]=Se,C[123]=me,C[124]=bn,C[125]=as,C[126]=cn,C[127]=Be,C[128]=sn,C[129]=Tr,C[130]=B,C[131]=co,C[132]=nn,C[133]=o,C[134]=Ue,C[135]=Yi,C[136]=Fr,C[137]=Wr,C[138]=hr==null?void 0:hr.left,C[139]=hr==null?void 0:hr.top,C[140]=Ai):Ai=C[140];let ui;C[141]!==pe?(ui=ur.jsx(IE,{setNotesHeight:F,notesHeight:pe}),C[141]=pe,C[142]=ui):ui=C[142];const lr="".concat(pe,"px");let pr;C[143]!==lr?(pr={height:lr},C[143]=lr,C[144]=pr):pr=C[144];let Di;C[145]!==o?(Di=ur.jsx(ME,{slide:o}),C[145]=o,C[146]=Di):Di=C[146];let er;C[147]!==pr||C[148]!==Di?(er=ur.jsx("div",{className:"text-token-text-primary w-full px-6 pt-3 pb-6 text-sm",style:pr,children:Di}),C[147]=pr,C[148]=Di,C[149]=er):er=C[149];let Yr;C[150]!==ve||C[151]!==$||C[152]!==o||C[153]!==tt?(Yr=!1,C[150]=ve,C[151]=$,C[152]=o,C[153]=tt,C[154]=Yr):Yr=C[154];let wn;C[155]!==Ai||C[156]!==ui||C[157]!==er||C[158]!==Yr?(wn=ur.jsxs("div",{className:"bg-token-bg-secondary/20 hidden flex-1 flex-col items-center justify-center overflow-hidden sm:flex",children:[Ai,ui,er,Yr]}),C[155]=Ai,C[156]=ui,C[157]=er,C[158]=Yr,C[159]=wn):wn=C[159];let _s;return C[160]!==Er||C[161]!==wn?(_s=ur.jsx("div",{className:"flex h-full flex-col gap-4 overflow-hidden",children:ur.jsxs("div",{className:"flex h-full flex-1 flex-row",children:[Er,wn]})}),C[160]=Er,C[161]=wn,C[162]=_s):_s=C[162],_s}function LE(z){return z.width===0&&z.height===0?z:{width:0,height:0}}function OE(z){return z==null?z:null}function kE(z){return z.width===0&&z.height===0?z:{width:0,height:0}}function FE(z){return z==null?z:null}function BE(z){return z.width===0&&z.height===0?z:{width:0,height:0}}function NE(z){return z==null?z:null}function VE(z){return z.width===0&&z.height===0?z:{width:0,height:0}}function UE(z){return z!=null?z:null}function jE(z){return z.width===0&&z.height===0?z:{width:0,height:0}}function GE(z){return z==null?z:null}function HE(){return[]}export{nI as CanvasRenderer};
//# sourceMappingURL=no6sh712qfsf8gwp.js.map
