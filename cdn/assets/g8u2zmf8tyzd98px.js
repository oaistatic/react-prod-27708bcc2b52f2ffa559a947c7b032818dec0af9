var Z=Object.defineProperty,J=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var R=(a,l,t)=>l in a?Z(a,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[l]=t,v=(a,l)=>{for(var t in l||(l={}))$.call(l,t)&&R(a,t,l[t]);if(O)for(var t of O(l))ee.call(l,t)&&R(a,t,l[t]);return a},N=(a,l)=>J(a,Y(l));import{f as se,e as Q,r as S,j as e,M as A}from"./fg33krlcm0qyi6yw.js";import{e2 as D,e4 as F,pa as te,b as ae,v8 as L,R as ne,ck as G,p as re,dB as B}from"./mtk1qztvnb31pw5r.js";import{ef as z,ee as V,nf as W,gc as oe,ng as K,ge as le,y as X,nh as ie,ni as ce,f6 as de,dL as ue}from"./k65njl5wlgspihfr.js";import{T as me,I as fe}from"./m3nchqrpfl8vs80b.js";import{T as P}from"./i5jw6wfkpao2rx5t.js";const ge=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],he=["Good sources","Answered my question","I like it","Other"],xe=["Not relevant","Out of date","Content is wrong"],pe=["Relevant","Up to date","Accurate"];function ye(a){switch(a){case"Not relevant":return f.tagNotRelevant;case"Inaccurate":return f.tagInaccurate;case"Incomplete":return f.tagIncomplete;case"Missing sources":return f.tagMissingSources;case"I don't like it":return f.tagDontLikeIt;case"Shouldn't have searched Google Drive":return f.tagShouldntHaveSearched;case"Prompt was misunderstood":return f.tagPromptMisunderstood;case"Didn't like the response style":return f.tagDidntLikeResponseStyle;case"Other":return f.tagOther;case"Good sources":return f.tagGoodSources;case"Answered my question":return f.tagAnsweredMyQuestion;case"I like it":return f.tagLike;case"Out of date":return f.tagOutOfDate;case"Content is wrong":return f.tagContentWrong;case"Relevant":return f.tagRelevant;case"Up to date":return f.tagUpToDate;case"Accurate":return f.tagAccurate}}function H(a,l){let t;try{t=ye(a)}catch(g){}return t?l.formatMessage(t):a}function q(a,l){return a.map(t=>({label:H(t,l),value:t}))}const f=se({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function be({citationMetadata:a,noBottomBorder:l=!1,sourceFeedback:t,setSourceFeedback:g}){var k;const m=Q(),[j,h]=S.useMemo(()=>{if(a.type!=="file")return["",""];const d=a.name.split(".");return d.length>1?[d.slice(0,-1).join("."),d[d.length-1]]:[a.name,""]},[a]),y=S.useMemo(()=>{var C,_,I;if(a.type!=="file")return()=>null;const d=(_=a.cloud_doc_url)!=null?_:(C=a.extra)==null?void 0:C.cloud_doc_url;if(!d)return z;const x=V(d);return(I=x==null?void 0:x.Icon)!=null?I:(()=>null)},[a]),u=S.useMemo(()=>{var d;if(a.type==="file"&&((d=a.extra)!=null&&d.cloud_doc_url))try{return new URL(a.extra.cloud_doc_url).hostname}catch(x){return}},[a]),b=S.useCallback(d=>{g({rating:d,tags:[]})},[g]);return a.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(y,{className:"icon me-1.5"}),e.jsx("a",{href:(k=a.extra)==null?void 0:k.cloud_doc_url,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:j}),u&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:u})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:(t==null?void 0:t.rating)==="thumbsUp"?e.jsx(W,{className:"icon text-token-text-primary",onClick:()=>b(void 0)}):e.jsx(oe,{className:"icon text-token-text-secondary",onClick:()=>b("thumbsUp")})}),e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:(t==null?void 0:t.rating)==="thumbsDown"?e.jsx(K,{className:"icon text-token-text-primary",onClick:()=>b(void 0)}):e.jsx(le,{className:"icon text-token-text-secondary",onClick:()=>b("thumbsDown")})})]})]}),(t==null?void 0:t.rating)&&e.jsx("div",{className:"mb-4 flex flex-row",children:(t.rating==="thumbsDown"?xe:pe).map(d=>e.jsx(me,{className:"me-2",$selected:t.tags.includes(d),onClick:()=>g(N(v({},t),{tags:t.tags.includes(d)?t.tags.filter(x=>x!==d):[...t.tags,d]})),children:H(d,m)},d))}),!l&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function ve({documentId:a,title:l,externalUrl:t,noBottomBorder:g=!1,shouldHaveBeenIncluded:m,setShouldHaveBeenIncluded:j}){const h=S.useMemo(()=>{var k;const u=t;if(!u)return z;const b=V(u);return(k=b==null?void 0:b.Icon)!=null?k:(()=>null)},[t]),y=S.useMemo(()=>{if(t)try{return new URL(t).hostname}catch(u){return}},[t]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(h,{className:"icon me-1.5"}),e.jsx("a",{href:t,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:l}),y&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:y})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(X,{checked:m,onChange:u=>j==null?void 0:j(u.currentTarget.checked),id:"should-have-been-included-".concat(a)})})]}),!g&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function je(a,l){var j,h,y,u,b,k,d,x,C,_,I;const{messageId:t}=l;let g=t;const m=[];for(;g;){const E=a.getNodeByIdOrMessageId(g);if(!E){g=null;break}const n=E.message;if(!n)continue;const p=(j=ie(n))!=null?j:"",U=Array.isArray((h=n.metadata)==null?void 0:h.citations)?n.metadata.citations:[],s=Array.isArray((y=n.metadata)==null?void 0:y.attachments)?n.metadata.attachments:[],i={id:String(n.id),author:n.author.role,recipient:(u=n.recipient)!=null?u:"",createTime:n.create_time,updateTime:n.update_time};switch(n.author.role){case D.System:m.push(N(v({},i),{type:"system",content:n.content,citations:U,attachments:s}));break;case D.Assistant:if(n.recipient&&["user","all"].includes(n.recipient)&&p)m.push(N(v({},i),{type:"visible_text",text:p,citations:U,attachments:s}));else if(n.recipient&&n.recipient.includes("file_search")){const o=(k=(b=n.metadata)==null?void 0:b.command)!=null?k:"";let r=[];try{const c=JSON.parse(p);typeof c=="object"&&c!=null&&Array.isArray(c.queries)&&(r=c.queries.map(M=>String(M)))}catch(c){}r?m.push(N(v({},i),{type:"query",command:o,content:n.content,queries:r})):m.push(N(v({},i),{type:"generic_file_search_tool",command:o,content:n.content}))}break;case D.User:(p||s.length>0)&&m.push(N(v({},i),{type:"visible_text",text:p,citations:U,attachments:s}));break;case D.Tool:if((d=n.author.name)!=null&&d.includes("file_search")&&n.recipient==="all"){const o=(C=(x=n.metadata)==null?void 0:x.command)!=null?C:"";if(o==="msearch"&&n.content.content_type===F.TetherBrowsingDisplay){const r=n.content.result,c=(_=n.metadata)==null?void 0:_.cloud_doc_urls;if(r){let M=null;const w=(I=n.metadata)==null?void 0:I.raw_response;if(typeof w=="object"&&w!=null)try{M=ce(w)}catch(T){}m.push(N(v({},i),{type:"result",command:o,content:n.content,result:de(r,c),searchResponse:M}))}}else o==="context_stuff"&&n.content.content_type===F.TetherQuote?m.push(N(v({},i),{type:"fetch",command:o,content:n.content})):m.push(N(v({},i),{type:"generic_file_search_tool",command:o,content:n.content}))}break}g=E.parentId||null}return l.orderRootToLeaf&&m.reverse(),{messages:m}}const _e="considered-source-should-have-been-used";function Ae({citations:a,rating:l,onClose:t,messageId:g,conversationId:m,nodeId:j,conversationTree:h}){const y=ae(),u=Q(),b=te(y),[k,d]=S.useState(""),[x,C]=S.useState(()=>{var i,o;const s={};for(const r of a)((i=r.metadata)==null?void 0:i.type)==="file"&&(s[r.metadata.id]={rating:void 0,tags:[],url:(o=r.metadata.extra)==null?void 0:o.cloud_doc_url});return s}),_=h==null?void 0:h.getNodeByIdOrMessageId(g).message,I=S.useMemo(()=>{var o,r,c,M;const s=new Set,i=[];for(const w of(r=(o=_==null?void 0:_.metadata)==null?void 0:o.citations)!=null?r:[])!w.metadata||w.metadata.type!=="file"||s.has(w.metadata.id)||(i.push(w.metadata),s.add(w.metadata.id));for(const w of(M=(c=_==null?void 0:_.metadata)==null?void 0:c.content_references)!=null?M:[])if(w.type==="file_navlist")for(const T of w.items)s.has(T.id)||(i.push({type:"file",id:T.id,name:T.name,source:"my_files",text:T.description,cloud_doc_url:T.cloud_doc_url,extra:{cloud_doc_url:T.cloud_doc_url}}),s.add(T.id));return i},[_]),[E,n]=S.useState(!0),p=S.useMemo(()=>{const s={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!h||!j||!h.containsNodeOrMessageId(j))return s;const i=je(h,{messageId:j});for(const o of i.messages)switch(o.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{o.result.chunks.forEach(r=>{r.documentId&&!s.referencedSyncedFiles.some(c=>c.fileId===r.documentId)&&!I.some(c=>c.type==="file"&&c.id===r.documentId)&&s.referencedSyncedFiles.push({fileId:r.documentId,title:r.title,url:r.cloudDocUrl})});continue}case"query":{s.hasQuery=!0;continue}case"visible_text":{if(o.author===D.User){if(!s.lastUserMessage){const r=L(h,o.id),c=r[r.length-1].messages,M=c[c.length-1];s.lastUserMessage=M}}else if(o.author===D.Assistant&&!s.lastAssistantMessage){const r=L(h,o.id),c=r[r.length-1].messages,M=c[c.length-1];s.lastAssistantMessage=M,s.lastUserMessage=null}continue}}return s},[h,I,j]),U=S.useCallback(async s=>{const i=N(v({},s),{additionalSources:k,sourcesFeedback:x,consentedToShareConvoLink:E});try{await ne.safePost("/ca/feedback",{requestBody:{feedback_format:b,message_id:g,conversation_id:m,text:i.textFeedback,rating:l,tags:i.tags.map(o=>o.value),tag_choices:i.tagChoices,additional_sources:i.additionalSources,sources_feedback:i.sourcesFeedback,consented_to_share_convo_link:i.consentedToShareConvoLink}}),G(y).success(u.formatMessage({id:"ZzqQBa",defaultMessage:"Thanks for providing feedback!"})),t()}catch(o){o instanceof re&&G(y).danger(u.formatMessage({id:"4d5bOS",defaultMessage:"There was an error submitting your feedback. Please try again later."}))}},[y,k,x,E,b,g,m,l,u,t]);return e.jsxs(fe,{multiple:!0,allowEmptySubmit:!0,onSubmit:U,onCancel:t,tagOptions:q(l==="thumbsDown"?ge:he,u),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[l==="thumbsDown"?e.jsx(K,{className:"mb-[-6px]"}):e.jsx(W,{className:"mb-[-6px]"}),e.jsx(A,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[I.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(A,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:I.map((s,i)=>(s==null?void 0:s.type)!=="file"?null:e.jsx(be,{citationMetadata:s,noBottomBorder:i===I.length-1,sourceFeedback:x[s.id],setSourceFeedback:o=>C(r=>{var c;return N(v({},r),{[s.id]:N(v({},o),{url:(c=s.extra)==null?void 0:c.cloud_doc_url})})})},s.id))})]}),p.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(A,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"text-token-text-secondary ms-2",children:e.jsx(A,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:p.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-token-text-tertiary text-sm",children:e.jsx(A,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:p.referencedSyncedFiles.map((s,i)=>e.jsx(ve,{title:s.title,documentId:s.fileId,externalUrl:s.url,noBottomBorder:i===p.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!x[s.fileId],setShouldHaveBeenIncluded:o=>C(r=>{const c=v({},Object.fromEntries(Object.entries(r).filter(([M])=>M!==s.fileId)));return o&&(c[s.fileId]={tags:[_e],rating:"thumbsUp",url:s.url}),c})},s.fileId))})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-token-text-primary text-sm",children:e.jsx(A,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx(ue,{name:"feedback",className:"mt-2",placeholder:u.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:k,onChange:s=>d(s.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(A,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[p.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(A,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"dark:bg-token-main-surface-secondary relative max-w-[var(--user-chat-width,70%)] rounded-3xl bg-[#f4f4f4] px-5 py-2.5",children:p.lastUserMessage?e.jsx(P,{message:p.lastUserMessage,isCompletionInProgress:!1,hasActiveRequest:!1,conversation:B(y,m),isFinalUserTurn:!1,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(A,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"bg-token-main-surface-secondary relative rounded-lg p-4 text-sm",children:p.lastAssistantMessage?e.jsx(P,{message:p.lastAssistantMessage,isCompletionInProgress:!1,hasActiveRequest:!1,conversation:B(y,m),isFinalUserTurn:!1,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(A,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"text-token-text-secondary mt-1 mb-2 text-sm",children:e.jsx(A,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(X,{id:"consented-to-share-entire-convo",label:u.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:E,onChange:s=>{n(s.currentTarget.checked)}})]})]})]})}export{Ae as C,_e as a,H as g};
//# sourceMappingURL=g8u2zmf8tyzd98px.js.map
