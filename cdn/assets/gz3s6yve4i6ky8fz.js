var I=Object.defineProperty,J=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var R=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var B=(t,n,r)=>n in t?I(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,l=(t,n)=>{for(var r in n||(n={}))R.call(n,r)&&B(t,r,n[r]);if(_)for(var r of _(n))L.call(n,r)&&B(t,r,n[r]);return t},k=(t,n)=>J(t,V(n));var h=(t,n)=>{var r={};for(var c in t)R.call(t,c)&&n.indexOf(c)<0&&(r[c]=t[c]);if(t!=null&&_)for(var c of _(t))n.indexOf(c)<0&&L.call(t,c)&&(r[c]=t[c]);return r};import{e as F,r as p,j as e,M as u,b as j,a as E,u as D}from"./fg33krlcm0qyi6yw.js";import{d9 as X,de as Z,qR as $,dA as H,pC as G,dy as ee,dz as te}from"./k65njl5wlgspihfr.js";import{a9 as x,R as m,m as ne,C as re,l as se,c0 as ce}from"./mtk1qztvnb31pw5r.js";import{m as i}from"./m9c0b46t4dp00adi.js";import{T as f}from"./hcn3kohxpjzaoxwc.js";function ae({setEnabled:t,isLoading:n,isEnabled:r}){const c=F(),[a,s]=p.useState(!1),d=()=>{s(!0)},o=y=>{s(!1),y&&t(!1)};return e.jsx("div",{className:"pt-1.5",children:r?e.jsxs(e.Fragment,{children:[e.jsx(x,{disabled:n,color:"danger",onClick:()=>{n||d()},children:e.jsx(u,l({},i.deleteDirectorySyncConnectionButton))}),e.jsx(X,{title:c.formatMessage(i.deleteDirectorySyncConnectionModalHeader),description:c.formatMessage(i.deleteDirectorySyncConnectionModalExplanation),confirmText:c.formatMessage(i.deleteDirectorySyncConnectionModalConfirmButton),cancelText:c.formatMessage(i.deleteDirectorySyncConnectionModalCancelButton),isOpen:a,primaryButtonColor:"danger",onClose:()=>o(!1),onConfirm:()=>o(!0)})]}):e.jsx(e.Fragment,{children:e.jsx(x,{disabled:n,color:"primary",onClick:()=>{n||t(!0)},children:e.jsx(u,l({},i.enableDirectorySyncButton))})})})}class S{static async getWorkspaceDirectorySyncSettings(n){return m.safeGet("/accounts/{account_id}/scim",{parameters:{path:{account_id:n}}})}static async setWorkspaceDirectorySyncEnabled(n,r){return m.safePost("/accounts/{account_id}/scim/set_enabled",{parameters:{path:{account_id:n}},requestBody:{enabled:r}})}static async setWorkspaceDirectorySyncEmailInvitesEnabled(n,r){return m.safePost("/accounts/{account_id}/scim/set_email_invites_enabled",{parameters:{path:{account_id:n}},requestBody:{enabled:r}})}static async getWorkspaceDirectorySyncPortalUrl(n){return m.safeGet("/accounts/{account_id}/scim/portal_link",{parameters:{path:{account_id:n}}})}static async getWorkspaceDirectorySyncFailedEvents(n){return m.safeGet("/accounts/{account_id}/scim/failed_events",{parameters:{path:{account_id:n}}})}static async retryWorkspaceDirectorySyncFailedEvent(n,r){return m.safePost("/accounts/{account_id}/scim/failed_events/{event_id}/retry",{parameters:{path:{account_id:n,event_id:r}}})}static async retryAllWorkspaceDirectorySyncFailedEvents(n){return m.safePost("/accounts/{account_id}/scim/failed_events/retry_all",{parameters:{path:{account_id:n}}})}static async discardWorkspaceDirectorySyncFailedEvent(n,r){return m.safeDelete("/accounts/{account_id}/scim/failed_events/{event_id}",{parameters:{path:{account_id:n,event_id:r}}})}static async getWorkspaceDirectorySyncProgressUsers(n){return m.safeGet("/accounts/{account_id}/scim/sync_progress_users",{parameters:{path:{account_id:n}}})}static async getWorkspaceDirectorySyncProgressGroups(n){return m.safeGet("/accounts/{account_id}/scim/sync_progress_groups",{parameters:{path:{account_id:n}}})}}function ie({isLoading:t,workspaceId:n,isDirectoryConnectionConfigured:r}){const[c,a]=p.useState(!1),s=ne(),d=F(),o=async()=>{try{a(!0);const y=await S.getWorkspaceDirectorySyncPortalUrl(n);a(!1),y!=null&&y.portal_link?window.open(y.portal_link,"_blank"):s.danger(d.formatMessage({id:"directorySync.portalLinkNotFound",defaultMessage:"Portal link not found."}),{toastId:"directory_sync_management_portal_button",loggingTitle:"Portal link not found.",loggingDescription:"Error message shown when directory sync portal link is missing"})}catch(y){y instanceof Error?s.danger(y.message,{toastId:"directory_sync_management_portal_button",loggingTitle:y.message,loggingDescription:"Generic error message for unexpected failures when opening the directory sync portal"}):s.danger(d.formatMessage({id:"directorySync.unexpectedError",defaultMessage:"An unexpected error occurred."}),{toastId:"directory_sync_management_portal_button",loggingTitle:"An unexpected error occurred.",loggingDescription:"Generic error message for unexpected failures when opening the directory sync portal"})}};return e.jsxs(x,{disabled:t||c,color:"secondary",className:"mt-3",onClick:o,children:[r?e.jsx(u,l({},i.launchDirectorySyncManagementPortalText)):e.jsx(u,l({},i.launchDirectorySyncSetupPortalText)),e.jsx(Z,{className:"icon-sm ms-1"})]})}function U(t){switch(t){case"dsync.user.created":return i.directorySyncEventTypeUserCreated;case"dsync.user.updated":return i.directorySyncEventTypeUserUpdated;case"dsync.user.deleted":return i.directorySyncEventTypeUserDeleted;case"dsync.group.created":return i.directorySyncEventTypeGroupCreated;case"dsync.group.updated":return i.directorySyncEventTypeGroupUpdated;case"dsync.group.deleted":return i.directorySyncEventTypeGroupDeleted;case"dsync.group.user_added":return i.directorySyncEventTypeGroupUserAdded;case"dsync.group.user_removed":return i.directorySyncEventTypeGroupUserRemoved;case"dsync.activated":return i.directorySyncEventTypeActivated;case"dsync.deleted":return i.directorySyncEventTypeDeleted;case"dsync.deactivated":return i.directorySyncEventTypeDeleted}}function oe({isLoading:t,failedEvents:n,retryEventWithId:r,retryAllFailedEvents:c,discardFailedEventWithId:a}){const[s,d]=p.useState(!1),[o,y]=p.useState(),C=F();return e.jsxs(e.Fragment,{children:[o&&e.jsx(re,{testId:"modal-directory-sync-failed-events",isOpen:s,onClose:d,title:C.formatMessage(U(o.event.event)),description:o.failure_reason,type:"success",showCloseButton:!0,isScrollable:!0,children:e.jsx("pre",{children:JSON.stringify(o.event,null,2)})}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs($,{className:"flex items-center space-x-4",children:[e.jsx(u,l({},i.failedDirectorySyncEventsTableHeader)),e.jsx(x,{disabled:t,color:"secondary",size:"small",className:"ms-auto",onClick:()=>{c()},children:e.jsx(u,l({},i.retryAllFailedDirectorySyncEventsButton))})]}),e.jsxs(f.Root,{className:"w-full table-auto",children:[e.jsxs(f.Header,{children:[e.jsx(f.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(u,l({},i.directorySyncEventsTableFailureEventTypeColumnHeader))}),e.jsx(f.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(u,l({},i.directorySyncEventsTableFailureReasonColumnHeader))}),e.jsx(f.HeaderCell,{className:"bg-token-main-surface-primary",children:e.jsx(u,l({},i.directorySyncEventsTableActionsColumnHeader))})]}),e.jsx(f.Body,{children:n.map((g,M)=>e.jsxs("tr",{children:[e.jsx(f.Cell,{children:e.jsx(u,l({},U(g.event.event)))}),e.jsx(f.Cell,{children:g.failure_reason}),e.jsxs(f.Cell,{children:[e.jsx("div",{children:e.jsx(x,{disabled:t,color:"secondary",size:"small",onClick:()=>{y(g),d(!0)},children:e.jsx(u,l({},i.showEventDirectorySyncEventButton))})}),e.jsx("div",{className:"ms-2",children:e.jsx(x,{disabled:t,color:"secondary",size:"small",onClick:()=>{r(g.event.id)},children:e.jsx(u,l({},i.retryDirectorySyncEventButton))})}),e.jsx("div",{className:"ms-2",children:a&&e.jsx(x,{disabled:t,color:"secondary",size:"small",onClick:()=>{a(g.event.id)},children:e.jsx(u,l({},i.discardDirectorySyncEventButton))})})]})]},g.event.id))})]})]})]})}function le({isLoading:t,numUsersSynced:n,numUsersInDirectory:r,numGroupsSynced:c,numGroupsInDirectory:a,failedEvents:s,retryEventWithId:d,retryAllFailedEvents:o,discardFailedEventWithId:y}){return e.jsxs(e.Fragment,{children:[e.jsxs(H,{className:"my-2",children:[e.jsxs("div",{children:[e.jsx(u,k(l({},i.directorySyncUserSyncStatus),{values:{numUsersSynced:n,numUsersInDirectory:r}})),e.jsx(G,{percentage:n/(r||1)*100})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx(u,k(l({},i.directorySyncGroupSyncStatus),{values:{numGroupsSynced:c,numGroupsInDirectory:a}}))}),e.jsx(G,{percentage:c/(a||1)*100})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(oe,{isLoading:t,failedEvents:s,retryEventWithId:d,retryAllFailedEvents:o,discardFailedEventWithId:y})})]})}const b=2e3;function T(t,n){const[r,c]=p.useState(!1),d=j({queryKey:["workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncSettings(t)},enabled:!!t,refetchInterval:r?b:!1}),{data:a}=d,s=h(d,["data"]);return p.useEffect(()=>{a!=null&&a.enabled&&(a==null?void 0:a.directory_connection)==null?c(!0):c(!1)},[a]),l({data:a},s)}function w(t,n){const[r,c]=p.useState(!1),{data:a}=T(t),o=j({queryKey:["workspace/directorySyncStatus/progressUsers","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncProgressUsers(t)},enabled:!!t&&!!(a!=null&&a.directory_connection),refetchInterval:r?b:!1}),{data:s}=o,d=h(o,["data"]);return p.useEffect(()=>{(s==null?void 0:s.synced_scim_users)===0||(s==null?void 0:s.synced_scim_users)!==(s==null?void 0:s.total_scim_users)?c(!0):c(!1)},[s,a==null?void 0:a.directory_connection]),l({isLoadingUsers:r,data:s},d)}function de(t,n){const[r,c]=p.useState(!1),{data:a}=T(t),o=j({queryKey:["workspace/directorySyncStatus/progressGroups","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncProgressGroups(t)},enabled:!!t&&!!(a!=null&&a.directory_connection),refetchInterval:r?b:!1}),{data:s}=o,d=h(o,["data"]);return p.useEffect(()=>{(s==null?void 0:s.synced_scim_groups)===0||(s==null?void 0:s.synced_scim_groups)!==(s==null?void 0:s.total_scim_groups)?c(!0):c(!1)},[s,a==null?void 0:a.directory_connection]),l({isLoadingGroups:r,data:s},d)}function ue(t,n){const{isLoadingUsers:r}=w(t);return j({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySync",t],queryFn:async()=>{if(t!==void 0)return await S.getWorkspaceDirectorySyncFailedEvents(t)},enabled:!!t,refetchInterval:r?b:!1})}function ye(t){const n=E();return D({mutationFn:r=>S.retryWorkspaceDirectorySyncFailedEvent(t,r),onSuccess:()=>{n.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySyncStatus/progressUsers","workspace/directorySyncStatus/progressGroups"]})}})}function me(t){const n=E();return D({mutationFn:()=>S.retryAllWorkspaceDirectorySyncFailedEvents(t),onSuccess:()=>{n.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents","workspace/directorySyncStatus/progressUsers","workspace/directorySyncStatus/progressGroups"]})}})}function pe(t){const n=E();return D({mutationFn:r=>S.discardWorkspaceDirectorySyncFailedEvent(t,r),onSuccess:()=>{n.refetchQueries({queryKey:["workspace/directorySyncStatus/failedEvents"]})}})}function fe(t){const n=E();return D({mutationFn:r=>S.setWorkspaceDirectorySyncEnabled(t,r),onSuccess:()=>{n.refetchQueries({queryKey:["workspace/directorySync",t]})}})}function je({workspaceId:t}){var W,q,N,A,P;const{data:n,isLoading:r}=T(t),{data:c,isLoading:a}=w(t),{data:s,isLoading:d}=de(t),{data:o,isLoading:y}=ue(t),{mutateAsync:C,status:g}=fe(t),{mutateAsync:M,status:K}=ye(t),{mutateAsync:O,status:Q}=me(t),{mutateAsync:z,status:Y}=pe(t),v=g==="pending"||K==="pending"||Q==="pending"||Y==="pending"||r||a||d||y;return e.jsxs(ee,{className:se("ps-6",v&&"text-token-text-secondary"),children:[e.jsx(te,{children:e.jsxs("div",{className:"flex flex-row",children:[e.jsx("div",{children:e.jsx(u,l({},i.directorySyncTitle))}),e.jsx("div",{className:"ms-2 mt-1",children:v&&e.jsx(ce,{})})]})}),e.jsx(H,{children:e.jsx(u,l({},i.directorySyncInfoText))}),(n==null?void 0:n.directory_connection)&&e.jsx("div",{children:e.jsx(le,{isLoading:v,numUsersSynced:(W=c==null?void 0:c.synced_scim_users)!=null?W:0,numUsersInDirectory:(q=c==null?void 0:c.total_scim_users)!=null?q:0,numGroupsSynced:(N=s==null?void 0:s.synced_scim_groups)!=null?N:0,numGroupsInDirectory:(A=s==null?void 0:s.total_scim_groups)!=null?A:0,failedEvents:o!=null?o:[],retryEventWithId:M,retryAllFailedEvents:O,discardFailedEventWithId:z})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(ae,{setEnabled:C,isLoading:v,isEnabled:(P=n==null?void 0:n.enabled)!=null?P:!0}),(n==null?void 0:n.enabled)&&e.jsx(e.Fragment,{children:e.jsx(ie,{isLoading:v,workspaceId:t,isDirectoryConnectionConfigured:!!(n!=null&&n.directory_connection)})})]})]})}export{je as DirectorySyncSection};
//# sourceMappingURL=gz3s6yve4i6ky8fz.js.map
